<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
  <head>
    <meta http-equiv="Content-Type" content=
    "text/html; charset=iso-8859-1">

    <title>OpenBSD Upgrading Mini-FAQ</title>
  </head>

  <body bgcolor="#FFFFFF" text="#000000" link="#23238E">

    <h1>MINI-FAQ: Upgrading OpenBSD</h1>

    <h2>Latest OpenBSD Release - 3.0</h2>

    <address>
      <p>Kjell Wooding 
	&lt;<a href="mailto:kjell@openbsd.com">kjell@openbsd.org</a>&gt;<br>
	Updated: 
	$OpenBSD: upgrade-minifaq.html,v 1.88 2002/01/17 17:49:39 kjell Exp $</p>
    </address>
    <br>
    
    <blockquote>
      <p>This Mini-FAQ is an attempt to address the most common
      issues encountered when upgrading between OpenBSD releases,
      or from the releases to <em>-current</em>. Though hardly
      <em>Mini</em> anymore, this document retains the Mini-FAQ
      moniker for historical and/or consistency reasons.
      Information on older versions can be found in a <a href=
      "upgrade-old.html">separate document</a>.</p>
    </blockquote>

    <h2>General Upgrade Questions</h2>
    
    <p>
      <a href="#1.1">1.1: Terminology. What is <em>-current</em>?
	What are Snapshots? What is <em>-stable</em>?</a><br>
      
      <a href="#1.2">1.2: What is the easiest way to upgrade to
	<em>-current</em>?</a><br>
      
      <a href="#1.3">1.3: I looked, but didn't see any snapshots on
	the FTP site. Where did they go?</a><br>
      
      <a href="#1.4">1.4: How do I get the latest source?</a><br>
      
      <a href="#1.5">1.5: Okay, I have the tree. How do I build
	it.</a><br>
      
      <a href="#1.6">1.6: My make build stopped halfway. Do I have
	to redo the whole thing?</a><br>
      
      <a href="#1.7">1.7: I'm getting errors during the build. What
	do I do?</a><br>
      
      <a href="#1.8">1.8: Is there a standard way of
	upgrading the compiler, <em>gcc</em>?</a><br>
      
      <a href="#1.9">1.9: What is the best way to upgrade
	<tt>/etc</tt>, <tt>/var</tt>, and <tt>/dev</tt>?</a><br>
      
      <a href="#1.10">1.10: How do I clean all the cruft out of my
	existing source tree?</a><br>
      
      <a href="#1.11">1.11: Do I have to be root to do a <em>make
	  build</em>?</a><br>
      
      <a href="#1.12">1.12: Why am I not seeing any new
	devices?</a><br>
      
      <a href="#1.13">1.13: Is there an easy way to make all the
	file hierarchy changes?</a><br>
    </p>
    
    <h2>Upgrading from 3.0</h2>
    
    <p>
      <a href="#3.0.1">3.0.1: Removal of libdl on ELF
	platforms</a><br>
      
      <a href="#3.0.2">3.0.2: New regression framework</a><br>
    </p>
    
    <h2>Upgrading from 2.9</h2>

    <p>
      <a href="#2.9.1">2.9.1: New users/groups - <em>proxy</em>,
	<em>smmsp</em> and <em>popa3d</em></a><br>

      <a href="#2.9.2">2.9.2: New packet filter: <em>pf</em></a><br>

      <a href="#2.9.3">2.9.3: Changes to <em>make</em></a><br>

      <a href="#2.9.4">2.9.4: Build fails because of KerberosV
	errors</a><br>

      <a href="#2.9.5">2.9.5: New <em>sendmail</em> version</a><br>

      <a href="#2.9.6">2.9.6: <tt>/etc/primes</tt> Moved</a>

    </p>
    
    <h2>Upgrading from 2.8</h2>
    
    <p>
      <a href="#2.8.1">2.8.1: New <em>auth</em> group</a><br>

      <a href="#2.8.2">2.8.2: New <em>wscons</em> console system</a><br>

      <a href="#2.8.3">2.8.3: Kernel compile fails with undefined
	symbols</a><br>
    </p>

    <h2>Upgrading from Earlier Versions</h2>

    <p>Information on upgrading from OpenBSD 2.3 to 2.7 
      has been moved to a <a href="upgrade-old.html">separate
	document</a>. This document was getting just
      too darn big.</p>


    &nbsp;<hr width="30%">

    <a name="1.0"></a> 
    <h2>General Upgrade Questions</h2>

    <a name="1.1"></a> 
    <h3>1.1: Terminology. What is <em>-current</em>? What are
      Snapshots? What is <em>-stable</em>?</h3>
    
    <p>Prior to OpenBSD 2.7, OpenBSD development happened from a
      single, unbranched source tree. As of 2.7, a patch branch was
      introduced.</p>
    
    <p>At approximately six-month intervals, OpenBSD
      <em>releases</em> are produced. These are numbered in the
      conventional (2.x, 3.x) manner. The current OpenBSD release is
      indicated at the top of this document.</p>
    
    <p><em>-current</em>, short for <em>openbsd-current</em>,
      refers to the up-to-the-minute version of the source tree
      contained in the CVS repository. This is the tree most commonly
      used by OpenBSD developers. The <em>-current</em> tree contains
      all the code that is planned for the next release. From time to
      time, brave souls will abandon the formal releases and run
      openbsd-current, usually to take advantage of features that
      have not yet made it into the formal releases. Because of its
      uncertain nature, however, upgrading to <em>-current</em> is
      not recommended for non-technical users.</p>
    
    <p>Between formal releases, a series of <em>snapshot</em>
      releases are 
      <a href="ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/">made
	available.</a> Snapshots are test releases of the
      <em>-current</em> source tree. Because they reflect the current
      state of development, there is no guarantee that snapshot
      releases will work correctly (or even at all). Snapshots are
      quite useful when moving from a formal release (or older
      version of -current) to the current tree.</p>
    
    <p>As of OpenBSD 2.7, a <a href="../stable.html">patch
	branch</a> (called <em>-stable</em>) was introduced. This
      branch contains the base release, and any important patches or
      fixes (important being the errata patches, plus others that are
      obvious and simple, but do not deserve an errata entry).</p>
    
    <p>The <a href="../ports.html">ports tree</a> is an integral
      part of the system. You should upgrade the ports tree at the
      same time as the rest of the system, following the same rules
      as for upgrading everything else; i.e., you should run -stable
      ports on a -stable system, and -current ports only on a
      -current system.</p>

    <a name="1.2"></a> 
    <h3>1.2: What is the best way to upgrade to
      <em>-current</em>?</h3>
    
    <p>Due to changes in the underlying libraries, moving directly
      from a release to <em>-current</em> is not always easy. The
      most painless way to move up to <em>-current</em> is to first
      upgrade to the latest snapshot (usually, via an FTP install).
      Once the snapshot is installed, the latest source can be 
      <a href="#1.4">fetched</a> and <a href="#1.5">built</a>. This
      procedure should eliminate most toolchain and library
      problems.</p>

    <a name="1.3"></a> 
    <h3>1.3: I looked, but didn't see any snapshots on the FTP
      site. Where did they go?</h3>
    
    <p>Snapshots may be removed as they become old (or no longer
      relevant). If no snapshot is available, you should upgrade to
      the most recent release and build the remainder of the way from
      source.</p>

    <a name="1.4"></a> 
    <h3>1.4: How do I get the latest source?</h3>

    <p>Short answer: 
      <a href="../anoncvs.html">http://www.openbsd.org/anoncvs.html</a></p>
    
    <p>For example. To retrieve the entire tree via CVS: (using the
      ksh shell. Others substitute <em>setenv</em> for
      <em>export</em>)</p>

<pre>
  # export CVSROOT=anoncvs@anoncvs.ca.openbsd.org:/cvs
  # export CVS_RSH=/usr/bin/ssh
  # cd /usr
  # cvs -q get -PA src
</pre>

    <a name="1.5"></a> 
    <h3>1.5: Okay, I have the tree. How do I build it.</h3>
    
    <p>Basic instructions are in 
      <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/Makefile"
	 ><tt>/usr/src/Makefile</tt></a>.
      This is a slightly expanded version.</p>
    
    <ol>
      <li>
        <p>Clean out the old object files.</p>
	
        <p>If you created a separate /usr/obj directory, clean
	  that, and rebuild the symbolic links:</p>

<pre>
  # rm -rf /usr/obj
  # mkdir /usr/obj
  # cd /usr/src
  # make obj
</pre>

        <p>If you find yourself performing this step a lot, you may
	  find it faster to place /usr/obj onto its own partition,
	  and use <em>newfs</em> instead of <em>rm</em>. For example,
	  I do a:</p>

<pre>
  # umount /dev/wd0h                 (the /usr/obj partition)
  # newfs wd0h
  # mount -a
  # make obj
</pre>

        <p>If you're worried there are object files in your source
	  tree, do this:</p>

<pre>
  # cd /usr/src
  # find . -type l -name obj | xargs rm
  # make cleandir
  # rm -rf /usr/obj
  # mkdir /usr/obj
  # make obj
</pre>

      </li>
      
      <li>
        <p>Perform any version-specific configuration changes. For
	  example, 2.3 users must add the <em>named</em> user and
	  group before moving to 2.4 or later. See the specific
	  Mini-FAQ section for your version.</p>
      </li>
      
      <li>
        <p>Make sure all the appropriate directories are created.
	  This is especially important when upgrading from older
	  versions, but is sometimes necessary in other cases. The
	  easiest way to do this is:</p>
<pre>
  # cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs
</pre>

      </li>

      <li>
        <p>Compile a new kernel.</p>
<pre>
  # cd /usr/src/sys/arch/`machine`/conf
</pre>

        <p>Most users will want to use GENERIC:</p>
<pre>
  # config GENERIC
  # cd ../compile/GENERIC
</pre>

        <p><strong>NOTE:</strong> The truly masochistic in the
	  crowd may want to compile a custom kernel instead. In these
	  cases, it's usually best to start with GENERIC and trim
	  from there. Do the following procedure instead:</p>
<pre>
  # cp GENERIC MYKERNEL
  # vi MYKERNEL
  (edit MYKERNEL to your liking)
  # config MYKERNEL
  # cd ../compile/MYKERNEL
</pre>

        <p>In either case,</p>
<pre>
  # make clean &amp;&amp; make depend &amp;&amp; make
  (arc architecture only) copy bsd.ecoff to your FAT partition
  # cp /bsd /bsd.old &amp;&amp; cp bsd /bsd
  # chown root.wheel /bsd (if you compiled as someone else)
  (reboot)
</pre>
      </li>

      <li>
        <p>Compile the system.</p>
<pre>
  # cd /usr/src
  # make build
</pre>
      </li>

      <li>
        <p>Update <tt>/etc</tt> and <tt>/dev</tt> by hand. These
	  are not updated automatically. Choose a directory with
	  enough space to hold /, /dev, /var, and /etc. Here I'll use
	  <em>/home/newroot</em></p>
<pre>
  # mkdir /home/newroot          
  # export DESTDIR=/home/newroot
  # cd /usr/src/etc &amp;&amp; make distribution-etc-root-var
</pre>

        <p>Now compare the files in /home/newroot with their
	  installed counterparts. Replace or update the files as
	  necessary.</p>
<pre>
  # rm -rf /home/newroot   (when done)
</pre>
      </li>

      <li>
        <p>Reboot to make sure the new /etc files are correct</p>
      </li>
    </ol>

    <a name="1.6"></a> 
    <h3>1.6: My make build stopped halfway. Do I have to redo the
      whole thing?</h3>

    <p>I would, but if you really want to pick up where you left
      off, do a:</p>
<pre>
# cd /usr/src
# make -n build
</pre>

    <p>This will show you what make build is doing. For example,
      mine tells me:</p>
<pre>
  (cd /usr/src/share/mk &amp;&amp;  make install)
  (cd /usr/src/include; make prereq;  make includes)
  make cleandir
  (cd /usr/src/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/kerberosIV/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/usr.bin/perl &amp;&amp;  make -f Makefile.bsd-wrapper config.sh &amp;&amp;  mak
e -f Makefile.bsd-wrapper depend &amp;&amp;  make -f Makefile.bsd-wrapper perl.lib &amp;&amp;
  make -f Makefile.bsd-wrapper install.lib)
  make depend &amp;&amp; make &amp;&amp;  make install
</pre>

    <p>To pick up where you left off, just reissue the commands
      from the point where the compile died.</p>
    
    <p>If you do this procedure a lot, you may want to create a new
      target in your makefile. Simply copy the entry for
      <em>build</em> (to <em>build-noclean</em>, for example), and
      remove the <em>make cleandir</em> reference.</p>

    <a name="1.7"></a> 
    <h3>1.7: I'm getting errors during the build. What do I
      do?</h3>
    
    <p>If your <em>make build</em> ends with an error, chances are
      it is because you failed to delete your old objects before
      rebuilding. See <a href="#1.5">1.5</a> for details on cleaning
      out these objects.</p>

    <p>If you are sure your tree is clean of old object cruft, and
      you are still receiving a build error, one of three things has
      probably happened:</p>
    
    <ol>
      <li>You have encountered a known upgrade issue. Make sure you
	have read the appropriate section of this document, and
	followed the instructions there carefully.</li>
      
      <li>You have encountered a new upgrade issue. This is life on
	the bleeding edge. Search recent postings to 
	<a href="../mail.html">misc@ and tech@</a> for possible
	workarounds.</li>
      
      <li>Someone has temporarily broken the source tree. This type
	of break is pretty rare, and is usually fixed immediately.
	Try waiting a few hours, and re-fetching the source tree. If
	you can't wait, try fetching a tree from a day or two
	beforehand.</li>
    </ol>

    <p>If you have tried all of the alternatives above, and your
      problem persists for more than a couple of days, post your
      problem to misc@openbsd.org. Make sure to include the relevant
      error messages, and any peculiarities of your setup.</p>

    <a name="1.8"></a> 
    <h3>1.8: I'm upgrading to a newer version of the compiler
      (<em>gcc</em>). Is there a standard way of bootstrapping
      it?</h3>

    <p>Because upgrading a compiler is a bit of a chicken-and-egg
      problem, changes to the in-tree compiler require a little extra
      attention. In general, you'll want to perform the following
      procedure:</p>

    <p>(and yes, you are building it twice)</p>

<pre>
  $ rm -r /usr/obj/gnu/egcs/gcc/*
  $ cd /usr/src/gnu/egcs/gcc
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper obj
  $ make -f Makefile.bsd-wrapper depend
  $ make -f Makefile.bsd-wrapper 
  $ sudo make -f Makefile.bsd-wrapper install
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper depend
  $ make -f Makefile.bsd-wrapper 
  $ sudo make -f Makefile.bsd-wrapper install
</pre>

    <p>And then run a normal <em>make build</em>.</p>

    <p>You may be able to speed this process up by using the
      BOOTSTRAP procedure:</p>

<pre>
  $ cd /usr/src/gnu/egcs/gcc
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper obj
  $ make -f Makefile.bsd-wrapper -DBOOTSTRAP
  $ sudo make -f Makefile.bsd-wrapper -DBOOTSTRAP install
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper
  $ sudo make -f Makefile.bsd-wrapper install
</pre>

    <a name="1.9"></a> 
    <h3>1.9: What is the best way to upgrade <tt>/etc</tt>,
      <tt>/var</tt>, and <tt>/dev</tt>?</h3>
    
    <p><strong>Short Answer</strong>: By Hand.</p>
    
    <p><strong>Long answer</strong>:</p>

    <p>As a policy, software in the OpenBSD tree does not modify
      files in <tt>/etc</tt> automatically. This means it is
      <em>always</em> up to the administrator to make the necessary
      modifications there. Upgrades are no exception. To update files
      in these directories, first determine what changes have
      occurred to the base (distribution) files, and then manually
      reapply these changes.</p>

    <p>For example, to see the files in the tree that have changed
      most recently, do a:</p>

<pre>
  # cd /usr/src/etc
  # ls -lt |more
</pre>

    <p>To see all the changes in <tt>/etc</tt> between arbitrary
      versions of OpenBSD, you can use 
      <a href="../anoncvs.html">CVS</a>. For example, to see the changes
      between 2.8 and 2.9, do a:</p>

<pre>
  # cd /usr/src/etc
  # cvs diff -u -rOPENBSD_2_8 -rOPENBSD_2_9
</pre>

    <p>Once you have identified the changes, reapply them to your
      local tree, preserving any local configuration you may have
      done.</p>

    <p>Typical <tt>/etc</tt> changes to watch out for between releases
      include:</p>
     
    <ul>
      <li>Additions to <tt>/etc/protocols</tt> and <tt>/etc/services</tt></li>
      <li>New sysctls. (see <tt>/etc/sysctl.conf</tt>)</li>
      <li>Changes to the default cron jobs. See <tt>/etc/daily</tt>, 
	<tt>/etc/weekly</tt>, <tt>/etc/monthly</tt>, and <tt>/etc/security</tt>
      </li>
      <li>All rc scripts, including netstart</li>
      <li>Device changes. See
	<a href="http://www.openbsd.org/faq/upgrade-minifaq.html#1.12">1.12</a>
      </li>
      <li>File hierarchy changes in <tt>/etc/mtree</tt>. See 
	<a href="http://www.openbsd.org/faq/upgrade-minifaq.html#1.13">1.13</a>
      </li>
      <li>
	New users (<tt>/etc/passwd</tt>)and groups (<tt>/etc/group</tt>)
      </li>
    </ul>


    <a name="1.10"></a> 
    <h3>1.10: How do I clean all the cruft out of my existing
      source tree?</h3>
    
    <p>The most important thing you can do is to clean out your obj
      directories. Here's a procedure to update source and kill any
      leftover objects:</p>

<pre>
  # cd /usr/src
  # cvs -q -d anoncvs@some.anon.server:/cvs up -PAd
  # find . -type l -name obj | xargs rm
  # make -k cleandir
  # rm -rf /usr/obj/*
  # make obj
</pre>

    <p>If you're still having trouble, you may want to try adding
      <tt>-I ! -I CVS -I obj</tt> to your CVS updates. This will
      identify any extra cruft in your source tree.</p>

    <a name="1.11"></a> 
    <h3>1.11: Do I have to be root to do a <em>make
	build</em>?</h3>

    <p>Though certain steps of the make build process require root
      privileges, the build process includes hooks to the 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sudo&amp;apropos=0&amp;sektion=8&amp;manpath=OpenBSD+Current&amp;arch=i386&amp;format=html"
	 >sudo(8)</a> command that make this process relatively
      painless.</p>

    <p>If your <tt>/etc/sudoers</tt> file is configured correctly,
      you can use the sudo hooks in the following manner:</p>
    
    <ul>
      <li>Place SUDO=/usr/bin/sudo in your environment prior to
	starting the build, or</li>

      <li>Add the line "SUDO=/usr/bin/sudo" to your
	<tt>/etc/mk.conf</tt> file.</li>
    </ul>

    <a name="1.12"></a> 
    <h3>1.12: Why am I not seeing any new devices?</h3>
    
    <p>The <tt>/dev/MAKEDEV</tt> script is not updated
    automatically as part of the <em>make build</em> process. As a
      general rule, it is a good idea to copy and run this script
      from your source tree when performing an upgrade:</p>

<pre>
  # cd /dev
  # cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  # ./MAKEDEV all
</pre>

    <a name="1.13"></a> 
    <h3>1.13: Is there an easy way to make all the file hierarchy
      changes?</h3>

    <p>From time to time, files or directories are added to, or
      removed from the file hierarchy. Also, ownership information
      for portions of the filesystem may changes. An easy way to
      ensure that your file hierarchy is up-to-date is to use the 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
	mtree(8)</a> utility.</p>
    
    <p>First, fetch the latest source, then do the following:</p>

<pre>
  # cd /usr/src/etc/mtree
  # install -c -o root -g wheel -m 600 special /etc/mtree
  # install -c -o root -g wheel -m 444 4.4BSD.dist /etc/mtree
  # mtree -qdef /etc/mtree/4.4BSD.dist -p / -u
</pre>

    <p>Your file hierarchy should now be up to date.</p>

    <a name="3.0"></a>
    <h2>
      Upgrading from 3.0
    </h2>
    
    <a name="3.0.1"></a>
    <h3>
      Removal of libdl on ELF platforms
    </h3>
    
    <p>
      ELF-based platforms (alpha, macppc and sparc64) do not use libdl
      anymore. The upgrade from a libdl system to a non-libdl is best
      done following these steps:
    </p>

    <ul>
      <li>
	<p>Recompile your system:</p>
<pre>
  $ cd /usr/src
  $ make build
</pre>
      </li>

      <li>
	<p>
	  If your &quot;make build&quot; completed successfully, you
	  can step ahead and remove libdl.  Note that packages that
	  have been linked against it should be reinstalled after
	  that.  If you are not ready for this, you can skip this step
	  for now.  Snapshots with correct packages will be made
	  available.
	</p>
<pre>
  # rm -f /usr/lib/libdl.* /usr/lib/libdl_pic.a
</pre>
	</li>
      <li>
	<p>
	  With libdl removed, regen your shared libraries cache:
	</p>
	
<pre>
  # ldconfig -R
</pre>
      </li>
    </ul>

    <a name="3.0.2"></a>
    <h3>
      3.0.2: New regression framework
    </h3>
    
    <p>
      A new infrastructure for regression tests has been introduced and
      <tt>bsd.regress.mk</tt> has been added.  You will need to install
      this file before running <em>make obj</em>.
    </p>

<pre>
  $ cd /usr/src/share/mk
  $ sudo make install
</pre>


    <a name="2.9"></a> 
    <h2>Upgrading from 2.9</h2>

    <a name="2.9.1"></a> 
    <h3>2.9.1: New users/groups - <em>proxy</em>, <em>smmsp</em>, and
      <em>popa3d</em>.</h3>

    <p>
      First, with the addition of the 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">
	pf(4)</a> firewalling package, and its 
      <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8"
	 >ftp-proxy(8)</a> suite, a new user and group named
      <em>proxy</em> were added to the system. To support this
      addition, add the following user entry using 
      <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
	vipw(8)</a>:</p>
    
<pre>
proxy:*:71:71::0:0:Proxy Services:/nonexistent:/sbin/nologin
</pre>

    <p>Also add the <em>proxy</em> group to /etc/group:</p>

<pre>
proxy:*:71:
</pre>

    <p>Second, as part of the Sendmail 8.12 upgrade, sendmail no
      longer runs setuid root. Both a new user and a new group, named
      <em>smmsp</em>, have been added to the system. Add a line like
      the following to your <tt>/etc/group</tt>:</p>

<pre>
smmsp:*:25:
</pre>

    <p>Then, run 
      <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
	vipw(8)</a> and add the following line for the <em>smmsp</em>
      user:</p>

<pre>
smmsp:*:25:25::0:0:Sendmail Message Submission Program:/nonexistent:/sbin/nologin
</pre>

    <p>Make sure this line appears before any <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=yp&amp;sektion=8">
      yp(8)</a> settings line.</p>

    <p>Finally, a new user and group were added for Solar
      Designer's popa3d server, now part of the core system. Add the
      following to <tt>/etc/group</tt>:</p>

<pre>
popa3d:*:26:
</pre>

    <p>And using <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
      vipw(8)</a>, add</p>
<pre>
popa3d:*:26:26::0:0:POP3 server:/var/empty:/sbin/nologin
</pre>

    <a name="2.9.2"></a> 
    <h3>2.9.2: New packet filter: <em>pf</em></h3>

    <p>The IPF firewalling package that has been part of previous
      OpenBSD releases has been replaced with an all-new firewalling
      suite called <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">
	pf(4)</a>. As a result, a number of changes need to be
      made.</p>

    <p>First, <em>pf</em> depends on a new device file. To ensure
      that this special device is created, do the following:</p>

<pre>
  $ cd /dev
  $ sudo cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  $ sudo ./MAKEDEV all
</pre>

    <p>Second, a number of filesystem change have occurred. For
      your reference, the following binaries have been replaced:</p>

<pre>
OLD:
/sbin/ipf /sbin/ipfstat /sbin/ipnat /usr/sbin/ipfs
/usr/sbin/ipftest /usr/sbin/ipmon /usr/sbin/ipresend
/usr/sbin/ipsend /usr/sbin/iptest
NEW:
/sbin/pfctl
/usr/libexec/ftp-proxy
</pre>

    <p>Similarly, for the devices:</p>

<pre>
OLD: /dev/ipl /dev/ipnat /dev/ipstate /dev/ipauth
NEW: /dev/pf
</pre>

    <p>And finally, the filter configuration files:</p>

<pre>
OLD: /etc/ipf.rules /etc/ipnat.rules
NEW: /etc/pf.conf /etc/nat.conf
</pre>

    <p>A mechanism for safely enabling <em>pf</em> has been added
      to the <tt>/etc/rc</tt> and <tt>/etc/rc.conf</tt> files. You
      will need to update these files to include the new hooking
      mechanism. If you wish to enable <em>pf</em>, set PF=YES in
      <tt>/etc/rc.conf</tt>.</p>

    <a name="2.9.3"></a> 
    <h3>2.9.3: Changes to <em>make</em></h3>

    <p>There have been changes to <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=make&amp;sektion=1">
	make(1)</a> and its data files which may cause difficulties in
      the build process. This usually manifests as errors from
      <em>bsd.own.mk</em> during the build. To avoid these issues,
      first update the data files:</p>
<pre>
  $ cd /usr/src/share/mk
  $ sudo make install
</pre>

    <p>Then build and install the new make.</p>

<pre>
  $ cd /usr/src/usr.bin/make
  $ make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make
  $ sudo make install
</pre>

    <p>Now proceed with your upgrade.</p>
    
    <a name="2.9.4"></a>
    <h3>2.9.4: Build fails because of KerberosV errors</h3>

    <p>Before you try building the whole system, you need to first
      build KerberosV.</p>

    <p>First, there is a new KerberosV configuration directory in
      <em>/etc</em>. If you have not already done so, use the <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
	mtree(8)</a> procedure described in <a href="#1.13">section
	1.13</a> to create it:</p>

    <p>Now, build KerberosV</p>

<pre>
  $ cd /usr/src/kerberosV
  $ sudo make obj
  $ cd lib/roken
  $ sudo make 
  $ cd ../../usr.bin/asn1_compile
  $ sudo make
  $ sudo make install
</pre>

    <p>You may also need to update your <tt>/etc/login.conf</tt>,
      to reflect that the file
      <tt>/usr/libexec/auth/login_krb-or-pwd</tt> has been renamed to
      <tt>login_krb<strong>4</strong>-or-pwd</tt>.</p>

    <a name="2.9.5"></a> 
    <h3>2.9.5: New <em>sendmail</em> version</h3>

    <p><a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">
	sendmail(8)</a> has been upgraded to version 8.12. As this
      version of <em>sendmail</em> no longer runs setuid root,
      significant changes have resulted.</p>

    <ol>
      <li>Both a new user and a new group (<em>smmsp</em>) have
	been added. If you have not yet done so, follow the procedure
	in <a href="#2.9.1">section 2.9.1</a> to create them.</li>

      <li>Several changes to the file hierarchy have occurred,
	including a new <tt>/var/spool/clientmqueue</tt> directory
	and new permissions for <tt>/var/spool/mqueue</tt>. These
	changes can both be made using the <a href=
        "http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
	  mtree(8)</a> procedure described in <a href="#1.13">section
	  1.13</a>.</li>

      <li>
        <p>Add the following to root's <a href=
          "http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">
	    crontab(1)</a>. This is necessary since <em>sendmail</em>
	  is no longer setuid root, and relies on this entry to do
	  parts of its job:</p>

<pre>
# sendmail clientmqueue runner
*/30    *       *       *       *       /usr/sbin/sendmail -L sm-msp-queue -Ac -q
</pre>

      </li>
      
      <li>
        <p>Upgrade sendmail:</p>

<pre>
  $ cd /usr/src/gnu/usr.sbin/sendmail
  $ make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make &amp;&amp; sudo make install
</pre>

        <p><strong>Note:</strong> The files <tt>submit.cf</tt> and
	  <tt>localhost.cf</tt> have been installed to your
	  <tt>/etc/mail</tt> directory. The first of these,
	  <tt>submit.cf</tt> (referred to as the "client"
	  configuration file in current sendmail documentation) is
	  used by mail user agents that want to submit mail locally
	  for delivery via sendmail. Due to the permissions changes
	  described above, this does not require root privileges; the
	  sendmail binary is set-groupid to group smmsp. The second
	  file, <tt>localhost.cf</tt>, is an OpenBSD-ism that runs
	  sendmail only listening on the localhost interface to
	  accept mail from the local host but not accept connections
	  from the network (you almost certainly want this if you
	  also use e.g., <a href=
          "http://www.openbsd.org/cgi-bin/man.cgi?query=smtpd&amp;sektion=8">
	    smtpd(8)</a> listening on the SMTP port on your outside
	  interface). For more details, see the file
	  <tt>SECURITY</tt> in
	  <tt>/usr/src/gnu/usr.sbin/sendmail/sendmail</tt>.</p>

        <p>It is highly recommended that you regenerate and update
	  your sendmail configuration files in <tt>/etc/mail</tt>.
	  You can find some working configuration files in
	  <tt>/usr/share/sendmail/cf</tt>. Note that localhost.cf is
	  generated from openbsd-localhost.mc.</p>
      </li>

      <li>
        <p>If you were running sendmail without the <tt>-bd</tt>
	  option in <tt>/etc/rc.conf</tt>, as the default
	  installation settings do, you will need to use
	  <tt>localhost.cf</tt>. Edit <tt>rc.conf</tt> to use the
	  following:</p>
<pre>
# For normal use: "-L sm-mta -bd -q30m"
sendmail_flags="-L sm-mta -C/etc/mail/localhost.cf -bd -q30m"
</pre>
      </li>

      <li>
        <p>Once your configuration file is ready, <a href=
         "http://www.openbsd.org/cgi-bin/man.cgi?query=kill&amp;sektion=1">
	    kill(1)</a> the existing sendmail:</p>
<pre>
  kill `sed 1q /var/run/sendmail.pid`
</pre>

        <p>Restart the new sendmail with the appropriate options,
	  for example:</p>
<pre>
  /usr/sbin/sendmail -L sm-mta -bd -q30m
</pre>

        <p>for a configuration accepting mail from outside, or</p>

<pre>
  /usr/sbin/sendmail -L sm-mta -C/etc/mail/localhost.cf -bd -q30m
</pre>

        <p>for a local mail-only configuration.</p>
	
        <p><strong>Note:</strong> the <tt>-bd</tt> flag is now
	  needed in both cases.</p>
      </li>
    </ol>

    <p>The new <em>sendmail</em> should now be running.</p>

    <a name="2.9.6"></a> 
    <h3>2.9.6: <tt>/etc/primes</tt> Moved</h3>

    <p><tt>/etc/primes</tt> has been renamed to
      <tt>/etc/moduli</tt>. Simply copy this file from its old
      location or from <tt>/usr/src/etc</tt>.</p>

    <a name="2.8"></a> 
    <h2>Upgrading from 2.8</h2>


    <a name="2.8.1"></a> 
    <h3>2.8.1: New <em>auth</em> group</h3>

    <p>A new group, <em>auth</em>, gid 11, has been added to the
      system. Add a line like the following to your
      <tt>/etc/group</tt>:</p>

<pre>
  auth:*:11:
</pre>

    <a name="2.8.2"></a> 
    <h3>2.8.2: New <em>wscons</em> console system</h3>

    <p>The <em>pcvt</em> console driver has been replaced with the
      <em>wscons</em> console system. Before using wscons, you will
      need to create the new wscons-related devices. Ensure you have
      the latest MAKEDEV installed, then make all devices:</p>

<pre>
 # cp /usr/src/etc/etc.i386/MAKEDEV /dev/MAKEDEV
 # cd /dev
 # ./MAKEDEV all
</pre>

    <p>If you are running X, change the Pointer section of your
      <em>XF86Config</em> file to contain the following:</p>

<pre>
    Protocol    "wsmouse"
    Device      "/dev/wsmouse"
</pre>

    <a name="2.8.3"></a> 
    <h3>2.8.3: Kernel compile fails with undefined symbols</h3>

    <p><a href=
    "http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;apropos=0&amp;sektion=8&amp;manpath=OpenBSD+Current&amp;arch=i386&amp;format=html">
	config(8)</a> has been updated. Building with the old
      <em>config</em> will result in errors like:</p>
<pre>
  Undefined symbol `_pdevnames_size' referenced
  Undefined symbol `_pdevnames' referenced
</pre>

    <p>To correct this, compile and install the new
      <em>config</em>:</p>
<pre>
  $ cd /usr/src/usr.sbin/config
  $ make clean &amp;&amp; make depend &amp;&amp; make
  $ sudo make install
</pre>

    <p>Now, recompile a new kernel as before.</p>


    <hr width="30%">

    <address>
      <p>
	$OpenBSD: upgrade-minifaq.html,v 1.88 2002/01/17 17:49:39 kjell Exp $<br>
	Copyright &copy; 1998-2002, Kjell Wooding.<br>
	Please send any comments, questions, or suggestions to <a
          href="mailto:kjell@openbsd.org">kjell@openbsd.org</a></p>
    </address>
  </body>
</html>

