<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <title>OpenBSD Upgrading Mini-FAQ</title>
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#23238E">


<h1>MINI-FAQ: Upgrading OpenBSD</h1>
<h2>Latest OpenBSD Release - 3.0</h2>

<address>
<p>
Kjell Wooding 
&lt;<a href="mailto:kjell@openbsd.com">kjell@openbsd.org</a>&gt; <br />
Updated:
$OpenBSD: upgrade-minifaq.html,v 1.85 2002/01/16 20:28:05 kjell Exp $
</p>
</address>

<br />

<blockquote>
<p>
If you've ever tried compiling the <em>-current</em> sources from an older
OpenBSD release, you're aware that the process isn't always
straightforward. This Mini-FAQ is
an attempt to address the most common issues encountered when upgrading
between OpenBSD releases, or from the releases to <em>-current</em>.
Though hardly <em>Mini</em> anymore, this document retains the Mini-FAQ
moniker for historical and/or consistency reasons.
</p>
</blockquote>


<h2>1.0: General Upgrade Questions</h2>

<p>
<a href="#1.1">
1.1: Terminology. What is <em>-current</em>? What are Snapshots? What is
<em>-stable</em>?
</a> <br />

<a href="#1.2">
1.2: What is the easiest way to upgrade to <em>-current</em>?
</a> <br />

<a href="#1.3">
1.3: I looked, but didn't see any snapshots on the FTP site. Where did
they go?
</a> <br />

<a href="#1.4">
1.4: How do I get the latest source?
</a> <br />

<a href="#1.5">
1.5: Okay, I have the tree. How do I build it.
</a> <br />

<a href="#1.6">
1.6: My make build stopped halfway. Do I have to redo the whole thing?
</a> <br />

<a href="#1.7">
1.7: I'm getting errors during the build. What do I do?
</a> <br />

<a href="#1.8">
1.8: I'm upgrading to a newer version of the compiler (<em>gcc</em>). Is there a
standard way of bootstrapping it?
</a> <br />

<a href="#1.9">
1.9: What is the best way to upgrade <tt>/etc</tt>, <tt>/var</tt>,
and <tt>/dev</tt>?
</a> <br />

<a href="#1.10">
1.10: How do I clean all the cruft out of my existing source tree?
</a> <br />

<a href="#1.11">
1.11: Do I have to be root to do a <em>make build</em>?
</a> <br />

<a href="#1.12">
1.12: Why am I not seeing any new devices?
</a> <br />

<a href="#1.13">
1.13: Is there an easy way to make all the file hierarchy changes?
</a> <br />
</p>

<h2>2.0: Upgrading from 2.3</h2>

<p>
<a href="#2.1">
2.1: What are the major problems upgrading from 2.3 to 2.4?
</a> <br />

<a href="#2.2">
2.2: I tried the build, but it failed when trying to compile <em>ssleay</em>.
</a> <br />

<a href="#2.3">
2.3: I tried the build, but it failed when trying to make something for the
PowerPC.
</a> <br />
</p>

<h2>3.0: Upgrading from 2.4</h2>

<p>
<a href="#3.1">
3.1: What are the major problems upgrading from 2.4 to 2.5?
</a> <br />
<a href="#3.2">
3.2: I tried the build, but it failed on cap_mkdb.
</a> <br />
</p>

<h2>4.0: Upgrading from 2.5</h2>

<p>
<a href="#4.1">
4.1: What are the major problems upgrading from 2.5 to 2.6?
</a> <br />
<a href="#4.2">
4.2: How do I upgrade <em>gcc</em> to <em>egcs</em>
</a>
</p>

<blockquote>
<p>
<a href="#4.2.1">4.2.1 - i386 and sparc are no longer #define'ed </a><br />
<a href="#4.2.2">4.2.2 - Build fails in xlint </a><br />
<a href="#4.2.3">4.2.3 - Core Dump on uthread_autoinit.c </a><br />
<a href="#4.2.4">4.2.4 - egcs seems much slower than gcc </a><br />
<a href="#4.2.5">4.2.5 - egcs generates larger code than gcc </a><br />
<a href="#4.2.6">4.2.6 - After installing egcs I have very little disk space 
left </a><br />
<a href="#4.2.7">4.2.7 - My build fails to build libcurses</a><br />
<a href="#4.2.8">4.2.8 - make obj fails</a>
</p>
</blockquote>

<p>
<a href="#4.3">
4.3: My <em>make build</em> dies with <em>unimplemented syscall</em> errors.
</a> <br />

<a href="#4.4">
4.4: Link to the new 2.6 directory.
</a> <br />

<a href="#4.5">
4.5: After an <strong>(U)</strong>pgrade, extraction of <em>base26.tar.gz</em>
fails with a message.
</a>
</p>

<h2>5.0 - Upgrading from 2.6</h2>

<p>
<a href="#5.1">
5.1: Termcap entries are too long.
</a> <br />

<a href="#5.2">
5.2: My <em>pn</em> (or <em>mx</em>, <em>al</em>, <em>ax</em>) device
is no longer recognized by the kernel.
</a> <br />

<a href="#5.3">
5.3: Upgrading gcc 2.95.1 to 2.95.2
</a> <br />

<a href="#5.4">
5.4: Upgrading Kerberos.
</a> <br />

<a href="#5.5">
5.5: Upgrading M4.
</a> <br />

<a href="#5.6">
5.6: Upgrading Sendmail.
</a> <br />

<a href="#5.7">
5.7: After upgrading, kernels that include 
<em>apm(8)</em> support no longer boot.
</a> <br />
</p>

<h2>6.0 - Upgrading from 2.7</h2>

<p>
<a href="#6.1">
6.1: What are the major problems upgrading from 2.7 to 2.8?
</a> <br />
</p>

<h2>7.0 - Upgrading from 2.8</h2>

<p>
<a href="#7.1">
7.1: New auth group
</a> <br />

<a href="#7.2">
7.2: New wscons console system
</a> <br />

<a href="#7.3">
7.3: Kernel compile fails with undefined symbols
</a> <br />

</p>

<h2>8.0 - Upgrading from 2.9</h2>
<p>
<a href="#8.1">
8.1: New users/groups - <em>proxy</em>, <em>smmsp</em> and <em>popa3d</em>
</a>
<br>

<a href="#8.2">
8.2: New packet filter: <em>pf</em>
</a>
<br>

<a href="#8.3">
8.3: Changes to <em>make</em>
</a>
<br>

<a href="#8.4">
8.4: Build fails because of KerberosV errors
</a>
<br>

<a href="#8.5">
8.5: New sendmail version
</a>
<br>

<a href="#8.6">
8.6: /etc/primes Moved
</a>

</p>

<h2>9.0 - Upgrading from 3.0</h2>
<p>
<a href="#9.1">
9.1: Removal of libdl on ELF platforms
</a>
<br>

<a href="#9.2">
9.2: New regression framework
</a>
<br>

</p>

&nbsp;<hr width="30%">

<a name="1.0"></a>
<h2>1.0: General Upgrade Questions</h2>


<a name="1.1"></a>
<h3>
1.1: Terminology. What is <em>-current</em>? What are Snapshots? What is
<em>-stable</em>?
</h3>

<p>
Prior to OpenBSD 2.7, OpenBSD development happened from a single, 
unbranched source tree. As of 2.7, a patch branch was introduced.
</p>

<p>
At approximately
six-month intervals, OpenBSD <em>releases</em> are produced. These are
numbered in the conventional (2.x, 3.x) manner. The current OpenBSD release is
indicated at the top of this document. 
</p>

<p>
<em>-current</em>, short for <em>openbsd-current</em>, refers to the
up-to-the-minute
version of the source tree contained in the CVS repository. This is the tree 
most commonly used by OpenBSD developers. The <em>-current</em> tree contains
all the code that is planned for the next release. From time to time,
brave souls will abandon the formal releases and run openbsd-current, usually
to take advantage of features that have not yet made it into the
formal releases. Because of its uncertain nature, however, upgrading
to <em>-current</em> is not recommended for non-technical users.
</p>

<p>
Between formal releases, a series of <em>snapshot</em> releases are 
<a href="ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/"> made available.</a> 
Snapshots are test releases of the <em>-current</em> source tree. 
Because they reflect the current state of development, 
there is no guarantee that snapshot releases will
work correctly (or even at all). Snapshots are quite useful when moving
from a formal release (or older version of -current) to the current tree.
</p>

<p>
As of OpenBSD 2.7, a <a href="../stable.html">patch branch</a> (called
<em>-stable</em>) was introduced.  This branch contains the base
release, and any important patches or fixes (important being the
errata patches, plus others that are obvious and simple, but do not
deserve an errata entry).
</p>

<p>
The <a href="../ports.html">ports tree</a> is an integral part of the
system. You should upgrade the ports tree at the same time as the rest
of the system, following the same rules as for upgrading everything
else; i.e., you should run -stable ports on a -stable system, 
and -current ports only on a -current system.
</p>

<a name="1.2"></a>
<h3>
1.2: What is the best way to upgrade to <em>-current</em>?
</h3>

<p>
Due to changes in the underlying libraries, moving directly from 
a release to <em>-current</em> is not always easy. 
The most painless way to
move up to <em>-current</em> is to first upgrade to the latest snapshot
(usually, via an FTP install). Once the snapshot is installed, the
latest source can be <a href="#1.4">fetched</a> and 
<a href="#1.5">built</a>. This
procedure should eliminate most toolchain and library problems.
</p>

<a name="1.3"></a>
<h3>
1.3: I looked, but didn't see any snapshots on the FTP site. Where did
they go?
</h3>

<p>
Snapshots may be removed as they become old (or no longer relevant).
If no snapshot is available, you should upgrade to the most recent
release and build the remainder of the way from source.
</p>

<a name="1.4"></a>
<h3>
1.4: How do I get the latest source?
</h3>

<p>
Short answer:
<a href="../anoncvs.html">http://www.openbsd.org/anoncvs.html</a>
</p>

<p>
For example. To retrieve the entire tree via CVS:
(using the ksh shell. Others substitute <em>setenv</em> for <em>export</em>)
</p>

<pre>
# export CVSROOT=anoncvs@anoncvs.ca.openbsd.org:/cvs
# export CVS_RSH=/usr/bin/ssh
# cd /usr
# cvs -q get -PA src
</pre>

<a name="1.5"></a>
<h3>
1.5: Okay, I have the tree. How do I build it.
</h3>

<p>
Basic instructions are in
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/Makefile">
<tt>/usr/src/Makefile</tt></a>. This is a slightly expanded
version.
</p>

<ol>

<li>
<p> Clean out the old object files.</p>

<p>
If you created a separate /usr/obj directory, clean that, and
rebuild the symbolic links:
</p>

<pre>
  # rm -rf /usr/obj
  # mkdir /usr/obj
  # cd /usr/src
  # make obj
</pre>

<p>
If you find yourself performing this step a lot, you may find it faster
to place /usr/obj onto its own partition, and use <em>newfs</em> instead 
of <em>rm</em>. For example, I do a:
</p>

<pre>
  # umount /dev/wd0h                 (the /usr/obj partition)
  # newfs wd0h
  # mount -a
  # make obj
</pre>

<p>
If you're worried there are object files in your source tree, 
do this:
</p>

<pre>
  # cd /usr/src
  # find . -type l -name obj | xargs rm
  # make cleandir
  # rm -rf /usr/obj
  # mkdir /usr/obj
  # make obj
</pre>

</li>

<li>
<p>
Perform any version-specific configuration changes. For example, 
2.3 users must add the <em>named</em> user and group before
moving to 2.4 or later. See the specific Mini-FAQ section for 
your version.
</p>
</li>

<li>
<p>
Make sure all the appropriate directories are created. This
is especially important when upgrading from older versions, but is
sometimes necessary in other cases. The easiest way to do this is:
</p>

<pre>
  # cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs
</pre>
</li>

<li>
<p>Compile a new kernel.</p>

<pre>
  # cd /usr/src/sys/arch/`machine`/conf
</pre>

<p>Most users will want to use GENERIC:</p>

<pre>
  # config GENERIC
  # cd ../compile/GENERIC
</pre>

<p>
<strong>NOTE:</strong> The truly masochistic in the crowd may want
to compile a custom kernel instead. In these cases, it's usually best
to start with GENERIC and trim from there. Do the following procedure
instead:
</p>

<pre>
  # cp GENERIC MYKERNEL
  # vi MYKERNEL
  (edit MYKERNEL to your liking)
  # config MYKERNEL
  # cd ../compile/MYKERNEL
</pre>

<p>
In either case, 
</p>

<pre>
  # make clean &amp;&amp; make depend &amp;&amp; make
  (arc architecture only) copy bsd.ecoff to your FAT partition
  # cp /bsd /bsd.old &amp;&amp; cp bsd /bsd
  # chown root.wheel /bsd (if you compiled as someone else)
  (reboot)
</pre>
</li>

<li>
<p>Compile the system.</p>

<pre>
  # cd /usr/src
  # make build
</pre>
</li>

<li>

<p>Update <tt>/etc</tt> and <tt>/dev</tt> by hand. These are not updated 
automatically. Choose a directory with enough space to 
hold /, /dev, /var, and /etc. Here I'll use <em>/home/newroot</em> 
</p>

<pre>
  # mkdir /home/newroot          
  # export DESTDIR=/home/newroot
  # cd /usr/src/etc &amp;&amp; make distribution-etc-root-var
</pre>

<p>
Now compare the files in /home/newroot with their 
installed counterparts. Replace or update the files as 
necessary.
</p>

<pre>
  # rm -rf /home/newroot   (when done)
</pre>
</li>

<li>
<p> Reboot to make sure the new /etc files are correct </p>
</li>
</ol>

<a name="1.6"></a>
<h3>
1.6: My make build stopped halfway. Do I have to redo the whole thing?
</h3>

<p>
I would, but if you really want to pick up where you left off, do a:
</p>

<pre>
# cd /usr/src
# make -n build
</pre>

<p>
This will show you what make build is doing. For example, mine tells me:
</p>

<pre>
  (cd /usr/src/share/mk &amp;&amp;  make install)
  (cd /usr/src/include; make prereq;  make includes)
  make cleandir
  (cd /usr/src/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/kerberosIV/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/usr.bin/perl &amp;&amp;  make -f Makefile.bsd-wrapper config.sh &amp;&amp;  mak
  e -f Makefile.bsd-wrapper depend &amp;&amp;  make -f Makefile.bsd-wrapper perl.lib &amp;&amp;
  make -f Makefile.bsd-wrapper install.lib)
  make depend &amp;&amp; make &amp;&amp;  make install
</pre>

<p>
To pick up where you left off, just reissue the commands from the point
where the compile died.
</p>

<p>
If you do this procedure a lot, you may want to create a new target in your
makefile. Simply copy the entry for <em>build</em> (to 
<em>build-noclean</em>, for example), and remove the <em>make cleandir</em> 
reference.
</p>

<a name="1.7"></a>
<h3>
1.7: I'm getting errors during the build. What do I do?
</h3>

<p>
If your <em>make build</em> ends with an error, chances are it is
because you failed to delete your old objects before rebuilding.
See <a href="#1.5">1.5</a> for details on cleaning out these objects.
</p>

<p>
If you are sure your tree is clean of old object cruft, and you are
still receiving a build error, one of three things has probably happened:
</p>

<ol>
<li>
You have encountered a known upgrade issue. Make sure you have
read the appropriate section of this document, and followed the instructions
there carefully.
</li>

<li>
You have encountered a new upgrade issue. This is life on the bleeding
edge. Search recent postings to
<a href="../mail.html">misc@ and tech@</a>
for possible workarounds.
</li>

<li>
Someone has temporarily broken the source tree. This type of break
is pretty rare, and is usually fixed immediately. Try waiting a few hours, and
re-fetching the source tree. If you can't wait, try fetching a tree from
a day or two beforehand.
</li>
</ol>

<p>
If you have tried all of the alternatives above, and your problem persists
for more than a couple of days, post your problem to misc@openbsd.org.
Make sure to include the relevant error messages,
and any peculiarities of your setup.
</p>

<a name="1.8"></a>
<h3>
1.8: I'm upgrading to a newer version of the compiler
(<em>gcc</em>). Is there a standard way of bootstrapping it?
</h3>

<p>
Because upgrading a compiler is a bit of a chicken-and-egg problem,
changes to the in-tree compiler require a little extra attention.
In general, you'll want to perform the following procedure:
</p>

<p>
(and yes, you are building it twice)
</p>

<pre>
  $ rm -r /usr/obj/gnu/egcs/gcc/*
  $ cd /usr/src/gnu/egcs/gcc
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper obj
  $ make -f Makefile.bsd-wrapper depend
  $ make -f Makefile.bsd-wrapper 
  $ sudo make -f Makefile.bsd-wrapper install
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper depend
  $ make -f Makefile.bsd-wrapper 
  $ sudo make -f Makefile.bsd-wrapper install
</pre>

<p>
And then run a normal <em>make build</em>.
</p>

<p>
You may be able to speed this process up by using the
BOOTSTRAP procedure:
</p>

<pre>
  $ cd /usr/src/gnu/egcs/gcc
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper obj
  $ make -f Makefile.bsd-wrapper -DBOOTSTRAP
  $ sudo make -f Makefile.bsd-wrapper -DBOOTSTRAP install
  $ make -f Makefile.bsd-wrapper clean
  $ make -f Makefile.bsd-wrapper
  $ sudo make -f Makefile.bsd-wrapper install
</pre>


<a name="1.9"></a>
<h3>
1.9: What is the best way to upgrade <tt>/etc</tt>, <tt>/var</tt>,
and <tt>/dev</tt>?
</h3>

<p>
<strong>Short Answer</strong>: By Hand.
</p>

<p>
<strong>Long answer</strong>:
</p>

<p>
As a policy, software in the OpenBSD tree does not modify files in
<tt>/etc</tt> automatically. This means it is <em>always</em> up to
the administrator to make the necessary modifications there. Upgrades
are no exception. To update files in these directories, first determine
what changes have occurred to the base (distribution) files, and then
manually reapply these changes.
</p>

<p>
For example, to see the files in the tree that have changed most recently,
do a:
</p>

<pre>
  # cd /usr/src/etc
  # ls -lt |more
</pre>

<p>
To see all the changes in <tt>/etc</tt> between arbitrary versions of
OpenBSD, you can use <a href="../anoncvs.html">CVS</a>. For example, 
to see the changes between 2.8 and 2.9, do a:
</p>

<pre>
  # cd /usr/src/etc
  # cvs diff -u -rOPENBSD_2_8 -rOPENBSD_2_9
</pre>

<p>
Once you have identified the changes, reapply them to your
local tree, preserving any local configuration you may have done.
</p>

<a name="1.10"></a>
<h3>
1.10: How do I clean all the cruft out of my existing source tree?
</h3>

<p>
The most important thing you can do is to clean out your obj
directories. Here's a procedure to update source and kill any leftover
objects:
</p>

<pre>
  # cd /usr/src
  # cvs -q -d anoncvs@some.anon.server:/cvs up -PAd
  # find . -type l -name obj | xargs rm
  # make -k cleandir
  # rm -rf /usr/obj/*
  # make obj
</pre>

<p>
If you're still having trouble, you may want to try adding
<tt>-I ! -I CVS -I obj</tt> to your CVS updates. This will identify any
extra cruft in your source tree.
</p>

<a name="1.11"></a>
<h3>
1.11: Do I have to be root to do a <em>make build</em>?
</h3>

<p>
Though certain steps of the make build process require root
privileges, the build process includes hooks to the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sudo&amp;apropos=0&amp;sektion=8&amp;manpath=OpenBSD+Current&amp;arch=i386&amp;format=html">sudo(8)</a>
command that make this process relatively painless.
</p>

<p>
If your <tt>/etc/sudoers</tt> file is configured correctly, 
you can use the sudo hooks in the following manner:
</p>

<ul>
<li>
Place SUDO=/usr/bin/sudo in your environment prior to starting the build,
or
</li>
<li>
Add the line "SUDO=/usr/bin/sudo" to your <tt>/etc/mk.conf</tt> file.
</li>
</ul>

<a name="1.12"></a>
<h3>
1.12: Why am I not seeing any new devices?
</h3>

<p>
The <tt>/dev/MAKEDEV</tt> script is not updated automatically
as part of the <em>make build</em> process. As a general rule, it
is a good idea to copy and run this script from your source tree when
performing an upgrade:
</p>

<pre>
  # cd /dev
  # cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  # ./MAKEDEV all
</pre>

<a name="1.13"></a>

<h3>
1.13: Is there an easy way to make all the file hierarchy changes?
</h3>

<p>
From time to time, files or directories are added to, or removed from
the file hierarchy. Also, ownership information for portions of the
filesystem may changes.  An easy way to ensure that your file hierarchy
is up-to-date is to use the
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8"
>mtree(8)</a> utility. 
</p>

<p>
First, fetch the latest source, then do the following:
</p>

<pre>
  # cd /usr/src/etc/mtree
  # install -c -o root -g wheel -m 600 special /etc/mtree
  # install -c -o root -g wheel -m 444 4.4BSD.dist /etc/mtree
  # mtree -qdef /etc/mtree/4.4BSD.dist -p / -u
</pre>

<p>
Your file hierarchy should now be up to date.
</p>

<a name="2.0"></a>
<h2>2.0: Upgrading from 2.3</h2>

<a name="2.1"></a>
<h3>
2.1: What are the major problems upgrading from 2.3 to 2.4?
</h3>

<h4>New User: <em>named</em></h4>

<p>
After 2.3, the <em>named</em> DNS daemon was moved to a chroot jail.
To make this change possible, the <em>named</em> user was created.
If you do not have it already, you will need to create this user to
ensure that all directories get created properly during the build process.
</p>

<p>
Add the following entry to /etc/passwd using <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>:
</p>

<pre>
named:*:70:70::0:0:BIND Daemon:/var/named:/sbin/nologin
</pre>

<p>
Add the following to /etc/group:
</p>

<pre>
named:*:70:
</pre>


<a name="2.2"></a>
<h3>
2.2: I tried the build, but it failed when trying to compile <em>ssleay</em>.
</h3>

<p>
You are likely missing an entry for the <em>named</em> user in your
password file.
</p>

<p>
<strong>Short Answer:</strong>
</p>

<p>
Create this user prior to the build.
</p>

<p>
<strong>Long Answer:</strong>
</p>

<p>
The <em>named</em> user is required in order to set permissions
correctly.  If this user is missing, part of the build process fails.
If you capture your build to a file (say, with a <em>make build
&amp;&gt;/tmp/build.log</em>) you will notice the following message:
</p>

<pre>
(cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs)
install -d -o root -g wheel -m 755 /
mtree -def mtree/4.4BSD.dist -p // -u

mtree: unknown user named
mtree: failed at line 1632 of the specification
*** Error code 1 (ignored)
</pre>

<p>
Unfortunately for us, the build continued happily on its way,
totally ignoring the fact that an error occurred.
</p>

<p>
If the <em>named</em> user exists, mtree works properly:
</p>

<pre>
missing: ./var/named (created)
missing: ./var/named/dev (created)
missing: ./var/named/etc (created)
missing: ./etc/afs (created)
missing: ./etc/ssl (created)
missing: ./etc/ssl/private (created)
missing: ./usr/obj (not created: File exists)
missing: ./usr/share/doc/html (created)
missing: ./usr/share/doc/html/lynx_help (created)
missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
missing: ./usr/share/doc/usd/13.viref (created)
missing: ./usr/share/man/cat4/powerpc (created)
missing: ./usr/share/man/man4/alpha (created)
missing: ./usr/share/man/man4/pmax (created)
missing: ./usr/share/man/man4/powerpc (created)
missing: ./usr/share/tmac/mdoc (created)
missing: ./var/www/htdocs/manual/vhosts (created)
missing: ./usr/include/ssl (created)
</pre>

<p>
The reason for the fail, then, is that the <em>/usr/include/ssl</em> directory
was never created. Without the header files, the <em>ssleay</em> build fails.
</p>

<p>
<strong>Fix:</strong>
</p>

<p>
Create the <em>named</em> user and group. Remove <em>/usr/include/ssl</em>,
<em>/var/named</em>, and any other directory from the list above that was
mistakenly created as a normal file by the <em>make build</em>.
</p>


<a name="2.3"></a>
<h3>
2.3: I tried the build, but it failed when trying to make something for the
PowerPC.
</h3>

<p>
Your directory tree is incomplete. Specifically, the 
<tt>/usr/share/man/cat4/powerpc</tt> directory is missing. 
</p>

<p>
<strong>Quick Fix:</strong>
</p>

<p>
Create this directory and proceed with the compilation
</p>

<p>
<strong>Complete Fix:</strong>
</p>

<p>
Create the entire directory tree. Do a:
</p>

<pre>
# cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs
</pre>

<p>
You will likely see an output like the following:
</p>

<pre>
install -d -o root -g wheel -m 755 /
mtree -def mtree/4.4BSD.dist -p // -u

missing: ./var/named (created)
missing: ./var/named/dev (created)
missing: ./var/named/etc (created)
missing: ./etc/afs (created)
missing: ./etc/ssl (created)
missing: ./etc/ssl/private (created)
missing: ./usr/obj (not created: File exists)
missing: ./usr/share/doc/html (created)
missing: ./usr/share/doc/html/lynx_help (created)
missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
missing: ./usr/share/doc/usd/13.viref (created)
missing: ./usr/share/man/cat4/powerpc (created)
missing: ./usr/share/man/man4/alpha (created)
missing: ./usr/share/man/man4/pmax (created)
missing: ./usr/share/man/man4/powerpc (created)
missing: ./usr/share/tmac/mdoc (created)
missing: ./var/www/htdocs/manual/vhosts (created)
missing: ./usr/include/ssl (created)
</pre>

<p>
Note that /usr/share/man/cat4/powerpc was one of the directories created by this process.
</p>

<a name="3.0"></a>
<h2>3.0: Upgrading from 2.4</h2>

<a name="3.1"></a>
<h3>
3.1: What are the major problems upgrading from 2.4 to 2.5?
</h3>

<p>
<h3>cap_mkdb</h3>

<p>
The syntax for invoking <em>cap_mkdb</em> has changed slightly.
Before doing a <em>make build</em>, rebuild cap_mkdb from the latest source:
</p>
<pre>
# cd /usr/src/usr.bin/cap_mkdb
# make clean &amp;&amp; make &amp;&amp; make install
</pre>

<p>
The make build should then run to completion
</p>

<h3>Man Page Changes</h3>
<p>
Several man pages were moved from section 1 to later sections.
Unfortunately, if the old man pages are left in section 1, unwary
users will not see the latest version of the page.
</p>

<p>
The following pages should be removed:
</p>
<pre>
/usr/share/man/cat1/ipf.0
/usr/share/man/cat1/ipnat.0
/usr/share/man/cat1/ipsecadm.0
</pre>

<h3>Snake</h3>
<p>
You will need to remove the contents of the obj directory before upgrading
<code>/usr/src/games/snake</code>.
</p>

<h3><a name="3.2">
3.2: I tried the build, but it failed on cap_mkdb.
</a></h3>

<p>
<strong>Symptom:</strong>
</p>

<p>
A <em>make build</em> resulted in an error like this:
</p>

<pre>
cap_mkdb -i -f terminfo terminfo.src
cap_mkdb: illegal option -- i
usage: cap_mkdb [-v] [-f outfile] file1 [file2 ...]
*** Error code 1
</pre>

<p>
<strong>Quick Fix:</strong>
</p>

<p>
You need to build a new <em>cap_mkdb</em>. See 
<a href="#3.1">3.1</a>.
</p>

<a name="4.0"></a>
<h2>4.0: Upgrading from 2.5</h2>

<a name="4.1"></a>
<h3>
4.1: What are the major problems upgrading from 2.5 to 2.6?
</h3>

<h5><em>perl</em> and <em>make</em></h5>
<p>
The latest version of Perl (5.005_03) requires a new version of
<em>make</em> to compile properly. You must rebuild make before
building the new Perl. Do a:
</p>

<pre>
# cd /usr/src/usr.bin/make
# make clean &amp;&amp; make &amp;&amp; make install
</pre>

<p>
Then go ahead and rebuild the new Perl. You will need to clean out the Perl
<code>obj</code> directory by hand before building.
</p>

<p>
Perl developers should take note of the latest changes. From 
millert@openbsd.org:
</p>

<pre>
The version of perl in the OpenBSD source tree (post 2.5) has been
upgraded to 5.005_03.  The build method has changed somewhat but
most of that should be invisible.  The important changes that affect
people are as follows:

1) Perl lib files have moved from /usr/lib/perl5 to the more correct
/usr/libdata/perl5
2) The default site_perl directories now live in /usr/local.  Ie:
if you install a perl module, it will place itself in
/usr/local/libdata/perl5/site_lib.  This makes it easy to
see what non-stock modules you have.  It also means that we
can have perl modules in the ports system easily.
3) The perl library man pages are now install in /usr/share/man/cat3p
You'll need to update your man.conf based on the src/etc/man.conf
to take advantage of them.  This means you can now do
"man 3p less" and get info on the less pragma but "man less"
will still get you the less pager manpage.

If you have modules or other non-stock perl files the simplest thing
to do is to move /usr/lib/perl5 to /usr/libdata/perl5 and add a link
from /usr/lib/perl5 to /usr/libdata/perl5.  Alternately, you could
just edit the installed Config.pm file and fix up the paths there.

</pre>

<h5>Compiler Change: <em>egcs</em> replaces <em>gcc</em></h5>
<p>
This change is likely the most significant change you will encounter.
For detailed instructions, see section <a href="#4.2">4.2</a>.
</p>

<h5>Kernel Structure - <em>statfs</em> - changed</h5>
<p>
The <tt>statfs</tt> structure has changed as of May 31. You must
rebuild your kernel before attempting a <em>make build</em>.
See <a href="#4.3">4.3</a> for details.
</p>

<a name="4.2"></a>
<h3>
4.2: How do I upgrade <em>gcc</em> to <em>egcs</em>
</h3>

<p>
The safest way will be to upgrade to a recent snapshot, once one is 
available. <strong>Look for a snapshot first!</strong>. Bootstrapping the new 
compiler from the old should be a <em>last resort</em>.
</p>

<p>
First, note that some platforms have not been bootstrapped
successfully yet. To date, the following should work, if you are 
careful:
</p>

<ul>
<li><strong>i386</strong>
<li><strong>sparc</strong>
<li><strong>m68k</strong>
<li><strong>alpha</strong>
</ul>

<p>
<strong>mips</strong> and <strong>rs6000</strong> have problems.
</p>

<p>
To test whether your platform can be bootstrapped, grab and install
the egcs-snapshot, available from the 
<a href="../ports.html">ports collection</a>. 
If this works, the in-tree version likely will, too.
This is the <em>safest</em> method of proceeding.
</p>

<p>
Now, before going any further, ensure that your copies of
<em>binutils</em>, <em>gas</em>, and <em>ld</em> are up to date.  Note
that there are two copies of <em>gas</em> and <em>ld</em> in the tree.
On <strong>i386</strong> and <strong>sparc</strong>, the binutils
versions are not used.  Check <tt>/usr/src/gnu/usr.bin/gas</tt> and
<tt>/usr/src/gnu/usr.bin/ld</tt> instead.
</p>

<p>
The following instructions referred to the original egcs snapshot 
(egcs-990517). Since that time, a second snapshot (egcs-990608) has gone
into the tree. If you are coming from vanilla 2.5, it is unlikely that
you will be able to build the latest version directly. In this event, you
will have to bootstrap an intermediate version using these instructions.
</p>

<p>
From espie@openbsd.org:
</p>

<blockquote>
<pre>
Today, the compiler changes.

Exit gcc 2.8.1, enter egcs... or more precisely, gcc 2.95 prerelease.

This is probably going to be a rough ride, but I can't work out all
the kinks on every architecture by myself.

I'm going to start importing stuff *now*. There will be a second message
to tech@ once things are settled...

Thanks to everyone who helped me sorting stuff out, most especially
niklas, turan, and millert.

Why the switch
--------------
as most of you already know, egcs is now the *official* compiler supported
by the FSF.  The upcoming july release as been re-christened gcc 2.95.

Just looking at the log messages will show you many improvements:
support for newer processors is better, C++ is more accurately matching
the ANSI/ISO standards, Fortran 77 is more closely integrated.
There are also countless bug-fixes and code generation improvements.

Also the development is more open. There is a cvs tree, there are several
mailing-lists available, and we are cooperating closely with the egcs
team. More precisely, I've been feeding patches back to the egcs team
so that OpenBSD configurations are officially supported.
Also, the development team is highly responsive to bug-reports, and problems
get fixed.

There also is a band-wagon phenomenon: everyone is switching to egcs,
which means lots of code to test the compiler on, and that we can benefit
from related projects.

Why now
-------
egcs-1.1 was unfit for some purposes. Specifically, code size on i386
was larger than gcc 2.8.1, which yielded floppy-disks problems. 
At 2.5 freeze, the only code fit to include was a somewhat unstable
snapshot.  In the interest of stability, after much pondering, egcs was
not put into 2.5.

Right now, the egcs project is going through a release cycle which will
yield egcs 1.2.  Judging from their time schedule, there is ample margin
between egcs 1.2 and the next release of OpenBSD.  Also, we want to get
in now, so that we get a chance to report problems on less frequently 
used architectures, and get everything fixed for 1.2.

egcs `feature freeze' is supposed to occur on may 7th, and the current
snapshot 19990502 looks solid.

What works and what doesn't
---------------------------
egcs runs an i386 OpenBSD system without problems.  m68k works as well,
with a few work-arounds linked to obscure bugs that will get fixed.
sparc seems to be running as well.  There is some linker trouble on some 
other arches that needs to be fixed before our next release.

Right now, constructors across dynamic libraries are not quite ready.

egcs now features a stand-alone cpp which is going to be better than
the current hackish solution we use. This means a few interface changes
and possibly weird warnings.

Keeping gcc 2.8.1 ?
-------------------
due to size constraints, as soon as egcs is imported, gcc is going
to move to cvs Attic.  If you don't want to deal with egcs now, you'll
have to be careful through your cvs updates.
Some Makefiles are bound to change: includes, gnu/usr.bin, and gnu/lib.
xlint and cpp.sh are going to change as well.

How to bootstrap the compiler
-----------------------------
the simplest way is probably to trust the various arch maintainers
and download a snapshot.

If you want to do stuff the hard way, you must first remake proper
obj dirs:
cd /usr/src
make obj

If you run i386, gas must be up-to-date.
If you run sparc, ld must be up-to-date.

then build libiberty:
cd /usr/src/gnu/egcs/libiberty
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

then the C compiler:
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

rebuild the C compiler with the new version:
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

rebuild the includes
cd /usr/src/include
make includes

build all egcs libraries and install them
cd /usr/src/gnu/egcs
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

install the new cpp driver
cd /usr/src/usr.bin/cpp
make install

then you're all set, and a standard make build should work...
</pre>


<p>
[author note: Actually, it doesn't quite work. xlint will fail to build.
The fix is simple though. Simply do a 
<code> make &amp;&amp; make install </code>
in the <code>/usr/src/usr.bin/xlint/xlint</code> directory before 
you attempt a <em>make build</em> and proceed. See <a href="#4.2.2">4.2.2</a>.]
</p>

<pre>
If it doesn't, you're using an arch that didn't go through make build yet.
The most probably occurrence is an Internal Compiler Error, as known as an
ICE.

First try to see if the ICE will go away with -O1 or -O0. In that case, you
can put a work-around in the Makefile until it's fixed 
(see /usr/src/lib/libm/Makefile for an example of how to put in such
work-arounds for m68k).

Then the error needs to be reported to the egcs-bugs mailing list.

At a minimum, you must run the source through the same compiler invocation,
with an addition of -v -save-temps to the options.

-v yields the precise sequence of commands invoked by gcc. -save-temps
will give you a pre-processed C file (.i) or C++ (.ii) that the egcs people
can make sense of... you can't ask them to run OpenBSD on their boxes.

If you have more time, you can try to trim down the pre-processed C file to
the bare minimum that triggers the bug. Dichotomy works nicely.
</pre>
</blockquote>

If you made it through this procedure, and everything is still working,
congratulations. If not, check the following sections for advice. Problems
not listed here should be posted to tech@openbsd.org.

<a name="4.2.1"></a>
<h5>
4.2.1 - <tt>i386</tt> and <tt>sparc</tt> are no longer 
<tt>#define</tt>'ed
</h5>

<p>
This is true. <em>egcs</em> uses the cleaner <tt>__i386__</tt> and
<tt>__sparc__</tt>. If you need to compile code that relies on the old
defines, add a <tt>-Dsparc</tt> or <tt>-Di386</tt> 
to the appropriate location of your Makefile.
</p>

<a name="4.2.2"></a>
<h5>
4.2.2 - Build fails in xlint
</h5>

<p>
This is due to semantic differences in cpp. The workaround is simple,
and similar to the <em>cap_mkdb</em> issue described in <a href="#3.1">3.1</a>.
</p>

<p>
Do a:
</p>

<pre>
# cd /usr/src/usr.bin/xlint/xlint
# make &amp;&amp; make install
</pre>

<p>
now re-run make, and the build should continue.
</p>

<a name="4.2.3"></a>
<h5>
4.2.3 - Core Dump on <tt>uthread_autoinit.c</tt>
</h5>

<p>
You have fallen victim to a linker bug. Here's a relevant message:
</p>

<pre>
From: Marc Espie &lt;Marc.Espie@liafa.jussieu.fr&gt;
Subject: egcs core-dumping on uthread_autoinit.c

If this happens to you, this is a known linker problem... the cc1 you have
was linked in a weird way.

Initially, I made cc1 link against static /usr/lib/libiberty.a to avoid this
problem, but this was cutting things too close, and the bug reappeared,
probably thanks to unrelated changes in libc or elsewhere...

The tree has been patched with a work-around in

src/gnu/egcs/f/lang-options.h

make sure you have the kludged version of that file (at least rev 1.2),
recompile and reinstall cc1, the problem should go away.

What's going on is that the 386 linker gets something wrong because of
the huge strings array in toplev.c, and something gets mislinked, so
that
void f(void) __attribute((constructor)) {}
kills cc1.

As a work-around, I've killed Fortran options help texts, until someone finds
where the linker errs.
</pre>

<a name="4.2.4"></a>
<h5>
4.2.4 - <em>egcs</em> seems much slower than <em>gcc</em>
</h5>

<p>
It is, but there is a reason. <em>egcs</em> performs more optimizing passes.
Data alignment and other such functionality will be better with 
<em>egcs</em>-generated code.
</p>

<a name="4.2.5"></a>
<h5>
4.2.5 - <em>egcs</em> generates larger code than <em>gcc</em>
</h5>

<p>
Yes it does. This is especially noticeable with the old <tt>-O2</tt>
gcc switch.  <em>egcs</em> introduces a new option, <tt>-Os</tt> which
optimizes for space.  This is roughly comparable to the old
<TT>-O2</TT> behavior.
</p>

<a name="4.2.6"></a>
<h5>
4.2.6 - After installing <em>egcs</em> I have very little disk space left
</h5>

<p>
<em>egcs</em> installs into a different subdirectory than gcc 2.8.1. You
may remove <em>gcc</em> once egcs is bootstrapped and working.
</p>

<p>
On a related note, the perl changes mentioned in <a href="#4.1">4.1</a>
mean that you can remove the <tt>/usr/lib/perl5</tt> directory. The
new location for this data is <tt>/usr/libdata/perl5</tt>.
</p>

<a name="4.2.7"></a>
<h5>
4.2.7 - My build dies while making libcurses
</h5>

<p>
<em>libcurses</em> now relies on the latest version of <em>cpp</em>.
Fetch the latest version, rebuild <em>cpp</em>, and continue. Eg:
</p>
<pre>
# cd /usr/src/usr.bin/cpp &amp;&amp; make install
</pre>

<p>And try the make build again.</p>

<a name="4.2.8"></a>
<h5>
4.2.8 - make obj fails
</h5>

<p>
If your <em>make obj</em> fails, citing errors in a Makefile, your
makefile includes are likely out of date. For example:
</p>

<pre>
===> lib/libkvm
"Makefile", line 30: Malformed conditional ((${UVM} == "yes"))
"Makefile", line 30: Missing dependency operator
"Makefile", line 32: if-less endif
"Makefile", line 32: Need an operator
Fatal errors encountered -- cannot continue

</pre>

<p>
This can be solved by rebuilding the makefile includes. Do a:
</p>

<pre>
cd /usr/src/share/mk &amp;&amp; make install
</pre>

<p>
and try the build again.
</p>

<a name="4.3"></a>
<h3>
4.3: My <em>make build</em> dies with <em>unimplemented syscall</em> errors.
</h3>

<p><strong>Short Answer:</strong> </p>

<p>
The kernel structure <tt>statfs</tt> has changed. You will need to recompile
the kernel before attempting a <em>make build</em>.
</p>

<p><strong>Long Answer:</strong> </p>

<p>
The kernel structure <tt>statfs</tt> has changed. 
The new <tt>struct statfs</tt> has the following features:
</p>

<ul>
<li> Has a <tt>u_int32_t</tt> flags field--now softdep can have a real flag.
</li>

<li> Uses <tt>u_int32_t</tt> instead of longs (nicer on the alpha).  
Note: the man page used to lie about setting invalid/unused fields to -1.  
SunOS does that but our code never has.
</li>

<li> Gets rid of <tt>f_type</tt> completely.  It hasn't been used since NetBSD 
0.9, and having it there but always 0 is confusing.  It is conceivable
that this may cause some old code to not compile, but that is better
than silently breaking.
</li>

<li> Adds a <tt>mount_info</tt> union that contains the <tt>FSTYPE_args</tt>
struct.  This means that <em>mount</em> can now tell you all the options a 
filesystem was mounted with.  This is especially nice for NFS.
</li>
</ul>

<p>
Other changes:
</p>

<ul>
<li> The linux statfs emulation didn't convert between BSD fs names
and linux <tt>f_type</tt> numbers.  Now it does, since the BSD <tt>f_type</tt>
number is useless to linux apps (and has been removed anyway)
</li>

<li> FreeBSD's struct statfs is different from ours (both old and new)
and thus needs conversion.  Previously, the OpenBSD syscalls
were used without any real translation.
</li>

<li> <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mount&amp;apropos=0&amp;sektion=8&amp;manpath=OpenBSD+Current&amp;arch=i386&amp;format=html">mount(8)</a>
will now show extra info when invoked with no arguments.
However, to see <em>everything</em> you need to use the -v (verbose) flag. 
</li>
</ul>

<a name="4.4"></a>
<h3>
4.4: Link to the new 2.6 directory.
</h3>

<p>
When upgrading to 2.6 you'll need to create one simple link for gcc.
</p>

<pre>
   cd /usr/lib/gcc-lib
   ln -s ${ARCH}-unknown-openbsd2.5 ${ARCH}-unknown-openbsd2.6
</pre>

<a name="4.5"></a>
<h3>
4.5: After an <strong>(U)</strong>pgrade, extraction of <em>base26.tar.gz</em>
fails with a message:
</h3>

<p>
<em>tar: Unable to remove directory ./usr/include/machine &lt;Directory
not empty&gt;
</em>
</p>

<p>In 2.5, <tt>/usr/include/machine</tt> was a directory, and
<tt>/usr/include/i386</tt> was a link to it. In 2.6, this situation
is reversed.
</p>

<p>
To correct the problem, escape to the shell, remove the <tt>/usr/include/machine</tt> directory, and retry the upgrade.
</p>

<a name="5.0"></a>
<h2>
5.0 - Upgrading from 2.6
</h2>

<a name="5.1"></a>
<h3>
5.1: Termcap entries are too long.
</h3>

<p>
There is a new <tt>termcaps.master</tt> file. You will need
to regenerate the <tt>terminfo</tt> and <tt>termcaps</tt> files
with the current version of
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tic&amp;apropos=0&amp;sektion=1&amp;manpath=OpenBSD+Current&amp;arch=i386&amp;format=html">tic(1)</a>.
If you are upgrading via <em>make build</em>, the correct version of
tic(1) will be used and this will be done for you.  If not, you will
get the following error:
</p>

<pre>
    terminfo.src is corrupt! You need to update /usr/bin/tic
</pre>

<p>
In this case, you must either rebuild and install tic(1) (being sure
to use the current version of <tt>libcurses</tt>) or simply build
the version of tic(1) in your source tree.
</p>

<a name="5.2"></a>
<h3>
5.2: My <em>pn</em> (or <em>mx</em>, <em>al</em>, <em>ax</em>) device is no longer
recognized by the kernel.
</h3>

<p> (Note: <em>pn</em> is used below for simplicity. This should
be taken to read <em>pn</em>, <em>mx</em>, <em>al</em>, or <em>ax</em>
as appropriate)
</p>

<p>
These four drivers were replaced with the a unified <em>dc</em> driver.
You must change all occurrences of <em>pn*</em>, <em>mx</em>,
<em>al</em>, or <em>ax</em> in your configuration files. This includes:
</p>

<ul>
<li>Updating your kernel configuration file(s). (Hint: start with a
    fresh GENERIC kernel, and modify from there)
</li>
<li>mv'ing <tt>/etc/hostname.pn*</tt>  to <tt>/etc/hostname.dc*</tt>
</li>
<li>Updating your <tt>/etc/ifaliases</tt> file.
</li>
<li>Changing your <tt>/etc/ipnat.rules</tt> and <tt>/etc/ipf.rules</tt> to
    reflect the new interface name.</li>
</ul>

<p>
If you are modifying a custom kernel, make sure you have
included the <em>dcphy</em> device in your kernel config, as follows:
</p>

<pre>
dcphy*  at mii? phy ?                           # Digital Clone PHYs
</pre>

<p>While you are at it, you may also want to add:</p>

<pre>
ukphy*  at mii? phy ?                           # "unknown" PHYs
</pre>

<a name="5.3"></a>
<h3>
5.3: Upgrading gcc 2.95.1 to 2.95.2
</h3>

<p><em>gcc</em> 2.95.2 was merged into the OpenBSD source tree around
January 19, 2000. In order for <em>gcc</em> to build properly, a more
recent (post 2.6) <em>libiberty</em> is required. To build this library,
do the following:</p>

<pre>
	cd /usr/src/gnu/egcs/libiberty
	make -f Makefile.bsd-wrapper clean
	make -f Makefile.bsd-wrapper obj
	make -f Makefile.bsd-wrapper
	make -f Makefile.bsd-wrapper install
</pre>

<p>
NOTE: On mips-based architectures, such as pmax, you must
perform an explicit <em>ldconfig</em> after new libraries are build.
</p>

<p>Once <em>libiberty</em> is build, you may proceed with a standard
<em>gcc</em> bootstrap:</p>

<pre>
   cd /usr/src/gnu/egcs/gcc
   make -f Makefile.bsd-wrapper clean
   make -f Makefile.bsd-wrapper obj
   make -f Makefile.bsd-wrapper -DBOOTSTRAP
   make -f Makefile.bsd-wrapper -DBOOTSTRAP install
   make -f Makefile.bsd-wrapper clean
   make -f Makefile.bsd-wrapper 
   make -f Makefile.bsd-wrapper install
</pre>

<a name="5.4"></a>
<h3>
5.4: Upgrading Kerberos.
</h3>

<p>
For Kerberos IV to build correctly, you will have to perform the following
steps:
</p>

<ul>
<li>
<p> Obtain and build the latest <tt>usr.bin/compile_et</tt>. </p>
<pre>
   # cd /usr/src/usr.bin/compile_et
   # make clean &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>

<li>
<p> Obtain and build the latest <tt>lib/libcom_err</tt>. </p>
<pre>
   # cd /usr/src/lib/libcom_err
   # make clean &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>

<li>
<p> Clean out and reinstall the Kerberos header files: </p>
<pre>
  # rm -r /usr/include/kerberosIV/*
  # cd /usr/src/kerberosIV
  # make includes
</pre>
</li>
<li>
<p> Now, rebuild the Kerberos library files:</p>
<pre>
   # cd /usr/src/kerberosIV/lib
   # make clean &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>
<li>
<p> If you are not doing a complete make build, rebuild Kerberos:</p>
<pre>
   # cd /usr/src/kerberosIV
   # make cleandir &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>
<li> Otherwise, simply restart your <em>make build</em>. </li>
</ul>


<a name="5.5"></a>
<h3>
5.5: Upgrading M4.
</h3>

<p>
The version of m4 that shipped with OpenBSD 2.6 will get into an infinite
loop while processing the sendmail .mc files into .cf files.  Because
of this you will need to install the new version of m4 <strong>before</strong>
you attempt a <em>make build</em>.  In other words:
</p>

<pre>
    # cd /usr/src/usr.bin/m4
    # make &amp;&amp; make install &amp;&amp; make cleandir
</pre>

<a name="5.6"></a>
<h3>
5.6: Upgrading Sendmail.
</h3>

<p>
In sendmail 8.10.X, locations (and names) of the sendmail configuration files
have changed.  Everything but the pid file now lives in /etc/mail.
Additionally, several files have changed names.
</p>

<table border="0">
<tr>
  <td><strong>OLD</strong></td>
  <td><strong>NEW</strong></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.cf</tt></td>
  <td><tt>/etc/mail/sendmail.cf</tt></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.cw</tt></td>
  <td><tt>/etc/mail/local-host-names</tt></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.ct</tt></td>
  <td><tt>/etc/mail/trusted-users</tt></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.oE</tt></td>
  <td><tt>/etc/mail/error-header</tt></td>
</tr>
<tr>
  <td><tt>/etc/aliases</tt></td>
  <td><tt>/etc/mail/aliases</tt></td>
</tr>
<tr>
  <td><tt>/etc/service.switch</tt></td>
  <td><tt>/etc/mail/service.switch</tt></td>
</tr>
<tr>
  <td><tt>/etc/userdb</tt></td>
  <td><tt>/etc/mail/userdb</tt></td>
</tr>
<tr>
  <td><tt>/usr/share/misc/sendmail.hf</tt></td>
  <td><tt>/etc/mail/helpfile</tt></td>
</tr>
</table>

<p>
There are a couple of ways to convert from the old sendmail config
to the new, but the first step is always the same.
</p>

<ol>
<li> Update <tt>/etc/rc</tt> so that it looks for
     <tt>/etc/mail/sendmail.cf</tt> instead of <tt>/etc/sendmail.cf</tt>
</li>
<li> <tt>mv /etc/sendmail.cf /etc/mail/sendmail.cf</tt> <br />
     This is the path of least resistance and you won't have to change
     the location of any other files.
</li>
<li> Or, build a new .cf file from your .mc source file.  Note that you
     no longer need to specify the line:
     <pre>include(`../m4/cf.m4')</pre>
     since it will be included for you by make.  Also note that when
     adding machines to class w (via "Cw machinename"), you now need
     to do that in the LOCAL_CONFIG section (see <tt>openbsd-lists.mc</tt>
     for an example).
</li>
</ol>

<a name="5.7"></a>
<h3>
5.7: After upgrading, kernels that include 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=apm&amp;apropos=0&amp;sektion=8&amp;manpath=OpenBSD+Current&amp;arch=i386&amp;format=html">apm(8)</a>
support no longer boot.
</h3>

<p>
You need to update your bootblocks. See
<a href="faq14.html#14.8">Section 14.8</a>
of the OpenBSD FAQ for details.
</p>

<a name="6.0"></a>
<h2>
6.0 - Upgrading from 2.7
</h2>

<a name="6.1"></a>
<h3>
6.1: What are the major problems upgrading from 2.7 to 2.8?
</h3>

<p>
A significant gcc change was introduced that makes it all too easy
to generate self-referencing <em>libc</em> libraries. For this reason, upgrades
should follow exactly this procedure:
</p>

<ol>
<li> <a href="#1.10">Clean the cruft</a> from your source tree, and fetch
the 2.8 code.</li>

<li>
<p>
 Build and install a new linker. This <strong>must</strong> be done before
a full <em>gcc</em> build.
</p>
<pre>
  $ cd /usr/src/gnu/usr.bin/ld
  $ make clean &amp;&amp; make obj &amp;&amp; make
  $ sudo make install
</pre>
</li>
<li> Build and install the new <em>gcc</em>. Use the
     <a href="#1.8">BOOTSTRAP</a> procedure to speed
     things up.<p>
</li>

<li>
<p> Build a new kernel. Do not install it yet </p>
<pre>
  $ cd /usr/src/sys/arch/`machine`/conf
  $ config GENERIC
  $ cd ../compile/GENERIC
  $ make clean &amp;&amp; make depend &amp;&amp; make
</pre>
</li>

<li><p> Because of some libc changes, your machine may hang on startup unless
   your <tt>/etc/resolv.conf</tt> contains <em>lookup file bind</em>.
   Add this line if necessary </p>
<pre>
  # echo &quot;lookup file bind&quot; &gt;&gt; /etc/resolv.conf
</pre>
</li>
<li> Install the new kernel and reboot
<pre>
  # cd /usr/src/sys/arch/`machine`/compile/GENERIC
  # mv /bsd /bsd.old
  # mv bsd /bsd
  # chown root.wheel /bsd
  # shutdown -r now
</pre>
<p>
(If this step fails, you can recover by booting the old kernel - bsd.old -
at the <tt>boot&gt;</tt> prompt.)</p>
</li>
<li> 
<p>Build and install the new make (and support files). 
     Do not skip the <tt>make depend</tt> step.
</p>
<pre>
  $ cd /usr/src/usr.bin/make
  $ make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make
  $ sudo make install
  $ cd /usr/src/share/mk
  $ sudo make install
</pre>
</li>

<li> Install the latest <em>mtree</em>, and ensure the necessary directory
     structure is present.
<pre>
  $ cd /usr/src/etc/mtree
  $ sudo install -c -o root -g wheel -m 444 4.4BSD.dist /etc/mtree
  $ sudo mtree -qdef /etc/mtree/
</pre>
</li>

<li> Perform the make build
<pre>
  # cd /usr/src &amp;&amp; make build
</pre>
</li>

<li> <a href="#1.9">Update <tt>/etc</tt> <tt>/var</tt> and 
     <tt>/dev/MAKEDEV</tt></a> by hand.

</li>
</ol>

<a name="7.0"></a>
<h2>
7.0 - Upgrading from 2.8
</h2>

<a name="7.1"></a>
<h3>
7.1: New auth group
</h3>

<p>
A new group, <em>auth</em>, gid 11, has been added to the system.
Add a line like the following to your <tt>/etc/group</tt>:
</p>

<pre>
  auth:*:11:
</pre>

<a name="7.2"></a>
<h3>
7.2: New wscons console system
</h3>

<p>
The <em>pcvt</em> console driver has been replaced with the <em>wscons</em>
console system.
Before using wscons, you will need to create the new wscons-related devices.
Ensure you have the latest MAKEDEV installed, then make all devices:
</p>

<pre>
 # cp /usr/src/etc/etc.i386/MAKEDEV /dev/MAKEDEV
 # cd /dev
 # ./MAKEDEV all
</pre>

<p>
If you are running X, change the Pointer section of your <em>XF86Config</em> 
file to contain the following:
</p>

<pre>
    Protocol    "wsmouse"
    Device      "/dev/wsmouse"
</pre>

<a name="7.3"></a>
<h3>
7.3: Kernel compile fails with undefined symbols
</h3>

<p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;apropos=0&amp;sektion=8&amp;manpath=OpenBSD+Current&amp;arch=i386&amp;format=html">config(8)</a>
has been updated. Building with the old <em>config</em> will result
in errors like:
</p>

<pre>
  Undefined symbol `_pdevnames_size' referenced
  Undefined symbol `_pdevnames' referenced
</pre>

<p>
To correct this, compile and install the new <em>config</em>:
</p>

<pre>
  $ cd /usr/src/usr.sbin/config
  $ make clean &amp;&amp; make depend &amp;&amp; make
  $ sudo make install
</pre>

<p>
Now, recompile a new kernel as before.
</p>

<a name="8.0"></a>
<h2>
8.0 - Upgrading from 2.9
</h2>

<a name="8.1"></a>
<h3>
8.1: New users/groups - <em>proxy</em>, <em>smmsp</em>, and <em>popa3d</em>.
</h3>

<p>
First, with the addition of the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4"
>pf(4)</a> firewalling package, and its
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8"
>ftp-proxy(8)</a> suite, a new user and
group named <em>proxy</em> were added to the system.  To support this
addition, add the following user entry using 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>:
</p>

<pre>
proxy:*:71:71::0:0:Proxy Services:/nonexistent:/sbin/nologin
</pre>

<p>
Also add the <em>proxy</em> group to /etc/group:
</p>

<pre>
proxy:*:71:
</pre>

<p>
Second, as part of the Sendmail 8.12 upgrade, sendmail no longer runs
setuid root.  Both a new user and a new group, named <em>smmsp</em>,
have been added to the system.  Add a line like the following to your
<tt>/etc/group</tt>:
</p>

<pre>
smmsp:*:25:
</pre>

<p>
Then, run <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a> and add the following line for the <em>smmsp</em> user:
</p>

<pre>
smmsp:*:25:25::0:0:Sendmail Message Submission Program:/nonexistent:/sbin/nologin
</pre>

<p>
Make sure this line appears before any <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=yp&amp;sektion=8">yp(8)</a> settings line.
</p>

<p>Finally, a new user and group were added for Solar Designer's
popa3d server, now part of the core system. Add the following to
<tt>/etc/group</tt>:
</p>

<pre>
popa3d:*:26:
</pre> 

<p>
And using  <a 
href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8"
>vipw(8)</a>, add
</p>

<pre>
popa3d:*:26:26::0:0:POP3 server:/var/empty:/sbin/nologin
</pre>

<a name="8.2"></a>
<h3>
8.2: New packet filter: <em>pf</em>
</h3>

<p>
The IPF firewalling package that has been part of previous
OpenBSD releases has been replaced with an all-new firewalling suite
called <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4"
>pf(4)</a>. As a result, a number of changes need to be made.
</p>

<p>First, <em>pf</em> depends on a new device file. To ensure that this
special device is created, do the following:
</p>

<pre>
  $ cd /dev
  $ sudo cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  $ sudo ./MAKEDEV all
</pre>

<p>
Second, a number of filesystem change have occurred. For your
reference, the following binaries have been replaced:
</p>

<pre>
OLD:
/sbin/ipf /sbin/ipfstat /sbin/ipnat /usr/sbin/ipfs
/usr/sbin/ipftest /usr/sbin/ipmon /usr/sbin/ipresend
/usr/sbin/ipsend /usr/sbin/iptest
NEW:
/sbin/pfctl
/usr/libexec/ftp-proxy
</pre>

<p>
Similarly, for the devices:
</p>

<pre>
OLD: /dev/ipl /dev/ipnat /dev/ipstate /dev/ipauth
NEW: /dev/pf
</pre>

<p>
And finally, the filter configuration files:
</p>

<pre>
OLD: /etc/ipf.rules /etc/ipnat.rules
NEW: /etc/pf.conf /etc/nat.conf
</pre>

<p>
A mechanism for safely enabling <em>pf</em> has been added to the
<tt>/etc/rc</tt> and <tt>/etc/rc.conf</tt> files. You will need to
update these files to include the new hooking mechanism. If you wish
to enable <em>pf</em>, set PF=YES in <tt>/etc/rc.conf</tt>.
</p>

<a name="8.3"></a>
<h3>
8.3: Changes to <em>make</em>
</h3>

<p>
There have been changes to 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=make&amp;sektion=1"
>make(1)</a> and its data files which may cause difficulties in the
build process. This usually manifests as
errors from <em>bsd.own.mk</em> during the build. To avoid these issues,
first update
the data files:
</p>

<pre>
  $ cd /usr/src/share/mk
  $ sudo make install
</pre>

<p>
Then build and install the new make.
</p>

<pre>
  $ cd /usr/src/usr.bin/make
  $ make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make
  $ sudo make install
</pre>

<p>
Now proceed with your upgrade.
</p>

<h3><a name="8.4">
8.4: Build fails because of KerberosV errors
</a></h3>

<p>
Before you try building the whole system, you need to first
build KerberosV.
</p>

<p>
First, there is a new KerberosV configuration directory in
<em>/etc</em>.  If you have not already done so, use the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8"
>mtree(8)</a> procedure described in 
<a href="#1.13">section 1.13</a> to create it:
</p>

<p>
Now, build KerberosV
</p>

<pre>
  $ cd /usr/src/kerberosV
  $ sudo make obj
  $ cd lib/roken
  $ sudo make 
  $ cd ../../usr.bin/asn1_compile
  $ sudo make
  $ sudo make install
</pre>

<p>
You may also need to update your <tt>/etc/login.conf</tt>, to
reflect that the file <tt>/usr/libexec/auth/login_krb-or-pwd</tt> 
has been renamed to <tt>login_krb<strong>4</strong>-or-pwd</tt>.
</p>

<a name="8.5"></a>
<h3>
8.5: New sendmail version
</h3>

<p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8"
>sendmail(8)</a> has been upgraded to version 8.12. As this version of
<em>sendmail</em> no longer runs setuid root, significant changes have
resulted.
</p>

<ol>
<li> Both a new user and a new group (<em>smmsp</em>) have been added.
If you have not yet done so, follow the procedure in 
<a href="#8.1">section 8.1</a> to create them.
</li>

<li> Several changes to the file hierarchy have occurred, including a new
<tt>/var/spool/clientmqueue</tt> directory and new permissions for
<tt>/var/spool/mqueue</tt>.
These changes can both be made using the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8"
>mtree(8)</a> procedure described in 
<a href="#1.13">section 1.13</a>.
</li>

<li>
<p>
Add the following to root's <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">crontab(1)</a>. This is necessary since
<em>sendmail</em> is no longer setuid root, and relies on this entry to
do parts of its job:
</p>

<pre>
# sendmail clientmqueue runner
*/30    *       *       *       *       /usr/sbin/sendmail -L sm-msp-queue -Ac -q
</pre>
</li>

<li>
<p> Upgrade sendmail:</p>

<pre>
  $ cd /usr/src/gnu/usr.sbin/sendmail
  $ make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make &amp;&amp; sudo make install
</pre>

<p><strong>Note:</strong> The files <tt>submit.cf</tt> and <tt>localhost.cf</tt> have
been installed to your <tt>/etc/mail</tt> directory.
The first of these, <tt>submit.cf</tt> (referred to as the "client" 
configuration file in current sendmail documentation) is used by mail user 
agents that want to submit mail locally for delivery via sendmail.
Due to the permissions changes described above, this does not require
root privileges; the sendmail binary is set-groupid to group smmsp.
The second file, <tt>localhost.cf</tt>, is an OpenBSD-ism that runs
sendmail only listening on the localhost interface to accept mail 
from the local host but not accept connections from the network
(you almost certainly want this if you also use e.g., 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=smtpd&amp;sektion=8">smtpd(8)</a>
listening on the SMTP port on your outside interface).
For more details, see the file <tt>SECURITY</tt> in 
<tt>/usr/src/gnu/usr.sbin/sendmail/sendmail</tt>.
</p>

<p>It is highly recommended that you regenerate and update your
sendmail configuration files in <tt>/etc/mail</tt>. You can find some
working configuration files in <tt>/usr/share/sendmail/cf</tt>.
Note that localhost.cf is generated from openbsd-localhost.mc.
<p>
</li>

<li> 
<p>
If you were running sendmail without the <tt>-bd</tt>
option in <tt>/etc/rc.conf</tt>, as the default installation settings do, 
you will need to use <tt>localhost.cf</tt>. Edit <tt>rc.conf</tt> to
use the following:
</p>

<pre>
# For normal use: "-L sm-mta -bd -q30m"
sendmail_flags="-L sm-mta -C/etc/mail/localhost.cf -bd -q30m"
</pre>

</li>

<li>
<p>
Once your configuration file is ready, <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kill&amp;sektion=1">kill(1)</a> the existing sendmail:
</p>

<pre>
  kill `sed 1q /var/run/sendmail.pid`
</pre>

<p>
Restart the new sendmail with the appropriate options, for example:
</p>

<pre>
  /usr/sbin/sendmail -L sm-mta -bd -q30m
</pre>

<p>
for a configuration accepting mail from outside, or
</p>

<pre>
  /usr/sbin/sendmail -L sm-mta -C/etc/mail/localhost.cf -bd -q30m
</pre>

<p>
for a local mail-only configuration. 
</p>

<p><strong>Note:</strong> the <tt>-bd</tt> flag is now needed in both cases.
</p>

</li>

</ol>

<p>
The new <em>sendmail</em> should now be running.
</p>

<a name="8.6"></a>
<h3>
8.6: /etc/primes Moved
</h3>

<p>
<tt>/etc/primes</tt> has been renamed to <tt>/etc/moduli</tt>.
Simply copy this file from its old location or from <tt>/usr/src/etc</tt>.
</p>

<a name="9.0"></a>
<h2>
9.0 - Upgrading from 3.0
</h2>

<a name="9.1"></a>
<h3>
9.1: Removal of libdl on ELF platforms
</h3>

<p>
ELF-based platforms (alpha, macppc and sparc64) do not use libdl anymore. The
upgrade from a libdl system to a non-libdl is best done following these
steps:
</p>

<ul>
<li>
<p>Recompile your system:</p>
<pre>
$ cd /usr/src
$ make build
</pre>
</li>
<li>
<p>
If your &quot;make build&quot; completed successfully, you can step ahead
and remove libdl.  Note that packages that have been linked against it should
be reinstalled after that.  If you are not ready for this, you can skip this
step for now.  Snapshots with correct packages will be made available.
</p>
<pre>
# rm -f /usr/lib/libdl.* /usr/lib/libdl_pic.a
</pre>
<li>
<p>
With libdl removed, regen your shared libraries cache:
</p>

<pre>
# ldconfig -R
</pre>
</li>
</ul>

<a name="9.2"></a>
<h3>
9.2: New regression framework
</h3>

<p>
A new infrastructure for regression tests has been introduced and
<tt>bsd.regress.mk</tt> has been added.  You will need to install
this file before running <em>make obj</em>.
</p>

<pre>
  $ cd /usr/src/share/mk
  $ sudo make install
</pre>

<p>
--
</p>
<address>
<p>
$OpenBSD: upgrade-minifaq.html,v 1.85 2002/01/16 20:28:05 kjell Exp $
<br />
Copyright &copy; 1998-2002, Kjell Wooding. 
<br />
Please send any comments, questions, or suggestions to 
<a href="mailto:kjell@openbsd.org">kjell@openbsd.org</a>
</p>
</address>

</body>
</html>

