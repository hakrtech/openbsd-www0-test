<HTML>
<HEAD>
   <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
   <TITLE>OpenBSD Upgrading Mini-FAQ </TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#23238E">


<h2>MINI-FAQ: Upgrading OpenBSD</h2>
<h3>Latest OpenBSD Version - 2.5</h3>

<h4>Kjell Wooding 
&lt;<A HREF="mailto:kwooding@codetalker.com">kwooding@codetalker.com</A>&gt;
</h4>
Last Update - 03 Jun 1999

<P>

<BLOCKQUOTE>
<FONT SIZE=-1>
If you've ever tried compiling the <I>-current</I> sources from an older
OpenBSD release, you're aware that the process isn't always
straightforward. This Mini-FAQ is
an attempt to address the most common issues encountered when upgrading
between OpenBSD releases, or from the releases to <I>-current</I>
</FONT>
</BLOCKQUOTE>

<P>

<H3>1.0: General Upgrade Questions</H3>
<A HREF="#1.1">
1.1: Terminology. What is <I>-current</I>? What are Snapshots?
</A>
<BR>
<A HREF="#1.2">
1.2: What is the easiest way to upgrade to <I>-current</I>?
</A>
<BR>
<A HREF="#1.3">
1.3: I looked, but didn't see any snapshots on the FTP site. Where did
they go?
</A>
<BR>
<A HREF="#1.4">
1.4: How do I get the latest source?
</A>
<BR>
<A HREF="#1.5">
1.5: Okay, I have the tree. How do I build it.
</A>
<BR>
<A HREF="#1.6">
1.6: My make build stopped halfway. Do I have to redo the whole thing?
</A>
<BR>

<H3>2.0: Upgrading from 2.3</H3>
<A HREF="#2.1">
2.1: What are the major problems upgrading from 2.3 to 2.4?
</A>
<BR>
<A HREF="#2.2">
2.2: I tried the build, but it failed when trying to compile <I>ssleay</I>.
</A>
<BR>
<A HREF="#2.3">
2.3: I tried the build, but it failed when trying to make something for the
PowerPC.
</A>
<BR>

<H3>3.0: Upgrading from 2.4</H3>
<A HREF="#3.1">
3.1: What are the major problems upgrading from 2.4 to 2.5?
</A>
<BR>
<A HREF="#3.2">
3.2: I tried the build, but it failed on cap_mkdb.
</A>
<BR>

<H3>4.0: Upgrading from 2.5</H3>
<A HREF="#4.1">
4.1: What are the major problems upgrading from 2.5 to <I>-current</I>?
</A>
<BR>
<A HREF="#4.2">
4.2: How do I upgrade <i>gcc</i> to <i>egcs</i>
</A>
<font size=-1>
<Blockquote>
<A HREF="#4.2.1">4.2.1 - i386 and sparc are no longer #define'ed </A><BR>
<A HREF="#4.2.2">4.2.2 - Build fails in xlint </A><BR>
<A HREF="#4.2.3">4.2.3 - Core Dump on uthread_autoinit.c </A><BR>
<A HREF="#4.2.4">4.2.4 - egcs seems much slower than gcc </A><BR>
<A HREF="#4.2.5">4.2.5 - egcs generates larger code than gcc </A><BR>
<A HREF="#4.2.6">4.2.6 - After installing egcs I have very little disk space 
left </A>
</blockquote>
</font>

<A HREF="#4.3">
4.3: My <I>make build</I> dies with <I>unimplemented syscall</i> errors.
</A>

<P>


&nbsp;<HR Width=30%><P>

<H3>1.0: General Upgrade Questions</H3>
<h4><A NAME="1.1">
1.1: Terminology. What is <I>-current</I>? What are Snapshots?
</A>
</h4>
<P>
Unlike Operating System projects like Linux and FreeBSD, 
OpenBSD development happens from a single source tree. On approximately
six-month intervals, OpenBSD <B>releases</B> are produced. These are
numbered in the conventional (2.x) manner. The current OpenBSD release is
2.5. 
<P>

<B>-current</B>, short for <I>openbsd-current</I>, refers to the up-to-the-minute
version of the source tree contained in the CVS repository. This is the tree 
most commonly used by OpenBSD developers. The <I>-current</I> tree contains
all the code that is planned for the next release. From time to time,
brave souls will abandon the formal releases and run openbsd-current, usually
to take advantage of features that have not yet made it into the
formal releases. Because of its uncertain nature, however, upgrading
to -current is not recommended for non-technical users.

<P>
Between formal releases, a series of <B>snapshot</B> releases are 
<A HREF="ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/"> made available.</A> 
Snapshots are test releases of the <I>-current</I> source tree. 
Because they reflect the current state of development, 
there is no guarantee that snapshot releases will
work correctly (or even at all). Snapshots are quite useful when moving
from a formal release (or older version of -current) to the current tree.


<H4><A NAME="1.2">
1.2: What is the best way to upgrade to <I>-current</I>?
</A>
</H4>
<P>
Due to changes in the underlying libraries, moving directly from 
a release to <I>-current</I> is not always easy. 
The most painless way to
move up to <I>-current</I> is to first upgrade to the latest snapshot
(usually, via an FTP install). Once the snapshot is installed, the
latest source can be <A HREF="#1.4">fetched</A> and 
<A HREF="#1.5">built</A>. This
procedure should eliminate most toolchain and library problems.


<h4><A NAME="1.3">
1.3: I looked, but didn't see any snapshots on the FTP site. Where did
they go?
</A></H4>

The snapshots used to be taken temporarily offline right around the release
time of a new version. This is no longer the OpenBSD policy.
<P>
Snapshots may be removed as they become old (or no longer relevant).
If no snapshot is available, you should upgrade to the most recent
release and build the remainder of the way from source.


<h4><A NAME="1.4">
1.4: How do I get the latest source?</B>
</A></H4>

Short answer: <A HREF="http://www.openbsd.org/anoncvs.html">http://www.openbsd.org/anoncvs.html</A>

<P>

For example. To retrieve the entire tree via CVS:
(using the bash shell. Others substitute <I>setenv</I> for <I>export</I>)

<PRE>
 # export CVSROOT=anoncvs@anoncvs.ca.openbsd.org:/cvs
 # export CVS_RSH=/usr/local/bin/ssh
 # cd /usr
 # cvs -q get -PA src
</PRE>


<h4><A NAME="1.5">
1.5: Okay, I have the tree. How do I build it.
</A></H4>

<P>

Basic instructions are in /usr/src/Makefile. This is a slightly expanded
version.


<PRE>

1. Clean out the old object files.

   If you created a separate /usr/obj directory, clean that, and
   rebuild the symbolic links:

   # rm -rf /usr/obj
   # mkdir /usr/obj
   # cd /usr/src
   # make obj

   If you're worried there are object files in your source tree, 
   do this:

   # cd /usr/src
   # find . -type l -name obj | xargs rm
   # make cleandir
   # rm -rf /usr/obj
   # mkdir /usr/obj
   # make obj

2. Perform any verion-specific configuration changes. For example, 
   2.3 users must add the <I>named</I> user and group before
   moving to 2.4 or later. See the specific Mini-FAQ section for 
   your version.

3. Make sure all the appropriate directories are created. This
   is especially important when upgrading from older versions, but is
   sometimes necessary in other cases. The easiest way to do this is:

   # cd /usr/src/etc && make DESTDIR=/ distrib-dirs

4. Compile a new kernel.

   # cd /usr/src/sys/arch/`machine`/conf
   # cp GENERIC MYKERNEL
   # vi MYKERNEL
   (edit MYKERNEL to your liking)
   # config MYKERNEL
   # cd ../compile/MYKERNEL
   # make clean && make depend && make
   (arc architecture only) copy bsd.ecoff to your FAT partition
   # cp /bsd /bsd.old && cp bsd /bsd
   # chown root.wheel /bsd (if you compiled as someone else)
   (reboot)

5. Compile the system.

   # cd /usr/src
   # make build

6. Update /etc and /dev by hand. These are not updated 
   automatically. Choose a directory with enough space to 
   hold /, /dev, /var, and /etc. Here I'll use <I>/home/newroot</I> 
   (<B>Note</B>: make sure the directory hierarchy you choose
   does not have group write (g+w) or other write (o+w)  
   permissions or sendmail will complain during this step. 
   This makes /tmp a bad choice):

   # mkdir /home/newroot          
   # export DESTDIR=/home/newroot
   # cd /usr/src/etc && make distribution-etc-root-var
   
   Now compare the files in /home/newroot with their 
   installed counterparts. Replace or update the files as 
   necessary.

   # rm -rf /home/newroot   (when done)

7. Reboot to make sure the new /etc files are correct
</PRE>

<h4><A NAME=1.6">
1.6: My make build stopped halfway. Do I have to redo the whole thing?
</A></H4>

<P>

I would, but if you really want to pick up where you left off, do a:

<PRE>
 # cd /usr/src
 # make -n build
</PRE>

This will show you what make build is doing. For example, mine tells me:

<PRE>
 (cd /usr/src/share/mk &&  make install)
 (cd /usr/src/include;  make includes)
 make cleandir
 (cd /usr/src/lib && make depend && make &&   make install)
 (cd /usr/src/gnu/lib && make depend && make &&   make install)
 (cd /usr/src/kerberosIV && make build)
 make depend && make &&  make install
</PRE>

To pick up where you left off, just reissue the commands from the point
where the compile died.
<P>
If you do this procedure a lot, you may want to create a new target in your
makefile. Simply copy the entry for <I>build</I> (to 
<I>build-noclean</I>, for example), and remove the <I>make cleandir</I> 
reference.



<H3>2.0: Upgrading from 2.3</H3>
<h4><A NAME="2.1">
2.1: What are the major problems upgrading from 2.3 to 2.4?
</A></H4>

<P>
<h4>New User: <i>named</i></h4>

After 2.3, the <I>named</I> DNS daemon was moved to a chroot jail.
To make this change possible, the <I>named</I> user was created.
If you do not have it already, you will need to create this user to
ensure that all directories get created properly during the build process.
<P>

Add the following entry to /etc/passwd using vipw
<PRE>
   named:*:70:70::0:0:BIND Daemon:/var/named:/sbin/nologin
</PRE>
   
Add the following to /etc/group:
<PRE>
   named:*:70:
</PRE>


<h4><A NAME="2.2">
2.2: I tried the build, but it failed when trying to compile <I>ssleay</I>.
</A></H4>

You are likely missing an entry for the <I>named</I> user in your
password file.

<P>
<B>Short Answer:</B>
<P>
Create this user prior to the build.

<P>

<B>Long Answer:</B>

<P>

The <I>named</I> user is required in order to set permissions
correctly.  If this user is missing, part of the build process fails.
If you capture your build to a file (say, with a <I>make build
&>/tmp/build.log</I>) you will notice the following message:

<PRE>
  (cd /usr/src/etc && make DESTDIR=/ distrib-dirs)
  install -d -o root -g wheel -m 755 /
  mtree -def mtree/4.4BSD.dist -p // -u
  
  mtree: unknown user named
  mtree: failed at line 1632 of the specification
  *** Error code 1 (ignored)
</PRE>

Unfortunately for us, the build continued happily on its way,
totally ignoring the fact that an error occurred.

<P>

If the <I>named</I> user exists, mtree works properly:

<PRE>
  missing: ./var/named (created)
  missing: ./var/named/dev (created)
  missing: ./var/named/etc (created)
  missing: ./etc/afs (created)
  missing: ./etc/ssl (created)
  missing: ./etc/ssl/private (created)
  missing: ./usr/obj (not created: File exists)
  missing: ./usr/share/doc/html (created)
  missing: ./usr/share/doc/html/lynx_help (created)
  missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
  missing: ./usr/share/doc/usd/13.viref (created)
  missing: ./usr/share/man/cat4/powerpc (created)
  missing: ./usr/share/man/man4/alpha (created)
  missing: ./usr/share/man/man4/pmax (created)
  missing: ./usr/share/man/man4/powerpc (created)
  missing: ./usr/share/tmac/mdoc (created)
  missing: ./var/www/htdocs/manual/vhosts (created)
  missing: ./usr/include/ssl (created)
</PRE>

The reason for the fail, then, is that the <I>/usr/include/ssl</I> directory
was never created. Without the header files, the <I>ssleay</I> build fails.

<P>

<B>Fix:</B>

<P>

Create the <I>named</I> user and group. Remove <I>/usr/include/ssl</I>,
<I>/var/named</I>, and any other directory from the list above that was
mistakenly created as a normal file by the <I>make build</I>.



<h4><A NAME="2.3">
2.3: I tried the build, but it failed when trying to make something for the
PowerPC.
</A></H4>

<P>

Your directory tree is incomplete. Specifically, the 
/usr/share/man/cat4/powerpc directory is missing. 

<P>
<B>Quick Fix:</B><P>
Create this directory and proceed with the compilation

<P>
<B>Complete Fix:</B>
<P>

Create the entire directory tree. Do a:

<PRE>
  # cd /usr/src/etc && make DESTDIR=/ distrib-dirs
</PRE>

You will likely see an output like the following:

<PRE>
  install -d -o root -g wheel -m 755 /
  mtree -def mtree/4.4BSD.dist -p // -u

  missing: ./var/named (created)
  missing: ./var/named/dev (created)
  missing: ./var/named/etc (created)
  missing: ./etc/afs (created)
  missing: ./etc/ssl (created)
  missing: ./etc/ssl/private (created)
  missing: ./usr/obj (not created: File exists)
  missing: ./usr/share/doc/html (created)
  missing: ./usr/share/doc/html/lynx_help (created)
  missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
  missing: ./usr/share/doc/usd/13.viref (created)
  missing: ./usr/share/man/cat4/powerpc (created)
  missing: ./usr/share/man/man4/alpha (created)
  missing: ./usr/share/man/man4/pmax (created)
  missing: ./usr/share/man/man4/powerpc (created)
  missing: ./usr/share/tmac/mdoc (created)
  missing: ./var/www/htdocs/manual/vhosts (created)
  missing: ./usr/include/ssl (created)
</PRE>

Note that /usr/share/man/cat4/powerpc was one of the directories created by this process.

<H3>3.0: Upgrading from 2.4</H3>
<h4><A NAME="3.1">
3.1: What are the major problems upgrading from 2.4 to 2.5?
</A></H4>

<P>
<h4>cap_mkdb</h4>

The syntax for invoking <I>cap_mkdb</I> has changed slightly.
Before doing a <I>make build</I>, rebuild cap_mkdb from the latest source:
<PRE>
# cd /usr/src/usr.bin/cap_mkdb
# make clean && make && make install
</PRE>
The make build should then run to completion

<P>

<h4>Man Page Changes</h4>
Several man pages were moved from section 1 to later sections
Unfortunately, if the old man pages are left in section 1, unwary
users will not see the latest version of the page.
<P>
The following pages should be removed:
<PRE>
/usr/share/man/cat1/ipf.0
/usr/share/man/cat1/ipnat.0
/usr/share/man/cat1/ipsecadm.0
</PRE>

<H4>Snake</h4>
You will need to remove the contents of the obj directory before upgrading
<code>/usr/src/games/snake</code>.


<h4><A NAME="3.2">
3.2: I tried the build, but it failed on cap_mkdb.
</A></H4>

<B>Symptom:</B>
<P>

A <I>make build</I> resulted in an error like this:
<PRE>
  cap_mkdb -i -f terminfo terminfo.src
  cap_mkdb: illegal option -- i
  usage: cap_mkdb [-v] [-f outfile] file1 [file2 ...]
  *** Error code 1
</PRE>

<B>Quick Fix:</B><P>

You need to build a new <I>cap_mkdb</I>. See 
<A HREF="#3.1">3.1</A>.


<H3>4.0: Upgrading from 2.5</H3>
<h4><A NAME="4.1">
4.1: What are the major problems upgrading from 2.5 to <I>-current</I>?
</A></H4>

<P>

<h5><I>perl</I> and <i>make</I></h5>
The latest version of Perl (5.005_03) requires a new version of <I>make</I> to
compile properly. You must rebuild make before building the new Perl. Do a:
<PRE>
# cd /usr/src/usr.bin/make
# make clean && make && make install
</PRE>
Then go ahead and rebuild the new Perl. You will need to clean out the Perl
<CODE>obj</CODE> directory by hand before building.
<P>

Perl developers should take note of the latest changes. From 
millert@openbsd.org:

<PRE>
The version of perl in the OpenBSD source tree (post 2.5) has been
upgraded to 5.005_03.  The build method has changed somewhat but
most of that should be invisible.  The important changes that affect
people are as follows:

    1) Perl lib files have moved from /usr/lib/perl5 to the more correct
       /usr/libdata/perl5
    2) The default site_perl directories now live in /usr/local.  Ie:
       if you install a perl module, it will place itself in
       /usr/local/libdata/perl5/site_lib.  This makes it easy to
       see what non-stock modules you have.  It also means that we
       can have perl modules in the ports system easily.
    3) The perl library man pages are now install in /usr/share/man/cat3p
       You'll need to update your man.conf based on the src/etc/man.conf
       to take advantage of them.  This means you can now do
       "man 3p less" and get info on the less pragma but "man less"
       will still get you the less pager manpage.

If you have modules or other non-stock perl files the simplest thing
to do is to move /usr/lib/perl5 to /usr/libdata/perl5 and add a link
from /usr/lib/perl5 to /usr/libdata/perl5.  Alternately, you could
just edit the installed Config.pm file and fix up the paths there.

</PRE>

<H5>Compiler Change: <I>egcs</I> replaces <I>gcc</I></H5>
This change is likely the most significant change you will encounter.
For detailed instructions, see section <A HREF="#4.2">4.2</A>.

<H5>Kernel Structure - <I>statfs</I> - changed</H5>
The <tt>statfs</tt> structure has changed as of May 31. You must
rebuild your kernel before attempting a <i>make build</i>.
See <A HREF="#4.3">4.3</A> for details.

<h4><A NAME="4.2">
4.2: How do I upgrade <i>gcc</i> to <i>egcs</i>
</A></H4>

The safest way will be to upgrade to a recent snapshot, once one is 
available. Until then (or for the brave of heart) read
the following <i>carefully</i>.

<P>
First, note that some platforms have not been bootstrapped
successfully yet. To date, the following should work, if you are 
careful:
<UL>
<LI><b>i386</b>
<LI><b>sparc</b>
<LI><b>m68k</b>
<LI><b>alpha</b>
</UL>
<B>mips</b> and <b>rs6000</b> have problems.

<P>
To test whether your platform can be bootstrapped, grab and install
the egcs-snapshot, available from the 
<A HREF="http://www.openbsd.org/ports.html">ports collection</A>. 
If this works, the in-tree version likely will, too.
This is the <i>safest</i> method of proceeding.

<P>
Now, before going any futher, ensure that your copies of 
<I>binutils</i>, <I>gas</i>, and <I>ld</I> are up to date.
Note that there are two copies of <I>gas</I> and <i>ld</i> in the tree. 
On <b>i386</b> and <b>sparc</b>, the binutils versions are not used.
Check 
<tt>/usr/src/gnu/usr.bin/gas</tt> and <tt>/usr/src/gnu/usr.bin/ld</tt>
instead.

<P>
To bootstrap to the in-tree egcs, read the following carefully.<P> 
From espie@openbsd.org:
<blockquote>
<PRE>
Today, the compiler changes.

Exit gcc 2.8.1, enter egcs... or more precisely, gcc 2.95 prerelease.

This is probably going to be a rough ride, but I can't work out all
the kinks on every architecture by myself.

I'm going to start importing stuff *now*. There will be a second message
to tech@ once things are settled...

Thanks to everyone who helped me sorting stuff out, most especially
niklas, turan, and millert.

Why the switch
--------------
as most of you already know, egcs is now the *official* compiler supported
by the FSF.  The upcoming july release as been re-christened gcc 2.95.

Just looking at the log messages will show you many improvements:
support for newer processors is better, C++ is more accurately matching
the ANSI/ISO standards, Fortran 77 is more closely integrated.
There are also countless bug-fixes and code generation improvements.

Also the development is more open. There is a cvs tree, there are several
mailing-lists available, and we are cooperating closely with the egcs
team. More precisely, I've been feeding patches back to the egcs team
so that OpenBSD configurations are officially supported.
Also, the development team is highly responsive to bug-reports, and problems
get fixed.

There also is a band-wagon phenomenon: everyone is switching to egcs,
which means lots of code to test the compiler on, and that we can benefit
from related projects.

Why now
-------
egcs-1.1 was unfit for some purposes. Specifically, code size on i386
was larger than gcc 2.8.1, which yielded floppy-disks problems. 
At 2.5 freeze, the only code fit to include was a somewhat unstable
snapshot.  In the interest of stability, after much pondering, egcs was
not put into 2.5.

Right now, the egcs project is going through a release cycle which will
yield egcs 1.2.  Judging from their time schedule, there is ample margin
between egcs 1.2 and the next release of OpenBSD.  Also, we want to get
in now, so that we get a chance to report problems on less frequently 
used architectures, and get everything fixed for 1.2.

egcs `feature freeze' is supposed to occur on may 7th, and the current
snapshot 19990502 looks solid.

What works and what doesn't
---------------------------
egcs runs an i386 OpenBSD system without problems.  m68k works as well,
with a few work-arounds linked to obscure bugs that will get fixed.
sparc seems to be running as well.  There is some linker trouble on some 
other arches that needs to be fixed before our next release.

Right now, constructors across dynamic libraries are not quite ready.

egcs now features a stand-alone cpp which is going to be better than
the current hackish solution we use. This means a few interface changes
and possibly weird warnings.

Keeping gcc 2.8.1 ?
-------------------
due to size constraints, as soon as egcs is imported, gcc is going
to move to cvs Attic.  If you don't want to deal with egcs now, you'll
have to be careful through your cvs updates.
Some Makefiles are bound to change: includes, gnu/usr.bin, and gnu/lib.
xlint and cpp.sh are going to change as well.

How to bootstrap the compiler
-----------------------------
the simplest way is probably to trust the various arch maintainers
and download a snapshot.

If you want to do stuff the hard way, you must first remake proper
obj dirs:
cd /usr/src
make obj

If you run i386, gas must be up-to-date.
If you run sparc, ld must be up-to-date.

then build libiberty:
cd /usr/src/gnu/egcs/libiberty
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

then the C compiler:
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

rebuild the C compiler with the new version:
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

rebuild the includes
cd /usr/src/include
make includes

build all egcs libraries and install them
cd /usr/src/gnu/egcs
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

install the new cpp driver
cd /usr/src/usr.bin/cpp
make install

then you're all set, and a standard make build should work...
</PRE>

[author note: Actually, it doesn't quite work. xlint will fail to build.
The fix is simple though. Simply do a <CODE> make && make install </CODE>
in the <CODE>/usr/src/usr.bin/xlint/xlint</CODE> directory before 
you attempt a <i>make build</i> and proceed. See <A HREF="#4.2.2">4.2.2</A>.]

<PRE>
If it doesn't, you're using an arch that didn't go through make build yet.
The most probably occurrence is an Internal Compiler Error, as known as an
ICE.

First try to see if the ICE will go away with -O1 or -O0. In that case, you
can put a work-around in the Makefile until it's fixed 
(see /usr/src/lib/libm/Makefile for an example of how to put in such
work-arounds for m68k).

Then the error needs to be reported to the egcs-bugs mailing list.

At a minimum, you must run the source through the same compiler invocation,
with an addition of -v -save-temps to the options.

-v yields the precise sequence of commands invoked by gcc. -save-temps
will give you a pre-processed C file (.i) or C++ (.ii) that the egcs people
can make sense of... you can't ask them to run OpenBSD on their boxes.

If you have more time, you can try to trim down the pre-processed C file to
the bare minimum that triggers the bug. Dichotomy works nicely.
</PRE>
</blockquote>

If you made it through this procedure, and everything is still working,
congratulations. If not, check the following sections for advice. Problems
not listed here should be posted to tech@openbsd.org.

<A NAME="4.2.1">
<H5>4.2.1 - <tt>i386</tt> and <tt>sparc</tt> are no longer 
<tt>#define</tt>'ed</H5>
</A>

This is true. <I>egcs</i> uses the cleaner <tt>__i386__</tt> and
<tt>__sparc__</tt>. If you need to compile code that relies on the old
defines, add a <tt>-Dsparc</tt> or <tt>-Di386</tt> 
to the appropriate location of your Makefile.

<A NAME="4.2.2">
<H5>4.2.2 - Build fails in xlint</H5>
</A>

This is due to semantic differences in cpp. The workaround is simple,
and similar to the <i>cap_mkdb</i> issue described in <A HREF="#3.1">3.1</A>.
<P>
Do a:

<PRE>
# cd /usr/src/usr.bin/xlint/xlint
# make && make install
</PRE>

now re-run make, and the build should continue.

<A NAME="4.2.3">
<H5>4.2.3 - Core Dump on <tt>uthread_autoinit.c</tt></h5>
</A>

You have fallen victim to a linker bug. Here's a relevant message:

<PRE>
   From: Marc Espie <Marc.Espie@liafa.jussieu.fr>
   Subject: egcs core-dumping on uthread_autoinit.c

   If this happens to you, this is a known linker problem... the cc1 you have
   was linked in a weird way.

   Initially, I made cc1 link against static /usr/lib/libiberty.a to avoid this
   problem, but this was cutting things too close, and the bug reappeared,
   probably thanks to unrelated changes in libc or elsewhere...

   The tree has been patched with a work-around in

   src/gnu/egcs/f/lang-options.h

   make sure you have the kludged version of that file (at least rev 1.2),
   recompile and reinstall cc1, the problem should go away.

   What's going on is that the 386 linker gets something wrong because of
   the huge strings array in toplev.c, and something gets mislinked, so
   that
   void f(void) __attribute((constructor)) {}
   kills cc1.

   As a work-around, I've killed Fortran options help texts, until someone finds
   where the linker errs.
</PRE>

<A NAME="4.2.4">
<H5> 4.2.4 - <i>egcs</i> seems much slower than <i>gcc</i></H5>
</A>

It is, but there is a reason. <I>egcs</i> performs more optimizing passes.
Data alignment and other such functionality will be better with 
<I>egcs</i>-generated code.

<A NAME="4.2.5">
<H5>4.2.5 - <I>egcs</i> generates larger code than <i>gcc</i></H5>
</A>

Yes it does. This is especially noticable with the old <tt>-O2</tt> gcc switch. 
<I>egcs</I> introduces a new option, <tt>-Os</tt> which optimizes for space.
This is roughly comparable to the old <TT>-O2</TT> behavior.

<A NAME="4.2.6">
<H5>4.2.6 - After installing <i>egcs</i> I have very little disk space left</h5>
</A>

<i>egcs</i> installs into a different subdirectory than gcc 2.8.1. You
may remove <I>gcc</i> once egcs is bootstrapped and working.

(on a related note, the perl changes mentioned in <A HREF="#4.1">4.1</A>
mean that you can remove the <tt>/usr/lib/perl5</tt> directory. The
new location for this data is <tt>/usr/libdata/perl5</tt>.)


<h4><A NAME="4.3">
4.3: My <I>make build</I> dies with <I>unimplemented syscall</i> errors.
</A></H4>
<B>Short Answer:</B> <P>

The kernel structure <tt>statfs</tt> has changed. You will need to recompile
the kernel before attempting a <I>make build</I>.
<P>

<B>Long Answer:</B> <P>
The kernel structure <tt>statfs</tt> has changed. 
The new <tt>struct statfs</tt> has the following features:

<UL>
<LI> Has a <tt>u_int32_t</tt> flags field--now softdep can have a real flag.

<LI> Uses <tt>u_int32_t</tt> instead of longs (nicer on the alpha).  
Note: the man page used to lie about setting invalid/unused fields to -1.  
SunOS does that but our code never has.

<LI> Gets rid of <tt>f_type</tt> completely.  It hasn't been used since NetBSD 
0.9 and having it there but always 0 is confusing.  It is conceivable
that this may cause some old code to not compile but that is better
than silently breaking.

<LI> Adds a <tt>mount_info</tt> union that contains the <tt>FSTYPE_args</tt>
struct.  This means that <I>mount</I> can now tell you all the options a 
filesystem was mounted with.  This is especially nice for NFS.
</UL>

Other changes:

<UL>
<LI> The linux statfs emulation didn't convert between BSD fs names
and linux <tt>f_type</tt> numbers.  Now it does, since the BSD <tt>f_type</tt>
number is useless to linux apps (and has been removed anyway)

<LI> FreeBSD's struct statfs is different from our (both old and new)
and thus needs conversion.  Previously, the OpenBSD syscalls
were used without any real translation.

<LI> <B>mount(8)</B> will now show extra info when invoked with no arguments.
However, to see <I>everything</I> you need to use the -v (verbose) flag. 
</UL>

<P>
<FONT SIZE=-1>
--
<BR>
$OpenBSD: upgrade-minifaq.html,v 1.3 1999/06/03 20:08:31 kjell Exp $

<BR>
Copyright &copy; 1998-1999, Kjell Wooding. 
<BR>
Please send any comments, questions, or suggestions to 
<A HREF="mailto:kwooding@codetalker.com">kwooding@codetalker.com</A>

</FONT>

</BODY>
</HTML>

