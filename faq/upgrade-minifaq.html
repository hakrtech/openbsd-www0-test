<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title>OpenBSD Upgrading Mini-FAQ</title>
  </head>

  <body bgcolor="#FFFFFF" text="#000000" link="#23238E">

    <h1>MINI-FAQ: Upgrading OpenBSD</h1>

    <h2>Latest OpenBSD Release - 3.3</h2>

    <address>
      <p>Kjell Wooding 
	&lt;<a href="mailto:kjell@openbsd.com">kjell@openbsd.org</a>&gt;<br>
	Updated: 
	$OpenBSD: upgrade-minifaq.html,v 1.176 2003/10/23 16:35:24 henning Exp $</p>
    </address>
    <br>
    
    <blockquote>
      <p>This Mini-FAQ is an attempt to address the most common
      issues encountered when upgrading between OpenBSD releases,
      or from the releases to <em>-current</em>. Though hardly
      <em>Mini</em> anymore, this document retains the Mini-FAQ
      moniker for historical and/or consistency reasons.
      Information on older versions can be found in a <a href=
      "upgrade-old.html">separate document</a>.</p>
    </blockquote>

    <p>
      The Upgrade-MiniFAQ is intended for <b>Advanced Users</b>.
      If you are a beginner, or are <b>not completely confident</b>
      with your compiler and toolchain, then upgrading via source is
      <b>not for you</b>. Install a binary release or snapshot instead,
      then apply any relevant instructions below for upgrading
      <tt>/etc</tt>.
    </p>

    <h2>General Upgrade Questions</h2>
    
    <p>
      <a href="#1.1">1.1: Terminology. What is <em>-current</em>?
	What are Snapshots? What is <em>-stable</em>?</a><br>
      
      <a href="#1.2">1.2: What is the easiest way to upgrade to
	<em>-current</em>?</a><br>
      
      <a href="#1.3">1.3: I looked, but didn't see any snapshots on
	the FTP site. Where did they go?</a><br>
      
      <a href="#1.4">1.4: How do I get the latest source?</a><br>
      
      <a href="#1.5">1.5: Okay, I have the tree. How do I build
	it?</a><br>
      
      <a href="#1.6">1.6: My make build stopped halfway. Do I have
	to redo the whole thing?</a><br>
      
      <a href="#1.7">1.7: I'm getting errors during the build. What
	do I do?</a><br>
      
      <a href="#1.8">1.8: Is there a standard way of
	upgrading the compiler, <em>gcc</em>?</a><br>
      
      <a href="#1.9">1.9: What is the best way to upgrade
	<tt>/etc</tt>, <tt>/var</tt>, and <tt>/dev</tt>?</a><br>
      
      <a href="#1.10">1.10: How do I clean all the cruft out of my
	existing source tree?</a><br>
      
      <a href="#1.11">1.11: Do I have to be root to do a <em>make
	  build</em>?</a><br>
      
      <a href="#1.12">1.12: Why am I not seeing any new
	devices?</a><br>
      
      <a href="#1.13">1.13: Is there an easy way to make all the
	file hierarchy changes?</a><br>

      <a href="#1.14">1.14: After an upgrade, <em>ps</em> now reports
	"proc size mismatch."</a><br>

      <a href="#1.15">1.15: How can I upgrade to the latest snapshot?</a><br>


    </p>
    
    <h2>Upgrading from 3.4</h2>
    <p>
      <a href="#3.4.1">3.4.1: svnd device minor numbers changed</a>
    </p>
  
    <h2>Upgrading from 3.3</h2>

    <p>
      <a href="#3.3.1">3.3.1: i386 W^X support </a><br>
      <a href="#3.3.2">3.3.2: mquery syscall change</a><br>
      <a href="#3.3.3">3.3.3: i386 flag day, exe addr/MAXDSIZ change</a><br>
      <a href="#3.3.4">3.3.4: config change</a><br>
      <a href="#3.3.5">3.3.5: Use __attribute__((bounded)) on certain
                functions</a><br>
      <a href="#3.3.6">3.3.6: New user and group _syslogd</a><br>
      <a href="#3.3.7">3.3.7: New format attribute __kprintf__ in kernel 
		headers</a><br>
    </p>
    
    <h2>Upgrading from 3.2</h2>
    
    <p>
      <a href="#3.2.1">3.2.1: New Perl</a><br>
      <a href="#3.2.2">3.2.2: New groups _radius, _token and _shadow</a><br>
      <a href="#3.2.3">3.2.3: Important compiler changes</a><br>
      <a href="#3.2.4">3.2.4: New user and group _spamd</a><br>
      <a href="#3.2.5">3.2.5: Alias for ipv6-icmp</a><br>
      <a href="#3.2.6">3.2.6: New group _lkm</a><br>
      <a href="#3.2.7">3.2.7: New libpthread</a><br>
      <a href="#3.2.8">3.2.8: Linker changes for ELF architectures </a><br>
      <a href="#3.2.9">3.2.9: Removal of /var/at and crontab changes </a><br>
    </p>
    
    <h2>Upgrading from 3.1</h2>
    
    <p>
      <a href="#3.1.1">3.1.1: New users/groups</a><br>
      <a href="#3.1.2">3.1.2: New group for crontab(1) and at(1)</a><br>
      <a href="#3.1.3">3.1.3: New Binutils</a><br>
      <a href="#3.1.4">3.1.4: New S/Key configuration</a><br>
      <a href="#3.1.5">3.1.5: New permissions for lp*</a><br>
      <a href="#3.1.6">3.1.6: atrun(8) no longer needed</a><br>
      <a href="#3.1.7">3.1.7: nat.conf merged into pf.conf</a><br>
      <a href="#3.1.8">3.1.8: New fbtab entry needed for xdm</a><br>
      <a href="#3.1.9">3.1.9: Use __attribute__((sentinel)) on certain
		functions</a><br>
    </p>

    <h2>Upgrading from 3.0</h2>
    
    <p>
      <a href="#3.0.1">3.0.1: New keyword supported by mtree(8)</a><br>
      <a href="#3.0.2">3.0.2: Removal of libdl on ELF platforms</a><br>
      <a href="#3.0.3">3.0.3: New regression framework</a><br>
      <a href="#3.0.4">3.0.4: ssh config files moved to /etc/ssh/</a><br>
    </p>
    
    <h2>Upgrading from 2.9</h2>

    <p>
      <a href="#2.9.1">2.9.1: New users/groups - <em>proxy</em>,
	<em>smmsp</em> and <em>popa3d</em></a><br>

      <a href="#2.9.2">2.9.2: New packet filter: <em>pf</em></a><br>

      <a href="#2.9.3">2.9.3: Changes to <em>make</em></a><br>

      <a href="#2.9.4">2.9.4: Build fails because of KerberosV
	errors</a><br>

      <a href="#2.9.5">2.9.5: New <em>sendmail</em> version</a><br>

      <a href="#2.9.6">2.9.6: <tt>/etc/primes</tt> Moved</a>

    </p>
    

    <h2>Upgrading from Earlier Versions</h2>

    <p>Information on upgrading from OpenBSD 2.3 to 2.8 
      has been moved to a <a href="upgrade-old.html">separate
	document</a>. This document was getting just
      too darn big.</p>


    &nbsp;<hr width="30%">

    <a name="1.0"></a> 
    <h2>General Upgrade Questions</h2>

    <a name="1.1"></a> 
    <h3>1.1: Terminology. What is <em>-current</em>? What are
      Snapshots? What is <em>-stable</em>?</h3>
    
    <p>Prior to OpenBSD 2.7, OpenBSD development happened from a
      single, unbranched source tree. As of 2.7, a patch branch was
      introduced.</p>
    
    <p>At approximately six-month intervals, OpenBSD
      <em>releases</em> are produced. These are numbered in the
      conventional (2.x, 3.x) manner. The current OpenBSD release is
      indicated at the top of this document.</p>
    
    <p><em>-current</em>, short for <em>openbsd-current</em>,
      refers to the up-to-the-minute version of the source tree
      contained in the CVS repository. This is the tree most commonly
      used by OpenBSD developers. The <em>-current</em> tree contains
      all the code that is planned for the next release. From time to
      time, brave souls will abandon the formal releases and run
      openbsd-current, usually to take advantage of features that
      have not yet made it into the formal releases. Because of its
      uncertain nature, however, upgrading to <em>-current</em> is
      not recommended for non-technical users.</p>
    
    <p>Between formal releases, a series of <em>snapshot</em>
      releases are
      <a href="ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/">made
	available.</a> Snapshots are test releases of the
      <em>-current</em> source tree. Because they reflect the current
      state of development, there is no guarantee that snapshot
      releases will work correctly (or even at all). Snapshots are
      quite useful when moving from a formal release (or older
      version of -current) to the current tree. If you happen to run
      <em>-current</em> it is strongly recommended to follow the
      <em>source-changes</em> <a href="/mail.html">mailing list</a>.
      The commit messages often contain valuable information about
      the latest and greatest features added.</p>
    
    <p>As of OpenBSD 2.7, a <a href="../stable.html">patch
	branch</a> (called <em>-stable</em>) was introduced. This
      branch contains the base release, and any important patches or
      fixes (important being the errata patches, plus others that are
      obvious and simple, but do not deserve an errata entry).</p>
    
    <p>The <a href="../ports.html">ports tree</a> is an integral
      part of the system. You should upgrade the ports tree at the
      same time as the rest of the system, following the same rules
      as for upgrading everything else; i.e., you should run -stable
      ports on a -stable system, and -current ports only on a
      -current system.</p>

    <a name="1.2"></a>
    <h3>1.2: What is the best way to upgrade to
      <em>-current</em>?</h3>
    
    <p>Due to changes in the underlying libraries, moving directly
      from a release to <em>-current</em> is not always easy. The
      most painless way to move up to <em>-current</em> is to first
      <a href="#1.15">upgrade to the latest snapshot</a>.
      Once the snapshot is installed, the latest source can be 
      <a href="#1.4">fetched</a> and <a href="#1.5">built</a>. This
      procedure should eliminate most toolchain and library
      problems.</p>

    <a name="1.3"></a> 
    <h3>1.3: I looked, but didn't see any snapshots on the FTP
      site. Where did they go?</h3>
    
    <p>Snapshots may be removed as they become old (or no longer
      relevant). If no snapshot is available, you should upgrade to
      the most recent release and build the remainder of the way from
      source.</p>

    <a name="1.4"></a> 
    <h3>1.4: How do I get the latest source?</h3>

    <p>Short answer: 
      <a href="../anoncvs.html">http://www.openbsd.org/anoncvs.html</a></p>
    
    <p>For example. To retrieve the entire tree via CVS: (using the
      ksh shell. Others substitute <em>setenv</em> for
      <em>export</em>)</p>

<pre>
  # export CVSROOT=anoncvs@anoncvs.ca.openbsd.org:/cvs
  # export CVS_RSH=/usr/bin/ssh
  # cd /usr
  # cvs -q get -P src
</pre>

    <p>Note that this gets you -current. You probably don't want that.
      For example, to retrieve 3.2-stable, use</p>

<pre>
  # cvs -q get -rOPENBSD_3_2 -P src
</pre>

    <a name="1.5"></a> 
    <h3>1.5: Okay, I have the tree. How do I build it?</h3>
    
    <p>Basic instructions are in 
      <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/Makefile"
	 ><tt>/usr/src/Makefile</tt></a>.
      This is a slightly expanded version.</p>
    
    <ol>
      <li>
        <p>Clean out the old object files.</p>
	
        <p>If you created a separate /usr/obj directory, clean
	  that, and rebuild the symbolic links:</p>

<pre>
  # rm -rf /usr/obj/*
  # cd /usr/src
  # make obj
</pre>

        <p>If you find yourself performing this step a lot, you may
	  find it faster to place /usr/obj onto its own partition,
	  and use <em>newfs</em> instead of <em>rm</em>. For example,
	  I do a:</p>

<pre>
  # umount /usr/obj
  # newfs wd0h
  # mount /usr/obj
  # make obj
</pre>

        <p>If you're worried there are object files in your source
	  tree, do this:</p>

<pre>
  # cd /usr/src
  # find . -type l -name obj | xargs rm
  # make cleandir
  # rm -rf /usr/obj/*
  # make obj
</pre>

      </li>
      
      <li>
        <p>Perform any version-specific configuration changes. For
	  example, 2.3 users must add the <em>named</em> user and
	  group before moving to 2.4 or later. See the specific
	  Mini-FAQ section for your version.</p>
      </li>
      
      <li>
        <p>Make sure all the appropriate directories are created.
	  This is especially important when upgrading from older
	  versions, but is sometimes necessary in other cases. The
	  easiest way to do this is:</p>
<pre>
  # cd /usr/src/etc &amp;&amp; DESTDIR=/ make distrib-dirs
</pre>

      </li>

      <li>
        <p>Compile a new kernel.</p>
<pre>
  # cd /usr/src/sys/arch/`machine`/conf
</pre>

        <p>Most users will want to use GENERIC:</p>
<pre>
  # config GENERIC
  # cd ../compile/GENERIC
</pre>

        <p><strong>NOTE:</strong> The truly masochistic in the
	  crowd may want to compile a custom kernel instead. In these
	  cases, it's usually best to start with GENERIC and trim
	  from there. Do the following procedure instead:</p>
<pre>
  # cp GENERIC MYKERNEL
  # vi MYKERNEL
  (edit MYKERNEL to your liking)
  # config MYKERNEL
  # cd ../compile/MYKERNEL
</pre>

        <p>In either case,</p>
<pre>
  # make clean &amp;&amp; make depend &amp;&amp; make
  (arc architecture only) copy bsd.ecoff to your FAT partition
  # cp /bsd /bsd.old &amp;&amp; cp bsd /bsd
  # chown root:wheel /bsd (if you compiled as someone else)
  (reboot)
</pre>
      </li>

      <li>
        <p>Compile the system.</p>
<pre>
  # cd /usr/src
  # make build
</pre>
      </li>

      <li>
        <p>Update <tt>/etc</tt> and <tt>/dev</tt> by hand. These
	  are not updated automatically. Choose a directory with
	  enough space to hold /, /dev, /var, and /etc. Here I'll use
	  <em>/home/newroot</em></p>
<pre>
  # mkdir /home/newroot          
  # export DESTDIR=/home/newroot
  # cd /usr/src/etc &amp;&amp; make distribution-etc-root-var
</pre>

        <p>Now compare the files in /home/newroot with their
	  installed counterparts. Replace or update the files as
	  necessary.</p>
<pre>
  # rm -rf /home/newroot   (when done)
</pre>
      </li>

      <li>
        <p>Reboot to make sure the new /etc files are correct</p>
      </li>
    </ol>

    <a name="1.6"></a> 
    <h3>1.6: My make build stopped halfway. Do I have to redo the
      whole thing?</h3>

    <p>I would, but if you really want to pick up where you left
      off, do a:</p>
<pre>
  # cd /usr/src
  # make -n build
</pre>

    <p>This will show you what make build is doing. For example,
      mine tells me:</p>
<pre>
  (cd /usr/src/share/mk &amp;&amp;  make install)
  (cd /usr/src/include; make prereq;  make includes)
  make cleandir
  (cd /usr/src/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/kerberosIV/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/usr.bin/perl &amp;&amp;  make -f Makefile.bsd-wrapper config.sh &amp;&amp;  make -f Makefile.bsd-wrapper depend &amp;&amp;  make -f Makefile.bsd-wrapper perl.lib &amp;&amp;
  make -f Makefile.bsd-wrapper install.lib)
  make depend &amp;&amp; make &amp;&amp;  make install
</pre>

    <p>To pick up where you left off, just reissue the commands
      from the point where the compile died.</p>
    
    <p>If you do this procedure a lot, you may want to create a new
      target in your makefile. Simply copy the entry for
      <em>build</em> (to <em>build-noclean</em>, for example), and
      remove the <em>make cleandir</em> reference.</p>

    <a name="1.7"></a> 
    <h3>1.7: I'm getting errors during the build. What do I
      do?</h3>
    
    <p>If your <em>make build</em> ends with an error, chances are
      it is because you failed to delete your old objects before
      rebuilding. See <a href="#1.5">1.5</a> for details on cleaning
      out these objects.</p>

    <p>If you are sure your tree is clean of old object cruft, and
      you are still receiving a build error, one of three things has
      probably happened:</p>
    
    <ol>
      <li>You have encountered a known upgrade issue. Make sure you
	have read the appropriate section of this document, and
	followed the instructions there carefully.</li>
      
      <li>You have encountered a new upgrade issue. This is life on
	the bleeding edge. Search recent postings to 
	<a href="../mail.html">misc@ and tech@</a> for possible
	workarounds.</li>
      
      <li>Someone has temporarily broken the source tree. This type
	of break is pretty rare, and is usually fixed immediately.
	Try waiting a few hours, and re-fetching the source tree. If
	you can't wait, try fetching a tree from a day or two
	beforehand.</li>
    </ol>

    <p>If you have tried all of the alternatives above, and your
      problem persists for more than a couple of days, post your
      problem to misc@openbsd.org. Make sure to include the relevant
      error messages, and any peculiarities of your setup.</p>

    <a name="1.8"></a> 
    <h3>1.8: I'm upgrading to a newer version of the compiler
      (<em>gcc</em>). Is there a standard way of bootstrapping
      it?</h3>

    <p>Because upgrading a compiler is a bit of a chicken-and-egg
      problem, changes to the in-tree compiler require a little extra
      attention. In general, you'll want to perform the following
      procedure:</p>

    <p>(and yes, you are building it twice)</p>

<pre>
  # rm -r /usr/obj/gnu/egcs/gcc/*
  # cd /usr/src/gnu/egcs/gcc
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper 
  # make -f Makefile.bsd-wrapper install
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper 
  # make -f Makefile.bsd-wrapper install
</pre>

    <p>And then run a normal <em>make build</em>.</p>

    <p>You may be able to speed this process up by using the
      BOOTSTRAP procedure:</p>

<pre>
  # cd /usr/src/gnu/egcs/gcc
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper -DBOOTSTRAP
  # make -f Makefile.bsd-wrapper -DBOOTSTRAP install
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>

    <a name="1.9"></a> 
    <h3>1.9: What is the best way to upgrade <tt>/etc</tt>,
      <tt>/var</tt>, and <tt>/dev</tt>?</h3>
    
    <p><strong>Short Answer</strong>: By Hand.</p>
    
    <p><strong>Long answer</strong>:</p>

    <p>As a policy, software in the OpenBSD tree does not modify
      files in <tt>/etc</tt> automatically. This means it is
      <em>always</em> up to the administrator to make the necessary
      modifications there. Upgrades are no exception. To update files
      in these directories, first determine what changes have
      occurred to the base (distribution) files, and then manually
      reapply these changes.</p>

    <p>For example, to see the files in the tree that have changed
      most recently, do a:</p>

<pre>
  # cd /usr/src/etc
  # ls -lt |more
</pre>

    <p>To see all the changes in <tt>/etc</tt> between arbitrary
      versions of OpenBSD, you can use 
      <a href="../anoncvs.html">CVS</a>. For example, to see the changes
      between 3.1 and 3.2, do a:</p>

<pre>
  # cd /usr/src/etc
  # cvs diff -u -rOPENBSD_3_1 -rOPENBSD_3_2
</pre>

    <p>Once you have identified the changes, reapply them to your
      local tree, preserving any local configuration you may have
      done.</p>

    <p>Typical <tt>/etc</tt> changes to watch out for between releases
      include:</p>
     
    <ul>
      <li>Additions to <tt>/etc/protocols</tt> and <tt>/etc/services</tt></li>
      <li>New sysctls. (see <tt>/etc/sysctl.conf</tt>)</li>
      <li>Changes to the default cron jobs. See <tt>/etc/daily</tt>, 
	<tt>/etc/weekly</tt>, <tt>/etc/monthly</tt>, and <tt>/etc/security</tt>
      </li>
      <li>All rc scripts, including netstart</li>
      <li>Device changes. See
	<a href="#1.12">1.12</a>
      </li>
      <li>File hierarchy changes in <tt>/etc/mtree</tt>. See 
	<a href="#1.13">1.13</a>
      </li>
      <li>
	New users (<tt>/etc/passwd</tt>)and groups (<tt>/etc/group</tt>)
      </li>
    </ul>


    <a name="1.10"></a> 
    <h3>1.10: How do I clean all the cruft out of my existing
      source tree?</h3>
    
    <p>The most important thing you can do is to clean out your obj
      directories. Here's a procedure to update source and kill any
      leftover objects:</p>

<pre>
  # cd /usr/src
  # cvs -q -d anoncvs@some.anon.server:/cvs up -Pd
  # find . -type l -name obj | xargs rm
  # make -k cleandir
  # rm -rf /usr/obj/*
  # make obj
</pre>

    <p>If you're still having trouble, you may want to try adding
      <tt>-I ! -I CVS -I obj</tt> to your CVS updates. This will
      identify any extra cruft in your source tree.</p>

    <a name="1.11"></a> 
    <h3>1.11: Do I have to be root to do a <em>make
	build</em>?</h3>

    <p>Though certain steps of the make build process require root
      privileges, the build process includes hooks to the 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sudo&amp;sektion=8"
	 >sudo(8)</a> command that make this process relatively
      painless.</p>

    <p>If your <tt>/etc/sudoers</tt> file is configured correctly,
      you can use the sudo hooks in the following manner:</p>
    
    <ul>
      <li>Place SUDO=/usr/bin/sudo in your environment prior to
	starting the build, or</li>

      <li>Add the line "SUDO=/usr/bin/sudo" to your
	<tt>/etc/mk.conf</tt> file.</li>
    </ul>

    <a name="1.12"></a> 
    <h3>1.12: Why am I not seeing any new devices?</h3>
    
    <p>The <tt>/dev/MAKEDEV</tt> script is not updated
    automatically as part of the <em>make build</em> process. As a
      general rule, it is a good idea to copy and run this script
      from your source tree when performing an upgrade:</p>

<pre>
  # cd /dev
  # cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  # ./MAKEDEV all
</pre>

    <a name="1.13"></a> 
    <h3>1.13: Is there an easy way to make all the file hierarchy
      changes?</h3>

    <p>From time to time, files or directories are added to, or
      removed from the file hierarchy. Also, ownership information
      for portions of the filesystem may change. An easy way to
      ensure that your file hierarchy is up-to-date is to use the 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
	mtree(8)</a> utility.</p>
    
    <p>First, fetch the latest source, then do the following:</p>

<pre>
  # cd /usr/src/etc/mtree
  # install -c -o root -g wheel -m 600 special /etc/mtree
  # install -c -o root -g wheel -m 444 4.4BSD.dist /etc/mtree
  # mtree -qdef /etc/mtree/4.4BSD.dist -p / -u
</pre>

    <p>Your file hierarchy should now be up to date.</p>

    <a name="1.14"></a> 
    <h3>1.14: After an upgrade, <em>ps</em> now reports
      "proc size mismatch."</h3>

    <p>
      Your userland and kernel are out of sync. They must both be
      compiled from the same sources, as certain dependencies exist
      between them. Rebuild your kernel and userland from the same
      sources to correct the problem.
    </p>
    
    <p>
      Since you've already made one mistake, now is an ideal time to
      reread this document in its entirety, to catch any other things
      you may have missed.
    </p>


    <a name="1.15"></a>
    <h3>1.15: How can I upgrade to the latest snapshot?</h3>

    <p>
      Installing snapshot is a good way to keep up to date.
      We want you to test snapshots, especially at beta-time,
      to make sure the next release is of superior quality.
      And it is much less difficult than building the whole tree.
    </p>

    <p>
      The easiest way to get <em>-current</em> is to grab a boot image
      and prepare as described in the
      <a href="faq4.html">FAQ</a>. Once booted, you choose
      &quot;(U)pgrade&quot; and follow the instructions.
    </p>

    <p>
      There are several opportunities to start the upgrade program.
      Usually, the easiest methods are booting from floppy or CD-ROM
      or place a -current <a href="faq4.html#bsd.rd">bsd.rd</a> on your /
      and boot that instead of <tt>/bsd</tt>.
      Other options include booting over the network and booting from tape.
      Not all methods are available for all architectures, refer to the
      installation instructions for more information.
    </p>

    <p>
      While in-place upgrades sometimes work, this is not recommended.
      The only safe way to upgrade is booting from a new install/upgrade media
      as described above.
    </p>

    <p>
      In all cases, you must upgrade <a href="#1.9">/etc, /var and /dev</a>
      by hand.
    </p>

    <a name="3.4"></a>
    <h2>
      Upgrading from 3.4
    </h2>

    <a name="3.4.1"></a>
    <h3>
      3.4.1: svnd device minor numbers changed (2003/10/10)
    </h3>
    <p>
      The device minor numbers of 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=svnd&amp;sektion=4">svnd</a>
      devices have changed, so you will need to run the updated
      <tt>/dev/MAKEDEV</tt> after installing the new kernel:
        <ul>
          <li>update your source code tree
          <li>Build a new kernel
          <li>copy the new MAKEDEV script to the dev directory, remove
              the existing svnd(4) and rsvnd devices, and create new ones:
<pre>
     # cp /usr/src/etc/etc.`machine`/MAKEDEV /dev
     # cd /dev
     # rm svnd* rsvnd*
     # ./MAKEDEV vnd
</pre>
          <li>Continue with build and release process
        </ul>

      This affects anyone using svnd devices, which includes those who
      <tt>make release</tt>.
    </p>


    <a name="3.3"></a>
    <h2>
      Upgrading from 3.3
    </h2>
    
    <a name="3.3.1"></a>
    <h3>
      3.3.1: i386 W^X support (2003/04/16)
    </h3>

    <p>To enable i386 Writable xor eXecute support, OpenBSD/i386 has
      changed from a.out executable format to ELF. The flexibility of 
      ELF allows better control over the executable layout which
      allows for W^X support. a.out compatibility is only available in a
      limited form. Static a.out binaries will work as before, dynamic
      a.out binaries ARE NOT SUPPORTED.
    </p>
    <p>SOURCE UPGRADES FROM a.out -&gt; ELF WILL NOT BE SUPPORTED.
      INSTALL A SNAPSHOT and then you can rebuild from source.
      This is i386-only, other architectures are NOT affected by this change.
    </p>

    <a name="3.3.2"></a>
    <h3>
      3.3.2: mquery syscall change (2003/04/28)
    </h3>

    <p>The parameters to the mquery systemcall were changed to match mmap().
      This requires the system to be upgraded in the correct order:

      <pre>
      1. Build and boot new kernel.
      2. (cd /usr/src && sudo make includes)
      3. (cd /usr/src/libexec/ld.so && make && sudo make install)
      4. 'make build'
      </pre>

      Only i386 uses mquery, so other architectures do not need to
      follow this strict build order.

    <a name="3.3.3"></a>
    <h3>
      3.3.3: i386 flag day, exe addr/MAXDSIZ change (2003/05/05)
    </h3>

    <p>To allow MAXDSIZ to be changed back to 1G, the base
      address of all executables changes from 0 to 0x1c000000. The
      combination of these changes requires updating from snapshot.
      Updating from source is not supported.  This only affects i386.
    </p>

    <a name="3.3.4"></a>
    <h3>
      3.3.4: <tt>config</tt> change (2003/05/23)
    </h3>

    <p>Moving swapgeneric.c required a change to 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8">config(8)</a>.
      Before building a new kernel, you must first build and install
      the updated config(8):
<pre>
  # cd /usr/src/usr.sbin/config
  # make clean
  # make obj
  # make
  # make install
</pre>
      Now, <tt>config</tt> your kernel configuration and run 
      "<tt>make depend</tt>" in your kernel compile directory as detailed
      <a href="#1.5">above</a>. 

   <a name="3.3.5"></a>
   <h3>
    3.3.5: Use __attribute__((bounded)) on certain functions (2003/06/26)
   </h3>
      
   <p>
     __attribute__((bounded)) is now used to detect incorrect arguments
     for functions which take buffer lengths as one of their parameters.
     <br><br>You will need to rebuild gcc according to section
     <a href="#1.8">1.8</a>
     of the Mini-FAQ before proceeding with <tt>make build</tt>.
   </p>

    <a name="3.3.6"></a>
    <h3>
      3.3.6: New user and group _syslogd (2003/07/31)
    </h3>
    <p>The <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8"
      >syslogd(8)</a> daemon now runs in privilege separated mode, and requires a new
      user and group _syslogd.
      Add the group by running
<pre>
  # groupadd -g 73 _syslogd
</pre>
      as root, and add the user entry using
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>:
<pre>
  _syslogd:*:73:73::0:0:Syslog Daemon:/var/empty:/sbin/nologin
</pre>
    </p>

    <a name="3.3.7"></a>
    <h3>
      3.3.7: Use format attribute __kprintf__ in kernel headers (2003/08/23)
    </h3>
    <p>
      A new format attribute __kprintf__ is now used in kernel header files to 
      make gcc aware of the format extensions in the kernel
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=printf&amp;sektion=9">printf(9)</a>.
      <br><br>You will need to rebuild gcc according to section <a href="#1.8">1.8</a>
     of the Mini-FAQ before proceeding with <tt>make build</tt>. You only need to rebuild
     gcc once from current sources to also support the __bounded__ attribute described
     in section <a href="#3.3.5">3.3.5</a>.
    </p>

    <a name="3.2"></a>
    <h2>
      Upgrading from 3.2
    </h2>

    <a name="3.2.1"></a>
    <h3>
      3.2.1: New Perl (2002/11/05)
    </h3>

    <p>Perl has been updated to version 5.8.0.<br>
      In Perl 5.8.0, the XS module API has changed due to a switch
      from stdio to PerlIO (see the perldelta manual page for more information).
      This means that any XS modules (perl .so files) you have installed
      <strong>must</strong> be rebuilt.  If you encounter an error such as
      <em>Undefined symbol "perl_get_sv"</em> this is your problem.  If the
      only modules you have installed were installed as packages or via the
      ports system, you can check your system for XS modules by running:
      <pre>
	# grep '\.so' /var/db/pkg/p5-*/+CONTENTS | cut -d: -f1 | sort -u
      </pre>
      You can then remove the offending modules with <em>pkg_delete -f</em>
      and rebuild/install them from the ports tree.

    <a name="3.2.2"></a>
    <h3>
      3.2.2: New groups _radius, _token and _shadow (2002/11/21)
    </h3>
    <p>Several new groups have been added:
      <ul>
      <li>The <em>_radius</em> group controls read-only access to
	  <tt>/etc/raddb/servers</tt> file.
      <li>The <em>_token</em> group controls read-only access to the
	  token databases used by 
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tokeninit&amp;sektion=8">tokeninit(8)</a>,
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tokenadm&amp;sektion=8">tokenadm(8)</a>, and
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login_token&amp;sektion=8">login_token(8)</a>.
      <li>The <em>_shadow</em> group controls read-only access to
	  the shadow password database.
      </ul>

      You will need to add these groups and adjust the permissions on
      some files before running a &quot;make build&quot;.  The following
      commands, run as root, will do this:
	<pre>
	  # groupadd -g 63 _radius
	  # chgrp _radius /etc/raddb /etc/raddb/servers
	  # chmod g+x /etc/raddb
	  # chmod g+r /etc/raddb/servers

	  # groupadd -g 64 _token
	  # chgrp _token /etc/activ.db /etc/crypto.db /etc/snk.db
	  # chmod 0640 /etc/activ.db /etc/crypto.db /etc/snk.db

	  # groupadd -g 65 _shadow
	  # chgrp _shadow /etc/spwd.db
	  # chmod 0640 /etc/spwd.db
	</pre>

      Don't worry about error messages indicating that a file was not found.
      That just means you haven't setup <em>token</em> or <em>radius</em> authentication.

    <a name="3.2.3"></a>
    <h3>
      3.2.3: Important compiler changes (2002/12/02)
    </h3>
    <p>The <a href="http://www.trl.ibm.com/projects/security/ssp">propolice</a>
      stack protection extension has been merged into
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gcc-local&amp;sektion=1"
      >gcc</a>. This requires a slightly different upgrade scenario:
      <ul>
      <li>Do <b>not</b> build a new kernel yet.
      <li>Do <b>not</b> rebuild gcc yet.
      <li>Build and install a new ld.so dynamic loader if your system has
        shared libraries.
        <pre>
	  # cd /usr/src
	  # make obj
          For ELF platforms (alpha, macppc, sparc, sparc64):
          # cd /usr/src/libexec/ld.so
          # make depend &amp;&amp; make &amp;&amp; make install
	  For a.out platforms (amiga, hp300, i386, mac68k, mvme68k):
          # cd /usr/src/gnu/usr.bin/ld/rtld
          # make depend &amp;&amp; make &amp;&amp; make install
	</pre>
      <li>Rebuild and install a new libc, following the first few commands
        from <i>make build</i>.
	<pre>
          # cd /usr/src/include
	  # make prereq &amp;&amp; make includes
	  # cd /usr/src/lib/libc
	  # make depend &amp;&amp; make NOMAN=1 &amp;&amp; make NOMAN=1 install
	</pre>
	Note that, if your compiler is too old, it will not be able to build
	libc. In this case, you'll have to do a binary upgrade from a snapshot.
      <li>Rebuild and install gcc, as told in section <a href="#1.8">1.8</a>.
      <li>You can now recompile a kernel.
        Be sure to run
        <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8"
	>config</a> again to regenerate the kernel Makefile.
      <li>Reboot on the new kernel, and run a <i>make build</i> to
        benefit from the stack protection.
      </ul>

    <a name="3.2.4"></a>
    <h3>
      3.2.4: New user and group _spamd (2002/12/24)
    </h3>
    <p>A new user and a new group _spamd for the
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamd&amp;sektion=8"
      >spamd(8)</a> daemon have been added.
      Add the group by running
<pre>
  # groupadd -g 62 _spamd
</pre>
      as root, and add the user entry using
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>:
<pre>
  _spamd:*:62:62::0:0:Spam daemon:/var/empty:/sbin/nologin
</pre>

    <a name="3.2.5"></a>
    <h3>
      3.2.5: Alias for ipv6-icmp (2002/12/30)
    </h3>

    <p>A new alias for ipv6-icmp, <em>icmp6</em> , has been added to
      <tt>/etc/protocols</tt>.  If you wish to use the <em>icmp6</em> alias
      (used in the
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8">pfctl(8)</a>
      regression tests) you must modify the <em>ipv6-icmp</em> line in
      <tt>/etc/protocols</tt>, adding the <em>icmp6</em> keyword before the #.
      The line should read as follows:
    </p>
<pre>
  ipv6-icmp 58    IPv6-ICMP icmp6 # ICMP for IPv6
</pre>

    <a name="3.2.6"></a>
    <h3>
      3.2.6: New group _lkm (2003/01/05)
    </h3>

    <p>The <em>_lkm</em> group controls access to
	  <tt>/dev/lkm</tt>.
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=modstat&amp;sektion=8">modstat(8)</a>
          is now setgid _lkm.
    <p>
      You will need to add this group and adjust the permissions on
      <tt>/dev/lkm</tt> before running a &quot;make build&quot;.  The following
      commands, run as root, will do this:
<pre>
  # groupadd -g 61 _lkm
  # chgrp _lkm /dev/lkm
</pre>

    <a name="3.2.7"></a>
    <h3>
      3.2.7: New libpthread (2003/01/14)
    </h3>

    <p><em>libc_r</em> and <em>libnpthread</em> have been removed and
    replaced by <em>libpthread</em>.  Threaded programs should still
    be compiled using the <em>-pthread</em> option; the compiler does
    the right thing.

    <p>Before removing <em>libc_r</em> and <em>libnpthread</em> threaded
    applications must be re-compiled using <em>libpthread</em>.  The
    recommended build sequence is:

    <ol>
      <li>
        <p>build gcc according to section <a href="#1.8">1.8</a>.
      <li>
        <p>re-build the system according to section <a href="#1.5">1.5</a>.
      <li>
        <p>re-build all threaded ports.
      <li>
        <p>remove the now unused libraries:
<pre>
  # rm /usr/lib/libc_r* /usr/lib/libnpthread*
</pre>
    </ol>

    <a name="3.2.8"></a>
    <h3>
      3.2.8: Linker changes for ELF architectures (2003/01/17)
    </h3>

    <p>Binutils/ld have been changed to introduce a new security feature to ELF
    executables. Instead of allowing the data section of executables and
    shared libraries to be marked executable by the linker, the layout has
    been changed to only mark the appropriate sections of the program image
    as executable. This change only affects ELF based architectures: alpha,
    sparc, sparc64, macppc.
    <p>
    It is recommended that binutils be rebuilt before the rest of the system.
    <p>
<pre>
  # cd /usr/src/gnu/usr.bin/binutils
  # make -f Makefile.bsd-wrapper cleandir
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>
    <p>
    Then re-build the system according to section <a href="#1.5">1.5</a>

    <a name="3.2.9"></a>
    <h3>
      3.2.9: Removal of /var/at and crontab changes (2003/02/19)
    </h3>

    <p>The contents of <tt>/var/at</tt> have been merged into <tt>/var/cron</tt>
    now that <em>at</em> has been integrated into <em>cron</em>.  Furthermore,
    the <em>cron</em> allow and deny files have been renamed cron.allow and
    cron.deny for POSIX compliance and consistency with at.allow and at.deny.
    <p>
    First re-build the system according to section <a href="#1.5">1.5</a>
    Then move the existing files and restart cron as follows:
    <p>
<pre>
  # mv /var/at/* /var/cron
  # mv /var/cron/jobs /var/cron/atjobs
  # mv /var/cron/allow /var/cron/cron.allow
  # mv /var/cron/deny /var/cron/cron.deny
  # rm -rf /var/at 
  # kill `cat /var/run/cron.pid`
  # /usr/sbin/cron
</pre>
    <p>
    Disregard any warnings about missing allow or deny files.
    Not all of them are part of the default installation.
    <p>
    If you do not already have a cron.deny file (it was not installed
    prior to OpenBSD 3.3) you will need one to run <em>crontab</em> as
    a user other than the superuser.
<pre>
  # install -c -o root -g crontab -m 660 /dev/null /var/cron/cron.deny
</pre>

    <a name="3.1"></a>
    <h2>
      Upgrading from 3.1
    </h2>
    
    <a name="3.1.1"></a>
    <h3>
      3.1.1: New users/groups
    </h3>

    <p>Several new users/groups have been added. 
      In support of 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8"
      >authpf(8)</a>, a new group is required. Also, to support
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8">sshd(8)</a>'s
      privilege separation feature, a new user and group named <em>sshd</em>
      have been added to the system.
      More new users for system services have been added, they are prefixed
      with &quot;_&quot;.
      Add the following user entries using 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>:
    </p>
<pre>
  sshd:*:27:27::0:0:sshd privsep:/var/empty:/sbin/nologin
  _portmap:*:28:28::0:0:portmap:/var/empty:/sbin/nologin
  _identd:*:29:29::0:0:identd:/var/empty:/sbin/nologin
  _rstatd:*:30:30::0:0:rpc.rstatd:/var/empty:/sbin/nologin
  _rusersd:*:32:32::0:0:rpc.rusersd:/var/empty:/sbin/nologin
  _fingerd:*:33:33::0:0:fingerd:/var/empty:/sbin/nologin
  _x11:*:35:35::0:0:X server:/var/empty:/sbin/nologin
</pre>
    
    <p>Add the following to <tt>/etc/group</tt>:</p>
       
<pre>
  sshd:*:27:
  _portmap:*:28:
  _identd:*:29:
  _rstatd:*:30:
  _rusersd:*:32:
  _fingerd:*:33:
  _sshagnt:*:34:
  _x11:*:35:
  authpf:*:72:
</pre>

    <a name="3.1.2"></a>
    <h3>
      3.1.2: New group for crontab(1) and at(1)
    </h3>

    <p>
      The 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">
      crontab(1)</a> and
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=at&amp;sektion=1">
      at(1)</a> commands are no longer setuid root, they are now setgid
      <em>crontab</em>.

    <p>
      Before you run &quot;make build&quot;, you will need to add the
      <em>crontab</em> group.
      Add a line like the following to your <tt>/etc/group</tt> file:</p>

<pre>
  crontab:*:66:
</pre>

<p>
      The &quot;make build&quot; will update some, but not all, permissions
      for you.  After &quot;make build&quot; finishes, you must run following
      by hand (assumes <tt>/bin/csh</tt>):
</p>

<pre>
  # chgrp crontab /var/at/at.{allow,deny} /var/cron/{allow,deny}
  # chmod 0640 /var/at/at.{allow,deny} /var/cron/{allow,deny}
  # foreach f ( /var/cron/tabs/* )
	  set u=`basename $f`
 	  chown $u:crontab $f
    end
</pre>

<p>
      Note that you probably will not have all of the allow/deny files;
      this is not a problem.
</p>

    <a name="3.1.3"></a>
    <h3>
      3.1.3: New Binutils
    </h3>

<p>
A new binutils (2.11.2) has gone into the tree, requiring an updated
<em>libiberty</em>. To build this library, follow these steps:
</p>
  
<pre>
  # cd /usr/src/gnu/egcs/libiberty
  # make -f Makefile.bsd-wrapper cleandir
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>

    <a name="3.1.4"></a>
    <h3>
      3.1.4: New S/Key configuration
    </h3>

    <p>
      The old S/Key database file, <tt>/etc/skeykeys</tt>, has been replaced by
      a directory, <tt>/etc/skey</tt>, where each record is an individual file
      owned by the user it describes.  You can convert <tt>/etc/skeykeys</tt>
      to the new format by running (as root):
    </p>
<pre>
  # skeyinit -C
  # mv /etc/skeykeys /etc/skeykeys.OLD
</pre>

<p>
      Note that any third-party programs that utilize S/Key directly will need
      to be recompiled.
</p>

    <a name="3.1.5"></a>
    <h3>
      3.1.5: New permissions for lp*
    </h3>

    <p>
      The spool directories used by lpd must now be writable by group
      daemon in order for lpr to be able to spool files.  Additionally,
      the files within the spool directories must be owned by user and
      group daemon.  This can be accomplished as follows:
    </p>
<pre>
 # find /var/spool/output /var/spool/lpd -type d \
	-execdir chgrp daemon {} \; -execdir chmod g+rwx {} \;
 # find /var/spool/output /var/spool/lpd -type f \
	-execdir chown daemon:daemon {} \;
</pre>

    <a name="3.1.6"></a>
    <h3>
      3.1.6: atrun(8) no longer needed
    </h3>

    <p>
      The <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=atrun&amp;sektion=8">atrun(8)</a>
      command is no longer needed.  Its functionality has been incorporated into
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=cron&amp;sektion=8">cron(8)</a>.
      You should remove the <tt>/usr/libexec/atrun</tt> job from root's
      crontab by running the following as root:
    </p>
    <pre>
      # crontab -e
    </pre>

    <p>
      You may also wish to remove <tt>/usr/libexec/atrun</tt>,
      <tt>/usr/share/man/cat8/atrun.0</tt> and the
      <tt>/var/at/spool</tt> directory.
    </p>

    <a name="3.1.7"></a>
    <h3>
      3.1.7: nat.conf merged into pf.conf
    </h3>

    <p>
	<tt>/etc/nat.conf</tt> is now merged into <tt>/etc/pf.conf</tt>.
	You need to insert your NAT rules in pf.conf after scrub rules and
	before filter rules.
    </p>
    <p>
	<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8">pfctl(8)</a>
	has a new option to load the ruleset, -f, and the -R and -N options
	have new meanings now. Make sure to check the manpage
	and to update your <tt>/etc/rc</tt>.
    </p>

    <a name="3.1.8"></a>
    <h3>
     3.1.8: New fbtab entry needed for xdm
    </h3>

    <p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login&amp;sektion=1">
login(1)</a> needs to chown /dev/wsmouse to the new _x11 user that is used by
xdm for privilege revocation purposes on many architectures. The change to
<tt>/etc/fbtab</tt> needed is architecture dependent. The file is created via
this process (assuming sources in /usr/src):
    </p>
<pre>
  # cat /usr/src/etc/fbtab.head > /etc/fbtab
  # cat /usr/src/etc/etc.`uname -m`/fbtab >> /etc/fbtab
  # cat /usr/src/etc/fbtab.tail >> /etc/fbtab
</pre>
<p>
If you had custom changes to <tt>/etc/fbtab</tt>, you will have to merge them
back into the new file manually.
</p>
   <a name="3.1.9"></a>
   <h3>
    3.1.9: Use __attribute__((sentinel)) on certain functions
   </h3>

   <p>
     __attribute__((sentinel)) is now employed to warn when certain
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=exec&amp;sektion=3">
exec(3)</a>
     functions are used without a terminating NULL pointer.
     <br><br>You will need to rebuild gcc according to section
     <a href="#1.8">1.8</a>
     of the Mini-FAQ before proceeding with <tt>make build</tt>.
   </p>

    <a name="3.0"></a>
    <h2>
      Upgrading from 3.0
    </h2>
    
    <a name="3.0.1"></a>
    <h3>
      3.0.1: New keyword supported by mtree(8)
    </h3>

    <p>
      You must build and install a new version of the
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
      mtree(8)</a> utility before &quot;make build&quot; will succeed.
    </p>
<pre>
  # cd /usr/src/usr.sbin/mtree
  # make cleandir
  # make obj
  # make depend
  # make
  # make install
</pre>

    <a name="3.0.2"></a>
    <h3>
      3.0.2: Removal of libdl on ELF platforms
    </h3>
    
    <p>
      ELF-based platforms (alpha, macppc and sparc64) do not use libdl
      anymore. The upgrade from a libdl system to a non-libdl is best
      done following these steps:
    </p>

    <ul>
      <li>
	<p>Recompile your system:</p>
<pre>
  # cd /usr/src
  # make build
</pre>
      </li>

      <li>
	<p>
	  If your &quot;make build&quot; completed successfully, you
	  can step ahead and remove libdl.  Note that packages that
	  have been linked against it should be reinstalled after
	  that.  If you are not ready for this, you can skip this step
	  for now.  Snapshots with correct packages will be made
	  available.
	</p>
<pre>
  # rm -f /usr/lib/libdl.* /usr/lib/libdl_pic.a
</pre>
	</li>
      <li>
	<p>
	  With libdl removed, regenerate your shared libraries cache:
	</p>
	
<pre>
  # ldconfig -R
</pre>
      </li>
    </ul>

    <a name="3.0.3"></a>
    <h3>
      3.0.3: New regression framework
    </h3>
    
    <p>
      A new infrastructure for regression tests has been introduced and
      <tt>bsd.regress.mk</tt> has been added.  You will need to install
      this file before running <em>make obj</em>.
    </p>

<pre>
  # cd /usr/src/share/mk
  # make install
</pre>

    <a name="3.0.4"></a>
    <h3>
      3.0.4: ssh config files moved to /etc/ssh/
    </h3>

    <p>
      You need to create /etc/ssh/ first, see section
      <a href="#1.13">1.13</a>
    </p>

    <p>
      Recompile your system:
    </p>
<pre>
  # cd /usr/src
  # make build
</pre>

    <p>
      Move your /etc/ssh*_* files into the newly created /etc/ssh/ directory:
    </p>
<pre>
  # cd /etc
  # mv ssh*_* ssh/
</pre>

    <p>
      You will need to
      <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/rc.diff?r1=1.188&amp;r2=1.189">
	change your <tt>rc</tt> scripts</a> to reflect
	these changes as well.
    </p>

    <p>
      Update any <tt>HostKey</tt> lines in your sshd_config to reflect
      the new location.  For example:
    </p>
<pre>
  HostKey /etc/ssh_host_key
</pre>

    <p>should be changed to:</p>

<pre>
  HostKey /etc/ssh/ssh_host_key
</pre>

    <p>
      After this, you can restart the sshd daemon.
    </p>

    <a name="2.9"></a> 
    <h2>Upgrading from 2.9</h2>

    <a name="2.9.1"></a> 
    <h3>2.9.1: New users/groups - <em>proxy</em>, <em>smmsp</em>, and
      <em>popa3d</em>.</h3>

    <p>
      First, with the addition of the 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">
	pf(4)</a> firewalling package, and its 
      <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8"
	 >ftp-proxy(8)</a> suite, a new user and group named
      <em>proxy</em> were added to the system. To support this
      addition, add the following user entry using 
      <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
	vipw(8)</a>:</p>
    
<pre>
proxy:*:71:71::0:0:Proxy Services:/nonexistent:/sbin/nologin
</pre>

    <p>Also add the <em>proxy</em> group to /etc/group:</p>

<pre>
proxy:*:71:
</pre>

    <p>Second, as part of the Sendmail 8.12 upgrade, sendmail no
      longer runs setuid root. Both a new user and a new group, named
      <em>smmsp</em>, have been added to the system. Add a line like
      the following to your <tt>/etc/group</tt>:</p>

<pre>
smmsp:*:25:
</pre>

    <p>Then, run 
      <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
	vipw(8)</a> and add the following line for the <em>smmsp</em>
      user:</p>

<pre>
smmsp:*:25:25::0:0:Sendmail Message Submission Program:/nonexistent:/sbin/nologin
</pre>

    <p>Make sure this line appears before any <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=yp&amp;sektion=8">
      yp(8)</a> settings line.</p>

    <p>Finally, a new user and group were added for Solar
      Designer's popa3d server, now part of the core system. Add the
      following to <tt>/etc/group</tt>:</p>

<pre>
popa3d:*:26:
</pre>

    <p>And using <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
      vipw(8)</a>, add</p>
<pre>
popa3d:*:26:26::0:0:POP3 server:/var/empty:/sbin/nologin
</pre>

    <a name="2.9.2"></a> 
    <h3>2.9.2: New packet filter: <em>pf</em></h3>

    <p>The IPF firewalling package that has been part of previous
      OpenBSD releases has been replaced with an all-new firewalling
      suite called <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">
	pf(4)</a>. As a result, a number of changes need to be
      made.</p>

    <p>First, <em>pf</em> depends on a new device file. To ensure
      that this special device is created, do the following:</p>

<pre>
  # cd /dev
  # cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  # ./MAKEDEV all
</pre>

    <p>Second, a number of filesystem change have occurred. For
      your reference, the following binaries have been replaced:</p>

<pre>
OLD:
/sbin/ipf /sbin/ipfstat /sbin/ipnat /usr/sbin/ipfs
/usr/sbin/ipftest /usr/sbin/ipmon /usr/sbin/ipresend
/usr/sbin/ipsend /usr/sbin/iptest
NEW:
/sbin/pfctl
/usr/libexec/ftp-proxy
</pre>

    <p>Similarly, for the devices:</p>

<pre>
OLD: /dev/ipl /dev/ipnat /dev/ipstate /dev/ipauth
NEW: /dev/pf
</pre>

    <p>And finally, the filter configuration files:</p>

<pre>
OLD: /etc/ipf.rules /etc/ipnat.rules
NEW: /etc/pf.conf /etc/nat.conf
</pre>
    <p>The old ipfilter sample configuration files may be removed:
    </p>
<pre>
  # rm -rf /usr/share/ipf
</pre>

    <p>A mechanism for safely enabling <em>pf</em> has been added
      to the <tt>/etc/rc</tt> and <tt>/etc/rc.conf</tt> files. You
      will need to update these files to include the new hooking
      mechanism. If you wish to enable <em>pf</em>, set PF=YES in
      <tt>/etc/rc.conf</tt>.</p>

    <a name="2.9.3"></a> 
    <h3>2.9.3: Changes to <em>make</em></h3>

    <p>There have been changes to <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=make&amp;sektion=1">
	make(1)</a> and its data files which may cause difficulties in
      the build process. This usually manifests as errors from
      <em>bsd.own.mk</em> during the build. To avoid these issues,
      first update the data files:</p>
<pre>
  # cd /usr/src/share/mk
  # make install
</pre>

    <p>Then build and install the new make.</p>

<pre>
  # cd /usr/src/usr.bin/make
  # make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make
  # make install
</pre>

    <p>Now proceed with your upgrade.</p>
    
    <a name="2.9.4"></a>
    <h3>2.9.4: Build fails because of KerberosV errors</h3>

    <p>Before you try building the whole system, you need to first
      build KerberosV.</p>

    <p>First, there is a new KerberosV configuration directory in
      <em>/etc</em>. If you have not already done so, use the <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
	mtree(8)</a> procedure described in <a href="#1.13">section
	1.13</a> to create it:</p>

    <p>Now, build KerberosV</p>

<pre>
  # cd /usr/src/kerberosV
  # make obj
  # cd lib/roken
  # make 
  # cd ../../usr.bin/asn1_compile
  # make
  # make install
</pre>

    <p>You may also need to update your <tt>/etc/login.conf</tt>,
      to reflect that the file
      <tt>/usr/libexec/auth/login_krb-or-pwd</tt> has been renamed to
      <tt>login_krb<strong>4</strong>-or-pwd</tt>.</p>

    <a name="2.9.5"></a> 
    <h3>2.9.5: New <em>sendmail</em> version</h3>

    <p><a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">
	sendmail(8)</a> has been upgraded to version 8.12. As this
      version of <em>sendmail</em> no longer runs setuid root,
      significant changes have resulted.</p>

    <ol>
      <li>Both a new user and a new group (<em>smmsp</em>) have
	been added. If you have not yet done so, follow the procedure
	in <a href="#2.9.1">section 2.9.1</a> to create them.</li>

      <li>Several changes to the file hierarchy have occurred,
	including a new <tt>/var/spool/clientmqueue</tt> directory
	and new permissions for <tt>/var/spool/mqueue</tt>. These
	changes can both be made using the <a href=
        "http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
	  mtree(8)</a> procedure described in <a href="#1.13">section
	  1.13</a>.</li>

      <li>
        <p>Add the following to root's <a href=
          "http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">
	    crontab(1)</a>. This is necessary since <em>sendmail</em>
	  is no longer setuid root, and relies on this entry to do
	  parts of its job:</p>

<pre>
# sendmail clientmqueue runner
*/30    *       *       *       *       /usr/sbin/sendmail -L sm-msp-queue -Ac -q
</pre>

      </li>
      
      <li>
        <p>Upgrade sendmail:</p>

<pre>
  # cd /usr/src/gnu/usr.sbin/sendmail
  # make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>

        <p><strong>Note:</strong> The files <tt>submit.cf</tt> and
	  <tt>localhost.cf</tt> have been installed to your
	  <tt>/etc/mail</tt> directory. The first of these,
	  <tt>submit.cf</tt> (referred to as the "client"
	  configuration file in current sendmail documentation) is
	  used by mail user agents that want to submit mail locally
	  for delivery via sendmail. Due to the permissions changes
	  described above, this does not require root privileges; the
	  sendmail binary is set-groupid to group smmsp. The second
	  file, <tt>localhost.cf</tt>, is an OpenBSD-ism that runs
	  sendmail only listening on the localhost interface to
	  accept mail from the local host but not accept connections
	  from the network (you almost certainly want this if you
	  also use e.g., <a href=
          "http://www.openbsd.org/cgi-bin/man.cgi?query=smtpd&amp;sektion=8">
	    smtpd(8)</a> listening on the SMTP port on your outside
	  interface). For more details, see the file
	  <tt>SECURITY</tt> in
	  <tt>/usr/src/gnu/usr.sbin/sendmail/sendmail</tt>.</p>

        <p>It is highly recommended that you regenerate and update
	  your sendmail configuration files in <tt>/etc/mail</tt>.
	  You can find some working configuration files in
	  <tt>/usr/share/sendmail/cf</tt>. Note that localhost.cf is
	  generated from openbsd-localhost.mc.</p>
      </li>

      <li>
        <p>If you were running sendmail without the <tt>-bd</tt>
	  option in <tt>/etc/rc.conf</tt>, as the default
	  installation settings do, you will need to use
	  <tt>localhost.cf</tt>. Edit <tt>rc.conf</tt> to use the
	  following:</p>
<pre>
# For normal use: "-L sm-mta -bd -q30m"
sendmail_flags="-L sm-mta -C/etc/mail/localhost.cf -bd -q30m"
</pre>
      </li>

      <li>
        <p>Once your configuration file is ready, <a href=
         "http://www.openbsd.org/cgi-bin/man.cgi?query=kill&amp;sektion=1">
	    kill(1)</a> the existing sendmail:</p>
<pre>
  kill `sed 1q /var/run/sendmail.pid`
</pre>

        <p>Restart the new sendmail with the appropriate options,
	  for example:</p>
<pre>
  /usr/sbin/sendmail -L sm-mta -bd -q30m
</pre>

        <p>for a configuration accepting mail from outside, or</p>

<pre>
  /usr/sbin/sendmail -L sm-mta -C/etc/mail/localhost.cf -bd -q30m
</pre>

        <p>for a local mail-only configuration.</p>
	
        <p><strong>Note:</strong> the <tt>-bd</tt> flag is now
	  needed in both cases.</p>
      </li>
    </ol>

    <p>The new <em>sendmail</em> should now be running.</p>

    <a name="2.9.6"></a> 
    <h3>2.9.6: <tt>/etc/primes</tt> Moved</h3>

    <p><tt>/etc/primes</tt> has been renamed to
      <tt>/etc/moduli</tt>. Simply copy this file from its old
      location or from <tt>/usr/src/etc</tt>.</p>


    <hr width="30%">

    <address>
      <p>
	$OpenBSD: upgrade-minifaq.html,v 1.176 2003/10/23 16:35:24 henning Exp $<br>
	Copyright &copy; 1998-2003, Kjell Wooding.<br>
	Please send any comments, questions, or suggestions to <a
          href="mailto:kjell@openbsd.org">kjell@openbsd.org</a></p>
    </address>
  </body>
</html>

