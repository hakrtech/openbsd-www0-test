<html>
<head>
<title>OpenBSD FAQ: 12 - For Advanced Users</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998,1999 by OpenBSD.">
</head>

<body bgcolor= "#ffffff" text= "#000000" link= "#23238E">

<img alt="[OpenBSD]" height=30 width=141 src="../images/smalltitle.gif">
<p>
<h2><font color=#e00000>12.0 - For Advanced Users</font><hr></h2>
</p>

<p>
<ul><h3>Table of Contents</h3>
<li><a href="#12.1">12.1 - Using OpenBSD's new PCI-IDE code</a>
<li><a href= "upgrade-minifaq.html">12.2 - Upgrading from various versions of OpenBSD via CVS.</a>
</ul>
</p> 
<hr>

<br>

<p>
<a name= "12.1">
<h2>12.1 - Using OpenBSD's new PCI-IDE code</h2>
</a>

<p>
If you have a current source tree that was last updated after July 25th, you
will notice that OpenBSD has PCI-IDE code enabled by default, a big win on
performance
for anyone using an IDE controller!  The PCI-IDE code introduces new PCI and ISA IDE
code, and both PCI and ISA versions have DMA (or Direct Memory Access) capability.
DMA allows the IDE controller to transfer data right from disk to your memory
instead of running it through the CPU.  This lowers the overall utilization
of your CPU,  keeping disk access fast and clean.
(Note that OpenBSD has implemented the pciide code from NetBSD.)
<P>
<UL><TT>
Date: Mon, 19 Jul 1999 18:07:40 -0700 (PDT)<BR>
From: Constantine Sapuntzakis &lt;<A HREF="mailto:csapuntz@stanford.edu">csapuntz@stanford.edu</a>&gt;<BR>
To: tech@openbsd.org<BR>
Subject: New ATA/IDE stuff in OpenBSD<BR>
<P>
This weekend, I started integrating the IDE code from NetBSD-current
to OpenBSD-current. It should be considered a work-in-progress.
<P>
I'm sending out this e-mail for three reasons: to tell you about the
new stuff, to ask for help in porting this across all the platforms
with IDE, and to ask for help in testing this new feature.
<P>
The code from NetBSD supports DMA, UltraDMA, PCI IDE, better error
recovery, etc. It's also faster too. The code has been extensively
tested in NetBSD but not in OpenBSD. The usual warnings apply: 
the new drivers might cause data loss.
<P>
The new code also has a different way of handling ATAPI devices (like
IDE CD ROMs, IDE tape drives, etc.). ATAPI devices talk the SCSI
packet protocol and the new ATAPI layer acts like a SCSI adapter. As
such, your ATAPI CD will now appear as SCSI CD (cd*), your ATAPI tape
drive as a SCSI tape drive (st*), your ATAPI zip drive like a SCSI
drive (sd*), etc. (note: some older ZIP drives are not ATAPI devices)
<P>
Many ATAPI devices are NOT entirely SCSI-I and SCSI-II compliant.  As
such, our SCSI device drivers may not work with your CD/tape drive/ZIP
drive. Integrating ATAPI device support into our SCSI devices is a
high priority so this shouldn't stay broken for long.  However, in the
interim, you might get SCSI errors to the console if you try to use
the devices. Under no condition should your machine hang or panic.  If
your machine does hang/panic, please send me mail, describing the
steps leading up to the hang and providing a dmesg dump.
<P>
For the best hard disk performance, you should not have an ATAPI
device on the same chain as a hard disk.
<P>
Currently, the ATA stuff is only integrated into the i386 port.  I am
willing to do the integration work on other platforms, but I need an
account on such a machine to do compiles and your help in testing the
resulting kernel.
<P>
To enable this feature on i386, you are going to have to edit some files.
Comments directing what edits to do appear in the following files:
<P>
1) arch/i386/conf/files.i386 (don't forget to uncomment pciide_machdep.c)<BR>
2) conf/files<BR>
3) dev/isa/files.isa<BR>
4) dev/pci/files.pci<BR>
<P>
In addition, look at
<P>
5) arch/i386/conf/NEWATA for how to configure the new stuff
<P>
If you boot the new stuff, I'd appreciate it if you sent me a dmesg dump.
Once you've got a new kernel, if anything goes wrong, please send me mail.
<P>
Feel free to provide positive feedback too. ;)
<P>
Thanks,<BR>
-Costa<BR>
</UL></tt>
<p>
With the PCI IDE code, your chipset may not be known.  If so, you will
get a message like:
<UL>
<PRE>
pciide0: bus-master DMA support present, used without full driver support
</PRE>
</UL>
If you get this message, you can try and force DMA mode by
using 'flags 0x0001' on your pciide entry in your kernel config file.
That would look something like this:
<UL><PRE>
pciide* at pci ? dev ? function ? flags 0x0001
</PRE></ul>
After doing this, the pciide code will try to use DMA mode regardless of
whether or not it actually knows how to do so with your chipset.  If this 
works, and your system makes it through fsck and startup, it is likely
that this will work for good.  If this does not work, and the system hangs
or panics after booting, then you can't use DMA mode (yet, until support
is added for your chipset).  Note that if you find the documentation
for your PCI-IDE controller's chipset, this is a good start to fully
supporting your chipset within the PCI-IDE code.  You can look on the
manufacturer's website or call them.  If your PCI-IDE controller is part
of your motherboard, figure out who manufactures the chipset and pursue their
resources!
<P>
Note that you will know that DMA support has been enabled if you see this
message:
<UL><PRE>
pciide0:0:0: using DMA data transfers
</PRE></UL>
This means that pciide0, channel 0, drive 0 is using DMA data transfers.
</ul>
</p>
<p>
Some notes:
</p>
<p>
DMA is not supported on wdc* unless a DMA channel (drq) is
specified. I'm not sure what the "standard" drqs are for hard disk
controllers. To enable
<pre>
wdc0	at isa? port 0x1f0 irq 14 flags 0x00
</pre>
Non-ultra DMA does not necessarily lead to higher bandwidth vs PIO. 
However, it decreases the CPU load significantly.
</p>

<p>
<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq11.html">[To Section 11.0 - Performance Tuning]</a>
<a href= "faq13.html">[To Section 13.0 - IPsec]</a>
</font>
</p>

<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../images/back.gif" border= "0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>$OpenBSD: faq12.html,v 1.21 1999/10/01 19:38:09 ericj Exp $</small>
</p>
</body>
</html>
