<html>
<head>
<title>OpenBSD FAQ: 12.0 - Performance Tuning</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998,1999 by OpenBSD.">
</head>

<body bgcolor= "#ffffff" text= "#000000" link= "#23238E">
<p>
<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq24.html">[To Section 11.0 - OpenBSD 2.4 Specific Information]</a>
</font>
</p>

<p>
<h1>12.0 - Performance Tuning</h1>
<hr>
</p>

<p>
<a name= "12.1">
<h2>12.1 - Networking</h2>
</a>
</p>

<p>
If you run a busy server, gateway or firewall, you should make sure to prevent memory
starvation to various parts of the kernel described below.
</p>

<P>
The <A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=options&apropos=0&sektion=4&format=html">options(4)<a> man page talks about the options presented.
<p>

<p>
An option you may need to chane for a busy server, gateway or firewall is
NMBCLUSTERS.  This controls the size of the kernel mbuf cluster map.
On your computer, if you get messages like "mb_map full",
you need to increase this value.  If traffic on a networking interface stops
for no apparent reason, this may also be a sign that you need to increase
this value.  A reasonable value on the i386 port with most 100Mbps
ethernet interfaces (no matter how many the machine has) is 8192.  
<ul>
<strong>
option NMBCLUSTERS=8192<BR>
</strong>
</ul>
<br>

<p>
<a name= "12.2">
<h2>12.2 - Disk I/O</h2>
</a>
</p>

<p>
Disk I/O speed is a significant factor in the overall speed of your
computer.  It becomes increasingly important when your computer
is hosting a multi-user environment (users of all kinds, from those
who log-in interactively to those who see you as a file-server or a web-server.)
Data storage constantly needs attention, especially when your partitions run
out of space and when your disks fail.  OpenBSD has several options
to increase the speed of your disk operations and provide fault tolerance.
</p>

<H3>CCD</H3><UL>
<p>
The first option is the use of <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ccd&apropos=0&sektion=4&format=html">ccd(4)</a>, the Concatenated Disk Driver.
This allows you to join several partitions into one virtual disk (and thus,
you can make several disks look like one disk).  This concept is
similar to that of LVM, which is found in many commercial Unix flavors.
<P>
If you are running GENERIC, ccd is already enabled.  If not, you may
need to add it to your kernel configuration.
To start setup of ccd, you need to add support for it in your kernel. A
line such as:
</p>

<p>
<UL>
<pre>
<strong>pseudo-device   ccd     4       # concatenated disk devices</strong>
</pre>
</UL>
</p>

<p>
The above configuration entry
gives you up to 4 ccd devices (virual disks),
which is also the maximum number of ccd devices allowed.
</p>
</UL>
<H3>RAID</H3>
<UL>
<p>
Another solution is <a href= "http://www.openbsd.org/cgi-bin/man.cgi?query=raid&apropos=0&sektion=4&format=html">raid(4)</a>
which will have you use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=raidctl&apropos=0&sektion=8&format=html">raidctl(8)</a>.
to control your raid devices.  OpenBSD's RAID is based off of
Greg Oster's <A HREF="http://www.cs.usask.ca/staff/oster/raid.html">NetBSD port</a>
of the CMU
<A HREF="http://www.pdl.cs.cmu.edu/RAIDframe/">RAIDframe</a> software.
OpenBSD has support for RAID levels
of 0, 1, 4, and 5.<P> With raid, as with ccd, support must be in the KERNEL.
Unlike ccd, support for RAID is not found in GENERIC, it must be compiled 
into your kernel (RAID support adds some 500K to the size of an i386 kernel!)
</p>

<p>
<UL>
<pre>
<strong>pseudo-device   raid   4       # RAIDframe disk device</strong>
</pre>
</UL>
</UL>
<H3>Filesystem Buffer</H3>
<UL>
For fileservers with memory to spare, you can increase BUFCACHEPERCENT.
That is, what percentage of your RAM should you use as a file system buffer.
This option will eventually go away when the Unified Buffer Cache is completed
and part of OpenBSD.  In the mean time, to increase BUFCACHEPERCENT,
you should add a line to your kernel configuration like this:
</p>

<p>
<UL>
<strong>option	BUFCACHEPERCENT=30</strong><BR>
</UL>
</p>
<p>
Of course you can make it as low as 5 percent (the default) or as high
as 50 percent (or more.)
</p>
</UL>
<p>
<H3>Soft updates</H3><UL>
Another tool that can be used to speed up your system is softupdates.  One of the 
slowest operations in the traditional BSD file system is updating metainfo
(which happens, among other times, when you create or delete files and
directories.) Softupdates
attempts to update metainfo in RAM instead of writing
to the hard disk each and every single metainfo update.  Another 
effect of this is that the metainfo on disk should always be complete,
although not always up to date.  So, a system crash should not require
fsck upon boot up, but simply a background version of fsck that makes
changes to the metainfo in RAM (a la softupdates).
This means rebooting a server is much faster, because you don't
have to wait for fsck!  (OpenBSD does not have this feature yet.) You can read
more about softupdates in the <a href="faq4.html#4.9">softupdates FAQ</a> entry.
If you use softupdates, you will most certainly want to take
advantage of the Tuning kmem section below.
</UL>
</p>
<BR>
<p>
<a name= "12.3">
<h2>12.3 - Tuning kmem</h2>
</a>
</p>

<P>
If you start using the performance tuning measures above, you may start
running out of kernel memory.  If you start getting
panics like "out of space in kmem_map" then you need to try
<UL>
<strong>
option NKMEMCLUSTERS=8192<BR>
</strong>
</UL>
Note that 8192 is valid for the i386 architecture, but may be too
little or too much for others. Look at /usr/include/machine/param.h
to see more information.
<P>
You may also want to increase the number of static kernel maps and entries.
The default value for these options on i386 is 20 (MAX_KMAP) and 1000 (MAX_KMAPENT).
If you are using soft updates, the following values should keep you going!
<UL>
<strong>
option MAX_KMAP=120<BR>
option MAX_KMAPENT=6000<BR>
</strong>
</ul>

<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq24.html">[To Section 11.0 - OpenBSD 2.4 Specific Information]</a>
</font>
</p>

<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../images/back.gif" border= "0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>$OpenBSD: faq12.html,v 1.5 1999/06/24 03:36:18 ericj Exp $</small>
</p>
</body>
</html>


