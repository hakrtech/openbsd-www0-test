<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
   <title>OpenBSD Upgrading Mini-FAQ - Old Versions</title>
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#23238E">


<h1>ミニ FAQ: OpenBSD のアップグレード - 旧バージョン</h1>
<h2>こちらでカバーするバージョンは 2.3 〜 3.1 です。</h2>

<address>
<p>
Kjell Wooding 
&lt;<a href="mailto:kjell@openbsd.com">kjell@openbsd.org</a>&gt; <br />
Updated:
$OpenBSD: upgrade-old.html,v 1.2 2004/05/09 09:58:22 saad Exp $
</p>
</address>

<br />

<blockquote>
<p>
このドキュメントは、既にサポートされなくなったバージョンの OpenBSD 
のためのミニ FAQ のエントリを含みます。より最近のバージョンのための
一般的なアップグレード手順については、正式版の
<a href="upgrade-minifaq.html">アップグレード ミニ FAQ</a> を参照してください。
</p>
</blockquote>


<h2>1.0: 一般的なアップグレードについての質問</h2>

<p>
<a href="#1.1">
1.1: より最近のバージョンの OpenBSD に関する情報はどちらにあるのでしょう ?
</a>
</p>

<h2>3.1 からのアップグレード</h2>

    <p>
      <a href="#3.1.1">3.1.1: 新しいユーザ/グループ</a><br>
      <a href="#3.1.2">3.1.2: crontab(1) と at(1) のための新しいグループ</a><br>
      <a href="#3.1.3">3.1.3: 新しい binutils</a><br>
      <a href="#3.1.4">3.1.4: 新しい S/Key の構成</a><br>
      <a href="#3.1.5">3.1.5: lp* のための新しいパーミッション</a><br>
      <a href="#3.1.6">3.1.6: atrun(8) はもはや不要</a><br>
      <a href="#3.1.7">3.1.7: nat.conf の pf.conf へのマージ</a><br>
      <a href="#3.1.8">3.1.8: xdm 用の新しい fbtab 必須エントリ</a><br>
      <a href="#3.1.9">3.1.9: ある種の関数への __attribute__((sentinel))
               の使用</a><br>
    </p>

<h2>3.0 からのアップグレード</h2>

    <p>
      <a href="#3.0.1">3.0.1: mtree(8) でサポートされる新しいキーワード</a><br>
      <a href="#3.0.2">3.0.2: ELF プラットフォームからの libdl の削除</a><br>
      <a href="#3.0.3">3.0.3: リグレッションテスト用の新しいフレームワーク</a><br>
      <a href="#3.0.4">3.0.4: /etc/ssh/ に移動された ssh の設定ファイル</a><br>
    </p>

<h2>2.9 からのアップグレード</h2>

    <p>
      <a href="#2.9.1">2.9.1: 新しいユーザ/グループ - <em>proxy</em> と
	<em>smmsp</em>、<em>popa3d</em></a><br>
      <a href="#2.9.2">2.9.2: 新しいパケットフィルタ: <em>pf</em></a><br>
      <a href="#2.9.3">2.9.3: <em>make</em> への変更</a><br>
      <a href="#2.9.4">2.9.4: KerberosV のエラーが原因の構築の
	失敗</a><br>
      <a href="#2.9.5">2.9.5: 新バージョンの <em>sendmail</em></a><br>
      <a href="#2.9.6">2.9.6: <tt>/etc/primes</tt> の移動</a>
    </p>

<h2>2.8 からのアップグレード</h2>
    
    <p>
      <a href="#2.8.1">2.8.1: 新しい <em>auth</em> グループ</a><br
      />

      <a href="#2.8.2">2.8.2: 新しい <em>wscons</em> コンソールシステム</a><br>

      <a href="#2.8.3">2.8.3: 未定義のシンボルによるカーネルのコンパイルの
	失敗</a><br>
    </p>

<h2>2.7 からのアップグレード</h2>

<p>
<a href="#2.7.1">
2.7.1: 2.7 から 2.8 へのアップグレードでの大きな問題は何でしょう ?
</a>
</p>

<h2>2.6 からのアップグレード</h2>

<p>
<a href="#2.6.1">
2.6.1: Termcap のエントリが長過ぎます
</a> <br />

<a href="#2.6.2">
2.6.2: <em>pn</em> (または <em>mx</em>、<em>al</em>、<em>ax</em>)
デバイスをカーネルが認識しなくなりました
</a> <br />

<a href="#2.6.3">
2.6.3: GCC 2.95.1 から 2.95.2 へのアップグレード
</a> <br />

<a href="#2.6.4">
2.6.4: Kerberos のアップグレード
</a> <br />

<a href="#2.6.5">
2.6.5: M4 のアップグレード
</a> <br />

<a href="#2.6.6">
2.6.6: Sendmail のアップグレード
</a> <br />

<a href="#2.6.7">
2.6.7: アップグレード後、<em>apm(8)</em> サポート
を含むカーネルがブートしなくなりました
</a> <br />

<a href="#2.6.8">
2.6.8: <em>daemon</em> ユーザのデフォルトのグループが変更されました

</a>
</p>


<h2>2.5 からのアップグレード</h2>

<p>
<a href="#2.5.1">
2.5.1: 2.5 から 2.6 へのアップグレードでの大きな問題は何でしょう ?
</a> <br />
<a href="#2.5.2">
2.5.2: <em>gcc</em> から <em>egcs</em> へのアップグレードはどのように行うのでしょう ?
</a>
</p>

<blockquote>
<p>
<a href="#2.5.2.1">2.5.2.1 - i386 および sparc は、最早 #define されていません。</a><br />
<a href="#2.5.2.2">2.5.2.2 - xlint で Build が失敗します。</a><br />
<a href="#2.5.2.3">2.5.2.3 - uthread_autoinit.c で core ダンプします。</a><br />
<a href="#2.5.2.4">2.5.2.4 - egcs は gcc よりずっと遅いようなのですが... </a><br />
<a href="#2.5.2.5">2.5.2.5 - egcs は gcc より大きなコードを生成するようですが... </a><br />
<a href="#2.5.2.6">2.5.2.6 - egcs をインストールしたら、非常に小さなディスク空間しか
残っていません。</a><br />
<a href="#2.5.2.7">2.5.2.7 - ビルドで libcurses の構築に失敗します。</a><br />
<a href="#2.5.2.8">2.5.2.8 - make obj が失敗します。</a>
</p>
</blockquote>

<p>
<a href="#2.5.3">
2.5.3: <em>make build</em> が <em>unimplemented syscall</em> エラーで停止します。
</a> <br />

<a href="#2.5.4">
2.5.4: 新しい 2.6 ディレクトリへのリンク
</a> <br />

<a href="#2.5.5">
2.5.5: <strong>(U)</strong>pgrade を選択後の、<em>base26.tar.gz</em>
の展開が失敗します。
</a>
</p>

<h2>2.4 からのアップグレード</h2>

<p>
<a href="#2.4.1">
2.4.1: Man ページの変更
</a> <br />

<a href="#2.4.2">
2.4.2: <em>cap_mkdb</em> のシンタクスの変更
</a> <br />

<a href="#2.4.3">
2.4.3: Snake
</a>
</p>

<h2>2.3 からのアップグレード</h2>

<p>
<a href="#2.3.1">
2.3.1: 新しいユーザ: <em>named</em>
</a> <br />

<a href="#2.3.2">
2.3.2: 構築しようとすると、<em>ssleay</em> をビルドしようとして
失敗します。</em>.
</a> <br />

<a href="#2.3.3">
2.3.3: 構築しようとすると、PowerPC 用の何かを
make しようとして失敗します。
</a>
</p>


&nbsp;<hr width="30%">

<a name="1.0"></a>
<h2>1.0: 一般的なアップグレードについての質問</h2>


<a name="1.1"></a>
<h3>
1.1: より最近のバージョンの OpenBSD に関する情報はどちらにあるのでしょう ?
</h3>
<p>
正式版の <a href="upgrade-minifaq.html">アップグレード ミニ FAQ</a> を参照してください。
</p>


    <a name="3.2"></a>
    <h2>
      3.2 からのアップグレード
    </h2>

    <a name="3.2.1"></a>
    <h3>
      3.2.1: 新しい Perl (2002/11/05)
    </h3>

    <p>Perl がバージョン 5.8.0 に更新されました。<br>
      Perl 5.8.0 では、XS モジュールの API が stdio から PerlIO に切り替えられたのにともなって
      変更されました (PerlIO についてのより詳しいことは perldelta マニュアルページを参照してください)。
      これは、インストール済のすべての XS モジュール (Perl .so ファイル) を再構築する
      <strong>必要がある</strong>ことを意味します。もし、<em>Undefined symbol "perl_get_sv"</em>
      のようなエラーが発生した場合には、これが原因でしょう。また、もし、
      インストール済のモジュールが packages や ports システムからインストールされたものだけであれば、
      XS モジュールをチェックするために、以下のコマンドを実行してください。
      <pre>
	# grep '\.so' /var/db/pkg/p5-*/+CONTENTS | cut -d: -f1 | sort -u
      </pre>
      これによって見つかった古いモジュールは <em>pkg_delete -f</em> を使用して削除した後、
      これらを ports ツリーから再構築/インストールし直してください。

    <a name="3.2.2"></a>
    <h3>
      3.2.2: 新しいグループ _radius、_token および _shadow (2002/11/21)
    </h3>
    <p>以下のいくつかの新しいグループが追加されました。
      <ul>
      <li><em>_radius</em> グループは、<tt>/etc/raddb/servers</tt>
	  ファイルに対する読み出し専用アクセスを提供するためのグループです。
      <li><em>_token</em> グループは、
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tokeninit&amp;sektion=8">tokeninit(8)</a>、
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tokenadm&amp;sektion=8">tokenadm(8)</a> および
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login_token&amp;sektion=8">login_token(8)</a>
	  が使用するトークンデータベースに対する読み出し専用アクセスを提供するためのグループです。
      <li><em>_shadow</em> グループは、シャドウパスワードデータベースに対する
	  読み出し専用アクセスを提供するためのグループです。
      </ul>

      これらのグループの追加やいくつかのファイルに対するパーミッションの調整は、
      &quot;make build&quot; の実行前に行う必要があります。root 権限で、
      次のコマンドを実行してください。
	<pre>
	  # groupadd -g 63 _radius
	  # chgrp _radius /etc/raddb /etc/raddb/servers
	  # chmod g+x /etc/raddb
	  # chmod g+r /etc/raddb/servers

	  # groupadd -g 64 _token
	  # chgrp _token /etc/activ.db /etc/crypto.db /etc/snk.db
	  # chmod 0640 /etc/activ.db /etc/crypto.db /etc/snk.db

	  # groupadd -g 65 _shadow
	  # chgrp _shadow /etc/spwd.db
	  # chmod 0640 /etc/spwd.db
	</pre>

      ファイルが見つからないというエラーメッセージは気にする必要はありません。それは単に、
      <em>token</em> や <em>radius</em> 認証の設定を行っていないことを意味しているだけです。

    <a name="3.2.3"></a>
    <h3>
      3.2.3: 重要なコンパイラの変更 (2002/12/02)
    </h3>
    <p><a href="http://www.trl.ibm.com/projects/security/ssp">propolice</a>
      スタック保護拡張機能が
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gcc-local&amp;sektion=1">gcc</a>
      にマージされました。このため、アップグレード手順が以下のように若干異なります。
      <ul>
      <li>まだこの時点では、新しいカーネルを構築しては<b>いけません</b>。
      <li>まだこの時点では、新しい gcc を再構築しては<b>いけません</b>。
      <li>シェアードライブラリを持つシステムの場合、新しい ld.so (ダイナミックローダ)
        を構築し、インストールします。
        <pre>
	  # cd /usr/src
	  # make obj
          ELF プラットフォーム (alpha, macppc, sparc, sparc64) の場合、
          # cd /usr/src/libexec/ld.so
          # make depend &amp;&amp; make &amp;&amp; make install
          a.out プラットフォーム (amiga, hp300, i386, mac68k, mvme68k) の場合、
          # cd /usr/src/gnu/usr.bin/ld/rtld
          # make depend &amp;&amp; make &amp;&amp; make install
	</pre>
      <li><i>make build</i> からの、最初の少しのコマンドに従って libc を再構築し、
        インストールします。
	<pre>
          # cd /usr/src/include
	  # make prereq &amp;&amp; make includes
	  # cd /usr/src/lib/libc
	  # make depend &amp;&amp; make NOMAN=1 &amp;&amp; make NOMAN=1 install
	</pre>
        使用中のコンパイラが古過ぎる場合、libc を構築することができない可能性があることに注意が必要です。
        その場合には、snapshot を使用したバイナリアップグレードを実行する必要があります。
      <li><a href="#1.8">1.8</a> 章に従って gcc を再構築し、インストールします。
      <li>ここで、カーネルの再コンパイルを行うことができます。
        カーネル用の Makefile を再生成するために、確実に
        <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8">config</a>
        を再実行してください。
      <li>新しいカーネルでリブートし、スタック保護の効果を得るため、
        <i>make build</i> を実行します。
      </ul>

    <a name="3.2.4"></a>
    <h3>
      3.2.4: 新しいユーザ/グループ _spamd (2002/12/24)
    </h3>
    <p>新しいユーザ/グループ _spamd が
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamd&amp;sektion=8"
      >spamd(8)</a> デーモン用に追加されました。
      root で以下を実行してグループを追加します。
<pre>
  # groupadd -g 62 _spamd
</pre>
      また、<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>
      を使用して次のユーザのエントリを追加してください。
<pre>
  _spamd:*:62:62::0:0:Spam daemon:/var/empty:/sbin/nologin
</pre>

    <a name="3.2.5"></a>
    <h3>
      3.2.5: IPv6-ICMP 用のエイリアス (2002/12/30)
    </h3>

    <p>ipv6-icmp 用の新しいエイリアス、<em>icmp6</em> が、
      <tt>/etc/protocols</tt> に追加されました。<em>icmp6</em> エイリアスを使用する場合 (
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8">pfctl(8)</a>
      のリグレッションテストで使用)、
      <tt>/etc/protocols</tt> ファイル中の <em>ipv6-icmp</em> の行を、# の前に <em>icmp6</em> 
      を追加して変更しなければなりません。
      この行は以下のようにしておくべきです。
    </p>
<pre>
  ipv6-icmp 58    IPv6-ICMP icmp6 # ICMP for IPv6
</pre>

    <a name="3.2.6"></a>
    <h3>
      3.2.6: 新しいグループ _lkm (2003/01/05)
    </h3>

    <p><tt>/dev/lkm</tt> へのアクセスを制御するためのグループ
         <em>_lkm</em> が追加されました。
         <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=modstat&amp;sektion=8">modstat(8)</a>
         は _lkm に setgid されるようになりました。
    <p>
      &quot;make build&quot; の実行前に、このグループを追加し、
      <tt>/dev/lkm</tt> のパーミッションを調整する必要があります。
      次のコマンドを root で実行することで、これが行われます。
<pre>
  # groupadd -g 61 _lkm
  # chgrp _lkm /dev/lkm
</pre>

    <a name="3.2.7"></a>
    <h3>
      3.2.7: 新しい libpthread (2003/01/14)
    </h3>

    <p><em>libc_r</em> と <em>libnpthread</em> が除去され、<em>libpthread</em>
    で置換されました。スレッドを使用するプログラムは、やはり <em>-pthread</em>
    オプションを使用してコンパイルしてください。コンパイラの方で正しく処理
    を行います。

    <p><em>libc_r</em> と <em>libnpthread</em> とを消去する前に、スレッドを使用する
    アプリケーションは <em>libpthread</em> を使用して再コンパイルしておかなければ
    なりません。推奨再構築手順は以下のようになります。

    <ol>
      <li>
        <p><a href="#1.8">1.8</a> 章に従って、gcc を再構築してください。
      <li>
        <p><a href="#1.5">1.5</a> 章に従って、システムを再構築してください。
      <li>
        <p>すべてのスレッドを使用する ports を再構築してください。
      <li>
        <p>使用されなくなったライブラリを消去してください。
<pre>
  # rm /usr/lib/libc_r* /usr/lib/libnpthread*
</pre>
    </ol>

    <a name="3.2.8"></a>
    <h3>
      3.2.8: ELF アーキテクチャ用のリンカの変更 (2003/01/17)
    </h3>

    <p>binutils/ld は、ELF 実行形式に新しいセキュリティ機能を導入するために
    変更されました。これは、実行形式ならびにシェアードライブラリのデータ
    セクションがリンカによってマークされた実行形式になるのを許容する代わりに、
    実行形式としてのプログラムイメージを適切なセクションのみマークされるよう
    レイアウトが変更されたものです。この変更は、ELF アーキテクチャである
    alpha、sparc、sparc64、macppc に対してのみ影響があります。
    <p>
    binutils は、残りのシステムの再構築前に構築しておくことをお勧めします。
    <p>
<pre>
  # cd /usr/src/gnu/usr.bin/binutils
  # make -f Makefile.bsd-wrapper cleandir
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>
    <p>
    そして、<a href="#1.5">1.5</a> 章に従って、システムを再構築してください。

    <a name="3.2.9"></a>
    <h3>
      3.2.9: /var/at の削除と crontab の変更 (2003/02/19)
    </h3>

    <p><em>at</em> が <em>cron</em> と統合されたことにともない、<tt>/var/at</tt>
    のコンテンツは <tt>/var/cron</tt> にマージされました。さらに、POSIX に準拠するため、
    および at.allow と at.deny との一貫性の維持のため、<em>cron</em> の allow および
    deny ファイルは、それぞれ cron.allow および cron.deny にリネームされました。
    <p>
    まず、<a href="#1.5">1.5</a> 章に従って、システムを再構築してください。
    そして、次のように既存のファイルを移動させて cron を再起動してください。
    <p>
<pre>
  # mv /var/at/* /var/cron
  # mv /var/cron/jobs /var/cron/atjobs
  # mv /var/cron/allow /var/cron/cron.allow
  # mv /var/cron/deny /var/cron/cron.deny
  # rm -rf /var/at 
  # kill `cat /var/run/cron.pid`
  # /usr/sbin/cron
</pre>
    <p>
    allow および deny ファイルがなくなったことによる一切の警告メッセージは無視してください。
    それらのすべてがデフォルトでインストールされるものというわけではないからです。
    <p>
    もし、まだ cron.deny ファイルがない場合で (このファイルは OpenBSD 3.3 以前の
    バージョンではインストールされません)、<em>crontab</em> をスーパーユーザ以外の
    ユーザ権限で実行したい場合には、このファイルが必要となります。
<pre>
  # install -c -o root -g crontab -m 660 /dev/null /var/cron/cron.deny
</pre>

    <a name="3.1"></a>
    <h2>
      3.1 からのアップグレード
    </h2>
    
    <a name="3.1.1"></a>
    <h3>
      3.1.1: 新しいユーザ/グループ
    </h3>

    <p>いくつかの新しいユーザ/グループが追加されました。
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8">authpf(8)</a>
      のサポートのため、新しいグループが必要になりました。また、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8">sshd(8)</a>
      の特権分離機能のサポートのため、<em>sshd</em> という
      新しいユーザとグループがシステムに追加されました。
      システムサービス用に、さらにいくつかの
      &quot;_&quot; をプレフィクスとして持つ
      新しいユーザが追加されました。
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>
      を使用して、次のユーザエントリを追加してください。
    </p>
<pre>
  sshd:*:27:27::0:0:sshd privsep:/var/empty:/sbin/nologin
  _portmap:*:28:28::0:0:portmap:/var/empty:/sbin/nologin
  _identd:*:29:29::0:0:identd:/var/empty:/sbin/nologin
  _rstatd:*:30:30::0:0:rpc.rstatd:/var/empty:/sbin/nologin
  _rusersd:*:32:32::0:0:rpc.rusersd:/var/empty:/sbin/nologin
  _fingerd:*:33:33::0:0:fingerd:/var/empty:/sbin/nologin
  _x11:*:35:35::0:0:X server:/var/empty:/sbin/nologin
</pre>
    
    <p>また、次のような行を /etc/group に追加します。</p>
       
<pre>
  sshd:*:27:
  _portmap:*:28:
  _identd:*:29:
  _rstatd:*:30:
  _rusersd:*:32:
  _fingerd:*:33:
  _sshagnt:*:34:
  _x11:*:35:
  authpf:*:72:
</pre>

    <a name="3.1.2"></a>
    <h3>
      3.1.2: crontab(1) と at(1) のための新しいグループ
    </h3>

    <p>
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">
      crontab(1)</a> と
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=at&amp;sektion=1">
      at(1)</a>
      コマンドは、もはや setuid root されたものではなくなり、
      <em>crontab</em> グループに setgid されたものになりました。

    <p>
      &quot;make build&quot; を実行する前に、
      <em>crontab</em> グループを追加する必要があるでしょう。
      <tt>/etc/group</tt> ファイルに次のような行を追加してください。</p>

<pre>
  crontab:*:66:
</pre>

<p>
      また、&quot;make build&quot; は、パーミッションも更新しますが、
      すべてではありませんので、&quot;make build&quot; の終了後に、
      次のコマンドを手動で実行してください (<tt>/bin/csh</tt> を仮定します)。
</p>

<pre>
  # chgrp crontab /var/at/at.{allow,deny} /var/cron/{allow,deny}
  # chmod 0640 /var/at/at.{allow,deny} /var/cron/{allow,deny}
  # foreach f ( /var/cron/tabs/* )
	  set u=`basename $f`
 	  chown $u:crontab $f
    end
</pre>

<p>
      もっとも、たぶん allow/deny ファイルが全然ないと思いますので、
      これは問題にはならないとは思います。
</p>

    <a name="3.1.3"></a>
    <h3>
      3.1.3: 新しい binutils
    </h3>

<p>
新しい binutils (2.11.2) がツリーに導入されましたが、これは更新済の <em>libiberty</em>
を必要としています。このライブラリを構築するには、次のステップに従ってください。
</p>
  
<pre>
  # cd /usr/src/gnu/egcs/libiberty
  # make -f Makefile.bsd-wrapper cleandir
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>

    <a name="3.1.4"></a>
    <h3>
      3.1.4: 新しい S/Key の構成
    </h3>

    <p>
      古い S/Key データベースファイルである <tt>/etc/skeykeys</tt> は、<tt>/etc/skey</tt>
      というディレクトリに置き換えられ、それぞれのレコードは、それが記述しているユーザが
      所有する個々のファイルになりました。<tt>/etc/skeykeys</tt> を (root 権限で) 次の
      コマンドを実行することで新しい形式に変換することができます。
    </p>
<pre>
  # skeyinit -C
  # mv /etc/skeykeys /etc/skeykeys.OLD
</pre>

<p>
      すべての S/Key ディレクトリを使用するサードパーティープログラムについては、
      再コンパイルする必要があるということに注意してください。
</p>

    <a name="3.1.5"></a>
    <h3>
      3.1.5: lp* のための新しいパーミッション
    </h3>

    <p>
      現在では、lpr にファイルをスプール可能にするため、lpd の使用する
      ディレクトリは daemon グループが書き込み可能でなければなりません。
      さらに、スプールディレクトリ中のファイルは、所有者・グループ共に
      daemon でなければなりません。これは、次の方法で変更できます。
    </p>
<pre>
 # find /var/spool/output /var/spool/lpd -type d \
	-execdir chgrp daemon {} \; -execdir chmod g+rwx {} \;
 # find /var/spool/output /var/spool/lpd -type f \
	-execdir chown daemon:daemon {} \;
</pre>

    <a name="3.1.6"></a>
    <h3>
      3.1.6: atrun(8) はもはや不要
    </h3>

    <p>
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=atrun&amp;sektion=8">atrun(8)</a>
      コマンドが、もはや不要のものとなりました。その機能は、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=cron&amp;sektion=8">cron(8)</a>.
      に統合されました。次のコマンドを root で実行して、<tt>/usr/libexec/atrun</tt>
      のジョブを root の crontab から削除してください。
    </p>
    <pre>
      # crontab -e
    </pre>

    <p>
      また、<tt>/usr/libexec/atrun</tt>、
      <tt>/usr/share/man/cat8/atrun.0</tt> および
      <tt>/var/at/spool</tt> ディレクトリも削除可能です。
    </p>

    <a name="3.1.7"></a>
    <h3>
      3.1.7: nat.conf の pf.conf へのマージ
    </h3>

    <p>
       <tt>/etc/nat.conf</tt> は <tt>/etc/pf.conf</tt> にマージされました。
       NAT ルールは、pf.conf の scrub ルールとフィルタルールとの間に挿入
       してください。
    </p>
    <p>
       <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8">pfctl(8)</a>
       には、ルールセットをロードするための新しいオプション -f が実装され、
       -R および -N オプションには新しい意味が付加されました。man ページを
       確認して、確実に <tt>/etc/rc</tt> を更新するようにしてください。
    </p>

    <a name="3.1.8"></a>
    <h3>
     3.1.8: xdm 用の新しい fbtab 必須エントリ
    </h3>

    <p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login&amp;sektion=1">
login(1)</a> は、多くのアーキテクチャで xdm が特権を放棄するために使用する、
新しい _x11 ユーザに /dev/wsmouse を chown する必要があります。<tt>/etc/fbtab</tt>
への変更は、アーキテクチャに依存します。ファイルは (それが /usr/src にあると
仮定して)、以下のプロセスで生成してください。
    </p>
<pre>
  # cat /usr/src/etc/fbtab.head > /etc/fbtab
  # cat /usr/src/etc/etc.`uname -m`/fbtab >> /etc/fbtab
  # cat /usr/src/etc/fbtab.tail >> /etc/fbtab
</pre>
<p>
もし、あなたが <tt>/etc/fbtab</tt> に特別な変更を施している場合には、それらを
手動で新しいファイルにマージする必要があります。
</p>
   <a name="3.1.9"></a>
   <h3>
    3.1.9: ある種の関数への __attribute__((sentinel)) の使用
   </h3>

   <p>
     __attribute__((sentinel)) は、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=exec&amp;sektion=3">
exec(3)</a> 関数が NULL ポインタで終端していない状態で使用された場合に
     警告を発するために使用されるようになります。
     <br><br><tt>make build</tt> に先だって、ミニ FAQ の
     <a href="#1.8">1.8</a> 章に従って、
     gcc を再構築しなければなりません。
   </p>

    <a name="3.0"></a>
    <h2>
      3.0 からのアップグレード
    </h2>
    
    <a name="3.0.1"></a>
    <h3>
      3.0.1: mtree(8) でサポートされる新しいキーワード
    </h3>

    <p>
      &quot;make build&quot; が成功するためには、新しいバージョンの
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">mtree(8)</a> 
      ユーティリティを構築して、インストールする必要があります。
    </p>
<pre>
  # cd /usr/src/usr.sbin/mtree
  # make cleandir
  # make obj
  # make depend
  # make
  # make install
</pre>

    <a name="3.0.2"></a>
    <h3>
      3.0.2: ELF プラットフォームからの libdl の削除
    </h3>
    
    <p>
      ELF ベースのプラットフォーム (alpha と macppc、sparc64) では、もう
      libdl は使用されなくなりました。libdl を使用するシステムから使用しない
      システムへのアップグレードは、次のステップで行うのが最も良いでしょう。
    </p>

    <ul>
      <li>
	<p>システムの再コンパイルを行います。</p>
<pre>
  # cd /usr/src
  # make build
</pre>
      </li>

      <li>
	<p>
	  &quot;make build&quot; が成功したなら、次のステップに進むことが
	  でき、libdl も削除することができます。ただし、これをリンクしている
	  packages は、その後に再インストールすべきであることに注意して
	  ください。その準備ができていないなら、取りあえず、このステップを
	  飛ばすこともできます。正しい packages が用意された snapshot が
	  用意されます。
	</p>
<pre>
  # rm -f /usr/lib/libdl.* /usr/lib/libdl_pic.a
</pre>
	</li>
      <li>
	<p>
	  libdl を削除したら、シェアードライブラリのキャッシュを再生成してください。
	</p>
	
<pre>
  # ldconfig -R
</pre>
      </li>
    </ul>

    <a name="3.0.3"></a>
    <h3>
      3.0.3: リグレッションテスト用の新しいフレームワーク
    </h3>
    
    <p>
      リグレッションテスト用の新しいインフラストラクチャーが導入され、
      <tt>bsd.regress.mk</tt> が追加されました。<em>make obj</em> を
      実行する前に、このファイルをインストールしておく必要があります。
    </p>

<pre>
  # cd /usr/src/share/mk
  # make install
</pre>

    <a name="3.0.4"></a>
    <h3>
      3.0.4: /etc/ssh/ に移動された ssh の設定ファイル
    </h3>

    <p>
      まず、/etc/ssh/ を作成する必要があります。
      <a href="#1.13">1.13</a> を参照してください。
    </p>

    <p>
      システムの再コンパイルを行います。
    </p>
<pre>
  # cd /usr/src
  # make build
</pre>

    <p>
      /etc/ssh*_* ファイルを、新しく作成した /etc/ssh/ ディレクトリに移動します。
    </p>
<pre>
  # cd /etc
  # mv ssh*_* ssh/
</pre>

    <p>
      これらの変更を反映するため、
      <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/rc.diff?r1=1.188&amp;r2=1.189">
	<tt>rc</tt> スクリプトを変更</a>
      する必要があります。
    </p>

    <p>
      新しい場所を反映するように、sshd_config ファイルの中の <tt>HostKey</tt>
      の行を更新します。たとえば、
    </p>
<pre>
  HostKey /etc/ssh_host_key
</pre>

    <p>というのは次のように変更します。</p>

<pre>
  HostKey /etc/ssh/ssh_host_key
</pre>

    <p>
      これらの変更後、sshd デーモンを再起動してください。
    </p>

    <a name="2.9"></a> 
    <h2>2.9 からのアップグレード</h2>

    <a name="2.9.1"></a> 
    <h3>2.9.1: 新しいユーザ/グループ - <em>proxy</em> と
      <em>smmsp</em>、<em>popa3d</em></h3>

    <p>
      まず、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">pf(4)</a>
      パケットフィルタリングパッケージ、
      および、その構成部品の
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8">ftp-proxy(8)</a>
      の追加にともなって、
      <em>proxy</em> という、
      新しいユーザとグループがシステムに追加されました。
      この新しい追加機能をサポートするため、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>
      を使用して、次のようなユーザエントリを追加してください。</p>

<pre>
proxy:*:71:71::0:0:Proxy Services:/nonexistent:/sbin/nologin
</pre>

    <p>Also add the <em>proxy</em> group to /etc/group:</p>

<pre>
proxy:*:71:
</pre>

    <p>次に、sendmail 8.12 のアップグレードにともなって、sendmail は
      もはや setuid root としては実行されなくなりました。<em>smmsp</em>
      という、新しいユーザと新しいグループがシステムに追加されましたので、
      次のような行を <tt>/etc/group</tt> に追加します。</p>

<pre>
smmsp:*:25:
</pre>

    <p>そして、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>
      を実行して、
      <em>smmsp</em> ユーザのための次のような行を
      追加してください。</p>

<pre>
smmsp:*:25:25::0:0:Sendmail Message Submission Program:/nonexistent:/sbin/nologin
</pre>

    <p>この行が、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=yp&amp;sektion=8">yp(8)</a>
      を設定するための行よりも前にあることを確認してください。</p>

    <p>最後に、システムの構成部分のひとつとなった、Solar Designer の
      popa3d サーバのための、新しいユーザと新しいグループが追加されました。
      次のような行を <tt>/etc/group</tt> に追加します。</p>

<pre>
popa3d:*:26:
</pre>

    <p>そして、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>
      を使用して、次の行を追加してください。</p>
<pre>
popa3d:*:26:26::0:0:POP3 server:/var/empty:/sbin/nologin
</pre>

    <a name="2.9.2"></a> 
    <h3>2.9.2: 新しいパケットフィルタ: <em>pf</em></h3>

    <p>以前の OpenBSD の release の部品だった
      IPF パケットフィルタリングパッケージは、
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">pf(4)</a>
      と呼ばれる、完全に新しいパケットフィルタリング
      パッケージと置き換えられました。その結果として、
      多くの変更を行う必要があります。</p>

    <p>まず、<em>pf</em> には新しいデバイスファイルが必要です。次のようにして、
      この新しいスペシャルデバイスが作成されていることを確認してください。</p>

<pre>
  # cd /dev
  # cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  # ./MAKEDEV all
</pre>

    <p>次に、多くのファイルの変更が行われました。参考までに、
      次のバイナリが置き換えられました。</p>

<pre>
OLD:
/sbin/ipf /sbin/ipfstat /sbin/ipnat /usr/sbin/ipfs
/usr/sbin/ipftest /usr/sbin/ipmon /usr/sbin/ipresend
/usr/sbin/ipsend /usr/sbin/iptest
NEW:
/sbin/pfctl
/usr/libexec/ftp-proxy
</pre>

    <p>同様に、デバイスの方も次のように置き換えられ、</p>

<pre>
OLD: /dev/ipl /dev/ipnat /dev/ipstate /dev/ipauth
NEW: /dev/pf
</pre>

    <p>そしてフィルタ設定ファイルも次のように置き換えられました。</p>

<pre>
OLD: /etc/ipf.rules /etc/ipnat.rules
NEW: /etc/pf.conf /etc/nat.conf
</pre>
    <p>古い IPfilter のサンプル設定ファイルは消去しても構わないでしょう。
    </p>
<pre>
  # rm -rf /usr/share/ipf
</pre>

    <p><em>pf</em> を安全に有効化するためのメカニズムが、
      <tt>/etc/rc</tt> と <tt>/etc/rc.conf</tt> ファイルに追加されました。
      新しいフックメカニズムを含むこれらのファイルを、更新する必要が
      あります。<em>pf</em> を有効化するには、<tt>/etc/rc.conf</tt>
      の中に、PF=YES をセットします。</p>

    <a name="2.9.3"></a> 
    <h3>2.9.3: <em>make</em> への変更点</h3>

    <p><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=make&amp;sektion=1">make(1)</a>
      と、そのデータファイルに変更が加えられましたが、
      それが構築のプロセスでの障害の原因となるかも知れません。
      これは通常、構築の際に、<em>bsd.own.mk</em> の中で発生する
      エラーとして現われます。この問題を回避するためには、
      次のデータファイルをまず更新してください。</p>
<pre>
  # cd /usr/src/share/mk
  # make install
</pre>

    <p>そして次に、新しい make を構築し、インストールします。</p>

<pre>
  # cd /usr/src/usr.bin/make
  # make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make
  # make install
</pre>

    <p>さぁ、アップグレードを継続してください。</p>
    
    <a name="2.9.4"></a>
    <h3>2.9.4: KerberosV のエラーが原因の構築の失敗</h3>

    <p>システム全体の構築を始める前に、まず、KerberosV の構築を
      行う必要があります。</p>

    <p>まず、<em>/etc</em> の下に新しい KerberosV 用の設定ファイル用の
      が作られました。もし、このディレクトリをまだ作っていないのでしたら、
      <a href="#1.13">1.13 章</a> に記述されている
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">mtree(8)</a>
      を使用して作成してください。</p>

    <p>では、KerberosV を構築しましょう。</p>

<pre>
  # cd /usr/src/kerberosV
  # make obj
  # cd lib/roken
  # make 
  # cd ../../usr.bin/asn1_compile
  # make
  # make install
</pre>

    <p><tt>/usr/libexec/auth/login_krb-or-pwd</tt>  は
      <tt>login_krb<strong>4</strong>-or-pwd</tt> に
      ファイル名が変更されましたが、これを反映するよう
      <tt>/etc/login.conf</tt> を更新する必要もあります。</p>

    <a name="2.9.5"></a> 
    <h3>2.9.5: 新バージョンの <em>sendmail</em></h3>

    <p><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">sendmail(8)</a>
      は、バージョン 8.12 へとアップグレードされました。
      このバージョンの <em>sendmail</em> は、
      もはや setuid root として実行されなくなりました。
      このため、大きな変更が行われました。</p>

    <ol>
      <li>新しいユーザと新しいグループ (<em>smmsp</em>) が追加されました。
	これらのユーザの作成がまだでしたら、<a href="#2.9.1">2.9.1 章</a>
	の手順に従って、作成してください。</li>

      <li><tt>新しい /var/spool/clientmqueue</tt> ディレクトリや
	<tt>/var/spool/mqueue</tt> の新しいパーミッションなど、
	ファイルの階層構造にいくつかの変更が行われました。
	これらの変更には、
	<a href="#1.13">1.13 章</a> に記述されている
	<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">mtree(8)</a>
	を使用することができます。</li>

      <li>
        <p>以下に示す行を、root の
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">crontab(1)</a>
	  に追加してください。<em>sendmail</em> は、
	  もはや setuid root バイナリではなくなりましたので、
	  その仕事に一部は、これに依存するようになりました。</p>

<pre>
# sendmail clientmqueue runner
*/30    *       *       *       *       /usr/sbin/sendmail -L sm-msp-queue -Ac -q
</pre>

      </li>
      
      <li>
        <p>sendmail をアップグレードします。</p>

<pre>
  # cd /usr/src/gnu/usr.sbin/sendmail
  # make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>

        <p><strong>注:</strong> <tt>submit.cf</tt> と
	  <tt>localhost.cf</tt> は、
	  <tt>/etc/mail</tt> ディレクトリにインストールされています。
	  前者の <tt>submit.cf</tt> (これは、現在の sendmail のドキュメンテーション
	  にある、"クライアント" 機能用設定ファイルとして参照されます) は、
	  sendmail でローカルにメールを配送しようとするユーザのメーラー (MUA) が
	  使用します。上述のとおり、パーミッションの変更によって、これらは
	  root 権限を必要としなくなり、sendmail のバイナリは、smmsp に
	  setgid されるようになりました。
	  後者の <tt>localhost.cf</tt> は、
	  sendmail がローカルホストからのメールを受信するのに、
	  localhost インターフェースのみを待ち受けるようにして、
	  ネットワークからの接続を受け付けないという、
	  いわゆるひとつの OpenBSD の流儀です (たとえば、
	  外部インターフェースの SMTP ポートを待ち受けるのに、
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=smtpd&amp;sektion=8">smtpd(8)</a>
	  などを使用しているのなら、間違いなくこれを必要とするでしょう)。
	  より詳しくは、<tt>/usr/src/gnu/usr.sbin/sendmail/sendmail</tt> ディレクトリの下の
	  <tt>SECURITY</tt> ファイルを参照してください。</p>

        <p><tt>/etc/mail</tt> の下の sendmail の設定ファイルを再生成し、
	  更新することを強く推奨します。<tt>/usr/share/sendmail/cf</tt>
	  の下に、使えそうな構成ファイルを見つけられるかも知れません。
	  localhost.cf は、openbsd-localhost.mc から
	  生成されたものだということに注意してください。</p>
      </li>

      <li>
        <p>インストール後のデフォルトの設定がそうであるように、
	  <tt>/etc/rc.conf</tt> の中で <tt>-bd</tt> オプションを指定せずに
	  sendmail を実行しているのなら、<tt>localhost.cf</tt> を
	  使用する必要があります。次のように、これが使われるよう、
	  <tt>rc.conf</tt> を編集しましょう。</p>
<pre>
# For normal use: "-L sm-mta -bd -q30m"
sendmail_flags="-L sm-mta -C/etc/mail/localhost.cf -bd -q30m"
</pre>
      </li>

      <li>
        <p>設定ファイルの準備ができたら、現在実行中の sendmail を
         <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kill&amp;sektion=1">kill(1)</a>
         しましょう。</p>
<pre>
  kill `sed 1q /var/run/sendmail.pid`
</pre>

        <p>これで、正しいオプションで新しい sendmail が再起動されます。
	  たとえば、外部からのメールを受け付ける場合は、</p>
<pre>
  /usr/sbin/sendmail -L sm-mta -bd -q30m
</pre>

        <p>のようになりますし、また、ローカルのメールのみの設定なら、</p>

<pre>
  /usr/sbin/sendmail -L sm-mta -C/etc/mail/localhost.cf -bd -q30m
</pre>

        <p>のようになります。</p>

        <p><strong>注:</strong> <tt>-bd</tt> オプションは、現在は、
	  どちらのケースでも必要とされます。</p>
      </li>
    </ol>

    <p>これで、新しい <em>sendmail</em> が実行されているはずです。</p>

    <a name="2.9.6"></a> 
    <h3>2.9.6: <tt>/etc/primes</tt> の移動</h3>

    <p><tt>/etc/primes</tt> は <tt>/etc/moduli</tt> に
      ファイル名が変更されました。古いファイルをリネームするか、
      または、<tt>/usr/src/etc</tt> から単にコピーしてください。</p>


<a name="2.8"></a> 
<h2>2.8 からのアップグレード</h2>


<a name="2.8.1"></a> 
<h3>2.8.1: 新しい <em>auth</em> グループ</h3>

<p>GID 11 の新しいグループ <em>auth</em> がシステムに追加されました。
<tt>/etc/group</tt> ファイルに以下のような行を
追加してください。</p>

<pre>
  auth:*:11:
</pre>

<a name="2.8.2"></a> 
<h3>2.8.2: 新しいコンソールシステム <em>wscons</em></h3>

<p><em>pcvt</em> コンソールドライバは <em>wscons</em>
コンソールシステムで置換されます。wscons を使用する前には、wscons
関連のデバイスを生成しておく必要があります。最新の MAKEDEV
がインストールされていることを確認し、すべてのドライバを make してください。</p>

<pre>
 # cp /usr/src/etc/etc.i386/MAKEDEV /dev/MAKEDEV
 # cd /dev
 # ./MAKEDEV all
</pre>

<p>もし、X を実行しているのなら、その <em>XF86Config</em> ファイルの
Pointer セクションを、以下の例のような行を含むよう変更してください。</p>

<pre>
    Protocol    "wsmouse"
    Device      "/dev/wsmouse"
</pre>

<a name="2.8.3"></a> 
<h3>2.8.3: 未定義のシンボルによるカーネルのコンパイルの失敗</h3>

<p><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8">config(8)</a> が更新されました。
古い <em>config</em> を使用して構築するのは、以下のようなエラーの原因となってしまいます。</p>
<pre>
  Undefined symbol `_pdevnames_size' referenced
  Undefined symbol `_pdevnames' referenced
</pre>

<p>これを修正するためには、新しい <em>config</em> をコンパイルし、インストールしてください。</p>
<pre>
  # cd /usr/src/usr.sbin/config
  # make clean &amp;&amp; make depend &amp;&amp; make
  # make install
</pre>

<p>これで、以前のように新しいカーネルをコンパイルできるようになりました。</p>


<a name="2.7"></a>
<h2>
2.7 からのアップグレード
</h2>

<a name="2.7.1"></a>
<h3>
2.7.1: 2.7 から 2.8 へのアップグレードでの大きな問題は何でしょう ?
</h3>

<p>
自己参照 <em>libc</em> ライブラリの生成を非常に簡単にすることのできる
gcc の大規模な変更が導入されました。この理由により、アップグレードするためには、 
以下の手順を正確に実行してください。
</p>

<ol>
<li> ソースツリーから<a href="upgrade-minifaq.html#1.10">ゴミを消去</a>し、
2.8 のソースコードを取得してください。</li>

<li>
<p>
 新しいリンカをビルドしてインストールします。これは、<em>gcc</em>
全体をビルドする前に実行する<strong>必要があります</strong>。
</p>
<pre>
  $ cd /usr/src/gnu/usr.bin/ld
  $ make clean &amp;&amp; make obj &amp;&amp; make
  $ sudo make install
</pre>
</li>
<li> 新しい <em>gcc</em> をビルドし、インストールします。
     <a href="upgrade-minifaq.html#1.8">BOOTSTRAP</a> の手順により、
     この作業を高速化することができます。
</li>

<li>
<p> 新しいカーネルを構築します。ただし、まだインストールしないでください。</p>
<pre>
  $ cd /usr/src/sys/arch/`machine`/conf
  $ config GENERIC
  $ cd ../compile/GENERIC
  $ make clean &amp;&amp; make depend &amp;&amp; make
</pre>
</li>

<li><p> いくつかの libc の変更のため、<tt>/etc/resolv.conf</tt> に <em>lookup file bind</em>
   という行が含まれていないと、起動時にマシンがハングアップするかも知れません。
   必要なら、この行を追加してください。</p>
<pre>
  # echo &quot;lookup file bind&quot; &gt;&gt; /etc/resolv.conf
</pre>
</li>
<li> 新しいカーネルをインストールし、マシンを再起動してください。
<pre>
  # cd /usr/src/sys/arch/`machine`/compile/GENERIC
  # mv /bsd /bsd.old
  # mv bsd /bsd
  # chown root.wheel /bsd
  # shutdown -r now
</pre>
<p>
(もし、このステップが失敗した場合には、<tt>boot&gt;</tt> プロンプトに
古いカーネル - bsd.old - を指定してリカバーすることができます。)</p>
</li>
<li> 
<p>新しい make (とそのサポートファイル) をビルドし、インストールします。
     その際に <tt>make depend</tt> のステップを忘れずに実行してください。
</p>
<pre>
  $ cd /usr/src/usr.bin/make
  $ make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make
  $ sudo make install
  $ cd /usr/src/share/mk
  $ sudo make install
</pre>
</li>

<li>
<p>最新の <em>mtree</em> をインストールし、必要なディレクトリ構造が
     存在していることを確認しておいてください。</p>
<pre>
  $ cd /usr/src/etc/mtree
  $ sudo install -c -o root -g wheel -m 444 4.4BSD.dist /etc/mtree
  $ sudo mtree -qdef /etc/mtree/
</pre>
</li>

<li> ここで、make build を実行します。
<pre>
  # cd /usr/src &amp;&amp; make build
</pre>
</li>

<li> そして、<a href="upgrade-minifaq.html#1.9"><tt>/etc</tt> <tt>/var</tt>
     ならびに <tt>/dev/MAKEDEV</tt></a> を手動で更新してください。

</li>
</ol>

<a name="2.6"></a>
<h2>
2.6 からのアップグレード
</h2>

<a name="2.6.1"></a>
<h3>
2.6.1: Termcap のエントリが長過ぎます
</h3>

<p>
新しい <tt>termcaps.master</tt> ファイルが作成されました。このため、
現行バージョンの
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tic&amp;sektion=1">tic(1)</a>
を使用して、<tt>terminfo</tt> と <tt>termcaps</tt> ファイルの再生成が必要となります。
もし、<em>make build</em> でアップグレードを行う場合、現行バージョンの tic(1)
を使用して、この再生成が実行されます。この作業を実行していない場合、
以下のようなエラーが発生します。
</p>

<pre>
    terminfo.src is corrupt! You need to update /usr/bin/tic
</pre>

<p>
この場合、(現行バージョンの <tt>libcurses</tt> が確実に使用されるようにして)
tic(1) を再構築してインストールしなければなりません。または、ソースツリー中の
バージョンの tic(1) を単純に構築してください。
</p>

<a name="2.6.2"></a>
<h3>
2.6.2: <em>pn</em> (または <em>mx</em>、<em>al</em>、<em>ax</em>)
デバイスをカーネルが認識しなくなりました
</h3>

<p> (注: 単純化のため、<em>pn</em> を以下で使用しています。これは、
必要に応じて、<em>pn</em>、<em>mx</em>、<em>al</em> または <em>ax</em>
に読み換えてください。)
</p>

<p>
これらの 4 個のドライバは、単一の <em>dc</em> ドライバで置換されました。
設定ファイル中に現れるすべての <em>pn*</em>、<em>mx</em>、<em>al</em> や
<em>ax</em> を変更する必要があります。これは、以下のものを含みます。
</p>

<ul>
<li>カーネル設定ファイルの更新 (ヒント: まっさらな GENERIC
    カーネルから始め、ここから変更しましょう)。
</li>
<li><tt>/etc/hostname.pn*</tt> を <tt>/etc/hostname.dc*</tt> にリネーム。
</li>
<li><tt>/etc/ifaliases</tt> ファイルの更新。
</li>
<li>新しいインターフェイス名を反映するための、
    <tt>/etc/ipnat.rules</tt> および <tt>/etc/ipf.rules</tt> の変更。</li>
</ul>

<p>
カスタムカーネルを変更する場合には、カーネル設定ファイル中に
以下のように <em>dcphy</em> デバイスが含まれていることを確認してください。
</p>

<pre>
dcphy*  at mii? phy ?                           # Digital Clone PHYs
</pre>

<p>この変更の際、以下のデバイスも追加して構いません。</p>

<pre>
ukphy*  at mii? phy ?                           # "unknown" PHYs
</pre>

<a name="2.6.3"></a>
<h3>
2.6.3: GCC 2.95.1 から 2.95.2 へのアップグレード
</h3>

<p>2000 年 1 月 19 日ころ、<em>gcc</em> 2.95.2 が OpenBSD
のソースツリーにマージされました。従って、正しく <em>gcc</em> をビルドするため、
最近の (2.6 以後の) <em>libiberty</em> が必要になります。
このライブラリをビルドは、以下の手順で行ってください。</p>

<pre>
	cd /usr/src/gnu/egcs/libiberty
	make -f Makefile.bsd-wrapper clean
	make -f Makefile.bsd-wrapper obj
	make -f Makefile.bsd-wrapper
	make -f Makefile.bsd-wrapper install
</pre>

<p>
注: pmax のような MIPS ベースのアーキテクチャでは、新しいライブラリのビルド後、
明示的に <em>ldconfig</em> を実行する必要があります。
</p>

<p><em>libiberty</em> がビルドできたら、標準的な <em>gcc</em>
のブートストラップを進めてください。</p>

<pre>
   cd /usr/src/gnu/egcs/gcc
   make -f Makefile.bsd-wrapper clean
   make -f Makefile.bsd-wrapper obj
   make -f Makefile.bsd-wrapper -DBOOTSTRAP
   make -f Makefile.bsd-wrapper -DBOOTSTRAP install
   make -f Makefile.bsd-wrapper clean
   make -f Makefile.bsd-wrapper 
   make -f Makefile.bsd-wrapper install
</pre>

<a name="2.6.4"></a>
<h3>
2.6.4: Kerberos のアップグレード
</h3>

<p>
Kerberos IV を正しくビルドするため、
以下の手順を実行する必要があります。
</p>

<ul>
<li>
<p> 最新の <tt>usr.bin/compile_et</tt> を取得し、ビルドします。</p>
<pre>
   # cd /usr/src/usr.bin/compile_et
   # make clean &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>

<li>
<p> 最新の <tt>lib/libcom_err</tt> を取得し、ビルドします。</p>
<pre>
   # cd /usr/src/lib/libcom_err
   # make clean &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>

<li>
<p> いったん Kerberos ヘッダファイルの消去して、再インストールします。</p>
<pre>
  # rm -r /usr/include/kerberosIV/*
  # cd /usr/src/kerberosIV
  # make includes
</pre>
</li>
<li>
<p> ここで、Kerberos ライブラリファイルを再構築してください。</p>
<pre>
   # cd /usr/src/kerberosIV/lib
   # make clean &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>
<li>
<p> 完全な make build を実行しない場合には Kerberos を再構築する必要があります。</p>
<pre>
   # cd /usr/src/kerberosIV
   # make cleandir &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>
</li>
<li> 上記を実行しない場合には、単に <em>make build</em> を再開してください。</li>
</ul>


<a name="2.6.5"></a>
<h3>
2.6.5: M4 のアップグレード
</h3>

<p>
OpenBSD 2.6 とともに出荷されているバージョンの m4 は、sendmail の .mc ファイルを
.cf ファイルに変換する際に、無限ループに入ってしまうことがあります。このため、
<em>make build</em> を実行しようとする<strong>前</strong>に、新しいバージョンの m4
をインストールする必要があります。そのためには、以下のような処理を行ってください。
</p>

<pre>
    # cd /usr/src/usr.bin/m4
    # make &amp;&amp; make install &amp;&amp; make cleandir
</pre>

<a name="2.6.6"></a>
<h3>
2.6.6: Sendmail のアップグレード
</h3>

<p>
sendmail 8.10.X では、sendmail 設定ファイルの場所 (と名前) が変更されました。
PID ファイル以外のすべてのファイルは、/etc/mail の下に置かれるようになりました。
さらに、いくつかのファイルで、そのファイル名が変更されました。
</p>

<table border="0">
<tr>
  <td><strong>OLD</strong></td>
  <td><strong>NEW</strong></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.cf</tt></td>
  <td><tt>/etc/mail/sendmail.cf</tt></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.cw</tt></td>
  <td><tt>/etc/mail/local-host-names</tt></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.ct</tt></td>
  <td><tt>/etc/mail/trusted-users</tt></td>
</tr>
<tr>
  <td><tt>/etc/sendmail.oE</tt></td>
  <td><tt>/etc/mail/error-header</tt></td>
</tr>
<tr>
  <td><tt>/etc/aliases</tt></td>
  <td><tt>/etc/mail/aliases</tt></td>
</tr>
<tr>
  <td><tt>/etc/service.switch</tt></td>
  <td><tt>/etc/mail/service.switch</tt></td>
</tr>
<tr>
  <td><tt>/etc/userdb</tt></td>
  <td><tt>/etc/mail/userdb</tt></td>
</tr>
<tr>
  <td><tt>/usr/share/misc/sendmail.hf</tt></td>
  <td><tt>/etc/mail/helpfile</tt></td>
</tr>
</table>

<p>
古い sendmail の設定ファイルから新しい設定ファイルへの変換方法には
いくつかの方法がありますが、最初のステップはどの方法でも同じです。
</p>

<ol>
<li> <tt>/etc/sendmail.cf</tt> の代わりに <tt>/etc/mail/sendmail.cf</tt>
     を探索するよう、<tt>/etc/rc</tt> を更新してください。
</li>
<li> <tt>mv /etc/sendmail.cf /etc/mail/sendmail.cf</tt> <br />
     これが最小限必要な操作であり、他のすべてのファイルの場所は
     変更する必要はないはずです。
</li>
<li> または、.mc のソースファイルから新しい .cf ファイルを構築してください。
     make によって含められるので、最早
     <pre>include(`../m4/cf.m4')</pre>
     という行を指定する必要がないことに注意してください。また、LOCAL_CONFIG
     のセクション (たとえば、<tt>openbsd-lists.mc</tt> を参照してください)
     に ("Cw machinename" で) クラス w にマシンを追加する必要がある
     ということにも注意が必要が必要です。
</li>
</ol>

<a name="2.6.7"></a>
<h3>
2.6.7: アップグレード後、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=apm&amp;sektion=8&amp;arch=i386">apm(8)</a>
サポートを含むカーネルがブートしなくなりました
</h3>

<p>
ブートブロックを更新する必要があります。詳細は、
OpenBSD FAQ の <a href="faq14.html#14.8">14.8 章</a>
を参照してください。
</p>

<a name="2.6.8"></a>
<h3>
2.6.8: <em>daemon</em> ユーザのデフォルトのグループが変更されました
</h3>

<p><em>daemon</em> のユーザのデフォルトのグループが 31 から 1 に変更されました。
daemon ユーザが以下の例のように見えるようにするためには vipw を使用してください。
<p><tt>daemon:*:1:1::0:0:The devil himself:/root:/sbin/nologin</tt>
</p>

<a name="2.5"></a>
<h2>2.5 からのアップグレード</h2>

<a name="2.5.1"></a>
<h3>
2.5.1: 2.5 から 2.6 へのアップグレードでの大きな問題は何でしょう ?
</h3>

<h5><em>perl</em> と <em>make</em></h5>
<p>
最新版の Perl (5.005_03) を正しくコンパイルするためには、
新しいバージョンの <em>make</em> が必要です。新しい Perl
をビルドする前に make を再構築するため、以下を実行してください。
</p>

<pre>
# cd /usr/src/usr.bin/make
# make clean &amp;&amp; make &amp;&amp; make install
</pre>

<p>
この後、Perl の再構築を実行してください。この再構築の前に、Perl の
<code>obj</code> ディレクトリのクリーンアップを手動で実行してください。
</p>

<p>
Perl の開発者の方は、millert@openbsd.org からの、以下の
最新の変更の注意事項に目を通しておいてください。
</p>

<pre>
OpenBSD (2.5 以降) のソースツリー中の Perl のバージョンは 5.005_03
にアップグレードされました。ビルド方法が一部変更されましたが、
そのほとんどは目に見えるものではありません。ユーザに影響のある
重要な変更点は以下のようなものです。

1) Perl のライブラリファイルが /usr/lib/perl5 から、より正確な
/usr/libdata/perl5 に移動されました。
2) デフォルトの site_perl ディレクトリは /usr/local に存在します。
たとえば、Perl モジュールをインストールする場合、それは
/usr/local/libdata/perl5/site_lib にインストールされるようになりました。これにより、
non-stock モジュールが何なのかを見るのが簡単になりました。これはまた、ports
システム中に Perl モジュールをより簡単に持たせることができるということも意味します。
3) Perl ライブラリの man ページは /usr/share/man/cat3p にインストールされるようになりました。
この効果を得るためには、システムの man.conf を src/etc/man.conf
に基づいて変更する必要があります。これは、"man 3p less" を実行して
less プラグマの情報を取得でき、なおかつ "man less" で less ページャの
man ページも取得できるということを意味しています。

もし、既存のモジュールや他の non-stock Perl ファイルがある場合に、最も簡単にできることは、
/usr/lib/perl5 を /usr/libdata/perl5 に移動し、/usr/lib/perl5 から /usr/libdata/perl5
に対してシンボリックリンクを張ることです。それ以外の方法としては、インストールされた
Config.pm ファイルを編集し、そのパスを修正することでしょう。

</pre>

<h5>コンパイラの変更: <em>egcs</em> で <em>gcc</em> を置換</h5>
<p>
この変更は、今までで最も大きな変更であると思われるものです。これに関する
詳細の手順については、<a href="#2.5.2">2.5.2 章</a>を参照してください。
</p>

<h5>カーネル構造体 - <em>statfs</em> - の変更</h5>
<p>
<tt>statfs</tt> 構造体が 5 月 31 日に変更されました。<em>make build</em>
を実行しようとする前に、カーネルを再構築する必要があります。
詳細は、<a href="#2.5.3">2.5.3</a> を参照してください。
</p>

<a name="2.5.2"></a>
<h3>
2.5.2: <em>gcc</em> から <em>egcs</em> へのアップグレードはどのように行うのでしょう ?
</h3>

<p>
最も安全な方法は、これが利用可能な最近の snapshot にアップグレードすることでしょう。
<strong>まずは、snapshot を見てください !</strong>  古いコンパイラを使用して
新しいコンパイラのブートストラップを行うのは<em>最後の手段</em>と言って良いでしょう。
</p>

<p>
まず、いくつかのプラットフォームでは、まだブートストラップに成功していない
ということに注意してください。現時点では、注意深く実行すれば、
以下のプラットフォームで動作することがわかっています。
</p>

<ul>
<li><strong>i386</strong>
<li><strong>sparc</strong>
<li><strong>m68k</strong>
<li><strong>alpha</strong>
</ul>

<p>
<strong>mips</strong> と <strong>rs6000</strong> には問題があります。
</p>

<p>
あなたのプラットフォームがブートストラップ可能かどうか、
<a href="../../ja/ports.html">ports コレクション</a> から
egcs-snapshot を取得してインストールしてみてください。
もし、これが動作すれば、ツリー中のバージョンも同様に動作するでしょう。
これがこの処理の<em>最も安全な</em>方法です。
</p>

<p>
今ここで、これ以上先に進む前に、手許の <em>binutils</em>、<em>gas</em>
および <em>ld</em> が最新版であることを確認してください。ツリー中には、
<em>gas</em> と <em>ld</em> が 2 バージョンあることに注意してください。
<strong>i386</strong> と <strong>sparc</strong> では、binutils の
バージョンは使用されません。代わりに <tt>/usr/src/gnu/usr.bin/gas</tt>
と <tt>/usr/src/gnu/usr.bin/ld</tt> とをチェックしてください。
</p>

<p>
以下の手順は、オリジナルの egcs の snapshot (egcs-990517) に適用されたものです。
それ以降に、二番目の snapshot (egcs-990608) がツリーにマージされました。
もし、基本の 2.5 を使用している場合、最新バージョンを直接ビルドできる可能性は
まずないでしょう。このような場合、これらの手順に従って、中間バージョンの
ブートストラップを行わなければなりません。
</p>

<p>
以下は espie@openbsd.org からのメッセージです。
</p>

<blockquote>
<pre>
本日、コンパイラが変更されました。

gcc 2.8.1 をやめて egcs... もっと正確に言うなら gcc 2.95 のプリリリース版に移行します。

これは、おそらく試練になるでしょうが、私は、私自身による各アーキテクチャごとの
すべての微調整に対する作業を続けることができなくなりました。

私は、まさに *今* から導入作業を開始します。作業が落ち着いた時点で、
2 通目のメッセージを tech@ に投稿するつもりです。

私の整理を手伝ってくれた皆さん、特に niklas、turan そして millert
に感謝します。

なぜ切り替えるのか
------------------
皆さんのほとんどが御存知のように、現在、egcs が FSF のサポートする公式の
コンパイラとなりました。来たる 7 月のリリースは gcc 2.95 と名付けられました。

ログメッセージを見てみますと、新しいプロセッサのサポートの改善、
C++ のより厳密な ANSI/ISO 標準への適合、Fortran 77 のより緊密な統合
など、多くの改善が行われていることがわかります。
さらに、無数のバグ修正やコード生成の改善も行われています。

また、開発はよりオープンに行われています。CVS ツリーやいくつかのメーリングリスト
が利用可能で、私たちはより緊密に egcs のチームと共同作業を行うことができました。
さらに厳密に言えば、私は、OpenBSD の設定が公式にサポートされるよう、パッチを
egcs のチームにフィードバックしてきました。
また、開発チームは、バグレポートに非常に敏感に反応しており、問題点を
修正してきました。

また、バンドワゴン現象というのもあります。皆さんが egcs に移行するということは、
多数のコードがコンパイラのテストを行うことを意味し、それによって、
関連プロジェクトからの利益を亨受することができるということでもあるのです。

なぜ今なのか
------------
egcs-1.1 はある種の目的には適合しませんでした。特に、i386 のコードサイズは
gcc 2.8.1 より大きく、フロッピーディスク関連の問題になっていました。
2.5 がフリーズされた時点で、含めることのできる唯一のコードは、どこか不安定な
snapshot しかありませんでした。安定性の問題について悩み抜いたあげく、egcs は
2.5 には入れないことにしました。

そして今、egcs プロジェクトは egcs 1.2 をリリースするサイクルに入っています。
彼らのタイムスケジュールから判断して、egcs 1.2 と OpenBSD の次期リリースとの
間には十分な余裕があります。また、あまり多くは使用されていないアーキテクチャ上で
問題を報告する機会がが欲しいことや、1.2 の問題のすべてが修正されたものが欲しいので、
今、これを取り込みたいと考えたのです。

egcs の `将来のフリーズ' は 5 月 7 日に予定されており、また、現状の snapshot の
19990502 版は問題なさそうに見えます。

何が動いて何が動かないのか
--------------------------
egcs は i386 で OpenBSD を何の問題もなく実行させることができます。m68k でも同様ですが、
いずれは修正しなければならない、よくわからないバグに関するわずかな回避策が施されています。
sparc でも同様に動作しているように見えます。次の私たちのリリースまでには修正しなければ
ならない、リンカの問題がいくつかの他のアーキテクチャ上で見つかっています。

現状では、ダイナミックライブラリにまたがるコンストラクタは、すぐには用意されません。

egcs は、現時点では、現在、私たちが使用中のハッカーっぽい解決策より優れた
単独の cpp を特徴としています。これは、一部のインターフェイスが変更され、
ちょっと変った警告が出力される可能性のあることを意味しています。

gcc 2.8.1 を維持すべきか ?
--------------------------
サイズの制約のため、egcs を導入でき次第、gcc は CVS の Attic
に移動されます。もし、今は egcs を使用したくない場合には、
CVS の update を慎重に実行する必要があるでしょう。
includes、gnu/usr.bin や gnu/lib などの、いくつかの Makefile は変更されます。
また、xlint や cpp.sh もまた同様に変更されます。

どのようにしてコンパイラのブートストラップを実行するのか
--------------------------------------------------------
最も簡単な方法は、おそらく、各アーキテクチャのメンテナを信じて、
snapshot をダウンロードすることでしょう。

もし、難しい方法を選択する場合には、最初に obj ディレクトリを
正しく再作成する必要があります。
cd /usr/src
make obj

i386 で実行しているのでしたら、gas が更新されていなければなりません。
sparc で実行しているのでしたら、ld が更新されていなければなりません。

その後、次のようにして libiberty をビルドしてください。
cd /usr/src/gnu/egcs/libiberty
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

そして C コンパイラをビルドしてください。
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

C コンパイラを新しいバージョンを使用して再構築してください。
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

include ファイルを再構築します。
cd /usr/src/include
make includes

すべての egcs ライブラリをビルドし、それらをインストールしてください。
cd /usr/src/gnu/egcs
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper 
make -f Makefile.bsd-wrapper install

そして、新しい cpp ドライバをインストールします。
cd /usr/src/usr.bin/cpp
make install

これですべての処理が終了しましたので、標準の make build を実行できるようになったはずです。
</pre>


<p>
[もうひとつの注意: 実際に、これが正しく動作しなければ、xlint はビルドに失敗するでしょう。
しかし、その修正は簡単です。<em>make build</em> を実行しようとする前に、
<code>/usr/src/usr.bin/xlint/xlint</code> ディレクトリ中で、
単に、<code> make &amp;&amp; make install </code> を実行します。
詳しくは、<a href="#2.5.2.2">2.5.2.2</a> を参照してください。]
</p>

<pre>
もし、これがうまく行かなければ、まだ make build を実行していない arch を使用しているのでしょう。
最も発生する可能性の高いのは、ICE として知られる Internal Compiler Error (内部コンパイラエラー)
でしょう。

まず、-O1 か -O0 で ICE が消えるかどうかを見てみてください。その場合、
これが修正されるまでの間、Makefile に回避策を講じることができます
(m68k 用に、このような回避策をどのように講じるかの例は、
/usr/src/lib/libm/Makefile を参照してください)。

そして、そのエラーは、egcs-bugs メーリングリストに報告されなければなりません。

最低限、オプションとして -v -save-temps を加えた上で、同じコンパイラを呼び出して
ソースをコンパイルする必要があります。

-v は gcc によって呼び出されるコマンドの正確なシーケンスを表示し、-save-temps は、egcs の人びとは、
彼らのマシン上で OpenBSD を実行してもらえるかどうかをあなたがお願いできないということの意味を
理解しているので、プリプロセッサを通した後の C のファイル (.i) や C++ (.li) を生成します。

時間的な余裕があるなら、バグの発生原因となる可能性を最小限にするために、プリプロセッサを通した
C ファイルをスリム化するよう試行錯誤することができます。また、二分法はうまく動作します。
</pre>
</blockquote>

<p>
もし、この手順どおりに実行した場合、そしてすべてが動作している場合は、おめでとうございます。
成功です。しかし、もしそうでなければ、以下の章を参考にしてチェックし直してください。また、
ここにリストアップされていない問題があれば、tech@openbsd.org に投稿してください。
</p>

<a name="2.5.2.1"></a>
<h5>
2.5.2.1 - <tt>i386</tt> および <tt>sparc</tt> は、
最早 <tt>#define</tt> されていません。
</h5>

<p>
これは本当です。<em>egcs</em> は、よりクリーンな <tt>__i386__</tt> および
<tt>__sparc__</tt> を使用します。古い定義に依存するコードをコンパイルする必要が
ある場合には、Makefile 中の適正な位置に <tt>-Dsparc</tt> や <tt>-Di386</tt>
を追加してください。
</p>

<a name="2.5.2.2"></a>
<h5>
2.5.2.2 - xlint で Build が失敗します。
</h5>

<p>
これは、cpp のセマンティクスの違いによるものです。その回避策は単純で、
<a href="#2.4.2">2.4.2</a> に記述された <em>cap_mkdb</em> の問題と同様です。
</p>

<p>
以下を実行してください。
</p>

<pre>
# cd /usr/src/usr.bin/xlint/xlint
# make &amp;&amp; make install
</pre>

<p>
これで、make を再実行し、ビルドを継続することができます。
</p>

<a name="2.5.2.3"></a>
<h5>
2.5.2.3 - <tt>uthread_autoinit.c</tt> で core ダンプします。
</h5>

<p>
リンカのバグの犠牲になってしまったようですね。以下は、それに関係のあるメッセージです。
</p>

<pre>
From: Marc Espie &lt;Marc.Espie@liafa.jussieu.fr&gt;
Subject: uthread_autoinit.c で egcs がコアダンプ

もし、あなたのところでこれが発生した場合、これはよく知られたリンカの問題で、
あなたの cc1 が変にリンクされてしまっているせいでしょう。

最初に、私はこの問題を回避するため、cc1 をスタティックな /usr/lib/libiberty.a
に対してリンクしましたが、これは問題を切り取り過ぎていて、バグが再現してしまったので、
おそらく libc か他の部分の関係のない変更に感謝すべきなのかも知れません。

ソースツリーは、以下のファイルについての回避策とともにパッチが当たっていますので、

src/gnu/egcs/f/lang-options.h

この回避策の適用済バージョンのファイル (少なくとも rev 1.2 はそうです)
があることを確認して、cc1 を再コンパイルして再インストールすれば、この問題は解消します。

ここで発生したことは、toplev.c の中の巨大な文字配列のためと、
何かが間違ってリンクされてしまったことにより、
i386 のリンカがおかしくなってしまったためで、
void f(void) __attribute((constructor)) {}
が cc1 を kill してしまうからなのです。

回避策として、誰かがリンカのエラーがどこなのかを発見するまでは、私は
ヘルプの文章の中の Fortran のオプションを除去することにしました。 
</pre>

<a name="2.5.2.4"></a>
<h5>
2.5.2.4 - <em>egcs</em> は <em>gcc</em> よりずっと遅いようなのですが... 
</h5>

<p>
そのとおりかも知れませんが、これには理由があります。<em>egcs</em> はより多くの最適化パスを実行します。
これにより、<em>egcs</em> の生成したコードのデータのアライメントやその他の機能性などが 
より良くなっているはずです。
</p>

<a name="2.5.2.5"></a>
<h5>
2.5.2.5 - <em>egcs</em> は <em>gcc</em> より大きなコードを生成するようですが...
</h5>

<p>
そのとおりです。これは特に、古い gcc のスイッチ <tt>-O2</tt> で注意すべきことと
なっています。このため、<em>egcs</em> では、サイズの最適化を行うための新しいオプション
<tt>-Os</tt> が導入されています。これは、大まかに言って、古い <tt>-O2</tt> の挙動と
互換性があります。
</p>

<a name="2.5.2.6"></a>
<h5>
2.5.2.6 - <em>egcs</em> をインストールしたら、非常に小さなディスク空間しか残っていません。
</h5>

<p>
<em>egcs</em> は gcc 2.8.1 とは異なるサブディレクトリにインストールされます。egcs
がいったんブートストラップに成功し、動作するようになれば、<em>gcc</em> を消去しても構いません。
</p>

<p>
関連する注意事項として、<a href="#2.5.1">2.5.1</a> に記述された Perl の変更は、
<tt>/usr/lib/perl5</tt> ディレクトリが消去できるということを意味します。
このデータの新しい位置は <tt>/usr/libdata/perl5</tt> です。
</p>

<a name="2.5.2.7"></a>
<h5>
2.5.2.7 - ビルドで libcurses の構築に失敗します。
</h5>

<p>
<em>libcurses</em> は、現時点では <em>cpp</em> の最新バージョンに依存しています。
最新バージョンの <em>cpp</em> を取得して、以下のようにして継続してください。
</p>
<pre>
# cd /usr/src/usr.bin/cpp &amp;&amp; make install
</pre>

<p>そして、もう一度、 make build を実行してみてください。</p>

<a name="2.5.2.8"></a>
<h5>
2.5.2.8 - make obj が失敗します。
</h5>

<p>
もし、たとえば、以下の例のように Makefile 中のエラーが理由で <em>make obj</em>
が失敗する場合には、Makefile の include が古いものと考えられます。
</p>

<pre>
===&gt; lib/libkvm
"Makefile", line 30: Malformed conditional ((${UVM} == "yes"))
"Makefile", line 30: Missing dependency operator
"Makefile", line 32: if-less endif
"Makefile", line 32: Need an operator
Fatal errors encountered -- cannot continue

</pre>

<p>
これは、Makefile の include を再構築することで解決することができます。以下を実行してください。
</p>

<pre>
cd /usr/src/share/mk &amp;&amp; make install
</pre>

<p>
そして、もう一度、ビルドを実行してみてください。
</p>

<a name="2.5.3"></a>
<h3>
2.5.3: <em>make build</em> が <em>unimplemented syscall</em> エラーで停止します。
</h3>

<p><strong>短かい回答:</strong> </p>

<p>
カーネル構造体 <tt>statfs</tt> が変更されました。<em>make build</em>
を実行しようとする前に、カーネルを再構築する必要があります。
</p>

<p><strong>長い回答:</strong> </p>

<p>
カーネル構造体 <tt>statfs</tt> が変更されました。
新しい <tt>struct statfs</tt> は以下のような機能を持ちます。
</p>

<ul>
<li> <tt>u_int32_t</tt> フラグフィールドを持っています -- softdep が実際のフラグを持つことができるようになりました。
</li>

<li> long の代わりに <tt>u_int32_t</tt> を使用します (alpha 上でより良くなっています)。  
注: マニュアルページには、不正な/使用していないフィールドを -1 にセットするという嘘が記載されていました。
確かに、SunOS ではそのようになっていますが、私たちのコードでは決してそのようなことはありません。
</li>

<li> <tt>f_type</tt> を完全に除去しました。これは、NetBSD 0.9 から使用されていないもので、
それが存在しているのに常に 0 であるということが混乱の元でした。これは、
いくつかの古いコードがコンパイルできない原因になるかも知れないと考えられますが、
それでも黙ってブレークしてしまうよりはまだましでしょう。
</li>

<li> <tt>FSTYPE_args</tt> 構造体を含む <tt>mount_info</tt> 共用体を追加しました。
これは、<em>mount</em> が、マウントされたファイルシステムのすべてのオプションを
表示できるようになったことを意味します。これは、NFS で特にすばらしいものでしょう。
</li>
</ul>

<p>
その他の変更点:
</p>

<ul>
<li> Linux の statfs のエミュレーションは、BSD のファイルシステム名と Linux の <tt>f_type</tt>
の数との間の変換を行いませんでした。BSD の <tt>f_type</tt> の数は Linux アプリケーションにとっては
役に立たないので (そして常に除去されるので)、現在ではこれができるようになりました。
</li>

<li> FreeBSD の struct statfs は私たちのものとは異なり
(古いところも新しいところも両方あります)、変換が必要となっています。
以前は、OpenBSD のシステムコールが実際の変換を行うことはありませんでした。
</li>

<li> <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mount&amp;sektion=8">mount(8)</a>
は、引数なしで呼び出された場合に、特別な情報を表示するようになりました。
しかし、<em>すべての情報</em>を見るためには、-v (verbose) フラグを使用しなければなりません。
</li>
</ul>

<a name="2.5.4"></a>
<h3>
2.5.4: 新しい 2.6 ディレクトリへのリンク
</h3>

<p>
2.6 にアップグレードする場合には、gcc 用にひとつの単純なリンクを生成する必要があります。
</p>

<pre>
   cd /usr/lib/gcc-lib
   ln -s ${ARCH}-unknown-openbsd2.5 ${ARCH}-unknown-openbsd2.6
</pre>

<a name="2.5.5"></a>
<h3>
2.5.5: <strong>(U)</strong>pgrade を選択後の、<em>base26.tar.gz</em>
の展開が失敗します。
</h3>

<p>
<em>tar: Unable to remove directory ./usr/include/machine &lt;Directory
not empty&gt;
</em>
</p>

<p>2.5 では、<tt>/usr/include/machine</tt> がディレクトリであり、
<tt>/usr/include/i386</tt> はそれに対するリンクでした。 2.6 では、
この状況は反転しています。
</p>

<p>
問題を訂正するため、シェルにエスケープして <tt>/usr/include/machine</tt> を削除してから、アップグレードを再実行してください。
</p>


<a name="2.4"></a>
<h2>2.4 からのアップグレード</h2>

<a name="2.4.1"></a>
<h3>2.4.1: Man ページの変更</h3>
<p>
いくつかのマニュアルページがセクション 1 から後のセクションに移されました。
不運にも、古いマニュアルページがセクション 1 に残っていると、注意深くない
ユーザは最新バージョンのページを見ないことになってしまいます。
</p>

<p>
以下のページを削除すべきです。
</p>
<pre>
/usr/share/man/cat1/ipf.0
/usr/share/man/cat1/ipnat.0
/usr/share/man/cat1/ipsecadm.0
</pre>

<a name="2.4.2"></a>
<h3>2.4.2: <em>cap_mkdb</em> のシンタクスの変更</h3>

<p>
<strong>現象:</strong>
</p>

<p>
<em>make build</em> で、以下のようなエラーが発生します。
</p>

<pre>
cap_mkdb -i -f terminfo terminfo.src
cap_mkdb: illegal option -- i
usage: cap_mkdb [-v] [-f outfile] file1 [file2 ...]
*** Error code 1
</pre>

<p>
<strong>修正:</strong>
</p>

<p>
<em>cap_mkdb</em> を呼び出す際のシンタクスが少し変更されました。
<em>make build</em> を実行する前に、cap_mkdb を最新のソースから
再構築してください。
</p>

<pre>
# cd /usr/src/usr.bin/cap_mkdb
# make clean &amp;&amp; make &amp;&amp; make install
</pre>

<p>
これで、問題なく make build を実行できるようになります。
</p>


<a name="2.4.3"></a>
<h3>2.4.3: Snake</h3>
<p>
<code>/usr/src/games/snake</code> をアップグレードする前に、obj
ディレクトリの内容を消去する必要があります。
</p>
 
<a name="2.3"></a>
<h2>2.3 からのアップグレード</h2>

<a name="2.3.1"></a>
<h3>
2.3.1: 新しいユーザ: <em>named</em>
</h3>

<p>
2.3 以後、DNS デーモンの <em>named</em> が chroot されるようになりました。
この変更を可能にするため、ユーザ <em>named</em> が作成されました。
まだ、このユーザを作成していない場合には、ビルドの処理中にすべてのディレクトリが
正常に作成されることを確実にするため、このユーザを作成しておく必要があります。
</p>

<p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a> を使用して、/etc/passwd に以下のエントリを追加してください。
</p>

<pre>
named:*:70:70::0:0:BIND Daemon:/var/named:/sbin/nologin
</pre>

<p>
また、以下のグループも /etc/group に追加します。
</p>

<pre>
named:*:70:
</pre>


<a name="2.3.2"></a>
<h3>
2.3.2: 構築しようとすると、<em>ssleay</em> をビルドしようとして
失敗します。</em>.
</h3>

<p>
パスワードファイルに <em>named</em> ユーザのエントリを
作成していないようですね。
</p>

<p>
<strong>短かい回答:</strong>
</p>

<p>
ビルドの前にこのユーザを作成してください。
</p>

<p>
<strong>長い回答:</strong>
</p>

<p>
<em>named</em> ユーザは、パーミッションを正しく設定するために必要です。
ですので、このユーザがない場合には、ビルドの処理の一部が失敗します。
もし、(<em>make build &amp;&gt;/tmp/build.log</em> のようにして) ビルドの処理を
ファイルにキャプチャしている場合には、以下のような注意のメッセージが記録されています。
</p>

<pre>
(cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs)
install -d -o root -g wheel -m 755 /
mtree -def mtree/4.4BSD.dist -p // -u

mtree: unknown user named
mtree: failed at line 1632 of the specification
*** Error code 1 (ignored)
</pre>

<p>
私たちにとって不幸なのは、ビルドがそのまま継続されてしまうことで、
最終的にエラーが発生したという事実が無視されてしまうことでしょう。
</p>

<p>
<em>named</em> ユーザが存在している場合には、mtree が正常に動作します。
</p>

<pre>
missing: ./var/named (created)
missing: ./var/named/dev (created)
missing: ./var/named/etc (created)
missing: ./etc/afs (created)
missing: ./etc/ssl (created)
missing: ./etc/ssl/private (created)
missing: ./usr/obj (not created: File exists)
missing: ./usr/share/doc/html (created)
missing: ./usr/share/doc/html/lynx_help (created)
missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
missing: ./usr/share/doc/usd/13.viref (created)
missing: ./usr/share/man/cat4/powerpc (created)
missing: ./usr/share/man/man4/alpha (created)
missing: ./usr/share/man/man4/pmax (created)
missing: ./usr/share/man/man4/powerpc (created)
missing: ./usr/share/tmac/mdoc (created)
missing: ./var/www/htdocs/manual/vhosts (created)
missing: ./usr/include/ssl (created)
</pre>

<p>
ここで、この失敗の理由は、<em>/usr/include/ssl</em> ディレクトリが
決して作成されないことです。そして、ヘッダファイルがないので、
<em>ssleay</em> のビルドが失敗するのです。
</p>

<p>
<strong>修正:</strong>
</p>

<p>
<em>named</em> ユーザ/グループを作成してください。そして、<em>/usr/include/ssl</em>、
<em>/var/named</em>、および <em>make build</em> によって間違って通常ファイルとして
作成されてしまった、上記のリストの他のディレクトリをすべて削除してください。
</p>


<a name="2.3.3"></a>
<h3>
2.3.3: 構築しようとすると、PowerPC 用の何かを
make しようとして失敗します。
</h3>

<p>
ディレクトリツリーが不完全です。特に、
<tt>/usr/share/man/cat4/powerpc</tt> ディレクトリがありません。
</p>

<p>
<strong>簡単な修正:</strong>
</p>

<p>
このディレクトリを作成し、コンパイルを継続してください。
</p>

<p>
<strong>完全な修正:</strong>
</p>

<p>
全体のディレクトリツリーを作成します。以下を実行してください。
</p>

<pre>
# cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs
</pre>

<p>
これにより、以下のような出力を目にするはずです。
</p>

<pre>
install -d -o root -g wheel -m 755 /
mtree -def mtree/4.4BSD.dist -p // -u

missing: ./var/named (created)
missing: ./var/named/dev (created)
missing: ./var/named/etc (created)
missing: ./etc/afs (created)
missing: ./etc/ssl (created)
missing: ./etc/ssl/private (created)
missing: ./usr/obj (not created: File exists)
missing: ./usr/share/doc/html (created)
missing: ./usr/share/doc/html/lynx_help (created)
missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
missing: ./usr/share/doc/usd/13.viref (created)
missing: ./usr/share/man/cat4/powerpc (created)
missing: ./usr/share/man/man4/alpha (created)
missing: ./usr/share/man/man4/pmax (created)
missing: ./usr/share/man/man4/powerpc (created)
missing: ./usr/share/tmac/mdoc (created)
missing: ./var/www/htdocs/manual/vhosts (created)
missing: ./usr/include/ssl (created)
</pre>

<p>
usr/share/man/cat4/powerpc は、この処理によって作成されるディレクトリのひとつであるということに注意してください。
</p>



<p>
--
</p>
<address>
<p>
Originally [OpenBSD: upgrade-old.html,v 1.9 ]
<br>
$Translation: upgrade-old.html,v 1.1 2004/04/13 11:21:06 toshi Exp $
<br>
$OpenBSD: upgrade-old.html,v 1.2 2004/05/09 09:58:22 saad Exp $
<br />
Copyright &copy; 1998-2003, Kjell Wooding. 
<br />
どのような御質問、御指摘、コメントでも
<a href="mailto:kjell@openbsd.org">kjell@openbsd.org</a> にお送りください。
</p>
</address>

</body>
</html>
