<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>5 - Building the system from Source</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998-2003 by OpenBSD.">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
</head>

<body bgcolor= "#ffffff" text= "#000000">
<!-- Passes validator.w3.org.  Please keep it this way -->

<img alt="[OpenBSD]" height=30 width=141 src="../images/smalltitle.gif">
<p>
<h2><font color="#e00000">5 - Building the system from Source</font></h2>
<hr>

<p>
<h3>Table of Contents</h3>
<ul>
<li><a href= "#Flavors">5.1 - OpenBSD's Flavors</a>
<li><a href= "#Why">5.2 - Why do I need a custom kernel?</a>
<li><a href= "#Options">5.3 - Kernel configuration Options</a>
<li><a href= "#Building">5.4 - Building your own kernel</a>
<li><a href= "#BootConfig">5.5 - Boot-time configuration</a>
<li><a href= "#VerboseBoot">5.6 - Getting more verbose output during
  boot</a>
<li><a href= "#config">5.7 - Using config(8) to change your kernel
  binary</a>
</ul>
<hr>
<br>


<a name="Flavors"></a>
<h2>5.1 - OpenBSD's Flavors</h2>

There are three "flavors" of OpenBSD:
<ul>
<li><b>-release:</b> The version of OpenBSD shipped every six months on CD.
<li><b>-stable:</b>  Release, plus patches considered critical to security
    and reliability.
<li><b>-current:</b> The to-the-moment version of OpenBSD, which will 
    turn into the next release.
</ul>

Graphically, the development of these flavors looks something like
this:

<blockquote>
<pre>
       ,------o-----------o----X                    2.9 Stable
       |      .           .
       |      .    ,------o---------o----X          3.0 Stable
       |      .    |      .         .
       |      .    |      .    ,----o----------o--&gt; 3.1 Stable
       |      .    |      .    |    .          .
       |      .    |      .    |    .    ,-----o--&gt; 3.2 Stable
       |      .    |      .    |    .    |     .
       |      .    |      .    |    .    |     .
 --&gt;2.9Rel-----&gt;3.0Rel-----&gt;3.1Rel-----&gt;3.2Rel----&gt; Current 

          Time ---&gt;
</pre>
</blockquote>

<p>
The code tree is branched between <i>-current</i>, <i>-release</i> and
<i>-stable</i> every six months -- <i>-release</i> becomes a frozen point
(a &quot;Tag&quot;) in the history of the source tree - it is never
changed, and is what is on the <a href="../orders.html">CDs</a> and 
<a href="../ftp.html">FTP
servers</a>.  <i>-Current</i> is where active work is done, and turns
into the next <i>-release</i> of OpenBSD.

<p>
The <i>-stable</i> (also known as the "Patch branch") is based on
<i>-release</i>, and as one can see, it is a "branch" from the
development path of OpenBSD.  As important fixes are made to
<i>-current</i>, they are "back ported" into the <i>-stable</i>
branches.  In the above illustration, the vertical dotted lines are bug
fixes being incorporated into the <i>-stable</i> branches.  You will
also note that in the above example, the <i>2.9-stable</i> branch came
to an end with <i>3.1-release</i>, and the <i>3.0-stable</i> branch came
to an end with <i>3.2-release</i> -- old releases are typically supported
up to two
releases back.  It takes resources and time to support older versions,
while we might like to provide ongoing support for old releases, we
would rather focus on new features.  The <i>-stable</i> branch is, by
design, very easy to build from <i>-release</i> of the same version
(i.e., going from <i>3.2-release</i> to <i>3.2-stable</i>).

<p>
The <i>-stable</i> branch is <i>-release</i> plus patches found on the
<a href="../errata.html">errata page</a>, and some simple fixes that do
not merit an errata entry.  Usually, the operation of <i>-stable</i> is
the same as the <i>-release</i> it is based on.  If the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi">man pages</a> have to
change, it probably won't go into <i>-stable</i>.  In other words, new
device support will NOT be added to <i>-stable</i>, and new feature
support will rarely be added unless it is considered very important. 

<p>
Warning: <i>-current</i> is a moving target.  It changes almost minute 
by minute,
and may well change several times in the time it takes to retrieve the
source code.  As indicated earlier, there is no promise that the system
compiles or that it works (of course, the hope is it does).  It is
entirely possible and not uncommon to get the <i>-current</i> source and
have it fail to compile, whereas five minutes later, it may work just
fine.  <b>If you are not prepared to deal with this, stay away from
<i>-current</i>.</b>

<p>
Most users should be running either <i>-stable</i> or <i>-release</i>.
That being said, many people do run <i>-current</i> on production
systems, and it is important that some people do so to identify bugs and
test new features.  However, if you don't know how to properly describe,
diagnose and deal with a problem, don't tell yourself (or anyone else)
that you are "helping the project" by running <i>-current</i>.  "It
didn't work!" is not a <a href="../report.html#bugtypes">useful bug
report.</a>.  "The recent changes to the pciide driver broke
compatibility with my Slugchip-based IDE interface, dmesg of working and
broken systems follow..." might be a useful report.

<p>
There are times where "normal" users may wish to live on the cutting
edge and run <i>-current</i>. The most common reason is when the user 
has a device
which is not supported by <i>-release</i> (and thus, not <i>-stable</i>),
or wishes to use a new feature of the <i>-current</i>.  In this case, the
choice may be either <i>-current</i> or not using the device, and
<i>-current</i> may be the lesser evil.  However, one should not expect
hand-holding from the developers.

<h3>Snapshots</h3>
Between formal releases of OpenBSD, <i>snapshots</i> are made available
through the <a href="../ftp.html">FTP sites</a>.  As the name implies,
these are builds of whatever code is in the tree at the instant the
builder grabbed a copy of the code for that particular platform.
Remember, on some platforms, this may be DAYS before the snapshot build
is completed and put out for distribution.  There is no promise that the
snapshots are completely functional, or even install.  Often, a change
that needs to be tested may trigger snapshot creation.  Some
platforms have snapshots built on an almost daily basis, others will be
much less frequent.  If you desire to run <i>-current</i>, a recent
snapshot is often all you need, and upgrading to a snapshot is usually a
good starting point before attempting to build <i>-current</i>.

<p>
It is sometimes asked if there is any way to get a copy of exactly the
code used to build a snapshot.  The answer is no.  First, there is no
significant benefit to this.  Second, the snapshots are built as
desired, as time permits, and as resources become available.  On fast
platforms, one might be able to build several snapshots in a day.  On
slower platforms, it may take a week or more to build a snapshot.
Providing tags or markers in the source tree for each snapshot would be
quite impractical.

<h3>Keeping Things in Sync</h3>
It is important to understand that OpenBSD is an Operating System, 
intended to be taken as a whole, not a kernel with a bunch of utilities
stuck on.  You must make sure your kernel, "userland" (the supporting
utilities and files) and <a href="../ports.html"><tt>ports</tt></a> tree
are all in sync, or unpleasant things will happen.  Said another way
(because people just keep making the error), you can not run brand new
<tt>ports</tt> on a month old system, or rebuild a kernel from <i>-current</i>
source and expect it to work with a <i>-release</i> userland.  Yes,
this does mean you need to update your system if you want to run a new 
program which was added to the ports tree today.  Sorry,
but again, OpenBSD has limited resources available.

<p>
One should also understand that when 
<a href="upgrade-minifaq.html">upgrading by source</a>, the update
process is supported in <b>only one direction: from older to newer</b>,
and from <i>-stable</i> to <i>-current</i>.  You can not run
<i>3.2-current</i> (or a snapshot), then decide you are living too
dangerously, and step back to <i>3.2-stable</i>.  You are on your own if
you choose any path other than the supported option of reloading your
system from scratch, do not expect assistance from the OpenBSD
development team.

<p>
Yes, this does mean you should think long and hard before committing
yourself to using <i>-current</i>.


<p>
<a name= "Why"></a>
<a name= "5.1"></a>
<h2>5.2 - Why would I want to create my own custom kernel?</h2>

<p>
Several reasons, although this practice is generally geared towards
knowledgeable users who have a good overall understanding of the system.

<ul>
  <li>Your computer has a very small amount of RAM and you want to preserve 
      as much as possible by removing device drivers you don't use
  <li>You wish to remove default options or add options which may not
      have been enabled by default
  <li>You wish to enable experimental options
    
</ul>

<p>
Under most circumstances you will NOT need to compile your own kernel.
The GENERIC kernel will usually be all that you need.  In fact, there
are several reasons why you do not want to create your own kernel.  The
main reason is that it is very easy to make changes to the kernel
configuration which look logical, but do not work.  This is your danger
sign.  If something does not appear to work properly, please try the
GENERIC kernel before sending in a bug report. Developers will
usually ignore bug reports dealing with custom kernels, unless the
problem can be reproduced in a GENERIC kernel as well. You have been
warned.

<p>
<a name= "Options"></a>
<a name= "5.2"></a>
<h2>5.3 - Kernel Configuration Options</h2>

<p>
Kernel Configuration Options are options that you add to your kernel
configuration that place certain features into your kernel. This allows
you to have exactly the support you want, without having support for
unneeded devices. There are a multitude of options that allow you to
customize your kernel. Here we will go over only some of them, those that
are most commonly used. Check the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&amp;sektion=4">options(4)</a>
man page for a more complete list of options. You can also check the
example configuration files that are available for your architecture.

<p>
Not all kernel options have been tested for compatibility with
all other options.  Don't put an option in your kernel unless you
actually have a reason to do so!  The one kernel configuration which
gets the most testing is the GENERIC kernel.  This is usually a
combination of the options in 
<tt>/usr/src/sys/arch/`arch -s`/conf/GENERIC</tt>
and <tt>/usr/src/sys/conf/GENERIC</tt>. 

<p>
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/alpha/conf/">Alpha Kernel Conf Files </a>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/i386/conf/">i386 Kernel Configuration files</a>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/macppc/conf/">macppc Kernel Configuration files</a>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/sparc/conf/">sparc Kernel Configuration Files</a>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/sparc64/conf/">sparc64 Kernel Configuration Files</a>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/vax/conf/">vax Kernel Configuration Files</a>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/">Other Arch's</a>
</ul>

<p>
Look closely at these files and you will notice a line like:<br>
<strong>include "../../../conf/GENERIC"</strong><br>
This means that it is referencing yet another configuration file. This
file stores non arch-dependent options. So when creating your Kernel
Config be sure to look through 
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/conf/GENERIC">/sys/conf/GENERIC</a> 
and see what you want. There <b>are</b> options in there that are
<b>necessary</b>.

<p>
All of the options listed below should be placed in your kernel
configuration file in the format of:<br>
<strong>option      OPTION</strong><br>
for example. To place option debug in the kernel, add a line like this:<br>
<strong>option	    DEBUG</strong><br>
Options in the OpenBSD kernel are translated into compiler preprocessor
options, therefore an option like DEBUG would have the source compiled
with option -DDEBUG. Which is equivalent to doing a #define DEBUG
throughout the kernel.

<p>
OpenBSD has many compatibility options which allow you to use
binaries from other OS's.  Not all are availably on every architecture,
so be sure to read the man pages for each option to see if your arch is
supported.

<p>
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_svr4&amp;sektion=8">COMPAT_SVR4(8)</a> 
  - Compatibility with SVR4 binaries.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_bsdos&amp;sektion=8">COMPAT_BSDOS(8)</a> 
  - Compatibility with BSD/OS binaries.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_linux&amp;sektion=8">COMPAT_LINUX(8)</a> 
  - Compatibility with Linux binaries.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_sunos&amp;sektion=8">COMPAT_SUNOS(8)</a> 
  - Compatibility with SunOS binaries.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ultrix&amp;sektion=8">COMPAT_ULTRIX(8)</a> 
  - Compatibility with Ultrix binaries.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_freebsd&amp;sektion=8">COMPAT_FREEBSD(8)</a> 
  - Compatibility with FreeBSD binaries.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_hpux&amp;sektion=8">COMPAT_HPUX(8)</a> 
  - Compatibility with HP-UX binaries. Only available on some m68k
  arch's.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ibcs2&amp;sektion=8">COMPAT_IBCS2(8)</a> 
  - Compatibility to run ibcs2 binaries.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_osf1&amp;sektion=8">COMPAT_OSF1(8)</a> 
  - Run Digital Unix binaries. Available only on Alpha platform.
<li>COMPAT_43 
  - Compatibility with 4.3BSD. Use of this is discouraged, but
  it is needed for some applications. 
<li>COMPAT_11 
  - Compatibility with NetBSD 1.1.
<li>COMPAT_NOMID 
 - Compatibility with a.out executables that lack a machine id.
</ul>

<p>
It is always helpful to be able to debug problems with the kernel. But
many choose not to put these options in their kernel because these
options add considerable size to the kernel. They are however extremely
helpful in a case where a bug might be present. This will help the
developers discover the source of your problems much quicker. Here is a
list of popular debugging options that can be added to your kernel.

<p>
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ddb&amp;sektion=4">DDB(4)</a>
  - This compiles in the in-kernel debugger. This isn't available on all
  platforms. So be sure to read before adding it.
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kgdb&amp;sektion=7">KGDB(7)</a>
  - Compiles a remote kernel debugger using gdb's `remote target`
  feature.
<li>makeoptions  DEBUG="-g" - Makes bsd.gdb along with bsd. This is
  useful for debugging crash dumps with gdb.
<li>DEBUG - Used to put various debugging options in the kernel, where
  the source has defined them.
<li>KTRACE - Adds hooks for the system call tracing facility. Which
  allows users to use 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ktrace&amp;sektion=1">ktrace(1)</a>.
<li>DIAGNOSTIC - Adds code to the kernel that does internal consistency
  checks.
<li>GPROF - adds code to the kernel for kernel profiling with 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kgmon&amp;sektion=8">kgmon(8)</a>.
<li>makeoptions PROF="-pg" - The -pg flag causes the kernel to be
  compiled with support for profiling. Option GPROF is required to use
  this option.
</ul>

<p>
<strong>Filesystem Options.</strong>
<ul>
<li>FFS - Berkeley Fast Filesystem <strong>NOTE:</strong> This option is
  required.
<li>EXT2FS - Second Extended File System, This is needed for those of
  you who want to read Linux partitions.
<li>MFS - Memory File System that stores files in swappable memory.
<li>NFS - Network File System, This is needed if you will be using
  NFS.
<li>CD9660 - This is iso9660 + rockridge filesystem. This is required to
  read from CDs.
<li>MSDOSFS - Needed to read MS-DOS FAT filesystems. Also has support
  for Windows 95 long name + mixed case extensions.
<li>FDESC - Includes code for a file system which can be mounted on
  /dev/fd.
<li>KERNFS - Includes code that permits the mounting of a special file
  system (normally mounted on /kern) in which files representing various
  kernel variables and parameters may be found.
<li>NULLFS - Code to have a loopback filesystem. 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mount_null&amp;sektion=8">mount_null(8)</a>
  has more information.
<li>PROCFS - Includes code for a special file system (conventionally
  mounted on /proc).
<li>PORTAL - Includes the (experimental) portal filesystem.  This
  permits interesting tricks like opening TCP sockets by opening files
  in the file system.
<li>UMAPFS - Includes a loopback file system in which user and group ids
  may be remapped -- this can be useful when mounting alien file systems
  with different uids and gids than the local system (eg, remote NFS).
<li>UNION - Includes code for the union file system, which permits
  directories to be mounted on top of each other in such a way that both
  file systems remain visible. This code isn't quite stable yet.
<li>XFS - Add hooks for using a filesystem that is compatible with the
  AFS filesystem. Currently used by the Arla/AFS code.
<li>FFS_SOFTUPDATES - Allows for the use of softupdates. To read more on
  softupdates read the <a href="faq14.html#SoftUpdates">Softupdates
  FAQ</a> section.
<li>NFSSERVER - Allow for the server-side NFS code to be included in the
  kernel.
<li>NFSCLIENT - Allow for the client-side NFS code to be included in the
  kernel.
<li>FIFO - Support for FIFOs. RECOMMENDED.
<li>NVNODE=integer - Where integer is the size of the cache used by the
  name-to-inode translation routines, (a.k.a. the namei() cache, though
  called by many other names in the kernel source).
<li>EXT2FS_SYSTEM_FLAG - This option changes the behavior of the APPEND
  and IMMUTABLE flags for a file on an EXT2FS filesystem. Read 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&amp;sektion=4">options(4)</a>
  for more details.
<li>QUOTA - Support for Filesystem Quota's. To read up on using quotas
  read <a href="faq10.html#Quotas">FAQ 10, Quotas</a>.
</ul>


<strong>Misc. Options</strong>
<ul>
<li>PCIVERBOSE - Make the boot process more verbose for PCI
  peripherals.
<li>EISAVERBOSE - Make the boot process more verbose for EISA
  peripherals.
<li>PCMCIAVERBOSE - Make the boot process more verbose for PCMCIA
  peripherals.
<li>APERTURE - Provide in-kernel support for VGA framebuffer mapping by
  user processes. Needed to run X.
<li>LKM - Support for Loadable Kernel Modules. Not available on all
  arch's. Read 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lkm&amp;sektion=4">lkm(4)</a>
  for more information.
<li>INSECURE - Hardwires the kernel security level to -1. Read 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=init&amp;sektion=8">init(8)</a>
  for more information on kernel security levels.
<li>RAM_DISK_HOOKS - Allows for machine dependent functions to be called
  when the ramdisk driver is configured.
<li>RAM_DISK_IS_ROOT - Forces the ramdisk to be root.
<li>CCDNBUF=integer - Set number of component buffers used by
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ccd&amp;sektion=4">CCD(4)</a>.
  Default is 8. For more on CCD, read the man page, or the
  <a href="faq11.html#ccd">Performance Tuning FAQ
  section</a>.
<li>KMEMSTATS - This makes malloc(9), the kernel memory allocator, keep
  statistics on its use. If option DEBUG is used, this option is
  automatically turned on by config. 
<li>BOOT_CONFIG - Adds support for the -c boot option.
</ul>

<strong>Networking Options</strong><br>
Also check the <a href="faq6.html">Networking FAQ</a> or the 
<a href="faq11.html#Network">Networking Performance Tuning FAQ</a>.
<ul>
<li>GATEWAY - Enables IPFORWARDING and (on most ports) increases the
  size of NMBCLUSTERS.
<li>NMBCLUSTERS=integer - Controls the size mbuf cluster map. 
<li>IPFORWARDING - Enables IP routing behavior.  With this option
  enabled, the machine will forward IP datagrams between its interfaces
  that are destined for other machines.
<li>MROUTING - Includes support for IP multicast routers.
<li>INET - Includes support for the TCP/IP protocol stack. This option
  is REQUIRED.
<li>MCLSHIFT=value - This option is the base-2 logarithm of the size of
  mbuf clusters. Read
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&amp;sektion=4">options(4)</a>
  for more information on this option.
<li>NS - Include support for the Xerox XNS protocol stack.  See 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ns&amp;sektion=4">ns(4)</a>.
<li>ISO,TPIP - Include support for the ubiquitous OSI protocol stack.
  See 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=iso&amp;sektion=4">iso(4)</a>
  for more information.
<li>EON - Include support for OSI tunneling over IP.
<li>CCITT,LLC,HDLC - Include support for the X.25 protocol stack.
<li>IPX, IPXIP - Include support for Internetwork Packet Exchange
  protocol commonly in use by Novell NetWare.
<li>NETATALK - Include kernel support for the AppleTalk family of
  protocols.
<li>TCP_COMPAT_42 - Use of this option is extremely discouraged, so it
  should not be enabled. TCP bug compatibility with 4.2BSD. In 4.2BSD, TCP
  sequence numbers were 32-bit signed values.  Modern implementations of
  TCP use unsigned values.
<li>TCP_NEWRENO - Turns on NewReno fast recovery phase, which allows one
  lost segment to be recovered per round trip time.
<li>TCP_SACK - Turns on selective acknowledgements.
<li>TCP_FACK - Turns on forward acknowledgements allowing a more precise
  estimate of outstanding data during the fast recovery phase by using
  SACK information. This option can be used together with TCP_SACK.
<li>PPP_FILTER - This option turns on 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pcap&amp;sektion=3">pcap(3)</a>
  based filtering for ppp connections.
<li>PPP_BSDCOMP - PPP BSD compression.
<li>PPP_DEFLATE - Used in conjunction with PPP_BSDCOMP.
<li>IPSEC - This option enables IP security protocol support. See 
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&amp;sektion=4">ipsec(4)</a>
  for more details. This now implies option KEY, which gives support for
  PFKEYv2.
<li>ENCDEBUG - This option enables debugging information to be
  conditionally logged in case IPSEC encounters errors.
</ul>

<strong>SCSI Subsystem Options</strong>
<ul>
<li>SCSITERSE - Terser SCSI error messages.  This omits the table for
  decoding ASC/ASCQ info, saving about 8 bytes or so.
<li>SCSIDEBUG - Prints extra debugging info for the SCSI subsystem to
  the console.
</ul>


<p> 
<a name= "Building"></a>
<a name= "5.3"></a>
<h2>5.4 - Building your own kernel</h2>

<p>
Full instructions for creating your own custom kernel are in the
<a href= "http://www.openbsd.org/cgi-bin/man.cgi?query=afterboot&amp;sektion=8">
afterboot(8)</a> man page.

<p>
To compile your kernel from the cdrom you need to first have the source
code available.  The source is available on both the 
<a href="../orders.html">official CD</a> (disk 3) and on the 
<a href="../ftp.html">FTP sites</a>.  The following example assumes
that CD3 is mounted on /mnt:

<blockquote>
<pre>
# <strong>cd /usr/src</strong>
# <strong>tar xvzf /mnt/src.tar.gz</strong>
</pre>
</blockquote>

<b>Note:</b> If you are downloading from the FTP servers, you will find
TWO files, <i>src.tar.gz</i> and <i>srcsys.tar.gz</i>.  The first is the
"userland" -- everything but the kernel, the second is the kernel
source.  Download and extract both of them as above, as for most uses,
you will want both.  On the CDROM, they are combined into one file.

<p>
Now to create your custom kernel it is easiest to start with the GENERIC
kernel. This is located at <tt>/usr/src/sys/arch/$ARCH/conf/GENERIC</tt>,
where $ARCH is your architecture. There are other sample configurations
available in that directory as well. Here are two examples for compiling
your kernel. The first example is compiling your kernel on a read-only
source tree. The second on a writable source tree.

<blockquote> 
<pre>
# <strong>cd /somewhere</strong>
# <strong>cp /usr/src/sys/arch/$ARCH/conf/SOMEFILE .</strong>
# <strong>vi SOMEFILE</strong>   <i>(to make the changes you want)</i>
# <strong>config -s /usr/src/sys -b . SOMEFILE</strong>
</pre>
followed by either:

<pre>
    # <strong>make depend</strong>
         <b><i>- OR -</i></b>
    # <strong>make clean</strong>
# <strong>make</strong>
</pre>
</blockquote>

You must run '<tt>make depend</tt>' when you have made any changes 
(including updates and patches) to your source tree (in other words,
almost always, unless you need to run '<tt>make clean</tt>').

<p>
If you have made changes to your kernel configuration options, and/or
made major changes to your source tree, you should use '<tt>make
clean</tt>' instead of the above '<tt>made depend</tt>'.  Note that it
is always safe to do a 'make clean', though it may result in longer
compile times, as more will be rebuilt.

<p>
To compile a kernel inside a writable source tree do the following:

<blockquote>
<tt>
# <strong>cd sys/arch/$ARCH/conf</strong><br>
# <strong>vi SOMEFILE</strong><i> (to make any changes you want)</i><br>
# <strong>config SOMEFILE</strong><i> (read more about it here: 
<a href= "http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8">config(8)</a>)</i><br>
# <strong>cd ../compile/SOMEFILE</strong><br>
# <strong>make</strong> <br>
</tt>
</blockquote>

<p>
Where $ARCH is the architecture you are using (e.g. i386). You can also do
a <strong>make depend</strong> to make the dependencies for the next time
you compile your kernel.

<p>
To move your kernel into place.

<blockquote>
<pre>
# <strong>cp /bsd /bsd.old</strong>
# <strong>cp /sys/arch/$ARCH/compile/SOMEFILE/bsd /bsd</strong>
</pre>
</blockquote>

To revert to your old kernel at boot you just need to

<blockquote>
<pre>
boot&gt; <strong>bsd.old</strong>
</pre>
</blockquote>

and your old kernel will be loaded instead of /bsd.

<p>
Sometimes when you build a new kernel you will be required to install
new bootblocks. To do so, read <a href="faq14.html#InstBoot">FAQ 14,
Installing Bootblocks</a>, which will give you an overview on using
OpenBSD's Bootloader.

<p>
<a name= "BootConfig"></a>
<a name="5.4"></a> 
<h2>5.5 - Boot Time Configuration </h2>

<p>
Sometimes when booting your system you might notice that the kernel finds
your device but maybe at the wrong IRQ. And maybe you need to use this
device right away. Well, without rebuilding the kernel you can use
OpenBSD's boot time kernel configuration. This will only correct your
problem for one time. If you reboot, you will have to repeat this
procedure. So, this is only meant as a temporary fix, and you should
correct the problem by fixing and recompiling your kernel. Your kernel
does however need <strong>option BOOT_CONFIG</strong> in the kernel, which 
GENERIC does have.

<p>
Most of this document can be found in the man page
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&amp;sektion=8">boot_config(8)</a>.

<p>
To boot into the User Kernel Config, or UKC, at boot time us the -c
option.

<blockquote><pre>
boot&gt; <strong>boot wd0a:/bsd -c</strong>
</pre></blockquote>

Or whichever kernel it is you want to boot. Doing this will bring up a
UKC prompt. From here you can issue commands directly to the kernel
specifying devices you want to change or disable or even enable.

<p>
Here is a list of common commands in the UKC.

<ul>
<li><tt>add <strong>device</strong></tt> - Add a device through copying another
<li><tt>change <strong>devno | device </strong></tt> - Modify one or more devices
<li><tt>disable <strong>devno | device </strong></tt> - Disable one or more devices 
<li><tt>enable <strong>devno | device </strong></tt> - Enable one or more devices 
<li><tt>find <strong>devno | device </strong></tt> - Find one or more devices
<li><tt>help</tt> - Short summary of these commands
<li><tt>list</tt> - List ALL known devices
<li><tt>exit/quit</tt> - Continue Booting
<li><tt>show <strong>[attr [val]]</strong></tt> - Show devices with an attribute and
  optional with a specified value
</ul>

<p>
Once you get your device configured, use quit or exit and continue
booting. After doing so you should correct your Kernel configuration and
Compile a new kernel. Refer to <a href="faq5.html#Building">Building
your own kernel</a> for help.

<p>
<a name= "VerboseBoot"></a>
<a name="5.5"></a>
<h2>5.6 - Getting more verbose output during boot</h2>

Getting more verbose output can be very helpful when trying to debug
problems when booting.  If you have a problem wherein your boot floppy
won't boot and need to get more information, simply reboot. When you get
to the &quot;boot&gt;&quot; prompt, boot with boot -c. This will bring you
into the UKC&gt;, then do:

<blockquote><pre>
UKC&gt; <strong>verbose</strong>
autoconf verbose enabled
UKC&gt; <strong>quit</strong>
</pre></blockquote>

<p>
Now you will be given extremely verbose output upon boot.

<p>
<a name= "config"></a>
<a name="5.6"></a>
<h2>5.7 - Using config(8) to change your kernel</h2>
<p>
The <b>-e</b> and <b>-u</b> options with
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8">config(8)</a>
can be extremely helpful and save wasted time compiling your kernel. The
<b>-e</b> flag allows you to enter the UKC or User Kernel Config on a
running system. These changes will then take place on your next reboot.
The <b>-u</b> flag tests to see if any changes were made to the running
kernel during boot, meaning you used <b>boot -c</b> to enter the UKC
while booting your system.

<p>
The following example shows the disabling of the ep* devices in the
kernel. For safety's sake you must use the <b>-o</b> option which writes
the changes out to the file specified. For example : <strong>config -e
-o bsd.new /bsd</strong> will write the changes to bsd.new. The example
doesn't use the <b>-o</b> option, therefore changes are just ignored,
and not written back to the kernel binary. For more information
pertaining to error and warning messages read the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8">config(8)</a>
man page.

<blockquote><pre>
$ <strong>sudo config -e /bsd</strong>
OpenBSD 3.2 (GENERIC) #25: Thu Oct  3 19:51:53 MDT 2002
    deraadt@i386.openbsd.org:/usr/src/sys/arch/i386/compile/GENERIC
warning: no output file specified
Enter 'help' for information
ukc&gt; ?
        help                            Command help list
        add         dev                 Add a device
        base        8|10|16             Base on large numbers
        change      devno|dev           Change device
        disable     attr val|devno|dev  Disable device
        enable      attr val|devno|dev  Enable device
        find        devno|dev           Find device
        list                            List configuration
        lines       count               # of lines per page
        show        [attr [val]]        Show attribute
        exit                            Exit, without saving changes
        quit                            Quit, saving current changes
        timezone    [mins [dst]]        Show/change timezone
        nmbclust    [number]            Show/change NMBCLUSTERS
        cachepct    [number]            Show/change BUFCACHEPERCENT
        nkmempg     [number]            Show/change NKMEMPAGES
        shmseg      [number]            Show/change SHMSEG
        shmmaxpgs   [number]            Show/change SHMMAXPGS
ukc&gt; <strong>list</strong>
  0 audio* at sb0|sb*|gus0|pas0|sp0|ess*|wss0|wss*|ym*|eap*|eso*|sv*|neo*|cmpci*
|clcs*|clct*|auich*|autri*|auvia*|fms*|uaudio*|maestro*|esa*|yds*|emu* flags 0x0
  1 midi* at sb0|sb*|opl*|opl*|opl*|opl*|ym*|mpu*|autri* flags 0x0
  2 nsphy* at aue*|xe*|ef*|gx*|stge*|bge*|nge*|sk*|ste*|sis*|sf*|wb*|tx*|tl*|vr*
|ne0|ne1|ne2|ne*|ne*|ne*|dc*|dc*|rl*|fxp*|fxp*|xl*|xl*|ep0|ep0|ep0|ep*|ep*|ep*|e
p*|ep* phy -1 flags 0x0
  3 nsphyter* at aue*|xe*|ef*|gx*|stge*|bge*|nge*|sk*|ste*|sis*|sf*|wb*|tx*|tl*|
vr*|ne0|ne1|ne2|ne*|ne*|ne*|dc*|dc*|rl*|fxp*|fxp*|xl*|xl*|ep0|ep0|ep0|ep*|ep*|ep
*|ep*|ep* phy -1 flags 0x0
  4 qsphy* at aue*|xe*|ef*|gx*|stge*|bge*|nge*|sk*|ste*|sis*|sf*|wb*|tx*|tl*|vr*
|ne0|ne1|ne2|ne*|ne*|ne*|dc*|dc*|rl*|fxp*|fxp*|xl*|xl*|ep0|ep0|ep0|ep*|ep*|ep*|e
p*|ep* phy -1 flags 0x0
  5 inphy* at aue*|xe*|ef*|gx*|stge*|bge*|nge*|sk*|ste*|sis*|sf*|wb*|tx*|tl*|vr*
|ne0|ne1|ne2|ne*|ne*|ne*|dc*|dc*|rl*|fxp*|fxp*|xl*|xl*|ep0|ep0|ep0|ep*|ep*|ep*|e
p*|ep* phy -1 flags 0x0
  6 iophy* at aue*|xe*|ef*|gx*|stge*|bge*|nge*|sk*|ste*|sis*|sf*|wb*|tx*|tl*|vr*
|ne0|ne1|ne2|ne*|ne*|ne*|dc*|dc*|rl*|fxp*|fxp*|xl*|xl*|ep0|ep0|ep0|ep*|ep*|ep*|e
p*|ep* phy -1 flags 0x0
  7 eephy* at aue*|xe*|ef*|gx*|stge*|bge*|nge*|sk*|ste*|sis*|sf*|wb*|tx*|tl*|vr*
|ne0|ne1|ne2|ne*|ne*|ne*|dc*|dc*|rl*|fxp*|fxp*|xl*|xl*|ep0|ep0|ep0|ep*|ep*|ep*|e
p*|ep* phy -1 flags 0x0
  8 exphy* at aue*|xe*|ef*|gx*|stge*|bge*|nge*|sk*|ste*|sis*|sf*|wb*|tx*|tl*|vr*
|ne0|ne1|ne2|ne*|ne*|ne*|dc*|dc*|rl*|fxp*|fxp*|xl*|xl*|ep0|ep0|ep0|ep*|ep*|ep*|e
p*|ep* phy -1 flags 0x0
[...snip...]
ukc&gt; <strong>disable ep</strong>
 65 ep0 disabled
 66 ep* disabled
 67 ep* disabled
149 ep0 disabled
150 ep0 disabled
151 ep* disabled
152 ep* disabled
202 ep* disabled
ukc&gt; <strong>quit</strong>
not forced
</pre></blockquote>

<p>
In the above example, all ep* devices are disabled in the kernel and will
not be probed. In some situations where you have used the UKC during boot,
via <b>boot -c</b>, you will need these changes to be written out
permanently. To do this you need to use the <b>-u</b> option.
In the following example, the computer was booted into the UKC and the
wi(4) device was disabled. Since changes made with boot -c are NOT
permanent, these changes must be written out. This example writes the
changes made from boot -c into a new kernel binary bsd.new.

<blockquote><pre>
$ <strong>sudo config -e -u -o bsd.new /bsd</strong>
OpenBSD 3.2 (GENERIC) #25: Thu Oct  3 19:51:53 MDT 2002
    deraadt@i386.openbsd.org:/usr/src/sys/arch/i386/compile/GENERIC
Processing history...
105 wi* disabled
106 wi* disabled
Enter 'help' for information
ukc&gt; <strong>quit</strong>
</pre></blockquote>


<p>
<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq4.html">[To Section 4.0 - Installation Guide]</a>
<a href= "faq6.html">[To Section 6.0 - Networking]</a>
</font>

<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../images/back.gif" border= "0" alt= "[back]"></a>
<a href= "mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>$OpenBSD: faq5.html,v 1.76 2003/02/18 03:02:18 nick Exp $</small>
</body>
</html>
