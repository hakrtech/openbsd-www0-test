<html>
<head>
<title>5.0 - Kernel configuration and Disk Setup</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998-1999 by OpenBSD.">
</head>

<body bgcolor= "#ffffff" text= "#000000" link= "#23238E">

<p>
<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq4.html">[To Section 4.0 - Installation and Disk Setup]</a>
<a href= "faq6.html">[To Section 6.0 - Networking]</a>
</font>
</p>

<p>
<h1>5.0 - Kernel Configuration and Disk Setup</h1>
</p>

<p>
<a name= "5.1"></a>
<h2>5.1 - Why would I want to create my own custom kernel?</h2>
</p>

<p>
Its a joyous occasion when you as a user get to configure and build your own
custom kernel. Why would you want to do this though? 
</p>

<p>
<ul>
    <li>You can define which drivers your computer has support for.</li>
    <li>You can get rid of uneeded drivers in the GENERIC kernel</li>
    <li>Speed up boot times</li>
    <li>Remove default options or add options which may not have been enabled
        by default</li>
</ul>
</p>

<p>
<a name= "5.2"></a>
<h2>5.2 - Kernel Configuration Options</h2>
</p>

<p>
Kernel Configuration Options are options that you add to your kernel
configuration that place certain features into your kernel. This allows
you to have exactly the support you want, without having support for
uneeded devices. There are multitudes of options that allow you to
customize you kernel. Here we will go over only some of them, one's that
are most commonly used. Check the <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&apropos=0&sektion=4&format=html">options(4)</a>
man page for a more complete list of options. You can also check the
example configuration files that are availible for your architecture.
</p>

<p>
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/alpha/conf/">Alpha Kernel Conf Files </a></li>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/i386/conf/">i386 Kernel Configuration files</a></li>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/mac68k/conf/">mac68k Kernel Configuration files</a></li>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/pmax/conf/">pmax Kernel Configuration Files</a></li>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/sparc/conf/">sparc Kernel Configuration Files</a></li>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/">Other Arch's</a></li>
</ul>
</p>

<p>
Look closely at these files and you will notice a line like:<br>
<strong>include "../../../conf/GENERIC"</strong><br>
This means that it *IS* referencing yet another configuration file. This
file stores non arch-dependent options. So when creating your Kernel
Config be sure to look through <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/conf/GENERIC">/sys/conf/GENERIC</a> 
and see what you want. There ARE options in there that are NEEDED.
</p>

<p>
All of the options listed below should be placed in your kernel configuration file in the format of:<br>
<strong>option      OPTION</strong><br>
for example. To place option debug in the kernel, add a line like this:<br>
<strong>option	    DEBUG</strong><br>
Options in the OpenBSD kernel are translated into compiler preprocessor options, therefore an option like DEBUG would have the
source compiled with option -DDEBUG. Which is equivalent to doing a #define DEBUG throughout the kernel.
</p>

<p>
OpenBSD has a great many compatibility options which allow you to use binaries from other OS's.
Not all are availibly on every architechture, so be sure to read the man pages for each option to 
see if your arch is supported.
</p>
<p>
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_svr4&sektion=8&apropos=0&manpath=OpenBSD+Current">COMPAT_SVR4(8)</a> - Compatibility with SVR4 binaries.</li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_bsdos&sektion=8&apropos=0&manpath=OpenBSD+Current">COMPAT_BSDOS(8)</a> - Compatibility with BSD/OS binaries.</li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_linux&sektion=8&apropos=0&manpath=OpenBSD+Current">COMPAT_LINUX(8)</a> - Compatibility with Linux binaries.</li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_sunos&sektion=8&apropos=0&manpath=OpenBSD+Current">COMPAT_SUNOS(8)</a> - Compatibility with SunOS binaries.</li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ultrix&sektion=8&apropos=0&manpath=OpenBSD+Current">COMPAT_ULTRIX(8)</a> - Compatibility with Ultrix binaries.</li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_freebsd&sektion=8&apropos=0&manpath=OpenBSD+Current">COMPAT_FREEBSD(8)</a> - Compatibility with FreeBSD binaries.</li>
<li>COMPAT_HPUX - Compatibility with HP-UX binaries. Only availible on some m68k arch's.</li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ibcs2&sektion=8&apropos=0&manpath=OpenBSD+Current">COMPAT_IBCS2(8)</a> - Compatibility to run ibcs2 binaries.</li>
<li>COMPAT_OSF1 - Run Digital Unix binaries. Availible only on Alpha platform.</li>
<li>COMPAT_43 - Compatibility with 4.3BSD. Use of this is certainly discouraged, But it is needed for our Navigator port</li>
<li>COMPAT_11 - Compatibility with NetBSD 1.1</li>
<li>COMPAT_NOMID - Compatibility with a.out executables that lack a machine id.
</ul>
</p>

<p>
It is always helpful to be able to debug problems with the kernel. But many choose not to put these options in their kernel
because these options add considerable size to the kernel. There are however extremely helpful in a case where a bug might be
present. This well help your or developers discover the source of your problems much quicker. Here is a list of popular
debugging options that can be added to your kernel.
</p>

<p>
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ddb&sektion=4&format=html">DDB</a> - This compiles in the in-kernel debugger. This isn't availible on all platforms. So be sure to read before adding it.</li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1&format=html">KGDB</a> - Compiles a remote kernel
debugger using gdb's `remote target` feature.</li>
<li>makeoptions  DEBUG="-g" - Makes bsd.gdb along with bsd. This is useful for debugging crash dumps with gdb. NOTE: This 
option also turns on <strong>option DEBUG</strong></li>
<li>DEBUG - Used to put various debugging options in the kernel, where the source has defined them.</li>
<li>KTRACE - Adds hooks for the system call tracing facility. Which allows users to use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ktrace&sektion=1&format=html">ktrace(1)</a>.</li>
<li>DIAGNOSTIC - Adds code to the kernel that does internal consistency checks.</li>
</ul>
</p>

<p>
<strong>Filesystem Options.</strong>
<ul>
<li>FFS - Berkeley Fast Filesystem <strong>NOTE:</strong> This option is required</li>
<li>EXT2FS - Second Extended File System, This is needed for those of you who want to read Linux partitions.</li>
<li>MFS - Memory File System that stores files in swapable memory. This is not quite stable as of now.</li>
<li>NFS - Network File System, This is needed if you will be using NFS.</li>
<li>CD9660 - This is iso9660 + rockridge filesystem. This is required to read from cd's</li>
<li>MSDOSFS - Needed to read MS-DOS FAT filesystems. Also has support for Windows 95 long name + mixed case extensions.</li>
<li>FDESC - Includes code for a file system which can be mounted on /dev/fd</li>
<li>KERNFS - Includes code which permits the mounting of a special file system (normally mounted on /kern) in which files
representing various kernel variables and parameters may be found.</li>
<li>NULLFS - Code to have a loopback filesystem. <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mount_null&sektion=8&format=html">mount_null(8)</a> has more
information</li>
<li>PROCFS - Includes code for a special file system (conventionally mounted on /proc)</li>
<li>PORTAL - Includes the (experimental) portal filesystem.  This permits interesting tricks like opening TCP sockets by
opening files in the file system.</li>
<li>UMAPFS - Includes a loopback file system in which user and group ids may be remapped -- this can be useful when mounting
alien file systems with different uids and gids than the local system (eg, remote NFS).</li>
<li>UNION - Includes code for the union file system, which permits directories to be mounted on top of each other in such a
way that both file systems remain visible. This code isnt quite stable yet.</li>
<li>XFS - Add hooks for using a filesystem that is compatible with the AFS filesystem. Currently used by the Arla/AFS code.  </li>
<li>LFS - Log Structured Filesystem.</li>
<li>FFS_SOFTUPDATES - Allows for the use of softupdates. To read up on softupdates more read the <a href="faq4.html#4.9">Softupdates FAQ</a> section.
<li>NFSSERVER - Allow for the server-side NFS code to be included in the kernel.</li>
<li>NFSCLIENT - Allow for the client-side NFS code to be included in the kernel.</li>
<li>FIFO - Support for FIFO's.. RECOMMENDED.</li>
<li>NVNODE=integer - Where integer is the size of the cache used by the name-to-inode translation routines, (a.k.a. the
namei() cache, though called by many other names in the kernel source).</li>
<li>EXT2FS_SYSTEM_FLAG - This option changes the behavior of the APPEND and IMMUTABLE flags for a file on an EXT2FS
filesystem. Read <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4&format=html">options(4)</a> for more
details.</li>
<li>QUOTA - Support for Filesystem Quota's. To read up on using quotas read <a href="faq10.html#10.10">FAQ 10</a></li>
</ul>
</p>

<p>
<strong>Misc. Options</strong>
<ul>
<li>PCIVERBOSE - Make the boot process more verbose for PCI peripherals.</li>
<li>EISAVERBOSE - Make the boot process more verbose for EISA peripherals.</li>
<li>PCMCIAVERBOSE - Make the boot process more verbose for PCMCIA peripherals.</li>
<li>APERTURE - Provide in-kernel support for VGA framebuffer mapping by user processes. Needed to run X.</li>
<li>XSERVER - Support for the X server console driver. Needed for X.</li>
<li>LKM - Support for Loadable Kernel Modules. Not availible on all arch's. Read <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lkm&sektion=4&format=html">lkm(4)</a> for more information.</li>
<li>INSECURE - Hardwires the kernel security level to -1. Read <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=init&sektion=8&format=html">init(8)</a> for more information on kernel security levels.</li>
<li>MACHINE_NONCONTIG - Changes part of the VM/pmap interface, to allow for non-contiguous memory.</li>
<li>RAM_DISK_HOOKS - Allows for machine dependent functions to be called when the ramdisk driver is configured.</li>
<li>RAM_DISK_IS_ROOT - Forces the ramdisk to be root.</li>
<li>CCDNBUF=integer - Set number of component buffers used by CCD(4). Default is 8. For more on CCD read the <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ccd&sektion=4&format=html">CCD(4)</a> man page, or the <a href="faq12.html#12.2">Performance Tuning FAQ section.</a></li>
<li>KMEMSTATS - This makes malloc(9), the kernel memory allocator keep statistics on its use. If option DEBUG is used, this option is automatically turned off by config. </li>
</ul>
</p>

<p> <a name= "5.3"></a>
<h2>5.3 - Building your own kernel</h2>
</p>

<p>
Full instructions for creating your own custom kernel are in the
<a href= "http://www.openbsd.org/cgi-bin/man.cgi?query=afterboot&apropos=0&sektion=8&format=html">
afterboot(8)</a> man page.
</p>

<p>
To compile your kernel from the cdrom do the following:
</p>

<p>
<pre>
#cd /somewhere
#cp /usr/src/sys/arch/$ARCH/conf/SOMEFILE .
#vi SOMEFILE (to make the changes you want)
#config -s /usr/src/sys -b . SOMEFILE
#make 
</pre>
</p>

<p>
To compile a kernel inside a writeable source tree do the following:
</p>

<p>
<pre>
#cd /sys/arch/$ARCH/conf
#vi SOMEFILE (to make any changes you want)
#config SOMEFILE (read more about it here : <a href= "http://www.openbsd.org/cgi-bin/man.cgi?query=config&apropos=0&sektion=8&format=html">config(8)</a>)
#cd ../compile/SOMEFILE
#make 
</pre>
</p>

<p>
Where $ARCH is the architecture you are using (e.g. i386). You can also do
a <strong>make depend</strong> to make the dependencies for the next time
you compile your kernel.
</p>

<p>
To move your kernel into place.
</p>

<p>
<pre>
#cp /bsd /bsd.old
#cp /sys/arch/$ARCH/compile/SOMEFILE/bsd /bsd
</pre>
</p>

<p>
To revert to your old kernel at boot you need to just
</p>

<p>
<pre>
boot>bsd.old
</pre>
</p>

<p>
and your old kernel will be loaded instead of /bsd.
</p>

<p>
<a name="5.4"></a> 
<h2>5.4 - Boot Time Configuration </h2>
</p>

<p>
Sometimes when booting your system you might notice that the kernel finds
your device but maybe at the wrong IRQ. And maybe you need to use this
device right away. Well, without rebuilding the kernel you can use
OpenBSD's boot time kernel configuration. This will only correct your
problem for one time. If you reboot, you will have to repeat this
procedure. So, this is only meant as a temporary fix, and you should
correct the problem by fixing and recompiling your kernel. Your kernel
does however need <strong>option BOOT_CONFIG</strong> in the kernel, which 
GENERIC does have.
</p>

<p>
Most of this document can be found in the man page
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&apropos=0&sektion=8&format=html">boot_config(8)</a>
</p>

To boot into the User Kernel Config, or UKC, at boot time us the -c
option.

<p><pre>
Boot> boot wd0a:/bsd -c
</pre></p>

<p>
Or whichever kernel it is you want to boot. Doing this will bring up a
UKC prompt. From here you can issue commands directly to the kernel
specifying devices you want to change or disable or even enable.
</p>

<p>
Here is a list of common commands in the UKC.
</p>

<p>
<CODE>add <strong>device</strong> - Add a device through copying another
</p>

<p>
change <strong>devno | device </strong> - Modify one or more devices
</p>

<p>
disable <strong>devno | device </strong> - Disable one or more devices 
</p>

<p>
enable <strong>devno | device </strong> - Enable one or more devices 
</p>

<p>
find <strong>devno | device </strong> - Find one or more devices
</p>

<p>
help - Short summary of these commands
</p>

<p>
list - List ALL known devices
</p>

<p>
exit/quit - Continue Booting
</p>

<p>
show <strong>[attr [val]]</strong> - Show devices with an attribute and optional with a specified value
</p></CODE>

<p>
Once you get your device configured, use quit or exit and continue
booting. After so you should correct your Kernel configuration and Compile
a new kernel. Refer to <a href="faq5.html#5.3">Building your own
kernel</a> for help.
</p>

<p>
<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq4.html">[To Section 4.0 - Installation and Disk Setup]</a>
<a href= "faq6.html">[To Section 6.0 - Networking]</a>
</font>
</p>

<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../images/back.gif" border= "0" alt= "[back]"></a> 
<a href= "mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>$OpenBSD: faq5.html,v 1.17 1999/06/25 00:41:44 ericj Exp $</small>
</p>
</body>
</html>
