<html>
<head>
<title>OpenBSD FAQ: 13 - Understanding and Using IPSec</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright (C) 1999 OpenBSD">
</head>

<body bgcolor= "#ffffff" text= "#000000" link= "#23238E">
<img alt="[OpenBSD]" height=30 width=141 src="/images/smalltitle.gif">
<p>

<p>
<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq12.html">[To Section 12.0 - For Advanced Users]</a>
<a href= "faq14.html">[To Section 14.0 - Using disks in OpenBSD]</a>
</font>
</p>

<p>
<Font size="-1">
This document borrows large pieces from:
<UL>
<LI><A HREF="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPSec for Dummies</a> by Julian Elischer
<LI><A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a> by Niels Provos, and several other people from the OpenBSD team
</UL>
Thanks, folks!
</font>
<p>
<h1>13.0 - Understanding and Using IPSec (IP Security Protocol)</h1>
<UL>
<LI><A HREF="#13.1">What is IPSec?</a>
<LI><A HREF="#13.2">That's nice, but why do I want to use IPSec?</a>
<LI><A HREF="#13.3">What are the protocols behind IPSec?</a>
<LI><A HREF="#13.4">On the wire format</a>
<LI><A HREF="#13.5">Configuring IPSec</a>
<LI><A HREF="#13.6">How do I setup IPSec with manual keying?</a>
<LI><A HREF="#13.7">How do I setup IPSec with isakmpd/IKE?</a>
<LI><A HREF="#13.8">What IKE clients are compatible with isakmpd?</a>
<LI><A HREF="#13.9">Troubleshooting IPSec/VPN</a>
<LI><A HREF="#13.10">Related Documentation</a>
</UL>
<p>
<a name= "13.1">
<h1>13.1 - What is IPSec?</h1>
</a>
<P>
IPSec is a set of extensions to the IP protocol family.   It provides
cryptographic security services.  These services allow for authentication,
integrity, access control, and confidentiality.  IPSec provides
similar services as SSL, but at the network layer, in a way that is completely
transparent to your applications, and much more powerful.  We say this
because your applications do not have to have any knowledge of IPSec to be
able to use it.
You can use <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.8">any IP protocol</a> over IPSec.  You can create encrypted tunnels (VPNs), or just do encryption between computers.
Since you have so many options, IPSec is rather complex (much more so then SSL!)
<P>
Before you start using IPSec, we strongly recommend that you check out
the "recommended reading" of <A HREF="faq6.html">part 6</a> of the FAQ.
In particular, if you don't already understand it, the <A HREF="http://www.3com.com/nsc/501302s.html">Understanding
IP Addressing</a> document is highly recommended.
<P>
In a logical sense, IPSec works in any of these three ways:
<UL>
<LI>Host-to-Host
<LI>Host-to-Network
<LI>Network-to-Network
</UL>
In every scenario that involves a network, we mean to imply
router.  As in, Host-to-Router (and this router controls and encrypts
traffic for a particular <i>Network</i>.)
<P>
As you can see, IPSec can be used to tunnel traffic for VPN connections.
However, its utility reaches beyond VPNs.  With a central Internet Key Exchange
registry, every machine on the internet could talk to another one
and employ powerful encryption and authentication!
<p>
<a name= "13.2">
<h1>13.2 - That's nice, but why do I want to use IPSec?</h1>
</a>
<P>
The internet protocol, IP, aka IPv4, does not inherently provide any protection
to your transferred data.  It does not even guarantee that the
sender is who he says he is.  IPSec tries to remedy this.  These services 
are considered distinct, but the IPSec supports them in a uniform manner. 
<P>
<h4>Confidentiality</h4> Make sure it is hard for anyone but the receiver
to understand what data has been communicated.  You do not want
anyone to see your passwords when logging into a remote machine
over the Internet.
<P>
<h4>Integrity</h4> Guarantee that the data does not get changed on the
way.  If you are on a line carrying invoicing data you probably
want to know that the amounts and account numbers are correct and
not altered while in-transit.
<P>
<h4>Authenticity</h4> Sign your data so that others can see that it is really
you that sent it.  It is clearly nice to know that documents
are not forged.
<P>
<h4>Replay protection</h4> We need ways to ensure a transaction can only
be carried out once unless we are authorized to repeat it.  I.e. it
should not be possible for someone to record a transaction, and
then replaying it verbatim, in order to get an effect of multiple
transactions being received by the peer.  Consider the attacker has
got to know what the traffic is all about by other means than
cracking the encryption, and that the traffic causes events
favourable for him, like depositing money into his account.  We
need to make sure he cannot just replay that traffic later.
<i>WARNING: as per the standards specification, replay protection is not
performed when using manual-keyed IPsec (e.g., when using <A
HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>)</i>.
<p>
<a name= "13.3">
<h1>13.3 - What are the protocols behind IPSec?</h1>
</a>
<P>
IPSec provides confidentiality, integrity, authenticity, and replay
protection through two new protocols.  These protocols are called AH,
Authentication header, and ESP, Encapsulated security payload.
<P>
AH provides authentication, integrity, and replay protection (but not
confidentiality). Its main difference with ESP is that AH also secures
parts of the IP header of the packet (like the source/destination
addresses).
<P>
ESP can provide authentication, integrity, replay protection, and
confidentiality of the data (it secures everything in the packet that follows
the IP header). Replay protection requires authentication and integrity
(these two go always together). Confidentiality (encryption) can be used
with or without authentication/integrity. Similarly, one could use
authentication/integrity with or without confidentiality.
<P>
<a name= "13.4">
<h1>13.4 - On the wire format</h1>

<P>The <B>Authentication Header</B>
(AH) comes after the basic IP header and contains cryptographically
secured Hashes of the data and Identification information. The hashes can
also cover the invariant parts of the IP header itself. There are
several differnt RFCs giving a choice of actual algorythms to use in the
AH, however they all must follow the guidlines specified in <A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC2402</A>.

<P>The <B>Encapsulating
Security Payload</B> (ESP) header, allows for rewriting of the payload
in encrypted form. The ESP header does not consider the fields of the IP
header before it and therefore amkes no guarantees about anything except
the payload. The various types of ESP applicable must follow <A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</A>.
An ESP header can also provide Authentication for the payload, (but not
the outer header).

<P>An orthogonal (mostly) division of IPSec functionality is applied depending
on whether the endpoint doing the IPSec encapsulation is the original source
of the data or a gateway:

<UL>
<LI><B>Transport</B> mode is used by a host that is generating the packets.
In transport mode, the security headers are added before the transport
layer (e.g . TCP, UDP) headers, before the IP header is prepended to the
packet. In other words an AH added to the packet will cover the hashing
of the TCP header and some fields of the end-to-end IP header, and an ESP
header will cover the encryption of the TCP header and the data, but
not the end-to-end IP header.</LI>

<LI><B>Tunnel </B>mode is used when the end-to-end IP header is already
attached to the packet, and one of the ends of the secure connection is
only a gateway. In this mode, the AH and ESP headers are used to cover
the entire packet including the end-to-end header, and a new IP header
is repended to the packet that covers just the hop to the other end of
the secure connection (though that may of course be several IP hops away).</LI>
</UL>

<P>IPSec secured links are defined in terms of <B>Security Associations
</B>(SAs). Each SA is defined for a single unidirectional flow of data,
and usually (ignoring multicast) from one single point to another, covering
trafic distiguishable by some <B>unique selector</B>. All traffic flowing
over a single SA is treated the same. Some traffic may be subject to several
SAs, each of which applies some transform. Groups of SAs are called an
SA <B>Bundle</B>. Incoming packets can be assigned to a particular SA by
the three defining fields, (<B>Destination IPaddess, Security Paramiter
Index, Security protocol)</B> SPI can be considered a cookie that is handed
out by the reciever of the SA when the parameters of the connection are
negotiated. and the protocol must be either AH or ESP. Since the IP
address of the reciever is part of the tripple, this is a guaranteed unique
value. They can be found from the outer IP header and the first security
header (which contains the SPI and the protocol).

<P>An example of a tunnel mode AH packet is:

<P><B>[IPHDR][IPoptions][AH]</B>[IPHDR2][IPoptions][TCP][data]

<P>An example of a transport mode AH packet is:

<P><B>[IPHDR][IPoptions][AH]</B>[TCP][data]

<P>Because an ESP header cannot authenticate the outer IP header,
it is useful to combine an AH and an ESP header to get the following:

<P><B>[IPHDR][IPoptions][AH][ESP]</B><I>[TCP][data]</I>

<P>This is called <B>Transport Adjacency</B>. The tunnelling version would
look like:

<P><B>[IPHDR][IPoptions][AH][ESP]</B><I>[IPHDR2][IPoptions][TCP][data]</I>

<P>However it is not specifically mentionned in the RFC. As with Transport
adjacency, this would authenticate the entire packet except a few headers
in the IP header and also encrypt the payload, (seen in italics). When
an AH and an ESP header are diectly applied together like this,
the order of the headers should be as shown. It is possible in tunnel mode,
to do arbitrary recursive encapsulation so that order is not specified.

<A name="13.5">
<h1>13.5 - Configuring IPSec</h1>
</a>

<P>How the IPSec systems and gateways are configured is to some extent
left to the designer, however the RFC has some strong recomendations as
to how this should be implemented, so as to minimise confusion.

<P>There are two administrative entities that control what happens to a
packet. One is the <B>Security Association Database</B> (SAD, referred
to as TDB or TDB table throughout OpenBSD's IPSec source code)
and the other is the <B>Security Policy Database</B> (SPD).

<P>They are similar in that given a number of selectors that describe some
traffic, they will deliver an entry that describes the processing needed.
however the SPD is two steps removed from the actual processing. The
SPD is used for outgoing packets, to decide what SAD entries should
be used, and the SAD entries in turn describe the actual process and the
parameters for it. The SPD entries specify the already created SAD entries
to use (if it's a bundle there can be more than 1), but if there is not
already a suitable one, it is used to create new ones. The fields of the
SA being created can be taken either from the SPD entry or from the packet
that initialted the creation.

<P>Outgoing packets go from the SPD entry to the specific SA, to get encoding
parameters. Incoming packates get to the correct SA directly using the
SPI/DEST/Proto tripple, and from there get to the SPD entry.

<P>The SPD can also specify what traffic should bypass IPSec and what should
be dropped, so it must also be consulted for incoming non-IPSec traffic.
SPD entries must be explicitly ordered as several might match a particular
packet, and the processing must be reproducible.

<P>The SPD can be though of as similar to a packet filter where the actions
decided upon are the activation of SA processes. Selectors can include
src and dest address, port numbers if relevant, application and user IDs
if available (only on host based transport SAs), hostnames, security sensitivity
levels, protocols etc.

<P>A SAD entry would include:

<UL>
<LI>Dest IP address
<LI>IPSec proto (SA or ESP)
<LI>SPI (cookie)
<LI>Sequnce counter
<LI>Seq O/F flag
<LI>anti-replay window info
<LI>AH type and info
<LI>ESP type and info
<LI>Lifetime info
<LI>tunnel/transport mode flags
<LI>Path MTU info
</UL>

<P>A SPD entry would contain:

<UL>
<LI>pointer to active SAs
<LI>Selector fields
</UL>

<P>Each SA can define one ESP header and one AH header.
An IPSec session must have one or the other or both, but cannot be defined
with neither, otherwise there would be no headers to specify the SPI
to look up the SA. The RFC doesn't say what would happen if the
AH and ESP headers dissagree about the SPI value. One would presume
this would imply multiple SA's in a bundle.

<P>The SPD in OpenBSD is mananged through the <tt>ipsecadm flow</tt> command.
(You would only make changes to it if you are using manual keying.)
SAD entries can be set manually with
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>,
however the IETF has also defined automatic mechanisms
for initialisation of sessions and such things as key exchange.
OpenBSD implements both Photuris (<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC2522</a>, and
<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2523.html">RFC2523</a>)
and ISAKMP automatic key exchange
(<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC2407</a>,
<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC2408,</A> and
<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC2409</A>)
in the
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=photurisd&apropos=0&sektion=8&format=html">photurisd(8)</a>
and <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8&format=html">isakmpd(8)</a>
daemons.
<P>
<a name= "13.6">
<h1>13.6 - How do I setup IPSec with manual keying?</h1>
</a>
<P>
Manual keying is the easiest way to get started with IPSec.
You can setup encryption between networks, to create VPNs using this
method.  After you have read this section, you may want to
investigate using <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">/usr/share/ipsec/rc.vpn</a>
to set this up for you automatically.
<P>
First, you need to turn on IP AH and IP ESP options in the OpenBSD
kernel.  (If you are only using ESP, such as with the rc.vpn script, or
as with the example below, then <i>you do not need to enable AH</i>. In fact,
there may even be security concerns related to enabling AH if you are not
using it.)<P>
There is a nice sysctl to enable these protocols.
<ul><tt>
# <b>sysctl -w net.inet.esp.enable=1</b><BR>
net.inet.esp.enable: 0 -> 1<br>
# <b>sysctl -w net.inet.ah.enable=1</b><br>
net.inet.ah.enable: 0 -> 1
</ul></tt>
You can edit <tt>/etc/sysctl.conf</tt> to turn these on at boot time.
<P>
Now, you need to setup SAs, or Security Associations.
A Security Association is a combination of your IP addresses, an SPI, and
your security protocol (AH and/or ESP.)  The IP addresses are that of both
your own and your destination.  The SPI, or Security Parameter Index, is a
number that OpenBSD uses to classify different SAs.
<P>
<I>These examples only use ESP to encrypt your traffic.  ESP includes
authentication of the contained encrypted data, but does not authenticate
the surrounding IP header, as AH would.  This "limited authentication"
is nevertheless quite sufficient in most cases, especially for ESP in a
tunnel environment.</i>
<P>
<ul>
<tt>
# <b>ipsecadm new esp -spi SPI_OUT -src MY_EXTERNAL_IP -dst PEER_EXTERNAL_IP
-forcetunnel -enc blf -auth sha1 -key ENC_KEY -authkey AUTH_KEY</b>
</tt>
</ul>
<P>
Let's put this into practice with two routers, 192.168.5.1 and 192.168.25.9.
<P>
On Host 192.168.5.1:
<ul>
<tt>
# <b>ipsecadm new esp -spi 1000 -src 192.168.5.1 -dst 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</tt>
</ul>
On Host 192.168.25.9:
<UL>
<tt>
# <b>ipsecadm new esp -spi 1001 -src 192.168.25.9 -dst 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</tT>
</ul>
<P>
Notice that the SPIs are different.  See <A HREF="#13.4">On the wire format</a> for a complete description of what the SPI is and where it is used.
<P>
Now that you have your Security Associations in place,
set up your flows.
<P>
Note that, with the -local option, ipsecadm will actually create two flows,
one with the source address set to 0.0.0.0/32, which handles packets
originating from the gateway.
<P>
On 192.168.5.1:<P>
So, right here, <b>two</b> flows will be created, one with 0.0.0.0/32 as the
source address, which covers all packets originating from the local host
to the destination, as well as a flow from the destination back to the local
host.
<ul>
<tt>
# <b>ipsecadm flow -proto esp -dst 192.168.25.9 -spi 1000
-addr 192.168.5.1 255.255.255.255 192.168.25.9 255.255.255.255 -local</b>
</tt></ul>
On 192.168.25.9:
<ul>
<tt>
# <b>ipsecadm flow -proto esp -dst 192.168.5.1 -spi 1001
-addr 192.168.25.9 255.255.255.255 192.168.5.1 255.255.255.255 -local</b>
</tt></ul>
<P>
If you want less overhead on your Host-to-Host VPNs, creating the SPI
without <tt>-forcetunnel</tt> will let you use transport mode (whereas, <tt>-forcetunnel</tt>
makes sure all of the IP packet, including the IP header, are encapsulated
by SPI).  If either
the source or destination is a network, you will have to use tunnel
mode.  Creating an SA to and/or from a network will automatically ensure
tunnel mode SPIs are being created.
<p>
This is a simple way to start using IPSec.
<P>
You can use IPSec to tunnel private IP address spaces over the Internet.
Here is a good example... We want to tunnel 192.168.99.0/24, which is behind
208.1.1.1, to 208.1.2.0/24 and 208.1.5.0/24 which are behind 208.2.2.2.
These examples were generated using the <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">rc.vpn</a> script.
<P>
As you can see, when you are using manual keying with IPSec,
you have to specify <b>exactly</b> what you want done.
It won't guess for you.  Look at these examples...
<h2>On 208.1.1.1:</h2>
First, set up the security associations (SAs):<BR>
(This sets up the SPIs, encryption methods, and keys.) 
<UL><tt>
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
</ul></tt>
Next, setup a flow from 208.1.1.1 to 208.2.2.2
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.2.2.2 255.255.255.255 -local</b><br>
</ul></tt>
Next, setup a flow from 208.1.2.0/24, which is behind 208.2.2.2, to 192.168.99.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.2.0 255.255.255.0</b><BR>
</ul></tt>
Next, setup a flow from 208.1.5.0/24, which is behind 208.2.2.2, to 192.168.99.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.5.0 255.255.255.0</b><br>
</ul></tt>
Now, setup a flow from 208.1.2.0/24, which is behind 208.2.2.2 to the router 208.1.1.1.
<ul><tT>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.2.0 255.255.255.0 -local</b><br>
</ul></tt>
OK, setup a flow from 208.1.5.0/24, which is behind 208.2.2.2, to the router 208.1.1.1
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.5.0 255.255.255.0 -local</b><br>
</ul></tt>
Finally, setup a flow from the router 208.2.2.2 to 192.168.99.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.2.2.2 255.255.255.255</b><br>
</ul></tt>
<P>
<h2>On 208.2.2.2:</h2>
Same as before, we setup the SAs...
<UL><TT>
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
</ul></tt>
Now, this is the reverse side...
Setup a flow from the router 208.2.2.2 to 208.1.1.1
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 208.1.1.1 255.255.255.255 -local</b><br>
</ul></tt>
Setup a flow from the network 192.168.99.0/24, which is behind 208.1.1.1, to 208.1.2.0/24
<ul><tT>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 192.168.99.0 255.255.255.0</b><br>
</ul></tt>
Setup a flow from the network 192.168.99.0/24, which is behind 208.1.1.1, to 208.1.5.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 192.168.99.0 255.255.255.0</b><br>
</ul></tt>
Now, setup a flow from 192.169.99.0/24, which is behind 208.1.1.1, to the router 208.2.2.2
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 192.168.99.0 255.255.255.0 -local</b><br>
</ul></tt>
We're almost done...
Two flows left to get 208.1.2.0/24 and 208.1.5.0/24 from the router 208.2.2.2
to the router 208.1.1.1.
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 208.2.2.2 255.255.255.255</b><br>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 208.2.2.2 255.255.255.255</b><br>
</ul></tt>
<P>
If you have been using ipsecadm, and you want to get rid of any work
that you've done, and start from scratch, do
<ul><tt>
# <b>ipsecadm flush</b>
</ul></tt>
This will flush all "IPSec info" (SPIs, flows, routing entries) from your system.
<P>
<a name="13.7">
<h1>13.7 - How do I setup IPSec with isakmpd/IKE?</h1>
</a>
<P>If you are thinking about VPNs or other traditional applications
of IPSec, you probably are going to use ISAKMP.  Most commercial
implementations of IPSec do not provide any manual keying ability, 
instead they require you to use some form of ISAKMP.  Unfortunately, this FAQ
isn't complete yet, certainly not section 13.7.
<a name= "13.8">
<h1>13.8 - What IKE clients are compatible with isakmpd?</h1>
</a>
<P>
<tt>isakmpd</tt> is the ISAKMP/Oakley key management daemon that comes with OpenBSD.
We suspect that it interoperates, at least partially, with most any ISAKMP
implementation, but the following have actually been tested.   Note that some
isakmp software out there is actually based on the OpenBSD isakmp daemon.
<P>
The following MS-Windows clients have been reported to be compatible:
<UL>
<LI><A HREF="http://www.timestep.com/">TimeStep</a> PERMIT/Client
<LI><A HREF="http://www.vpcom.com/">Ashley Laurent</a> VPCom VPN software
<LI><A HREF="http://www.nai.com/asp_set/products/tns/pgp_vpn.asp">PGP VPN</a> software
<LI><A HREF="http://www.radguard.com/">Radguard</a> cIPro client
<LI><A HREF="http://www.cisco.com/">Cisco</a> Win32 client (<i>unreleased?</i>)
</UL>
<P>
The following other gateways/routers have been reported to be compatible:
<UL>
<LI><A HREF="http://www.cisco.com/">Cisco</a> IOS
<LI><A HREF="http://www.cisco.com/">Cisco</a> PIX
<LI><A HREF="http://www.intel.com/">Intel</a> LanRover
<LI><A HREF="http://www.timestep.com/">TimeStep</a> PERMIT/Gate
<LI><A HREF="http://www.cendio.com/">Cendio</a> Fuego
<LI><A HREF="http://www.kame.net/">KAME</a> for FreeBSD
<LI><A HREF="http://www.xs4all.nl/~freeswan/">FreeS/WAN</a> for Linux
<LI><A HREF="http://www.axent.com/">Axent</a> Raptor
<LI><A HREF="http://www.ericsson.com/">Ericsson</a> eBox
<LI><A HREF="http://www.radguard.com/">Radguard</a> cIPro-VPN
<LI><A HREF="http://www.f-secure.com/">F-Secure</a> VPN+
<LI><A HREF="http://www.teamware.com/">Teamware</a> TWISS
<LI><A HREF="http://www.3com.com/">3com</a> Pathbuilder
<LI><A HREF="http://www.nortelnetworks.com/">Nortel</a> Contivity
</UL>
<P>
<a name= "13.9">
<h1>13.9 - Troubleshooting IPSec/VPN</h1>
</a>
<P>
Your first tool for troubleshooting IPSec is <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>.
Use <tt>tcpdump</tt> to look for several things.
<P>
First, if you are running
OpenBSD 2.6, you have an enhanced version of tcpdump which can show some
information about ESP and AH packets.  If you are using tcpdump from OpenBSD
2.5 or on another operating system, chances are you have an older
version that will simply show the protocol number for AH or ESP if it sees
either kind of packets on your network.  (ESP is IP protocol 50, AH is 51)
<UL>
<P>
<LI>
With tcpdump, look and see if traffic is using AH/ESP or cleartext.
If your traffic is in cleartext, then your flows are setup incorrectly
or your isakmp is not negotiating properly.  Use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>
to generate simple traffic.
<P>
<UL>
For instance, I have two hosts, 208.1.1.1 and 208.2.2.2.  
Logged in to 208.2.2.2, I am doing this:
<PRE>
vpn# <b>ping -c 3 208.1.1.1</b>
PING esp.mil (208.1.1.1): 56 data bytes
64 bytes from 208.1.1.1: icmp_seq=0 ttl=255 time=190.155 ms
64 bytes from 208.1.1.1: icmp_seq=1 ttl=255 time=201.040 ms
64 bytes from 208.1.1.1: icmp_seq=2 ttl=255 time=165.481 ms
--- esp.mil ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 165.481/185.558/201.040 ms
</PRE>
And in another session, I can see my encapsulated pings:
<PRE>
vpn# <b>tcpdump -ni fxp7 host 208.1.1.1</b>
tcpdump: listening on fxp7
14:12:19.630274 esp 208.2.2.2 > 208.1.1.1 spi 0x00001000 seq 4535 len 116
14:12:19.813519 esp 208.1.1.1 > 208.2.2.2 spi 0x00001001 seq 49313 len 116
14:12:20.630277 esp 208.2.2.2 > 208.1.1.1 spi 0x00001000 seq 4536 len 116
14:12:20.832458 esp 208.1.1.1 > 208.2.2.2 spi 0x00001001 seq 49314 len 116
14:12:21.630273 esp 208.2.2.2 > 208.1.1.1 spi 0x00001000 seq 4537 len 116
<b>^C</b>
1831 packets received by filter
0 packets dropped by kernel
</PRE>
</ul>
<P>
<LI>IKE runs on UDP port 500.  If this is locked out through a firewall
or packet filter, then you need to change it!
<P>
<LI>With tcpdump on OpenBSD, you can decode most cleartext parts of Internet
Key Exchange sessions.  If you are using tcpdump from a version of OpenBSD
that is <i>newer</i> then 2.6-RELEASE, tcpdump will also show AH payload
data.  If you are interested in a patch to do this for an older
version of tcpdump, contact <A HREF="mailto:ho@openbsd.org">ho@openbsd.org</a>.
<P>
<LI>Mount a /kern filesystem (if you don't use one by default already.)
<P>
<UL><TT>
# <b>mkdir /kern; mount -t kernfs /kern /kern</b>
</UL></TT>
<P>
In /kern, there is a table of current SA/SPIs, including which have flows
(outgoing SAs) or not (incoming SAs).
There are also traffic counters which you can use to see what traffic going
where.
<P>
<LI>Finally, you can use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a> to see your SAs.
<UL><PRE>
vpn% <b>netstat -rn -f encap</b>
Routing tables

Encap:
Source             Port  Destination        Port  Proto SA(Address/SPI/Proto) 
0.0.0.0/32         0     192.168.99/24      0     0     208.1.1.1/00001000/50
0.0.0.0/32         0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
</PRE></UL>
<P>
<LI>
If all else fails, recompile your kernel with <tt>option ENCDEBUG</tt>.
Then, set the sysctl <tt>net.inet.ip.encdebug</tt> to 1.  Look in your dmesg for
warnings or errors, and report them using <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>
to the OpenBSD developers.  Alternately, if you are not sure you have
actually ran into a bug, you may want to send a message to one of the <A HREF="/mail.html">mailing lists</a>.
</UL>
<P>
<a name= "13.10">
<h1>13.10 - Related Documentation</h1>
</a>
<p>
IPSec is partially documented in the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&apropos=0&sektion=0&format=html">vpn(8)</a>
man page.  There are various configuration templates in <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/">/usr/share/ipsec/</a>
directory which can also assist you.  The manual pages for
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&apropos=0&sektion=4&format=html">enc(4)</a>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&apropos=0&sektion=4&format=html">ipsec(4)</a>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=photurisd&apropos=0&sektion=8&format=html">photurisd(8)</a>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=startkey&apropos=0&sektion=1&format=html">startkey(1)</a>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8&format=html">isakmpd(8)</a> and
<a HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>
are detailed and can assist in setup and operation of IPSec.
<P>
Other links...
<UL>
<LI><A HREF="http://www.ietf.org/html.charters/ipsec-charter.html">IETF IPSec Working Group</a>
<LI><A HREF="http://isakmp-test.ssh.fi/">SSH IPSec interoperability Test Node</a>
<LI><A HREF="http://ipsec-wit.antd.nist.gov/">NIST IPSec Web Based Interoperability Tester</a>
<LI><A HREF="http://www.r4k.net/ipsec/">A port of OpenBSD's IPSec to FreeBSD</a>
<LI><A HREF="http://www.xs4all.nl/~freeswan/">FreeS/WAN - IPSec for Linux</a>
<LI><A HREF="http://www.cs.umass.edu/~lmccarth/ipsec.html">Lots of IPSec related links</A>
<LI><A HREF="http://www.codetalker.com/greenbox/docs/vpn-24-minifaq.html">OpenBSD 2.4 VPN Configuration Mini-FAQ</a>
</UL>
<p> 
And on to the RFCs...
<UL>
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2085.html">RFC 2085</a> - HMAC-MD5 IP Authentication with Replay Prevention
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2104.html">RFC 2104</a> - HMAC: Keyed-Hashing for Message Authentication
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPSec Data Flows
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<b>IPSec</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC 2402</A> - IP Authentication Header (<b>AH</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2403.html">RFC 2403</A> - The Use of HMAC-MD5-96 within ESP and AH
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2404.html">RFC 2404</A> - The Use of HMAC-SHA-1-96 within ESP and AH
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2405.html">RFC 2405</A> - The ESP DES-CBC Cipher Algorithm With Explicit IV
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC 2406</A> - IP Encapsulating Security Payload (<b>ESP</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC 2407</A> - The Internet IP Security Domain of Interpretation for ISAKMP
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408</A> - Internet Security Association and Key Management Protocol (<b>ISAKMP</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</A> - The Internet Key Exchange (<b>IKE</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2410.html">RFC 2410</A> - The NULL Encryption Algorithm and Its Use With IPsec (ha ha...)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2411.html">RFC 2411</A> - IP Security Document Roadmap
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2412.html">RFC 2412</A> - The OAKLEY Key Determination Protocol
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2451.html">RFC 2451</a> - The ESP CBC-Mode Cipher Algorithms
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC 2522</a> - Photuris: Session-Key Management Protocol
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2523.html">RFC 2523</a> - Photuris: Extended Schemes and Attributes
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2709.html">RFC 2709</a> - Security Model with Tunnel-mode IPsec for NAT Domains
</UL>

<font color= "#0000e0">
<a href= "index.html">[Back to Main Index]</a>
<a href= "faq12.html">[To Section 12.0 - For Advanced Users]</a>
<a href= "faq14.html">[To Section 14.0 - Using disks in OpenBSD]</a>
</font>
<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../images/back.gif" border= "0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>$OpenBSD: faq13.html,v 1.14 1999/10/19 17:09:38 chris Exp $</small>
</p>
</body>
</html>
