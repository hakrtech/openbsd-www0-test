<html>
<head>
<title>10.0 - Gestión del Sistema</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 1998,2000 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<img alt="[OpenBSD]" height="30" width="141" src="../../images/smalltitle.gif">
<p>
<h2><font color="#e00000">10.0 - Gestión del Sistema</font><hr></h2>
</p>

<p>
<ul><h3>Tabla de Contenidos</h3>
<li><a href="faq10.html#10.1">10.1 - Cuando un Usuario Intenta Convertirse en
    el Superusuario root con <kbd>su(1)</kbd>, le Dice que Está en el Grupo
    Erróneo.</a> (&quot;wrong group&quot;).</li>
<li><a href="faq10.html#10.2">10.2 - ¿Cómo Puedo Duplicar un Sistema de
    Archivo?</a></li>
<li><a href="faq10.html#10.3">10.3 - ¿Cómo Inicio los D&aelig;mons con el
    Sistema?</a>
    ( <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&apropos=0&sektion=8&manpath=OpenBSD+Current&format=html">rc(8)</a> ).</li>
<li><a href="faq10.html#10.4">10.4 - ¿Por Qué Cuando los Usuarios Envían
    Correo a través de Mi Sistema OpenBSD les Niega el Acceso de Reenvío?</a>
    (&quot;relaying access denied&quot;).</li>
<li><a href="faq10.html#10.5">10.5 - He Configurado POP, pero Obtengo Errores
    Cuando Accedo a Mi Correo a través de POP.
    ¿Qué Puedo Hacer?</a></li>
<li><a href="faq10.html#10.6">10.6 - Cómo Configurar un Servidor HTTP Seguro
    Usando SSL(8).</a></li>
<li><a href="faq10.html#10.7">10.7 - He Hecho Cambios a /etc/passwd con
    vi(1), pero los Cambios No Funcionan.
    ¿Por Qué?</a></li>
<li><a href="faq10.html#10.8">10.8 - ¿Cómo Añado un Usuario?  ¿Cómo Elimino
    un Usuario?</a></li>
<li><a href="faq10.html#10.9">10.9 - ¿Cómo Puedo Crear una Cuenta Sólo
    FTP?</a></li>
<li><a href="faq10.html#10.10">10.10 - Configurar Cuotas para Limitar el Uso
    del Disco a los Usuarios.</a> 
    ( <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=quota&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">quota(1)</a> ).</li>
<li><a href="faq10.html#10.11">10.11 - Configurar un Cliente/Servidor
    Kerberos.</a></li>
<li><a href="faq10.html#10.12">10.12 - Configurar un Servidor de FTP
    Anónimo.</a></li>
<li><a href="faq10.html#10.13">10.13 - Confinar a los Usuarios a Sus
    Directorios de Usuario (&quot;home&quot;) en ftpd(8).</a>
</ul>
</p> 
<hr>

<br>

<p>
<a name="10.1">
<h2>10.1 - ¿Por Qué Me Dice Que Estoy en el Grupo Erróneo Cuando Intento
Ingresar como Usuario root con <kbd>su(1)</kbd>?</h2>
</a>
</p>

<p>
Para que un usuario normal se pueda convertir en el superusuario root, debe
añadirlo al grupo <kbd>wheel</kbd> a mano.
Esto se hace por motivos de seguridad, y se recomienda tener cuidado con los
usuarios a los que se otorgue este acceso especial.
En OpenBSD, los usuarios que pertenezcan al grupo <kbd>wheel</kbd> podrán
usar el programa de modo usuario (&quot;userland program&quot;)
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=su&apropos=0&sektion=1&format=html">su(1)</a>
para convertirse en el usuario root.
Los usuarios que no pertenezcan al grupo <kbd>wheel</kbd> no podrán usar
su(1).
A continuación puede ver el ejemplo de una entrada en <kbd>/etc/group</kbd>
para asociar al usuario <strong>ericj</strong> al grupo <kbd>wheel</kbd>.

<p>
Si va a crear un usuario nuevo con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&apropos=0&sektion=8&format=html">adduser(8)</a>,
puede asociarlo al grupo <kbd>wheel</kbd> desde el punto <tt>Invite
<i>user</i> into other groups:</tt>, simplemente contestando wheel.
Esto añadirá al usuario en la línea del grupo <kbd>wheel</kbd>, en el fichero
/etc/group, que quedará del siguiente modo:
</p>

<ul>
<pre>
wheel:*:0:root,ericj
</pre>
</ul>

<p>
Si lo que busca un modo de permitir a los usuarios acceso limitado a los 
privilegios del superusuario, sin tener que asociarlos al grupo
<kbd>wheel</kbd>, use
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sudo&sektion=8&format=html">sudo(8)</a>.
</p>

<p>
<a name="10.2">
<h2>10.2 - ¿Cómo Puedo Duplicar un Sistema de Archivo?</h2>
</a>
</p>

<p>
Para duplicar su sistema de archivo use
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dump&sektion=8&format=html">dump(8)</a> y
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=restore&sektion=8&format=html">restore(8)</a>.
Por ejemplo, para duplicar todo en el directorio <kbd>SRC</kbd> al directorio
<kbd>DST</kbd>, haga lo siguiente:
</p>

<ul>
<pre>
# <strong>cd /SRC; dump 0f - . | (cd /DST; restore -rf - )</strong>
</pre>
</ul>

<p>
<kbd>dump</kbd> está diseñado para ofrecer una gran variedad de posibilidades
para copias de respaldo/seguridad, y puede resultar excesivo si sólo quiere
duplicar un único sistema de archivo o parte de él.
La orden
<a href"http://www.openbsd.org/cgi-bin/man.cgi?query=tar&sektion=1&format=html">tar(1)</a>
puede resultar más rápida para una operación de este tipo.
El formato es muy parecido:

<ul>
<pre>
# <strong>cd /SRC; tar cf -  . | (cd /DST; tar xpf - )</strong>
</ul>
</pre>
<br>

<p><a name="10.3"></a>
<h2>10.3 - ¿Cómo Inicio los D&aelig;mons con el Sistema?
( <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&sektion=8&format=html">rc(8)</a> )</h2>
</p>

<p>
OpenBSD usa un inicio del estilo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&sektion=8&format=html">rc(8)</a>,
para lo que necesita unos cuantos ficheros claves para iniciar.
</p>

<ul>
   <li>/etc/rc - Guión (&quot;script&quot;) principal.
       No se debe editar.
   <li>/etc/rc.conf - Fichero de configuración usado por <i>/etc/rc</i> para
       saber qué d&aelig;mons debe iniciar con el sistema.
   <li>/etc/netstart - Guión usado para iniciar la red.
       No se debe editar.
   <li>/etc/rc.local - Guión usado para tareas de administración local.
       Aquí se debe almacenar información específica de la máquina anfitriona
       o de los d&aelig;mons.
   <li>/etc/rc.securelevel - Guión para ejecutar las órdenes que deben ser
       invocadas antes de los cambios en el nivel de seguridad.
       Vea <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=init&sektion=8&format=html">init(8)</a>.
   <li>/etc/rc.shutdown - Guión invocado por 
       <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=shutdown&sektion=8&apropos=0&manpath=OpenBSD+Current&format=html">shutdown(8)</a>.
       Añada en este fichero cualquier cosa que quiera hacer antes de cerrar 
       el sistema.
       Ver también
       <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.shutdown&sektion=8&format=html">rc.shutdown(8)</a>.
</ul>

<h3>Cómo funciona rc(8)?</h3>

<p>
Los ficheros más importantes para un administrador de sitemas son
<i>/etc/rc.conf</i>, <i>/etc/rc.local</i> y <i>/etc/rc.shutdown</i>.
Para que se pueda hacer una idea sobre cómo funciona el procedimiento de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&apropos=0&sektion=8&manpath=OpenBSD+Current&format=html">rc(8)</a>,
mire este flujo:
</p>

<ul>Después de arrancar el núcleo del sistema, se inicia <i>/etc/rc</i>.
   <li>Comprueba los sistemas de archivo (&quot;filesystems&quot;).
       Este paso se omitirá en caso de que exista fichero /etc/fastboot, pero
       no es conveniente hacerlo de este modo.
   <li>Lee las variables de configuración de <i>/etc/rc.conf</i>.
   <li>Monta los sistemas de archivo.
   <li>Limpia el sistema de archivo <i>/tmp</i> y preserva cualquier
       fichero creado por el editor.
   <li>Configura la red por medio de <i>/etc/netstart</i>:
      <ul>
         <li>Configura las interfaces.
	 <li>Configura &quot;hostname&quot;, &quot;domainname&quot;, etc.
      </ul>
   <li>Inicia los &quot;d&aelig;mons&quot;.
   <li>Lleva a cabo varias comprobaciones (&quot;quota&quot;,
       &quot;savecore&quot;, etc...).
   <li>Invoca y ejecuta los &quot;d&aelig;mons&quot; locales, como en
       <i>/etc/rc.local</i>.
</ul>

<h3>Iniciar los d&aelig;mons y servicios que vienen con OpenBSD</h3>

<p>
La mayoría de d&aelig;mons y servicios que vienen predefinidos con OpenBSD
pueden iniciarse con el arranque, editando el fichero de configuración
<i>/etc/rc.conf</i>.
Un ejemplo lo puede encontrar en el fichero
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/rc.conf">/etc/rc.conf</a> que viene por definición con el sistema,
en donde verá líneas parecidas a la siguiente:

</p>

<ul>
<pre>
ftpd_flags=NO           # for non-inetd use: ftpd_flags="-D"
</pre>
</ul>

<p>
Una línea como ésta nos indica que ftpd no se inicia con el sistema (al menos
no mediante <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&apropos=0&sektion=8&manpath=OpenBSD+Current&format=html">rc(8)</a>;  lea la
<a href="#10.12">sección sobre FTP Anónimo</a> para más información al
respecto).
En cualquier caso, cada línea va acompañada por un comentario que le mostrará
los indicadores para el uso <b>NORMAL</b> de ese d&aelig;mon o servicio.
Esto no significa que debe invocar el d&aelig;mon o servicio en cuestión con
esos indicadores.
Siempre puede usar
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=man&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">man(1)</a>
para ver cómo puede iniciar de cualquier otro modo que prefiera ese
d&aelig;mon o servicio.
Por ejemplo, vea la línea predefinida para la entrada para
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">httpd(8)</a>:
</p>

<ul>
<pre>
httpd_flags=NO          # for normal use: "" (or "-DSSL" after reading ssl(8))
</pre>
</ul>

<p>
Aquí puede ver con claridad que no es necesario ningún indicador para iniciar
httpd.
Por lo tanto, sólo será necesaria una línea como:
&quot;<b>httpd_flags=&quot;&quot;</b>&quot;.
Pero para iniciar httpd con ssl (lea la <a href="#10.6">sección sobre SSL</a>
o la página de manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&sektion=8&format=html">ssl(8)</a>),
necesitará una línea como: &quot;httpd_flags=&quot;"-DSSL&quot;&quot;.
</p>

<h3>Inicio y configuración de d&aelig;mons locales</h3>

<p>
Para instalar otros d&aelig;mons en el sistema por medio de los portes o
cualquier otro medio, debe usar el fichero <i>/etc/rc.local</i>.
Por ejemplo, supongamos que se ha instalado un d&aelig;mon que se encuentre 
en /usr/local/sbin/daemonx, y que se desea iniciar durante el arranque del
sistema.
Para ello pondría una entrada como la siguiente en <i>/etc/rc.local</i>:
</p>

<ul>
<pre>
if [ -x /usr/local/sbin/daemonx ]; then
             echo -n ' daemonx';       /usr/local/sbin/daemonx
fi
</pre>
</ul>

<p>
Desde este momento, el d&aelig;mon será invocado durante el arranque.
También podrá ver cualquier error durante el arranque;  un arranque normal
sin errores sólo mostraría una línea como ésta:
</p>

<ul>
<pre>
Starting local daemons: daemonx.
</pre>
</ul>

<h3>rc.shutdown</h3>

<p>
<i>/etc/rc.shutdown</i> es un guión (&quot;script&quot;) que se invoca al
cerrar el sistema.
Cualquier cosa que quiera hacer antes de que se cierre el sistema, la debe
añadir a este fichero.
Si tiene apm, también puede configurar &quot;powerdown=YES&quot;, que le dará
un resultado equivalente a &quot;shutdown -p&quot;.
</p>

<p>
<a name="10.4"></a>
<h2>10.4 - ¿Por Qué Cuando los Usuarios Envían Correo a través de Mi 
Sistema OpenBSD les Niega el Acceso de Reenvío?</h2>
</p>

<p>
Pruebe lo siguiente:
</p>
<ul>
<pre>
# <strong>cat /etc/sendmail.cf | grep relay-domains</strong>
</pre>
</ul>
<p>
La salida será parecida a ésta:
</p>
<ul>
<pre>
FR-o /etc/mail/relay-domains
</pre>
</ul>
<p>
Si este fichero no existe, créelo.
Necesitará introducir los huéspedes que estén enviando correo de forma remota
con la siguiente sintaxis:
</p>
<ul>
<pre>
.domain.com    #Permitir reenvío para/a cualquier huésped en domain.com
sub.domain.com #Permitir reenvío para/a sub.domain.com y cualquier
               #huésped en ese dominio
10.2           #Permitir reenvío desde todos los huéspedes en la red
               #IP 10.2.*.*
</pre>
</ul>
<p>
No olvide enviar una señal 'HangUP' a sendmail (una señal que hace que la
mayoría de d&aelig;mons vuelvan a leer sus ficheros de configuración):
</p>
<ul>
<pre>
# <Strong>kill -HUP `cat /var/run/sendmail.pid`</strong>
</pre>
</ul>
<p>

<h3>Más información</h3>

<p>
<ul>
<li><a href="http://www.sendmail.org/~ca/email/relayingdenied.html">http://www.sendmail.org/~ca/email/relayingdenied.html</a>
<li><a href="http://www.sendmail.org/tips/relaying.html">http://www.sendmail.org/tips/relaying.html</a>
<li><a href="http://www.sendmail.org/antispam.html">http://www.sendmail.org/antispam.html</a>
</ul>

<a name="10.5"></a>
<h2>10.5 - He Configurado POP, pero Obtengo Errores Cuando Accedo a Mi 
Correo a través de POP.  ¿Qué Puedo Hacer?</h2>
</p>

<p>
La mayoría de problemas relacionados con POP tienen que ver con ficheros
temporales y ficheros de cerrojo.
Si su servidor pop envía un mensaje de error como el siguiente:
</p>
<ul>
<pre>
-ERR Couldn't open temporary file, do you own it?
</pre>
</ul>
<p>
Intente configurar sus permisos así:
<ul>
<pre>
permisos en /var
drwxrwxr-x   2 bin     mail     512 May 26 20:08 mail


permisos en /var/mail
-rw-------   1 username   username        0 May 26 20:08 username
</pre>
</ul>
<p>
Otra cosa que puede comprobar es que realmente el usuario sea el propietario
de su propio fichero /var/mail.
Por supuesto, esto debería ser así (como por ejemplo, el propietario de
/var/mail/joe debería ser el usuario joe), pero si no está correctamente
configurado podría ser el causante del problema.

<p>
Dejar /var/mail con permisos de escritura para el grupo mail abre algunos
problemas de seguridad.
Es probable que nunca tenga problemas con eso.
¡Pero podría tenerlos!  (especialmente si su sitio es de alto rendimiento,
como un ISP, ...)
Pruebe a invocar 'cucipop' u otro d&aelig;mon de la colección de portes de
OpenBSD.
O podría ser que tuviera seleccionadas las opciones erróneas para su
d&aelig;mon pop (como &quot;dot locking&quot;).
O también es posible que necesitara cambiar el directorio que bloquea (aunque
entonces, el bloqueo sólo sería de valor para el d&aelig;mon POP).
</p>

<p>
<a name="10.6"></a>
<h2>10.6 - Cómo Configurar un Servidor HTTP Seguro Usando SSL(8)</h2>
</p>

<p>
A partir de la versión 2.6, OpenBSD incluye un httpd preparado para SSL.
Sin embargo, debido a las distintas patentes, algunas bibliotecas no pueden
ser incluidas.
Por lo tanto, para poder usar certificados RSA, debe instalar unas 
bibliotecas extras en su sistema.
Hay dos grupos de estas bibliotecas, dependiendo de su ubicación geográfica
(<strong>NOTA:</strong> Si ha instalado por FTP o cualquier otra instalación 
por red, es más que seguro que ya las tenga instaladas en su sistema).
Aquéllos que vivan fuera de los Estados Unidos deben usar un paquete llamado
<b>ssl26.tgz</b>, mientras que aquellos otros que vivan en los Estados Unidos
deben usar el paquete <b>sslUSA26.tgz</b>.
Estos paquetes se instalan con la utilidad
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pkg_add&sektion=1&format=html">pkg_add(1)</a>.
Por ejemplo, para instalar la versión de las bibliotecas para no residentes 
en EE.UU. use la siguiente orden, en la que ${arch} es la arquitectura de su
máquina ((<strong>NOTA:</strong> No está disponible para la arquitectura
Alpha, debido a su falta de bibliotecas compartidas).
</p> 

<div style="margin-left: 2em">
<pre>
# <strong>pkg_add ftp://ftp.openbsd.org/pub/OpenBSD/2.6/packages/${arch}/ssl26.tgz</strong>
</pre>
</div>

<p>
Para usarlas con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&sektion=8&format=html">httpd(8)</a>
primero debe haber generado un certificado, que se guardará en 
<i>/etc/ssl/private/</i>.
Los pasos que aquí se muestran están tomados, en parte, de la página de
manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&sektion=8&format=html">ssl(8)</a>.
Para más información, lea esta página.
En estas Preguntas Frecuentes tan sólo se resalta cómo generar un
certificado RSA para servidores de web, no un certificado DSA para
servidores.
Para saber cómo hacerlo, por favor lea la página de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&sektion=8&format=html">ssl(8)</a>.
</p> 

<p>
Para empezar, necesita generar su clave de servidor y su certificado.
Para usar las características de RSA, tiene que haber actualizado antes 
libssl.
Ahora ya puede generar su clave usando OpenSSL:
</p>

<div style="margin-left: 2em">
<pre>
# <strong>openssl genrsa -out /etc/ssl/private/server.key 1024</strong>
</pre>
</div>

<p>
O si desea puede cifrar la clave con una contraseña que tendrá que introducir
cuando inicie los servidores:
</p>

<div style="margin-left: 2em">
<pre>
# <strong>openssl genrsa -des3 -out /etc/ssl/private/server.key 1024</strong>
</pre>
</div>

<p>
El próximo paso es generar un &quot;Certificate Signing Request&quot;
(Requerimiento para Firmar el Certificado), que se usa para que una Autoridad
Certificadora (CA) firme su certificado.
Para ello use la orden:
</p>

<div style="margin-left: 2em">
<pre>
# <strong>openssl req -new -key /etc/ssl/private/server.key -out /etc/ssl/private/server.csr</strong>
</pre>
</div>

<p>
Este fichero <i>server.csr</i> se puede entregar a la Autoridad
Certificadora que firmará la clave.
Una de estas CAs es <b>Thawte Certification</b>, y la puede localizar en
<a href="http://www.thawte.com/">http://www.thawte.com/</a>.
Actualmente Thawte puede firmar sus claves RSA.
Está en marcha un procedimiento para poder firmar las claves DSA.
</p>

<p>
Si no se lo puede permitir, o si quiere firmar Vd. mismo el certificado, 
puede usar lo siguiente:
</p>

<div style="margin-left: 2em">
<pre>
# <strong>openssl x509 -req -days 365 -in /etc/ssl/private/server.csr \
       -signkey /etc/ssl/private/server.key -out /etc/ssl/server.crt</strong>
</pre>
</div>

<p>
Con <i>/etc/ssl/server.crt</i> y <i>/etc/ssl/private/server.key</i> en su
sitio, ya puede iniciar
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&sektion=8&format=html">httpd(8)</a>
con el indicador <b>-DSSL</b>, permitiendo transacciones https con su máquina
en el puerto 443.
</p> 

<p>
<a name="10.7"></a>
<h2>10.7 - He Hecho Cambios a /etc/passwd, pero los Cambios No Funcionan.
¿Por Qué?</h2>
</p>

<p>
Si edita /etc/passwd, cualquier cambio que haga se perderá.
OpenBSD genera el fichero /etc/passwd de forma dinámica con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pwd_mkdb&sektion=8&apropos=0">pwd_mkdb(8)</a>.
El fichero principal de las contraseñas en OpenBSD es /etc/master.passwd.
Según la página de manual de pwd_mkdb(8),

<ul>
<pre>
FILES
     /etc/master.passwd  current password file
     /etc/passwd         a Version 7 format password file
     /etc/pwd.db         insecure password database file
     /etc/pwd.db.tmp     temporary file
     /etc/spwd.db        secure password database file
     /etc/spwd.db.tmp    temporary file
</pre>
</ul>

<p>
En un fichero de contraseñas tradicional de Unix, como /etc/passwd, toda la
información, incluida la contraseña cifrada del usuario, está disponible para
cualquiera que pueda acceder al sistema (y es el primer objetivo para
programas como Crack).
4.4BSD introdujo el fichero master.passwd, que tiene un formato extendido
(con opciones adicionales que van más allá de las ofrecidas por /etc/passwd),
y sólo puede ser leido por root.
Para un acceso más rápido a los datos, las llamadas de las bibliotecas que
acceden a estos datos leen los ficheros /etc/pwd.db y /etc/spwd.db.

<p>
OpenBSD viene con una herramienta para la edición de su fichero de
contraseña,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&apropos=0&sektion=8&manpath=OpenBSD+Current&format=html">vipw(8)</a>.
Vipw usa
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vi&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">vi(1)</a>
(nuestro editor favorito, definido por $EDITOR) para editar el fichero
/etc/master.passwd.
Una vez haya terminado de editar, vuelve a crear los ficheros /etc/passwd,
/etc/pwd.db, y /etc/spwd.db conforme con los cambios que haya llevado a cabo.
Vipw también se encarga de bloquear estos ficheros, de modo que si alguna
otra persona intentara cambiarlos al mismo tiempo, le no le permitiría el
acceso.
</p>

<p>
<a name="10.8"></a>
<h2>10.8 - ¿Cómo Añado un Usuario?  ¿Cómo Elimino un Usuario?</h2>
</p>

<p>
En OpenBSD, la mejor manera para añadir un usuario es usando el guión
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html">adduser(8)</a>.
Puede configurarlo para que funcione como mejor le convenga, editando
<strong>/etc/adduser.conf</strong>.
También puede añadir usuarios a mano, pero adduser(8) es el modo en que se
recomienda hacerlo.
adduser(8) permite llevar a cabo comprobaciones de consistencia sobre los
ficheros <strong>/etc/passwd</strong> y <strong>/etc/group</strong>, y sobre
las bases de datos de la shell.
También generará para Vd. las entradas correspondientes y directorios HOME.
Incluso puede enviar un mensaje de bienvenida al usuario.
Todo esto se puede modificar según se desee.
Puede leer más información sobre cómo añadir usuarios en la página de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser_proc&sektion=8&format=html">adduser_proc(8)</a>.
</p>

<p>
Para eliminar usuarios debe usar la utilidad
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rmuser&sektion=8&format=html">rmuser(8)</a>.
Esto eliminará todo vestigio de un usuario.
Eliminará cualquier entrada en
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&apropos=0&sektion=1&manpath=OpenBSD+Current&format=html">crontab(1)</a>
relacionada con el usuario, su directorio HOME (siempre que el propietario de
éste sea el usuario en cuestión), y su correo.
También eliminará sus entradas en los ficheros <strong>/etc/passwd</strong> y
<strong>/etc/group</strong>.
</p>

<p>
<a name="10.9"></a>
<h2>10.9 - ¿Cómo Puedo Crear una Cuenta Sólo FTP (no FTP Anónimo)?</h2>
</p>

<p>
Existen varios modos de hacerlo, pero una manera muy común es añadir
/bin/false en el fichero <strong>/etc/shells</strong>.
Así, cuando cree el usuario, configure su shell como /bin/false y de este
modo no podrá ingresar de forma interactiva, pero podrá usar ftp.
adduser(8) le dará un directorio HOME que será, por definición,
/home/&lt;usuario&gt;.
Si le parece bien de esta forma, no necesita cambiarlo;  sin embargo, puede
configurarlo a cualquier otro directorio que Vd. desee.
Puede forzar que el usuario sólo pueda ver los ficheros en su directorio
HOME, añadiendo su nombre de usuario al fichero /etc/ftpchroot.
Mediante el uso de la opción -A para ftpd, puede restringir los ingresos para
que sólo sean posibles por ftpchroot.
</p>

<p>
<a name="10.10"></a>
<h2>10.10 - Configurar Cuotas</h2>
</p>

<p>
Las cuotas se usan para limitar el espacio del que disponen los usuarios en
sus discos.
Puede ser muy útil en situaciones en las que Vd. disponga de recursos
limitados.
Las cuotas se pueden configurar de dos maneras diferentes:
</p>

<p>
<ul>
   <li>Cuotas de Usuario</li>
   <li>Cuotas de Grupo</li>
</ul>
</p>

<p>
El primer paso para configurar cuotas es asegurarse de que la opción
<tt>QUOTA</tt> se encuentra activada en la configuración del núcleo de su
sistema.
Después necesita marcar los sistemas de archivo para los que vaya a
configurar las cuotas en /etc/fstab.
Debe usar las palabras clave <tt>userquota</tt> y <tt>groupquota</tt> para
marcar cada sistema de archivo en el que usará las cuotas.
Por definición, los ficheros <tt>quota.user</tt> y <tt>quota.group</tt> se
crearán en la raíz de ese sistema de archivo que tendrá la información sobre
las cuotas.
Esto se puede anular con la siguiente orden:
<code>userquota=/var/quotas/quota.user</code> ... o cualquier otro fichero en
el que quiera almacenar la información sobre cuotas.
He aquí un ejemplo de /etc/fstab con un sistema de archivo con cuotas de
usuario activadas:
</p>

<ul>
<pre>
/dev/wd0a / ffs rw,userquota=/var/quotas/quota.user 1 1
</pre>
</ul>

<p>
Ahora ya puede configurar las cuotas de usuario.
Para ello use la utilidad
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=edquota&sektion=8&format=html">edquota(8)</a>.
Una forma simple de usarlo es <strong>edquota &lt;usuario&gt;</strong>.
edquota(8) usará vi(1) para editar las cuotas a menos que la variable de
entorno EDITOR indique un editor diferente.
Por ejemplo:
</p>

<ul>
</pre>
# <strong>edquota ericj</strong>
</pre>
</ul>

<p>
Esto dará un resultado parecido al siguiente:
</p>

<ul>
<pre>
Quotas for user ericj:
/: blocks in use: 62, limits (soft = 0, hard = 0)
	inodes in use: 25, limits (soft = 0, hard = 0)
</pre>
</ul>

<p>
Para añadir límites, debe quedar algo como esto:
</p>

<ul>
<pre>
Quotas for user ericj:
/: blocks in use: 62, limits (soft = 1000, hard = 1050)
	inodes in use: 25, limits (soft = 0, hard = 0)
</pre>
</ul>

<p>
Aquí el límite &quot;soft&quot; es de 1.000 bloques, y el límite
&quot;hard&quot; de 1.050 bloques.
El límite &quot;soft&quot; es en el que el usuario sólo recibe un aviso
cuando lo sobrepasa, y tiene hasta su periodo de gracia para rebajar su uso
del disco por debajo de su límite.
Los periodos de gracia se pueden configurar usando la opción
<strong>-t</strong> con la orden edquota(8).
Después de que el periodo de gracia haya pasado, el límite &quot;soft&quot;
se toma como límite &quot;hard&quot;.
El resultado es un fallo de ubicación (&quot;allocation failure&quot;).
</p>

<p>
Una vez que las cuotas ya están configuradas, tiene que activarlas.
Para ello use
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=quotaon&sektion=8&format=html">quotaon(8)</a>.
Por ejemplo:
</p>

<ul>
<pre>
# <strong>quotaon -a</strong>
</pre>
</ul>

<p>
Esto repasará /etc/fstab para activar los sistemas de archivo con opciones de
cuota.
En cuanto las cuotas estén funcionando, puede verlas con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=quota&sektion=1&format=html">quota(1)</a>.
Si usa la orden <strong>quota &lt;usuario&gt;</strong> obtendrá la
información sobre el usuario que especifique.
Al ser invocada sin argumentos, la orden quota(8) le dará sus estadísticas de
cuotas.
Por ejemplo:
</p>

<ul>
<pre>
# <Strong>quota ericj</strong>
</pre>
</ul>

<p>
Dará como resultado algo como esto:
</p>

<ul>
<pre>
Disk quotas for user ericj (uid 1001): 
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
              /      62    1000    1050              27       0       0        
</pre>
</ul>

<p>
Las cuotas que estén configuradas en /etc/fstab iniciarán durante el arranque
por definición.
Para desactivarlo use:

<ul>
<pre># <strong>quotaoff -a</strong>
</pre>
</ul>
</p>

<p>
<a name="10.11"></a>
<h2>10.11 - Cómo Configurar Clientes y Servidores Kerberos en OpenBSD</h2>
</p>

<p>
Como usuario o administrador de sistemas OpenBSD, tiene suerte de que
KerberosIV es un componente preinstalado del sistema.
Ésta es una guía para configurar el servidor Kerberos así como el cliente.
</p>

<p>
Un punto *IMPORTANTÍSIMO* a recordar es que los clientes y servidores 
Kerberos deben tener sincronizados sus relojes del sistemas.
Si existe un lapsus de más de 5 minutos, recibirá errores extraños que no le
revelarán que han sido causados por un lapsus de tiempo, como:
</p>

<ul>
<pre>
kinit: Can't send request (send_to_kdc) 
</pre>
</ul>

Otro error más exacto es:

<ul>
<pre>
kauth: Time is out of bounds (krb_rd_req) 
</pre>
</ul>

<p>
Una forma fácil para sincronizar los relojes del sistema es con xntpd,
disponible desde el árbol de portes en
<strong>/usr/ports/sysutils/xntpd/</strong>.
</p>

Este documento asume que tiene unos conocimientos anterior de los conceptos
detrás de Kerberos.
Para una buena referencia, simple de entender, lea:

<ul>
<li><a href="http://www.freebsd.org/handbook/kerberos.html">The FreeBSD handbook</a> </li>
<li>Use la orden <strong>info kth-krb</strong></li>
<li><a href="http://web.mit.edu/kerberos/www/dialogue.html">Designing an Authentication System: a Dialogue in Four Scenes</a></li>
<li><a href="http://web.mit.edu/kerberos/www/papers.html#krb4">Papers and Documentation Describing KerberosIV</a></li>
</ul>O el libro<ul>
<li><a href="http://www.amazon.com/exec/obidos/ASIN/0130614661/qid%3D930594963/">Network Security Private Communication in a Public World [Kaufman, Perlman, Speciner, 1995]</a></li> 
</ul>
</ul>

<h3>Cómo configurar el servidor y el campo de acción de Kerberos IV</h3>

<p>
Configuraremos el campo de acción de CIARASYSTEMS.COM con
avalanche.ciarasystems.com como servidor principal.
</p>

<p>
Para empezar, tendremos que editar nuestros ficheros de configuración.
Estos ficheros están ubicados en <tt>/etc/kerberosIV/</tt>.
Los dos ficheros que nos interesan son <i>krb.realms</i> y <i>krb.conf</i>.
Empecemos con <i>krb.conf</i>.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>cat krb.conf</strong>
CIARASYSTEMS.COM
CIARASYSTEMS.COM avalanche.ciarasystems.com admin server
</pre>
</ul>

<p>
Como puede ver, esto indica a kerberos que el dominio es CIARASYSTEMS.COM (o
campo de acción lógico) y que dentro de ese dominio, avalanche es el servidor
de administración.
A continuación veremos <i>krb.realms</i>.
Para más información lea la página de manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=krb.conf&sektion=5&format=html">krb.conf</a>.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>cat krb.realms</strong>
avalanche.ciarasystems.com      CIARASYSTEMS.COM
.ciarasystems.com               CIARASYSTEMS.COM
</pre>
</ul>

<p>
krb.realms provee una traducción del nombre del huésped al nombre del campo 
de acción de Kerberos para los servicios provistos por ese huésped.
Cada línea del fichero de traducción es de una de las siguientes formas (el
nombre del dominio debería ser del tipo .XXX.YYY).
Así, en este ejemplo, avalanche es el nombre de huésped de una máquina en el
campo de acción CIARASYSTEMS.COM, y .ciarasystems.com es el nombre del
dominio en el campo de acción CIARASYSTEMS.COM.
Para más información lea la página de manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=krb.realms&sektion=5&format=html">krb.realms</a>.
</p>

<p>
A continuación ejecutaremos
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kbd_init&sektion=8&format=html">kdb_init(8)</a>
para crear una base de datos inicial de Kerberos.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>kdb_init</strong>
Realm name [default  NO.DEFAULT.REALM ]: CIARASYSTEMS.COM
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.

Enter Kerberos master password: <strong>not shown</strong>
Verifying password -
Enter Kerberos master password:
</pre>
</ul>

<p>
Lo siguiente que tendremos que usar es
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kstash&sektion=8&format=html">kstash(8)</a>,
que se utiliza para guardar clave maestra de la base de datos, del centro de
distribución de claves (KDC), en el fichero de caché de la clave maestra.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>kstash</strong>
Enter Kerberos master password:

Current Kerberos master key version is 1.

Master key entered.  BEWARE!
Wrote master key to /etc/kerberosIV/master_key
</pre>

De este modo se guarda la contraseña maestra cifrada en
/etc/kerberosIV/master_key.

<p>
A continuación necesitaremos añadir a la base de datos dos 
&quot;principal&quot; por cada uno de los sistemas que será asegurado 
con Kerberos.
Sus nombres son <i>kpasswd</i> y <i>rcmd</i>.
Estos dos &quot;principal&quot; se harán para cada sistema, siendo
&quot;instance&quot; el nombre de cada sistema.

Estos d&aelig;mons, <i>kpasswd</i> y <i>rcmd</i>, permiten que otros sistemas
cambien las contraseñas de Kerberos y ejecuten órdenes como <i>rcp</i>,
<i>rlogin</i> y <i>rsh</i>.

<pre>
# <b>kdb_edit</b>
Opening database...
    
Enter Kerberos master key:
    
Current Kerberos master key version is 1.
    
Master key entered.  BEWARE!

Previous or default values are in [brackets] ,
enter return to leave the same, or new value.

Principal name: <strong>passwd</strong>
Instance: <strong>avalanche</strong>

&lt;Not found&gt;, Create [y] ? <strong>y</strong>

Principal: passwd, Instance: avalanche, kdc_key_ver: 1
New Password:            <strong>&lt;----- Use 'RANDOM' como contraseña</strong>
Verifying password -
New Password:

Random password [y] ? <strong>y</strong>

Principal's new key version = 1
Expiration date (enter yyyy-mm-dd) [ 1999-12-31 ] ? <strong>2001-12-31</strong>
Max ticket lifetime (*5 minutes) [ 255 ] ?
Attributes [ 0 ] ?
Edit O.K.


Principal name: <strong>rcmd</strong>
Instance: <strong>avalanche</strong>

&lt;Not found&gt;, Create [y] ? <strong>y</strong>
Principal: rcmd, Instance: avalanche, kdc_key_ver: 1
New Password:            <strong>&lt;----- Use 'RANDOM' como contraseña</strong>
Verifying password -
New Password:

Random password [y] ? <Strong>y</strong>

Principal's new key version = 1
Expiration date (enter yyyy-mm-dd) [ 1999-12-31 ] ? <strong>2001-12-31</strong>
Max ticket lifetime (*5 minutes) [ 255 ] ?
Attributes [ 0 ] ?
Edit O.K.
Principal name:       <strong>&lt;----- Pulse &lt;INTRO&gt; para acabar</strong>

</pre>
</ul>

<p>
Un fichero srvtab es fichero de la clave de servicio.
Éstas deben extraerse de la base de datos del centro de distribución de
claves de Kerberos para que los servicions autentiquen usando Kerberos.
Por cada uno de los nombres de huésped (&quot;hostname&quot;) especificados
en la línea de órdenes,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ext_srvtab&sektion=8&format=html">ext_srvtab(8)</a>
genera el fichero de la clave de servicio hostname-new-srvtab, que contiene
todas las entradas en la base de datos con un campo &quot;instance&quot; del
nombre del huésped.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <Strong>ext_srvtab avalanche</strong>

Enter Kerberos master password:

Current Kerberos master key version is 1.

Master key entered.  BEWARE!
Generating 'avalanche-new-srvtab'....

[root@avalanche kerberosIV] <strong>mv avalanche-new-srvtab srvtab</strong>
[root@avalanche kerberosIV] <strong>chmod 600 srvtab</strong>
</pre>
</ul>

<p>
Ahora podemos añadir usuarios a nuestra base de datos.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>kdb_edit</strong>
Opening database...
    
Enter Kerberos master key:
    
Current Kerberos master key version is 1.
    
Master key entered.  BEWARE!
Previous or default values are in [brackets] ,
enter return to leave the same, or new value.
    
Principal name: <strong>jeremie</strong>
Instance:
    
&lt;Not found&gt;, Create [y] ? <strong>y</strong>
    
Principal: jeremie, Instance: , kdc_key_ver: 1
New Password:                &lt;---- introduzca una contraseña segura aquí
Verifying password
    
New Password:                &lt;---- vuelva a introducir la contraseña
Principal's new key version = 1
Expiration date (enter yyyy-mm-dd) [ 2000-01-01 ] ?
Max ticket lifetime (*5 minutes) [ 255 ] ?
Attributes [ 0 ] ?
Edit O.K.
Principal name:          &lt;---- una entrada vacía aquí causará que salga
</pre>
</ul>

<p>
Ahora ya están configurados todos los &quot;particular&quot;.
Todo lo que queda por hacer es activar la carga del servidor Kerberos durante
el arranque y activar los d&aelig;mons &laquo;kerberizados&raquo;.
</p>

<p>
Escriba en /etc/rc.conf:

<ul>
<tt>kerberos_server=YES</tt>
</ul>

y en /etc/inetd.conf active las siguientes líneas (quitando el signo del
comentario):

<ul>
<pre>
telnet       stream  tcp     nowait  root    /usr/libexec/telnetd    telnetd -k
klogin       stream  tcp     nowait  root    /usr/libexec/rlogind    rlogind -k
kshell       stream  tcp     nowait  root    /usr/libexec/rshd       rshd -k
kauth        stream  tcp     nowait  root    /usr/libexec/kauthd     kauthd
</pre>
</ul>

Y reinicie o:

<ul>
<pre>
[root@avalanche /] <strong>kill -HUP `cat /var/run/inetd.pid`</strong>
[root@avalanche /] <strong>/usr/libexec/kerberos &gt;&gt; /var/log/kerberos.log &amp;</strong>
[root@avalanche /] <strong>/usr/libexec/kadmind -n &gt;&gt; /var/log/kadmind.log &amp;</strong>
</pre>
</ul>
</p>

<p>
Nota: ésta es una configuración del servidor bastante simple.
Generalmente se configuran servidores redundantes (y servidores esclavos)
para que si un servidor cayera, todos los servicios que dependen de Kerberos
se mantuvieran.
También podemos añadir privilegios de 'su' a un &quot;principal&quot;
específico;  vea el
<a href="http://www.freebsd.org/handbook/kerberos.html#AEN4957">FreeBSD
Handbook</a> para más información.
</p>

<h3>Cómo &laquo;kerberizar&raquo; una estación de trabajo cliente</h3>

<p>
Configuraremos la estación de trabajo llamada <i>gatekeeper</i> para que esté
en el campo de acción de CIARASYSTEMS.COM, con avalanche.ciarasystems.com
como el servidor principal.
</p>

<p>
Para empezar, necesitamos configurar los ficheros <i>krb.conf</i> y
<i>krb.realms</i> como para la máquina anterior.
Esto es para que <i>gatekeeper</i> sepa qué servidor es el KDC y en qué
dominio se encuentra.
He aquí el contenido de los ficheros:
</p>

<ul>
<pre>
[root@gatekeeper kerberosIV] <strong>cat krb.conf</strong>
CIARASYSTEMS.COM
CIARASYSTEMS.COM avalanche.ciarasystems.com admin server

[root@gatekeeper kerberosIV] <strong>cat krb.realms</strong>
avalanche.ciarasystems.com      CIARASYSTEMS.COM
.ciarasystems.com               CIARASYSTEMS.COM
</pre>
</ul>

<p>
Eso ha sido la configuración, ahora necesitamos iniciar kerberos.
Para obtener un ticket usaremos
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kinit&sektion=1&format=html">kinit(1)</a>.
</p>

<ul>
<pre>
xyz:jeremie% <Strong>kinit</strong>
The OpenBSD Project (gatekeeper)
Kerberos Initialization
Kerberos name: <strong>jeremie</strong>
Password:
</pre></strong>
</ul>

<p>
Ahora que nos hemos identificado, podemos ver una lista de nuestros tickets
con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=klist&sektion=1&format=html">klist(1)</a>.
</p>

<ul>
<pre>
xyz:jeremie$ <strong>klist</strong>
Ticket file:    /tmp/tkt1000
Principal:      jeremie@CIARASYSTEMS.COM

  Issued           Expires          Principal
Jun 28 01:03:25  Jun 28 11:03:25  krbtgt.CIARASYSTEMS.COM@CIARASYSTEMS.COM
</pre>
</ul>

<p>
Parece que ya está todo.
Lo único que queda por hacer es probarlo.
En los siguientes ejemplos lo probaremos con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rlogin&apropos=0&sektion=1&manpath=OpenBSD+Current&format=html">rlogin(1)</a> y
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&apropos=0&sektion=1&manpath=OpenBSD+Current&format=html">telnet(1)</a>.
</p>

<ul>
<pre>
xyz:jeremie% <Strong>telnet avalanche</strong>
Trying 192.168.0.38...
Connected to avalanche.
Escape character is '^]'.
[ Trying mutual KERBEROS4 ... ]
[ Kerberos V4 accepts you ]
[ Kerberos V4 challenge successful ]
Last login: Sun Jun 27 22:52:25 on ttyp1 from gatekeeper
Warning: no Kerberos tickets issued.
OpenBSD 2.5 (AVALANCHE) #5: Tue Apr  6 01:18:16 EDT 1999
</pre>
</ul>

y 

<ul>
<pre>
xyz:jeremie% <Strong>rlogin avalanche</strong>
Last login: Sun Jun 27 22:53:39 on ttyp1 from gatekeeper
Warning: no Kerberos tickets issued.
OpenBSD 2.5 (AVALANCHE) #5: Tue Apr  6 01:18:16 EDT 1999
</pre>
</strong>
</ul>

<p>
Se ve claro que está usando Kerberos para autenticar la sesión de rlogin.
Para eliminar los tickets de la sesión usaremos
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kdestroy&sektion=1&format=html">kdestroy(1)</a>.
Por ejemplo:
</p>

<ul>
<pre>
xyz:jeremie% <strong>kdestroy</strong>
Tickets destroyed.
xyz:jeremie% <Strong>rlogin avalanche</strong>
krcmd: No ticket file (tf_util)
rlogin: warning, using standard rlogin: can't provide Kerberos auth data.
avalanche: Connection refused
</pre>
</ul>

<p>
No se preocupe por el mensaje 'Warning: no Kerberos tickets issued'.
Esto es debido a que sólo estamos haciendo autenticación con kerberos, no
pases de tickets.
Si quiere pases de tickets, use
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssh&sektion=1&format=html">OpenSSH</a> que tiene soporte para ello.
KerberosIV de serie tampoco tiene soporte para pases tgt, sólo la
implementación de krb4 de kaserver AFS, ya que KerberosIV normal comprueba
con kdc las direcciones IP de los clientes en la lista del ticket.
</p>

<p>
<a name="10.12"></a>
<h2>10.12 - Configurar Servicios de FTP Anónimo</h2>
</p>

<p>
FTP Anónimo permite a los usuarios que carecen de cuentas en el sistema,
acceder a ficheros en su máquina mediante el &laquo;Protocolo de
Transferencia de Ficheros&raquo; (FTP, &quot;File Transfer Protocol&quot;).
Esta sección ofrece un resumen sobre cómo configurar el servidor de ftp
anónimo, su ingreso, etc...
</p>

<h3>Añadir la cuenta de FTP</h3>

<p>
Para empezar, necesita tener una cuenta &quot;ftp&quot; en su sistema.
Esta cuenta no debe tener una contraseña utilizable.
Aquí configuraremos el directorio de ingreso como /home/ftp, pero puede
ponerlos donde quiera que desee.
Cuando use ftp anónimo, el d&aelig;mon de ftp ejecutará chroot sobre sí 
mismo para cambiar la directorio del usuario de ftp.
Puede leer más sobre esto en las páginas de manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&sektion=8&format=html">ftp(8)</a> y
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chroot&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">chroot(2)</a>.
He aquí un ejemplo sobre cómo añadir el usuario <i>ftp</i>.
Para ello usaremos
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html">adduser(8)</a>.
También necesitamos añadir /bin/false a nuestro fichero <i>/etc/shells</i>,
que será la &quot;shell&quot; que configuraremos para el usuario ftp.
Así no tendrán permiso para ingresar, aunque les daremos una contraseña
vacía.
Para ello puede hacer simplemente lo siguiente:

<pre>
echo /bin/false &gt;&gt; /etc/shells
</pre>

También, si quiere que esa shell se muestre durante las preguntas de la orden
adduser, necesita modificar <i>/etc/adduser.conf</i>.
</p>

<ul>
<pre>
oshibana# <strong>adduser</strong>
Use option ``-silent'' if you don't want see all warnings &amp; questions.

Reading /etc/shells
Check /etc/master.passwd
Check /etc/group

Ok, let's go.
Don't worry about mistakes. I will give you the chance later to correct any input.
Enter username [a-z0-9_]: <strong>ftp</strong>
Enter full name []: <strong>anonymous ftp</strong>
Enter shell csh false ksh nologin sh tcsh zsh [sh]: <strong>false</strong>
Uid [1002]:
Login group ftp [ftp]:
Login group is ``ftp''. Invite ftp into other groups: guest no
[no]: <strong>no</strong>
Enter password []:
Use an empty password? (y/n) [y]: <strong>y</strong>

Name:     ftp
Password: ****
Fullname: anonymous ftp
Uid:      1002
Gid:      1002 (ftp)
Groups:   ftp
HOME:     /home/ftp
Shell:    /usr/bin/false
OK? (y/n) [y]: <strong>y</strong>
Added user ``ftp''
Copy files from /usr/share/skel to /home/ftp
Add another user? (y/n) [y]: <strong>n</strong>
Goodbye!
</pre>
</ul>

<h3>Configuración del directorio</h3>

<p>
Además del usuario, ha creado el directorio <i>/home/ftp</i>.
Es lo que queremos, pero hay algunos cambios que tendremos que hacer para
tenerlo preparado para ftp anónimo.
Estos cambios se explican en la página de manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&sektion=8&format=html">ftp(8)</a>.
</p>

<ul>
<b>No</b> necesita crear un directorio /home/ftp/usr o /home/ftp/bin.<br>

<li><i>/home/ftp</i> - Es el directorio principal.
		       Su propietario debe ser root, y los permisos deben ser
		       555.</li>
<li><i>/home/ftp/etc</i> - Es totalmente opcional y no se recomienda, ya que
			   sólo sirve para dar información sobre los usuarios
			   existentes en un sistema.
			   Si quiere que parezca que su directorio de ftp
			   anónimo contiene usuarios reales adjuntos a sus
			   ficheros, debería copiar /etc/pwd.db y /etc/group
			   a este directorio.
			   Este directorio debería ser de modo 511, y los dos
			   ficheros de modo 444.
			   Éstos se usan para dar al propietario nombres en
			   lugar de números.
			   No existen contraseñas almacenadas en pwd.db, ya
			   que están todas en spwd.db, así que no las copie
			   ahí.</li>
<li><i>/home/ftp/pub</i> - Éste es el directorio estándar para ubicar los
			   ficheros que quiera compartir.
			   Este directorio también debería ser de modo 555.
</ul>

<p> 
Note que el propietario de todos estos directorios debería ser ''root''.
He aquí una lista de cómo deberían ser los directorios después de ser
creados:
</p>

<ul>
<pre>
oshibana# pwd 
/home
oshibana# ls -laR ftp
total 5
dr-xr-xr-x  5 root  ftp    512 Jul  6 11:33 .
drwxr-xr-x  7 root  wheel  512 Jul  6 10:58 ..
dr-x--x--x  2 root  ftp    512 Jul  6 11:34 etc
dr-xr-xr-x  2 root  ftp    512 Jul  6 11:33 pub

ftp/etc:
total 43
dr-x--x--x  2 root  ftp    512 Jul  6 11:34 .
dr-xr-xr-x  5 root  ftp    512 Jul  6 11:33 ..
-r--r--r--  1 root  ftp    316 Jul  6 11:34 group
-r--r--r--  1 root  ftp  40960 Jul  6 11:34 pwd.db

ftp/pub:
total 2
dr-xr-xr-x  2 root  ftp  512 Jul  6 11:33 .
dr-xr-xr-x  5 root  ftp  512 Jul  6 11:33 ..
</pre>
</ul>

<h3>Inicio del servidor e ingreso</h3>

<p>
Con <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">ftpd(8)</a>
puede escoger entre invocarlo desde
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">inetd(8)</a> 
o lo pueden iniciar los guiones de configuración de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">rc(8)</a>.
En estos ejemplos se verá cómo se inicia nuestro d&aelig;mon desde
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/inetd.conf">inetd.conf</a>.
Primero debemos familiarizarnos con algunas de las opciones de ftpd.
La línea por definición de <i>/etc/inetd.conf</i> es:
</p>

<ul>
<pre>
<strong>
ftp             stream  tcp     nowait  root    /usr/libexec/ftpd       ftpd -US
</strong>
</pre>
</ul>

<p>
En este caso ftpd se invoca con <i>-US</i>.
Así se grabarán las conexiones anónimas a <i>/var/log/ftpd</i>, y las
sesiones concurrentes a <i>/var/run/utmp</i>.
De este modo, podremos ver estas sesiones con la orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=who&apropos=0&sektion=0&manpath=OpenBSD+Current&format=html">who(1)</a>.
Es posible que algunos sólo quisieran tener un servidor anónimo, y desactivar
ftp para usuarios.
Para ello debe invocar ftpd con la opción <i>-A</i>.
He aquí una línea que inicia ftpd para conexiones anónimas sólo.
También usa <i>-ll</i> para grabar cada conexión a syslog, junto con las
órdenes de ftp 'get', 'retrieve', etc.
</p>

<ul>
<pre>
<strong>
ftp             stream  tcp     nowait  root    /usr/libexec/tcpd       ftpd -llUSA
</strong>
</pre>
</ul>

<p>
Nota:  Para aquéllos que usen servidores de ftp de MUCHO tráfico, es
conveniente que no invoquen ftpd desde inetd.conf.
La mejor opción es comentar la línea de ftpd de inetd.conf e iniciar ftpd
desde rc.conf junto con la opción <i>-D</i>.
De este modo iniciarán ftpd como un d&aelig;mon, y será más simple que
iniciarlo desde inetd.
A continuación viene un ejemplo de cómo iniciarlo desde rc.conf:
</p>

<ul>
<pre>
ftpd_flags="-DllUSA"           # for non-inetd use: ftpd_flags="-D"
</pre>
</ul>

<p>
Esto sólo funcionará si ha desactivado ftpd en <i>/etc/inetd.conf</i>.
</p>

<h3>Otros ficheros de importancia</h3>

<p>
<ul>
   <li><i>/etc/ftpwelcome</i> - Contiene el mensaje de bienvenida que verán
                                al conectar con su servidor ftp.</li>
   <li><i>/etc/motd</i> - Contiene el mensaje que verán después de haber
                          ingresado en su servidor ftp.</li>
   <li><i>.message</i> - Este fichero se puede ubicar en cualquier
                         directorio, y cuando alguien entre en ese
			 directorio, verá el mensaje que contiene.</li>
</ul>


<p>
<a name="10.13"></a>
<h2>10.13 - Confinar a los Usuarios a Sus Directorios de Usuario 
(&quot;home&quot;) en ftpd(8)</h2>
</p>

<p>
En OpenBSD,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&sektion=8&format=html">ftpd(8)</a>
está configurado por definición para poder gestionar esto de modo muy fácil.
Se hace por medio del fichero <strong>/etc/ftpchroot</strong>.
Como los usuarios no son siempre fiables, puede ser necesario restringir su
entrada en otros directorios que no sean el propio.
Esto NO está activado por definición.
He aquí un ejemplo de cómo responde por definición:
</p>

<ul>
<pre>
$ <strong>ftp localhost</strong>
Connected to localhost.
220 oshibana FTP server (Version 6.4/OpenBSD) ready.
Name (localhost:ericj): <strong>ericj</strong>
331 Password required for ericj.
Password: <strong>*********</strong>
230- OpenBSD 2.6 (GENERIC) #690: Fri Oct 29 16:32:17 MDT 1999
230- 
230- Welcome to OpenBSD: The proactively secure Unix-like operating system.
230- 
230- Please use the sendbug(1) utility to report bugs in the system.
230- Before reporting a bug, please try to reproduce it with the latest
230- version of the code.  With bug reports, please try to ensure that
230- enough information to reproduce the problem is enclosed, and if a
230- known fix for it exists, include that as well.
230- 
230 User ericj logged in.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; <strong>cd /</strong>
250 CWD command successful.
ftp&gt; <strong>ls</strong>
227 Entering Passive Mode (127,0,0,1,60,7)
150 Opening ASCII mode data connection for 'file list'.
altroot
bin
dev
etc
home
mnt
root
sbin
stand
tmp
usr
var
bsd
sys
boot
226 Transfer complete.
ftp&gt; <strong>quit</strong>
221 Goodbye.
</pre>
</ul>

<p>
Como puede ver, el acceso está permitido para todo el servidor.
En un mundo perfecto esto debería ser así, deberíamos poder fiarnos de todos
los usuarios, pero no es así.
Para limitar un usuario, añada su nombre al fichero
<strong>/etc/ftpchroot</strong>.
He aquí un ejemplo que muestra cómo restringir al usuario &quot;ericj&quot;:
</p>

<ul>
<pre>
$ <strong>cat /etc/ftpchroot</strong>
#
# list of users (one per line) given ftp access to a chrooted area.
# read by ftpd(8).
ericj
</pre>
</ul>

<p>
Esto es suficiente para evitar que el usuario &quot;ericj&quot; se escape de
su propio directorio.
Como puede ver en el siguiente ejemplo, el directorio / ha cambiado de
repente a su directorio de usuario.
</p>

<ul>
<pre>
$ <strong>ftp localhost</strong>
Connected to localhost.
220 oshibana FTP server (Version 6.4/OpenBSD) ready.
Name (localhost:ericj): <strong>ericj</strong>
331 Password required for ericj.
Password: <strong>*********</strong>
230 User ericj logged in.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; <strong>cd /</strong>
250 CWD command successful.
ftp&gt; <strong>ls</strong>
227 Entering Passive Mode (127,0,0,1,92,171)
150 Opening ASCII mode data connection for 'file list'.
.login
.mailrc
.profile
.rhosts
.ssh
.cshrc
work
mail
src
226 Transfer complete.
ftp&gt; <strong>quit</strong>
221 Goodbye.
</pre>
</ul>

<p>
<font color="#0000e0">
<a href="index.html">[Volver al Índice Principal]</a>
<a href="faq9.html">[Sección 9.0 - Consejos para Usuarios de Linux]</a>
<a href="faq11.html">[Sección 11.0 - Afinar el Rendimiento]</a>
</font>
</p>
<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[&iacute;ndice]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: faq10.html,v 1.40 2000/03/25 00:05:04 wvdputte Exp ]<br>
$Translation: faq10.html,v 1.3 2000/04/29 17:58:05 horacio Exp $<br>
$OpenBSD: faq10.html,v 1.3 2000/04/30 20:30:15 wvdputte Exp $
</small>
</p>
</body>
</html>
