<html>
<head>
<title>6.0 - Redes</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta name="resource-type" content="documento">
<meta name="description"   content="Preguntas Frecuentes de OpenBSD">
<meta name="keywords"      content="openbsd,faq,documentación">
<meta name="distribution"  content="global">
<meta name="copyright"     content="Este documento es copyright 1998-2000 de OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238E">

<img alt="[OpenBSD]" height="30" width="141" src="../../images/smalltitle.gif">
<p>
<h2><font color="#e00000">6.0 - Redes</font><hr></h2>
</p>

<p>
<ul><h3>Tabla de contenidos</h3>
<li><a href="#6.0.1">6.0.1 - Introducci&oacute;n</a>
<li><a href="#6.1">6.1 - Configuraci&oacute;n inicial de la red</a>
<li><a href="#6.2">6.2 - Filtros IP</a>
<li><a href="#6.3">6.3 - Traducci&oacute;n de Direcciones de Red
    (NAT)</a>
<li><a href="#6.4">6.4 - Protocolo de Configuraci&oacute;n para
    H&uacute;espedes Din&aacute;micos
    (DHCP)</a>
<li><a href="#6.5">6.5 - Protocolo Punto a Punto (PPP)</a>
<li><a href="#6.6">6.6 - Afinar par&aacute;metros de red</a>
<li><a href="#6.7">6.7 - Usar NFS</a>
<li><a href= "#6.8">6.8 - Servicio de Nombres de Dominio  - DNS, BIND,
    y named</a>
<li><a href="#6.9">6.9 - Configuraci&oacute;n de una conexi&oacute;n
    PPTP en OpenBSD</a>
</ul>
</p>
<hr>

<br>
<p>
<a name="6.0.1"></a>
<h2>6.0.1 - Introducci&oacute;n</h2>
<p>
Para la comprensi&oacute;n de la mayor parte de este documento
ser&aacute; de gran ayuda que haya leido y, por lo menos, asimilado en
parte el cap&iacute;tulo
<a href="faq5.html">&laquo;Configuraci&oacute;n del N&uacute;cleo&raquo;</a> 
de las Preguntas Frecuentes, y las p&aacute;ginas de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&apropos=0&sektion=8&format=html">ifconfig(8)</a> 
y
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a>.

<p>
Si es Vd. un administrador de redes y est&aacute; configurando
protocolos de enrutamiento, si est&aacute; usando su sistema OpenBSD
como un enrutador, si necesita conocer m&aacute;s a fondo los
protocolos de redes IP, entonces es realmente necesario que lea
<a href="http://www.3com.com/solutions/en_US/ncs/501302.html">Understanding IP addressing</a>.
&iexcl;&Eacute;ste es un excelente documento que contiene conocimientos
fundamentales sobre redes de IP!

<p>
Si est&aacute; trabajando con aplicaciones como servidores de http,
servidores de ftp, y servidores de correo, se puede beneficiar en gran
medida de la lectura de los
<a href="http://the.rfceditor.org/rfc.html">RFC</a>.

<p>
<i>(Nota: existe un proyecto de traducci&oacute;n de RFCs al castellano
conocido como
<a href="http://www.arrakis.es/~pjleon/rfc-es/index.html">RFC-ES</a>)</i>

<p>
Lo m&aacute;s seguro es que no los pueda leer todos.  Seleccione
algunos temas que le interesen, o que use en su entorno de red.
L&eacute;alos y averig&uuml;e c&oacute;mo deber&iacute;an funcionar.
Los RFC definen much&iacute;simas (miles) de las normas para protocolos
en internet y c&oacute;mo se supone que deben funcionar.

<a name="6.1"></a>
<h2>6.1 - Configuraci&oacute;n inicial de la red</h2>

<p>
<a name="6.1.1"></a>
<h3>6.1.1 - Idenficaci&oacute;n y configuraci&oacute;n de la interfaces
de red</h3>
</p>

<p>
Lo primero que debe hacer para empezar es identificar su interfaz de
red.  En OpenBSD las interfaces se designan por el tipo de tarjeta, no
por el tipo de conexi&oacute;n.  Puede ver su tarjeta de red iniciar
durante el arranque, o despu&eacute;s del arranque usando la orden
<strong>dmesg(8)</strong>.  Tambi&eacute;n puede ver su interfaz de red
usando la orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8&format=html">ifconfig(8)</a>.
Por ejemplo, vea a continuaci&oacute;n la salida originada por dmesg
para una tarjeta de red ne2k, que usa un nombre de dispositivo ne.
</p>

<ul>
<pre>
ne3 at pcmcia1 function 0 "Linksys, EtherFast 10/100 PC Card (PCMPC100), " port 0x340/16 irq 9
ne3: address 00:e0:98:04:95:ba
</pre>
</ul>

<p>
Si no sabe cu&aacute;l es el nombre de su dispositivo, aqu&iacute;
tiene una lista de tarjetas comunes con sus nombres de dispositivo.
</p>

<ul>
<li>ne2000 Network Cards - <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ne&sektion=4&format=html">ne</a> 
<li>3Com EtherLink III and Fast EtherLink III Ethernet - <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ep&sektion=4&format=html">ep</a>
<li>3Com EtherLink XL and Fast EtherLink XL Ethernet (3C9xx) - <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=xl&sektion=4&format=html">xl</a>
<li>Intel 82586 chip Ethernet device driver - <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ie&sektion=4&format=html">ie</a>
<ul>Que incluyen tarjetas como:
	<li>3Com 3C507
	<li>AT&amp;T StarLAN 10
	<li>AT&amp;T EN100
	<li>AT&amp;T StarLan Fiber
	<li>Intel EtherExpress 16
</ul>

<li>Controlador DEC/Intel 21142/3 y cl&oacute;nico 10/100 Ethernet - <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dc&sektion=4&format=html">dc</a>

<ul>
<font size="-1"><b>Nota:</b> Algunos controladores que estaban en
OpenBSD 2.6, como mx, ax, al y pn, han sido substituidos por este
controlador.</font><br>
Que incluye tarjetas como:

   <li>Intel 21142/21143 (antes fabricado por DEC)
   <li>Macronix 98713, 98713A, 98715, 98715A y 98725
   <li>Davicom DM9100 y DM9102
   <li>ASIX Electronics AX88140A y AX88141
   <li>ADMtek AL981 Comet y AN985 Centaur
   <li>Lite-On 82c168 y 82c169 PNIC
   <li>Lite-On/Macronix 82c115 PNIC II

<p>
Si va a actualizar a OpenBSD 2.7 desde una versi&oacute;n m&aacute;s
antigua de OpenBSD, necesita prestar atenci&oacute;n a este punto.
Cualquier referencia en <i>/etc/ifaliases</i>, <i>/etc/ipf.rules</i>, o
<i>/etc/ipnat.rules</i> a los nombres de interfaz antiguos mx, al, ax,
o pn, se debe substituir por dc.  Adem&aacute;s, cualquier fichero
hostname.xxx con las extensiones de interfaz antiguas, se debe
renombrar a hostname.dcX para que pueda ser reconocido.  Substituya X
con el n&uacute;mero de la interfaz.
</ul>
<li>Lucent Technologies WaveLAN/IEEE 802.11DS - <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=wi&sektion=4">wi</a>
<li>Aironet Communications 4500/4800 IEEE 802.11DS - <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=an&sektion=4">an</a>
</ul>

<p>
Tambi&eacute;n puede comprobar qu&eacute; interfaces han sido
identificadas usando la utilidad 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8&format=html">ifconfig(8)</a>.
He aqu&iacute; la salida que mostrar&iacute;a un dispositivo ne2k.
</p>

<ul>
<pre>
$ <strong>ifconfig -a</strong>
lo0: flags=8009&lt;UP,LOOPBACK,MULTICAST&gt;
        inet 127.0.0.1 netmask 0xff000000
lo1: flags=8008&lt;LOOPBACK,MULTICAST&gt;
ne3: flags=8863&lt;UP,BROADCAST,NOTRAILERS,RUNNING,SIMPLEX,MULTICAST&gt;
        media: Ethernet manual
        inet 10.0.0.38 netmask 0xffffff00 broadcast 10.0.0.255
sl0: flags=c010&lt;POINTOPOINT,LINK2,MULTICAST&gt;
sl1: flags=c010&lt;POINTOPOINT,LINK2,MULTICAST&gt;
ppp0: flags=8010&lt;POINTOPOINT,MULTICAST&gt;
ppp1: flags=8010&lt;POINTOPOINT,MULTICAST&gt;
tun0: flags=10&lt;POINTOPOINT&gt;
tun1: flags=10&lt;POINTOPOINT&gt;
enc0: flags=0&lt;&gt;
bridge0: flags=0&lt;&gt;
bridge1: flags=0&lt;&gt;
</pre>
</ul>

<p>
Como habr&aacute; podido comprobar, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8&format=html">ifconfig(8)</a> 
muestra mucha m&aacute;s informaci&oacute;n de la que necesitamos en
este momento.  Pero lo importante aqu&iacute; es que nos permite ver
nuestra interfaz.  En el ejemplo anterior, la tarjeta de la interfaz ya
est&aacute; configurada.  Esto se sabe al ver que los valores ya han
sido fijados en &quot;inet 10.0.0.38 netmask 0xffffff00 broadcast
10.0.0.255&quot;, y que los indicadores <strong>UP</strong> y
<strong>RUNNING</strong> est&aacute;n activados.  Tambi&eacute;n
podr&aacute; notar muchas otras interfaces.  A continuaci&oacute;n
puede ver una lista de interfaces que se supone que deben estar
ah&iacute;.
</p>

<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&sektion-4&format=html">lo</a> - Interfaz Loopback
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sl&sektion=4&format=html">sl</a> - Interfaz de Red SLIP
<li>ppp - Protocolo Punto a Punto
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tun&sektion=4&format=html">tun</a> - Interfaz de Red de T&uacute;nel
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4&format=html">enc</a> - Interfaz de Encapsulamiento
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&sektion=4&format=html">bridge</a> - Interfaz Ethernet Puente
</ul>

<p>
Si su interfaz no ha sido configurada, el primer paso ser&aacute; crear
el fichero <strong>/etc/hostname.${IF}</strong>, donde el nombre de su
interfaz substituir&aacute; ${IF}.  De acuerdo con la
informaci&oacute;n de los ejemplos anteriores, el nombre ser&iacute;a
<strong>/etc/hostname.ne3</strong>.  La composici&oacute;n de este
fichero es como sigue a continuaci&oacute;n.  Para leer m&aacute;s
sobre el formato de este fichero, tome como referencia la p&aacute;gina
de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&sektion=5&format=html">hostname.if(5)</a>
</p>

<ul>
<pre>
[address_family] [your_ip] [your_netmask] [media options]
</pre>
</ul>

<p>
Por lo tanto, para el ejemplo anterior, un nombre correcto ser&iacute;a
parecido a este:
</p>

<ul>
<pre>
$ <strong>cat /etc/hostname.ne3</strong>
inet 10.0.0.38 255.255.255.0 NONE
</pre>
</ul>

<p>
El siguiente paso ser&aacute; la configuraci&oacute;n de su pasarela.
Para ello basta con que ponga el IP de su pasarela en el fichero
<strong>/etc/mygate</strong>.  Esto permitir&aacute; que su pasarela se
active en el momento del arranque.  A continuaci&oacute;n deber&aacute;
configurar sus nombres de servidores (<i>&quot;nameservers&quot;</i>) y
su fichero <strong>/etc/hosts</strong>.  Para configurar sus nombres de
servidores debe crear un fichero con el nombre
<strong>/etc/resolv.conf</strong>.  Puede leer m&aacute;s sobre el
formato de este fichero en la p&aacute;gina de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolv.conf&sektion=5&format=html">resolv.conf(5)</a>.
El siguiente ejemplo es para un uso t&iacute;pico.  En este ejemplo sus
servidores de dominio son 125.2.3.4 y 125.2.3.5.  Tambi&eacute;n
pertenece al dominio &laquo;sudominio.dom&raquo;.
</p>

<ul>
<pre>
$ <strong>cat /etc/resolv.conf</strong>
search sudominio.dom
nameserver 125.2.3.4
nameserver 125.2.3.5
lookup file bind
</pre>
</ul>

<p>
Desde este punto ya puede reiniciar o bien ejecutar el gui&oacute;n de
configuraci&oacute;n <strong>/etc/netstart</strong>.  Puede hacerlo
escribiendo (como root):
</p>

<ul>
<pre>
$ <strong>sh /etc/netstart</strong>
writing to routing socket: File exists
add net 127: gateway 127.0.0.1: File exists
writing to routing socket: File exists
add net 224.0.0.0: gateway 127.0.0.1: File exists
</pre>
</ul>

<p>
F&iacute;jese en que se producen un peque&ntilde;o n&uacute;mero de
errores, pero &eacute;stos se refieren a la interfaz de loopback.  Por
lo tanto puede ignorar estos errores.  A partir de aqu&iacute; su
sistema deber&iacute;a funcionar correctamente.  Puede hacer una
comprobaci&oacute;n con 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8&format=html">ifconfig(8)</a>
para asegurarse de que su interfaz se configur&oacute; correctamente.
Tambi&eacute;n puede comprobar sus rutas con
<strong>netstat(1)</strong> o <strong>route(8)</strong>.  A
continuaci&oacute;n puede ver un ejemplo de c&oacute;mo ver sus tablas
de rutas usando ambas herramientas.
</p>

<ul>
<pre>
$ <strong>netstat -rn</strong>
Routing tables

Internet:
Destination        Gateway            Flags     Refs     Use    Mtu  Interface
default            10.0.0.1           UGS         0       86      -  ne3
127/8              127.0.0.1          UGRS        0        0      -  lo0
127.0.0.1          127.0.0.1          UH          0        0      -  lo0
10.0.0/24          link#1             UC          0        0      -  ne3
10.0.0.1           aa:0:4:0:81:d      UHL         1        0      -  ne3
10.0.0.38          127.0.0.1          UGHS        0        0      -  lo0
224/4              127.0.0.1          URS         0        0      -  lo0

Encap:
Source             Port  Destination        Port  Proto SA(Address/SPI/Proto)
$ <strong>route show</strong>
Routing tables

Internet:
Destination      Gateway            Flags
default          10.0.0.1           UG
127.0.0.0        LOCALHOST          UG
localhost        LOCALHOST          UH
10.0.0.0         link#1             U
10.0.0.1         aa:0:4:0:81:d      UH
10.0.0.38        LOCALHOST          UGH
BASE-ADDRESS.MCA LOCALHOST          U
</pre>
</ul>

<p>
<a name="6.1.2"></a>
<h3>6.1.2 - Configuraci&oacute;n del sistema OpenBSD como pasarela
(<em>&quot;gateway&quot;</em>)</h3>
</p>

<p>
&Eacute;sta es la informaci&oacute;n b&aacute;sica que necesita para
configurar su sistema OpenBSD como una pasarela (tambi&eacute;n llamada
&laquo;enrutador&raquo; o &laquo;encaminador&raquo;).  Si piensa usar
OpenBSD como un enrutador en Internet, le sugerimos que lea
tambi&eacute;n la secci&oacute;n con las instrucciones sobre la
configuraci&oacute;n de <a href="#6.2">Filtros IP</a>, para bloquear
tr&aacute;fico potencialmente malicioso.  Adem&aacute;s, debido a la
escasa disponibilidad de direcciones IPv4 en los proveedores de
servicios de redes y registros regionales, es conveniente leer la
secci&oacute;n sobre <a href="#6.3">NAT</a> para informaci&oacute;n
sobre c&oacute;mo conservar su espacio de direcci&oacute;n IP.
</p>

<p>
El n&uacute;cleo GENERIC posee la capacidad de permitir IP Forwarding,
pero debe ser activado.  Para ello debe usar la utilidad
<strong>sysctl(8)</strong>.  Para que los cambios sean permanentes,
debe editar el fichero <em>/etc/sysctl.conf</em> para habilitar IP
Forwarding.  Esto lo puede llevar a cabo a&ntilde;adiendo la siguiente
l&iacute;nea en ese fichero de configuraci&oacute;n.
</p>

<ul>
<pre>
net.inet.ip.forwarding=1
</pre>
</ul>

<p>
Para que este cambio surja efecto sin tener que reiniciar el sistema,
use directamente la utilidad <strong>sysctl(8)</strong>.  Recuerde que
este cambio todav&iacute;a no existir&aacute; despu&eacute;s de
reiniciar, y que necesitar&aacute; ser ejecutado como root.
</p>

<ul>
<pre>
# <strong>sysctl -w net.inet.ip.forwarding=1</strong>
net.inet.ip.forwarding: 0 -&gt; 1
</pre>
</ul>

<p>
A continuaci&oacute;n modifique las rutas en los otros hu&eacute;spedes
de ambos lados.  OpenBSD ofrece muchas posibilidades de uso como
enrutador, usando software como 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=routed&apropos=0&sektion=8&format=html">routed(8)</a>, <a href="http://www.gated.org">gated</a>, 
<a href="http://www.mrtd.net">mrtd</a>, y 
<a href="http://www.zebra.org">zebra</a>.
OpenBSD dispone de soporte para gated y mrtd en la colecci&oacute;n de
portes.  OpenBSD incluye soporte para varias interfaces T1, HSSI, ATM,
FDDI, Ethernet, e interfaces de serie (PPP/SLIP).
</p>

<p>
<a name="6.1.3"></a>
<h3>6.1.3 - Configuraci&oacute;n de alias en una interfaz.</h3>
</p>

<strong>&iexcl;Desde la versi&oacute;n 2.8, ya <em>/etc/ifaliases</em>
no se usa!</strong>

<p>
OpenBSD dispone de un simple mecanismo para configurar los alias de ip en
una interfaz.  Para ellos s&oacute;lo tiene que editar el fichero
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&sektion=5&format=html"><em>/etc/hostname.&lt;if&gt;</em></a>.
El gui&oacute;n <i>/etc/rc</i>, que forma parte de la
<a href="faq10.html#10.3">jerarqu&iacute;a de inicio rc</a>,
leer&aacute; este fichero durante el proceso de inicio del sistema.
Por ejemplo, supongamos que el usuario tiene una interfaz
<strong>dc0</strong> y pertenece a la red 192.168.0.0.  Otra
informaci&oacute;n de importancia:
</p>

<ul>
<li>IP para dc0 es 192.168.0.2
<li>NETMASK es 255.255.255.0
</ul>

<p>
Unas notas sobre los alias:  en OpenBSD s&oacute;lo se usa el nombre de
la interfaz; no existen diferencias entre el primer alias y el segundo,
por lo tanto, a diferencia de otros sistemas operativos, en OpenBSD no
hay que referirse a ellos como dc0:0 y dc0:1.  Si hace referencia a una
direcci&oacute; de IP alias espec&iacute;fica con ifconfig, o si
est&aacute; a&ntilde;adiendo un alias, aseg&uacute;rese de decir
'<kbd>ifconfig int alias</kbd>' en lugar de '<kbd>ifconfig int</kbd>'
en la l&iacute;nea de &oacute;rdenes.  Puede eliminar los alias con
'<kbd>ifconfig int delete</kbd>'.
</p>

<p>
Asumiendo que est&eacute; usando direcciones de IP m&uacute;ltiples que
est&eacute;n en la misma subred IP con alias, la configuraci&oacute;n
de su enmascaramiento de red (&quot;netmask&quot;) para cada alias pasa
a ser 255.255.255.255.  No necesitan seguir el netmask del primer IP
ligado a la interfaz.  En el siguiente <em>/etc/hostname.dc0</em> de
ejemplo, se a&ntilde;aden dos alias al dispositivo
<strong>dc0</strong>, el cual, por cierto, se configur&oacute; como
192.168.0.2 netmask 255.255.255.0.
</p>

<ul>
<pre>
# <b>cat /etc/hostname.dc0</b>
inet 192.168.0.2 255.255.255.0 media 100baseTX
inet alias 192.168.0.3 255.255.255.255 NONE
inet alias 192.168.0.4 255.255.255.255 NONE
</pre>
</ul>

<p>
Una vez que haya configurado este fichero ser&aacute; necesario
reiniciar para que los cambios funcionen.  Sin embargo, puede hacer
efectivos los alias a mano, usando la utilidad
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8&format=html">ifconfig(8)</a>.
Para hacer efectivo el primer alias use la orden:
</p>

<ul>
<pre>
# <b>ifconfig dc0 inet alias 192.168.0.3 netmask 255.255.255.255</b>
</pre>
</ul>

<p>
Para ver estos alias debe usar la orden:
</p>

<ul>
<pre>
$ <b>ifconfig -A</b>
dc0: flags=8863&lt;UP,BROADCAST,NOTRAILERS,RUNNING,SIMPLEX,MULTICAST&gt;
        media: Ethernet manual
        inet 192.168.0.2  netmask 0xffffff00 broadcast 192.168.0.255
        inet 192.168.0.3 netmask 0xffffffff broadcast 192.168.0.3
</pre>
</ul>


<p>
<a name="6.2"></a>
<h2>6.2 - Filtros IP</h2>
</p>

<p>
El paquete de filtros IP, IPFilter, se creó con el fin de gestionar dos
tareas, tratar con permisos
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipf&apropos=0&sektion=8&format=html">ipf(8)</a>
para el env&iacute;o a nivel de paquetes y asignar
hu&eacute;spedes/subrredes a un campo de direcciones externas
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&apropos=0&sektion=8&format=html">ipnat(8)</a>.
Los ficheros de configuraci&oacute;n para estos dos servicios son
<em>/etc/ipf.rules</em> y <em>/etc/ipnat.rules</em>.
</p>

<p>
Para iniciar estos servicios con su sistema, antes debe editar el
fichero <em>/etc/rc.conf</em> y activar las siguientes l&iacute;neas
tal y como se muestra a continuaci&oacute;n:
</p>

<ul><pre>
ipfilter=YES
ipnat=YES
</pre></ul>

<p>
<strong>NOTA:</strong> no siempre es necesario activar ambas opciones,
a menos que vaya a usar los dos.  Sin embargo, si va a usar
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8">ipnat(8)</a>,
<em>ipfilter</em> tambi&eacute;n tendr&aacute; que ser activado.
</p>

<p>
Si va a usar
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8">ipnat(8)</a>,
es muy probable que tambi&eacute;n deba configurar el valor
<em>net.inet.ip.forwarding</em> de sysctl a <code>1</code>.  Puede
hacerlo activando la l&iacute;nea correspondiente en
<em>/etc/sysctl.conf</em>.
</p>

<p>
Si ha compilado IP Filter en su n&uacute;cleo pero no lo ha activado en
el fichero <em>/etc/rc.conf</em>, lo puede activar f&aacute;cilmente.

<ul>
<pre>
# <strong>ipf -Fa -f /etc/ipf.rules -E</strong>
# <strong>ipnat -CF -f /etc/ipnat.rules</strong>
</pre>
</ul>

<p>
El indicador <em>-E</em> en ipf `activa' IP Filter.  El indicador
<em>-Fa</em> limpia cualquier regla que pueda tener ah&iacute;.<br>
<em>-f /etc/ipf.rules</em> carga las reglas desde
<em>/etc/ipf.rules</em>.

<p>
Si hace alg&uacute;n cambio en <em>/etc/ipf.rules</em> despu&eacute;s
de haber cargado ipf, puede recargar sus reglas muy f&aacute;cilmente.

<ul>
<pre>
# <strong>ipf -Fa -f /etc/ipf.rules</strong>
</pre>
</ul>

Lo mismo para ipnat...

<ul>
<pre>
# <strong>ipnat -CF -f /etc/ipnat.rules</strong>
</pre>
</ul>

Tambi&eacute;n puede activar ipmon para el depurado.

<ul>
<pre>
# <strong>ipmon -Ds</strong>
</pre>
</ul>

<p>
A partir de aqu&iacute; este documento cubrir&aacute; algunos aspectos
b&aacute;sicos de configuraciones de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipf&sektion=8">ipf(8)</a>
y <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8">ipnat(8)</a>.
Existen muchos ejemplos para ipnat y ipf en <em>/usr/share/ipf</em>, le
recomendamos que escoja el que m&aacute;s se acerque a la
configuraci&oacute;n que Vd. desee, y que lo modifique conforme a sus
necesidades.  Puede encontrar m&aacute;s informaci&oacute;n sobre
Filtros IP en los archivos de la
<a href="http://false.net/ipfilter/">lista de correo IP Filter</a>, en
las <a href="http://coombs.anu.edu.au/~avalon/">p&aacute;ginas de IP
Filter</a>, y en el <a href="http://www.obfuscation.org/ipf/">IP Filter
HOWTO</a>.
</p>

<p>
<h3>IPF</h3>
</p>

<p>
Para activar ipf desde el momento del inicio del sistema necesita
modificar <em>/etc/rc.conf</em> de modo que lea IPFILTER=YES.  IP
Filter (ipf) est&aacute; controlado por <i>/etc/ipf.rules</i>, que se
leer&aacute; durante el inicio.  Para una explicaci&oacute;n m&aacute;s
detallada lea la p&aacute;gina de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipf&apropos=0&sektion=5&format=html">ipf(5)</a>.
En los siguientes ejemplos, fxp0 representa la interfaz externa a
internet.  En su caso puede ser diferente seg&uacute;n el adaptador de
ethernet de que disponga en su m&aacute;quina.  En estas reglas se
asumir&aacute; que existe una conexi&oacute;n permanente a internet,
del mismo tipo que la de un servidor de web.
</p>

<p>
Las reglas de IP Filter se procesan de modo secuencial desde el principio
hasta el final, siendo de ayuda para visualizar cada paquete que tenga que
atravesar cada regla antes de alcanzar su destino.
</p>

<p>
Por ejemplo, el grupo de reglas predefinido permite que entren y salgan
todos los paquetes:

<ul>
<pre>
pass out from any to any 
pass in from any to any
</pre>
</ul>

Supongamos ahora que no queremos permitir ninguna conexi&oacute;n
entrante por el puerto 3306 (mysql) porque la base de datos s&oacute;lo
deber&iacute;a permitir la conexi&oacute;n de forma local.  En este
caso el grupo de reglas ser&iacute;a as&iacute;:

<ul>
<pre>
pass out from any to any
pass in from any to any
block in on fxp0 from any to any port = 3306
</pre>
</ul>

Que traducido viene a decir lo siguiente: &laquo;bloquear todos los
paquetes entrantes desde cualquier sitio hasta cualquier sitio cuyo
destino sea 3306&raquo;.  Lo que ocurrir&iacute;a es que un paquete
destinado al puerto 3306 en la interfaz fxp0 pasar&iacute;a la primera
regla &quot;pass in&quot;, y acto seguido ser&iacute;a bloqueado por la
regla &quot;block in port = 3306&quot;.  En el caso en que se
invirtieran las reglas de entrada (recuerde que el orden es importante)

<ul>
<pre>
pass out from any to any
block in on fxp0 from any to any port = 3306
pass in from any to any
</pre>
</ul>

los paquetes destinados al puerto 3306 pasar&iacute;an debido a que la
&uacute;ltima regla en el grupo permite que pasen todos los paquetes.
Cuando est&eacute; escribiendo reglas para el filtrado de paquetes es
importante que tenga en cuenta lo siguiente:
<b>La &uacute;ltima regla que concuerde tendr&aacute; precedencia</b>.
</p>

<p>
Por supuesto que existen excepciones para toda regla.  La opci&oacute;n
<em>quick</em> filtra el paquete en la primera regla que concuerde.
Veamos el defectuoso ejemplo anterior a&ntilde;adi&eacute;ndole la
opci&oacute;n <em>quick</em> a la regla &quot;block in&quot;:

<ul>
<pre>
pass out from any to any
block in quick on fxp0 from any to any port = 3306
pass in from any to any
</pre>
</ul>

<p>
Un paquete destinado para el puerto 3306 ser&aacute; filtrado por la
regla &quot;block in quick&quot; y bloqueado inmediatamente.  Todos los
paquetes destinados a otros puertos no encontrar&aacute;n una
concordancia en las reglas hasta llegar a la regla &quot;pass in&quot;
que permite que pasen todos los paquetes.
</p>

<b>Denegaci&oacute;n predefinida</b>

<p>
La pol&iacute;tica de filtrado de p&aacute;quetes m&aacute;s segura es
la de &laquo;denegaci&oacute;n por definici&oacute;n&raquo;.  Esta
pol&iacute;tica es mucho m&aacute;s segura que la denegaci&oacute;n
expl&iacute;cita de cada servicio protegido, permite grupos de reglas
m&aacute;s breves, y puede proteger de un servicio que haya sido mal
configurado de modo accidental y que haya quedado expuesto.

<p>
Veamos ahora otro ejemplo de grupo de reglas real, seguido de una
explicaci&oacute;n l&iacute;nea por l&iacute;nea.  El siguiente ejemplo
es para un servidor de web con una pol&iacute;tica de denegaci&oacute;n
predefinida que s&oacute;lo permite conexiones ssh (para
administraci&oacute;n), y conexiones http (puerto 80) y https (puerto
443).

<ul>
<pre>
pass in quick on fxp0 from any to any port = 22
pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443
block in quick on fxp0 from any to any
pass out on fxp0 from any to any
</pre>
</ul>

<p>
Esto permitir&aacute; las conexiones desde cualquier sitio a los
puertos 22 (ssh), 80 (http) y 443 (https).  Cualquier otro intento de
conexi&oacute;n distinto ser&aacute; bloqueado, y permitir&aacute;
todas las conexiones salientes.  Este grupo de reglas es muy estricto.
Pero, &iquest;y si Vd. s&oacute;lo quisiera permitir la conexi&oacute;n
a ssh a hu&eacute;spedes internos en su bloque de direcciones 1.1.1.0,
y al mismo tiempo permitir conexiones externas a http y https?
</p>

<ul>
<pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443
block in quick on fxp0 from any to any
pass out on fxp0 from any to any
</pre>
</ul>

De acuerdo, pero, &iquest;y si s&oacute;lo quisiera permitir la
administraci&oacute;n remota de su servidor de web a una sola
m&aacute;quina (1.1.1.1)?  En tal caso cambiar&iacute;a esta regla:

<ul>
<pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
</pre>
</ul>

por esta otra:

<ul>
<pre>
pass in quick on fxp0 from 1.1.1.1/32 to any port = 22
</pre>
</ul>

IP Filter tiene soporte para formas de &quot;netmask address&quot;
tanto CIDR como de punto decimal.  Por tanto podr&iacute;a escribir lo
anterior de esta forma:

<ul>
<pre>
pass in quick on fxp0 from 1.1.1.1/255.255.255.255 to any port = 22
</pre>
</ul>

pero, &iquest;para qu&eacute;?
</p>

<b>Ejemplos de reglas</b>

<p>
Aqu&iacute; puede ver algunas buenas reglas que puede usar cualquier
persona (se asume que fxp0 es la interfaz externa conectada a
interner).  Para empezar configuraremos una simple protecci&oacute;n
contra la falsificaci&oacute;n de direcciones.

<ul>
<pre>
block in quick on fxp0 from 127.0.0.0/8 to any
block in quick on fxp0 from 192.168.0.0/16 to any
block in quick on fxp0 from 172.16.0.0/12 to any
block in quick on fxp0 from 10.0.0.0/8 to any
block out quick on fxp0 from any to 127.0.0.1/8
block out quick on fxp0 from any to 192.168.0.0/16
block out quick on fxp0 from any to 172.16.0.0/12
block out quick on fxp0 from any to 10.0.0.0/8
</pre>
</ul>

Tambi&eacute;n es una buena idea separar su interfaz de
<em>loopback</em> de sus otras reglas.

<ul>
<pre>
pass out quick on lo0
pass in quick on lo0
</pre>
</ul>

Nuestro grupo de reglas empieza a tener buena pinta;  cuando lo ponemos
todo junto, esto es lo que vemos:

<ul>
<pre>
# loopback rules
pass out quick on lo0
pass in quick on lo0

# no permitir a nadie falsificar direcciones que no puedan ser enrutadas

block in quick on fxp0 from 127.0.0.0/8 to any
block in quick on fxp0 from 192.168.0.0/16 to any
block in quick on fxp0 from 172.16.0.0/12 to any
block in quick on fxp0 from 10.0.0.0/8 to any
block out quick on fxp0 from any to 127.0.0.1/8
block out quick on fxp0 from any to 192.168.0.0/16
block out quick on fxp0 from any to 172.16.0.0/12
block out quick on fxp0 from any to 10.0.0.0/8

# permitir la conexi&oacute;n por ssh s&oacute;lo a nuestra m&aacute;quina de administraci&oacute;n

pass in quick on fxp0 from 1.1.1.1/32 to any port = 22

# permitir que otros usen http y https

pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443

# finalmente, cerrar el resto con una denegaci&oacute;n por definici&oacute;n

block in quick on fxp0 from any to any

# y dejar pasar todo el tr&aacute;fico saliente
# Los indicadores S son para asegurar que el estado del seguimiento
# comience s&oacute;lo en el primer paquete saliente en una
# sesi&oacute;n de tcp.
# El indicador s s&oacute;lo funciona con el protocolo tcp, y son
# necesarias tres entradas para cubrir los tres protocolo (tcp, udp, y
# icmp).

pass out     quick on fxp0 proto tcp  from any to any flags S keep state
pass out     quick on fxp0 proto udp  from any to any         keep state
pass out     quick on fxp0 proto icmp from any to any         keep state
pass out on fxp0 from any to any
</pre>
</ul>
</p>

<b>Registro de paquetes</b>

<p>
De momento va bastante bien, pero podr&iacute;a ir mejor.  &iquest;Qué
har&iacute;amos si quisi&eacute;ramos obtener un registro de cualquier
intento de conexi&oacute;n al puerto 22 (ssh) que fuera por nuestro
cortafuegos?  Ser&iacute;a fácil, IP Filter puede gestionar este caso
con la opci&oacute;n clave <em>log</em>:

<ul>
<pre>
pass in quick on fxp0 from 1.1.1.1/32 to any port = 22
block in log quick on fxp0 from any to any port = 22
</pre>
</ul>

Esta regla permitir&aacute; la conexi&oacute;n remota por el puerto 22
a nuestra m&aacute;quina de administraci&oacute;n, pero denegar&aacute;
y registrar&aacute; cualquier otro intento de conexi&oacute;n al puerto
22.
</p>

<b>Filtrado de paquetes seg&uacute;n el protocolo</b>

<p>
IP Filter puede filtrar cualquier protocolo IP bas&aacute;ndose en su
n&uacute;mero o nombre en 
<a href=file://localhost/etc/protocols>/etc/protocols</a>.  Para que se
entienda con m&aacute;s claridad, s&oacute;lo trataremos aqu&iacute;
con tcp, udp, e icmp.  &Eacute;stos son los protocolos de uso
m&aacute;s com&uacute;n.  Todas las aplicaciones b&aacute;sicas de
internet dependen de la disponibilidad y de la correcta operatibilidad
de estos protocolos.
</p>

<p>
Para que ipf filtre seg&uacute;n qu&eacute; protocolo, se debe usar la
opci&oacute;n clave <em>proto</em>.  Bas&aacute;ndonos en el ejemplo
anterior, y puesto que ssh funciona sobre tcp, s&oacute;lo
deber&iacute;amos permitir la conexi&oacute;n a paquetes tcp.  Usando
la opci&oacute;n clave <em>proto</em> para permitir s&oacute;lo
conexiones tcp, obtendremos una regla como esta:

<ul>
<pre>
pass in quick on fxp0 proto tcp from 1.1.1.1/32 to any port = 22
</pre>
</ul>

Pero, &iquest;y si necesit&aacute;ramos permitir conexiones a un
servicio como bind que funciona tanto sobre tcp como sobre udp?  En el
caso de tcp/udp, IP Filter nos permite agrupar ambos protocolos en un
s&oacute;lo (Nota: esto s&oacute;lo es v&aacute;lido para tcp/udp).
Usando el ejemplo de bind, una regla que permita conexiones de tcp y
udp en un entorno de denegaci&oacute;n por definici&oacute;n
ser&iacute;a:

<ul>
<pre>
pass in quick on fxp0 proto tcp/udp from any to any port = 53
</pre>
</ul>
</p>

<b>Filtrado de paquetes</b>

<p> 
Adem&aacute;s de filtrar seg&uacute;n el protocolo, IP Filter
tambi&eacute;n puede gestionar paquetes de IP fragmentados (un
m&eacute;todo com&uacute;n para bular filtros de paquetes).  Hay dos
opciones claves posibles que se pueden usar para tratar paquetes de ip
fragmentados, <em>frag</em> para paquetes de IP fragmentados normales,
o <em>short</em> para paquetes de IP con cabeceras demasiado
peque&ntilde;as para poder compararlas.  Ya que, dependiendo de las
condiciones de conexi&oacute;n, los paquetes fragmentados pueden darse
normalmente, es mejor filtrar s&oacute;lo los paquetes con cabeceras
demasiado peque&ntilde;as como para obtener comparaciones
v&aacute;lidas.  Esto se puede conseguir con la siguiente regla:

<ul>
<pre>
block in quick proto tcp all with short
</pre>
</ul>

&iquest;Y qu&eacute; hay de las Opciones de IP?  IP Filter
tambi&eacute;n puede tratar con ese tipo de paquetes.  Los paquetes se
pueden bloquear si tienen las opciones de IP activadas, o se pueden
bloquear seg&uacute;n las opciones de IP que est&eacute;n activadas.
Por ejemplo, la siguiente regla bloquear&aacute; y crear&aacute; un
registro de todos los paquetes con las opciones de ip activadas.

<ul>
<pre>
block in log quick on fxp0 all with ipopts
</pre>
</ul>

Sin embargo, esto puede estropear algunas cosas como
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=traceroute&sektion=8&format=html">traceroute(8)</a>.
Tambi&eacute;n es posible especificar qu&eacute; opciones no
ser&aacute;n permitidas.  Por ejemplo, una buena regla es la de
bloquear todos los paquetes con opciones de enrutamiento de fuentes.
Se puede llevar a cabo con esta regla:

<ul>
<pre>
block in quick on fxp0 all with opt lsrr
block in quick on fxp0 all with opt ssrr
</pre>
</ul>

<b>Indicadores TCP, conexiones establecidas, y mantenimiento del
estado</b>

<p>
La principal fuerza de IP Filter reside en su capacidad para filtrar
paquetes bas&aacute;ndose en los indicadores TCP, y mantener conexiones
establecidas y el estado de la conexi&oacute;n.  Se recomienda a todos
los usuarios que deseen filtrar paquetes bas&aacute;ndose en
indicadores TCP que entiendan antes el papel que desempe&ntilde;a cada
indicador.  Por ejemplo, si un usuario quisiera denegar la
conexi&oacute;n a todos los paquetes con los indicadores FIN, URG, y
PSH activados (como por ejemplo un intento de obtener la huella digital
de un sistema operativo por nmap), podr&iacute;a usar una regla como la
siguiente:

<ul>
<pre>
block in quick on fxp0 proto tcp from any to any flags FUP
</pre>
</ul>

(Gracias a <a href=mailto:halogen@nol.net>Kyle Hargraves</a> por esta
regla)
</p>

<p>
El pr&oacute;ximo truco de IP Filter es su capacidad para
&laquo;mantener el estado&raquo; (<em>keep state</em>).  Se ha descrito
mantener el estado como &laquo;no hablar hasta que no le hablen&raquo;,
o en otras palabras, una vez que se ha establecido una conexi&oacute;n,
los paquetes ya no tienen que atravesar grupos de reglas.  &Eacute;sta
es una potente caracter&iacute;stica que permite escribir unas reglas
mucho m&aacute;s sencillas y seguras.
</p>

<p>
Por ejemplo, veamos c&oacute;mo se puede aplicar este estado al ejemplo
del grupo de reglas anterior.  &iquest;Todav&iacute;a est&aacute;
confundifo?.  Revis&eacute;moslo: estamos permitiendo el acceso de
gesti&oacute;n desde nuestra m&aacute;quina de clase C al puerto 22
(ssh), y el acceso web a todo el tr&aacute;fico a los puertos 80 (http)
y 443 (https).  Estamos bloqueando el resto de tr&aacute;fico.  Pero,
&iquest;y si quisiera conectar por ssh fuera del servidor de web? o,
&iquest;y si necesitara usar lynx para buscar algo en las
p&aacute;ginas de Preguntas Frecuentes?  No podr&iacute;a, ya que
habr&iacute;a bloqueado todas las conexiones entrantes que no
estuvieran dirigidas a los puertos especificados.  Aunque &eacute;sta
es la ruta m&aacute;s segura, puede ser muy poco conveniente.  Al
a&ntilde;adir las opciones clave <em>keep state</em> a la regla
&quot;pass out&quot;, puede permitir el paso de conexiones entrantes
que sean respuestas a conexiones que Vd. haya iniciado, como por
ejemplo al navegar por la web.  Recuerde que es necesario especificar
para qu&eacute; protocolo estamos manteniendo el estado.

<ul>
<pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443
block in quick on fxp0 from any to any
pass out on fxp0 proto tcp from any to any keep state
</pre>
</ul>
</p>

<p>
Este peque&ntilde;o cambio supondr&aacute; un dram&aacute;tico
incremento en la flexibilidad y seguridad de su grupo de reglas, debido
a que IP Filter es extremadamente flexible.  Por ejemplo, en el grupo
de reglas anterior, est&aacute; permitiendo todo el tr&aacute;fico tcp
a los puertos 80 y 443.  A&uacute;n puede ajustarlo un poco m&aacute;s.
Para establecer una conexi&oacute;n tcp s&oacute;lo necesita permitir
que tenga lugar el saludo inicial (<em>&quot;handshake&quot;</em>);
una vez que esto ocurra, puede bloquear el tr&aacute;fico a ese puerto
y permitir a la regla &quot;keep state&quot; que gestione la
conexi&oacute;n.  Para que se complete el saludo inicial, s&oacute;lo
necesita permitir el paso a los paquetes con los indicadores SYN y
SYNACK activados.  Al dejar pasar s&oacute;lo paquetes con SYN y SYNACK
activados puede prevenir muchas formas de escaneos de puertos como
puede ser el escaneo FIN.  Ahora las reglas est&aacute;n de este modo:

<ul>
<pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
pass in quick on fxp0 from any to any port = 80 flags S/SA
pass in quick on fxp0 from any to any port = 443 flags S/SA
block in quick on fxp0 from any to any
pass out on fxp0 proto tcp from any to any keep state
</pre>
</ul>
</p>

<p>
Pongamos ahora todas las reglas que tenemos, poni&eacute;ndolas en un
solo paquete de reglas.  Este paquete de reglas tendr&aacute; una
pol&iacute;tica de denegaci&oacute;n predefinida, permitir&aacute;
conexiones de gesti&oacute;n s&oacute;lo desde una red local (mediante
ssh), y permitir&aacute; el paso de tr&aacute;fico entrante en los
puertos 80 (http) y 443 (https).  Adem&aacute;s, proteger&aacute;
contra direcciones de ip falsificadas no enrutables, y bloquear&aacute;
todos los paquetes que no est&eacute;n tan fragmentados que no puedan
ser inspeccionados.  Una configuraci&oacute;n bastante comprensiva para
un servidor de web p&uacute;blico.  He aqu&iacute; c&oacute;mo
quedar&iacute;a <em>/etc/ipf.rules</em>:

<ul>
<pre>
# reglas de loopback
pass out quick on lo0
pass in quick on lo0

# bloquear fragmentos diminutos
block in quick proto tcp all with short

# bloquear paquetes enrutados de fuentes
block in quick on fxp0 all with opt lsrr
block in quick on fxp0 all with opt ssrr

# no permitir a nadie que falsee direcciones no enrutables
block in quick on fxp0 from 127.0.0.0/8 to any
block in quick on fxp0 from 192.168.0.0/16 to any
block in quick on fxp0 from 172.16.0.0/12 to any
block in quick on fxp0 from 10.0.0.0/8 to any
block out quick on fxp0 from any to 127.0.0.1/8
block out quick on fxp0 from any to 192.168.0.0/16
block out quick on fxp0 from any to 172.16.0.0/12
block out quick on fxp0 from any to 10.0.0.0/8

# permitir la conexi&oacute;n por ssh s&oacute;lo a sus m&aacute;quinas
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22

# permitir que otros usen http y https
pass in quick on fxp0 from any to any port = 80 flags S/SA
pass in quick on fxp0 from any to any port = 443 flags S/SA

# finalmente, bloquear el resto con una denegaci&oacute;n por definici&oacute;n
block in quick on fxp0 from any to any

# y dejar pasar todo el tr&aacute;fico saliente y mantener el estado
# en conexiones establecidas
pass out on fxp0 proto tcp from any to any keep state
</pre>
</ul>
</p>

<p>
Si tiene problemas puede activar el ingreso en reglas individuales para
analizarlos;  o sea,
pass in log quick on fxp0 from 1.1.1.0/24 to any port = 22<br>
Cuando modifique el fichero de configuraci&oacute;n para obtener
ficheros log de informaci&oacute;n de los paquetes, no se olvide de
hacer que los cambios surtan efecto mediante:
ipf -Fa -f /etc/ipf.rules<br>
ipmon escribir&aacute; las entradas de los ficheros de log en
<em>/var/log/ipflog</em>.<br>
Para m&aacute;s informaci&oacute;n sobre ipf, el
<a href=http://www.obfuscation.org/ipf/ipf-howto.txt>IPF howto</a> es
una fuente excelente, como tambi&eacute;n lo son los recursos
disponibles en las p&aacute;ginas de
<a href=http://coombs.anu.edu.au/~avalon/ip-filter.html>IP Filter</a>.
</p>

<p>
<a name="6.3"></a>
<h2>6.3 - IPNAT</h2>
</p>

<p>
Desarrollado sobre un trabajo original de Wayne Fergerstrom 
&lt;wayne@methadonia.net&gt;
</p>

<a name="nat1.0"></a>
<h3><u>6.3.1 Introducci&oacute;n a NAT</u></h3>

<a name="nat1.1"></a>
<b>Secci&oacute;n de Introducci&oacute;n</b>

<p>
Esta secci&oacute;n pretende servir de ayuda para aquellos que instalen
y configuren la &laquo;Traducci&oacute;n de Direcciones de Red&raquo;
(NAT, &quot;Network Address Translation&quot;) en una m&aacute;quina
con OpenBSD.
Se asume que el usuario ya ha configurado y activado una m&aacute;quina
con OpenBSD con dos tarjetas de red (una conectada a Internet y la otra
a la red local).
IP NAT funcionar&aacute; en m&aacute;quinas con s&oacute;lo un NIC, sin
embargo, como los paquetes entrar&aacute;n y saldr&aacute;n de la misma
interfaz, las colisiones de ethernet ralentizar&aacute;n el rendimiento
de forma considerable.
</p>

<p>
Basado en <a href="http://www.geektools.com/rfc/rfc1631.txt">RFC 1631</a>,
ipnat ofrece una forma f&aacute;cil para la asignaci&oacute;n de redes
locales a una direcci&oacute;n &uacute;nica enrutable
(&laquo;real&raquo;) de internet.  Esto es de gran utilidad si no
dispone de direcciones asignadas oficialmente para cada hu&eacute;sped
en su red interna.  Cuando configura redes privadas/internas, puede
aprovechar los bloques de direcciones reservados (asignados en
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>), como:

<pre>
10.0.0.0/8 (10.0.0.0 - 10.255.255.255)
172.16.0.0/12 (172.16.0.0 - 172.31.255.255)
192.168.0.0/16 (192.168.0.0 - 192.168.255.255)
</pre>
</p>

<a name="nat1.2"></a>
<b>Terminolog&iacute;a</b>

<p>
Los t&eacute;rminos convencionales usados en este documento son
bastante claros.  Con el fin de documentarlos, repasar&eacute; algunos
de estos t&eacute;rminos y la acepci&oacute;n que toman en este
documento.
</p>

<ul>
<strong>&quot;NAT&quot;</strong>
<p>
Describe la funci&oacute;n de &laquo;Traducci&oacute;n de Direcciones
de Red&raquo;.  El proceso de NAT se describir&aacute; m&aacute;s
adelante en este documento.
</p>
</ul>

<ul>
<strong>&quot;ipnat&quot;</strong>

<p>
Es la abreviaci&oacute;n de &laquo;Traducci&oacute;n de Direcciones de
Red IP&raquo;.  Se puede utilizar de manera indistinta en
substituci&oacute;n de NAT.  Sin embargo, en este documento el
t&eacute;rmino &quot;ipnat&quot; se utilizar&aacute; tan s&oacute;lo
para el uso de la l&iacute;nea de &oacute;rdenes.
</p>
</ul>

<ul>
<strong>&quot;IPF&quot;</strong>
<p>
Es la abreviaci&oacute;n de &laquo;Filtro IP&raquo;.  IP Filter es un
paquete de software de filtrado portable que se incluye como parte del
sistema OpenBSD.  IP Filter debe estar activado antes de poder activar
ipnat.  Se activa de modo f&aacute;cil, simplemente editando el fichero
<em>/etc/rc.conf</em> y cambiando ipf=NO por ipf=YES.  Esto s&oacute;lo
lo cambiar para la secuencia de inicio, y es necesario ejecutar 'ipf
-E' para activar ipf mientras el sistema est&aacute; en funcionamiento.
M&aacute;s adelante se describen estos pasos.
</p>
</ul>

<br>
<a name="nat1.3"></a>
<b>Detalles de configuraci&oacute;n</b>

<p>
Esta parte se refiere a los detalles de configuraci&oacute;n de las
m&aacute;quinas para este documento.  Su configuraci&oacute;n
ser&aacute; distinta de &eacute;sta, pero el prop&oacute;sito de este
documento es el de ofrecerle una breve idea de c&oacute;mo puede ser,
con el fin de que pueda adaptar esta informaci&oacute;n a su
configuraci&oacute;n.
</p>

<ul>
<b>Sistema operativo de la m&aacute;quina: </b>OpenBSD v2.7 i386<br>
<br>
<b>NICs: </b>
<ul>
	NetGear 10/100MB <b>dc0</b><br>
	Conectada a una LAN EXTERNA (o WAN)<br>
	<b>IP Address: </b>24.5.0.5<br>
	<b>Netmask: </b>255.255.255.0<br>
	<br>
	NetGear 10/100MB <b>dc1</b><br>
	Conectada a una LAN INTERNA<br>
	<b>IP Address: </b>192.168.1.1<br>
	<b>Netmask: </b>255.255.255.0<br>	
</ul>
<br>
<b>IP enrutable por Internet, externo (en este ejemplo, una
conexi&oacute;n por m&oacute;dem anal&oacute;gico provista por un
Proveedor de Servicios de Internet)<br></b>
<ul>
	<b>IP Address: </b>24.5.0.5<br>
	<b>Netmask: </b>255.255.255.0<br>
	<b>Gateway: </b>24.5.0.1<br>
</ul>
<br>
<b>Red de &Aacute;rea Local (LAN)</b><br>
<ul>
En este ejemplo, las m&aacute;quinas de la LAN usan el esquema de
direcciones IP 192.168.1.xxx (donde xxx es un n&uacute;mero
&uacute;nico).  Existe una gran variedad de sistemas operativos
diferentes en la LAN interna, incluidos Windows 98, Windows NT, OpenBSD
y Linux.  Cada m&aacute;quina est&aacute; conectada a un
&quot;hub&quot; designado para uso interno.  Para este documento y sus
ejemplos, el cliente en la LAN asumir&aacute; una direcci&oacute;n IP
192.168.1.40
</ul>
<br>
<b>Diagrama de configuraci&oacute;n</b>
<ul><pre>
+-----+              +---------+         +----------+
| Hub |--------- dc1 |   NAT   | dc0 ----| Internet |
+-----+              +---------+         +----------+
  | |
  | +-- Cliente A
  +---- M&aacute;s clientes 

                              +--------------------------+
                              |           LEGEND         |
                              +--------------------------+
                              |   NIC dc0 - 24.5.0.5     |
                              |   NIC dc1 - 192.168.1.1  |
                              | Cliente A - 192.168.1.40 |
                              +--------------------------+

</pre></ul>
</ul>

<br>
<a name="nat2.0"></a>
<h3><u>6.3.2 Traducci&oacute;n de direcciones de red</u></h3>
<br>

<a name="nat2.1"></a>
<b>Introducci&oacute;n a NAT</b>

<p>
Cada d&iacute;a m&aacute;s empresas y usuarios entran en Internet, y
cada uno debe tener una direcci&oacute;n IP, pero las direcciones IP
p&uacute;blicas son cada vez m&aacute;s dif&iacute;ciles de conseguir.
Para muchas personas la soluci&oacute;n ha sido la
&laquo;Traducci&oacute;n de Direcciones de Red&raquo; (o NAT).  NAT es
un modo muy simple y a la vez muy potente de conectar una LAN a
Internet sin tener que comprar o alquilar direcciones IP para cada
m&aacute;quina.  NAT tambi&eacute;n es conocido como
&laquo;Enmascaramiento de IP&raquo; entre los usuarios de Linux.
</p>

<p>
Cuando NAT est&aacute; funcionando correctamente, permite que los
usuarios dentro de la LAN puedan acceder a Internet a trav&eacute;s de
diferentes direcciones de IP (la que haya activado con su proveedor).
Cada m&aacute;quina conectada a la LAN usa la direcci&oacute;n IP (de
forma transparente) de la m&aacute;quina que est&aacute; configurada
para usar la direcci&oacute;n de IP asignada por el Proveedor de
Servicion de Internet (ISP).
</p>

<p>
El modo en que funciona NAT es increiblemente simple.  Cuando un
cliente dentro de la LAN quiere conectar a la m&aacute;quina en
Internet, le env&iacute;a un paquete TCP con un requerimiento de
conexi&oacute;n.  Dentro de la cabecera del paquete TCP se encuentra la
direcci&oacute;n IP del cliente (o sea, 192.168.1.40) y la
direcci&oacute;n IP del anfitri&oacute;n requerido (o sea,
123.45.67.89).  La m&aacute;quina en la que est&aacute; funcionando NAT
intercepta este paquete TCP y cambia la direcci&oacute;n IP del cliente
de 192.168.1.40 a la direcci&oacute;n IP de la m&aacute;quina conectada
a Internet (o sea, 24.5.0.5).  De este modo enga&ntilde;a a la
m&aacute;quina anfitriona, haci&eacute;ndole pensar que la
conexi&oacute;n requerida proviene de la m&aacute;quina con NAT, no de
la m&aacute;quina cliente.  Entonces el anfitri&oacute;n env&iacute;a
de vuelta respuestas a la m&aacute;quina NAT como si &eacute;sta fuera
la que se estuviera conectando.  Cuando la m&aacute;quina NAT recibe
las respuestas, las traduce r&aacute;pidamente y env&iacute;a el
paquete al cliente.  El cliente no tiene ni la m&aacute;s remota idea
de lo que est&aacute; ocurriendo y la falsificaci&oacute;n de la
conectividad a Internet es totalmente transparente.
</p>

<p>
El ejemplo siguiente muestra NAT de un modo m&aacute;s claro:
</p>

<ul><pre>
Cliente ----------------- dc1 [ NAT ] dc0 ---------- Anfitri&oacute;n de Internet
192.168.1.40 --- 192.168.1.1 [ NAT ] 24.5.0.5 --- 123.45.67.89

Paquete TCP SALIENTE                            Paquete TCP SALIENTE
Desde: 192.168.1.40      &gt;&gt;=== NAT ===&gt;&gt;        Desde: 24.5.0.5
Hacia: 123.45.67.89                             Hacia: 123.45.67.89

Paquete TCP ENTRANTE				Paquete TCP ENTRANTE
Desde: 123.45.67.89 				Desde: 123.45.67.89
Hacia: 192.168.1.40      &lt;&lt;=== NAT ===&lt;&lt;        Hacia: 24.5.0.5
</pre></ul>

<br>
<a name="nat2.2"></a>
<b>&iquest;Por qu&eacute; usar NAT?</b>

<p>
Una vez que ya hab&iacute;a conseguido un m&oacute;dem cable en mi
nuevo apartamento me d&iacute; cuenta de que ten&iacute;a un
peque&ntilde;o problema.  &iquest;C&oacute;mo podr&iacute;a conseguir
acceso a Internet para mis compa&ntilde;eros de apartamento si el
m&oacute;dem estaba en mi habitaci&oacute;n?  S&oacute;lo hab&iacute;a
unas pocas opciones que pod&iacute;an ayudarme, y que iban desde
obtener direcciones IP extras, pasando por instalar un servidor proxy,
hasta instalar NAT (no permita que el ejemplo del m&oacute;dem cable le
enga&ntilde;e, NAT es lo suficientemente potente como para enmascarar
un gran red con cientos o incluso miles de m&aacute;quinas).
</p>

<p>
Existen varias razones por las que decid&iacute; instalar NAT, la
primera de ellas mi econom&iacute;a.  En la casa viv&iacute;an dos
compa&ntilde;eros de piso (cada uno con su propio PC) y yo (con tres
PCs).  Mi ISP s&oacute;lo permit&iacute;a tres direcciones IP por casa,
lo que significaba que no hab&iacute;an suficientes IPs para que cada
m&aacute;quina pudiera tener acceso a Internet.
</p>

<p>
Usando NAT cada m&aacute;quina tendr&iacute;a una direcci&oacute;n IP
&uacute;nica (interna), pero compartir&iacute;an la &uacute;nica
direcci&oacute;n IP que mi ISP me dio.  El coste se redujo.
</p>

<br>
<a name="nat2.3"></a>
<b>Preconfiguraci&oacute;n</b>

<p>
Para activar NAT en su m&aacute;quina OpenBSD, necesitar&aacute;
configurar IPF y NAT.  Esto se puede llevar a cabo de una manera
f&aacute;cil editando los ficheros que aparecen en la siguiente lista
(haga los cambios al fichero de modo que aparezcan como las opciones
que siguen a continuaci&oacute;n):
</p>

<p>
<b>/etc/rc.conf</b> (este fichero se usa para iniciar servicios durante
el arranque)
</p>

<ul>
	ipfilter=YES<br>
	ipnat=YES
</ul>

<p>
<b>/etc/sysctl.conf</b>
</p>

<ul>
	net.inet.ip.forwarding=1
</ul>

<p>
Despu&iacute;s de haber hecho estos cambios, la m&aacute;quina
estar&aacute; lista para la configuraci&oacute;n de NAT.
</p>

<br>
<a name="nat2.4"></a>
<b>Configuraci&oacute;n</b>

<p>
El primer paso es configurar el fichero de reglas de IPF
(<i>/etc/ipf.rules</i>).  Para el prop&oacute;sito que persigue este
documento, dejaremos que el tr&aacute;fico pase a trav&eacute;s de esta
opci&oacute;n de cortafuegos sin que haya interferencias.  El fichero
ser&aacute; como sigue:
</p>

<ul>
<pre>
pass in from any to any
pass out from any to any
</pre>
</ul>

<p>
Para m&aacute;s informaci&oacute;n puede leer la
<a href="#6.2">secci&oacute;n 6.2</a> de estas Preguntas Frecuentes.
</p>

<p>
La sintaxis del fichero de configuraci&oacute;n de NAT
(<i>/etc/ipnat.rules</i>) es bastante simple.  De acuerdo con el
ejemplo de configuraci&oacute;n anterior, el fichero de
configuraci&oacute;n de NAT contendr&aacute; las siguientes entradas:
</p>

<ul>
<pre>
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32 portmap tcp/udp 10000:60000
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32
</pre>
</ul>

<p>
He aqu&iacute; lo que significan estas l&iacute;neas.
</p>

<ul>
<strong>&quot;map&quot;</strong>
<p>
&Eacute;sta es la orden que se le pasa a ipnat.  Dicha orden indica a
ipnat que &eacute;sta es una entrada para cambiar la direcci&oacute;n
IP entre la LAN e Internet.
</p>
</ul>

<ul>
<strong>&quot;dc0&quot;</strong>
<p>
&Eacute;sta es la interfaz de red que est&aacute; conectada a Internet.
</p>
</ul>

<ul>
<b>&quot;192.168.1.0/24&quot;</b>
<p>
La direcci&oacute;n IP y de enmascaramiento de red
(<em>&quot;netmask&quot;</em>, cuyo formato es CIDR).  La
combinaci&oacute;n de ambas indica que &laquo;cualquier
direcci&oacute;n IP con un valor desde 192.168.1.1 hasta 192.168.1.254
debe ser asignado&raquo;.  Si prefiere no usar el formato CIDR, puede
substituir &laquo;/24&raquo; por &laquo;/255.255.255.0&raquo;.
</p>
</ul>

<ul>
<b>&quot;24.5.0.5/32&quot;</b>
<p>
Esta direcci&oacute;n de IP y de enmascaramiento de red indica la
direcci&oacute;n IP que se asignar&aacute; a la LAN.  /32 indica una
sola direcci&oacute;n IP.  Tambi&eacute;n puede asignarle direcciones
IP /24, &oacute; 256 (&oacute; /27, &oacute; cualquier otro
n&uacute;mero de bits que quiera).  Esto &uacute;ltimo es muy
&uacute;til si tiene varios miles de m&aacute;quinas hu&eacute;spedes
detr&aacute;s de su NAT... claro que s&oacute;lo es de utilidad si ese
/24 est&aacute; siendo enrutado a su sistema OpenBSD.
</p>
</ul>

<ul>
<b>&quot;portmap tcp/udp 10000:60000&quot;</b>
<p>
Esto asigna todos los paquetes tcp/udp a puertos desde el 10000 hasta
el 60000.
</p>
</ul>

<p>
La segunda l&iacute;nea tiene casi la misma entrada que la primera,
exceptuando la parte final.  En esta l&iacute;nea se indica a ipnat que
debe asignar cualquier otra cosa (que no sea tcp/udp, ya que esos
paquetes concuerdan en la primera l&iacute;nea) a cualquier puerto que
requiera (usado por ICMP y otros protocolos).  Una vez que esto
est&aacute; en el fichero, s&oacute;lo tiene que ejecutar el
d&aelig;mon IPF.
</p>

<br>

<a name="nat2.5"></a>
<b>NAT selectivo</b>

<p>
Es posible que quiera evitar NAT para un rango de direcciones externas.
Continuando con el ejemplo anterior, supongamos que hay
hu&eacute;spedes en la red 24.5.0.0/28 para los que quiere que su
pasarela NAT sea un simple enrutador, sin traducci&oacute;n de
direcciones.  Puede suprimir la traducci&oacute;n de direcciones para
el tr&aacute;fico desde <em>dc0</em> hasta esta subrred con lo
siguiente:
</p>
<ul><pre>
map dc0 from 192.168.1.0/24 ! to 24.5.0.0/28 -&gt; 24.5.0.5/32 portmap tcp/udp 10000:60000
map dc0 from 192.168.1.0/24 ! to 24.5.0.0/28 -&gt; 24.5.0.5/32
</pre></ul>

<a name="nat2.6"></a>
<b>Funcionamiento</b>

<p>
Ejecutar NAT tambi&eacute;n es un proceso muy sencillo.  Una vez que
haya acabado de configurarlo, hay dos maneras de activar NAT.  La
primera manera, y la mejor si fuera posible comprobar la fase de
configuraci&oacute;n, es reiniciando su sistema OpenBSD.  Para ello
basta que use la orden &laquo;<i>reboot</i>&laquo;.
</p>

<p>
Si quiere ejecutar ipnat desde la l&iacute;nea de &oacute;rdenes, use
las siguiente &oacute;rdenes:
</p>

<ul>
<pre>
# ipf -Fa -f /etc/ipf.rules -E
# ipnat -CF -f /etc/ipnat.rules
</pre>
</ul>

<p>
Con la primera l&iacute;nea de órdenes se activa IPF (recuerde que NAT
depende de IPF, y por lo tanto es necesario iniciar IPF y tenerlo en
funcionamiento antes de poder cargar NAT).  Las opciones en la
l&iacute;nea de &oacute;rdenes &quot;-Fa&quot; limpian cualquier
entrada existente.  &quot;-f /etc/ipf.rules&quot; indica a ipf
d&oacute;nde encontrar el fichero con las reglas.  &quot;-E&quot; es el
interruptor para activar el d&aelig;mon IPF.
</p>

<p>
La segunda l&iacute;nea de &oacute;rdenes es para activar NAT.
&quot;-CF&quot; limpia y descarga todas las entradas existentes en la
tabla de NAT.  &quot;-f /etc/ipnat.rules&quot; indica a NAT
d&oacute;nde encontrar el fichero con las reglas de NAT.  Ahora ya
tiene NAT funcionando.  As&iacute; de sencillo.
</p>

<p>
<b>Nota:</b> para volver a cargar las configuraciones de NAT (en el
caso en que las cambiara y no quisiera reiniciar) ejecute la segunda
orden de nuevo.  Las configuraciones ser&aacute;n descargadas y
cargadas de nuevo.
</p>

<br>
<a name="nat3.0"></a>
<h3><u>6.3.3 Base de conocimientos de NAT</u></h3>

<br>
<a name="nat3.1"></a>
<b>Verificar el estado de NAT</b>

<p>
Para averiguar c&oacute;mo est&aacute; funcionando NAT o asegurarse de
que las configuraciones hayan hecho efecto, use la opci&oacute;n
&quot;-l&quot;.  Esta opci&oacute;n le mostrar&aacute; un listado de
todas las opciones de configuraci&oacute;n y sesiones actuales que
est&eacute; usando ipnat:
</p>

<ul>
<pre>
# <b>ipnat -l</b>
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32 portmap tcp/udp 10000:60000
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32

List of active sessions:
MAP 192.168.1.40  2473  &lt;- -&gt; 24.5.0.5  13463 [129.128.5.191 80]
</pre>
</ul>

<p>
El prop&oacute;sito de las primeras dos l&iacute;neas es el de
verificar las configuraciones que se introdujeron anteriormente en
<em>/etc/ipnat.rules</em>.  Cualquier l&iacute;nea a partir de esas dos
mostrar&aacute; una lista de las conexiones que est&eacute;n siendo
actualmente controladas por NAT.
</p>

<ul>
<b>&quot;MAP 192.168.1.40  2473&quot;</b>
<p>
Le indica la direcci&oacute;n IP de la m&aacute;quina que est&eacute;
usando NAT en la LAN.  El n&uacute;mero del puerto que se use para
realizar la conexi&oacute;n se mostrar&aacute; a continuaci&oacute;n.
</p>
</ul>

<ul>
<b>&quot;&lt;- -&gt;&quot;</b>
<p>
Indica que NAT est&aacute; gestionando el flujo de tr&aacute;fico en
ambas direcciones.
</p>
</ul>

<ul>
<b>&quot;24.5.0.5  13463&quot;</b>
<p>
Indica que la conexi&oacute;n va a Internet a trav&eacute;s de la
direcci&oacute;n IP 24.5.0.5 y que usa el puerto 13463.
</p>
</ul>

<ul>
<b>&quot;129.128.5.191 80&quot;</b>
<p>
La direcci&oacute;n IP y el puerto por el que se est&aacute; realizando
la conexi&oacute;n.
</p>
</ul>

<a name="nat3.2"></a>
<b>Limitaciones de NAT (en FTP)</b>

<p>
NAT tiene unas pocas limitaciones a tener en cuenta.  Cuando un usuario
conecta a un servidor de FTP remoto y pide informaci&oacute;n o un
fichero a &eacute;ste, el servidor de FTP conectar&aacute; con el
cliente y le transferir&aacute; los datos.  Este proceso se lleva a
cabo por un puerto libre aleatorio.  Pero esto representa un problema
para los usuarios que intentan obtener acceso a los servidores de FTP
desde dentro de la LAN.  Cuando el servidor de FTP env&iacute;a sus
datos, los env&iacute;a al NIC externo en un puerto aleatorio.  La
m&aacute;quina NAT los recibe, pero como no tiene ninguna
asignaci&oacute;n para el paquete desconocido ni para ese puerto en
concreto, suelta el paquete y no lo entrega.

<p>
La soluci&oacute;n a esto est&aacute; en que el usuario se ubique en
&laquo;modo pasivo&raquo; en su cliente de FTP.  De este modo
indicar&aacute; al servidor que desea conectarse a &eacute;ste, y que
no ocurra lo antes mencionado.  As&iacute;, al realizar el usuario la
conexi&oacute;n, NAT la gestionar&aacute; correctamente.

<p>
IP Filter ofrece otra soluci&oacute;n para esta situaci&oacute;n, un
<em>&quot;proxy&quot;</em> de ftp integrado en el c&oacute;digo de NAT.
Para activarlo, debe escribir algo parecido a lo siguiente antes de sus
otras asignaciones para NAT.

<pre>
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32 proxy port ftp ftp/tcp
</pre>

Con esto, el n&uacute;cleo del sistema observar&aacute; sus conexiones
por FTP para la orden &quot;PORT&quot; que proceda del cliente de ftp,
y substituir&aacute; la direcci&oacute;n IP y el puerto con su propia
direcci&oacute;n IP externa y con un puerto de su elecci&oacute;n.
Obviamente, esto requiere de un uso mucho m&aacute;s intensivo de
recursos pero, a menos que su m&aacute;quina de filtrado NAT/IP esté
alcanzando una masa cr&iacute;tica, no deber&iacute;a darle
ning&uacute;n problema.
<p>


<br>
<a name="nat3.3"></a>
<b>Redireccionamiento del tr&aacute;fico</b>

<p>
Es posible que haya momentos en los que necesite redireccionar el
tr&aacute;fico entrante o saliente hacia cierto protocolo o puerto.  Un
buen ejemplo de esto podr&iacute;a ser el caso en el que tuviera un
servidor que residiera dentro de la LAN y que estuviera haciendo la
funci&oacute;n de servidor de web.  Las conexiones entrantes a su IP
v&aacute;lido de Internet se encontrar&iacute;an con que, a menos que
su m&aacute;quina NAT fuera el servidor de web, no podr&iacute;an
conectar.  Para solventarlo usaremos la directiva `rdr' de NAT en el
fichero de reglas, para darle las instrucciones sobre a d&oacute;nde
debe redireccionar (o enrutar) una conexi&oacute;n en particular.
</p>

<p>
Para nuestro ejemplo, supongamos que un servidor de web reside en la
LAN y que su direcci&oacute;n IP es 192.168.1.80.  El fichero de reglas
de NAT necesita una nueva directiva para gestionar esto.  A&ntilde;ada
una l&iacute;nea parecida a la siguiente a su ipnat.con:
</p>

<ul>
<pre>
rdr dc0 24.5.0.5/32 port 80 -&gt; 192.168.1.80 port 80
</pre>
</ul>

<p>
Desglosando esta l&iacute;nea para ver qu&eacute; signfica cada
componente de ella:
</p>

<ul>
<b>&quot;rdr&quot;</b>
<p>
Es la orden que le est&aacute; pasando a ipnat.  Indica a ipnat que lo
que sigue es una entrada para redireccionar una conexi&oacute;n.
</p>
</ul>


<ul>
<b>&quot;dc0&quot;</b>
<p>
Es la interfaz de red que est&aacute; conectada a Internet.
</p>
</ul>

<ul>
<b>&quot;24.5.0.5/32&quot;</b>
<p>
Indica que es una conexi&oacute;n entrante a esta dirección IP
(s&oacute;lo en dc0, como arriba).
</p>
</ul>

<ul>
<b>&quot;port 80&quot;</b>
<p>
&Eacute;ste es el puerto (80) que debe ser redireccionado.  El
n&uacute;mero &laquo;80&raquo; no es estrictamente necesario,
tambi&eacute;n podr&iacute;a usar &laquo;port www&raquo; para
especificar una redirecci&oacute;n del puerto 80.  Si desea usar un
nombre en lugar de un n&uacute;mero, el nombre del servicio y el puerto
correspondiente deben existir en el fichero <em>/etc/services</em>.
</p>
</ul>

<ul>
<b>&quot;192.168.1.80&quot;</b>
<p>
Es la direcci&oacute;n IP y de enmascaramiento de red
(<em>&quot;netmask&quot;</em>) de la m&aacute;quina LAN a la que
redireccionan los paquetes.  El enmascaramiento de red es siempre
&laquo;/32&raquo; (y por tanto no es necesario especificarlo), para que
los paquetes puedan ser redirigidos a una m&aacute;quina en particular.
</p>
</ul>

<p>
Cuando haya terminado de a&ntilde;adir todos los datos, recargue las
reglas de NAT y el redireccionamiento comezar&aacute; de inmediato.
</p>

<br>
<a name="nat3.4"></a>
<b>NAT frente a proxy</b>

<p>
La diferencia entre NAT y una aplicaci&oacute;n basada en proxy es que
el software de proxy act&uacute;a como un intermediario entre Internet
y las m&aacute;quinas conectadas a la LAN.  En prinicipio esto no
presenta ning&uacute;n problema, sin embargo cada aplicaci&oacute;n que
quiera ejecutar en su m&aacute;quina y conectarla a Internet a
trav&eacute;s del servidor de proxy, DEBE reconocer el proxy (ser capaz
de usarlo).  No todas las aplicaciones con capaces de esto (en especial
los juegos).  A&uacute;n m&aacute;s, no existen aplicaciones para
servidores de proxy para todos los servicios de Internet.  NAT asigna
su red interna de un modo transparente, para que pueda conectar a
Internet.  La &uacute;nica ventaja de seguridad que proxy tiene sobre
NAT es que el software de proxy puede haber sido programado para
funciones de seguridad, y puede filtrar seg&uacute;n el contenido con
el fin de evitar que una macro de virus se interne en su m&aacute;quina
Windows, o proteger sus programas contra desbordamientos de la memoria
intermedia (<em>&quot;buffer overflows&quot;</em>), y otros peligros.
El mantenimiento de estos filtros es a menudo un trabajo muy pesado.
</p>

<a name="nat4.0"></a>
<b>6.3.4 Referencias y recursos</b>

<p>
Ficheros de OpenBSD:
<ul>
   <li><em>/etc/ipnat.rules</em> 
       - fichero de reglas de NAT
   <li><em>/etc/rc.conf</em> 
       - fichero para iniciar ipnat e ipf durante el arranque del
	 sistema
   <li><em>/etc/sysctl.conf</em> 
       - fichero para activar IP forwarding
   <li><em>/usr/share/ipf/nat.1</em> 
       - ejemplos de ipnat.rules
</ul>
</p>

<p>
Enlaces de NAT en Internet:
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8">http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=5&format=html">P&aacute;gina de manual que muestra la sintaxis correcta de <em>ipnat.rules</em></a>
<li><a href="http://coombs.anu.edu.au/~avalon/">http://coombs.anu.edu.au/~avalon/</a>
<li><a href="http://www.geektools.com/rfc/rfc1631.txt">http://www.geektools.com/rfc/rfc1631.txt</a>
</ul>
<p>

<br>

<p> 
<a name="6.4"></a> <h2>6.4 - DHCP</h2> </p>

<h3>6.4.1 Cliente DHCP</h3>

<p>
Para usar el cliente DHCP incluido en OpenBSD, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dhclient&apropos=0&sektion=8&format=html">dhclient(8)</a>,
edite el fichero <em>/etc/hostname.xl0</em> (suponiendo que su interfaz
principal de ethernet sea xl0;  la suya podr&iacute;a ser ep0, o fxp0,
o cualquier otra).  Todo lo que necesita a&ntilde;adir a este fichero
es 'dhcp'.

<pre>
# <strong>echo dhcp >/etc/hostname.xl0</strong>
</pre>

Esto har&aacute; que OpenBSD inicie el cliente DHCP
autom&aacute;ticamente durante el arranque.  OpenBSD obtendr&aacute; la
informaci&oacute;n sobre su direcci&oacute;n IP, pasarela, y servidores
de DNS desde el servidor de DHCP.

<p>
Si quiere iniciar un cliente dhcp desde la l&iacute;nea de
&oacute;rdenes, aseg&uacute;rese de que el fichero
<em>/etc/dhclient</em> existe, y entonces escriba:

<pre>
# <strong>dhclient fxp0</strong>
</pre>

en donde fxp0 es la interfaz en la que quiere recibir dhcp.

<p>
Sea cual fuere el modo en que inicie dhclient, puede <b>evitar</b> que
se actualice su DNS de acuerdo con la idea que tenga el servidor dhcp
sobre la DNS, comentando las l&iacute;neas precedidas por 'request'
(son ejemplos de la configuraci&oacute;n predefinida, pero necesita
activarlos para anular la configuraci&oacute;n predefinida de dhclient)

<pre>
request subnet-mask, broadcast-address, time-offset, routers,
      domain-name, domain-name-servers, host-name, lpr-servers, ntp-servers;
</pre>

y a continuaci&oacute;n <b>eliminar</b> domain-name-servers.
Tambi&eacute;n es posible que tambi&eacute;n desee anular hostname u
otras configuraciones.

<p>
<h3>6.4.2 Servidor DHCP</h3>

Si quiere usar OpenBSD como servidor DHCP con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dhcpd&apropos=0&sektion=8&format=html">dhcpd(8)</a>,
edite el fichero <em>/etc/rc.conf</em>.  Config&uacute;relo poniendo
dhcp_flags=&quot;-q&quot; en lugar de dhcp_flags=NO.  A&ntilde;ada en
<em>/etc/dhcp.interfaces</em> las interfaces en las que quiera que dhcp
est&eacute; <b>a la escucha</b>.

<pre>
# <strong>echo xl1 xl2 xl3 >/etc/dhcpd.interfaces</strong>
</pre>

y edite <em>/etc/dhcpd.conf</em>.  Las opciones son bastante claras:

<pre>
        option  domain-name &quot;xyz.mil&quot;;
        option  domain-name-servers 192.168.1.3, 192.168.1.5;

        subnet 192.168.1.0 netmask 255.255.255.0 {
                option routers 192.168.1.1;

                range 192.168.1.32 192.168.1.127;
        }
</pre>

<p>
Con esto indicar&aacute; a sus clientes dhcp que el dominio que deben
a&ntilde;adir a sus requerimientos de DNS es xyz.mil (as&iacute;, si un
usuario escribiera 'telnet joe', los enviar&iacute;a a joe.xyz.mil).
Les dirigir&aacute; a los servidores de DNS 192.168.1.3 y 192.168.1.5.
Para los hu&eacute;spedes que se encuentren en la misma red que una
interfaz de ethernet en la m&aacute;quina de OpenBSD, que est&aacute;
en el rango 192.168.1.0/24, les asignar&aacute; una direcci&oacute;n de
IP entre 192.168.1.32 y 192.168.1.127, configurando su pasarela por
definici&oacute;n como 192.168.1.1.

<p>
Si quiere iniciar dhcpd desde la l&iacute;nea de &oacute;rdenes,
despu&eacute;s de editar <em>/etc/dhcpd.conf</em> intente lo siguiente:

<pre>
# <strong>dhcpd -q fxp0</strong>
</pre>

En donde fxp0 es la interfaz que Vd. desea que empiece a servir dhcp.
El indicador -q fuerza dhcpd en silencio, de otro modo es muy ruidoso.

<p>
Si est&aacute; actuando como servidor de DHCP para una m&aacute;quina
Windows, es posible que quiera que dhcp ofrezca al cliente una
direcci&oacute;n de servidor 'WINS'.  Para ello a&ntilde;ada la
siguiente l&iacute;nea al fichero <em>/etc/dhcpd.conf</em>:

<pre>
option	netbios-name-servers	192.168.92.55;
</pre>

En donde 192.168.92.55 es el IP de su servidor de Windows o Samba.
Para ver m&aacute;s opciones que puedan aceptar sus clientes DHCP, lea
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dhcp-options&apropos=0&sektion=5&format=html">dhcp-options(5)</a>.

<p>
<a name="6.5"></a>
<h2>6.5 - PPP </h2>
</p>

El &laquo;Protocolo Punto a Punto&raquo; es el que se suele usar para
crear una conexi&oacute;n con su ISP a trav&eacute;s de un
m&oacute;dem.  OpenBSD puede hacer esto de dos maneras:

<ul>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppd&sektion=8&format=html">pppd(8)</a> - Es el d&aelig;mon ppp del n&uacute;cleo (<em>&quot;kernel&quot;</em>) del sistema.
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&sektion=8&format=html">ppp(8)</a> - Es el d&aelig;mon ppp del modo usuario.
</ul>

<p>
Primero trataremos el d&aelig;mon del modo de usuario.  Para empezar
necesitar&aacute; algo de informaci&oacute;n sobre su isp.  He
aqu&iacute; una lista de la informaci&oacute;n que necesitar&aacute;:
</p>

<ul>
   <li>El n&uacute;mero de tel&eacute;fono de conexi&oacute;n de su
       proveedor (ISP)
   <li>Su <em>nameserver</em> (nombre del servidor) 
   <li>Su nombre de usuario y contrase&ntilde;a
   <li>Su pasarela (<em>gateway</em>)
</ul>

<p>
Parte de esta informaci&oacute;n no es estrictamente necesaria, pero
ser&aacute; de gran ayuda para configurar ppp.  El d&aelig;mon PPP de
modo usuario utiliza el fichero
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/ppp/ppp.conf.sample">/etc/ppp/ppp.conf</a>
como fichero de configuraci&oacute;n.  Existen muchos ficheros en
<em>/etc/ppp</em> de gran utilidad, que pueden contener diferentes
ejemplos de configuraci&oacute;n para situaciones distintas.  Le
aconsejamos que mire en ese directorio.
</p>

<p>
En caso de no estar usando un n&uacute;cleo GENERIC, aseg&uacute;rese
de que tiene la siguiente l&iacute;nea en su fichero de
configuraci&oacute;n:
</p>

<ul><pre><strong>
pseudo-device   tun             2
</strong></pre></ul>


<h3>Configuraci&oacute;n inicial para PPP(8)</h3>

<p>
La configuraci&oacute;n inicial del d&aelig;mon PPP de modo usuario
consiste en editar su fichero <em>/etc/ppp/ppp.conf</em>.  Este fichero
no existe y debe ser creado, pero puede tomar el fichero
<em>/etc/ppp/ppp.conf.sample</em>, editarlo, y crear su propio fichero
<em>ppp.conf</em> a partir de ah&iacute;.  Aqu&iacute; empezar&eacute;
con la m&aacute;s simple, y probablemente m&aacute;s utilizada,
configuraci&oacute;n.  A continuaci&oacute;n puede ver un
peque&ntilde;o fichero <em>ppp.conf</em> que llevar&aacute; a cabo la
conexi&oacute;n con su ISP y usar&aacute; sus rutas predefinidas y su
<em>nameserver</em>.  Para este fichero, toda la informaci&oacute;n que
necesitar&aacute; ser&aacute; el n&uacute;mero de tel&eacute;fono de su
ISP, su nombre de usuario, y su contrase&ntilde;a.
</p>

<ul>
<pre>
default:
set log Phase Chat LCP IPCP CCP tun command     
set device /dev/cua01                           
set speed 115200     
set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \"\" AT OK-AT-OK ATE1Q0 OK\\dATDT\\T TIMEOUT 40 CONNECT"
</pre>
</ul>

<p>
<b>AVISO</b> - En OpenBSD 2.6, el sistema se lanz&oacute; con un
fichero <em>/etc/ppp/ppp.conf.example</em> que conten&iacute;a una
configuraci&oacute;n err&oacute;nea para el dispositivo.  El
dispositivo era <b>"set device /dev/cuaa0"</b> cuando en realidad
deb&iacute;a ser <em>/dev/cua00</em>, que corresponde al dispositivo
para el puerto de comunicaciones 1 (COM1).  Su dispositivo
podr&iacute;a no estar en COM1, a&uacute;n as&iacute; este esquema era
err&oacute;neo.
</p>

<p>
La secci&oacute;n en la opci&oacute;n <b>default:</b> ser&aacute;
ejecutada cada vez.  En ella se configura toda la informaci&oacute;n
cr&iacute;tica.  Con &quot;set log&quot; se configuran los niveles de
ingreso.  Esto se puede cambiar;  para m&aacute;s informaci&oacute;n
sobre c&oacute;mo configurar los niveles de ingreso lea la
p&aacute;gina de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&sektion=8&format=html">ppp(8)</a>.
El dispositivo se configura con &quot;set device&quot;.  &Eacute;ste es
el dispositivo en el que se encuentra el modem.  En este ejemplo el
modem est&aacute; en el puerto de comunicaciones 2 (COM2), mientras que
el puerto de comunicaciones 1 corresponder&iacute;a a
<em>/dev/cua00</em>.  Con &quot;set speed&quot; se configura la
velocidad de la conexi&oacute;n por llamada, y con &quot;set dial&quot;
se configura los par&aacute;metros de la llamada.  Con esto se puede
cambiar el tiempo muerto, etc...  Es conveniente dejar esta
l&iacute;nea m&aacute;s o menos como est&aacute;.
</p>

<p>
A continuaci&oacute;n puede pasar a configurar la informaci&oacute;n
espec&iacute;fica para su ISP.  Para ello debe a&ntilde;adir otra
opci&oacute;n en la secci&oacute;n <b>default:</b>.  Puede dar
cualquier nombre a esta etiqueta, pero lo m&aacute;s f&aacute;cil es
darle el nombre de su ISP.  En el ejemplo usaremos <b>myisp:</b> para
la opci&oacute;n que har&aacute; referencia a nuestro ISP.  He
aqu&iacute; una configuraci&oacute;n simple que incorpora todo lo
necesario para conectar:
<p>

<ul>
<pre>
myisp:
set phone 1234567   
set login "ABORT NO\\sCARRIER TIMEOUT 5 ogin:--ogin: ppp word: ppp"
set timeout 120   
set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.0 0.0.0.0
add default HISADDR 
enable dns
</pre>
</ul>

<p>
Aqu&iacute; hemos configurado informaci&oacute;n esencial para un ISP
espec&iacute;fico.  La primera opci&oacute;n, &quot;set phone&quot;, es
para configurar el n&uacute;mero de tel&eacute;fono para la
conexi&oacute;n de su ISP.  La opci&oacute;n &quot;set login&quot; es
para configurar sus opciones de ingreso.  En el ejemplo hemos puesto un
tiempo muerto de espera de 5, lo que significa que terminar&aacute;
nuestro intento de ingreso despu&eacute;s de 5 segundos su no hay
transportador.  De lo contrario esperar&aacute; hasta recibir un
&quot;login&quot; para enviar su nombre de usuario y contrase&ntilde;a.
En el ejemplo, tanto el nombre de usuario como la contraseña son
&quot;ppp&quot;.  Estos valores hay que substituirlos por otros reales.
La opci&oacute;n &quot;set timeout&quot; es para configurar el tiempo
de espera para todo el proceso de ingreso.  La opci&oacute;n &quot;set
ifaddr&quot; es algo complicada.  He aqu&iacute; una explicaci&oacute;n
m&aacute;s extensa sobre ella:
</p>

<ul><pre>
set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.0 0.0.0.0
</pre></ul>

<p>
Hemos configurado la l&iacute;nea anterior con el formato 
&quot;<b>set ifaddr [myaddr[/nn] [hisaddr[/nn] [netmask
[triggeradr]]]]</b>&quot;.  De este modo el primer IP que se
especifique es el que querremos como nuestro IP.  Sin tiene una
direcci&oacute;n IP est&aacute;tica, escr&iacute;bala aqu&iacute;.  En
el ejemplo hemos usado /0, que indica que no es necesario que concuerde
ning&uacute;n bit de esta direcci&oacute;n ip, y que se puede
substituir todo.  El segundo IP que se especifique es el que esperamos
como el IP de nuestro ISP.  Si lo sabe lo puede especificar
aqu&iacute;, pero en la l&iacute;nea no sabemos cu&aacute;l se
asignar&aacute;, as&iacute; que dejaremos que nos lo digan.  Esto es
muy &uacute;til al negociar con algunas implementaciones PPP que no
asignan un n&uacute;mero IP a menos que su conexi&oacute;n les requiera
``0.0.0.0''.
</p>

<p>
La siguiente opci&oacute;n &quot;add default HISADDR&quot; es para
configurar la ruta predefinida a su IP.  Si su IP cambiara, la ruta se
actualizar&iacute;a de forma autom&aacute;tica.  Con &quot;enable
dns&quot; indicamos a nuestro ISP que autentifique nuestras direcciones
<em>nameservers</em>.  No haga esto si est&aacute; usando una DNS
local, ya que ppp circunvalar&aacute; su uso introduciendo algunas
l&iacute;neas en <em>/etc/resolv.conf</em>.
</p>

<h3>C&oacute;mo usar PPP(8)</h3>

<p>
Ahora que ya tenemos el fichero <em>ppp.conf</em> configurado, podemos
intentar una conexi&oacute;n con nuestro ISP.  A continuaci&oacute;n se
dar&aacute;n algunos detalles sobre argumentos de uso com&uacute;n con
ppp.
</p>

<ul>
   <li><em>ppp -auto myisp</em> 
       - Inicia ppp, configura sus interfaces, le conecta con su isp, y
       a continuaci&oacute;n pasa a un plano de fondo.
   <li><em>ppp -ddial myisp</em> 
       - Parecido a -auto, pero si su conexi&oacute;n cayera
       volver&iacute;a a conectar.
</ul>

<p>
Si usa <em>/usr/sbin/ppp</em> sin pasarle ninguna opci&oacute;n, le
pasar&aacute; al modo interactivo, desde donde podr&aacute;
interaccionar directamente con el m&oacute;dem.  De este modo puede
depurar problemas en su fichero <em>ppp.conf</em>.
</p>

<h3>Acciones adicionales con ppp(8)</h3>

<p>
Si necesitara ejecutar &oacute;rdenes al tiempo que conecta o
desconecta, puede hacerlo creando dos ficheros adicionales.
<em>/etc/ppp/ppp.linkup</em> y <em>/etc/ppp/ppp.linkdown</em>.
Puede ver ejemplos de configuraci&oacute;n para estos ficheros en:
</p>

<ul>
   <li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/ppp/ppp.linkup.sample">ppp.linkup</a>
   <li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/ppp/ppp.linkdown.sample">ppp.linkdown</a>
</ul>

<p>
Puede encontrar m&aacute;s informaci&oacute;n en
<a href="http://www.freebsd.org/handbook/userppp.html">http://www.freebsd.org/handbook/userppp.html</a> o en
<a href="http://www.es.freebsd.org/es/FAQ/ppp.html">http://www.es.freebsd.org/es/FAQ/ppp.html</a>.
</p>

<p>
<a name="6.6"></a>
<h2>6.6 - Afinar par&aacute;metros de red</h2>

<h3>6.6.1 - &iquest;C&oacute;mo puedo forzar al n&uacute;cleo del
sistema para obtener un mayor n&uacute;mero de reintentos y tiempos de
espera mayores en las sesiones TCP?</h3>

Para problemas de conexi&oacute;n o enrutamiento puede usar lo
siguiente.  Tenga en cuenta que para que sea más efectivo, ambos lados
de la conexi&oacute;n deben usar valores similares.

<p>
Para forzarlo use <tt>sysctl</tt> e incremente los valores de:

<pre>
net.inet.tcp.keepinittime
net.inet.tcp.keepidle
net.inet.tcp.keepintvl
</pre>

Si usa sysctl -a podr&aacute; ver los valores actuales de estos y
muchos otros par&aacute;metros.  Para cambiar cualquiera de ellos, use
<tt>sysctl -w</tt>, como por ejemplo en
<tt>sysctl -w net.inet.tcp.keepidle=28800</tt>.

<h3>6.6.2 - &iquest;C&oacute;mo puedo activar emisiones dirigidas?</h3>

Por regla general no es aconsejable hacer esto, ya que si su sistema
OpenBSD es un enrutador, permite que puedan enviar tr&aacute;fico a la
direcci&oacute;n o direcciones de emisi&oacute;n de sus redes.

<p>
En algunos casos, como en redes cerradas, puede tener cierta utilidad,
en particular cuando est&eacute; usando implementaciones antiguas del
protocolo NetBIOS.  Se puede activar con <tt>sysctl -w
net.inet.ip.directed-broadcast=1</tt>.  Para saber porqu&eacute; se
encuentra desactivado por definici&oacute;n, inf&oacute;rmese sobre
<a href="http://www.netscan.org">ataques <em>&quot;smurf&quot;</em></a>.

<h3>6.6.3 - No quiero que el n&uacute;cleo haga asignaciones
din&aacute;micas de ciertos puertos</h3>

Tambi&eacute;n existe un sysctl para esto.  De la p&aacute;gina de
manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&apropos=0&sektion=8&format=html">sysctl(8)</a>:

<pre>
A&ntilde;ada la lista de puertos TCP que no deber&iacute;an ser
asignados din&aacute;micamente por el n&uacute;cleo.  Esto se puede
usar para evitar que algunos d&aelig;mons se apropien de un puerto
espec&iacute;fico que sea necesario para el funcionamiento de otro
programa.  La lista de elementos puede ir separada por comas y/o
espacios en blanco.

   sysctl -w net.inet.tcp.baddynamic=749,750,751,760,761,871

Tambi&eacute;n se pueden a&ntilde;adir o eliminar puertos de la lista
actual.

   sysctl -w net.inet.tcp.baddynamic=+748
   sysctl -w net.inet.tcp.baddynamic=-871
</pre>

<a name="6.7"></a>
<h2>6.7 - Uso simple de NFS</h2>

<p>
El &laquo;Sistema de Archivos de Red&raquo; (NFS, <em>&quot;Network
File System&quot;</em>) se usa para compartir un sistema de archivos en
una red.  Algunas p&aacute;ginas de manual que deber&iacute;a leer
antes de que intente configurar un servidor de NFS son:

<p>

<ul>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nfsd&sektion=8&format=html">nfsd(8)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mountd&sektion=8&format=html">mountd(8)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=exports&sektion=5&format=html">exports(5)</a>
</ul>

<p>
En esta secci&oacute;n se detallar&aacute;n los pasos para una
configuraci&oacute;n simple de NFS.  El ejemplo ofrece detalles sobre
un servidor en una LAN, con clientes que tengan acceso NFS en la LAN.
En esta secci&oacute;n no se tratar&aacute; sobre la seguridad de NFS.
Asumiremos que Vd. ya ha configurado su paquete de filtros, u otra
protecci&oacute;n como cortafuegos, para prevenir el acceso desde el
exterior.  Si su configuraci&oacute;n permite el acceso desde el
exterior a su servidor de NFS, y si tiene alg&uacute;n tipo de datos
confidenciales o importantes, le recomendamos encarecidamente que haga
uso de <a href="faq13.html">IPSec</a>.  De otro modo existe la
posibilidad de que extra&ntilde;os puedan ver su tr&aacute;fico NFS.
Tambi&eacute;n ser&iacute;a posible que alguien pretendiera estar en la
direcci&oacute;n IP que tenga autorizada la entrada en su servidor NFS.
Existen varios tipos de ataques efectivos en este aspecto.  Cuando
IPSec est&aacute; correctamente configurado, protege contra todos estos
tipos de ataques.

<p>
Otra nota importante sobre seguridad.  No se limite a a&ntilde;adir un
sistema de archivos a <em>/etc/exports</em> sin alg&uacute;n tipo de
lista de hu&eacute;spedes autorizados.  Sin una lista de
hu&eacute;spedes que puedan montar un directorio particular, cualquiera
que pueda llegar a su hu&eacute;sped podr&aacute; montar sus
directorios de NFS en <em>exports</em>.
</p>

<p>
La configuraci&oacute;n consiste en un servidor con el ip
<b>10.0.0.1</b>, que servir&aacute; NFS s&oacute;lo a clientes dentro
de esa red.  El primer paso para configurar NFS es configurar su
fichero <em>/etc/exports</em>.  Este fichero se compone de una lista
con los sistemas de archivo que quiera que se encuentren accesibles por
medio de NFS, y define qui&eacute;n puede acceder a cada uno de ellos.
Existen muchas opciones que puede usar en su fichero
<em>/etc/exports</em>, y es conveniente leer la p&aacute;gina de manual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=exports&sektion=5&format=html">exports(5)</a>.
En este ejemplo empezaremos con un fichero <em>/etc/exports</em> como
el siguiente:
</p>

<ul>
<pre>
#
# NFS exports Database
# See exports(5) for more information.  Be very careful, misconfiguration
# of this file can result in your filesystems being readable by the world.
/work -alldirs -ro -network 10.0.0 -mask 255.255.255.0
</pre>
</ul>

<p>
Esto quiere decir que el sistema de archivo local <em>/work</em>
estar&aacute; disponible por medio de NFS.  <b>-alldirs</b> indica que
los clientes podr&aacute;n montar en cualquier parte del punto de
montaje <em>/work</em>.  <b>-ro</b> indica que s&oacute;lo se
permitir&aacute; montarlo en modo de s&oacute;lo lectura.  Los dos
&uacute;ltimos argumentos indican que s&oacute;lo los clientes dentro
de la red 10.0.0.0 que usen una m&aacute;scara de red 255.255.255.0,
estar&aacute;n autorizados a montar este sistema de archivo.  Esto es
importante en algunos servidores accesibles desde diferentes redes.
</p>

<p>
Una vez que su fichero <em>/etc/exports</em> haya sido configurado,
puede seguir adelante y configurar su servidor NFS.  Primero
deber&iacute;a asegurarse de que las opciones NFSSERVER y NFSCLIENT se
encuentren en la configuraci&oacute;n del n&uacute;cleo de su sistema
(el n&uacute;cleo GENERIC incluye estas opciones).  A
continuaci&oacute;n debe configurar <strong>nfs_server=YES</strong> en
el fichero <em>/etc/rc.conf</em>.  De este modo, cuando reinicie el
sistema, se activar&aacute;n nfsd(8) y mountd(8).  Ahora ya puede
continuar e iniciar los d&aelig;mons Vd. mismo.  Estos d&aelig;mons
deben ser iniciados por root, y debe asegurarse de que portmap(8) se
encuentre funcionando en su sistema.  El ejemplo que sigue sobre
c&oacute;mo iniciar nfsd(8) sirve tanto para TCP como para UDP usando 4
d&aelig;mons.  Para gestionar el m&aacute;ximo n&uacute;mero de
requerimientos de clientes concurrentes a los que quiera dar servicio,
debe activar un n&uacute;mero apropiado de d&aelig;mons del servidor
NFS.

<p>

<ul>
<pre>
# <strong>/sbin/nfsd -tun 4</strong>
</pre>
</ul>

<p>
No s&oacute;lo debe iniciar el servidor nfsd(8), sino que
tambi&eacute;n necesita iniciar mountd(8).  &Eacute;ste es el
d&aelig;mon que da servicio a los requerimientos para montar en NFS.
Para iniciar mountd(8) escriba:
<p>

<ul>
<pre>
# <strong>/sbin/mountd</strong>
</pre>
</ul>

<p>
Si hace alg&uacute;n cambio al fichero <em>/etc/exports</em> mientras
NFS est&eacute; funcionando, tendr&aacute; que avisar a mountd sobre el
cambio pas&aacute;ndole una se&ntilde;al &quot;HUP&quot;:

<ul>
<pre>
# <strong>kill -HUP `cat /var/run/mountd.pid`</strong>
</pre>
</ul>

<p>

<h3>Comprobaci&oacute;n de estad&iacute;sticas en NFS</h3>

<p>
Puede llevar a cabo comprobaciones para asegurarse de que estos
d&aelig;mons est&eacute;n funcionando y registrados con RPC.  Para ello
use rcpinfo(8).

<p>

<ul>
<pre>
$ <strong>rpcinfo -p 10.0.0.1</strong>
   program vers proto   port
    100000    2   tcp    111  portmapper
    100000    2   udp    111  portmapper
    100005    1   udp    633  mountd
    100005    3   udp    633  mountd
    100005    1   tcp    916  mountd
    100005    3   tcp    916  mountd
    100003    2   udp   2049  nfs
    100003    3   udp   2049  nfs
    100003    2   tcp   2049  nfs
    100003    3   tcp   2049  nfs
</pre>
</ul>

<p>
Durante su uso normal, existen unas pocas utilidades más que le
permitir&aacute;n ver lo que est&aacute; ocurriendo con NFS.  Una de
ellas es
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=showmount&sektion=8&format=html">showmount(8)</a>,
que le permite ver qu&eacute; se encuentra montado y qui&eacute;n lo
est&aacute; montando.  Tambi&eacute;n est&aacute; nfsstat(8), que
muestra una informaci&oacute;n de las estad&iacute;sticas mucho
m&aacute;s amplia.  Para usar showmount(8) escriba
<b>/usr/bin/showmount -a host</b>.  Por ejemplo:

<p>

<ul>
<pre>
$ <strong>/usr/bin/showmount -a 10.0.0.1</strong>
All mount points on 10.0.0.1:
10.0.0.37:/work
</pre>
</ul>

<h3>C&oacute;mo montar sistemas de archivo NFS</h3>

<p>
Los sistemas de archivo NFS se deben montar mediante mount(8), o
m&aacute;s
exactamente mediante
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mount_nfs&sektion=8&format=html">mount_nfs(8)</a>.
Para montar un sistema de archivo <em>/work</em> del hu&eacute;sped
10.0.0.1 en un sistema de archivo local <em>/mnt</em>, haga lo
siguiente (no necesita usar una direcci&oacute;n IP, mount se
encargar&aacute; de la resoluci&oacute;n de nombres):
<p>

<ul>
<pre>
# <strong>mount -t nfs 10.0.0.1:/work /mnt</strong>
</pre>
</ul>

<P>
Para que el sistema se monte al iniciar, a&ntilde;ada una algo como lo
que ve a continuaci&oacute;n en su fichero <em>/etc/fstab</em>:

<p>

<ul>
<pre>
10.0.0.1:/work /mnt nfs rw 0 0
</pre>
</ul>

<p>
&iexcl;&iexcl;Es importante que use <tt>0 0</tt> al final de esta
l&iacute;nea para que su m&aacute;quina no intente ejecutar fsck sobre
el sistema de archivo NFS durante el inicio del sistema!!  El resto de
opciones de seguridad t&iacute;picas como noexec, nodev, y nosuid,
tambi&eacute;n deber&iacute;an usarse donde sean posibles, como en:

<p>

<ul>
<pre>
10.0.0.1:/work /mnt nfs rw,nodev,nosuid 0 0
</pre>
</ul>

<p>
De este modo ning&uacute;n dispositivo o programa setuid en el servidor
NFS podr&aacute; traspasar las medidas de seguridad en el cliente NFS.
Si no est&aacute; montando programas para ejecutarlos en el cliente
NFS, a&ntilde;ada noexec a esta lista.


<a name="6.8"></a>
<h2>6.8 - Servicio de Nombres de Dominio  - DNS, BIND, y named</h2>

<h3>6.8.1 &iquest;Qu&eacute; es DNS?</h3>

<p>
El &laquo;Servicio de Nombres de Dominio&raquo; (DNS, &quot;Domain Name
Service&quot;) es una facilidad de red que permite a los dominios de
redes IP proveer resoluciones de direcciones nombre-a-IP y resoluciones
direcci&oacute;n-a-nombre en respuesta a un requerimiento.  Su
instalaci&oacute;n de OpenBSD est&aacute; configurada por
definici&oacute;n como un cliente de DNS, pero no como un servidor de
DNS.  O sea, su instalaci&oacute;n de OpenBSD puede llevar a cabo un
requerimiento de DNS para la direcci&oacute;n de una m&aacute;quina 
contra un servidor de nombres de dominio, pero no puede responder a uno
de esos requerimientos de DNS de por s&iacute; a menos que la configure
para ello.

<p>
Mi m&aacute;quina con OpenBSD est&aacute; conectada actualmente a
Internet a trav&eacute;s de mi proveedor (ISP <em>&quot;Internet
Service Provider&quot;</em>), y por lo tanto puedo usar la utilidad
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nslookup&sektion=8&format=html">nslookup(8)</a>
para ejecutar el requerimiento de DNS:

</p>

<ul>
<pre>
$ <strong>nslookup www.openbsd.org</strong>
Server:  ns4.us.prserv.net
Address:  165.87.201.244

Non-authoritative answer:
Name:    www.openbsd.org
Address:  129.128.5.191
</pre>
</ul>

<p>
<b>165.87.201.244</b> es el nombre del servidor que ha contestado,
porque es el &laquo;nombre de servidor&raquo;
(<em>&quot;nameserver&quot;</em>) que mi ISP me dijo que usara con mi
cuenta, y cuyo n&uacute;mero se introduce en el fichero
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolv.conf&sektion=5&format=html">/etc/resolv.conf</a>.
Pero la respuesta no fue autorizada.  Para una respuesta autorizada,
investiguemos cu&aacute;l es el servidor de DNS autorizado para el
dominio <em>openbsd.org</em>, y pregunt&eacute;mosle por la
direcci&oacute;n de <em>www.openbsd.org</em>:
</p>

<ul>
<pre>
# Identificar el nombre de los servidores de openbsd.org
# con la ayuda del nombre del servidor de mi ISP.
$ <strong>nslookup -type=NS openbsd.org</strong>
Server:  ns4.us.prserv.net
Address:  165.87.201.244

Non-authoritative answer:
openbsd.org     nameserver = cvs.openbsd.org
openbsd.org     nameserver = gandalf.sigmasoft.com
openbsd.org     nameserver = cs.colorado.edu
openbsd.org     nameserver = ns.appli.se
openbsd.org     nameserver = zeus.theos.com

Authoritative answers can be found from:
cvs.openbsd.org internet address = 199.185.137.3
gandalf.sigmasoft.com   internet address = 198.144.202.98
cs.colorado.edu internet address = 128.138.243.151
ns.appli.se     internet address = 194.198.196.230
zeus.theos.com  internet address = 199.185.137.1

# Usar la informaci&oacute;n conseguida para requerir una
# resoluci&oacute;n autorizada:
# requerir la autorizaci&oacute;n zeus.theos.com.
$ <strong>nslookup www.openbsd.org zeus.theos.com</strong>
Server:  zeus.theos.com
Address:  199.185.137.1

Name:    www.openbsd.org
Address:  129.128.5.191
</pre>
</ul>

<p>
<em>zeus.theos.com</em> es, como puede suponer, una m&aacute;quina que
funciona con OpenBSD y que est&aacute; correctamente configurada para
ser un servidor de DNS para el dominio <em>openbsd.org</em>.
</p>

<a name="6.8.1.1"></a>
<h3>6.8.1.1 &iquest;D&oacute;nde puedo aprender todo sobre DNS y su
implementaci&oacute;n en OpenBSD?</h3>

<ul>
<li>Lea los RFC <a href="http://www.faqs.org/rfcs/rfc1033.html">1033</a>, <a href="http://www.faqs.org/rfcs/rfc1034.html">1034</a>, y <a href="http://www.faqs.org/rfcs/rfc1035.html">1035</a> 
para m&aacute;s informaci&oacute;n sobre el sistema de nombres de
dominio en Internet.</li>
<li>Lea el libro de O'Reilly Associates<i><a href="../../es/books.html#dns&bind">DNS and BIND</a></i>.</li>
<li>Lea las <a href="http://www.openbsd.org/cgi-bin/man.cgi">p&aacute;ginas de manual de OpenBSD</a>,
en especial las p&aacute;ginas de</li>
   <ul>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1&format=html">dig(1)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nslookup&sektion=8&format=html">nslookup(8)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gethostbyname&sektion=3&format=html">gethostbyname(3)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=named&sektion=8&format=html">named(8)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolver&sektion=3&format=html">resolver(3)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolver&sektion=5&format=html">resolver(5)</a>
   </ul>
</ul>

<p>
La orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1&format=html">dig(1)</a>
es epecialmente &uacute;til porque puede requerir un dominio y devolver
la informaci&oacute;n pr&aacute;cticamente en el mismo formato
requerido por los ficheros de configuraci&oacute;n de BIND.  Puede usar
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1&format=html">dig(1)</a>
para examinar nombres de servidores que sepa que est&aacute;n operando
correctamente para comparar su configuraci&oacute;n con la de ellos.
</p>

<h3>6.8.2 &iquest;Necesita mi m&aacute;quina ser un servidor de nombres
de dominio?</h3>

<p>
Si no est&aacute; seguro de si necesita que su m&aacute;quina haga el
papel de servidor de DNS, no la configure de ese modo.  La
instalaci&oacute;n de OpenBSD no activa su m&aacute;quina como servidor
de nombres de dominio por definici&oacute;n, aunque todos los ficheros
necesarios se encuentran instalados.  Para la mayor&iacute;a de
estaciones de trabajo, es suficiente con los ficheros
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&sektion=5&format=html">/etc/hosts</a>
para indicar las direcciones IP de la m&aacute;quinas locales y
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolv.conf&sektion=5&format=html">/etc/resolv.conf</a>
para indicar qu&eacute; servidores de DNS le har&aacute;n el servicio
en la intranet o internet.
</p>

<p>
Por otra parte, podr&iacute;a necesitar configurar su m&aacute;quina
como un servidor de nombres de dominio:

<ul>
<li>Si tiene una LAN IP en la que no quiere replicar los ficheros
    &quot;hosts&quot; de direcciones locales en cada m&aacute;quina,
    puede configurar su m&aacute;quina con OpenBSD como servidor de DNS
    y servir los requerimientos de otras m&aacute;quinas de su
    LAN.</li>

<ul>
<li><b>Nota:</b> No existen restricciones en la pr&aacute;ctica al
    n&uacute;mero de servidores de DNS en una LAN.  Cualquier
    m&aacute;quina o todas las de la LAN puede ofrecer el servicio de
    DNS si se configuran para ello.  Que uno de estos servidores se
    considere autorizado desde fuera de su LAN (o incluso conocido
    desde fuera de la LAN), es un factor de configuraci&oacute;n que
    suele estar controlado por el nivel superior inmediato de su LAn en
    la jerarqu&iacute;a de dominios.</li>
</ul>

<li>Si tiene una LAN IP en la que residen m&aacute;quinas que quiera
    que sean localizables a trav&eacute;s de requerimientos de DNS por
    m&aacute;quinas en otra LAN o WAN.</li>

<li>Si tiene dificultades en resolver el nombre de dominio local a una
    direcci&oacute;n IP, o resolver cualquier otro nombre local a
    direcciones IP aunque tenga los ficheros <em>/etc/hosts</em> y
    <em>/etc/resolv.conf</em> correctamente (v.g., en OpenBSD, Netscape
    a veces se comporta de este modo porque implementa su propia
    herramienta de resoluci&oacute;n, en lugar de usar
    <em>gethostbyname(3)</em> para la b&uacute;squeda de
    direcciones).</li>
</ul>

<p>
Algo m&aacute;s a tener en cuenta es el velocidad de ejecuci&oacute;n.
Como la resoluci&oacute;n de nombres es un proceso repititivo, en el
que el servidor de nombres lleva a cabo repetidos requerimientos de
direcciones en dominios remotos a otros servidores de nombres, la
resoluci&oacute;n de nombres puede tardar algo m&aacute;s si tiene una
conexi&oacute;n por m&oacute;dem a Internet y est&aacute; requiriendo
direcciones remotas a su propio servidor de DNS (que har&aacute;
continuos requerimientos a servidores de nombres remotos a
trav&eacute;s del m&oacute;dem) que si est&aacute; requiriendo el
servidor de nombres de su ISP (que probablemente tenga una
conexi&oacute;n m&aacute;s r&aacute;pida a los servidores de nombres
remotos).
</p>

<h3>6.8.3 &iquest;Cu&aacute;les son los componentes de software del
servidor de DNS?</h3>

<ul>
<li>named <i>(``d&aelig;mon de name'')</i></li>
<li>Los ficheros de configuraci&oacute;n en el directorio bajo la
    jerarqu&iacute;a de <i>/var/named/</i></li>
</ul>

<h4>6.8.3.1 &iquest;Qu&eacute; nivel de BIND tiene soporte?</h4>

<p>
BIND es el nombre de la especificaci&oacute;n del comportamiento de un
servidor de nombres de dominio.  Los componentes de DNS existen para
implementar BIND de forma colectiva.
</p>

<p>
Existen dos especificaciones BIND diferentes:

<ol>
<li>BIND 4</li>
<li>BIND 8</li>
</ol>

<p>
Tal y como queda instalado, OpenBSD <b>named</b> tiene soporte para
BIND 4.x.

<h4>6.8.3.2 &iquest;Cu&aacute;les son algunas de las alternativas a
proveer DNS a trav&eacute;s de la implementaci&oacute;n predefinida de
BIND 4.x?</h4>

<ul>
<li>La implementaci&oacute;n de BIND 8.x en <i>/usr/ports/net/bind8</i> 
    (ver <a href="../../es/ports.html">portes</a>).</li>
<li>Tambi&eacute;n se encuentra disponible
    <a href="http://cr.yp.to/dnscache.html">DNSCache</a>, de D. J.
    Bernstein.  DNSCache tambi&eacute;n se puede encontrar en el
    &aacute;rbol de portes en <em>/usr/ports/net/dnscache/</em>.  Este
    programa incluye un servidor de DNS minimalista que es perfecto
    para sitios que no tengan grandes bases de datos de entradas de
    DNS.  DNSCache se podr&iacute;a manejar por guiones
    (<em>&quot;scripts&quot;</em>) f&aacute;cilmente.  Su
    configuraci&oacute;n no se parece en nada a la de abajo, pero
    est&aacute; bien documentada en su p&aacute;gina web.</li>
<li>Un grupo de personas que estaban particularmente descontentas con
    BIND, decidieron escribir <a href="http://www.dents.org">Dents</a>,
    su propio servidor de DNS, desde cero.  Contiene algunas
    funcionalidades interesantes.</li>
</ul>

<h5>6.8.3.2.1 Nota de <u>Seguridad</u></h5>

<p>
Si usa estas implementaciones alternativas del DNS, estar&aacute;
ofreciendo un servicio de red cr&iacute;tico mediante el uso de unos
programas que pueden no haber sido sometidos al mismo nivel de
escrutinio que el d&aelig;mon de <code>name</code> en la
instalaci&oacute;n base, <strong><code>named</code></strong>, el cual
ha pasado una <a href="../../es/security.html">auditor&iacute;a de
seguridad</a>.  Esta es una consideraci&oacute;n a tener muy en cuenta,
ya que si un servidor de nombres de dominio es puesto en peligro, los
resolucionadores que usen ese servidor de DNS pueden ser
redireccionados al sitio de un impostor.
</p>

<h3>6.8.4 &iquest;Cu&aacute;nto tengo que instalar?</h3>

<p>
Si la configuraci&oacute;n predefinida de la red se instal&oacute;
correctamente durante la instalaci&oacute;n de OpenBSD, tendr&aacute;
todo ya instalado.  S&oacute;lo tiene que configurar el d&aelig;mon de
name (&quot;named&quot;).
</p>

<h3>6.8.5 &iquest;C&oacute;mo configuro DNS?</h3>

<p>
Para configurar DNS en OpenBSD, edite y/o cree los ficheros que
controlan el d&aelig;mon de <code>name</code>, <strong>named</strong>.
La ubicaci&oacute;n por definici&oacute;n de estos ficheros es el
directorio <em>/var/named</em> y sus subdirectorios, en especial el
fichero <em>/var/named/named.boot</em> que es el fichero de
inicializaci&oacute;n para <strong>named</strong>.  Tambi&eacute;n hay
un par m&aacute;s de pasos para la configuraci&oacute;n que se deben
llevar a cabo en <em>/etc</em>.
</p>

<p>
En este documento configuraremos el d&aelig;mon de name en
<em>nemo.yewtopia.com</em> como el nombre nombre primario del servidor
para el dominio (&iexcl;muy peque&ntilde;o!) <em>yewtopia.com</em>.  La
direcci&oacute;n de <em>nemo.yewtopia.com</em> es <em>192.168.1.9</em>.
Otras dos m&aacute;quinas en esa subrred son
<em>crater.yewtopia.com</em> en 192.168.1.1 y
<em>earhart.yewtopia.com</em> en 192.168.1.2.
</p>

<h4>6.8.5.1 Configuraci&oacute;n en <em>/var/named</em></h4>

<h5>6.8.5.1.1 <em>/var/named/named.boot</em></h5>

<ul>
<pre>
; tell what subdir has the lookup database files
directory       /namedb

; type    domain                source host/file
backup file
cache
root.cache
primary   0.0.127.IN-ADDR.ARPA  localhost.rev

; example primary server config:
primary  yewtopia.com yewtopia
primary  1.168.192.IN-ADDR.ARPA yewtopia.rev
</pre>
</ul>

<p>
Esto indica al proceso de inicializaci&oacute;n en qu&eacute;
subdirectorio y bajo qu&eacute; nombres encontrar&aacute; los ficheros
de configuraci&oacute;n de <em>yewtopia.com</em>.

<h5>6.8.5.1.2 <em>/var/named/namedb/localhost.rev</em></h5>

<ul>
<pre>
; Reverse lookup for localhost interface
@       IN      SOA     nemo.yewtopia.com.
your_id.nemo.yewtopia.com.  (
                                14      ; Serial
                                3600    ; Refresh
                                900     ; Retry
                                3600000 ; Expire
                                3600 )  ; Minimum
        IN      NS      nemo.yewtopia.com.
1       IN      PTR     localhost.yewtopia.com.
</pre>
</ul>

<h5>6.8.5.1.3 <em>/var/named/namedb/yewtopia</em></h5>

<ul>
<pre>
; yewtopia.com domain database
yewtopia.com.        IN      SOA     nemo.yewtopia.com.
your_id.nemo.yewtopia.com.  (
                                14      ; Serial
                                3600    ; Refresh
                                900     ; Retry
                                3600000 ; Expire
                                3600 )  ; Minimum
                     IN      NS      nemo.yewtopia.com.

; Addresses
localhost.yewtopia.com.      IN A    127.0.0.1
crater.yewtopia.com.         IN A    192.168.1.1
earhart.yewtopia.com.        IN A    192.168.1.2
nemo.yewtopia.com.           IN A    192.168.1.9
</pre>
</ul>

<h5>6.8.5.1.4 <em>/var/named/namedb/yewtopia.rev</em></h5>

<ul>
<pre>
; yewtopia domain reverse lookup database
1.168.192.in-addr.arpa. IN      SOA     nemo.yewtopia.com.
your_id.nemo.yewtopia.com.  (
                                14      ; Serial
                                3600    ; Refresh
                                900     ; Retry
                                3600000 ; Expire
                                3600 )  ; Minimum
1.168.192.in-addr.arpa. IN      NS      nemo.yewtopia.com.

; Addresses
1.1.168.192.in-addr.arpa. IN PTR crater.yewtopia.com.
2.1.168.192.in-addr.arpa. IN PTR earhart.yewtopia.com.
9.1.168.192.in-addr.arpa. IN PTR nemo.yewtopia.com.
</pre>
</ul>

<h4>6.8.5.2 Configuraci&oacute;n en <em>/etc</em></h4>

<h5>6.8.5.2.1 <em>/etc/resolv.conf</em></h5>

<p>
Aseg&uacute;rese de que <em>/etc/resolv.conf</em> ahora se&ntilde;ale
al dominio de la m&aacute;quina local (en vez de, por ejemplo, el
nombre del servidor de su ISP), de modo que la resoluci&oacute;n del
nombre en requerimientos sea enviada al
<strong>named</strong> que haya configurado.
</p>

<ul>
<pre>
domain yewtopia.com
lookup file bind
</pre>
</ul>

<h4>6.8.5.2.2 <em>/etc/hosts</em></h4>

<p>
Si anteriormente hubiera a&ntilde;adido las direcciones de varias
m&aacute;quinas al fichero <em>/etc/hosts</em>, puede que le interese
acortar su fichero <em>/etc/hosts</em> al estado en que se encontraba
por definic&oacute;n
</p>

<ul>
<pre>
# Host addresses
127.0.0.1       localhost       localhost.localdomain
192.168.1.9     nemo            nemo.yewtopia.com
</pre>
</ul>

<p>
de modo que <strong>named</strong> no sea circunvalado en favor de
direcciones (probablemente caducadas) en el fichero
<em>/etc/hosts</em>.  &iexcl;<u>Aseg&uacute;rese de que tiene al menos
la entrada predefinida de <em>localhost</em></u>, o su red no
iniciar&aacute; correctamente!  Note tambi&eacute;n que <em>nemo</em>
debe aparecer en su propio fichero hosts, o de lo contrario ver&aacute;
un mensaje de error (no da&ntilde;ino) durante el arranque cuando
<em>/etc/netstart</em> invoque
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=route&sektion=8&format=html">route(8)</a>
para a&ntilde;adir <em>nemo</em> (cuyo nombre aparece en
<em>/etc/myname</em>).
</p>

<h4>6.8.5.3 C&oacute;mo usar
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1&format=html">dig(1)</a>
para examinar los resultados.</h4>

<ul>
<pre>
$ <strong>dig @nemo.yewtopia yewtopia any any</strong>

; &lt;&lt;&gt;&gt; DiG 2.2 &lt;&lt;&gt;&gt; @nemo.yewtopia yewtopia any any
; (1 server found)
;; res options: init recurs defnam dnsrch
;; got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 59904
;; flags: qr rd ra; Ques: 1, Ans: 2, Auth: 0, Addit: 1
;; QUESTIONS:
;;      yewtopia, type = ANY, class = ANY

;; ANSWERS:
yewtopia.        3600   SOA     nemo.yewtopia.
your_id.nemo.yewtopia. (
                        14      ; serial
                        3600    ; refresh (1 hour)
                        900     ; retry (15 mins)
                        3600000 ; expire (41 days 16 hours)
                        3600 )  ; minimum (1 hour)
yewtopia.        3600   NS      nemo.yewtopia.

;; ADDITIONAL RECORDS:
nemo.yewtopia.   3600   A       192.168.1.9

;; Total query time: 4 msec
;; FROM: nemo to SERVER: nemo.yewtopia.  192.168.1.9
;; WHEN: Tue May  2 23:47:19 2000
;; MSG SIZE  sent: 25  rcvd: 102
</pre>
</ul>

<h3>6.8.6 &iquest;C&oacute;mo y cu&aacute;ndo inicio y paro DNS?</h3>

<h4>6.8.6.1 Iniciar DNS</h4>

<p>
El d&aelig;mon de name <strong>named</strong> se lanza durante el
inicio del sistema desde
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&sektion=8&format=html">/etc/rc</a>
si la l&iacute;nea instalada por definici&oacute;n en
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&sektion=8&format=html">/etc/rc.conf</a>,
</p>

<ul>
<pre>
named_flags=NO          # para uso normal: &quot;&quot;
</pre>
</ul>

<p>
se cambia a
</p>

<ul>
<pre>
named_flags=&quot;&quot;          # para uso normal: &quot;&quot;
</pre>
</ul>

<p>
Examine tambi&eacute;n estas l&iacute;neas en <em>/etc/rc.conf</em>:
</p>

<ul>
<pre>
named_user=named                # named no deber&iacute;a ejecutarse como root a menos que fuera necesario
named_chroot=/var/named         # D&oacute;nde chroot named si no est&aacute; vac&iacute;o
</pre>
</ul>

<p>
Estos valores predefinidos ser&aacute;n v&aacute;lidos para casi todas
las configuraciones.
</p>

<p>
Para iniciar <strong>named</strong> de forma manual, use la orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ndc&sektion=8&format=html">ndc(8)</a>.
Por ejemplo:
</p>

<ul>
<pre>
# <strong>ndc start</strong>
          o
# <strong>ndc restart</strong>
</pre>
</ul>

<h4>6.8.6.2 Parar DNS</h4>

<p>
El mejor modo de parar el d&aelig;mon de <code>name</code> es usando la
orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ndc&sektion=8&format=html">ndc(8)</a>.
Por ejemplo:
</p>

<ul>
<pre>
# <strong>ndc stop</strong>
</pre>
</ul>

<p>
Si no funcionara, encuentre el id del proceso de <strong>named</strong>
y use la orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kill&sektion=1&format=html">kill(1)</a>
para finalizar el proceso.  El PID para <strong>named</strong> mientras
est&eacute; funcionando se encontrar&aacute; como la primera
l&iacute;nea del fichero <em>/var/named/named.pid</em>.
</p>

<ul>
<pre>
# <strong>cat /var/named/named.pid</strong>
4608
named -t /var/named -u named
# <strong>kill -KILL 4608</strong>
</pre>
</ul>

<h4>6.8.6.3 Reiniciar DNS con una configuraci&oacute;n alterada</h4>

<p>
Para hacer que un proceso en funcionamiento del d&aelig;mon de name se
reinicie recargando su configuraci&oacute;n despu&eacute;s de haberle
hecho cambios, env&iacute;e una se&ntilde;al <em>hangup</em>:
</p>

<ul>
<pre>
# <strong>kill -HUP 4608</strong> 
</pre>
</ul>

<p>
o use la orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ndc&sektion=8&format=html">ndc(8)</a>.
Por ejemplo:
</p>

<ul>
<pre>
# <strong>ndc reload</strong>
</pre>
</ul>

<h3>6.8.7 &iquest;C&oacute;mo bloqueo los requerimientos AXFR?</h3>

<p>
ejemplo:

<ul>
<pre>
garden:/home/jeremy$<strong>  host -l openssh.com</strong>
openssh.com.            NS      zeus.theos.com.
openssh.com.            NS      cvs.openbsd.org.
openssh.com.            NS      gandalf.sigmasoft.com.
openssh.com.            NS      cs.colorado.edu.
openssh.com.            NS      ns.appli.se.
openssh.com.            A       199.185.137.4
cvs.openssh.com.        A       199.185.137.4
localhost.openssh.com.  A       127.0.0.1
</pre>
</ul>

<p>
Esta informaci&oacute;n es &uacute;til para depurar DNS, pero en
algunos casos puede que no le interese que esta informaci&oacute;n se
haga p&uacute;blica.  Si est&aacute; usando in-addr(rfc2317) sin clase
para inverso, &iexcl; 'host -' podr&iacute;a informar sobre todos los
dominios hospedados en su sistema!  Esto se puede solucionar
f&aacute;cilmente con la cl&aacute;usula 'allow-transfer' en su fichero
<em>zone</em>.
<br><br>
Si usa Bind8 necesitar&aacute; especificar los hu&eacute;spedes a los
que quiere permitir la transferencia de zonas en su(s) fichero(s)
individual zone:

<ul>
<pre>
zone "foo.com" in {
        type master;
        file "directory/zonefile";
        allow-transfer {
          127.0.0.1;
          10.0.0.6;
          10.0.255.12;
        };
};
</pre>
</ul>

Tambi&eacute;n puede bloquear las transferencias para todos los
dominios editando <em>/var/named.conf</em> y a&ntilde;adi&eacute;ndo el
par&aacute;metro 'allow-transfer' a la secci&oacute;n 'options' del
fichero de configuraci&oacute;n:

<ul>
<pre>
   options {
        allow-transfer { 127.0.0.1; };
    };
</pre>
</ul>

El m&eacute;todo para Bind8 tambi&eacute;n funciona para Bind9.<br>
Si est&aacute; usando Bind 4 (predefinido en OpenBSD), puede editar
<em>/var/named/named.boot</em> y usar la opci&oacute;n 'xfrnets'.<br>

<ul>
<pre>
xfrnets 209.142.221.5 12.7.96.7
; type    domain                source host/file                backup file
cache     .                                                     root.cache
primary   0.0.127.IN-ADDR.ARPA  localhost.rev
</pre>
</ul>

Bind 4 permite transferencias desde clases enteras, por lo que no es
tan exacto.  Generalmente, los &uacute;nicos hu&eacute;spedes que
necesitan llevar a cabo transferencias son los esclavos y
hu&eacute;spedes de DNS desde los que quiera depurar (127.0.0.1 es
normalmente un buen hu&eacute;sped desde donde permitir
transferencias).  El bloqueo de requerimientos AXFR a&ntilde;ade un
nivel adicional de privacidad, pero puede entorpecer el &uacute;til
depurado de DNS (gracias a 
<a href="mailto:ntang@nachtwache.org">Nicholas Tang</a> por este
consejo).
</p>


<h3>6.8.7 &iquest;Qu&eacute; ha quedado en el tintero sobre la
configuraci&oacute;n de DNS?</h3>

<p>
Hay muchas cosas de las que no hemos hablado, como por ejemplo,
c&oacute;mo configurar DNS para que los requerimientos para dominios de
intranet que no sean visibles desde la ra&iacute;z de la
jerarqu&iacute;a del dominio dependan de servidores dentro de su
empresa.  Lea los <a href="#6.8.1.1">documentos que le recomendamos</a>
para m&aacute;s informaci&oacute;n sobre DNS.
</p>


<a name="6.9"></a>
<h2>6.9 - Configuraci&oacute;n de una conexi&oacute;n PPTP en
OpenBSD</h2>

<p>
<strong>NOTA:</strong> Esta informaci&oacute;n no es v&aacute;lida para
<strong>TODOS</strong> los proveedores de conexiones ADSL, pero mucha
de la informaci&oacute;n que encontrar&aacute; aqu&iacute; se puede
usar como base.  Esta informaci&oacute;n s&oacute;lo se ha comprobado
con <a href="http://www.inode.at">Inode</a>, un proveedor de ADSL en
Austria.
</p>

<p>
Antes que nada debe instalar pptp.  Existe un porte de pptp en el
&aacute;rbol de portes de OpenBSD que fue a&ntilde;adido A PARTIR de la
versi&oacute;n 2.8 de OpenBSD, y que se instala y funciona bien desde
el mismo &aacute;rbol.  Lo puede encontrar en <em>/ports/net/pptp</em>.
Para m&aacute;s informaci&oacute;n sobre el &aacute;rbol de portes de
OpenBSD, lea la <a href="faq8.html#8.6">secci&oacute;n 8.6</a> de las
preguntas frecuentes.
</p>

<p>
Debido a un conflicto entre el soporte integrado en el n&uacute;cleo de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gre&apropos=0&sektion=0&manpath=OpenBSD+Current&arch=i386&format=html">gre(4)</a>
y pptp, tendr&aacute; que recompilar el n&uacute;cleo del sistema,
eliminando el soporte de gre(4).
</p>

<ul>Parche para eliminar el soporte de GRE(4).
<pre>
Index: sys/conf/GENERIC
===================================================================
RCS file: /cvs/src/sys/conf/GENERIC,v
retrieving revision 1.66
diff -u -r1.66 GENERIC
--- sys/conf/GENERIC    2000/10/13 04:21:14     1.66
+++ sys/conf/GENERIC    2000/12/26 19:55:31
@@ -97,6 +97,6 @@
 pseudo-device  ksyms   1	# kernel symbols device
 pseudo-device  bridge  2	# network bridging support
 #pseudo-device vlan    2	# IEEE 802.1Q VLAN
-pseudo-device  gre     1	# GRE encapsulation interface
+#pseudo-device gre     1	# GRE encapsulation interface

 option		BOOT_CONFIG     # add support for boot -c
</pre>
</ul>

<p>
Para recompilar el n&uacute;cleo, obtenga antes la distribuci&oacute;n
2.8-stable de OpenBSD mediante cvs (lea la p&aacute;gina de
<a href="../../es/stable.html">OpenBSD Stable</a> para m&aacute;s
informaci&oacute;n), aplicar el parche anterior al fichero de
configuraci&oacute;n del n&uacute;cleo, <em>GENERIC</em>, y recompilar
el n&uacute;cleo tal y como se describe en la
<a href="faq5.html#5.3">secci&oacute;n 5.3</a> de las preguntas
frecuentes.
</p>

<p>
Una vez que ya tenga instalado el paquete <strong>pptp</strong> y el
nuevo n&uacute;cleo, deber&aacute; editar unos cuantos ficheros para
configurar su conexi&oacute;n.  Este paquete utiliza el programa de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&apropos=0&sektion=0&manpath=OpenBSD+Current&arch=i386&format=html">ppp(8)</a>
nativo de OpenBSD;  si est&aacute; familiarizado con ppp(8), gran parte
de la configuraci&oacute;n es id&eacute;ntica.  Lea tambi&eacute;n la
<a href="#6.5">secci&oacute;n 6.5</a> de este documento.
</p>

<ul>
<li>1 - /etc/ppp/options
<li>2 - /etc/ppp/pap-secrets
</ul>

<p>
Para el fichero <em>/etc/ppp/options</em>, una configuraci&oacute;n
como la siguiente ser&aacute; probablemente todo lo que necesite:
</p>

<ul>
<pre>
# <strong>cat /etc/ppp/options</strong>
name &quot;LOGINNAME&quot;
noauth
noipdefault
defaultroute
debug
</pre>
</ul>

<p>
Debe substituir <tt>LOGINNAME</tt> con su identificador de usuario.
</p>

<p>
Para el fichero <em>/etc/ppp/pap-secrets</em> necesitar&aacute; una
l&iacute;nea como &eacute;sta:

<ul>
<pre>
# <strong>cat /etc/ppp/pap-secrets</strong>
LOGINNAME 10.0.0.138 PASSWORD
</pre>
</ul>

<p>
En donde LOGINNAME es su identificador de usuario y PASSWORD su
contrase&ntilde;a.  10.0.0.138 es la direcci&oacute;n IP asignada a su
modem en caso de que use ADSL, etc.  Aseg&uacute;rese de que este
fichero sea de &laquo;s&oacute;lo lectura&raquo; para el usuario
&quot;root&quot; (modo 600).
</p>

<h3>6.9.1 - Asignaci&oacute;n de una direcci&oacute;n a su interfaz de
red</h3>

<p>
En el ejemplo anterior, el modem ven&iacute;a con una interfaz
10.0.0.38 preconfigurada.  Pero ahora necesitaremos asignar una
direcci&oacute;n a NUESTRA interfaz.  Lo mejor es escoger una
direcci&oacute;n IP cercana a la asignada para el MODEM, o usar la
direcci&oacute;n IP est&aacute;tica que nos hayan asignado.  Puede leer
m&aacute;s sobre c&oacute;mo configurar interfaces en la
<a href="#6.1">secci&oacute;n 6.1</a> de este documento.
</p>

<p>
Una vez que haya configurado su interfaz, deber&iacute;a poder
establecer una conexi&oacute;n pptp con la orden:

<ul>
<pre>
# <strong>/usr/local/sbin/pptp 10.0.0.138 &amp;</strong>
</pre>
</ul>

<p>
Como ya hemos dicho, usar&aacute; el ppp(8) nativo de OpenBSD, e
iniciar&aacute; dos procesos;  en consecuencia, podr&aacute; matar pptp
matando estos dos procesos:
</p>

<ul>
<pre>
# <strong>kill -9 [pid de pppd]</strong>
% <strong>kill -9 [pid de pptp]</strong>
</pre>
</ul>

Es recomendable abrir <tt>/var/log/messages</tt> en una ventana de
terminal aparte, para poder reconoce cualquier posible problema.

<ul>
<pre>
# <strong>tail -f /var/log/message</strong>
</pre>
</ul>
</p>

<p>
Tambi&eacute;n le sugerimos que ponga la orden de inicio en
<em>/etc/rc.local</em> para que conecte de forma autom&aacute;tica
cuando reinicie el sistema.
</p>


<p>
<p>
<font color="#0000e0">
<a href="index.html">[Volver al &iacute;ndice principal]</a>
<a href="faq5.html">[Secci&oacute;n 5.0 - Configuraci&oacute;n del n&uacute;cleo y del disco]</a>
<a href="faq7.html">[Secci&oacute;n 7.0 - Controles del teclado]</a>
</font>
</p>

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../back.gif" border="0" alt="[&iacute;ndice]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: faq6.html,v 1.99 2001/05/06 16:33:15 jufi Exp ]<br>
$Translation: faq6.html,v 1.33 2001/05/06 20:26:29 horacio Exp $<br>
$OpenBSD: faq6.html,v 1.25 2001/05/07 05:56:56 jufi Exp $
</small>
</p>
</body>
</html>
