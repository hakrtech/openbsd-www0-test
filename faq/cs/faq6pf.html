<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Staré PF FAQ</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-2">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998-2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- passes validator.w3.org, please keep it this way -->

<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
<p>

<h1><font color="#e00000">PF</font></h1>
<h4:Poznámka: Tato sekce byla nahrazena
<a href="../pf/cs/index.html">Novou U¾ivatelskou pøíruèkou PF</a>.</h4>

<hr>

<p>
<h3>Obsah</h3>
<ul>
<li><a href= "#PF"    >6.2 - Packet Filter (PF)</a>
<li><a href= "#NAT"   >6.3 - Pøeklad sí»ových adres (NAT) </a>
</ul>

<hr>

<p>
<a name="6.2"></a>
<a name="PF"></a>
<h2>6.2 - Packet Filter (PF)</h2>

<p>
<h4>Poznámka: V OpenBSD 3.2 byla funkce <i>/etc/nat.conf</i>
pøesunuta do <i>/etc/pf.conf</i>.
</h4>

<p>
Nový soubor
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5"><i>/etc/pf.conf</i></a>
má ètyøi èásti:

<ul>
<li><b>Options:</b> Rùzné volby ovlivòující èinnost PF.
<li><b>Scrub:</b> Pøepracování paketù kvùli normalizaci a defragmentaci.
<li><b><a href="#NAT">Pravidla NATu a pøesmìrování</a></b> NAT umo¾òuje
  více strojùm pøistupovat na Internet pomocí jedné IP adresy.
  Pøesmìrování umo¾òuje, aby pøíchozí pakety byly pøeposlány na
  urèený stoj za NATem.
<li><b>Pravidla filtru:</b> Umo¾òuje selektivní filtrování nebo
  blokování paketù, kdy¾ procházejí nìkterým z rozhraní.

<p>
Subsystém Packet Filter slou¾í k zaji¹tìní dvou úloh, filtrování na
úrovni paketù a mapování poèítaèù a podsítí na okruh externích adres.
Konfiguraèní soubor pro tuto slu¾bu je
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+3.2">/etc/pf.conf(5)</a></i>.

<p>
Aby se tyto slu¾by spou¹tìly pøi startu systému, musíte upravit 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&amp;sektion=8">/etc/rc.conf(8)</a></i>
a nastavit pøíslu¹ný øádek na:

<blockquote><pre>
pf=YES
</pre></blockquote>

<p>
Pokud pou¾íváte NAT, nejspí¹ budete muset nastavit také hodnotu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8">sysctl(8)</a>
<tt>net.inet.ip.forwarding</tt> na 1. To mù¾ete udìlat odkomentováním
pøíslu¹ného øádku v 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl.conf&amp;sektion=5">/etc/sysctl.conf(5)</a></i>
a restartováním poèítaèe.

<p>
Pokud máte Packet Filter zakompilovaný v jádøe, ale nemáte ho aktivován v
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&amp;sektion=8">/etc/rc.conf(8)</a></i>,
mù¾ete ho stále je¹tì aktivovat pøíkazem
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.2">pfctl(8)</a>.

<blockquote><pre>
# <b>pfctl -f /etc/pf.conf</b>
# <b>pfctl -e</b>
</pre></blockquote>

<p>
První øádek nastavuje filtrování a NAT podle <i>/etc/pf.conf</i>,
a druhý aktivuje PF.

<p>
Mù¾ete to také zapsat jedním pøíkazem:
<blockquote><pre>
# <strong>pfctl -f /etc/pf.conf -e</strong>
</pre></blockquote>

<p>
Pokud udìláte zmìny v <i>/etc/pf.conf</i> poté
co je PF spu¹tìn, mù¾ete znovu nahrát pravidla opìtovným naètením
pøíslu¹ného souboru:

<blockquote><pre>
# <b>pfctl -f /etc/pf.conf</b>
</pre></blockquote>

<p>
Tento dokument dále popisuje jen nìkolik základních konfigurací  
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+3.2">pf.conf(5)</a>.
Mù¾ete se také podívat na <a href="#sample_pf.conf">výsledná
pravidla</a>, která obsahují v¹echna vylep¹ení detailnì popsaná ní¾e.
Dal¹í informace o Packet Filteru najdete na
<a href="http://www.benzedrine.cx/pf.html">webové stránce Packet Filteru</a> 
a v 
<a href="http://www.inebriated.demon.nl/pf-howto/">Packet Filter HOWTO</a>. 

<p>
<h3>Packet Filter</h3>

<p>
Abyste zapnuli Packet Filter pøi bootu, musíte upravit
<i>/etc/rc.conf</i> tak, aby obsahoval <tt>pf=YES</tt>.  Packet Filter
(pf) se nastavuje pomocí <i>/etc/pf.conf</i>, který je naèten pøi bootu.  
Detailnìj¹í vysvìtlení si pøeètete v
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+3.2">pf.conf(5)</a>. 
V následujících pøíkladech reprezentuje <tt>fxp0</tt> externí rozhraní k
internetu.  Ve va¹em pøípadì bude patrnì jiné, podle ethernetového
adaptéru ve va¹em poèítaèi. Pravidla pøedpokládají trvalé spojení s
Internetem, jaké byste zaøídili patrnì pro webserver.

<p>
Pravidla Packet Filtru jsou zpracovávána postupnì od shora dolù.  Ka¾dý
paket musí pøejít pøes tato pravidla, pøedtím ne¾ dosáhne svého urèení.

<p>
Napøíklad implicitní soubor pravidel umo¾òuje ka¾dému paketu cestovat
dovnitø a ven:

<blockquote><pre>
pass out all 
pass in all
</pre></blockquote>

<p>
co¾ je zkrácený zápis

<blockquote><pre>
pass in from any to any
pass out from any to any
</pre></blockquote>

<p>
To znamená &quot;propus» pøíchozí pakety odkudkoliv, smìøující
kamkoliv&quot; s implikovaným &quot;na ka¾dém rozhraní (co¾ je
pøedpokládáno poka¾dé, pokud není specifikováno konkrétní rozhraní)
ka¾dé address family,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inet&amp;sektion=4">inet (v4)</a>
nebo <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inet6&amp;sektion=4">inet6 (v6)</a>&quot;.

<p>
Pochopitelnì ¾e tohle není ¾ádný filtr. Skuteèné filtrování bude
zalo¾eno na address family (IPv4 nebo IPv6), protokolu a portu
vyu¾ívaných slu¾bou, kterou chcete filtrovat. Mù¾ete specifikovat
kterýkoli protokol z
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=protocols&amp;sektion=5">/etc/protocols(5)</a></i>,
a» u¾ jménem nebo èíslem, ale my se zamìøíme na
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcp&amp;sektion=4">tcp(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=udp&amp;sektion=4">udp(4)</a> a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp&amp;sektion=4">icmp(4)</a>.

<p>
Nyní pøedpokládejme, ¾e nechceme dovolit jakékoliv pøíchozí IPv4
spojení na port 3306 (MySQL), proto¾e k databázi by mìl být pøístup
pouze z localhostu.  Soubor pravidel by vypadal takto:

<blockquote><pre>
pass out all
pass in all
block in on fxp0 inet proto tcp from any to any port 3306
</pre></blockquote>

<p>
Toto øíká &quot;blokuj v¹echny pøíchozí IPv4 (inet) pakety, pøicházející
odkudkoliv, smìøující kamkoliv, jejich¾ cílem je port 3306.&quot;
V¹imnìte si, ¾e pokud filtrujete podle portu, musíte uvést také protokol
a doporuèuje se urèit i address family. Slu¾by definované v souboru
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5">/etc/services(5)</a>
mù¾ete také specifikovat jejich jménem, napøíklad <em>www</em> nebo 
<em>mysql</em>.
Paket urèený pro port 3306 na zaøízení <tt>fxp0</tt> projde pøes první
&quot;pass in&quot; pravidlo a potom bude odhozen díky pravidlu 
&quot;block in port 3306&quot;. Pokud zmìníte poøadí va¹ich pravidel 
(vzpomeòte si, poøadí je dùle¾ité):

<blockquote><pre>
pass out all
block in on fxp0 inet proto tcp from any to any port 3306
pass in all
</pre></blockquote>

<p>
Pakety urèené pro port 3306 projdou, proto¾e poslední pravidlo souboru
dovoluje v¹em pøíchozím paketùm projít. Je dùle¾ité pamatovat si pøi
psaní pravidel pro Packet Filter, ¾e:
<b> Poslední odpovídající pravidlo vítìzí</b>.

<p>
Samozøejmì ¾e existují výjimky pro ka¾dé pravidlo. Volba <em>quick</em>
ukonèí zpracování paketu na prvním pravidlu, které odpovídá. Podívejme
se na pøedcházející pøíklad.
Pokud pøidáme <em>quick</em> k pravidlu &quot;block in&quot;:

<blockquote><pre>
pass out all
block in quick on fxp0 inet proto tcp from any to any port 3306
pass in all
</pre></blockquote>

<p>
Paket urèený pro ná¹ poèítaè na port 3306 bude zpracován bezprostøednì
pravidlem &quot;block in quick&quot; a bude odhozen. V¹echny pakety
urèené pro jiné porty nenajdou odpovídající pravidlo, dokud nedosáhnou
pravidla &quot;pass in&quot;, které jim dovolí projít.

<p>
<b>Default Deny</b>
<p>
Nejbezpeènìj¹í politika filtrování paketù je tzv. politika default
deny.  V¹echny pakety, které nejsou pøímo dovoleny, jsou odhozeny. Tato
politika je mnohem bezpeènìj¹í ne¾ pøímo nepovolovat ka¾dou chránìnou
slu¾bu, umo¾òuje mít relativnì malý soubor pravidel a také mù¾e ochránit
od ¹patnì nakonfigurované slu¾by, která je ponechána svému osudu.

<p>
Nyní se podívejte na jiný pøíklad skuteèného ¾ijícího pøíkladu pravidel
a vysvìtleme si øádku po øádce jejich význam. Je to pøíklad webserveru s
default deny politikou, která povoluje pouze ssh spojení (pro
administraci) a spojení http (port 80) a https (port 443).

<blockquote><pre>
block in on fxp0 all
pass  in on fxp0 inet proto tcp from any to any port 22
pass  in on fxp0 inet proto tcp from any to any port 80
pass  in on fxp0 inet proto tcp from any to any port 443
pass out on fxp0 all
</pre></blockquote>

<p>
Tato pravidla dovolí projít pøíchozím spojením odkudkoliv na tcp porty
22(ssh), 80(http) a 443(https). Odhodí v¹echny ostatní pakety a umo¾ní
v¹echna odchozí spojení. To u¾ je celkem dobrá sada pravidel.  Co kdy¾
ale chcete dovolit ssh spojení pouze z interních strojù ve va¹em
adresovém bloku 1.1.1.0, ale dovolit spojení zvenku na http a https?

<blockquote><pre>
block in on fxp0 all
pass  in on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22
pass  in on fxp0 inet proto tcp from any to any port 80
pass  in on fxp0 inet proto tcp from any to any port 443
pass out on fxp0 from all
</pre></blockquote>

<p>
Docela dobré, ale co kdy¾ chceme dovolit pouze jednomu stroji (1.1.1.1)
administrovat webserver vzdálenì?
V tomto pøípadì mù¾eme zmìnit:

<blockquote><pre>
pass  in on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22
</pre></blockquote>

<p>
na:
<blockquote><pre>
pass  in on fxp0 inet proto tcp from 1.1.1.1/32 to any port 22
</pre></blockquote>

<p>
<b>Pøíklad souboru pravidel</b>
<p>
Zde je nìkolik pravidel pro ka¾dého (pøedpokládejme, ¾e fxp0 je externí
zaøízení pøipojené na internet). Nejprve nastolíme jednoduchou address
spoofing ochranu.  Tyto adresy by (normálnì) nemìly poletovat
Internetem, a pokud ano, je to málokdy dobøe, tak¾e je zablokujeme:

<blockquote><pre>
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }
</pre></blockquote>

<p>
Ná¹ soubor pravidel zatím vypadá dobøe; kdy¾ to dáme v¹echno dohromady,
vypadá to takto:

<blockquote><pre>
# don't allow anyone to spoof non-routeable addresses
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }

# only allow our administration machine to connect via ssh
pass in quick on fxp0 inet proto tcp from 1.1.1.1/32 to any port 22

# allow others to use http and https
pass in quick on fxp0 inet proto tcp from any to any port 80
pass in quick on fxp0 inet proto tcp from any to any port 443

# finally lock the rest down with a default deny
block in quick on fxp0 from any to any

# and let out-going traffic out
pass out on fxp0 from any to any
</pre></blockquote>

<p>
<b>Logování paketù</b>
<p>
Nyní je na¹e situace dost dobrá, ale mohla by být je¹tì lep¹í. Co kdy¾
chceme logovat ka¾dý pokus o spojení na port 22(ssh), který byl
firewallem zablokován?  Jednodu¹e, Packet Filter to umo¾òuje pomocí
slova <em>log</em>:

<blockquote><pre>
pass in quick on fxp0 inet proto tcp from 1.1.1.1/32 to any port 22
block in log quick on fxp0 inet proto tcp from any to any port 22
</pre></blockquote>

<p>
Toto pravidlo dovolí na¹emu vzdálenému administraènímu poèítaèi spojení
na port 22, ale blokuje a loguje v¹echny ostatní pokusy o spojení na
port 22.

<p>
Logované pakety jsou posílány na rozhraní pflog0, které monitoruje
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.2">pflogd(8)</a>,
jen¾ vìt¹inou dumpuje pakety do <i>/var/log/pflog</i> v binárním formátu pro 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.2">tcpdump(8)</a>.
pflogd(8) je standardnì pou¹tìn z 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&amp;sektion=8">/etc/rc(8)</a></i>,
pokud je pf zapnutý v
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&amp;sektion=8">/etc/rc.conf(8)</a></i>.
Tento soubor logù si mù¾ete pøeèíst následujícím pøíkazem:

<blockquote><pre>
# <b>tcpdump -n -e -ttt -r /var/log/pflog</b>
</pre></blockquote>

<p>
Mìli byste si být vìdomi, ¾e pou¾ití tcpdumpu k monitorování souboru pflog
NEZOBRAZUJE výsledky v reálném èase. Pokud chcete vidìt logy v reálném èase,
mù¾ete pou¾ít tento pøíkaz:

<blockquote><pre>
# <b>tcpdump -i pflog0</b>
</pre></blockquote>

<p>
Také je mo¾né usnadnit si ladìní tím, ¾e zmen¹íme zábìr tcpdumpu:

<blockquote><pre>
# <b>tcpdump -e -i pflog0 port 80</b>
</pre></blockquote>

<p>
Tímto NEBUDOU ovlivnìna data, která jsou ulo¾ena v souboru
<i>/var/log/pflog</i>.  

<p>
Pøi zkoumání logù byste mìli být obzvlá¹tì opatrní pøi &quot;verbose
protocol decoding&quot; (aktivovaném volbou -v na pøíkazové øádce).
Tcpdumpové dekodery protokolù nemají úplnì nejlep¹í historie
bezpeènosti.  Alespoò teoreticky jsou mo¾né zpo¾dìné útoky
prostøednictvím urèitého obsahu paketù nahraných logovacím zaøízením.

<p>
Speciální pozornost by mìla být vìnována pøístupu k logùm. Pflogd
odchytí 96 bytù paketu a zapí¹e je do logu. Pøístup k logùm mù¾e
poskytnout èásteèný pøístup k citlivému obsahu paketù (napø.
pøihla¹ování pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1">telnetu(1)</a> nebo 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1">ftp(1)</a> ).
</p>

<p>
<b>Logování paketù pomocí syslogu</b>
<p>
V mnoha situacích je ¾ádoucí mít logy z firewallu dostupné v ASCII
formátu a/nebo je posílat na vzdálený logovací server.
Toho mù¾e být dosa¾eno 2 malými shellovými skripty a mírnou zmìnou
konfiguraèních souborù OpenBSD.

<p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.2">Syslogd(8)</a>
je standardní logovací démon, loguje v ASCII a je také schopen logovat
na vzdálený logovací server.

<p>
Nejprve musíme vytvoøit u¾ivatele <em>pflogger</em> s .nologin. shellem.
Nejjednodu¹¹í zpùsob jak vytvoøit tohoto u¾ivatele je pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8&amp;manpath=OpenBSD+3.2">adduser(8)</a>.

<p>
Po vytvoøení u¾ivatele <em>pflogger</em> vytvoøte následující dva
skripty:

<p>
<i>/etc/pflogrotate</i>

<blockquote><pre>
FILE=/home/pflogger/pflog5min.$(date "+%Y%m%d%H%M")
kill -ALRM $(cat /var/run/pflogd.pid)
if [ $(ls -l /var/log/pflog | cut -d " " -f 8) -gt 24 ]; then
        mv /var/log/pflog $FILE
        chown pflogger $FILE
        kill -HUP $(cat /var/run/pflogd.pid)
fi
</pre></blockquote>

<p>
<i>/home/pflogger/pfl2sysl</i>

<blockquote><pre>
#!/bin/sh
# feed rotated pflog file(s) to syslog
for logfile in /home/pflogger/pflog5min* ; do
        tcpdump -n -e -ttt -r $logfile | logger -t pf -p local0.info
        rm $logfile
done
</pre></blockquote>

<p>
Upravte crontab u¾ivatele <em>root</em>

<blockquote><pre>
# <b>crontab -u root -e</b>
</pre></blockquote>

<p>
a pøidejte následující dva øádky:

<blockquote><pre>
# rotate pf log file every 5 minutes
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</pre></blockquote>

<p>
Vytvoøte crontab pro u¾ivatele <em>pflogger</em>

<blockquote><pre>
# <b>crontab -u pflogger -e</b>
</pre></blockquote>

<p>
a pøidejte následující dva øádky:

<blockquote><pre>
# feed rotated pflog file(s) to syslog
0-59/5 *       *       *       *       /bin/sh /home/pflogger/pfl2sysl
</pre></blockquote>

<p>
Pøidejte následující øádek do <i>/etc/syslog.conf</i>:

<blockquote><pre>
local0.info    /var/log/pflog.txt
</pre></blockquote>

<p>
Pokud chcete logovat na vzdálený log server, pøidejte také øádek:

<blockquote><pre>
local0.info    @syslogger
</pre></blockquote>

<p>
a ujistìte se, ¾e stroj <i>syslogger</i> je definován v souboru
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5&amp;manpath=OpenBSD+3.2">
/etc/hosts(5)</a>.

<p>
V¹echny zalogované pakety jsou zaznamenány do <i>/var/log/pflog.txt</i>.
Pokud je pøidána i druhá øádka, jsou také poslány na vzdálený logovací
server <i>syslogger</i>.

<p>
<i>/etc/pflogrotate</i> nyní zpracovává a ma¾e <i>/var/log/pflog</i>,
tak¾e rotování <i>pflog</i> pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8&amp;manpath=OpenBSD+3.2">
newsyslogd(8)</a> u¾ není zapotøebí a mìlo by být vypnuto. Nicménì
<i>/var/log/pflog.txt</i> nahrazuje <i>/var/log/pflog</i> a jeho
rotování by mìlo být aktivováno.
Zmìòte <i>/etc/newsyslog.conf</i> takto:

<blockquote><pre>
#/var/log/pflog        600     3       250     *       ZB /var/run/pflogd.pid
/var/log/pflog.txt     600     7       *       24
</pre></blockquote>

<p>
Pf bude nyní logovat v ASCII do /var/log/pflog.txt. Pokud je tak
nastaven v <em>/etc/syslog.conf</em>, bude také posílat logy na vzdálený
server. Logování není okam¾ité, ale mù¾e trvat a¾ 5-6 minut (interval
úlohy v cronu) ne¾ se logované pakety objeví v souboru.

<p>
<b>Vícenásobné protokoly</b>

<p>
Co kdy¾ potøebujeme povolit spojení na slu¾by bì¾ící pøes více
protokolù, jako je bind, který vyu¾ívá TCP a UDP?  Packet Filter vám
umo¾òuje volby spojit dohromady do mno¾in (o tom více podìji):

<blockquote><pre>
# Pass DNS traffic for BIND
pass in quick on fxp0 inet proto { tcp, udp } from any to any port 53
</pre></blockquote>

<p>
V¹imnìte si mezer z obou stran kolem znakù '{ }'. To je èist¹í
ne¾ alternativní zápis, který byste jinak pou¾ili:

<blockquote><pre>
pass in quick on fxp0 inet proto tcp from any to any port 53
pass in quick on fxp0 inet proto udp from any to any port 53
</pre></blockquote>

<p>
<a name="normalization"></a>
<b>Normalizování paketù</b>
<p>
Normalizování paketù znamená opìtné spojování fragmentovaných paketù a
ru¹ení IP options.  Nìkteré operaèní systémy a aplikace mívají problémy
s abnormálními nebo fragmentovanými pakety a je obecnì dobré mít pakety
normalizované pøi porovnávání s pravidly filtru a doruèení cílovému
stroji.  Proto je témìø v¾dy pøínosné normalizovat pakety pøedtím, ne¾
jsou propu¹tìny na své koneèné místo urèení.  To je mo¾né provést volbou
<b>scrub</b>, pou¾itou takto:

<blockquote><pre>
scrub in all
</pre></blockquote>

<p>
To zpùsobuje velmi malé dal¹í zatí¾ení systému a vy¾aduje trochu pamìti
na cachování fragmentù paketu. Pøínos normalizace paketù témìø v¾dy
pøevý¹í tyto ztráty.

<p>
<b>IP options</b>
<p>
Standardnì PF blokuje pakety s nastavenými IP options. To mù¾e ztí¾it
¾ivot utilitám pro &quot;OS fingerprinting&quot;, jako je nmap. Pokud
máte aplikaci, která vy¾aduje propou¹tìní takových paketù, jako
multicast nebo IGMP, mù¾ete vyu¾ít volbu <b>allow-opts</b>:

<blockquote><pre>
pass in quick on fxp0 all allow-opts
</pre></blockquote>

<p>
<b>TCP pøíznaky, vytvoøená spojení a udr¾ování stavu</b>
<p>
Packet Filter mù¾e také filtrovat pakety na základì TCP pøíznakù a
udr¾ovat vytvoøená spojení a stavy spojení. Doporuèujeme, aby v¹ichni
u¾ivatelé, kteøí chtìjí filtrovat pakety podle TCP pøíznakù, rozumìli,
jaký význam ka¾dý pøíznak má. Napøíklad pokud chcete blokovat v¹echny
pakety s nastavenými pøíznaky FIN, URG a PSH (jako ku pøíkladu pokusy o
OS fingerprinting nmapem) pou¾ijete takovéhle pravidlo:

<blockquote><pre>
block in quick on fxp0 inet proto tcp from any to any flags FUP/FUP
</pre></blockquote>

<p>
(Thanks to <a href=mailto:halogen@nol.net>Kyle Hargraves</a> za tento tip)

<p>
Dal¹í skvìlá vlastnost Packet Filteru je jeho schopnost udr¾ovat stav.
Udr¾ování stavu je vysvìtlováno jako &quot;nemluvit dokud nejsem
osloven&quot;.  Jinak øeèeno, jakmile je spojení vytvoøeno, pakety u¾
nemusí projít souborem pravidel. To je velice mocná vlastnost, která
umo¾òuje psaní mnohem jednodu¹¹ích a bezpeènìj¹ích pravidel.

<p>
Napøíklad se podívejme, jak mù¾eme uplatnit tuto vlastnost pøi psaní
na¹í ukázkové sestavy pravidel. Pro pøipomenutí, dovolujeme
administraèní pøístup z na¹í adresy tøídy C na port 22(ssh) a dovolujeme
v¹echna pøíchozí spojení na port 80 (http) a 443 (https). Blokujeme
v¹echna ostatní spojení. Co ale dìlat v pøípadì, ¾e se chceme spojit
pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssh&amp;sektion=1">ssh(1)</a>
z web serveru, nebo chceme pou¾ít 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lynx&amp;sektion=1">lynx(1)</a> 
abychom se podívali na nìco ve FAQ? To udìlat nemù¾eme, proto¾e jsme
zablokovali v¹echna pøíchozí spojení, které smìøují na jiné ne¾ námi
povolené porty. Aèkoliv nastavení ip filtru je tak bezpeèné jak to jen
jde, mù¾e být ponìkud nevyhovující. Pøidáním slova <em>keep state</em>
do pravidla &quot;pass out&quot; mù¾eme automaticky povolit pakety,
které pøicházejí jako odezva na na¹e pokusy o spojení, jako je napø.
surfování na webu.  Pamatujte si, ¾e potøebujeme specifikovat protokol,
pro který udr¾ujeme stav.

<blockquote><pre>
block in  on fxp0 inet proto tcp all
pass  in  on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22 keep state
pass  in  on fxp0 inet proto tcp from any to any port 80 keep state
pass  in  on fxp0 inet proto tcp from any to any port 443 keep state
pass  out on fxp0 inet proto tcp all keep state
</pre></blockquote>

<p>
Tato malá zmìna dramaticky zvy¹uje flexibilitu a bezpeènost na¹í sady
pravidel.  Napøíklad, v pøecházejícím pøíkladì umo¾òujeme tcp spojení na
port 80 a 443.  Mù¾eme to ale je¹tì zlep¹it. K tomu, aby se vytvoøilo
tcp spojení, potøebujeme aby probìhl jen poèáteèní handshake. Jakmile k
nìmu dojde, mù¾eme blokovat spojení na tento port a pomocí na¹eho
&quot;keep state&quot; pravidlo bude udr¾ovat vytvoøené spojení. Abychom
dovolili poèáteèní handshake, potøebujeme dovolit pakety pouze s
nastaveným flagem SYN a nenastaveným ACK. Propu¹tìním paketù pouze s
pøíznaky SYN se ubráníme mnoha formám port skenù jako je napøíklad FIN
skenování. flags S/SA znamená: z flagù S (SYN) a A (ACK) mù¾e být
nastaven jenom SYN. Ostatní flagy nejsou zkoumány.
Pravidla nyní vypadají takto:

<blockquote><pre>
block in  on fxp0 inet proto tcp all
pass  in  on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22 \
	flags S/SA keep state
pass  in  on fxp0 inet proto tcp from any to any port 80 \
	flags S/SA keep state
pass  in  on fxp0 inet proto tcp from any to any port 443 \
	flags S/SA keep state
block out on fxp0 inet proto tcp all
pass  out on fxp0 inet proto tcp all flags S/SA keep state
</pre></blockquote>

<p>
Nyní dejme dohromady v¹echny pravidla, která jsme mìli dosud v na¹í
sadì.  Tato sada bude podporovat IPv4, mít default deny politiku,
povolující pouze administrativní spojení z interní sítì (pøes ssh) a
umo¾òující pøíchozí spojení na porty 80 (http) a 443 (https). Ochrání
nás rovnì¾ pøed spoofovanými neroutovatelnými ip adresami a zaká¾e
v¹echny pakety, které jsou pøíli¹ fragmentované nato, aby se daly
vy¹etøit. Docela dobré nastavení pro veøejný webserver. Zde je ukázka
souboru <i>/etc/pf.conf</i>:

<blockquote><pre>
# Clean up fragmented and abnormal packets
scrub in all

# don't allow anyone to spoof non-routeable addresses
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }

# by default, block all incoming packets, except those explicitly
# allowed by further rules
block in on fxp0 all

# allow others to use http and https
pass in on fxp0 inet proto tcp from any to any port 80 \
	flags S/SA keep state
pass in on fxp0 inet proto tcp from any to any port 443 \
	flags S/SA keep state

# and let out-going traffic out and maintain state on established connections
# pass out all protocols, including TCP, UDP and ICMP, and create state,
# so that external DNS servers can reply to our own DNS requests (UDP).
block out on fxp0                 all
pass  out on fxp0 inet proto tcp  all flags S/SA keep state
pass  out on fxp0 inet proto udp  all            keep state
pass  out on fxp0 inet proto icmp all            keep state

</pre></blockquote>

<p>
I kdy¾ toto mù¾e vypadat dobøe, existuje je¹tì pár dal¹ích vìcí, kterými
vám Packet Filter pomáhá, aby soubor <i>pf.conf</i> byl èist¹í a dal se
lépe udr¾ovat.

<p>
<b>Mno¾iny</b>
<p>
Mno¾iny jsou u¾iteèné "zkratky" pro psaní jednoduchých
a jasných pravidel v PF. Co kdy¾, napøíklad, potøebujeme
povolit spojení na slu¾by bì¾ících pøes více protokolù,
jako tøeba BIND, který pou¾ívá TCP a UDP?

<blockquote><pre>
pass in quick on fxp0 inet proto { tcp, udp } from any to any port 53
</pre></blockquote>

<p>
V¹imnìte si mezer z obou stran znakù '{ }'.

<p>
Skupiny souvisejících IP mohou být spojeny dohromady do mno¾in,
které mohou být kdekoliv pou¾ity místo jednoho IP.
Vezmeme-li ku pøíkladu na¹e anti-spoofing pravidla uvedená vý¹e:

<blockquote><pre>
# don't allow anyone to spoof non-routeable addresses
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }
</pre></blockquote>

<p>
<b>Expanze promìnných</b>
<p>
Jeden problém se vý¹e uvedeným vzorovým souborem <i>pf.conf</i> je,
¾e pokud potøebujete vymìnit vá¹ NIC nebo zmìnit IP adresu,
musíte zmìnit velký poèet øádek. Ten mù¾eme sní¾it pou¾itím
expanze promìných:

<blockquote><pre>
NoRouteIPs="{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
ExtIF="fxp0"
block in quick on $ExtIF from $NoRouteIPs to any
block out quick on $ExtIF from any to $NoRouteIPs
</pre></blockquote>

<p>
<a name="sample_pf.conf"></a>
<b>Dáváme to v¹e dohromady</b>
<p>
A teï to v¹echno dejme dohromady a podívejme se na eleganci výsledného
souboru:

<blockquote><pre>
# Define useful variables
ExtIF="fxp0"              # External Interface
IntNet="1.1.1.0/24"       # Our internal network
NoRouteIPs="{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
Services="{ www, https }"

# Clean up fragmented and abnormal packets
scrub in all

# don't allow anyone to spoof non-routeable addresses
block in  quick on $ExtIF from $NoRouteIPs to any
block out quick on $ExtIF from any to $NoRouteIPs

# by default, block all incoming packets, except those explicitly
# allowed by further rules
block in on $ExtIF all

# allow others to use http and https
pass  in on $ExtIF inet proto tcp from any to any port $Services \
	flags S/SA keep state

# and let out-going traffic out and maintain state on established connections
# pass out all protocols, including TCP, UDP and ICMP, and create state,
# so that external DNS servers can reply to our own DNS requests (UDP).
block out on $ExtIF                 all
pass  out on $ExtIF inet proto tcp  all flags S/SA keep state
pass  out on $ExtIF inet proto udp  all            keep state
pass  out on $ExtIF inet proto icmp all            keep state
</pre></blockquote>

<p>
Pokud se vyskytnou nìjaké problémy, mo¾ná budete chtít zprovoznit
logování u jednotlivých pravidel, abyste vìdìli, co se dìje, napø:

<blockquote><pre>
pass in log quick on fxp0 proto tcp from 1.1.1.0/24 to any port 22
</pre></blockquote>

<p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.2">pflogd(8)</a>
zapí¹e záznam ip logu do <i>/var/log/pflog</i>.
Vzpomeòte si, ¾e <i>/var/log/pflog</i> je binární soubor urèený ke ètení pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.2">tcpdump(8)</a>,
NE pøímo èlovìkem.

<p>
Pokud zmìníte konfiguraèní soubor, nezapomeòte pou¾ít
<b>pfctl -R /etc/pf.conf</b>, aby se zmìny uplatnily! 

<p>
<a name="6.3"></a>
<a name="NAT"></a>
<h2>6.3 - NAT</h2>

<p>
<h4>Poznámka: V OpenBSD 3.2 jsou funkce NATu zahrnuty v souboru 
<i>/etc/pf.conf</i>, nikoliv v samostatném souboru <i>/etc/nat.conf</i>
pou¾ívaném v OpenBSD 3.0 a 3.1</h4>

<a name="nat1.0"></a>
<h3><u>6.3.1 NAT Introduction</u></h3>

<a name="nat1.1"></a>

<p>
Na základì
<a href="http://www.geektools.com/rfc/rfc1631.txt">RFC 1631</a>,
NAT poskytuje jednoduchý zpùsob jak namapovat interní sí» na jedinou
routovatelnou ("reálnou") internetovou adresu. Toto je velmi u¾iteèné,
pokud je¹tì napøíklad nemáte oficiálnì pøiøazené adresy pro ka¾dý stroj
na va¹í interní síti. Pøi nastavování soukromé/interní sítì, mù¾ete
s výhodou pou¾ít rezervovaných adresových blokù (pøiøazených v
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>),
jako jsou:

<p>
10.0.0.0/8 (10.0.0.0 - 10.255.255.255)<br>
172.16.0.0/12 (172.16.0.0 - 172.31.255.255)<br>
192.168.0.0/16 (192.168.0.0 - 192.168.255.255)

<p>
Pøedpokládá se, ¾e u¾ivatel u¾ nastavil a nakonfiguroval OpenBSD se
dvìma sí»ovými kartami (jedna pøipojena k Internetu a druhá k lokální
síti).

<p>
<a name="nat1.3"></a>
<b>Nastavení</b>

<p>
Jako pøíklad pou¾ijeme ní¾e popsaný systém. Va¹e uspoøádání
se témìø urèitì bude li¹it, tak¾e buïte velmi opatrní,
pokud odsud cokoliv doslova pøepí¹ete a oèekáváte, ¾e
to bude fungovat tak, jak jste chtìli.

<blockquote>
<b>Sí»ové karty:</b>
<pre>
Intel EtherExpress Pro/100 <b>fxp0</b>
Connected to the EXTERNAL LAN (or WAN)
<b>IP Address: </b>24.5.0.5
<b>Netmask: </b>255.255.255.0

Compaq Netelligent 10/100Mb <b>tl0</b>
Connected to the INTERNAL LAN
<b>IP Address: </b>192.168.1.1
<b>Netmask: </b>255.255.255.0
</pre>
</blockquote>

<blockquote>
<b>Externí, internetová routa (dodal ji ISP, v tomto pøípadì se jedná o
linku modemovou)<br></b>
<pre>
<b>IP Address: </b>24.5.0.5
<b>Netmask: </b>255.255.255.0
<b>Gateway: </b>24.5.0.1
</pre>
</blockquote>

<blockquote>
<b>Lokální sí»</b>
<ul>
V na¹em vzorovém prostøedí pou¾ívají poèítaèe na LAN adresové schéma
192.168.1.xxx (kde xxx je jedineèné èíslo). Na LAN je mnoho rùzných OS,
vèetnì Windows 98, Windows NT, OpenBSD a Linux, ale OS klienta nehraje
pøi NAT roli.  V tomto dokumentu a v jeho pøíkladech bude klient na LAN
pou¾ívat IP adresu 192.168.1.40.
</blockquote>

<blockquote>
<b>Diagram nastavení</b>
<pre>
+-----+              +---------+          +----------+
| Hub |--------- tl0 |   NAT   | fxp0 ----| Internet |
+-----+              +---------+          +----------+
| |
| +-- Klient A
+---- Dal¹í klienti 

		      +--------------------------+
		      |          LEGEND          |
		      +--------------------------+
		      |  NIC fxp0 - 24.5.0.5     |
		      |  NIC tl0  - 192.168.1.1  |
		      | Klient A  - 192.168.1.35 |
		      +--------------------------+

</pre>
</blockquote>

<p>
<a name="nat2.0"></a>
<h3><u>6.3.2 Network Address Translation</u></h3>
<br>

<p>
<a name="nat2.1"></a>
<b>Seznámení s NATem</b>

<p>
Ka¾dý uzel Internetu potøebuje unikátní IP adresu. Pøinejmen¹ím
u IPv4 je mno¾ství dostupných IP adres velmi omezené a proto
nejsou zdarma. Hodnì "levných" ISP poskytuje nìco mezi 1 a 30
adresami, a i kdy¾ si organizace s vìt¹ím rozpoètem mohou
dovolit vìt¹í blok, ve vìt¹inì pøípadù z toho, ¾e ka¾dý poèítaè je
na Internetu individuálnì adresovatelný,  plyne málo
výhod a znaèná rizika.

<p>
Network Address Translation (pøeklad adres), nebo NAT, (také známý jako 
&quot;IP Masquerading&quot;,
pokud pocházíte z linuxového prostøedí) umo¾òuje, aby více poèítaèù
bylo umístìno &quot;za&quot; jednou IP adresou (nebo malým mno¾stvím adres).
Ka¾dý &quot;interní&quot; poèítaè má lokálnì pøidìlenou, neregistrovanou
IP adresu (podle <a href="http://www.geektools.com/rfc/rfc1918.txt">RFC
1918</a>), a v¹echny souèasnì vyu¾ívají stejnou externí IP adresu.

<p>
Zpùsob, jakým NAT pracuje je pøekvapivì jednoduchý. Kdy¾ se klient na
LAN chce spojit se strojem v Internetu, po¹le ven TCP paket se ¾ádostí o
spojení. Uvnitø TCP hlavièky paketu je klientova IP adresa (napø.
192.168.1.40) a po¾adovaná IP adresa cílového poèítaèe (napø.
123.45.67.89). Stroj, na kterém bì¾í NAT obdr¾í tento TCP paket a zmìní
klientovu IP adresu v hlavièce z 192.168.1.40 na IP adresu pøipojenou na
Internet (napø.  24.5.0.5). Tímto zpùsobem efektivnì docílíme toho, ¾e
cílový poèítaè se domnívá, ¾e vlastní spojení pøichází ze stroje, na
kterém bì¾í NAT. Cílový poèítaè (host) posílá dále pakety týkající se
daného spojení na adresu stroje s NATem. Kdy¾ stroj s NATem obdr¾í paket
od host-a, pøelo¾í rychle cílovou IP adresu na adresu klienta a po¹le
paket klientovi. Klient nemá ani tu¹ení o tom, co se stalo a Internetové
spojení je pro nìj zcela transparentní.

<p>
Následující pøíklad ozøejmí dosud nepochopené:

<blockquote><pre>
Klient ----------------- tl0 [ NAT ] fxp0 ---------- Internet Host
192.168.1.35 --- 192.168.1.1 [ NAT ] 24.5.0.5 --- 123.45.67.89

Odcházející TCP Packet                  Odcházející TCP Packet
From: 192.168.1.35  &gt;&gt;=== NAT ===&gt;&gt;     From: 24.5.0.5
To: 123.45.67.89                        To: 123.45.67.89

Pøíchozí TCP Packet                     Pøíchozí TCP Packet
From: 123.45.67.89 			From: 123.45.67.89
To:   192.168.1.40  &lt;&lt;=== NAT ===&lt;&lt;     To: 24.5.0.5
</pre></blockquote>

<p>
<a name="nat2.2"></a>
<b>Proè pou¾ívat NAT?</b>

<p>
Kdy¾ jsem se nastìhoval do nového bytu, byl jsem postaven pøed men¹í
problém.  Jak dát pøipojení k Internetu mým spolubydlícím, kdy¾ modemový
kabel je pouze v mé místnosti? Bylo tu nìkolik mo¾ností, které jsem mohl
implementovat, poèínají tím, ¾e ka¾dý z nás obdr¾í vlastní IP adresu,
pøes nastavení proxy serveru a¾ po nastavení NATu. (Nenechejte se mýlit
pøíkladem s modemovým kabelem. NAT je dostateènì silný aby zamaskoval
velikou LAN se stovkami ba i tisíci poèítaèù!)

<p>
Je tu mnoho dùvodù, proè jsem chtìl nastavit NAT. Dùvodem èíslo jedna
bylo u¹etøit peníze. V mém domì jsou dva spolubydlící (ka¾dý s vlastním
PC) a já sám se tøemi poèítaèi, tak¾e potøebujeme pøipojit pìt poèítaèù.
Mùj ISP ale povoluje pouze tøi IP adresy v ka¾dé domácnosti.  To
znamená, ¾e zde není dostatek IP adres , aby ka¾dému poèítaèi mohl být
umo¾nìn internetový pøístup.

<p>
Pøi pou¾ití NATu bude mít ka¾dý stroj unikátní (interní) IP adresu, ale
budou sdílet jednu IP adresu pro pøístup na Internet. Náklady jdou dolù.

<p>
<a name="nat2.4"></a>
<b>Setup</b>

<p>
Nejprve budete muset na va¹em OpenBSD systému zapnout PF. Toho
jednodu¹e docílíte editací souborù uvedených dále (zmìny udìlejte tak,
aby odpovídající øádky vypadaly jako ty následující):

<p>
<b>/etc/rc.conf</b> (z tohoto souboru se startují programy pøi bootování)

<blockquote><pre>
pf=YES<br>
</pre></blockquote>

<p>
<b>/etc/sysctl.conf</b>

<blockquote><pre>
net.inet.ip.forwarding=1
</pre></blockquote>

<p>
Po tìchto zmìnách je stroj pøipraven pro konfiguraci NATu.

<p>
<a name="nat2.5"></a>
<b>Konfigurace</b>

<p>
Prvním krokem je nastavit soubor s pravidly pro PF
(<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+3.2">/etc/pf.conf</a></i>).
Pro úèely tohoto dokumentu dovolíme spojení pøes tento firewall bez
omezení.  Soubor by mìl vypadat asi takto:

<blockquote><pre>
pass in all
pass out all
</pre></blockquote>

<p>
Pro dal¹í informace si pøeètìte <a href="#PF">FAQ 6, Packet Filter</a>

<p>
Èást s nastavení NATu v souboru
(<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+3.2">/etc/pf.conf</a></i>).
má velmi jednoduchý syntax.
Pro pøípad nastaveného firewallu (viz. vý¹e) bude vypadat takto:

<blockquote><pre>
nat on fxp0 from 192.168.1.0/24 to any -&gt; 24.5.0.5
</pre></blockquote>

<p>
Zde je vysvìtlení pøedcházejícího øádku.

<dl>
<dt>"nat"
<dd> Tímto øíkáte, ¾e pøíkaz, který zadáváte, je pravidlo NATu.
</dl>

<dl>
<dt>"fxp0"
<dd>Název sí»ového rozhraní pøipojeného na Internet.
</dl>

<dl>
<dt>"192.168.1.0/24"
<dd>IP adresa a sí»ová maska (maska je v CIDR formátu). Dohromady to
 znamená "jakákoliv IP adresa o hodnotì od 192.168.1.1 do 192.168.1.254"
 má být mapována. 
</dl>

<dl>
<dt>"24.5.0.5"
<dd>
Externí IP adresa, na kterou budou mapovány interní IP adresy.
</dl>

<p>
<a name="nat2.6"></a>
<b>Running</b>

<p>
Jakmile je jednou konfigurace kompletní, jsou zde dva zpùsoby jak
spustit NAT. První (a nejlep¹í, pokud je to mo¾né) je rebootovat
OpenBSD stroj. To se provede pøíkazem "<i>reboot</i>".

<p>
Spu¹tìní NATu z pøíkazové øádky docílíte pøíkazy:

<blockquote><pre>
# <b>pfctl -f /etc/pf.conf</b>
# <b>pfctl -e</b>
</pre></blockquote>

<p>
První øádek nahraje soubor pravidel NATu do PF (a zahodí stará pravidla),
druhý zapíná PF. Reboot je opìt nejlep¹í cestou, jak se ujistit,
¾e se po rebootu spustí v¹e tak, jak jste pøedpokládali.

<p>
<b>Poznámka:</b> budete-li potøebovat updatovat nastavení NATu (v
pøípadì, ¾e editujete soubor, ale nechcete rebootovat) staèí pøedchozí
pøíkaz spustit znovu. Nastavení bude obnoveno s provedenými zmìnami.

<p>
<a name="nat3.0"></a>
<h3><u>6.3.3 Nat Knowledge Base</u></h3>

<p>
<a name="nat3.1"></a>
<b>Testování NATu</b>

<p>
Chcete-li zjistit, jak NAT právì pracuje, nebo se ujistit o tom, zda
nastavení jsou funkèní, pou¾ijte volbu "-ss". Tato volba vypí¹e seznam
v¹ech souèasných spojení, které NAT zpracovává:

<blockquote><pre>
# pfctl -ss
TCP  192.168.1.35:2132 -&gt; 24.5.0.5:53136 -&gt; 65.42.33.245:22       TIME_WAIT:TIME_WAIT
TCP  192.168.1.35:2492 -&gt; 24.5.0.5:55011 -&gt; 65.42.33.245:22       ESTABLISHED:ESTABLISHED
UDP  192.168.1.35:2491 -&gt; 24.5.0.5:60527 -&gt; 24.2.68.33:53       2:1
</pre></blockquote>

<p>
Vysvìtlení (prvního øádku, ostatní jsou podobné):

<dl>
<dt>"192.168.1.35:2132"
<dd> To vám øíká IP adresu poèítaèe ve vnitøní síti, který pou¾ívá NAT
(192.168.1.35).  Za ní následuje port, pou¾itý k vytvoøení spojení
(2132).
</dl>

<dl>
<dt>"24.5.0.5:53136"
<dd>To znaèí, ¾e spojení jde do internetu pøes IP adresu 24.5.0.5
a port 53136.
</dl>

<dl>
<dt>"65.42.33.245:22"
<dd>IP adresa a port, na který spojení vede.
</dl>

<dl>
<dt>"TIME_WAIT:TIME_WAIT"
<dd>To ukazuje stav TCP, ve kterém si PF myslí, ¾e spojení je.
</dl>

<p>
<a name="nat3.2"></a>
<b> Omezení NATu pøi FTP</b>

<p>
Existuje nìkolik omezení, která NAT pøiná¹í, z nich¾ nejèastìj¹í
je pøi FTP. FTP mù¾ete pou¾ívat dvìma zpùsoby: pasivním a aktivním.
Pasivní FTP je obecnì pova¾ováno za bezpeènìj¹í.

<p>
Kdy¾ se pøi aktivním FTP u¾ivatel pøipojí na vzdálený FTP server a
¾ádá informace nebo soubor, FTP klient po¹le serveru náhodné èíslo
portu, na který se FTP server pøipojí a pøenese data. To zpùsobuje
problém pro u¾ivatele, kteøí se sna¾í získat pøístup na FTP server
z vnitøní sítì. Kdy¾ FTP server posílá data, posílá je na náhodný
port na externí sí»ovou kartu. Ma¹ina, která provádí NAT, je pøijme,
ale proto¾e nemá ¾ádné mapování pro neznámý paket a ¾ádné mapování
pro tento port, zahodí paket a nedoruèí ho.

<p>
Pøi pasivní módu FTP (co¾ je default pro OpenBSD
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1">ftp(1)</a>
klienta), klient po¾ádá server, aby vybral náhodný port, na kterém
bude èekat na datové spojení. Server informuje klienta o tom, jaký
port vybral, a klient se na tento port pøipojí, aby pøenesl data.
Bohu¾el to není v¾dy mo¾né nebo ¾ádoucí. ftp(1) standardnì pou¾ívá
tento mód; pou¾ít aktivní FTP mód ho donutíte pou¾itím volby -A nebo
vypnutím pasivního módu zadáním pøíkazu

<blockquote><pre>
passive off
</pre></blockquote>

<p>
na pøíkazovém øádku ftp&gt;.

<p>
Packet Filter poskytuje je¹tì dal¹í øe¹ení, pøesmìrováním FTP spojení
pøes FTP proxy server, co¾ je proces, který funguje jako "prùvodce"
FTP spojení skrz filtry. FTP proxy pou¾ívaná OpenBSD a PF je
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.2">ftp-proxy(8)</a>.
Aktivujete ji pøidání nìèeho takového do va¹e souboru <i>/etc/pf.conf</i>:

<blockquote><pre>
rdr on tl0 from any to any port 21 -&gt; 127.0.0.1 port 8021
</pre></blockquote>

<p>
Krátké vysvìtlení  této øádky je: "Provoz na interním rozhraní je
pøesmìrován na proxy server bì¾ící na tomto stroji, která poslouchá na
portu 8021".

<p>
Doufejme, ¾e je jasné, ¾e proxy server musí být spu¹tìn a bì¾í na tomto
OpenBSD stroji. To udìláme pøidáním následujícího øádku do
<i>/etc/inetd.conf</i>:

<blockquote><pre>
127.0.0.1:8021 stream tcp nowait root /usr/libexec/ftp-proxy ftp-proxy
</pre></blockquote>

<p>
a buï restartováním systému nebo poslání signálu 'HUP'
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8">inetd(8)</a>.
Jedním ze zpùsobù, jak poslat signál 'HUP' je pøíkaz:

<blockquote><pre>
kill -HUP `cat /var/run/inetd.pid`
</pre></blockquote>

<p>
V¹imnìte si, ¾e ftp-proxy poslouchá na portu 8021, stejném jako port, na
který vý¹e uvedený pøíkaz rdr posílá FTP spojení. Výbìr portu 8021 je
náhodný, i kdy¾ 8021 je dobrá volba, proto¾e není definován pro ¾ádnou
jinou aplikaci.

<p>
<a name="nat3.3"></a>
<b>Pøesmìrování provozu</b>

<p>
Stane se, ¾e potøebujete pøesmìrovat pøíchozí nebo odchozí spojení pro
urèitý protokol nebo port na nìjaký stroj za filtrovacím systémem.
Pøíkladem tohoto je mù¾e být poèítaè ve vnitøní síti, na kterém bì¾í web
server pøístupný ze svìta, (nebo samozøejmì na¹e známá ftp-proxy(8)).
Pøíchozí spojení na platnou Internetovou IP adresu v¹ak budou bez odezvy,
proto¾e na stroji s NATem nebì¾í web server. Pro tento úèel pou¾íváme
direktivu NATu 'rdr' v souboru s pravidly, která dává instrukce pro
pøesmìrování urèitého spojení.

<p>
V na¹em pøípadì pøedpokládejme, ¾e web server se nachází na LAN s IP
adresou 192.168.1.80. Soubor s pravidly pro NAT potøebuje novou
direktivu, která se o toto postará. Pøidejte øádku podobnou této do
<i>/etc/pf.conf</i>:

<blockquote><pre>
rdr on fxp0 proto tcp from any to any port 80 -&gt; 192.168.1.80 port 80
</pre></blockquote>

<p>
Vysvìtlení ka¾dé èásti této øádky:

<dl>
<dt>"rdr"
<dd>Pøíkaz, který dáváte NATu. Øíká NATu, ¾e tato polo¾ka je pøíkaz
k pøesmìrování spojení.
</dl>

<dl>
<dt>"on fxp0"
<dd>Externí sí»ové rozhraní pøipojené k Internetu.
</dl>

<dl>
<dt>"from any to any"
<dd>Toto øíká, kterou adresu pøesmìrovat (pøicházející odkudkoliv
na fxp0, jak bylo naznaèeno vý¹e, na jakémkoliv cílové IP)
</dl>

<dl>
<dt>"port 80"
<dd>Pøíchozí port (80), který má být pøesmìrován. Nemusíte pou¾ít èíslo
"80", mù¾ete také pou¾ít "port www" pro pøesmìrování portu 80. Pokud
chcete pou¾ít jméno namísto èísla, musí odpovídající název a èíslo
existovat v souboru <i>/etc/services</i>.
</dl>

<dl>
<dt>"192.168.1.80 port 80"
<dd>IP adresa stroje v LAN, na který se budou pøesmìrovávat pakety.
V¹imnìte si, ¾e cílový port NEMUSÍ odpovídat pøíchozímu portu.  Tak¾e
tøeba následující pøíklad je platný a dokonce potenciálnì u¾iteèný:
<pre>
rdr on fxp0 proto tcp from any to any port 8080 -&gt; 192.168.1.35 port 80
</pre>
Tento øádek by smìroval pøíchozí spojení na port 8080 na webserver
bì¾ící na stroji ve vnitøní síti na "standardním" portu 80.
</dl>

<p>
Po pøidání pravidla znovu nahrajte pravidla NATu a pøesmìrování zaène
okam¾itì fungovat.

<p>
<b>Negace</b>
<p>
Nìkdy potøebujete udìlat výjimku z pravidla NATu nebo pøesmìrování.
Tady je pøíklad. AOL Instant Messenger známý tím, ¾e se proplí¾í skrz
firewally ka¾dým dostupným portem. Mo¾ná zjistíte, ¾e ftp-proxy
interferuje s AIMem, kdy¾ se rozhodne projít ven na port 21. Pokud vám
to vadí (hodnì lidí tráví nezanedbatelnì èasu pokusy o zablokování
AIMu!), mù¾ete se rozhodnout vyøadit IP adresy AIM serverù ze spojení
pøesmìrovávaných na¹ím pravidlem pro ftp-proxy. Udìláte to
následujícím øádkem:

<blockquote><pre>
rdr on tl0 proto tcp from any to ! 64.12.163.199 port 21 -&gt; 127.0.0.1 port 8021
</pre></blockquote>

<p>
Interpretace: Pøesmìruj spojení pøicházející na na tl0 smìøující na port
21, ale NE na 64.12.163.199 (u¾ivatelé serverù AIMu s tím mìli potí¾e)
na localhost, port 8021 (kde, doufejme, èeká ftp-proxy).  No a teï byste
si mìli uvìdomit, ¾e AIM serverù je hodnì, tak¾e si patrnì budete muset
pohrát s tìmito IP adresami (64.12.0.0/16 by mohlo být produktivnìj¹í, i
kdy¾ pravdìpodobnì zasáhne i nìkteré non-AOL servery).

<p>
<a name="nat3.4"></a>
<b>NAT versus Proxy</b>
<p>
Rozdíl mezi NATem a aplikaènì zalo¾enou proxy je ten, ¾e proxy software
jedná jako prostøedník mezi Internetem a strojem pøipojeným na LAN. To
je v poøádku, pøesto ka¾dá aplikace, kterou chcete spustit MUSÍ být
schopna pou¾ít proxy server. Ne v¹echny aplikace to doká¾í (obzvlá¹»
hry). Navíc neexistují proxy server aplikace pro v¹echny Internetové
slu¾by. NAT prùhlednì mapuje va¹i interní sí», aby mohla být spojena s
Internetem. Jediná výhoda, proè pou¾ívat proxy software narozdíl od NATu
je, ¾e proxy software by mìl být bezpeèný a mù¾e provádìt filtrování na
základì obsahu paketù, uchrání tak vá¹ stroj s Windows od macro viru,
mù¾e ochránit od buffer overflowu software klienta a více.  Pou¾ívání
tìchto filtrù je vìt¹inou nároèný úkol.

<p>
<a name="nat3.5"></a>
<b>Pøesmìrování a odrá¾ení</b>

<p>
Èasto jsou pøesmìrovávací pravidla pou¾ívána k pøesmìrování spojení
pøicházejících z Internetu na lokální server s privátní adresou v LAN,
jako tøeba:

<pre>
rdr on $ext_if proto tcp from any to $ext_if port 80 -&gt; $server port 80
</pre>

<p>
Ale kdy¾ jsou pravidla pro pøesmìrování testována z klientské stanice v
LAN, uká¾e se, ¾e to nefunguje.
Problém je v tom, ¾e pøesmìrovávací pravidla se uplatní pouze na pakety,
které procházejí specifikovaným rozhraním ($ext_if, externí rozhraní, v
na¹em pøíkladu).
Pøipojování se k vnìj¹ímu rozhraní firewallu ze stanice v LAN nicménì
neznamená, ¾e pakety budou procházet vnìj¹ím rozhraním.
TCP/IP stack na firewallu porovnává cílovou adresu pøíchozích paketù s
vlastními adresami a aliasy a rozpozná spojení na nìj samý u¾ v
okam¾iku, kdy procházejí vnitøním rozhraním. Takové pakety fyzicky
neprojdou vnìj¹ím rozhraním a stack takový prùchod ¾ádným zpùsobem
nesimuluje. pf tyto pakety nikdy nevidí na vnìj¹ím rozhraní a
pravidla pro pøesmìrování na vnìj¹ím rozhraní se neuplatní.

<p>
Pøidání druhého pøesmìrovávacího pravidla na vnitøním rozhraní nemá
oèekávaný úèinek.
Kdy¾ se lokální klient pøipojuje na externí adresu firewallu, úvodní
paket TCP handshake se dostane na firewall vnitøním rozhraním.
Pravidlo pøesmìrování se uplatní a cílová adresa je nahrazena adresou
vnitøního serveru. Paket je pøesmìrován zpátky skrz vnitøní rozhraní a
dostane se k vnitønímu serveru.
Ale zdrojová adresa nebyla pøelo¾ena a stále obsahuje adresu lokálního
klienta. Firewall nikdy neobdr¾í odpovìï a nemá ¹anci správnì zmìnit
pøeklad. Klient obdr¾í odpovìï ze zdroje, který neèekal, a zahodí ji.
TCP handshake sel¾e a ¾ádné spojení nemù¾e být vytvoøeno.

<p>
Nicménì pøesto je èasto zapotøebí, aby se klienti na LAN mohli
transparentnì pøipojit na vnitøní server stejným zpùsobem jako vnìj¹í.
Existuje nìkolik øe¹ení tohoto problému:

<p>
<b>Rozdìlené DNS</b>
<p>
Je mo¾né nastavit DNS servery, aby odpovídaly na dotazy vnitøních
klientù jinak ne¾ na externí dotazy, tak¾e lokální klienti obdr¾í adresu
vnitøního serveru bìhem pøekladu jména.
Potom se budou pøipojovat pøímo ani¾ by se na tom podílel firewall.
Tím se sni¾uje lokální provoz, proto¾e pakety nemusejí být posílány pøes
firewall.

<p>
<b>Pøesunutí serveru do oddìlené vnitøní sítì</b>
<p>
Pøidání dal¹ího sí»ového rozhraní na firewall a pøesunutí lokálního
serveru z vnitøní sítì do dedikované sítì (DMZ) umo¾òuje pøesmìrovaní z
lokálních klientù stejným zpùsobem jako pøesmìrování externích spojení.
Pou¾ití oddìlené sítì má nìkolik výhod, vèetnì zvý¹ení bezpeènosti díky
izolování serveru od ostatních lokálních stanic.
Pokud by server (který je v na¹em pøípadì dostupný z internetu) byl
kompromitován, nemá pøímý pøístup k ostatním lokálním strojùm, proto¾e
v¹echna spojení musí projít firewallem.

<p>
<b>Pou¾ití TCP proxy</b>
<p>
Mù¾eme na firewallu nastavit obecnou TCP proxy, buï naslouchající na
pøesmìrovávaném portu nebo pøesmìrování spojení z vnitøního rozhraní na
port, na kterém naslouchá.
Kdy¾ se lokální klient pøipojí na firewall, proxy akceptuje spojení,
vytvoøí nové spojení na vnitøní server a pøeposílá data mezi tìmito
dvìma spojeními.

<p>
Jednoduché proxy mù¾eme vytvoøit pou¾itím
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8">inetd(8)</a>
a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1">nc(1)</a>.
Následující øádek v <i>/etc/inetd.conf</i> vytvoøí naslouchající soket
na loopback adrese a portu 5000.
Spojení jsou pøesmìrována na port 80 na serveru 192.168.1.10.

<pre>
127.0.0.1:5000 stream tcp wait nobody /usr/bin/nc nc -w 20 192.168.1.10 80
</pre>

<p>
Následující pravidlo pøesmìruje port 80 na vnitøním rozhraní na proxy:

<pre>
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; 127.0.0.1 port 5000
</pre>

<p>
<b>Kombinace RDR a NAT</b>
<p>
Pøidáním dal¹ího NAT pravidla mù¾eme dosáhnout chybìjícího pøekladu
zdrojové adresy popsáného vý¹e.

<pre>
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; $server
no nat on $int_if proto tcp from $int_if to $int_net
nat on $int_if proto tcp from $int_net to $server port 80 -&gt; $int_if
</pre>

<p>
To zpùsobí, ¾e úvodní pakety od klienta budou pøelo¾eny znovu, kdy¾ jsou
pøeposílány zpátky vnitøním rozhraním, pøièem¾ je zdrojová adresa
klienta nahrazena vnitøní adresou firewallu.
Vnitøní server odpoví zpátky firewallu, který mù¾e vrátit oba NAT i RDR
pøeklady, kdy¾ pøeposílá odpovìï lokálnímu klientovi.
Je zapotøebí dát si pozor, aby se NAT pravidlo neuplatnilo i na dal¹í
provoz, napøíklad spojení pøicházející od externích strojù (dal¹ími
pøesmìrováními) nebo ze samotného firewallu.
Uvìdomte si, ¾e vý¹e uvedené rdr pravidlo zpùsobí, ¾e TCP/IP stack 
obdr¾í pakety pøicházející z vnitøního rozhraní s cílovou adresou 
ve vnitøní síti. Abyste stacku zabránili ve vyslání zprávy ICMP 
redirect (øíkájící klientovi, ¾e jeho cíl je dosa¾itelný pøímo,
co¾ by naru¹ilo odrá¾ení), vypnìte na firewallu redirecty, pomocí

<pre>
# <strong>sysctl -w net.inet.ip.redirect=0</strong>
</pre>

Obecnì byste mìli pou¾ít spí¹e pøedchozí uvedená øe¹ení.

<p>
<a name="nat4.0"></a>
<b>6.3.4 Links and Cross-References</b>

<p>
OpenBSD soubory:
<ul>
<li>/etc/pf.conf - pravidla pro PF/NAT
<li>/etc/rc.conf - nutné upravit pro spu¹tìní NATu a PF pøi bootu
<li>/etc/sysctl.conf - nutné editovat pro IP forwarding
</ul>

<p>
NAT Internet Links:
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+3.2">manuálová stránka pf.conf</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.2">manuálová stránka pfctl</a>
<li><a href="http://www.geektools.com/rfc/rfc1631.txt">http://www.geektools.com/rfc/rfc1631.txt</a>
</ul>

<p>
<font color= "#0000e0">
<a href="index.html">[Zpìt na hlavní stránku]</a>
<a href="faq5.html">[Do sekce 5.0 - Nastavení jádra]</a>
<a href="faq7.html">[Do sekce 7.0 - Keyboard controls]</a>
</font>

<p>
<hr>
<a href="index.html"><img height= "24" width= "24" src= "../../images/back.gif" border= "0" alt= "[zpìt]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<small>
<br>
Originally [OpenBSD: faq6pf.html,v 1.1 ]
<br>
$Translation: faq6pf.html,v 1.1 2003/10/31 15:47:38 certik Exp $
<br>
$OpenBSD: faq6pf.html,v 1.1 2003/10/31 23:12:34 horacio Exp $
</small>

</body>
</html>
