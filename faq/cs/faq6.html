<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-2">
<title>6.0 - Nastavení sítì</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998-2002 by OpenBSD.">
</head>

<body bgcolor= "#ffffff" text= "#000000">

<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
<p>
<h2><font color=#e00000>6.0 - Nastavení sítì</font><hr></h2>
</p>

<p>
<ul><h3>Obsah</h3>
<li><A href= "#Intro">6.0.1 - Pøedtím ne¾ pùjdeme dále</a>
<li><a href= "#Setup">6.1 - Úvodní nastavení sítì</a>
<li><a href= "#PF">6.2 - Packet Filter (PF)</a>
<li><a href= "#NAT">6.3 - Pøeklad sí»ových adres (NAT) </a>
<li><a href= "#DHCP">6.4 - Dynamic Host Configuration Protocol (DHCP)</a>
<li><a href= "#PPP">6.5 - Point to Point Protokol</a>
<li><A href= "#Tuning">6.6 - Zlep¹ování výkonu sítì</a>
<li><a href= "#NFS">6.7 - Pou¾ívání NFS</a>
<li><a href= "#DNS">6.8 - Domain Name Service  - DNS, BIND a named</a>
<li><a href= "#PPTP">6.9 - Nastavení PPTP spojení v OpenBSD</a>
</ul>
</p>
<hr>

<br>
<p>
<a name= "Intro"></a>
<a name="6.0.1"></a>
<h2>6.0.1 - Pøedtím ne¾ pùjdeme dále</h2>
<p>
Na úvod pøedpokládáme, ¾e ètenáø pøeèetl a alespoò èásteènì chápe sekci 
<a href="faq5.html">Konfigurace jádra</a> tìchto FAQ, stejnì jako manuálové stránky
pøíkazù 
<a href= "http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8">
ifconfig(8)</a> a 
<a href= "http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&sektion=1">
netstat(1)</a>.
<p>
Pokud jste administrátor sítì a nastavujete smìrovací protokoly, pokud 
pou¾íváte OpenBSD box jako router, pokud chcete hloubìji poznat princip 
fungovaní sítì s IP protokolem, pak byste si rozhodnì mìli pøeèíst
<a href="http://www.3com.com/solutions/en_US/ncs/501302.html">V¹e co potøebujete vìdìt o IP adresování</a>
(nebo <a href="http://www.3com.com/other/pdfs/infra/corpinfo/en_US/501302.pdf">tady</a>).
Jedná se skuteènì o vynikající dokument, který obsahuje zcela nepostradatelné
informace pro práci se sítìmi na bázi IP protokolu, obzvlá¹tì pokud pokud máte
co doèinìní nebo zodpovídáte za více ne¾ jednu sí».
<p>
Pokud pracujete s aplikacemi jako jsou web servery, ftp servery a mail servery,
mù¾ete najít mnoho cenných informací 
<a href="http://the.rfceditor.org/rfc.html">ètením RFC dokumentù</a>.
Samozøejmì, ¾e je nemù¾ete pøeèíst v¹echny. 
Radìji si vyberte téma, o které se zajímáte, nebo které pou¾íváte v práci.
RFC definují mnoho (øádovì tisíce) standardù protokolù internetu a popisují,
jak tyto protokoly jsou navr¾eny a jak pracují.

<a name="Setup"></a>
<a name="6.1"></a>
<h2>6.1 - Úvodní nastavení sítì</h2>

<p>
<a name="Setup.1"></a>
<a name="6.1.1"></a>
<h3>6.1.1 - Identifikace a nastavení va¹ich sí»ových rozhraní</h3>
</p>

<p>
Nejprve je nutné identifikovat v systému vá¹ sí»ový hardware. V OpenBSD jsou
sí»ová rozhraní pojmenovaná podle sí»ové karty, ne podle typu spojení. 
To zda byla va¹e sí»ová karta inicializovaná, mù¾ete vidìt pøi startu systému,
nebo pozdìji pomocí pøíkazu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dmesg&sektion=8">dmesg(8)</a>.
Rovnì¾ mù¾ete svoje sí»ová rozhraní identifikovat ve výpisu pøíkazu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8">ifconfig(8)</a>
Napøíklad zde je výstup z pøíkazu dmesg pro sí»ovou kartu Intel Fast Ethernet, které
odpovídá název zaøízení fxp.
</p>

<ul><pre>
fxp0 at pci0 dev 10 function 0 "Intel 82557" rev 0x0c: irq 5, address 00:02:b3:2b:10:f7
inphy0 at fxp0 phy 1: i82555 10/100 media interface, rev. 4
</pre></ul>

<p>
Pokud nevíte, jaké jméno v systému odpovídá va¹í kartì, 
podívejte se, prosím, na <a href="./plat.html">seznam podporovaného hardwaru</a>
pro Va¹i platformu. Najdete tam seznam mnoha bì¾ných sí»ových karet a jména
je OpenBSD ovladaèù. Spojte krátké alfabetické jméno zaøízení (jako fxp)
s èíslem pøiøazeným kernelem a získáte jméno rozhraní (napø. fxp0).
</p>

<p>
Chcete-li zjistit, která zaøízení byla identifikována,
mù¾ete pou¾ít pøíkaz 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8">ifconfig(8)</a>.
Následující pøíkaz uká¾e v¹echna sí»ová rozhraní v systému.
V tomto vzorovém výstupu vidíme pouze jedno fyzické rozhraní,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=fxp&sektion=4">fxp(4)</a>.
</p>

<ul><pre>
$ <strong>ifconfig -a</strong>
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 33224
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x4
        inet6 ::1 prefixlen 128
        inet 127.0.0.1 netmask 0xff000000 
lo1: flags=8008&lt;LOOPBACK,MULTICAST&gt; mtu 33224
fxp0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
        media: Ethernet autoselect (100baseTX full-duplex)
        status: active
        inet 10.0.0.38 netmask 0xffffff00 broadcast 10.0.0.255
	inet6 fe80::202:b3ff:fe2b:10f7%fxp0 prefixlen 64 scopeid 0x1
pflog0: flags=0&lt;&gt; mtu 33224
sl0: flags=c010&lt;POINTOPOINT,LINK2,MULTICAST&gt; mtu 296
sl1: flags=c010&lt;POINTOPOINT,LINK2,MULTICAST&gt; mtu 296
ppp0: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1500
ppp1: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1500
tun0: flags=10&lt;POINTOPOINT&gt; mtu 3000
tun1: flags=10&lt;POINTOPOINT&gt; mtu 3000
enc0: flags=0&lt;&gt; mtu 1536
bridge0: flags=0&lt;&gt; mtu 1500
bridge1: flags=0&lt;&gt; mtu 1500
vlan0: flags=0&lt;&gt; mtu 1500
vlan1: flags=0&lt;&gt; mtu 1500
gre0: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1450
gif0: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1280
gif1: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1280
gif2: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1280
gif3: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1280
	 
</pre></ul>

<p>
Jak je vidìt, <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8">ifconfig(8)</a>
dává více informací, ne¾ v této fázi potøebujeme. Umo¾òuje nám ale najít na¹e
zaøízení. V pøedcházejícím pøíkladì je ji¾ sí»ová karta nakonfigurována.
Poznáte to podle vypsaných hodnot &quot;inet 10.0.0.38 netmask
0xffffff00 broadcast 10.0.0.255&quot;, odpovídající nastavení parametrù a také
pomocí pøíznakù <strong>UP</strong> a <strong>RUNNING</strong>.
</p>
<p>
Zaznamenáte také nìkolk dal¹í rozhraní, která jsou standardnì zapnuta.
Ta poskytují rùzné slu¾by. Následující manuálové stránky je popisují:
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&sektion=4">lo</a> - Loopback Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&sektion=4">pflog</a> - Packet Filter Logging Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sl&sektion=4">sl</a> - SLIP Network Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&sektion=4">ppp</a> - Point to Point Protocol
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tun&sektion=4">tun</a> - Tunnel Network Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4">enc</a> - Encapsulating Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&sektion=4">bridge</a> - Ethernet Bridge Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vlan&sektion=4">vlan</a> - IEEE 802.1Q Encapsulation Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gre&sektion=4">gre</a> - GRE/MobileIP Encapsulation Interface
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gif&sektion=4">gif</a> - Generic IPv4/IPv6 Tunnel Interface
</ul>

<p>
Pokud va¹e zaøízení nemáte nakonfigurované, prvním krokem je vytvoøení souboru
<strong>/etc/hostname.xxx</strong>.
Jméno zaøízení se nachází na místì xxx. V pøedcházejícím pøíkladu by
by jméno bylo <strong>/etc/hostname.ne3</strong>. Formát tohoto souboru
je jednoduchý:<br>
</p>

<ul><pre>
address_family va¹e_ip va¹e_sí»ová_maska [media options]
</pre></ul>

(Mnohem více informací o formátu tohoto souboru najdete v manuálové stránce 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&sektion=5">hostname.if(5)</a>.)
</p>

<p>
Typický konfiguraèní soubor rozhraní nastaveného na IPv4 adresu
bude vypadat takto:
</p>

<ul><pre>
$ <strong>cat /etc/hostname.fxp0</strong>
inet 10.0.0.38 255.255.255.0 NONE
</pre></ul>

<p>
Mù¾ete také urèit typ Ethernetového média, tøeba kdy¾ si budete chtít vynutit 
100baseTX full-duplex mód.
</p>

<ul><pre>
inet 10.0.0.38 255.255.255.0 NONE media 100baseTX media-opt full-duplex
</pre></ul>

(Samozøejmì byste si nikdy nemìli vynutit full dupplex mód,
pokud to neudìlají obì strany spojení! Pokud nemáte speciální potøeby,
nastavení média by mìlo být vynecháno.)

<p> 
Nebo mù¾ete chtít nastavit speciální flagy pro urèité zaøízení. Formát
souboru hostname se pøíli¹ nezmìní!
</p>

<ul><pre>
$ <strong>cat /etc/hostname.vlan0</strong>
inet 172.21.0.0 255.255.255.0 NONE vlan 2 vlandev fxp1
</pre></ul>

<p>
Dal¹í krok je nastavení defaultního routeru. Provedete to tak, ¾e jeho IP adresu
umístíte do souboru s názvem <strong>/etc/mygate</strong>. Tím umo¾òíte, aby
vá¹ defaultní router byl nastaven pøi startu. 
Poté byste mìli nastavit va¹e nameservery a soubor <strong>/etc/hosts</strong>
(viz manuálová stránka <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&sektion=5">hosts(5)</a>).
Nastavení nameserverù spoèívá mmj. ve vytvoøení souboru s názvem 
<strong>/etc/resolv.conf</strong>. Více informací o formátu tohoto souboru 
naleznete v manuálové stránce 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolv.conf&sektion=5">resolv.conf(5)</a>.
Pro standardní pou¾ití zde je pøíklad takového souboru. V tomto pøíkladu 
pøedpokládejme, ¾e adresy va¹ich nameserverù jsou 125.2.3.4 a 125.2.3.5. 
Patøíte rovnì¾ do domény &quot;yourdomain.com&quot;.
</p>

<ul><pre>
$ <strong>cat /etc/resolv.conf</strong>
search yourdomain.com
nameserver 125.2.3.4
nameserver 125.2.3.5
lookup file bind
</pre></ul>

<p>
Nyní mù¾ete buïto restartovat poèítaè, nebo spustit skript <strong>/etc/netstart</strong>.
Udìláte to jednodu¹e napsáním (jako u¾ivatel root):
</p>

<ul><pre>
# <strong>sh /etc/netstart</strong>
writing to routing socket: File exists
add net 127: gateway 127.0.0.1: File exists
writing to routing socket: File exists
add net 224.0.0.0: gateway 127.0.0.1: File exists
</pre></ul>

<p>
V¹imnìte si, ¾e do¹lo k nìkolika chybám.
Spu¹tìním tohoto skriptu rekonfigurujete vìci,
které jsou ji¾ zkonfigurovány. Tak tøeba nìkteré routy
u¾ existovaly v routovacích tabulkách jádra.
Nyní by vá¹ systém mìl být nastaven
a mìl by fungovat. Opìt se mù¾ete pøíkazem 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8">ifconfig(8)</a>
pøesvìdèit, ¾e je va¹e zaøízení nastaveno správnì. Smìrování paketù na sí»ových rozhraních,
nastavení rout mù¾ete zkontrolovat pomocí pøíkazu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&sektion=1">netstat(1)</a>
nebo <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=route&sektion=8">route(8)</a>.
Zde je pøíklad, jak si obìma zpùsoby prohlédnout routovací tabulky.
</p>

<ul><pre>
$ <strong>netstat -rn</strong>
Routing tables

Internet:
Destination        Gateway            Flags     Refs     Use    Mtu  Interface
default            10.0.0.1           UGS         0       86      -  fxp0 
127/8              127.0.0.1          UGRS        0        0      -  lo0
127.0.0.1          127.0.0.1          UH          0        0      -  lo0
10.0.0/24          link#1             UC          0        0      -  fxp0 
10.0.0.1           aa:0:4:0:81:d      UHL         1        0      -  fxp0
10.0.0.38          127.0.0.1          UGHS        0        0      -  lo0
224/4              127.0.0.1          URS         0        0      -  lo0

Encap:
Source             Port  Destination        Port  Proto SA(Address/SPI/Proto)

$ <strong>route show</strong>
Routing tables

Internet:
Destination      Gateway            Flags
default          10.0.0.1           UG
127.0.0.0        LOCALHOST          UG
localhost        LOCALHOST          UH
10.0.0.0         link#1             U
10.0.0.1         aa:0:4:0:81:d      UH
10.0.0.38        LOCALHOST          UGH
BASE-ADDRESS.MCA LOCALHOST          U
</pre></ul>

<p>
<a name="Setup.2"></a>
<a name="6.1.2"></a>
<h3>6.1.2 - Nastavení OpenBSD jako routeru</h3>
</p>

<p>
Následují základní informace, které potøebujete znát, abyste mohli nastavit
va¹e OpenBSD jako router . Pokud pou¾íváte OpenBSD jako
router v síti Internet, doporuèujeme vám, abyste si pøeèetli rovnì¾ nastavení
Packet Filteru, o kterém pojednává dal¹í èást. Pomocí Packet Filteru mù¾ete blokovat
potenciálnì nebezpeèné sí»ové relace. Rovnì¾ z dùvodu nedostatkù IP adres na
Internetu pro
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip&sektion=4">IPv4</a>
se mù¾ete podívat na Pøeklad sí»ových adres (Network address translation), 
kde najdete informace, jak roz¹íøit vá¹ adresový prostor.
</p>

<p>
Jádro kompilované jako GENERIC má ji¾ v sobì podporu IP Forwardingu, kterou je 
nutné zapnout. Mù¾ete tak uèinit pomocí pøíkazu  
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">sysctl(8)</a>. 
Pro trvalou zmìnu byste mìli zeditovat soubor 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl.conf&sektion=5">/etc/sysctl.conf(5)</a>.
Udìláte to snadno pøidáním následující øádky do tohoto souboru.
</p>

<ul><pre>
net.inet.ip.forwarding=1
</pre></ul>

<p>
Chcete-li tuto zmìnu provést bez restartu stroje, mìli byste pou¾ít pøíkaz
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">sysctl(8)</a>.
Pamatujte si v¹ak, ¾e tato zmìna nebude trvalá, vydr¾í
jen do rebootu a také ¾e tento pøíkaz musíte spustit jako u¾ivatel root.
</p>

<ul><pre>
# <strong>sysctl -w net.inet.ip.forwarding=1</strong>
net.inet.ip.forwarding: 0 -&gt; 1
</pre></ul>

<p>
Nyní zmìòte routovací tabulky na jiných strojích. Je mnoho zpùsobù pou¾ití 
OpenBSD jako router, pomocí softwaru
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=routed&apropos=0&sektion=8">routed(8)</a>,
<a href="http://www.gated.org">gated</a>,
<a href="http://www.mrtd.net">mrtd</a> a <a href="http://www.zebra.org">zebra</a>.
OpenBSD podporuje porty v ports tree zebra, gated, a mrtd.
OpenBSD podporuje mnoho sí»ových zaøízení, jako T1, HSSI, ATM, FDDI, Ethernet
a sériové PPP/SLIP zaøízení.
</p>

<p>
<a name="Setup.3"></a>
<a name="6.1.3"></a>
<h3>6.1.3 - Nastavení aliasù zaøízení.</h3>
</p>

<p>
OpenBSD má jednoduchý mechanismus, který umo¾òuje nastavit ip aliasy na zaøízení.
V¹e spoèívá v jednoduché editaci souboru
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&sektion=5"><i>/etc/hostname.&lt;if&gt;</i></a>.
Tento soubor je pøeèten pøi startu systému skriptem
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&sektion=8">/etc/rc(8)</a>,
který je souèástí <a href="faq10.html#rc">rc startup hierarchy</a>. 
Napøíklad pøedpokládejme, ¾e u¾ivatel má zaøízení <b>dc0</b> a je na síti 192.168.0.0.
Dal¹í podstatné informace jsou:
</p>

<ul>
<li>IP adresa pro dc0 je 192.168.0.2
<li>sí»ová maska  255.255.255.0
</ul>

<p>
Nìkolik poznámek o aliasech. V OpenBSD pou¾íváte pouze název zaøízení. Není 
tady rozdíl mezi prvním aliasem nebo druhým aliasem. Narozdíl od nìkterých 
operaèních systémù, OpenBSD se na nì neodkazuje jako dc0:0, dc0:1. Pokud se 
odkazujete na urèitou aliasovanou IP adresu pomocí ifconfig, nebo pøidáváte 
alias, ujistìte se, ¾e pí¹ete "<tt>ifconfig interface alias</tt>" namísto  
"<tt>ifconfig interface</tt>". Smazat alias mù¾ete pomocí 
"<tt>ifconfig interface delete</tt>".
<p>
Pøedpokládejme, ¾e pou¾íváte více IP adres, které jsou na stejné podsíti, 
a pou¾íváte k tomu aliasy. va¹e sí»ová maska pro ka¾dý alias má automaticky 
hodnotu 255.255.255.255. Není nutné, aby sí»ové masky aliasù následovaly 
sí»ovou masku prvního IP spojeného s tímto zaøízením. V následujícím pøíkladì 
<i>/etc/hostname.dc0</i> jsou pøidány dva aliasy pro zaøízení dc0, které mimo 
jiné bylo nastaveno jako 192.168.0.2 netmask 255.255.255.0.
</p>

<ul><pre>
inet 192.168.0.2 255.255.255.0 media 100baseTX
inet alias 192.168.0.3 255.255.255.255
inet alias 192.168.0.4 255.255.255.255
</pre></ul>

<p>
Poté co jste vytvoøili tento soubor, budete muset rebootovat, aby se zmìny 
nastavení projevily. Nebo mù¾ete nastavit aliasy ruènì pomocí 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&sektion=8">ifconfig(8)</a>.
Nastavení prvního aliasu by se provedlo takto:
</p>

<ul><pre>
# <b>ifconfig dc0 inet alias 192.168.0.3 netmask 255.255.255.255</b>
</pre></ul>

<p>
Pro prohlí¾ení tìchto aliasù je vhodný pøíkaz:
</p>

<ul><pre>
$ <b>ifconfig -A</b>
dc0: flags=8863&lt;UP,BROADCAST,NOTRAILERS,RUNNING,SIMPLEX,MULTICAST&gt;
        media: Ethernet manual
        inet 192.168.0.2  netmask 0xffffff00 broadcast 192.168.0.255
        inet 192.168.0.3 netmask 0xffffffff broadcast 192.168.0.3
</pre></ul>

<p>
<a name= "6.2"></a>
<a name= "PF"></a>
<h2>6.2 - Packet Filter (PF)</h2>
</p>
<p>
<h5>Poznámka: Packet Filter je filtrovací systém v OpenBSD 3.0 a
pozdìj¹ích. Pokud hledáte IPF/IPNAT FAQ pro OpenBSD 2.9 a star¹í,
kliknìte <a href="faqipf.html">zde</a>.</h5>
</p>
<p>
Subsystém Packet Filter slou¾í k zaji¹tìní dvou úloh,
filtrování na úrovni paketù a mapování poèítaèù a podsítí na okruh
externích adres. Konfiguraèní soubory pro tyto dvì slu¾ny jsou
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5">/etc/pf.conf(5)</a></i> 
a 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nat.conf&sektion=5">/etc/nat.conf(5)</a></i>.
</p>
<p>
Aby se tyto slu¾by spou¹tìly pøi startu systému, musíte upravit 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&sektion=8">/etc/rc.conf(8)</a></i>
a nastavit pøíslu¹ný øádek na:
</p>

<ul><pre>
pf=YES
</pre></ul>

<p>
Pokud pou¾íváte NAT, nejspí¹ budete muset nastavit také hodnotu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">sysctl(8)</a>
<tt>net.inet.ip.forwarding</tt> na 1. To mù¾ete udìlat odkomentováním
pøíslu¹ného øádku v 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl.conf&sektion=5">/etc/sysctl.conf(5)</a></i>
a restartováním poèítaèe.
</p>
<p>
Pokud máte Packet Filter zakompilovaný v jádøe, ale nemáte ho aktivován v
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&sektion=8">/etc/rc.conf(8)</a></i>,
mù¾ete ho stále je¹tì aktivovat pøíkazem
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&sektion=8&manpath=OpenBSD+3.1">pfctl(8)</a>.
</p>
<ul><pre>
# <b>pfctl -R /etc/pf.conf</b>
# <b>pfctl -N /etc/nat.conf</b>
# <b>pfctl -e</b>
</pre></ul>

<p>
První øádek nastavuje filtrování podle <i>/etc/pf.conf</i>,
druhý nastaví NAT podle <i>/etc/nat.conf</i> (více o NAT najdete
dále v <a href="#NAT">Sekci 6.3, NAT</a>) a koneènì
tøetí aktivuje PF.
</p>
Mù¾ete to také zapsat jedním pøíkazem:
<ul><pre>
# <strong>pfctl -R /etc/pf.conf -N /etc/nat.conf -e</strong>
</pre></ul>
<p>
Pokud udìláte zmìny v <i>/etc/pf.conf</i> poté
co je PF spu¹tìn, mù¾ete znovu nahrát pravidla opìtovným naètením pøíslu¹ného
souboru:
</p>
<ul><pre>
# <b>pfctl -R /etc/pf.conf</b>
</pre></ul>

<p>
Tento dokument dále popisuje jen nìkolik základních konfigurací  
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5&manpath=OpenBSD+3.1">pf.conf(5)</a>
a <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nat.conf&sektion=5&manpath=OpenBSD+3.1">nat.conf(5)</a>.
Mù¾ete se také podívat na <a href="#sample_pf.conf">výsledná
pravidla</a>, která obsahují v¹echna vylep¹ení detailnì popsaná ní¾e.
Dal¹í informace o Packet Filteru najdete na
<a href="http://www.benzedrine.cx/pf.html">webové stránce Packet Filteru</a> 
a v 
<a href="http://www.inebriated.demon.nl/pf-howto/">Packet Filter HOWTO</a>. 
</p>

<p>
<h3>Packet Filter</h3>
</p>

<p>
Abyste zapnuli Packet Filter pøi bootu, musíte upravit
<i>/etc/rc.conf</i> tak, aby obsahoval <tt>pf=YES</tt>.  Packet Filter (pf)
se nastavuje pomocí <i>/etc/pf.conf</i>, který je naèten pøi bootu.  
Detailnìj¹í vysvìtlení si pøeètete v
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5&manpath=OpenBSD+3.1">pf.conf(5)</a>. 
V následujících pøikladech reprezentuje <tt>fxp0</tt> externí rozhraní k internetu.
Ve va¹em pøípadì bude patrnì jiné, podle ethernetového adaptéru ve va¹em
poèítaèi. Pravidla pøedpokládají trvalé spojení s Internetem, jaké byste
zaøídili patrnì pro webserver.
</p>

<p>
Pravidla Packet Filtru jsou zpracovávána postupnì od shora dolù.
Ka¾dý paket musí pøejít pøes tato pravidla, pøedtím ne¾ dosáhne svého urèení.
</p>

<p>
Napøíklad implicitní soubor pravidel umo¾òuje ka¾dému paketu cestovat dovnitø
a ven:

<ul><pre>
pass out all 
pass in all
</pre></ul>

co¾ je zkrácený zápis
<ul><pre>
pass in from any to any
pass out from any to any
</pre></ul>

To znamená &quot;propus» pøíchozí pakety odkudkoliv, smìøující kamkoliv&quot;
s implikovaným &quot;na ka¾dém rozhraní (co¾ je pøedpokládáno poka¾dé, pokud
není specifikováno konkrétní rozhraní) ka¾dé address family,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inet&sektion=4">inet (v4)</a>
nebo <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inet6&sektion=4">inet6 (v6)</a>&quot;.
</p>
<p>
Pochopitelnì ¾e tohle není ¾ádný filtr. Skuteèné filtrování bude zalo¾eno
na address family (IPv4 nebo IPv6), protokolu a portu vyu¾ívaných slu¾bou,
kterou chcete filtrovat. Mù¾ete specifikovat kterýkoli protokol z
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=protocols&sektion=5">/etc/protocols(5)</a></i>,
a» u¾ jménem nebo èíslem, ale my se zamìøíme na
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcp&sektion=4">tcp(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=udp&sektion=4">udp(4)</a> a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp&sektion=4">icmp(4)</a>.
</p>

<p>
Nyní pøedpokládejme, ¾e nechceme dovolit jakoukéliv pøichozí IPv4 spojení 
na port 3306 (MySQL), proto¾e k databázi by mìl být pøístup pouze z localhostu.
Soubor pravidel by vypadal takto:

<ul><pre>
pass out all
pass in all
block in on fxp0 inet proto tcp from any to any port 3306
</pre></ul>

Toto øíká &quot;blokuj v¹echny pøíchozí IPv4 (inet) pakety, pøicházející 
odkudkoliv, smìøující kamkoliv, jejich¾ cílem je port 3306.&quot;
V¹imnìte si, ¾e pokud filtrujete podle portu, musíté uvést také protokol
a doporuèuje se urèit i address family. Slu¾eby definované
v souboru <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&sektion=5">/etc/services(5)</a>
mù¾ete také specifikovat jejich jménem, napøíklad <em>www</em> nebo 
<em>mysql</em>.
Paket urèený pro port 3306 na zaøízení <tt>fxp0</tt> projde pøes první
&quot;pass in&quot; pravidlo a potom bude odhozen díky pravidlu 
&quot;block in port 3306&quot;. Pokud zmìníte poøadí va¹ich pravidel 
(vzpomeòte si, poøadí je dùle¾ité):

<ul><pre>
pass out all
block in on fxp0 inet proto tcp from any to any port 3306
pass in all
</pre></ul>

Pakety urèené pro port 3306 projdou, proto¾e poslední pravidlo souboru dovoluje
v¹em pøíchozím paketùm projít. Je dùle¾ité pamatovat si pøi psaní pravidel
pro Packet Filter, ¾e:
<b> Poslední odpovídající pravidlo vítìzí</b>.
</p>

<p>
Samozøejmì ¾e existují vyjímky pro ka¾dé pravidlo. Volba <em>quick</em> ukonèí
zpracování paketu na prvním pravidlu, které odpovídá. Podívejme se na pøedcházející pøíklad.
Pokud pøidáme <em>quick</em> k pravidlu &quot;block in&quot;:

<ul><pre>
pass out all
block in quick on fxp0 inet proto tcp from any to any port 3306
pass in all
</pre></ul>

<p>
Paket urèený pro ná¹ poèítaè na port 3306 bude zpracován bezprostøednì pravidlem
&quot;block in quick&quot; a bude odhozen. V¹echny pakety urèené pro jiné porty
nenajdou odpovídající pravidlo, dokud nedosáhnou pravidla &quot;pass in&quot;,
které jim dovolí projít.
</p>

<b>Default Deny</b>
<p> Nejbezpeènìj¹í politika filtrování paketù je tzv. politika default deny.
V¹echny pakety, které nejsou pøímo dovoleny, jsou odhozeny. Tato politika je
mnohem bezpeènìj¹í ne¾ pøímo nepovolovat ka¾dou chránìnou slu¾bu, umo¾òuje
mít relativnì malý soubor pravidel a také mù¾e ochránit od ¹patnì 
nakonfigurované slu¾by, která je ponechána svému osudu.
</p>
<p>
Nyní se podívejte na jiný pøíklad skuteèného ¾ijícího pøíkladu pravidel a
vysvìtleme si øádku po øádce jejich význam. Je to pøíklad webserveru s default
deny politikou, která povoluje pouze ssh spojení (pro administraci) a spojení
http (port 80) a https (port 443).
</p>
<ul><pre>
block in on fxp0 all
pass  in on fxp0 inet proto tcp from any to any port 22
pass  in on fxp0 inet proto tcp from any to any port 80
pass  in on fxp0 inet proto tcp from any to any port 443
pass out on fxp0 all
</pre></ul>

<p>
Tato pravidla dovolí projít pøíchozím spojením odkudkoliv na tcp porty 22(ssh), 
80(http) a 443(https). Odhodí v¹echny ostatní pakety a umo¾ní v¹echna
odchozí spojení. To u¾ je celkem dobrá sada pravidel.
Co kdy¾ ale chcete dovolit ssh spojení pouze z interních strojù 
ve va¹em adresovém bloku 1.1.1.0, ale dovolit
spojení zvenku na http a https?

<ul><pre>
block in on fxp0 all
pass  in on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22
pass  in on fxp0 inet proto tcp from any to any port 80
pass  in on fxp0 inet proto tcp from any to any port 443
pass out on fxp0 from all
</pre></ul>

Docela dobré, ale co kdy¾ chceme dovolit pouze jednomu stroji (1.1.1.1)
administrovat webserver vzdálenì?
V tomto pøípadì mù¾eme zmìnit:

<ul><pre>
pass  in on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22
</pre></ul>
na:
<ul><pre>
pass  in on fxp0 inet proto tcp from 1.1.1.1/32 to any port 22
</pre></ul>
</p>

<b>Pøíklad souboru pravidel</b>
<p>
Zde je nìkolik pravidel pro ka¾dého (pøedpokládejme, ¾e fxp0 je externí zaøízenípøipojené na internet). Nejprve nastolíme jednoduchou address spoofing ochranu.
Tyto adresy by (normálnì) nemìly poletovat Internetem, a pokud ano,
je to málokdy dobøe, tak¾e je zablokujeme:
<ul><pre>
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }
</pre></ul>

Ná¹ soubor pravidel zatím vypadá dobøe; kdy¾ to dáme v¹echno dohromady,
vypadá to takto:

<ul><pre>
# don't allow anyone to spoof non-routeable addresses
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }

# only allow our administration machine to connect via ssh
pass in quick on fxp0 inet proto tcp from 1.1.1.1/32 to any port 22

# allow others to use http and https
pass in quick on fxp0 inet proto tcp from any to any port 80
pass in quick on fxp0 inet proto tcp from any to any port 443

# finally lock the rest down with a default deny
block in quick on fxp0 from any to any

# and let out-going traffic out
pass out on fxp0 from any to any
</pre></ul>
</p>

<b>Logování paketù</b>
<p>
Nyní je na¹e situace dost dobrá, ale mohla by být je¹tì lep¹í. Co kdy¾ chceme
logovat ka¾dý pokus o spojení na port 22(ssh), který byl firewallem zablokován?
Jednodu¹¹e, Packet Filter to umo¾òuje pomocí slova <em>log</em> :
<ul><pre>
pass in quick on fxp0 inet proto tcp from 1.1.1.1/32 to any port 22
block in log quick on fxp0 inet proto tcp from any to any port 22
</pre></ul>
Toto pravidlo dovolí na¹emu vzdálenému administraènímu poèítaèi spojení na port
22, ale blokuje a loguje v¹echny ostatní pokusy o spojení na port 22.
</p>
<p>
Logované pakety jsou posílány na rozhraní pflog0, které monitoruje
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&sektion=8&manpath=OpenBSD+3.1">pflogd(8)</a>,
jen¾ vìt¹inou dumpuje pakety do <i>/var/log/pflog</i> v binárním formátu pro 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&sektion=8&manpath=OpenBSD+3.1">tcpdump(8)</a>.
pflogd(8) je standardnì pou¹tìn z 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&sektion=8">/etc/rc(8)</a></i>,
pokud je pf zapnutý v
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&sektion=8">/etc/rc.conf(8)</a></i>.
Tento soubor logù si mù¾ete pøeèíst následujícím pøíkazem:
<ul><pre>
# <b>tcpdump -n -e -ttt -r /var/log/pflog</b>
</pre></ul>
</p>
<p>
Mìli byste si být vìdomi, ¾e pou¾ití tcpdumpu k monitorování souboru pflog
NEZOBRAZUJE výsledky v reálném èase. Pokud chcete vidìt logy v reaálném èase,
mù¾ete pou¾ít tento pøíkaz:
<ul><pre>
# <b>tcpdump -i pflog0</b>
</pre></ul>
Také je mo¾né usnadnit si debugování tím, ¾e zmen¹íme zábìr tcpdumpu:
<ul><pre>
# <b>tcpdump -e -i pflog0 port 80</b>
</pre></ul>
Tímto NEBUDOU ovlivnìna data, která jsou ulo¾ena v souboru
<i>/var/log/pflog</i>.  
</p>
<p>
Pøi zkoumání logù byste mìli být obzvlá¹tì opatrní pøi &quot;verbose
protocol decoding&quot; (aktivovaném volbou -v na pøíkazové øádce).
Tcpdumpové dekodery protokolù nemají úplnì nejlep¹í historie bezpeènosti.
Alespoò teoreticky jsou mo¾né zpo¾dìné útoky prostøednictvím
urèitého obsahu paketù nahraných logovacím zaøízením.
</p>
<p>
Speciální pozornost by mìla být vìnována pøístupu k logùm. Pflogd
odchytí 96 bytù paketu a zapí¹e je do logu. Pøístup k logùm
mù¾e poskytnout èásteèný pøístup k citlivému obsahu paketù (napø. pøihla¹ování 
pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&sektion=1">telnetu(1)</a> nebo 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&sektion=1">ftp(1)</a> ).
</p>

<p>
<b>Vícenásobné protokoly</b>
</p>
<p>
Co kdy¾ potøebujeme povolit spojení na slu¾by bì¾ící pøes více protokolù,
jako je bind, který vyu¾ívá TCP a UDP?
Packet Filter vám umo¾òuje volby spojit dohromady do mno¾in 
(o tom více podìji):
<ul><pre>
# Pass DNS traffic for BIND
pass in quick on fxp0 inet proto { tcp, udp } from any to any port 53
</pre></ul>
V¹imnìte si mezer z obou stran kolem znakù '{ }'. To je èist¹í
ne¾ alternativní zápis, který byste jinak pou¾ili:
<ul><pre>
pass in quick on fxp0 inet proto tcp from any to any port 53
pass in quick on fxp0 inet proto udp from any to any port 53
</pre></ul>
</p>

<p>
<a name="normalization"></a>
<b>Normalizování paketù</b>
</p>
<p>
Normalizování paketù znamená opìtné spojování fragmentovaných paketù
a ru¹ení IP options.
Nìkteré operaèní systémy a aplikace mívají problémy s abnormálními nebo
fragmentovanými pakety a je obecnì dobré mít pakety normalizované
pøi porovnávání s pravidly filtru a doruèení cílovému stroji. 
Proto je témìø v¾dy pøínosné normalizovat pakety pøedtím, ne¾ jsou
propu¹tìny na své koneèné místo urèení. 
To je mo¾né provést volbou <b>scrub</b>,
pou¾itou takto:
<ul><pre>
scrub in all
</pre></ul>
To zpùsobuje velmi malé dal¹í zatí¾ení systému a vy¾aduje trochu pamìti
na cachování fragmentù paketu. Pøínos normalizace paketù témìø v¾dy
pøevý¹í tyto ztráty.
</p>

<p>
<b>IP options</b>
</p>
<p>
Standardnì PF blokuje pakety s nastavenými IP options. To mù¾e ztí¾it ¾ivot
utilitám pro &quot;OS fingerprinting&quot;, jako je nmap. Pokud máte aplikaci,
která vy¾aduje propou¹tìní takových paketù, jako multicast nebo IGMP, mù¾ete
vyu¾ít volbu <b>allow-opts</b>:
<ul><pre>
pass in quick on fxp0 all allow-opts
</pre></ul>
</p>

<p>
<b>TCP pøíznaky, vytvoøená spojení a keeping state</b>
</p>
<p>
Packet Filter mù¾e také filtrovat pakety na základì TCP pøíznakù
a udr¾ovat vytvoøená spojení a stavy spojení. Doporuèujeme,
aby v¹ichni u¾ivatelé, kteøí chtìjí filtrovat pakety podle TCP
pøíznakù, rozumìli, jaký význam ka¾dý pøíznak má. Napøíklad
pokud chcete blokovat v¹echny pakety s nastavenými pøíznaky
FIN, URG a PSH (jako ku pøíkladu pokusy o OS fingerprinting nmapem)
pou¾ijete takovéhle pravidlo:
<ul><pre>
block in quick on fxp0 inet proto tcp from any to any flags FUP/FUP
</pre></ul>
(Thanks to <a href=mailto:halogen@nol.net>Kyle Hargraves</a> za tento tip)
</p>
<p>
Dal¹í skvìlá vlastnost Packet Filteru je jeho schopnost udr¾ovat stav.
Udr¾ování stavu je vysvìtlováno jako &quot;nemluvit dokud nejsem osloven&quot;.
Jinak øeèeno, jakmile je spojení vytvoøeno, pakety u¾ nemusí projít
souborem pravidel. To je velice mocná vlastnost, která umo¾òuje
psaní mnohem jednodu¹¹ích a bezpeènìj¹ích pravidel.
</p>
<p>
Napøíklad se podívejme, jak mu¾eme uplatnit tuto vlastnost pøi psaní na¹í
ukázkové sestavy pravidel. Pro pøipomenutí, dovolujeme administraèní pøístup z
na¹í adresy tøídy C na port 22(ssh) a dovolujeme v¹echna pøíchozí spojení
na port 80 (http) a 443 (https). Blokujeme v¹echna ostatní spojení. Co ale
dìlat v pøípadì, ¾e se chceme spojit pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssh&sektion=1">ssh(1)</a>
z web serveru, nebo chceme pou¾ít 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lynx&sektion=1">lynx(1)</a> 
abychom se podívali na nìco ve FAQ? To udìlat nemù¾eme, proto¾e
jsme zablokovali v¹echna pøíchozí spojení, které smìøují na jiné ne¾ námi
povolené porty. Aèkoliv nastavení ip filtru je tak bezpeèné jak to jen jde,
mù¾e být ponìkud nevyhovující. Pøídáním slova <em>keep state</em> do pravidla
 &quot;pass out&quot; mù¾eme automaticky povolit pakety, které pøicházejí
jako odezva na na¹e pokusy o spojení, jako je napø. surfování na webu.
Pamatujte si, ¾e potøebujeme specifikovat protokol, pro který udr¾ujeme stav.
</p>
<ul><pre>
block in  on fxp0 inet proto tcp all
pass  in  on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22 keep state
pass  in  on fxp0 inet proto tcp from any to any port 80 keep state
pass  in  on fxp0 inet proto tcp from any to any port 443 keep state
pass  out on fxp0 inet proto tcp all keep state
</pre></ul>
<p>
Tato malá zmìna dramaticky zvy¹uje flexibilitu a bezpeènost na¹í sady pravidel.
Napøíklad, v pøecházejícím pøíkladì umo¾òujeme tcp spojení na port 80 a 443.
Mù¾eme to ale je¹tì zlep¹it. K tomu, aby se vytvoøilo tcp spojení, potøebujeme
aby probìhl jen poèáteèní handshake. Jakmile k nìmu dojde, mù¾eme blokovat
spojení na tento port a pomocí na¹eho &quot;keep state&quot; pravidlo bude
udr¾ovat vytvoøené spojení. Abychom dovolili poèáteèní handshake, potøebujeme
dovolit pakety pouze s nastaveným flagem SYN a nenastaveným ACK. Propu¹tìním paketù
pouze s pøíznaky SYN se ubráníme mnoha formám port skenù jako je
napøíklad FIN skenování. flags S/SA znamená: z flagù S (SYN) a A (ACK) mù¾e
být nastaven jenom SYN. Ostatní flagy nejsou zkoumány.
Pravidla nyní vypadají takto:
<ul><pre>
block in  on fxp0 inet proto tcp all
pass  in  on fxp0 inet proto tcp from 1.1.1.0/24 to any port 22 \
	flags S/SA keep state
pass  in  on fxp0 inet proto tcp from any to any port 80 \
	flags S/SA keep state
pass  in  on fxp0 inet proto tcp from any to any port 443 \
	flags S/SA keep state
block out on fxp0 inet proto tcp all
pass  out on fxp0 inet proto tcp all flags S/SA keep state
</pre></ul>
</p>
<p>
Nyní dejme dohromady v¹echny pravidla, která jsme mìli dosud v na¹í sadì.
Tato sada bude podporovat IPv4, mít default deny politiku, 
povolující pouze administrativní spojení z interní sítì (pøes ssh)
a umo¾òující pøíchozí spojení na porty
80 (http) a 443 (https). Ochrání nás rovnì¾ pøed spoofovanými neroutovatelnými
ip adresami a zaká¾e v¹echny pakety, které jsou pøíli¹ fragmentované nato, aby
se daly vy¹etøit. Docela dobré nastavení pro veøejný webserver. Zde je
ukázka souboru <i>/etc/pf.conf</i>:
<ul><pre>
# Clean up fragmented and abnormal packets
scrub in all

# don't allow anyone to spoof non-routeable addresses
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }

# by default, block all incoming packets, except those explicitly
# allowed by further rules
block in on fxp0 all

# allow others to use http and https
pass in on fxp0 inet proto tcp from any to any port 80 \
	flags S/SA keep state
pass in on fxp0 inet proto tcp from any to any port 443 \
	flags S/SA keep state

# and let out-going traffic out and maintain state on established connections
# pass out all protocols, including TCP, UDP and ICMP, and create state,
# so that external DNS servers can reply to our own DNS requests (UDP).
block out on fxp0                 all
pass  out on fxp0 inet proto tcp  all flags S/SA keep state
pass  out on fxp0 inet proto udp  all            keep state
pass  out on fxp0 inet proto icmp all            keep state

</pre></ul>
</p>
<p>
I kdy¾ toto mù¾e vypadat dobøe, existuje je¹tì pár dal¹ích vìcí, kterými vám
Packet Filter pomáhá, aby soubor <i>pf.conf</i> byl èist¹í a dal se lépe
udr¾ovat.
</p>

<p>
<b>Mno¾iny</b>
</p>
<p>
Mno¾iny jsou u¾iteèné "zkratky" pro psaní jednoduchých
a jasných pravidel v PF. Co kdy¾, napøíklad, potøebujeme
povolit spojení na slu¾by bì¾ících pøes více protokolù,
jako tøeba BIND, který pou¾ívá TCP a UDP?
<ul><pre>
pass in quick on fxp0 inet proto { tcp, udp } from any to any port 53
</pre></ul>
V¹imnìte si mezer z obou stran znakù '{ }'.
</p>
<p>
Skupiny souvisejících IP mohou být spojeny dohromady do mno¾in,
které mohou být kdekoliv pou¾ity místo jednoho IP.
Vezmeme-li ku pøíkladu na¹e anti-spoofing pravidla uvedená vý¹e:
<ul><pre>
# don't allow anyone to spoof non-routeable addresses
block in quick on fxp0 inet from { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 } to any
block out quick on fxp0 inet from any to { 127.0.0.0/8, 192.168.0.0/16, \
172.16.0.0/12, 10.0.0.0/8 }
</pre></ul>
</p>

<p>
<b>Expanze promìných</b>
</p>
<p>
Jeden problém se vý¹e uvedeným vzorovým souborem <i>pf.conf</i> je,
¾e pokud potøebujete vymìnit vá¹ NIC nebo zmìnit IP adresu,
musíte zmìnit velký poèet øádek. Ten mù¾eme sní¾it pou¾itím
expanze promìných:
</p>
<ul><pre>
NoRouteIPs="{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
ExtIF="fxp0"
block in quick on $ExtIF from $NoRouteIPs to any
block out quick on $ExtIF from any to $NoRouteIPs
</pre></ul>
</p>

<p>
<a name="sample_pf.conf"></a>
<b>Dáváme to v¹e dohromady</b>
</p>
<p>
A teï to v¹echno dejme dohromady a podívejme se na eleganci výsledného souboru:
<ul><pre>
# Define useful variables
ExtIF="fxp0"              # External Interface
IntNet="1.1.1.0/24"       # Our internal network
NoRouteIPs="{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
Services="{ www, https }"

# Clean up fragmented and abnormal packets
scrub in all

# don't allow anyone to spoof non-routeable addresses
block in  quick on $ExtIF from $NoRouteIPs to any
block out quick on $ExtIF from any to $NoRouteIPs

# by default, block all incoming packets, except those explicitly
# allowed by further rules
block in on $ExtIF all

# allow others to use http and https
pass  in on $ExtIF inet proto tcp from any to any port $Services \
	flags S/SA keep state

# and let out-going traffic out and maintain state on established connections
# pass out all protocols, including TCP, UDP and ICMP, and create state,
# so that external DNS servers can reply to our own DNS requests (UDP).
block out on $ExtIF                 all
pass  out on $ExtIF inet proto tcp  all flags S/SA keep state
pass  out on $ExtIF inet proto udp  all            keep state
pass  out on $ExtIF inet proto icmp all            keep state
</pre></ul>
</p>

<p>
Pokud se vyskytnou nìjaké problémy, mo¾ná budete chtít zprovoznit logování
u jednotlivých pravidel, abyste vìdìli, co se dìje, napø:
<ul><pre>
pass in log quick on fxp0 proto tcp from 1.1.1.0/24 to any port 22
</pre></ul>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&sektion=8&manpath=OpenBSD+3.1">pflogd(8)</a>
zapí¹e záznam ip logu do <i>/var/log/pflog</i>.
Vzpomìnte si, ¾e <i>/var/log/pflog</i> je binární soubor urèený ke ètení pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&sektion=8&manpath=OpenBSD+3.1">tcpdump(8)</a>,
NE pøímo èlovìkem.
</p>
<p>
Pokud zmìníte konfiguraèní soubor, nezapomeòte pou¾ít
<b>pfctl -R /etc/pf.conf</b>, aby se zmìny uplatnily! 
</p>

<p>
<h3>Rozdíly mezi PF a IPF</h3>
</p>
<p>
Packet Filter byl navr¾en tak, aby byl velmi kompatibliní se
souborem <i>ipf.rules</i> pro IPF.
Nicménì PF není jednodu¹e pøesná náhrada IPF.
Základní rozdíly v syntaxy pravidel filtrování (pf.conf) jsou následující:
</p>
<ul>
<li><b>group and head:</b>  Tyto volby nejsou dále podporovány,
nebo» pravidla filtru jsou optimalizována za bìhu.
Pokud pøená¹íte stará pravidla z IPF, mìli byste smazat
v¹echny definice <em>group</em> nebo <em>head</em> a ruènì
pøeuspoøádat pravidla tak, aby se jejich semantika nezmìnila.</li>
<li><b>level:</b> Pøi logování PF neakceptuje volbu <em>level</em> u klíèového
slova log, proto¾e logování se nedìje prostøednictvím 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&sektion=8">syslogdu(8)</a>, ale separátním logovacím démonem. K odli¹ení konrétního typu
provozu tak, jak mohlo být provedeno volbou <em>level</em>,
pou¾ijte dostupné volby
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&sektion=8&manpath=OpenBSD+3.1">tcpdumpu(8)</a>.</li>
<li><b>keep frags:</b>  Toto bylo nahrazeno normalizací, kterou provádí volba
<a href="#normalization">scrub</a>.</li>
<li><b>@n Rules:</b>  PF nepodporuje oznaèování pravidel pomocí <em>@n</em>,
aby byla umístìna na konkrétní místo v seznamu pravidel tak, jako IPF.
Která èísla PF pøiøadil pravidlùm, mù¾ete zjistit pøíkazem <tt>pfctl -sr</tt></li>
</ul>

<p>
<a name="6.3"></a>
<a name="NAT"></a>
<h2>6.3 - NAT</h2>
</p>
<p>
<h5>Poznámka: Packet Filter je filtrovací systém v OpenBSD 3.0 a
pozdìj¹ích.  Pokud hledáte IPF/IPNAT FAQ pro OpenBSD 2.9 a
star¹í, kliknìte <a href="faqipf.html">zde</a>.</h5>
</p>
<a name="nat1.0"></a>
<h3><u>6.3.1 NAT Introduction</u></h3>

<a name="nat1.1"></a>

<p>
Na základì
<a href="http://www.geektools.com/rfc/rfc1631.txt">RFC 1631</a>,
NAT poskytuje jednoduchý zpùsob jak namapovat interní sí» na jedinou
routovatelnou ("reálnou") internetovou adresu. Toto je velmi u¾iteèné,
pokud je¹tì napøíklad nemáte oficiálnì pøiøazené adresy pro ka¾dý stroj
na va¹í interní síti. Pøi nastavování soukromé/interní sítì, mù¾ete
s výhodou pou¾ít rezervovaných adresových blokù (pøiøazených v
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>),
jako jsou:
</p>

<p>
10.0.0.0/8 (10.0.0.0 - 10.255.255.255)<br>
172.16.0.0/12 (172.16.0.0 - 172.31.255.255)<br>
192.168.0.0/16 (192.168.0.0 - 192.168.255.255)<br>
</p>

<p>
Pøedpokládá se, ¾e u¾ivatel u¾ nastavil a nakonfiguroval OpenBSD se dvìma
sí»ovými kartami (jedna pøipojena k Internetu a druhá k lokální síti).
</p>


<br>
<a name="nat1.3"></a>
<b>Nastavení</b>

<p>
Jako pøíklad pou¾ijeme ní¾e popsaný systém. Va¹e uspoøádání
se témìø urèitì bude li¹it, tak¾e buïte velmi opatrní,
pokud odsud cokoliv doslova pøepí¹ete a oèekáváte, ¾e
to bude fungovat tak, jak jste chtìli.
</p>

<ul>
<b>Sí»ové karty: </b>
<ul>
Intel EtherExpress Pro/100 <b>fxp0</b><br>
Connected to the EXTERNAL LAN (or WAN)<br>
<b>IP Address: </b>24.5.0.5<br>
<b>Netmask: </b>255.255.255.0<br>
<br>
Compaq Netelligent 10/100Mb <b>tl0</b><br>
Connected to the INTERNAL LAN<br>
<b>IP Address: </b>192.168.1.1<br>
<b>Netmask: </b>255.255.255.0<br>	
</ul>
<br>
<b>Externí, internetová routa (dodal ji ISP, v tomto pøípadì se jedná o linku modemovou)<br></b>
<ul>
<b>IP Address: </b>24.5.0.5<br>
<b>Netmask: </b>255.255.255.0<br>
<b>Gateway: </b>24.5.0.1<br>
</ul>
<br>
<b>Lokální sí»</b><br>
<ul>
V na¹em vzorovém prostøedí
pou¾ívají poèítaèe na LAN adresové schéma 192.168.1.xxx (kde xxx je jedineèné
èíslo). Na LAN je mnoho rùzných OS, vèetnì Windows 98, Windows NT, OpenBSD a
Linux, ale OS klienta nehraje pøi NAT roli.
V tomto dokumentu a v jeho pøíkladech bude klient na LAN pou¾ívat IP adresu
192.168.1.40.
</ul>
<br>
<b>Diagram nastavení</b>
<ul><pre>
+-----+              +---------+          +----------+
| Hub |--------- tl0 |   NAT   | fxp0 ----| Internet |
+-----+              +---------+          +----------+
| |
| +-- Klient A
+---- Dal¹í klienti 

		      +--------------------------+
		      |          LEGEND          |
		      +--------------------------+
		      |  NIC fxp0 - 24.5.0.5     |
		      |  NIC tl0  - 192.168.1.1  |
		      | Klient A  - 192.168.1.35 |
		      +--------------------------+

</pre></ul>
</ul>

<br>
<a name="nat2.0"></a>
<h3><u>6.3.2 Network Address Translation</u></h3>
<br>

<a name="nat2.1"></a>
<b>Seznámení s NATem</b>

<p>
Ka¾dý uzel Internetu potøebuje unikátní IP adresu. Pøinejmen¹ím
u IPv4 je mno¾ství dostupných IP adres velmi omezené a proto
nejsou zdarma. Hodnì "levných" ISP poskytuje nìco mezi 1 a 30
adresami, a i kdy¾ si organizce s vìt¹ím rozpoètem mohou
dovolit vìt¹í blok, ve vìt¹inì pøípadù z toho, ¾e ka¾dý poèítaè je
na Internetu individuálnì adresovatelný,  plyne málo
výhod a znaèná rizika.
</p>
<p>
Network Address Translation (pøeklad adres), nebo NAT, (také známý jako 
&quot;IP Masquerading&quot;,
pokud pocházíte z linuxového prostøedí) umo¾òuje, aby více poèítaèù
bylo umístìno &quot;za&quot; jednou IP adresou (nebo malým mno¾stvím adres).
Ka¾dý &quot;interní&quot; poèítaè má lokálnì pøidìlenou, neregistrovanou
IP adresu (podle <a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>),
a v¹echny souèasnì vyu¾ívají stejnou externí IP adresu.
</p>
<p>
Zpùsob, jakým NAT pracuje je pøekvapivì jednoduchý. Kdy¾ se klient na LAN chce
spojit se strojem v Internetu, po¹le ven TCP paket se ¾ádostí o spojení. Uvnitø
TCP hlavièky paketu je klientova IP adresa (napø. 192.168.1.40) a po¾adovaná
IP adresa cílového poèítaèe (napø. 123.45.67.89). Stroj, na kterém bì¾í NAT
obdr¾ít tento TCP paket a zmìní klientovu IP adresu v hlavièce z 192.168.1.40
na IP adresu pøipojenou na Internet (napø.  24.5.0.5). Tímto zpùsobem
efektivnì docílíme toho, ¾e cílový poèítaè se domnívá, ¾e vlastní spojení pøichází ze stroje, na kterém bì¾í NAT. Cílový poèítaè (host) posílá dále pakety
týkající se daného spojení na adresu stroje s NATem. Kdy¾ stroj s NATem obdr¾í
paket od host-a, pøelo¾í rychle cílovou IP adresu na adresu klienta a po¹le paket klientovi. Klient nemá ani tu¹ení o tom, co se stalo a Internetové spojení
je pro nìj zcela transparentní.
</p>

<p>
Následující pøíklad ozøejmí dosud nepochopené:
</p>

<ul><pre>
Klient ----------------- tl0 [ NAT ] fxp0 ---------- Internet Host
192.168.1.35 --- 192.168.1.1 [ NAT ] 24.5.0.5 --- 123.45.67.89

Odcházející TCP Packet                  Odcházející TCP Packet
From: 192.168.1.35  &gt;&gt;=== NAT ===&gt;&gt;     From: 24.5.0.5
To: 123.45.67.89                        To: 123.45.67.89

Pøíchozí TCP Packet                     Pøíchozí TCP Packet
From: 123.45.67.89 			From: 123.45.67.89
To:   192.168.1.40  &lt;&lt;=== NAT ===&lt;&lt;     To: 24.5.0.5
</pre></ul>

<br>
<a name="nat2.2"></a>
<b>Proø pou¾ívat NAT?</b>

<p>
Kdy¾ jsem se nastìhoval do nového bytu, byl jsem postaven pøed men¹í problém.
Jak dát pøipojení k Internetu mým spolubydlícím, kdy¾ modemový kabel je
pouze v mé místnosti? Bylo tu nìkolik mo¾ností, které jsem mohl implementovat,
poèínají tím, ¾e ka¾dý z nás obdr¾í vlastní IP adresu, pøes nastavení proxy
serveru a¾ po nastavení NATu. (Nenechejte se mýlit pøíkladem s modemovým kabelem. NAT je dostateènì silný aby zamaskoval velikou LAN se stovkami ba i tisíci
poèítaèù!)
</p>

<p>
Je tu mnoho dùvodù, proè jsem chtìl nastavit NAT. Dùvodem èíslo jedna bylo
u¹etøit peníze. V mém domì jsou dva spolubydlící (ka¾dý s vlastním PC) a já sám
se tøemi poèítaèi, tak¾e potøebujeme pøipojit pìt poèítaèu. Mùj ISP ale povoluje
pouze tøi IP adresy v ka¾dé domácnosti.  To znamená, ¾e zde není dostatek 
IP adres , aby ka¾dému poèítaèi mohl být umo¾nìn internetový pøístup.
</p>

<p>
Pøi pou¾ití NATu bude mít ka¾dý stroj unikátní (interní) IP adresu, ale budou
sdílet jednu IP adresu pro pøístup na Internet. Náklady jdou dolù.
</p>

<br>
<a name="nat2.4"></a>
<b>Setup</b>

<p>
Nejprve budete muset na va¹em OpenBSD systému zapnout PF. Toho jednodu¹¹e
docílíte editací souborù uvedených dále (zmìny udìlejte tak, aby odpovídající
øádky vypadaly jako ty následující):
</p>

<p>
<b>/etc/rc.conf</b> (z tohoto souboru se startují programy pøi bootování)
</p>

<ul><pre>
pf=YES<br>
</pre></ul>

<p>
<b>/etc/sysctl.conf</b>
</p>

<ul><pre>
net.inet.ip.forwarding=1
</pre></ul>

<p>
Po tìchto zmìnách je stroj pøipraven pro konfiguraci NATu.
</p>

<br>
<a name="nat2.5"></a>
<b>Konfigurace</b>

<p>
Prvním krokem je nastavit soubor s pravidly pro PF
(<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5&manpath=OpenBSD+3.1">/etc/pf.conf</a></i>).
Pro úèely tohoto dokumentu dovolíme spojení pøes tento firewall bez omezení.
Soubor by mìl vypadat asi takto:
</p>

<ul><pre>
pass in all
pass out all
</pre></ul>

<p>
Pro dal¹í informace si pøeètìte <a href="#PF">FAQ 6, Packet Filter</a>
</p>

<p>
Soubor s nastavení NATu
(<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nat.conf&sektion=5&manpath=OpenBSD+3.1">/etc/nat.conf</a></i>).
má velmi jednoduchý syntax.
Pro pøípad nastaveného firewallu (viz. vý¹e) bude vypadat takto:
</p>

<ul><pre>
nat on fxp0 from 192.168.1.0/24 to any -&gt; 24.5.0.5
</pre></ul>

<p>
Zde je vysvìtlení pøedcházejícího øádku.
</p>

<ul>
<strong>"nat"</strong>
<p>
Tímto øíkáte, ¾e pøíkaz, který zadáváte, je pravidlo NATu.
</p>
</ul>

<ul>
<strong>"fxp0"</strong>
<p>
Název sí»ového rozhraní pøipojeného na Internet.
</p>
</ul>

<ul>
<b>"192.168.1.0/24"</b>
<p>
IP adresa a sí»ová maska (maska je v CIDR formátu). Dohromady to znamená
"jakákoliv IP adresa o hodnotì od 192.168.1.1 do 192.168.1.254" má být
mapována. 
</p>
</ul>

<ul>
<b>"24.5.0.5"</b>
<p>
Externí IP adresa, na kterou budou mapovány interní IP adresy.
</p>
</ul>

<a name="nat2.6"></a>
<b>Running</b>

<p>
Jakmile je jednou konfigurace kompletní, jsou zde dva zpùsoby jak spustit NAT.
První (a nejlep¹í, pokud je to mo¾né) je rebootovat OpenBSD stroj.
To se provede pøíkazem "<i>reboot</i>".
</p>

<p>
Spu¹tìní NATu z pøíkazové øádky docílíte pøikazy:
</p>

<ul><pre>
# <b>pfctl -N /etc/nat.conf</b>
# <b>pfctl -e</b>
</pre></ul>

<p>
První øádek nahraje soubor pravidel NATu do PF (a zahodí stará pravidla),
druhý zapíná PF. Reboot je opìt nejlep¹í cestou, jak se ujistit,
¾e se po rebootu spustí v¹e tak, jak jste pøedpokládali.
</p>


<p>
<b>Poznámka:</b> budete-li potøebovat updatovat nastavení NATu (v pøípadì, ¾e
editujete soubor, ale nechcete rebootovat) staèí pøedchozí pøíkaz spustit znovu.
Nastavení bude obnoveno s provedenými zmìnami.
</p>

<br>
<a name="nat3.0"></a>
<h3><u>6.3.3 Nat Knowledge Base</u></h3>

<br>
<a name="nat3.1"></a>
<b>Testování NATu</b>

<p>
Chcete-li zjistit, jak NAT právì pracuje, nebo se ujistit o tom, zda nastavení
jsou funkèní, pou¾ijte volbu "-ss". Tato volba vypí¹e seznam v¹ech
souèasných spojení, které NAT zpracovává:
</p>

<ul><pre>
# pfctl -ss
TCP  192.168.1.35:2132 -&gt; 24.5.0.5:53136 -&gt; 65.42.33.245:22       TIME_WAIT:TIME_WAIT
TCP  192.168.1.35:2492 -&gt; 24.5.0.5:55011 -&gt; 65.42.33.245:22       ESTABLISHED:ESTABLISHED
UDP  192.168.1.35:2491 -&gt; 24.5.0.5:60527 -&gt; 24.2.68.33:53       2:1
</pre></ul>

<p>
Vysvìtlení (prvního øádku, ostatní jsou podobné):
</p>
<ul>
<b>"192.168.1.35:2132"</b>
<p>
To vám øíká IP adresu poèítaèe ve vnitøní síti, který pu¾ívá NAT (192.168.1.35).
Za ní následuje port, pou¾itý k vytvoøení spojení (2132).
</p>
</ul>
<ul>
<b>"24.5.0.5:53136"</b>
<p>
To znaèí, ¾e spojení jde do internetu pøes IP adresu 24.5.0.5 a port 53136.
</p>
</ul>
<ul>
<b>"65.42.33.245:22"</b>
<p>
IP adresa a port, na který spojení vede.
</p>
</ul>
<ul>
<b>"TIME_WAIT:TIME_WAIT"</b>
<p>
To ukazuje stav TCP, ve kterém si PF myslí, ¾e spojení je.
</p>
</ul>

<a name="nat3.2"></a>
<b> Omezení NATu pøi FTP</b>

<p>
Existuje nìkolik omezení, která NAT pøiná¹í, z nich¾ nejèastìj¹í
je pøi FTP. FTP mù¾ete pou¾ívat dvìma zpùsoby: pasivním a aktivním.
Pasivní FTP je obecnì pova¾ováno za bezpeènìj¹í.
</p>
<p>
Kdy¾ se pøi aktivním FTP u¾ivatel pøipojí na vzdálený FTP server a
¾ádá informace nebo soubor, FTP klient po¹le serveru náhodné èíslo
portu, na který se FTP server pøipojí a pøenese data. To zpùsobuje
problém pro u¾ivatele, kteøí se sna¾í získat pøístup na FTP server
z vnitøní sítì. Kdy¾ FTP server posílá data, posílá je na náhodný
port na externí sí»ovou kartu. Ma¹ina, která provádí NAT, je pøijme,
ale proto¾e nemá ¾ádné mapování pro neznámý paket a ¾ádné mapování
pro tento port, zahodí paket a nedoruèí ho.
</p>
<p>
Pøi pasivní módu FTP (co¾ je default pro OpenBSD
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&sektion=1">ftp(1)</a>
klienta), klient po¾ádá server, aby vybral náhodný port, na kterém
bude èekat na datové spojení. Server informuje klienta o tom, jaký
port vybral, a klient se na tento port pøipojí, aby pøenesl data.
Bohu¾el to není v¾dy mo¾né nebo ¾ádoucí. ftp(1) standardnì pou¾ívá
tento mód; pou¾ít aktivní FTP mód ho donutíte pou¾itím volby -A neo
vypnutím pasivního módu zadáním pøíkazu
<dl><dt>
<pre>passive off
</pre>
</dt></dl>
na pøíkazovém øádku ftp&gt;.
</p>
<p>
Packet Filter poskytuje je¹tì dal¹í øe¹ení, pøesmìrováním FTP spojení
pøes FTP proxy server, co¾ je proces, který funguje jako "prùvodce"
FTP spojení skrz filtry. FTP proxy pou¾ívíná OpenBSD a PF je
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&sektion=8&manpath=OpenBSD+3.1">ftp-proxy(8)</a>.
Aktivujete ji pøidání nìèeho takového do va¹e souboru <i>/etc/nat.conf</i>:
<ul><pre>
rdr on tl0 from any to any port 21 -&gt; 127.0.0.1 port 8081
</pre></ul>
Krátké vysvìtlení  této øádky je: "Provoz na interním rozhraní je pøesmìrován
na proxy server bì¾ící na tomto stroji, která poslouchá na portu 8081".
</p>
<p>
Doufejme, ¾e je jasné, ¾e proxy server musí být spu¹tìn a bì¾í na tomto
OpenBSD stroji. To udìláme pøidáním následujícího øádku do
<i>/etc/inetd.conf</i>:
<ul><pre>
127.0.0.1:8081 stream tcp nowait root /usr/libexec/ftp-proxy ftp-proxy
</pre></ul>
a buï restartováním systému nebo poslání signálu 'HUP'
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&sektion=8">inetd(8)</a>.
Jedním ze zpùsobù, jak poslat signál 'HUP' je pøíkaz:
<ul><pre>
kill -HUP `cat /var/run/inetd.pid`
</pre></ul>
V¹imnìte si, ¾e ftp-proxy poslouchá na portu 8081, stejném jako port, na který
vý¹e uvedený pøíkaz rdr posílá FTP spojení. Výbìr portu 8081 je náhodný,
i kdy¾ 8081 je dobrá volba, proto¾e není definován pro ¾ádnou jinou aplikaci.
</p>
<br>
<a name="nat3.3"></a>
<b>Redirecting Traffic</b>

<p>
Stane se, ¾e potøebujete pøesmìrovat pøíchozí nebo odchozí spojení pro urèitý
protokol nebo port na nìjaký stroj za filtrovacím systémem.
Pøíkladem tohoto je mù¾e být poèítaè ve vnitøní síti, na kterém bì¾í web server
pøístupný ze svìta, (nebo samozøejmì na¹e známá ftp-proxy(8)).
Pøíchozí spojení na platnou Internetovu IP adresu v¹ak budou
bez odezvy, proto¾e na stroji s NATem nebì¾í web server. Pro tento úèel
pou¾íváme direktivu NATu 'rdr' v souboru s pravidly, která dává instrukce pro
pøesmìrování urèitého spojení.
</p>

<p>
V na¹em pøípadì pøedpokládejme, ¾e web server se nachází na LAN s IP adresou
192.168.1.80. Soubor s pravidly pro NAT potøebuje novou direktivu, která se
o toto postará. Pøidejte øádku podobnou této do <i>/etc/nat.conf</i>:
</p>

<ul><pre>
rdr on fxp0 from any to any port 80 -&gt; 192.168.1.80 port 80
</pre></ul>

<p>
Vysvìtlení ka¾dé èásti této øádky:
</p>
<ul>
<b>"rdr"</b>
<p>
Pøíkaz, který dáváte NATu. Øíká NATu, ¾e tato polo¾ka je pøíkaz
k pøesmìrování spojení.
</p>
</ul>

<ul>
<b>"on fxp0"</b>
<p>
Externí sí»ové rozhraní pøipojené k Internetu.
</p>
</ul>

<ul>
<b>"from any to any"</b>
<p>
Toto øíká, kterou adresu pøesmìrovat (pøicházející odkudkoliv
na fxp0, jak bylo naznaèeno vý¹e, na jakémkoliv cílové IP)
</p>
</ul>

<ul>
<b>"port 80"</b>
<p>
Pøíchozí port (80), který má být pøesmìrován. Nemusíte pou¾ít èíslo "80",
mù¾ete také pou¾ít "port www" pro pøesmìrování portu 80. Pokud
chcete pou¾ít jméno namísto èísla, musí odpovídající název a èíslo existovat
v souboru <i>/etc/services</i>.
</p>
</ul>
<ul>
<b>"192.168.1.80 port 80"</b>
<p>
IP adresa stroje v LAN, na který se budou pøesmìrovávat pakety.
V¹imnìte si, ¾e cílový port NEMUSÍ odpovídat pøíchozímu portu.
Tak¾e tøeba následující pøíklad je platný a dokonce potenciálnì u¾iteèný:
<pre>
rdr on fxp0 from any to any port 8080 -&gt; 192.168.1.35 port 80
</pre>
Tento øádek by smìroval pøíchozí spojení na port 8080 na webserver
bì¾ící na stroji ve vnitøní síti na "standardním" portu 80.
</p>
</ul>
<p>
Po pøidání pravidla znovu nahrajte pravidla NATu a pøesmìrování zaèkne
okam¾itì fungovat.
</p>
<p>
<b>Negace</b>
</p>
<p>
Nìkdy potøebujete udìlat vyjímkou z pravidla NATu nebo pøesmìrování.
Tady je pøíklad. AOL Instant Messenger známý tím, ¾e se proplí¾í
skrz firewally ka¾dým dostupným portem. Mo¾ná zjistíte,
¾e ftp-proxy interferuje s AIMem, kdy¾ se rozhodne projít ven
na port 21. Pokud vám to vadí (hodnì lidí
tráví nezanedbatelnì èasu pokusy o zablokování AIMu!),
mù¾ete se rozhodnout vyøadit IP adresy AIM serverù ze spojení
pøesmìrovávaných na¹ím pravidlem pro ftp-proxy. Udìláte to
následujícím øádkem:
<ul><pre>
rdr on tl0 from any to ! 64.12.163.199 port 21 -&gt; 127.0.0.1 port 8081
</pre></ul>
Interpretace: Pøesmìruj spojení pøicházející na na tl0 smìøující
na port 21, ale NE na 64.12.163.199 (u¾ivatelé serverù AIMu s tím
mìli potí¾e) na localhost, port 8081 (kde, doufejme, èeká ftp-proxy).
No a teï byste si mìli uvìdomit, ¾e AIM serverù je hodnì, tak¾e si
patrnì budete muset pohrát s tìmito IP adresami (64.12.0.0/16 by
mohlo být produktivnìj¹í, i kdy¾ pravdìpodobnì zasáhne i nìkteré
non-AOL servery).
</p>

<br>
<a name="nat3.4"></a>
<b>NAT versus Proxy</b>

<p>
Rozdíl mezi NATem a aplikaènì zalo¾enou proxy je ten, ¾e proxy software jedná
jako prostøedník mezi Internetem a strojem pøipojeným na LAN. To je v poøádku,
pøesto ka¾dá aplikace, kterou chcete spustit MUSÍ být schopna pou¾ít proxy
server. Ne v¹echny aplikace to doká¾í (obzvlá¹» hry). Navíc neexistují proxy
server aplikace pro v¹echny Internetové slu¾by. NAT prùhlednì mapuje va¹i 
iterní sí», aby mohla být spojena s Internetem. Jediná výhoda, proè pou¾ívat
proxy software narozdíl od NATu je, ¾e proxy software by mìl být bezpeèný a mù¾eprovádìt filtrování na základì obsahu paketù, uchrání tak vá¹ stroj s Windows
od macro viru, mù¾e ochránit od buffer overflowu software klienta a více.
Pou¾ívání tìchto filtrù je vìt¹inou nároèný úkol.
</p>

<a name="nat4.0"></a>
<b>6.3.4 Links and Cross-References</b>

<p>
OpenBSD files:
<ul>
<li>/etc/nat.conf - pravidla pro NAT
<li>/etc/rc.conf - nutné upravit pro spu¹tìní NATu a PF pøi bootu
<li>/etc/sysctl.conf - nutné editovat pro IP forwarding
</ul>
</p>

<p>
NAT Internet Links:
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nat.conf&sektion=5&manpath=OpenBSD+3.1">manuálová stránka nat.conf</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&sektion=8&manpath=OpenBSD+3.1">manuálová stránka pfctl</a>
<li><a href="http://www.geektools.com/rfc/rfc1631.txt">http://www.geektools.com/rfc/rfc1631.txt</a>
</ul>
<p>



<br>

<p>
<a name= "DHCP"></a>
<a name= "6.4"></a>
<h2>6.4 - DHCP</h2>
</p>

<h3>6.4.1 DHCP Klient</h3>
<p>Pro pou¾ívání DHCP klienta 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dhclient&sektion=8">dhclient(8)</a>
 dodávaného spolu s OpenBSD, zeditujte soubor /etc/hostname.xl0 
(za pøedpokladu, ¾e va¹e hlavní ethernetové rozhraní je xl0. Mù¾ete mít jiné 
rozhraní, napø. ep0 nebo fxp0 nebo jiné!) Jediné slovo, které musí tento soubor
po editaci obsahovat je 'dhcp'.
<pre>
# <strong>echo dhcp  &gt;/etc/hostname.xl0</strong>
</pre>
Tento pøíkaz zpùsobí automatické nastartovaní DHCP klienta pøi bootování.
OpenBSD bude od DHCP serveru po¾adovat informaci o své IP adrese, defaultním 
routeru a DNS serverech.
<p>
Chcete-li spou¹tìt DHCP klienta z pøíkazové øádky, ujistìte se, ¾e existuje
soubor /etc/dhclient.conf a potom vyzkou¹ejte:
<PRE>
# <strong>dhclient fxp0</strong>
</pre>
Kde fxp0 je rozhraní, na kterém chcete konfigurovat pomocí DHCP.
<p>Bez ohledu na to, jak spustíte DHCP klienta, mù¾ete zeditovat soubor 
/etc/dhclient.conf , aby napø. nedo¹lo ke zmìnì v ji¾ nakonfigurovaném DNS na základì
odezvy DHCP serveru. V tomto pøípadì staèí kdy¾ odkomentujete øádku zaèínající
slovem 'request' (tato øádka se nachází v pùvodním souboru), tak docílíte zmìny
v chování DHCP klienta.
<pre>
request subnet-mask, broadcast-address, time-offset, routers,
      domain-name, domain-name-servers, host-name, lpr-servers, ntp-servers;
</pre>
a potom <b>odstraòte</b> slovo domain-name-servers. Samozøejmì mù¾ete chtít
odstranit i jiná nastavení jako napø. hostname.
<p>
<h3>6.4.2 DHCP Server</h3>

Pokud chcete pou¾ívat OpenBSD jako DHCP server 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=dhcpd&sektion=8">dhcpd(8)</a>,
zeditujte /etc/rc.conf.  Nastavte v nìm volbu  dhcpd_flags="-q"  namísto pùvodní dhcpd_flags=NO.
Nyní uveïte rozhraní, na kterých chcete aby <b>poslouchal</b> DHCP server, v
souboru /etc/dhcpd.interfaces.
<pre>
# <strong>echo xl1 xl2 xl3  &gt;/etc/dhcpd.interfaces</strong>
</pre>
Pak zeditujte /etc/dhcpd.conf.
Volby uvedené v tomto souboru jsou dostateènì zøejmé.
<pre>
        option  domain-name "xyz.mil";
        option  domain-name-servers 192.168.1.3, 192.168.1.5;

        subnet 192.168.1.0 netmask 255.255.255.0 {
                option routers 192.168.1.1;

                range 192.168.1.32 192.168.1.127;
        }
</pre>
<p>
Takovéto nastavení øíká va¹im DHCP klientùm, ¾e doména, kterou mají pøidávat
k DNS dotazùm je xyz.mil (tedy pokud u¾ivatel napí¹e 'telnet joe' , pak ve skuteènosti se bude spojovat se strojem joe.xyz.mil).  Dále odká¾ete klienta, aby
pou¾íval DNS servery 192.168.1.3 a 192.168.1.5.  Poèítaèùm na stejné síti jako
je ethernetové rozhraní DHCP serveru, je¾ je v rozsahu 192.168.1.0/24 , bude
DHCP server pøiøazovat IP adresy mezi 192.168.1.32 a 192.168.1.127.  Defaultní
router klientù bude nastaven na 192.168.1.1.
<p>
Pokud chcete spou¹tìt dhcpd z pøíkazové øádky, po editaci /etc/dhcpd.conf vyzkou¹ejte:
<PRE>
# <strong>dhcpd -q fxp0</strong>
</PRE>
Kde fxp0 je rozhraní, na kterém chcete nastartovat DHCP server. Volba -q øíká
dhcpd; aby vypisoval co nejménì informací, v opaèném pøípadì je toti¾
velmi "ukecaný".
<p>
Pou¾íváte-li DHCP server pro stroje s Windows, mù¾ete dát klientovi adresu
'WINS' serveru. Docílíte toho tímto øádkem v /etc/dhcpd.conf:
<pre>
option  netbios-name-servers  192.168.92.55;
</pre>
(kde 192.168.92.55 je IP va¹eho Windows nebo Samba serveru. )
Více voleb pro dhcp klienty se nachází zde: 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dhcp-options&sektion=5">dhcp-options(5)</a> .
<p>
<a name= "PPP"></a>
<a name= "6.5"></a>
<h2>6.5 - PPP </h2>
</p>

Point-to-Point Protokol je tím protolem, který se dnes pou¾ívá pro spojení s
modemem va¹eho ISP. OpenBSD má dva zpùsoby jak toto spojení nakonfigurovat.

<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppd&sektion=8">pppd(8)</a> - Jedná se o ppp démona zaèlenìného do jádra systému .
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&sektion=8">ppp(8)</a> - Tento ppp démon pracuje jako u¾ivatelský proces (nesystémový).
</ul>

<p>
První, který popí¹eme bude nesystémový ppp démon. Pøedtím ne¾ zaènete s konfigurací je dobré zjistit si nìkteré údaje od va¹eho ISP. Jedná se pøedev¹ím o:
</p>

<ul>
<li>Telefonní (dialup) èíslo va¹eho ISP
<li>vá¹ nameserver
<li>va¹e u¾ivatelské jméno a heslo
<li>vá¹ router
</ul>

<p>
Nìkteré z tìchto informací nutnì nepotøebujete, bez jiných se zase neobejdete.
Nesystémový ppp démon pou¾ívá <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/ppp/ppp.conf.sample">/etc/ppp/ppp.conf</a> jako svùj konfiguraèní soubor.
V adresáøi <b>/etc/ppp</b> se obecnì nachází øada souborù, které nabízejí
rùzné nastavení pro rùzné situace. Mìli byste si je prohlédnout.
</p>

<p>
Také se ujistìte, v pøípadì, ¾e pou¾íváte jádro GENERIC, ¾e máte následující
øádku ve va¹em konfiguraèním souboru:
</p>

<ul><pre><strong>
pseudo-device   tun             2
</strong></pre></ul>


<h3>Úvodní nastavení - pro PPP(8)</h3>

<p>
Úvodní nastavení nesystémového démona se sestává z editace souboru <b>/etc/ppp/ppp.conf</b>. Tento soubor defaultnì neexistuje, ale je tu soubor <b>/etc/ppp/ppp.conf.sample</b> , který mù¾ete jednodu¹¹e zeditovat a vytvoøit tak vlastní <b>ppp.conf</b> . Zde zaèneme s nejjednodu¹¹ím a patrnì také nejèastìj¹ím nastavením. Zde je soubor <b>ppp.conf</b>, díky kterému se ppp spojí s va¹ím ISP a nastaví defaultní routy a nameserver. S tímto souborem potøebujete vìdìt jen informaci
o telefonním èísle va¹eho ISP, u¾ivatelském jménu a heslu.
</p>

<ul>
<pre>
default:
set log Phase Chat LCP IPCP CCP tun command
set device /dev/cua01
set speed 115200
set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \"\" AT OK-AT-OK ATE1Q0 OK\\dATDT\\T TIMEOUT 40 CONNECT"
</pre>
</ul>

<p>
Sekce uvedená slovem <b>default:</b> bude vykonána pøi ka¾dém spu¹tìní. Zde
nastavujeme v¹echny kritické informace. Slovem  &quot;set log&quot; nastavujeme
záznamovou úroveò. Je mo¾né to zmìnit, více manuálová stránka
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&sektion=8">ppp(8)</a>. Sériový port
se nastavuje pøíkazem &quot;set device&quot;. Toto je zaøízení, na kterém se
nachází modem. V na¹em  pøípadì je modem na portu 2. Proto com port 1 by byl
/dev/cua00. Slovem  &quot;set speed&quot; nastavujeme rychlost dialup spojení
a pomocí &quot;set dial&quot; nastavujeme parametry dialup-u. Pomocí nich
mù¾eme zmìnit ná¹ timeout atd. 
</p>

<p>
Nyní mù¾eme pokraèovat nastavením informací o na¹em ISP. Provedeme to pøidáním
nové sekce za sekci <b>default:</b> . Tato sekce se mù¾e jmenovat jakkoliv,
nejjednodu¹¹í je pou¾ít jméno va¹eho ISP. My pou¾ijeme oznaèení <b>myisp:</b> .
Následuje krátké a jednoduché nastavení, které poskytuje to nejnutnìj¹í pro
na¹e spojení.
<p>

<ul>
<pre>
myisp:
set phone 1234567
set login "ABORT NO\\sCARRIER TIMEOUT 5 ogin:--ogin: ppp word: ppp"
set timeout 120
set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.0 0.0.0.0
add default HISADDR
enable dns
</pre>
</ul>

<p>
Zde jsme nastavili  &quot;set phone&quot; telefonní èíslo na¹eho ISP,  &quot;set login&quot; volby pro pøihlá¹ení (timeout nastavený na 5 znamená, ¾e pøeru¹íme
pokus o pøihlá¹ení po pìti sekundách není-li na lince signál. Jinak budeme
èekat na zaslání na poslání øetìzce &quot;login:&quot; a pak po¹leme na¹e u¾ivatelské jméno a heslo. U nás to bude username=ppp a password=ppp. Tyto hodnoty
si zmìnte na va¹e vlastní. &quot;set timeout&quot; nastavuje timeout pro celý
pøihla¹ovací proces na 120 sekund. &quot;set ifaddr&quot; je ponìkud trikové.
Vysvìtlení je zde:
</p>

<ul><pre>
set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.0 0.0.0.0
</pre></ul>

<p>
V øádku nahoøe nastavujeme na¹i IP adresu ve formátu  &quot;<b>set ifaddr [myaddr[/nn] [hisaddr[/nn] [netmask
[triggeraddr]]]]</b>&quot;. Tedy první IP adresa na øádce specifikuje èíslo, které chceme obdr¾et od ISP jako na¹i IP adresu. Pokud máte statickou IP adresu,
nastavte ji zde. U nás pou¾ijeme /0 , co¾ øíká, ¾e ¾ádný z bitù ip adresy nemusí odpovídat a proto celá adresa mù¾e být nahrazena jinou (dynamicky pøiøazenou).
Druhá IP adresa je adresa, kterou oèekáváme jako IP adresu na¹eho ISP. Pokud
ji znáte, mù¾ete ji specifikovat. My opìt nevíme, co máme oèekávat, proto pou¾ijeme opìt /0 . Tøetí èíslo je na¹e sí»ová maska, zde nastavena na 255.255.255.0 . Pokud specifikujeme triggeraddr, je pou¾ita namísto myaddr v pùvodní IPCP komunikaci. Pøesto, pouze adresa v rozsahu myaddr bude akceptována. Toto je u¾iteèné
pøi komunikaci s nìkterými implementacemi PPP, které nedovolují pøiøadit IP adresu, pokud peer ¾ádá ``0.0.0.0''.
</p>

<p>
Dal¹í volba  &quot;add default HISADDR&quot; nastavuje defaultní routu na IP adresu providera. Dobré je, ¾e pokud se zmìní IP adresa providera za chodu, bude
va¹e routa automaticky upravena. Volbou  &quot;enable dns&quot; øíkáme na¹emu
ISP, aby nám sdìlil adresu nameserveru. Nepøidávejte tuto volbu, pokud u vás
bì¾í lokální DNS, proto¾e ppp lehce znemo¾ní její pou¾ívání tím, ¾e pøidá
nìkolik øádek do souboru /etc/resolv.conf.
</p>

<h3>Pou¾ívání PPP(8)</h3>

<p>
Nyní máme základní nastavení v souboru <b>ppp.conf</b> pøipravené a mù¾eme
zaèít zou¹et spojení s na¹ím ISP. Obvyklé formy pøikazu jsou:
</p>

<ul>
<li><b>ppp -auto myisp</b> - Spustí ppp, nastaví rozhraní a spojí se s na¹im isp, poté pøechází na pozadí.
<li><b>ppp -ddial myisp</b> - Podobné jako -auto, ale pokud konekce je zru¹ena, pokusí se znovu o spojení.
</ul>

<p>
Spu¹tìní <b>/usr/sbin/ppp</b> bez voleb vás zavede do interaktivního módu. V nìm mù¾ete komunikovat pøímo s modemem, velmi vhodné pøi ladìní problémù ve va¹em  <b>ppp.conf</b> .
</p>

<h3>ppp(8) extra</h3>

<p>
V nìkterých situacích mù¾ete chtít spustit dodateènì nìjaké pøíkazy, kdy¾ je
vytvoøeno nebo naopak zru¹eno spojení. Jsou zde dva soubory, které mù¾ete vytvoøit pro tyto situace. <b>/etc/ppp/ppp.linkup</b> a <b>/etc/ppp/ppp.linkdown</b>.
Pøíklad nastavení je zde:
</p>

<ul>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/ppp/ppp.linkup.sample">ppp.linkup</a>
<li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/ppp/ppp.linkdown.sample">ppp.linkdown</a>
</ul>

<p>
Dal¹í informace: 
<a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/userppp.html">FreeBSD Handbook èást User PPP</a>.
</p>

<p>
<a name= "Tuning"></a>
<a name= "6.6"></a>
<h2>6.6 - Zlep¹ování výkonu sítì</h2>

<H3>6.6.1 - Jak pøinutit jádro, aby dovolovalo vìt¹í poèet pokusù a del¹í timeout pro TCP spojení?</h3>
Normálnì byste to mìl vyu¾ít v pøípadì smìrovacích nebo spojovacích problémù.
Samozøejmì, nejefektivnìj¹í je, kdy¾ obì strany spojení pou¾ívají podobné hodnoty. 
<p>
Pou¾ijte <tt>sysctl</tt> a zvìt¹ete hodnoty promìnných:
<pre>
net.inet.tcp.keepinittime
net.inet.tcp.keepidle
net.inet.tcp.keepintvl
</pre>
Díky sysctl -a mù¾ete vidìt souèasné hodnoty tìchto a mnoha dal¹ích parametrù.
Zmìnu provedete pomocí <tt>sysctl -w</tt> jako napø. <tt>sysctl -w
net.inet.tcp.keepidle=28800</tt>.
<h3>6.6.2 - Jak mohu umo¾nit directed broadcast?</h3>
Normálnì to nepotøebujete dìlat. Directed broadcast umo¾òuje komukoliv poslat 
pakety na veøejnou adresu va¹í pøipojené sítì, pokud pou¾íváte OpenBSD jako router.<p>
V nìkterých pøípadech uzavøených sítí mù¾e být directed broadcast u¾iteèný,
zejména pøi pou¾ívání starých iplementací NetBIOS protokolu. Pou¾ijte 
<Tt>sysctl -w net.inet.ip.directed-broadcast=1</tt> pro tuto vlastnost. Rovnou si ale
pøeètìte také èlánek o <a href="http://www.netscan.org">smurf útocích</a>,
pokud chcete vìdìt, proè je tato vlastnost defaultnì vypnutá.
<H3>6.6.3 - Nechci, aby kernel dynamicky alokoval urèité porty</h3>
Na tohle tu také máme jedno sysctl. 
V <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">sysctl(8)</a> se pí¹e:
<PRE>
Nastavení rezervovaných TCP portù, které by nemìly být dynamicky pøidìlovány jádrem. Seznam èísel tìchto portù mù¾e být oddìlen èárkami a/nebo mezerami.

 #  <strong>sysctl -w  net.inet.tcp.baddynamic=749,750,751,760,761,871</strong>

Je také mo¾né odstranit nebo pøidat èásti souèasného seznamu.

 #  <strong>sysctl -w net.inet.tcp.baddynamic=+748</strong>
 #  <strong>sysctl -w net.inet.tcp.baddynamic=-871</strong>
</pre>

<a name="NFS"></a>
<a name="6.7"></a>
<h2>6.7 - Jednoduché pou¾ití NFS</h2>
</p>

<p> NFS, neboli Network File System, se pou¾ívá pro sdílení souborových systémù na síti. Dobré je, kdy¾ pøed pokusem o nastavení NFS serverù si pøeètete pár manuálových stránek:

<p>

<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nfsd&sektion=8">nfsd(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mountd&sektion=8">mountd(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=exports&sektion=5">exports(5)</a>
</ul>

<p>
Tato sekce vás provede základními kroky pro jednoduché nastavení NFS. 
V pøíkladì pøedpokládejme server na LAN, s klienty pøistupujícími na NFS 
na LAN. Nemluvíme zde o zabezpeèení NFS. Pøedpokládáme, ¾e jste ji¾ nastavili
filtrování paketù, nebo jinou firewallovou ochranu pro odepøení pøístupu zvenèí.
Pokud dovolujete vnìj¹í pøístup na vá¹ NFS server a máte na nìm nìjaká citlivá 
data, dùraznì doporuèujeme, abyste zprovoznil <a href="faq13.html">IPsec</a>.
 V opaèném pøípadì mohou cizí lidé potenciálnì vidìt va¹e  NFS spojení. Mù¾e 
to vést i k nìkterým útokùm. Pokud je IPsec protokol správnì nastaven, mù¾e 
vás od tohoto typu útokù ochránit. 
<p>
Jiná podstatná bezpeènostní poznámka. Nepøidávejte filesystém do /etc/exports
bez urèitého seznamu povolených strojù. Bez seznamu strojù, které mohou pøipojit
daný adesáø, mù¾e kdokoliv, kdo má spojení s va¹ím poèítaèem, pøipojit adresáøe,
které pøes NFS exportujete.
</p>

<p>
Nastavení obsahuje server s ip <b>10.0.0.1</b>, který slou¾í jako NFS server
pouze klientùm na této síti. První krok pøi nastavení NFS je nastavit soubor 
<i>/etc/exports</i> . Tento soubor obsahuje seznam filesystému, které chcete
zpøístupnit pøes NFS a definuje, komu je mù¾ete zpøístupnit. 
V <i>/etc/exports</i> mù¾ete pou¾ít spoustu voleb a nejlépe je pøeèíst si
manuálovou stránku 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=exports&sektion=5">exports(5)</a>.
My máme <i>/etc/exports</i> takovýto:
</p>

<ul><pre>
#
# NFS exports Database
# See exports(5) for more information.  Be very careful, misconfiguration
# of this file can result in your filesystems being readable by the world.
/work -alldirs -ro -network 10.0.0 -mask 255.255.255.0
</pre></ul>

<p>
To znamená, ¾e lokální filesystém  <b>/work</b> bude zpøístupnìn pøes NFS.
<b>-alldirs</b> øíká, ¾e klienti budou moci pøipojit kterýkoliv podadresáø
adresáøe <b>/work</b>. <b>-ro</b> øíká, ¾e pøipojit filesystém bude mo¾né jen
pro ètení. Poslední dva argumenty øíkají, ¾e pouze klienti v rozsahu sítì 10.0.0.0 s maskou 255.255.255.0 budu oprávnìni pøipojit filesystém. To je dùle¾ité
zejména pro sítì, které jsou pøistupné zvenku.
</p>

<p> Máte-li nastaven <i>/etc/exports</i>, mù¾ete pokraèovat v nastavení 
NFS serveru. Nejprve se ujistìte, ¾e máte zkompilované jádro s volbami NFSSERVER a NFSCLIENT (jádra GENERIC jsou ok).
Dále nastavte v <i>/etc/rc.conf</i> <strong>nfs_server=YES</strong> . Tím spustíte nfsd(8) i mountd(8) po rebootování.
Pro zaèátek mù¾ete spustit démony ruènì. Musíte je spustit jako root a potøebujete se ujistit, ¾e vám na systému bì¾í
portmap(8). Pøíklad jak spustit nfsd(8),
který pracuje jak na TCP tak na UDP ve 4 instancích. Mìli byste nastavit maximální poèet klientù
se ¾ádostí o spojení na slu¾bu NFS.

<p>

<ul><pre>
# <strong>/sbin/nfsd -tun 4</strong>
</pre></ul>

<p>
Nestaèí pustit jen nfsd(8) server, musíte spustit i mountd(8). Jedná se o démona,
který vlastnì obsluhuje ¾ádosti o NFS spojení. Ujistìte se. ¾e existuje prázdný
soubor mountdtab, a spus»te daemona: 
<p>

<ul><pre>
# <strong>echo -n &gt;/var/db/mountdtab</strong>
# <strong>/sbin/mountd</strong>
</pre></ul>

<p>
Pokud udìláte zmìny v /etc/exports poté co u¾ NFS bì¾í, musíte na to mountd
upozornit! Takhle:

<ul><pre>
# <strong>kill -HUP `cat /var/run/mountd.pid`</strong>
</pre></ul>

<p>

<h3>Kontrola stavu NFS</h3>

<p>
Nyní se mù¾ete podívat a ujistit se, ¾e démoni bì¾í a jsou registrováni s RPC.
Pou¾ijte procinfo(8).
<p>

<ul><pre>
$ <strong>rpcinfo -p 10.0.0.1</strong>
   program vers proto   port
    100000    2   tcp    111  portmapper
    100000    2   udp    111  portmapper
    100005    1   udp    633  mountd
    100005    3   udp    633  mountd
    100005    1   tcp    916  mountd
    100005    3   tcp    916  mountd
    100003    2   udp   2049  nfs
    100003    3   udp   2049  nfs
    100003    2   tcp   2049  nfs
    100003    3   tcp   2049  nfs
</pre></ul>

<p>V normálním provozu máte k dispozici dal¹í utility, které vám dovolují 
sledovat co se dìje na NFS. Jedna z nich je 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=showmount&sektion=8">showmount(8)</a>,
která umo¾òuje sledovat co je právì pøipojeno a kdo to pøipojil. Dále také 
nfsstat(8) s podrobnìj¹ím výpisem. Pou¾ití pøíkazu showmount(8): zkuste 
<b>/usr/bin/showmount -a host</b>. Napøíklad:

<p>

<ul><pre>
$ <strong>/usr/bin/showmount -a 10.0.0.1</strong>
All mount points on 10.0.0.1:
10.0.0.37:/work
</pre></ul>

<h3>Pøipojení NFS filesystému</h3>

<p>
NFS filesystém by mìl být pøipojen pomocí pøíkazu mount(8), nebo konkrétnìji 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mount_nfs&sektion=8">mount_nfs(8)</a>.
Pro pøipojení filesystému /work na stroji 10.0.0.1 na lokální filesystém /mnt,
udìlejte toto: (pozn. nepotøebujete pou¾ívat ip adresy, mount resolvuje jména):
<p>

<ul><pre>
# <strong>mount -t nfs 10.0.0.1:/work /mnt</strong>
</pre></ul>

<p>
Pøipojení systému pøi bootu:
pøidejte do <i>/etc/fstab</i>:
<p>

<ul><pre>
10.0.0.1:/work /mnt nfs rw 0 0
</pre></ul>

<p>
Je dùle¾ité pou¾ít <tt>0 0</tt> na konci øádky, jinak bude vá¹ poèítaè pou¹tìt fsck na NFS filesystém pøi startu!!!!
Jiné standardní security volby jsou noexec, nodev, a nosuid ta poslední by mìla
být pou¾ita kde jen to je mo¾né. Napø.:
<p>

<ul><pre>
10.0.0.1:/work /mnt nfs rw,nodev,nosuid 0 0
</pre></ul>

<p>
Diky tomu nebudou moci ¾ádné suid bit binárky na NFS serveru podlomit bezpeènost na NFS klientovi. Pokud nepøipojujete programy, které by mìly bì¾et na klientovi, pøidejte noexec.

<p>
<a name="DNS"></a>
<a name="6.8"></a>
<h2>6.8 - Domain Name Service  - DNS, BIND, a named</h2>
</p>

<h3>6.8.1 Co je DNS?</h3>

<p>
Domain Name Service je sí»ová slu¾ba zprostøedkující sí»ovým doménám na bázi IP
pøeklad sí»ových IP adres na jména a jména strojù na sí»ové adresy. va¹e instalace OpenBSD je nastavena defaultnì jako DNS klient, ne jako DNS server. Tj. va¹e instalace OpenBSD mù¾e dávat DNS serverùm DNS dotazy, ale nemù¾e sama odpovídat
na DNS dotazy , pokud není speciálnì nastavena. Tu je info jak na to.</p>

<p>
Máte-li OpenBSD pøipojené k Internetu pøes va¹eho ISP, mù¾ete spustit 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nslookup&sektion=8">nslookup(8)</a>,
program, který provádí DNS dotazy:
</p>

<ul><pre>
$ <strong>nslookup www.openbsd.org</strong>
Server:  ns4.us.prserv.net
Address:  165.87.201.244

Non-authoritative answer:
Name:    www.openbsd.org
Address:  129.128.5.191
</pre></ul>

<p>
<b>165.87.201.244</b> je nameserver , který odpovìdìl, je to nameserver, který
mùj ISP doporuèuje, abych ho pou¾íval v rámci svého úètu a toto èíslo je
ulo¾eno v 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolv.conf&sektion=5">/etc/resolv.conf</a>.
Odpovìï ale nebyla autoritativní. Pro autoritativní odpovìï na DNS dotaz
zjistíme nejprve, který DNS server je autoritativní pro doménu 
<i>openbsd.org</i> a zeptáme se ho pak na adresu <i>www.openbsd.org</i>:
</p>

<ul><pre>
# Identify the name servers for openbsd.org
# with the help of my ISP's name server.
$ <strong>nslookup -type=NS openbsd.org</strong>
Server:  ns4.us.prserv.net
Address:  165.87.201.244

Non-authoritative answer:
openbsd.org     nameserver = cvs.openbsd.org
openbsd.org     nameserver = gandalf.sigmasoft.com
openbsd.org     nameserver = cs.colorado.edu
openbsd.org     nameserver = ns.appli.se
openbsd.org     nameserver = zeus.theos.com

Authoritative answers can be found from:
cvs.openbsd.org internet address = 199.185.137.3
gandalf.sigmasoft.com   internet address = 198.144.202.98
cs.colorado.edu internet address = 128.138.243.151
ns.appli.se     internet address = 194.198.196.230
zeus.theos.com  internet address = 199.185.137.1

# Use the info gained to query for an authoritative
# resolution: query the authoritative zeus.theos.com.
$ <strong>nslookup www.openbsd.org zeus.theos.com</strong>
Server:  zeus.theos.com
Address:  199.185.137.1

Name:    www.openbsd.org
Address:  129.128.5.191
</pre></ul>

<p>
<i>zeus.theos.com</i> je , jak se dá pøedpokládat, server s OpenBSD, který
je správnì nastaven jako DNS server pro doménu <i>openbsd.org</i>.
</p>

<a name="DNS.1.1"></a>
<a name="6.8.1.1"></a>
<h3>6.8.1.1 Kde se dozvím v¹echno o DNS a jeho iplementaci pod OpenBSD?</h3>

<ul>
<li>Jednak RFC <a href="http://www.faqs.org/rfcs/rfc1033.html">1033</a>,
 <a href="http://www.faqs.org/rfcs/rfc1034.html">1034</a>, 
a <a href="http://www.faqs.org/rfcs/rfc1035.html">1035</a> s více informacemi o DNS.</li>
<li>Kniha od O'Reilly Associates <i><a href="http://www.openbsd.org/books.html#6">DNS a BIND</a> </i>.</li>
<li>Dále pak <a href="http://www.openbsd.org/cgi-bin/man.cgi">OpenBSD Manual</a> speciálnì manuálové stránky </li>
  <ul>
  <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1">dig(1)</a>
  <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nslookup&sektion=8">nslookup(8)</a>
  <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gethostbyname&sektion=3">gethostbyname(3)</a>
  <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=named&sektion=8">named(8)</a>
  <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolver&sektion=3">resolver(3)</a>
  <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolver&sektion=5">resolver(5)</a>
  </ul>
</ul>

<p>
Pøíkaz <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1">dig(1)</a>
je u¾iteèný tím, ¾e vrací informaci o doménì ve stejném formátu, jaký je nutný
pro konfiguraèní soubory BINDu. Mù¾ete pou¾ít
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1">dig(1)</a>
pro prozkoumání nameserverù, které pracují správnì, abyste mohli porovnat jejich
nastavení s va¹ím.
</p>

<h3>6.8.2 Potøebuji, aby mùj stroj slou¾il jako nameserver?</h3>

<p>
Pokud si nejste jisti, zda by mìl vá¹ stroj slou¾it jako DNS server,
nekonfigurujte ho tak. Instalace OpenBSD defaultnì neaktivuje stroj jako domain
name server, aèkoliv v¹echny potøebné soubory jsou instalovány. Pro vìt¹inu
poèítaèù je dostaèující soubor
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&sektion=5">/etc/hosts</a>
 s názvy lokálních strojù a jejich IP adresami a soubor
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=resolv.conf&sektion=5">/etc/resolv.conf</a>,
který udává adresy DNS serverù, pou¾ívaných vámi na internetu nebo intranetu.
</p>

<p>
Na druhou stranu mù¾e být ve va¹em pøípadì potøeba nastavit stroj jako domain
name server:
<ul>
<li>Pokud máte IP LAN a nechcete replikovat "hosts" soubory lokálních adres
stroj od stroje. V takovém pøípadì byste mohli konfigurovat OpenBSD jako
DNS server a odpovídat na DNS dotazy strojù z va¹í LAN.</li>
<ul>
<li><b>Poznámka:</b> Neexistuje praktické omezení poètu DNS serverù na LAN.
¾ádný nebo naopak v¹echny poèítaèe na LAN mohou nabízet DNS service, pokud
jsou tak konfigurovány. Zda je ten který server pova¾ován za autoritativní
zvenku va¹í LAN (nebo je vùbec znám venkovním sítím) je vlastnost konfigurace,
která je vìt¹inou kontrolována na vy¹¹í úrovni doménové hierarchie.</li>
</ul>
<li>Pokud máte IP LAN, na které se nacházejí poèítaèe, které byste chtìli mít
dostupné z hlediska DNS dotazù, ze strojù z jiných IP LAN nebo WAN.</li>
<li>Pokud máte potí¾e s pøevodem názvu stroje na IP adresu nebo s pøevodem
lokálních názvù na IP adresy, pøesto¾e máte správnì nastaven obsah souborù
<i>/etc/hosts</i> a <i>/etc/resolv.conf</i> (Napø. Netscape na OpenBSD obèas
vykazuje podobné problémy, proto¾e implementuje vlastní resolver místo pou¾ití
funkce <i>gethostbyname(3)</i> pro kladení DNS dotazù.))</li>
</ul>

<p>
Dal¹ím faktorem je rychlost procesu. Proto¾e pøeklad jmen na adresy je
opakující se proces, ve kterém name servery opakovanì odpovídají jiným
nameserverùm na dotazy ohlednì adres jiných domén, pøeklad jmen mù¾e trvat
ponìkud déle, pokud máte modemové spojení s Internetem a dotazujete se
vlastního DNS serveru na adresy vzdálených poèítaèù (který se pak bude
opakovanì dotazovat vzdálených name serverù pomocí modemu), ne¾ pokud
 se dotazujete name serveru va¹eho ISP (který
má zøejmì rychlej¹í spojení se vzdálenými name servery).
</p>

<h3>6.8.3 Jaké jsou softwarové komponenty DNS serveru?</h3>

<ul>
<li>named <i>("name daemon")</i></li>
<li>Konfiguraèní soubory v adresáøovém hierarchii pod <i>/var/named/</i></li>
</ul>

<h4>6.8.3.1 Jaká úroveò BINDu je podporována?</h4>

<p>
BIND je oznaèení implementaci DNS. Komponenty domain name serveru spoleènì implementují BIND.
</p>

<p>
Existují tøi odli¹né specifikace BIND:
<ol>
<li>BIND 4</li>
<li>BIND 8</li>
<li>BIND 9</li>
</ol>

<p>
V bì¾né instalaci OpenBSD <b>named</b> podporuje BIND 4.x.

<h4>6.8.3.2 Jaké jsou nìkteré mo¾nosti provozování DNS prostøednictvím defaultní implementace BIND 4.x?</h4>

<ul>
<li>Iplementace BIND 9.x v <i>/usr/ports/net/bind9</i>.(Viz. <a href="../../cs/ports.html">ports</a>)
</ul>

<h5>6.8.3.2.1 <u>Poznámka o bezpeènosti</h5></u>

<p>
Pokud pou¾íváte tyto alternativní implementace domain name slu¾by, provozujete kritickou sí»ovou slu¾bu za pou¾ití softwaru, který nebyl pøedmìtem bezpeènostního auditu jako <a href="http://www.openbsd.org/security.html">auditovaný</a> <b>named</b> name daemon v základní instalaci. Toto je zapotøební zvá¾it, ponìvad¾
v pøípadì bezpeènostního naru¹ení domain name serveru mohou být resolvery pou¾ívající tento name server pøesmìrovány na cizí místa.
</p>

<h3>6.8.4 Kolik toho musím nainstalovat?</h3>

<p>
Pokud bylo nále¾itì nainstalováno pùvodní sí»ové nastavení pøi instalaci OpenBSD, pak je u¾ v¹echno vlastnì instalováno. Musíte je¹tì nastavit name daemona ("<tt>named</tt>").
</p>

<h3>6.8.5 Jak konfigurovat DNS?</h3>

<p>
Konfigurace se sestává na OpenBSD z editace nebo vytvoøení souborù, které øídí
name daemona <tt>named</tt>. Tyto soubory se nacházejí pùvodnì v adresáøi <i>/var/named</i> a v jeho podadresáøích, obzvlá¹tì soubor  <i>/var/named/named.boot</i>, co¾ je inicializaèní soubor pro <b>named</b>. Je tu rovnì¾ nìkolik dal¹ích
krokù konfigurace, které se nacházejí v <i>/etc</i>.
</p>

<p>
V tomto dokumentu budeme konfigurovat name daemona na <i>nemo.yewtopia.com</i> jako primární nameserver pro (velmi malou!!!) doménu <i>yewtopia.com</i>. Adresa i>nemo.yewtopia.com</i> je <i>192.168.1.9</i>. Dva jiné poèítaèe <i>crater.yewtopia.com </i> na 192.168.1.1 a <i>earhart.yewtopia.com</i> na 192.168.1.2 se nacházejí v její podsíti.
</p>

<h4>6.8.5.1 Konfigurace v <i>/var/named</i></h4>

<h5>6.8.5.1.1 <i>/var/named/named.boot</i></h5>

<ul><pre>
; tell what subdir has the lookup database files
directory       /namedb

; type    domain                source host/file backup file
cache .  root.cache
primary   0.0.127.IN-ADDR.ARPA  localhost.rev

; example primary server config:
primary  yewtopia.com yewtopia
primary  1.168.192.IN-ADDR.ARPA yewtopia.rev
</pre></ul>

<p>
Obsah souboru øíká inicializaèními procesu, ve kterém podadresáøi a pod kterými
jmény se nacházejí konfiguraèní soubory pro <i>yewtopia.com</i>.

<h5>6.8.5.1.2 <i>/var/named/namedb/localhost.rev</i></h5>

<ul><pre>
; Reverse lookup for localhost interface
@       IN      SOA     nemo.yewtopia.com.  your_id.nemo.yewtopia.com.  (

                                14      ; Serial
                                3600    ; Refresh
                                900     ; Retry
                                3600000 ; Expire
                                3600 )  ; Minimum
        IN      NS      nemo.yewtopia.com.
1       IN      PTR     localhost.yewtopia.com.
</pre></ul>

<h5>6.8.5.1.3 <i>/var/named/namedb/yewtopia</i></h5>

<ul><pre>
; yewtopia.com domain database
@      IN      SOA     nemo.yewtopia.com.  your_id.nemo.yewtopia.com.  (
                                14      ; Serial
                                3600    ; Refresh
                                900     ; Retry
                                3600000 ; Expire
                                3600 )  ; Minimum
                     IN      NS      nemo.yewtopia.com.

; Addresses
localhost.yewtopia.com.      IN A    127.0.0.1
crater.yewtopia.com.         IN A    192.168.1.1
earhart.yewtopia.com.        IN A    192.168.1.2
nemo.yewtopia.com.           IN A    192.168.1.9
</pre></ul>

<h5>6.8.5.1.4 <i>/var/named/namedb/yewtopia.rev</i></h5>

<ul><pre>
; yewtopia domain reverse lookup database
+@      IN      SOA     nemo.yewtopia.com.  your_id.nemo.yewtopia.com.  (
                                14      ; Serial
                                3600    ; Refresh
                                900     ; Retry
                                3600000 ; Expire
                                3600 )  ; Minimum
1.168.192.in-addr.arpa. IN      NS      nemo.yewtopia.com.

; Addresses
1.1.168.192.in-addr.arpa. IN PTR crater.yewtopia.com.
2.1.168.192.in-addr.arpa. IN PTR earhart.yewtopia.com.
9.1.168.192.in-addr.arpa. IN PTR nemo.yewtopia.com.
</pre></ul>

<h4>6.8.5.2 Konfigurace v <i>/etc</i></h4>

<h5>6.8.5.2.1 <i>/etc/resolv.conf</i></h5>
<p>
Ujistìte se, ¾e <i>/etc/resolv.conf</i> nyní odkazuje na doménu lokálního
stroje (namísto napøíklad nameserveru va¹eho ISP) tak, aby ¾ádosti na DNS
dotazy byly zasílány na <b>named</b>, kterého jste konfigurovali!
</p>

<ul><pre>
domain yewtopia.com
lookup file bind
</pre></ul>

<h4>6.8.5.2.2 <i>/etc/hosts</i></h4>

<p>
Pokud jste døíve pøidali adresy rùzných strojù do souboru <i>/etc/hosts</i>, mù¾ete zvá¾it zkrácení souboru <i>/etc/hosts</i> do pùvodního stavu:
</p>

<ul><pre>
# Host addresses
127.0.0.1       localhost       localhost.localdomain
192.168.1.9     nemo            nemo.yewtopia.com
</pre></ul>

<p>
Takto není <b>named</b> obcházen v pøípadì (mo¾ná zastaralých) adres v souboru
<i>/etc/hosts</i>. <u>Ujistìte se, ¾e máte pøinejmen¹ím v tomto souboru polo¾ku <i>localhost</i> </u>
jinak se va¹e sí» správnì nenastaví! V¹imnìte si také, ¾e
<i>nemo</i> se mustí objevit ve vlastním hosts souboru, jinak uvidíte (vìt¹inou málo nebezpeènou) 
chybovou hlá¹ku pøi startu, kdy¾ <i>/etc/netstart</i> spustí 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=route&sektion=8">route(8)</a>, 
aby pøidal <i>nemo</i> (jeho¾ adresa se objeví v  <i>/etc/myname</i>).
</p>

<h4>6.8.5.3 Pou¾ití <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dig&sektion=1">dig(1)</a> pro zkoumání výsledkù.</h4>

<ul><pre>
$ <strong>dig @nemo.yewtopia.com yewtopia.com any any</strong>

; &lt;&lt;&gt;&gt; DiG 2.2 &lt;&lt;&gt;&gt; @nemo.yewtopia yewtopia any any
; (1 server found)
;; res options: init recurs defnam dnsrch
;; got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 59904
;; flags: qr rd ra; Ques: 1, Ans: 2, Auth: 0, Addit: 1
;; QUESTIONS:
;;      yewtopia.com, type = ANY, class = ANY

;; ANSWERS:
yewtopia.com.   3600    SOA    nemo.yewtopia.com.  your_id.nemo.yewtopia.com. (
                        14      ; serial
                        3600    ; refresh (1 hour)
                        900     ; retry (15 mins)
                        3600000 ; expire (41 days 16 hours)
                        3600 )  ; minimum (1 hour)
yewtopia.com.   3600    NS      nemo.yewtopia.com.

;; ADDITIONAL RECORDS:
nemo.yewtopia.com.  3600    A       192.168.1.9

;; Total query time: 4 msec
;; FROM: nemo to SERVER: nemo.yewtopia.com  192.168.1.9
;; WHEN: Tue May  2 23:47:19 2000
;; MSG SIZE  sent: 25  rcvd: 102
</pre></ul>

<h3>6.8.6 Jak a kdy mám nastartovat a zastavit DNS?</h3>

<h4>6.8.6.1 Start DNS</h4>

<p>
Démon <b>named</b> je spu¹tìn pøi startu systému z 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&sektion=8">/etc/rc</a>,
v øádce instalované v pùvodním 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&sektion=8">/etc/rc.conf</a>.
</p>

<ul><pre>
named_flags=NO          # for normal use: ""
</pre></ul>

<p>
je zmìnìno na 
</p>

<ul><pre>
named_flags=""          # for normal use: ""
</pre></ul>

<p>
Rovnì¾ si v¹imnìte øádkù v /etc/rc.conf:
</p>

<ul><pre>
named_user=named                # Named should not run as root unless neccesary
named_chroot=/var/named         # Where to chroot named if not empty
</pre></ul>

<p>
Tato nastavení budou správná pro vìt¹inou míst.
</p>

<p>
Ruèní spu¹tìní <b>named</b>: pou¾ijte pøíkaz <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ndc&sektion=8">ndc(8)</a>. Napøíklad:
</p>

<ul><pre>
# <strong>ndc start</strong>
nebo 
# <strong>ndc reload</strong>
</pre></ul>

<h4>6.8.6.2 Zastavení DNS</h4>

<p>
Nejlep¹í zpùsob jak zastavit démona je pou¾ít pøíkaz <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ndc&sektion=8">ndc(8)</a>. Napøíklad:
</p>

<ul><pre>
# <strong>ndc stop</strong>
</pre></ul>

<p>
Pokud toto nefunguje, najdìte proces id procesu named a pou¾ijte <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kill&sektion=1">kill(1)</a> pro ukonèení procesu. PID of <b>named</b>, pokud bì¾í, mù¾ete najít v první øádce souboru <i>/var/named/named.pid</i>
</p>

<ul><pre>
# <strong>cat /var/named/named.pid</strong>
4608
named -t /var/named -u named
# <strong>kill -KILL 4608</strong>
</pre></ul>

<h4>6.8.6.3 Restart DNS se zmìnìnou konfigurací</h4>

<p>
Chcete-li, aby bì¾ící instance déman named restartovala sama sebe, s naètením
nové konfigurace, za¹lete procesu signál "hangup":
</p>

<ul><pre>
# <strong>kill -HUP 4608</strong>
</pre></ul>

<p>
nebo pou¾ijte pøíkaz <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ndc&sektion=8">ndc(8)</a>. Napø.:
</p>

<ul><pre>
# <strong>ndc restart</strong>
</pre></ul>

<h3>6.8.7 Jak zablokovat AXFR dotazy? </h3>
<p>
pøíklad:
<ul><pre>
garden:/home/jeremy$<strong>  host -l openssh.com</strong>
openssh.com.            NS      zeus.theos.com.
openssh.com.            NS      cvs.openbsd.org.
openssh.com.            NS      gandalf.sigmasoft.com.
openssh.com.            NS      cs.colorado.edu.
openssh.com.            NS      ns.appli.se.
openssh.com.            A       199.185.137.4
cvs.openssh.com.        A       199.185.137.4
localhost.openssh.com.  A       127.0.0.1
</pre></ul>
<p>
Tato informace je u¾iteèná pri ladìní DNS, ale v nìkterých pøípadech nemusí být vhodné nabízet tento výstup veøejnì.
Pokud pou¾íváte classless in-addr(rfc2317) jako reverz, host -l bude informovat o ka¾dé doménì, která se nachází ve va¹em systému! Zákazu zónových transferù 
docílíte pomocí klauzule 'allow-transfer' ve va¹em zónovém souboru.
<br><br>
Pokud pou¾íváte Bind8, mù¾ete specifikovat poèítaèe, kterým dovolíte zónové
transfery zón ve va¹ich zónových souborech:
<ul><pre>
zone "foo.com" in {
        type master;
        file "directory/zonefile";
        allow-transfer {
          127.0.0.1;
          10.0.0.6;
          10.0.255.12;
        };
};
</pre></ul>
Mù¾ete také zablokovat transfery V¹ech domén editováním souboru /var/named.conf a pøidáním parametru 'allow-transfer' do sekce options:
<pre><ul>
   options {
        allow-transfer { 127.0.0.1; };
    };
</pre></ul>
Metoda Bind8 pracuje takté¾ s Bind9.<br>
Pokud pou¾íváte Bind 4 (default v OpenBSD) mù¾ete editovat /var/named/named.boot a pou¾ít volbu 'xfrnets'.<br>

<pre><ul>
xfrnets 209.142.221.5 12.7.96.7
; type    domain                source host/file                backup file
cache     .                                                     root.cache
primary   0.0.127.IN-ADDR.ARPA  localhost.rev
</pre></ul><br>
Bind 4 dovoluje transfery z celých tøíd, tak¾e není tak pøesný.
Typicky jediné stroje, které potøebují vykonávat DNS transfery jsou va¹i DNS slaves a stroje, ze kterých chcete DNS debugovat (127.0.0.1 je vìt¹inou dobrá volba, u které dovolit transferu!)
Blokování AXFR dotazù pøidává dal¹í úroveò soukromí, ale mù¾e znemo¾nit debugování DNS. 
(Thanks to <a href=mailto:ntang@nachtwache.org>Nicholas Tang</a> za tento tip)
</p>
<h3>6.8.8 Co jste mi neøekli o nastavení DNS?</h3>
<p>
Je zde toho mnoho, napøíklad, jak nastavit DNS, aby dotazy na intranetové domény, které nejsou viditelné z koøene doménové hierarchie byly pøevádìny na servery v rámci va¹í spoleènosti. Radìji si pøeètìte <a href="#DNS.1.1">Dokumenty které doporuèujeme</a> , kde najdete více informací o DNS.
</p>

<a name="PPTP"></a>
<a name="6.9"></a>
<h2>6.9 - Nastavení PPTP spojení v OpenBSD</h2>

<p>
<strong>POZNÁMKA:</strong> Informace se nevztahují ke  <strong>V©EM</strong> ADSL providerùm, ale mnoho informací mù¾e být pøevzato z tohoto nastavení. O nìm je známo, ¾e funguje pro ADS providera v Rakousku <a href="http://www.inode.at">Inode</a>. 
</p>

<p>
Pro zaèátek potøebujete nainstalovat pptp.  Port se nachází v
<i>/usr/ports/net/pptp</i>. Pøeètìte si <a href="faq8.html#Ports">FAQ 8,
Ports</a> pro více informací o OpenBSD ports tree.
</p>

<p>
V dùsledku konfliktu pptp s podporou 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gre&apropos=0&sektion=0">gre(4)</a>
v jádøe budete nutné pøekompilovat jádro a odstranit podporu pro gre(4).
</p>

<ul>Patch pro odstranìní GRE(4) podpory.
<pre>
Index: GENERIC
===================================================================
RCS file: /cvs/src/sys/conf/GENERIC,v
retrieving revision 1.86
diff -u -r1.86 GENERIC
--- GENERIC     14 Mar 2002 00:42:25 -0000      1.86
+++ GENERIC     17 May 2002 01:52:17 -0000
@@ -87,7 +87,7 @@               
 pseudo-device  enc     1       # option IPSEC needs the encapsulation interface
 pseudo-device  bridge  2       # network bridging support
 pseudo-device  vlan    2       # IEEE 802.1Q VLAN
-pseudo-device  gre     1       # GRE encapsulation interface
+#pseudo-device gre     1       # GRE encapsulation interface
 #pseudo-device strip   1       # Starmode Radio IP interface

 pseudo-device  pty     64      # pseudo-terminals
</pre></ul>

<p>
Pro pøekompilování jádra proveïte checkout  OpenBSD source tree pomocí cvs 
(podívejte se na webovou stránku <a href="../../cs/anoncvs.html">AnonCVS</a>
pro dal¹í informace), aplikujte pøedcházející patch a pøekompilujete kernel
podle <a href="faq5.html#Building">FAQ 5, Kompilace kernelu</a>.
</p>

<p>
Poté co nainstalujete balík <b>pptp</b> a nové jádro, potøebujete zeditovat
soubory pro nastavení spojení. Tento balík pou¾ívá do OpenBSD zakomponované
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&apropos=0&sektion=0">ppp(8)</a>,
tak¾e pokud se v nìm vyznáte, pak velká èást nastavení vypadá stejnì. Rovnì¾
se podívejte na <a href="#PPP">FAQ 6, PPP</a>.
</p>

<ul>
<li>1 - /etc/ppp/options
<li>2 - /etc/ppp/pap-secrets
</ul>

<p>
Soubor <i>/etc/ppp/options</i> s následujícím nastavením bude dìlat pravdìpodobnì co potøebujete:
</p>

<ul><pre>
# <strong>cat /etc/ppp/options</strong>
name "LOGINNAME"
noauth
noipdefault
defaultroute
debug
</pre></ul>

<p>
<tt>LOGINNAME</tt> Mìlo by být nahrazeno va¹ím User-ID.
</p>

<p>
V  <i>/etc/ppp/pap-secrets</i> øádek:

<ul><pre>
# <strong>cat /etc/ppp/pap-secrets</strong>
LOGINNAME 10.0.0.138 PASSWORD
</pre></ul>

<p>
Kde LOGINNAME je va¹e User-ID a PASSWORD je va¹e heslo. 10.0.0.138 je IP pøiøazené va¹emu MODEMu v pøípadì ¾e pou¾íváte ADSL, atd. Ujistìte se, ¾e soubor mù¾e èíst pouze u¾ivatel root (mód 600).
</p>

<h3>6.9.1 - Pøiøazení adresy sí»ovému rozhraní</h3>

<p>
V pøedcházejícím pøípadì mìl ná¹ modem pøedkonfigurované rozhraní na 10.0.0.138.
Nyní potøebujeme pøiøadit adresu  NA©EMU rozhraní. Nejlépe je vybrat si jedno
IP blízko tomu, které vám bylo pøiøazeno va¹ím modemem, nebo pou¾ít statické IP,
které vám pøiøadili. Více si pøeètìte v <a href="#Setup">FAQ 6, Úvodní nastavení sítì</a>.
</p>

<p>
Poté co nastavíte interfejsy, mìli byste být schopni vytvoøit pptp spojení pøíkazem.

<ul><pre>
# <strong>/usr/local/sbin/pptp 10.0.0.138 &amp;</strong>
</pre></ul>

<p>
Proto¾e pou¾íváme do OpenBSD zaèlenìné ppp(8), jsou nastartovány dva procesy. Mù¾ete zastavit pptp ukonèením obou procesù:
</p>

<ul><pre>
# <strong>kill -9 [pid of pppd]</strong>
$ <strong>kill -9 [pid of pptp]</strong>
</pre></ul>

Doporuèujeme otevøít si  <tt>/var/log/messages</tt> v oddìleném terminálovém oknì, abyste rozpoznali mo¾né problémy.

<ul>
<pre>
# <strong>tail -f /var/log/messages</strong>
</pre></ul>
</p>

<p>
Rovnì¾ si pøidejte startovací pøíkaz do <i>/etc/rc.local</i> abyste se mohli automaticky spojit pøi restartu.
</p>


<p>
<font color= "#0000e0">
<a href= "index.html">[Zpìt na hlavní stránku]</a>
<a href= "faq5.html">[Do sekce 5.0 - Nastavení jádra]</a>
<a href= "faq7.html">[Do sekce 7.0 - Keyboard controls]</a>
</font>
</p>

<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../../images/back.gif" border= "0" alt= "[zpìt]"></a>
<a href= "mailto:www@openbsd.org">www@openbsd.org</a>
<small>
<br>
Originally [OpenBSD: faq6.html,v 1.143 ]
<br>
$Translation: faq6.html,v 1.10 2002/08/18 20:54:56 certik Exp $
<br>
$OpenBSD: faq6.html,v 1.10 2002/08/27 12:20:06 jufi Exp $
</small>

</body>
</html>


