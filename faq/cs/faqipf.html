<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-2">
<title>IPF - IP Filter (OpenBSD 2.9 a star¹í)</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998-2002 by OpenBSD.">
</head>

<body bgcolor= "#ffffff" text= "#000000" link= "#23238E">

<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
<p>
<h2><font color=#e00000>IPF - IP Filter (OpenBSD 2.9 a star¹í)</font><hr></h2>
</p>

<p>
<h4>Poznámka: IPF byl v OpenBSD 3.0 a pozdìj¹ích nahrazen Packet Filterem.
Tento dokument je urèen u¾ivatelùm sta¹ích verzí OpenBSD.</h4>
<p>
<ul><h3>Obsah</h3>
<li><a href= "#6.2">6.2 - IP filtr</a>
<li><a href= "#6.3">6.3 - Pøeklad sí»ových adres (NAT) </a>
</ul>
</p>
<hr>

<br>

<p>
<a name= "6.2"></a>
<h2>6.2 - IP Filter</h2>
</p>

<p>

Softwarový balík IP Filter od Darrena Reeda slou¾í pro zaji¹tìní následujících dvou úloh:
filtrovací pravidla pro filtrování na úrovni paketù 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipf&apropos=0&sektion=8&format=html">ipf(8)</a> a mapování
poèítaèù, podsítí na okruh externích adres 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&apropos=0&sektion=8&format=html">ipnat(8)</a>. Konfiguraèní soubory pro tyto dvì slu¾by jsou <i>/etc/ipf.rules</i> a <i>/etc/ipnat.rules</i>.
</p>

<p>
Je nutné zeditovat <i>/etc/rc.conf</i> pro jejich aktivaci pøi startu; øádky nastavte na:
</p>
<ul><pre>
ipfilter=YES
ipnat=YES
</pre></ul>

<p><p>
<b>Poznámka:</b> Pokud nebudete pou¾ívat ipnat a ipfilter zároveò, nemusíte nastavovat obì volby. 
Pokud ov¹em pou¾íváte <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8&manpath=OpenBSD+2.7">ipnat(8)</a>,
musí být aktivován také ipfilter.
</p>

<p>
Pokud pou¾íváte <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8&manpath=OpenBSD+2.7">ipnat(8)</a>,
nejspí¹e bude muset nastavit hodnotu sysctl &quot;net.inet.ip.forwarding&quot; na 1. To mù¾ete
udìlat odkomentováním pøíslu¹ného øádku v <i>/etc/sysctl.conf</i>.
</p>

<P>
Pokud máte IP filtr zakompilovaný v jádøe, ale nemáte ho aktivován v <i>/etc/rc.conf</i>, mù¾ete ho stále je¹tì jednodu¹¹e aktivovat.

<ul><pre>
# <strong>ipf -Fa -f /etc/ipf.rules -E</strong>
# <strong>ipnat -CF -f /etc/ipnat.rules</strong>
</pre></ul>

<P>
Volba <tt>-E</tt> u ipf 'umo¾òuje' IP filtr.  <Tt>-Fa</tt> ma¾e v¹echna pravidla pro filtrování, která mohla být ji¾ nastavena. <tt>-f /etc/ipf.rules</tt> nahraje nová pravidla ze souboru 
<i>/etc/ipf.rules</i>.
<p>
Pokud udìláte zmìny v <i>/etc/ipf.rules</i> poté co ipf je nahrán, mù¾ete pravidla
jednodu¹¹e nahrát znova.

<ul><pre>
# <strong>ipf -Fa -f /etc/ipf.rules</strong>
</pre></ul>
Stejné pro ipnat...

<ul><pre>
# <strong>ipnat -CF -f /etc/ipnat.rules</strong>
</pre></ul>
Také budete chtít spustit <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipmon&sektion=8&manpath=OpenBSD+2.7">ipmon(8)</a> pro ladìní.
<ul><pre>
# <strong>ipmon -Ds</strong>
</pre></ul>
<p>
Tento dokument obsahuje jen nìkolik základních 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipf&sektion=8&manpath=OpenBSD+2.7">ipf(8)</a> a 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8&manpath=OpenBSD+2.7">ipnat(8)</a> konfigurací.
Spousta pìkných pøíkladù je v <i>/usr/share/ipf/</i> . Doporuèujeme, abyste si
vybrali tu, která je vám nejbli¾¹í a modifikovali ji pro va¹e potøeby.
Informace o IP filtru naleznete na IP Filter <A HREF="http://false.net/ipfilter/">mailing list archívu</a>,
<A HREF="http://coombs.anu.edu.au/~avalon/">IP Filter web site</a>, a koneènì <A
HREF="http://www.obfuscation.org/ipf/">IP Filter HOWTO</a>.
</p>

<p>
<h3>IPF</h3>
</p>

<p>
Pro konfiguraci IP filtru pøi startu, budete muset modifikovat /etc/rc.conf ,aby zde bylo IPFILTER=YES. 
IP Filtr  (ipf) je kontrolován sadou pravidel ze souboru /etc/ipf.rules, která
jsou naètena pøi startu. Pro detailnìj¹í popis si pøeètìte <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipf&apropos=0&sektion=5&manpath=OpenBSD+2.7">ipf(5)</a>. V pøikladech, které následují, fxp0 reprezentuje externí rozhraní k internetu. Ve va¹em  pøípadì bude patrnì jiné, na základì ethernetového adaptéru ve va¹em poèítaèi.  Pravidla pøedpokládají trvalé spojení s Internetem, jaké byste
zaøídili patrnì pro webserver.
</p>

<p>
Pravidla IP filtru jsou zpracovávána postupnì od shora dolù. Ka¾dý paket musí
pøejít pøes tyto pravidla, pøedtím ne¾ dosáhne svého urèení.
</p>

<p>
Napøíklad implicitní soubor pravidel umo¾òuje ka¾dému paketu cestovat dovnitø a ven:

<ul><pre>
pass out from any to any
pass in from any to any
</pre></ul>

Nyní pøedpokládejme, ¾e nechceme dovolit jakoukoliv pøichozí konekci na port
3306 (mysql) proto¾e k databázi by mìl být pøístup pouze z localhostu.
Soubor pravidel by vypadal takto:

<ul><pre>
pass out from any to any
pass in from any to any
block in on fxp0 from any to any port = 3306
</pre></ul>

Toto øíká  &quot;blokuj v¹echny pøíchozí pakety, pøicházející na interfejs fxp0 odkudkoliv, smìøující kamkoliv, jejich¾ destinace je port 3306.&quot;
Pøirozenì, paket urèený pro port 3306 na zaøízení fxp0 projde pøes první
&quot;pass in&quot; pravidlo a potom bude odhozen díky pravidlu &quot;block in port = 3306&quot; . Pokud zmìníte poøadí va¹ich pravidel (pamatujte si, poøadí
je dùle¾ité):

<ul><pre>
pass out from any to any
block in on fxp0 from any to any port = 3306
pass in from any to any
</pre></ul>

Pakety urèené pro port 3306 projdou, proto¾e poslední pravidlo souboru dovoluje
v¹em pøíchozím paketùm projít. Je dùle¾ité pamatovat si pøi psaní pravidel
pro IP filtr, ¾e:
 <b> Poslední odpovídající pravidlo vítìzí</b>.
</p>

<p>
Samozøejmì, jsou zde vyjímky pro ka¾dé pravidlo. Volba <em>quick</em> ukonèí 
zpracování paketu na prvním pravidlu, které odpovídá. Podívejme se na pøedcházející pøíklad.
Pokud pøidáme  <em>quick</em>  k pravidlu &quot;block in&quot; :

<ul><pre>
pass out from any to any
block in quick on fxp0 from any to any port = 3306
pass in from any to any
</pre></ul>

ck</em> <p>
Paket urèený pro ná¹ poèítaè na port 3306 bude zpracován bezprostøednì pravidlem
&quot;block in quick&quot; a bude odhozen. V¹echny pakety urèené pro jiné porty
nenajdou odpovídající pravidlo, dokud nedosáhnou pravidla &quot;pass in&quot;, které jim dovolí projít.
</p>

<b>Default Deny</b>
<p> Nejbezpeènìj¹í politika filtrování paketù je tzv. politika default deny.
V¹echny pakety, které nejsou pøímo dovoleny, jsou odhozeny. Tato politika je
mnohem bezpeènìj¹í ne¾ pøímo nepovolovat ka¾dou chránìnou slu¾bu, také umo¾òuje
mít relativnì malý soubor pravidel a mù¾e ochránit od ¹patnì nakonfigurované
slu¾by, která je ponechána svému osudu.
<p>
Nyní se podívejte na jiný pøíklad skuteèného ¾ijícího pøíkladu pravidel a vysvìtleme si øádku po øádce jejich význam. Je zde pøíklad webserveru s default deny
politikou, která povoluje pouze ssh spojení (pro administraci) a spojení
http (port 80) a https (port 443).
<ul><pre>
pass in quick on fxp0 from any to any port = 22
pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443
block in quick on fxp0 from any to any
pass out on fxp0 from any to any 
</pre></ul>

<p>
Tyto pravidla dovolí pøíchozím spojením odkudkoliv na porty 22(ssh), 80(http)
a 443(https) projít. Odhodí v¹echny ostatní pakety a umo¾ní v¹echna odchozí
spojení.
Co ale kdy¾ chcete dovolit ssh spojení pouze z interních strojù , ale dovolit
spojení zvenku na http a https?
</p>

<ul><pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443
block in quick on fxp0 from any to any
pass out on fxp0 from any to any
</pre></ul>

Docela dobré, ale co kdy¾ chceme dovolit pouze jednomu stroji (1.1.1.1) administrovat webserver vzdálenì?
V tomto pøípadì  mù¾eme zmìnit :

<ul><pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
</pre></ul>
na:
<ul><pre>
pass in quick on fxp0 from 1.1.1.1/32 to any port = 22
</pre></ul>
IP filtr podporuje jak teèkovou desítkovou tak CIDR notaci sí»ové masky. Pøedcházející byste mohli napsat také jako:
<ul><pre>
pass in quick on fxp0 from 1.1.1.1/255.255.255.255 to any port = 22
</pre></ul>
ale proè byste to dìlali?
</p>
<b> Pøíklad souboru pravidel</b>
<p>
Zde je nìkolik pravidel pro ka¾dého (pøedpokládejme, ¾e fxp0 je externí zaøízení
pøipojené na internet). Nejprve nastolíme jednoduchou address spoofing ochranu.
<ul><pre>
block in quick on fxp0 from 127.0.0.0/8 to any
block in quick on fxp0 from 192.168.0.0/16 to any
block in quick on fxp0 from 172.16.0.0/12 to any
block in quick on fxp0 from 10.0.0.0/8 to any
block out quick on fxp0 from any to 127.0.0.1/8
block out quick on fxp0 from any to 192.168.0.0/16
block out quick on fxp0 from any to 172.16.0.0/12
block out quick on fxp0 from any to 10.0.0.0/8
</pre></ul>
Dobrá my¹lenka je rovnì¾ oddìlit pravidla pro va¹e loopback rozhraní od ostatních. 
 
<ul><pre>
pass out quick on lo0
pass in quick on lo0
</pre></ul>
Ná¹ soubor pravidel zdá se zatím vypadá dobøe, kdy¾ to dáme v¹echno dohromady,
vypadá to takto:
<ul><pre>
# loopback rules

pass out quick on lo0
pass in quick on lo0

# don't allow anyone to spoof non-routeable addresses

block in quick on fxp0 from 127.0.0.0/8 to any
block in quick on fxp0 from 192.168.0.0/16 to any
block in quick on fxp0 from 172.16.0.0/12 to any
block in quick on fxp0 from 10.0.0.0/8 to any
block out quick on fxp0 from any to 127.0.0.1/8
block out quick on fxp0 from any to 192.168.0.0/16
block out quick on fxp0 from any to 172.16.0.0/12
block out quick on fxp0 from any to 10.0.0.0/8

# only allow our administration machine to connect via ssh

pass in quick on fxp0 from 1.1.1.1/32 to any port = 22

# allow others to use http and https

pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443

# finally lock the rest down with a default deny

block in quick on fxp0 from any to any

# and let out-going traffic out

pass out on fxp0 from any to any
</pre></ul>
</p>

<b>Logování paketù</b>
<p>
Nyní je na¹e situace dost dobrá, ale mohla by být je¹tì lep¹í. Co kdy¾ chceme
logovat ka¾dý pokus o spojení na port 22(ssh), který byl firewallem zablokován?
Jednodu¹¹e, IP filtr to umo¾òuje pomocí slova <em>log</em> :
<ul><pre>
pass in quick on fxp0 from 1.1.1.1/32 to any port = 22
block in log quick on fxp0 from any to any port = 22
</pre></ul>
Toto pravidlo dovolí na¹emu vzdálenému administraènímu poèítaèi spojení na port
22, ale blokuje a loguje v¹echny ostatní pokusy o spojení na port 22.
</p>
<b> Filtrování na základì protokolù</b>
<p>
IP filtr umí filtrovat jakýkoliv IP protokol podle jeho èísla nebo názvu
v souboru <a href=file://localhost/etc/protocols>/etc/protocols</a>. My
se zamìøíme jen na protokoly tcp, udp a icmp. Tyto jsou nejèastìji u¾ívány. 
V¹echny zásadní internetové aplikace závisí na implementaci a správném fungování tìchto protokolù.</p>
<p>
Pro filtrování podle protokolù se u¾ívá v konfiguraci ipf klíèové slovo <em>proto</em>. Podíváme-li se na ná¹ pøedchozí pøíklad pravidla pro ssh, proto¾e ssh
pou¾ívá pro svoji komunikaci tcp, mìli bychom dovolit spojení pouze tcp paketùm. Pou¾itím slova <em>proto</em> umo¾níme uspìt pouze tcp paketùm a dostáváme pravidlo podobné tomuto:
<ul><pre>
pass in quick on fxp0 proto tcp from 1.1.1.1/32 to any port = 22
</pre></ul>
Co ale v pøípadì, kdy potøebujeme umo¾nit spojení slu¾bì pou¾ívající jak tcp
tak i udp, jako je napøíklad bind? V pøípadì tcp/udp IP filtr dovoluje spojit
oba protokoly dohromady. Poznámka: toto je mo¾né pouze v pøípadì tcp/udp. Pou¾ití v pøípadì slu¾by dns v prostøedí s defaultní politikou deny je následující:
<ul><pre>
pass in quick on fxp0 proto tcp/udp from any to any port = 53
</pre></ul>
</p>
<b> Filtrování fragmentù</b>
<p>
Kromì filtrování zalo¾eného na protokolech je IP filtr schopen filtrovat
rovnì¾ fragmentované IP pakety (bì¾ná metoda obcházení paket filtrù). Jsou
zde dvì klíèová slova, která se pou¾ívají pro práci s fragmentovanými ip pakety,  <em>frag</em> pro bì¾nì fragmentované pakety nebo <em>short</em> pro IP pakety, jejich¾ hlavièky jsou pøíli¹ malé pro porovnávání. Proto¾e fragmentované
pakety se mohou vyskytnout v dùsledku bì¾ného provozu, je nejlep¹í filtrovat
pouze pakety, jejich¾ hlavièky jsou pøíli¹ malé pro smysluplné porovnávání. 
Toho dosáhneme pou¾itím následujícího pravidla:
<ul><pre>
block in quick proto tcp all with short
</pre></ul>
A co IP paket s nastavenými IP volbami ?
IP filtr pracuje i s tìmito fenomény. Pakety mohou být odfiltrovány, pokud
mají nastaveny volby jako takové, nebo pokud mají nastaveny urèité volby.
Napøíklad následující pravidlo zaká¾e a loguje v¹echny pakety s nastavenými
volbami.
<ul><pre>
block in log quick on fxp0 all with ipopts
</pre></ul>
Toto pravidlo mù¾e ale znemo¾nit funkci nìkterých programù, jako napøíklad
 <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=traceroute&sektion=8&format=html">traceroute(8)</a>. Mù¾ete rovnì¾ specifikovat, které volby IP paketu
nepovolujete. Napøíklad takto:
<ul><pre>
block in quick on fxp0 all with opt lsrr
block in quick on fxp0 all with opt ssrr
</pre></ul>
<b>TCP pøíznaky, vytvoøená spojení a keeping state</b>
<p>
Nyní zaèíná být filtrování progresivní. Nejvìt¹í silou IP filtru je toti¾
schopnost filtrovat pakety na základì nastavených pøíznakù TCP protokolu,
udr¾ovat vytvoøená spojení a jejich stav. Doporuèujeme, aby v¹ichni u¾ivatelé,
kteøí chtìjí filtrovat podle TCP pøíznakù  vìdìli, jakou roli ka¾dý
pøíznak má. Napøíklad , pokud chcete zakázat v¹echny pakety s nastavenými
flagy FIN, URG a PSH (jako napøíklad v pøípadì pokusu o OS fingerprinting pomocí nmap-u ) mù¾ete pou¾ít pravidlo jako je toto:
<ul><pre>
block in quick on fxp0 proto tcp from any to any flags FUP
</pre></ul>
( Díky  <a href=mailto:halogen@nol.net>Kyle Hargraves</a> za tento tip)
</p>
<p>
Dal¹í výborná vlastnost IP filtru je schopnost udr¾ovat stav. Tato vlastnost
spoèívá v tom, ¾e jakmile je jednou vytvoøeno spojení, pakety týkající se
tohoto spojení u¾ dále nepodstupují filtrování. Toto je velmi silná vlastnost
, která umo¾òuje psát pravidla filtru jednodu¹¹eji a bezpeènìji.</p>
<p>
Napøíklad, podívejme se, jak mu¾eme uplatnit tuto vlastnost pøi psaní na¹í ukázkové sestavy pravidel. Pro pøipomenutí, dovolujeme administraèní pøístup z
na¹í adresy tøídy C na port 22(ssh) a dovolujeme v¹echna pøíchozí spojení 
na port 80 (http) a 443 (https). Blokujeme v¹echna ostatní spojení. Co ale
dìlat v pøípadì, ¾e se chceme spojit pomocí ssh z web serveru, nebo chceme
pou¾ít lynx abychom se podívali na nìco ve FAQ? To udìlat nemù¾eme, proto¾e
jsme zablokovali v¹echna pøíchozí spojení, které smìøují na jiné ne¾ námi
povolené porty. Aèkoliv nastavení ip filtru je tak bezpeèné jak to jen jde,
mù¾e být ponìkud nevyhovující. Pøídáním slova <em>keep state</em> do pravidla
 &quot;pass out&quot; mù¾eme automaticky dovolit spojení, která pøicházejí
jako odezva na na¹e pokusy o spojení, jako je napø. surfování na webu.
<ul><pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
pass in quick on fxp0 from any to any port = 80
pass in quick on fxp0 from any to any port = 443
block in quick on fxp0 from any to any
pass out on fxp0 proto tcp from any to any keep state
</pre></ul>
</p>
<p>
Tato malá zmìna dramaticky zvy¹uje flexibilitu a bezpeènost na¹í sady pravidel
. Napøíklad, v pøecházejícím pøíkladì umo¾òujeme tcp spojení na port 80 a 443.
Mù¾eme to ale je¹tì zlep¹it. K tomu, aby se vytvoøilo tcp spojení, potøebujeme
aby probìhl jen poèáteèní handshake, jakmile k nìmu dojde, mù¾eme blokovat
spojení na tento port a pomocí na¹eho &quot;keep state&quot; pravidlo bude
udr¾ovat vytvoøené spojení. Abychom dovolili poèáteèní handshake, potøebujeme
dovolit pakety pouze s nastavenými flagy SIN a SIN/ACK. Propu¹tìním paketù pouze s pøíznaky SIN a SIN/ACK se ubráníme mnoha formám port skenù jako je napøíklad
FIN skenování. Pravidla nyní vypadají takto:
<ul><pre>
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22
pass in quick on fxp0 from any to any port = 80 flags S/SA
pass in quick on fxp0 from any to any port = 443 flags S/SA
block in quick on fxp0 from any to any
pass out on fxp0 proto tcp from any to any keep state
</pre></ul>
</p>
<p>
Nyní dejme dohromady v¹echny pravidla, která jsme mìli dosud v na¹í sadì.
Tato sada bude mít default deny politiku, umo¾òující pouze administrativní
spojením z interní sítì (pøes ssh) a umo¾òující pøíchozí spojení na porty
80 (http) a 443 (https). Ochrání nás rovnì¾ pøed spoofovanými neroutovatelnými
ip adresami a zaká¾e v¹echny pakety, které jsou pøíli¹ fragmentované nato, aby
se daly vy¹etøit. Docela dobré nastavení pro veøejný webserver. Zde je
ukázka souboru /etc/ipf.rules :
<ul><pre>
# loopback rules
pass out quick on lo0
pass in quick on lo0

# drop itsy bitsy frags
block in quick proto tcp all with short

# drop source routed packets
block in quick on fxp0 all with opt lsrr
block in quick on fxp0 all with opt ssrr

# don't allow anyone to spoof non-routeable addresses
block in quick on fxp0 from 127.0.0.0/8 to any
block in quick on fxp0 from 192.168.0.0/16 to any
block in quick on fxp0 from 172.16.0.0/12 to any
block in quick on fxp0 from 10.0.0.0/8 to any
block out quick on fxp0 from any to 127.0.0.1/8
block out quick on fxp0 from any to 192.168.0.0/16
block out quick on fxp0 from any to 172.16.0.0/12
block out quick on fxp0 from any to 10.0.0.0/8

# only allow our machines to connect via ssh
pass in quick on fxp0 from 1.1.1.0/24 to any port = 22

# allow others to use http and https
pass in quick on fxp0 from any to any port = 80 flags S/SA
pass in quick on fxp0 from any to any port = 443 flags S/SA

# finally lock the rest down with a default deny
block in quick on fxp0 from any to any

# and let out-going traffic out and maintain state on established connections
#  -- The flags S on the keep state is to ensure that state tracking starts
#    only on the first outbound packet in a tcp session.
#    unnecessary consumption of state table entries.
# -- The flag s only works on the tcp protocol, so three entries are required to
#    to cover all three protocols (tcp, udp, icmp).

pass in        quick on fxp0 proto tcp  from any to any flags S keep state
pass in        quick on fxp0 proto udp  from any to any         keep state
pass in        quick on fxp0 proto icmp from any to any         keep state
</pre></ul>
</p>
<p>
Pokud se vyskytnou nìjaké problémy, mù¾ete chtít zprovoznit logování u jednotlivých pravidel, abyste vìdìli co se dìje, napø.:
pass in log quick on fxp0 from 1.1.1.0/24 to any port = 22<br>
Pokud zmìníte svùj konfiguraèní soubor, aby pravidla logovaly pakety, nezapmeòte dát ipf -Fa -f /etc/ipf.rules aby se zmìny promítly!
<br>ipmon bude psat ip log hlá¹ky do /var/log/ipflog .<br>
Pro dal¹í informace o ipf je k dispozici excelentní <a href=http://www.obfuscation.org/ipf/ipf-howto.txt>IPF how-to</a>, stejnì jako <a href=http://coombs.anu.edu.au/~avalon/ip-filter.html>IP Filter</a> homepage.
</p>

<p>
<a name="6.3"></a>
<h2>6.3 - IPNAT</h2>
</p>

<p>
Initial work done by Wayne Fergerstrom &lt;wayne@methadonia.net&gt;
</p>

<a name="nat1.0"></a>
<h3><u>6.3.1 NAT Úvod</u></h3>

<a name="nat1.1"></a>
<b>Sekce Úvod</b>
<p>
Tato sekce se pokou¹í pomoci tìm, kteøí instalují a konfigurují Network Address Translation ("NAT") na systému OpenBSD.

Pøedpokládá se, ¾e u¾ivatel u¾ nastavil a nakonfiguroval OpenBSD se dvìma
sí»ovými kartami (jedna pøipojena k Internetu a druhá k lokální síti).
Pøeklad IP adres bude fungovat i na strojích s jedním sí»ovým rozhraním, pøesto
je nutné poznamenat, ¾e pakety budou procházet pøes toto jediné rozhraní dovnitø a ven a ¾e ethernetové kolize sní¾í významnì výkon.
</p>

<p>
Na základì <a HREF="http://www.geektools.com/rfc/rfc1631.txt">RFC 1631</a>, ipnat dává jednoduchý zpùsob jak namapovat interní sí» na jedinou routovatelnou
("reálnou") internetovou adresu. Toto je velmi u¾iteèné, pokud je¹tì napøíklad
nemáte oficiálnì pøiøazené adresy pro ka¾dý stroj na va¹í interní síti. Pøi
nastavování soukromé/interní sítì, mù¾ete s výhodou pou¾ít rezervovaných adresových blokù (pøiøazených v <A HREF="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>), jako jsou:
<P>

10.0.0.0/8 (10.0.0.0 - 10.255.255.255)<br>
172.16.0.0/12 (172.16.0.0 - 172.31.255.255)<br>
192.168.0.0/16 (192.168.0.0 - 192.168.255.255)<br>

</p>

<a name="nat1.2"></a>
<b>Terminologie</b>

<p>
Pro informaci uvádíme nìkolik zkratek a formát jaký bude v dokumentu pou¾it.
<ul>
<strong>"NAT"</strong>
<p>
Tato zkratka popisuje funkci "Network Address Translation"  tj. pøekladu
sí»ových adres. Proces pøekladu je popsán pozdìji.
</p>
</ul>

<ul>
<strong>"ipnat"</strong>

<p>
Zkratka za "IP Network Address Translation." V podstatì mù¾e být pou¾ita
podobnì jako NAT. Pøesto v tomto dokumentu bude oznaèovat termín "ipnat" pouze
pro pou¾ití na pøíkazové øádce.
</p>
</ul>

<ul>
<strong>"IPF"</strong>

<p>
Zkratka za IP filtr. IP filtr je portovatelný software pro filtrování paketù,
který je dodáván jako souèást OpenBSD. IP filtr musí být zapnut, pøedtím ne¾
spustíte ipnat. Je to snadné, docílíte toho editací souboru /etc/rc.conf a
zmìníte ipf=NO na ipf=YES. Tato zmìna zmìní stav vìcí pro dal¹í bootování.
Pokud jste u¾ systém nastartovali mù¾ete ip filtr zapnout pomocí pøíkazu 'ipf -E' . Samozøejmì toto je popsáno dále.
</p>
</ul>

<br>
<a name="nat1.3"></a>
<b>Nastavení</b>

<p>
Následují informace o nastavení poèítaèù, které figurují v tomto dokumentu.
</p>

<ul>
<b>Operaèní systém: </b>OpenBSD v2.7 i386<br>
<br>
<b>Sí»ové karty: </b>
<ul>
  NetGear 10/100MB <b>dc0</b><br>
  Connected to the EXTERNAL LAN (or WAN)<br>
  <b>IP Address: </b>24.5.0.5<br>
  <b>Netmask: </b>255.255.255.0<br>
  <br>
  NetGear 10/100MB <b>dc1</b><br>
  Connected to the INTERNAL LAN<br>
  <b>IP Address: </b>192.168.1.1<br>
  <b>Netmask: </b>255.255.255.0<br>
</ul>
<br>
<b>Externí, internetová routa (dodal ji ISP, v tomto pøípadì se jedná o linku
modemovou)<br></b>
<ul>
  <b>IP Address: </b>24.5.0.5<br>
  <b>Netmask: </b>255.255.255.0<br>
  <b>Gateway: </b>24.5.0.1<br>
</ul>
<br>
<b>Lokální sí»</b><br>
<ul>
Poèítaèe na LAN pou¾ívají adresové schéma 192.168.1.xxx (kde xxx je jedineèné
èíslo). Na LAN je mnoho rùzných OS, vèetnì Windows 98, Windows NT, OpenBSD a
Linux. Ka¾dý stroj je pøipojen k hubu, který je vybaven pro interní pou¾ití.
V tomto dokumentu a v jeho pøíkladech  klient na LAN bude pou¾ívat IP adresu
192.168.1.40
</ul>
<br>
<b>Diagram nastavení</b>
<ul><pre>
+-----+              +---------+         +----------+
| Hub |--------- dc1 |   NAT   | dc0 ----| Internet |
+-----+              +---------+         +----------+
  | |
  | +-- Klient A
  +---- Ostatní stroje  

                              +-------------------------+
                              |        LEGENDA          |
                              +-------------------------+
                              |  NIC dc0 - 24.5.0.5     |
                              |  NIC dc1 - 192.168.1.1  |
                              | Klient A - 192.168.1.40 |
                              +-------------------------+

</pre></ul>
</ul>
<br>
<a name="nat2.0"></a>
<h3><u>6.3.2 Pøeklad sí»ových adres</u></h3>
<br>

<a name="nat2.1"></a>
<b>Seznámení s NATem</b>

<p>
Jak pøibývají dal¹í a dal¹í firmy, které chtìjí mít spojení na Internet, ka¾dá
musí mít vlastní IP adresu. Veøejných IP adres je èímdál ménì. Øe¹ením pro mnoho lidí je Network Address Translation (NAT), neboli pøeklad sí»ových adres . NAT je jednoduchý zpùsob, jak pøipojit va¹i LAN na Internet, ani¾ byste si
museli zakoupit nebo pronajmout IP adresu pro ka¾dý stroj. 
</p>

<p>
Zpùsob, jakým NAT pracuje je pøekvapivì jednoduchý. Kdy¾ se klient na LAN chce
spojit se strojem v Internetu, po¹le ven TCP paket se ¾ádostí o spojení. Uvnitø
TCP hlavièky paketu je klientova IP adresa (napø. 192.168.1.40) a po¾adovaná
IP adresa cílového poèítaèe (napø. 123.45.67.89). Stroj, na kterém bì¾í NAT
obdr¾ít tento TCP paket a zmìní klientovu IP adresu v hlavièce z 192.168.1.40
na IP adresu pøipojenou na Internet (napø.  24.5.0.5). Tímto zpùsobem
efektivnì docílíme toho, ¾e cílový poèítaè se domnívá, ¾e vlastní spojení pøichází ze stroje, na kterém bì¾í NAT. Cílový poèítaè (host) posílá dále pakety
týkající se daného spojení na adresu stroje s NATem. Kdy¾ stroj s NATem obdr¾í
paket od host-a, pøelo¾í rychle cílovou IP adresu na adresu klienta a po¹le paket klientovi. Klient nemá ani tu¹ení o tom, co se stalo a Internetové spojení
je zcela transparentní.
</p>

<p>
Následující pøíklad ozøejmí dosud nepochopené:
</p>

<ul><pre>
Klient ----------------- dc1 [ NAT ] dc0 ---------- Internet Host
192.168.1.40 --- 192.168.1.1 [ NAT ] 24.5.0.5 --- 123.45.67.89

Odcházející TCP paket                     Odcházející TCP paket
From: 192.168.1.40    &gt;&gt;=== NAT ===&gt;&gt;     From: 24.5.0.5
To: 123.45.67.89                          To: 123.45.67.89

Pøicházející TCP paket                    Pøicházející TCP paket
From: 123.45.67.89                        From: 123.45.67.89
To:   192.168.1.40    &lt;&lt;=== NAT ===&lt;&lt;     To: 24.5.0.5
</pre></ul>

<br>
<a name="nat2.2"></a>
<b>Proè pou¾ívat NAT?</b>

<p>
Kdy¾ jsem se nastìhoval do nového bytu, byl jsem postaven pøed men¹í problém.
Jak dát pøipojení k Internetu mým spolubydlícím, kdy¾ modemový kabel je
pouze v mé místnosti? Bylo tu nìkolik mo¾ností, které jsem mohl implementovat,
poèínají tím, ¾e ka¾dý z nás obdr¾í vlastní IP adresu, pøes nastavení proxy
serveru a¾ po nastavení NATu. (Nenechejte se mýlit pøíkladem s modemovým kabelem. NAT je dostateènì silný aby zamaskoval velikou LAN se stovkami ba i tisíci
poèítaèù!)
</p>

<p>
Je tu mnoho dùvodù, proè jsem chtìl nastavit NAT. Dùvodem èíslo jedna bylo u¹etøit peníze. V mém domì jsou tøi spolubydlící (ka¾dý s vlastním PC) a já sám
se tøemi poèítaèi. Mùj ISP dovolí pouze tøi IP adresy v ka¾dé domácnosti.
To znamená, ¾e zde není dostatek IP adres , aby ka¾dému poèítaèi mohl být
dovolen internetový pøístup.
</p>

<p>
Za pou¾ití NATu bude mít ka¾dý stroj unikátní (interní) IP adresu, ale budou
sdílet jednu IP adresu pro pøístup na Internet. Náklady jdou dolù.
</p>

<br>
<a name="nat2.3"></a>
<b>Setup</b>

<p>
Nejprve budete muset na va¹em OpenBSD systému zapnout IPF a NAT. Toho jednodu¹¹e docílíte editací souborù uvedených dále (zmìny udìlejte tak, aby odpovídající
øádky vypadaly jako ty následující):
</p>

<p>
<b>/etc/rc.conf</b> (Z tohoto souboru se startují programy pøi bootování)
</p>

<ul>
  ipfilter=YES<br>
  ipnat=YES
</ul>

<p>
<b>/etc/sysctl.conf</b>
</p>

<ul>
  net.inet.ip.forwarding=1
</ul>

<p>
Po tìchto zmìnách je stroj pøipraven pro konfiguraci NATu.
</p>

<br>
<a name="nat2.4"></a>
<b>Konfigurace</b>

<p>
Prvním krokem je nastavit soubor s pravidly pro IPF (<i>/etc/ipf.rules</i>).
Pro úèely tohoto dokumentu dovolíme spojení pøes tento firewall bez omezení.
Soubor by mìl vypadat asi takto:
</p>

<ul><pre>
pass in from any to any
pass out from any to any
</pre></ul>

<p>
Pro více informací si pøeètìte <a href="#6.2">FAQ 6.2</a>
</p>

<p>
Soubor s nastavením NATu (<i>/etc/ipnat.rules</i>) má velmi jednoduchý syntax.
Pro pøípad nastaveného firewallu (viz. vý¹e) bude vypadat takto:
</p>

<ul><pre>
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32 portmap tcp/udp 10000:60000
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32
</pre></ul>

<p>
Zde je vysvìtlení pøedcházejících øádek.
</p>

<ul>
<strong>"map"</strong>
<p>
Tímto pøíkazem øíkate NATu,  ¾e podle následujících dat se bude mìnit adresa
mezi LAN a Internetem.
</p>
</ul>

<ul>
<strong>"dc0"</strong>
<p>
Název sí»ového rozhraní pøipojeného na Internet.
</p>
</ul>

<ul>
<b>"192.168.1.0/24"</b>
<p>
IP adresa a sí»ová maska (maska je v CIDR formátu). Dohromady to znamená
"jakákoliv IP adresa o hodnotì od 192.168.1.1 do 192.168.1.254" má být
mapována. Pokud nechcete pou¾ít CIDR (classless inter-domain routing) notaci,
mù¾ete  "/24" nahradit "/255.255.255.0".
</p>
</ul>

<ul>
<b>"24.5.0.5/32"</b>
<p>
Tato IP adresa a sí»ová maska zastupují IP adresu, na kterou budou namapovány
adresy z LAN. /32 znamená, ¾e se jedná o jednu IP adresu. Mù¾ete také mapovat
na /24 nebo  256 IP adres (nebo /27  nebo jakýkoliv poèet bitù, který chcete)!!  Toto je u¾iteèné, pokud máte nìkolik tisíc klientù umístìných za NATem ....
(Samozøejmì, je to u¾iteèné jenom pokud tìch /24 je smìrováno na vá¹ stroj s OpenBSD!)
</p>
</ul>

<ul>
<b>"portmap tcp/udp 10000:60000"</b>
<p>
Toto mapuje v¹echny tcp/udp pakety na porty v rozsahu od 10000 do 60000.
</p>
</ul>

<p>
Druhý øádek je témìø stejný s výjimkou poslední èásti.
Ta øíká ipnat-u aby mapoval v¹echno ostatní (ne tcp/udp, tyto pakety byly
u¾ obslou¾eny prvním øádkem) na jakýkoliv port, který je po¾adován (pou¾ívá
se pro ICMP a jiné protokoly). Jakmile máte tohle v¹echno v souboru, jediné
co potøebujete je spustit IPF démona.
</p>

<br>

<a name="nat2.5"></a>
<b>Selektivní NAT</b>

<p>
Mohli byste chtít zabránit NAT pro nìkterý rozsah venkovních adres.
Pokraèujme v pøedchozím pøíkladu a pøedpokládejme, ¾e chcete, aby se pro poèítaèe v síti 24.5.0.0/28
Va¹e NAT gateway chovala jako obyèejný router bez pøekladu adres.
Potlaèit pøeklad adres pro odchozí spojení z dc0 do této podsítì mù¾ete takto:
</p>

<ul><pre>
map dc0 from 192.168.1.0/24 ! to 24.5.0.0/28  -&gt;  24.5.0.5/32 portmap tcp/udp 10000:60000
map dc0 from 192.168.1.0/24 ! to 24.5.0.0/28  -&gt;  24.5.0.5/32
</pre></ul>

<a name="nat2.5"></a>
<b>Running</b>

<p>
Spu¹tìní NATu je také velmi jednoduché. Jakmile je jednou konfigurace kompletní, jsou zde dva zpùsoby jak spustit NAT. První je rebootovat OpenBSD stroj.
Je to v¹ak metoda pomìrnì nedeterministická a pro toho kdo si nainstaloval OpenBSD jenom poukazuje na neznalost problematiky.
</p>

<p>
Spu¹tìní ipnat-u z pøikazové øádky docílíte pøíkazy:
</p>

<ul><pre>
# ipf -Fa -f /etc/ipf.rules -E
# ipnat -CF -f /etc/ipnat.rules
</pre></ul>

<p>
První øádek spou¹tí IPF (pamatujte si, ¾e NAT závisí na IPF, proto IPF musí
být spu¹tìn pøed inicializací NATu ). Volby na pøíkazové øádce: "-Fa" vyèistí
filtrovací sadu od ji¾ existujících pravidel, "-f /etc/ipf.rules" øíká ipf,
kde najde filtrovací pravidla, "-E" je pøepínaè spou¹tìjící IPF démona.
</p>

<p>
Druhý øádek spou¹tí NATa. "-CF" sma¾e a instaluje nová pravidla v NAT tabulce.
"-f /etc/ipnat.rules" øíká, kde NAT najde soubor s pravidly. NAT nyní bì¾í.
</p>


<p>
<b>Poznámka:</b> budete-li potøebovat updatovat nastavení NATu (v pøípadì, ¾e
editujete soubor, ale nechcete rebootovat) staèí pøedchozí pøíkaz spustit znovu. Nastavení bude obnoveno s provedenými zmìnami.
</p>

<br>
<a name="nat3.0"></a>
<h3><u>6.3.3 Testování NATu</u></h3>

<br>
<a name="nat3.1"></a>
<b>Kontrola stavu NATu</b>

<p>
Chcete-li zjistit, jak NAT právì pracuje,nebo se ujistit o tom, zda nastavení
jsou funkèní, pou¾ijte volbu "-l". Tato volba vypí¹e seznam v¹ech nastavení
a souèasných spojení, které zpracovává ipnat:
</p>

<ul><pre>
# <b>ipnat -l</b>
map dc0 192.168.1.0/24  -&gt;  24.5.0.5/32 portmap tcp/udp 10000:60000
map dc0 192.168.1.0/24  -&gt;  24.5.0.5/32

List of active sessions:
MAP 192.168.1.40  2473  &lt;-  -&gt;  24.5.0.5  13463 [129.128.5.191 80]
</pre></ul>

<p>
První dva øádky informují o souèasném nastavení NATu, které jste zapsali
do /etc/ipnat.rules ji¾ døíve. Øádek pod nimi ukazuje seznam souèasných spojení,
které NAT kontroluje. 
</p>

<ul>
<b>"MAP 192.168.1.40  2473"</b>
<p>
Toto vám øíká IP adresu stroje na LAN, který pou¾ívá NAT. Port pou¾itý pro toto
spojení je zobrazen za ní.
</p>
</ul>

<ul>
<b>"&lt;- -&gt;"</b>
<p>
Toto ukazuje, ¾e NAT zpracovává spojení v obou smìrech.
</p>
</ul>

<ul>
<b>"24.5.0.5  13463"</b>
<p>
Toto øíká, ¾e spojení jde do internetu pøes IP adresu 24.5.0.5 a port 13463.
</p>
</ul>

<ul>
<b>"129.128.5.191 80"</b>
<p>
IP adresa a port, na který spojení vede jsou vypsány jako poslední.
</p>
</ul>

<a name="nat3.2"></a>
<b> Omezení NATu (v FTP)</b>

<p>
Existuje nìkolik omezení, která s sebou NAT pøiná¹í. Jedním z nich je FTP.
Kdy¾ se u¾ivatel spojí s FTP serverem v Internetu a ¾ádá informace nebo soubory, FTP server vytvoøí spojení s klientem a pøená¹í tyto informace. Spojení probíhá na náhodném volném portu. Toto je problém pro u¾ivatele poukou¹ející se spojit
s FTP serverem zevnitø LAN. Kdy¾ FTP server ode¹le informaci, po¹le ji na náhodný port na externí sí»ové rozhraní. Stroj s NATem ale nemá ¾ádné mapování pro 
neznámý paket a daný port, opustí tedy paket a nedodá jej. 

<p>
Vyøe¹it celý problém mù¾ete tak, ¾e se pøepnete ve FTP klientovi  do "passivního módu". Poté, kdy¾ vytváøíte spojení ven, NAT bude správnì pracovat.
<P>
IP filtr umo¾òuje jiné øe¹ení v této situaci, tj. ftp proxy, která je vestavìna
do kódu NATu. Aktivace dosáhnete tak, ¾e umístíte podobné pravidlo jako je následující pøed va¹e mapování NATu .
<PRE>
map dc0 192.168.1.0/24 -&gt; 24.5.0.5/32 proxy port ftp ftp/tcp
</pre>
S tímto øádkem na svém místì bude kernel hlídat va¹e FTP spojení a v okam¾iku
kdy se v nìm objeví pøíkaz "PORT" pøicházející z ftp klienta, nahradí
IP adresu a port se svou vlastní IP adresou a portem, který si vybere. Potom
otevøe tento port a posílat data pøes tunel na port va¹eho ftp klienta, který
jste po¾adovali. Sice takto docílíte ponìkud pomalej¹ího zpracování paketù, domnívám se ale, ¾e je ve své podstatì zanedbatelné.
ok.
<P>


<br>
<a name="nat3.3"></a>
<b>Pøesmìrování spojení</b>

<p>
Stane se, ¾e potøebujete pøesmìrovat pøíchozí nebo odchozí spojení pro urèitý
protokol nebo port. Dobrý pøíklad tohoto je vá¹ web server nacházející se
uvnitø LAN. Pøíchozí spojení na platnou Internetovu IP adresu v¹ak budou
bez odezvy, proto¾e na stroji s NATem nebì¾í web server. Pro tento úèel
pou¾íváme direktivu NATu 'rdr' v souboru s pravidly, která dává instrukce pro
pøesmìrování urèitého spojení.
</p>

<p>

V na¹em pøípadì pøedpokládejme, ¾e web server se nachází na LAN s IP adresou
192.168.1.80. Soubor s pravidly pro NAT potøebuje novou direktivu, která se
o toto postará. Pøidejte øádku podobnou této do ipnat.rules :
</p>

<ul><pre>
rdr dc0 24.5.0.5/32 port 80 -&gt; 192.168.1.80 port 80
</pre></ul>

<p>
Vysvìtlení:
</p>

<ul>
<b>"rdr"</b>
<p>
Pøíkaz, který dáváte ipnatu. Data na této øádce mají význam pøesmìrování spojení.
</p>
</ul>


<ul>
<b>"dc0"</b>
<p>
Sí»ové rozhraní pøipojené k Internetu.
</p>
</ul>

<ul>
<b>"24.5.0.5/32"</b>
<p>
Pøíchozí spojení na IP adresu vý¹e (pouze na device dc0 )
</p>
</ul>

<ul>
<b>"port 80"</b>
<p>
Port, který má být pøesmìrován. "port 80" mù¾ete nahradit "port www". Pokud
chcete pou¾ít jméno namísto èísla, musí odpovídající název a èíslo existovat
v souboru /etc/services.
</p>
</ul>

<ul>
<b>"192.168.1.80"</b>
<p>
IP adresa a maska stroje na LAN, na který se budou pøesmìrovávat pakety.
Maska je v¾dy "/32" a proto nemusí být uvedena.
</p>
</ul>

<br>
<a name="nat3.4"></a>
<b>NAT versus Proxy</b>

<p>
Rozdíl mezi NATem a aplikaènì zalo¾enou proxy je ten, ¾e proxy software jedná
jako prostøedník mezi Internetem a strojem pøipojeným na LAN. To je v poøádku,
pøesto ka¾dá aplikace, kterou chcete spustit MUSÍ být schopna pou¾ít proxy
server. Ne v¹echny aplikace to doká¾í (obzvlá¹» hry). Dále, nejsou zde proxy
server aplikace pro v¹echny Internetové slu¾by. NAT prùhlednì mapuje va¹i iterní sí», aby mohla být spojena s Internetem. Jediná výhoda, proè pou¾ívat
proxy software narozdíl od NATu je, ¾e proxy software by mìl být bezpeèný a mù¾e
provádìt filtrování na základì obsahu paketù, uchrání tak vá¹ stroj s Windows
od macro viru, mù¾e ochránit od buffer overflowu software klienta a více. 
Pou¾ívání tìchto filtrù je vìt¹inou nároèný úkol.
</p>

<a name="nat4.0"></a>
<b>6.3.4 Odkazy</b>

<p>
Soubory na OpenBSD:
<ul>
<li>/etc/ipnat.rules - pravidla pro NAT
<li>/etc/rc.conf - nutné editovat pro spu¹tìní ipnat a ipf pøi bootu
<li>/etc/sysctl.conf - nutné editovat pro IP forwarding
<li>/usr/share/ipf/nat.1 - pøíklad pravidel pro ipnat.
</ul>
</p>

<p>
NAT Internet Links:
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8&manpath=OpenBSD+2.">http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=8</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&sektion=5&manpath=OpenBSD+2.">Man page showing correct ipnat.rules syntax</a>
<li><a href="http://coombs.anu.edu.au/~avalon/">http://coombs.anu.edu.au/~avalon/</a>
<li><a href="http://www.geektools.com/rfc/rfc1631.txt">http://www.geektools.com/rfc/rfc1631.txt</a>
</ul>
<p>

<br>

<p>
<font color= "#0000e0">
<a href= "index.html">[Zpìt na hlavní stránku]</a>
<a href= "faq6.html">[Zpìt do sekce 6.0]</a>
</font>
</p>

<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../../images/back.gif" border= "0" alt= "[zpìt]"></a>
<a href= "mailto:www@openbsd.org">www@openbsd.org</a>
<small>
<br>
Originally [OpenBSD: faqipf.html,v 1.3 ]
<br>
$Translation: faqipf.html,v 1.2 2002/04/29 17:43:35 certik Exp $
<br>
$OpenBSD: faqipf.html,v 1.2 2002/05/01 08:40:30 jufi Exp $
</small>

</body>
</html>


