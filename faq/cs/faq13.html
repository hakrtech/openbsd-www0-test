<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-2">
<title>13.0 - Pou¾ívaní IPsec</title>
<link rev= "made" href= "mailto:www@openbsd.org">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 2000-2002 OpenBSD">
</head>

<body bgcolor= "#ffffff" text= "#000000"> 
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
<p>


<p>
<h1>13.0 - Pou¾ívání IPsec (IP Security Protocol)</h1>
<ul>
<li><a href="#What">13.1 - Co je IPsec?</a>
<li><a href="#Why">13.2 - To je sice pìkné, ale proè bych mìl pou¾ívat IPsec?</a>
<li><a href="#Protocols">13.3 - Jaké protokoly stojí za IPsec?</a>
<li><a href="#Wire">13.4 - Formát sí»ové vrstvy</a>
<li><a href="#Config">13.5 - Konfigurace IPsec</a>
<li><a href="#ManKey">13.6 - Jak nastavím IPsec s manuálním nastavením klíèù?</a>
<li><a href="#isakmpd">13.7 - Jak nastavím isakmpd?</a>
<li><a href="#x509">13.8 - Jak pou¾iji isakmpd s X.509 certifikáty?</a>
<li><a href="#IKEcl">13.9 - Jací IKE klienti jsou kompatibilní s isakmpd?</a>
<li><a href="#Trouble">13.10 - Ladìní IPsec/VPN</a>
<li><a href="#SeeAlso">13.11 - Dal¹í Dokumentace</a>
</ul>

<p>
<Font size="-1">
Èásti tohoto dokumentu byly pøevzaty z:
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8&format=html">vpn(8)</a>
<li><a href="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPsec for Dummies</a> by Julian Elischer
<li><a href="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a> by Patrick Ethier
<li><a href="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a> by J&ouml;rgen Granstam
</ul>
</font>

<p>
<a name= "What">
<a name= "13.1">
<h1>13.1 - Co je IPsec?</h1>
</a>
<p>
IPsec je mno¾ina roz¹íøení protokolu IP. Poskytuje ¹ifrované bezpeènostní
slu¾by. Tyto slu¾by dovolují autentizaci, celistvost, kontrolu pøístupu a
dùvìryhodnost. IPsec poskytuje podobné slu¾by jako SSL, ale na sí»ové vrstvì,
tak, aby v¹e bylo maximálnì transparentní vzhledem k va¹im aplikacím a navíc o
mnoho mocnìj¹í. Toto øíkáme proto, ¾e va¹e aplikace vùbec nemusí vìdìt, ¾e
IPsec existuje aby ho mohly pou¾ívat. 
Pøes IPsec mù¾ete pou¾ít
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.8">jakýkoliv IP protokol</a>.  
Mù¾ete vytváøet ¹ifrované tunely (VPN) nebo mù¾ete jenom ¹ifrovat
komunikaci mezi dvìma poèítaèi. Je spousta mo¾ností jak to udìlat, IPsec
je docela komplexní (mnohem více ne¾ SSL!)
<p>
Ne¾ zaènete IPsec pou¾ívat, dùraznì doporuèujeme abyste si pøeèetli
"doporuèenou literaturu" z  <a href="faq6.html">èásti 6</a> FAQ.
Napøíklad, pokud je¹tì nerozumíte IP adresaci, dùraznì doporuèujeme
abyste si pøeèetli:
<a href="http://www.3com.com/nsc/501302s.html">Understanding IP
Addressing</a>.
<p>
V logickém smyslu pracuje IPsec následujícími tøemi zpùsoby:
<ul>
<li>Host-to-Host
<li>Host-to-Network
<li>Network-to-Network
</ul>
V ka¾dém scénáøi, který zahrnuje sí», budeme pøedpokládat router.
Napøíklad v Host-to-Router (a tento router øídí a ¹ifruje provoz pro
danou <i>Sí»</i>.)
<p>
Jak mù¾ete vidìt, IPsec mù¾e být pou¾it k tunelování provozu pro VPN
konekce.  Navíc ale jeho schopnosti sahají daleko za pouhé pou¾ití pro
VPN. S centrální "Internet Key Exchange" databází mù¾e ka¾dý stroj na
internetu komunikovat s jiným a pou¾ívat silnou autentizaci a ¹ifrování!
<p>

<a name= "Why">
<a name= "13.2">
<h1>13.2 - To je sice pìkné, ale proè bych mìl pou¾ívat IPsec?</h1>
</a>
<p>
Internetový protokol, IP, neboli IPv4 nezahrnuje ¾ádnou ochranu
pøená¹ených dat. Dokonce ani negarantuje pravost odesílatele. IPsec se
pokou¹í toto poskytnout. Tyto slu¾by se mohou zdát nesouvisející, ale
IPsec se je pokou¹í podporovat spoleènì.
<p>
<h4>Dùvìryhodnost</h4> Ujistìte se, ¾e kdokoli kromì pøijímací strany
nebude rozumìt datùm, která procházejí v rámci komunikace. Nechcete aby
nikdo vidìl va¹e hesla, kdy¾ se logujete na vzdálený stroj pøes
Internet.
<p>
<h4>Integrita</h4> Ujistìte se, ¾e va¹e data nebudou po cestì zmìnìna.
Jestli¾e pøená¹íte fakturaèní data budete asi chtít, aby byly èástky a
èísla kont byly správnì a nebyly bìhem pøenosu zmìnìny.
<p>
<h4>Pravost</h4> Podepi¹te svoje data tak¾e ostatní budou mít mo¾nost
vidìt, ¾e jste to opravdu vy, kdo je vyslal. Je to urèitì pìkné vìdìt,
¾e dokumenty nejsou zfal¹ovány.
<p>
<h4>Ochrana proti Replay útokùm</h4> Potøebujeme zpùsoby jak zajistit,
aby transakce byla pøenesena a my jsme byli jediná entita, která mù¾e
pøenos zopakovat. Tzn. nemìlo by být mo¾né, aby byla transakce zachycena
nìkým jiným a pak vìrnì pøehrána tak, aby druhá, s námi komunikující
strana dostala nìkolik stejných datových sekvencí. Uva¾ujme, ¾e jedninou
cestou, jak se útoèník mù¾e dozvìdìt, co komunikace skuteènì obsahuje,
je prolomit ¹ifru a ¾e provoz zpùsobuje události pro nìj zajímavé, napø.
vkládání penìz na jeho úèet.  Chtìli bychom se tedy ujistit, ¾e nemù¾e
jednodu¹e tento provoz opakovat nìkdy pozdìji.
<i>
VAROVÁNÍ: podle specifikace není ochrana proti replay útokùm pou¾ívána,
kdy¾ v IPsec pou¾íváte manuální nastavení klíèù (tzn. kdy¾ pou¾íváte 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>)</i>.
<p>

<a name= "Protocols">
<a name= "13.3">
<h1>13.3 - Jaké protokoly stojí za IPsec?</h1>
</a>
<p>
IPsec poskytuje dùvìryhodnost, integritu, autenticitu a ochranu proti
replay útokùm pøes nové dva protokoly. Tyto protokoly se nazývají AH -
"Authentication header" a ESP - "Encapsulated security payload".
<p>
AH poskytuje autentizaci, integritu a zaji¹»uje ochranu proti replay
útokùm (ale ne dùvìryhodnost). Hlavní rozdíl od ESP je v tom, ¾e AH také
zabezpeèuje èásti hlavièky IP (jako napø. zdrojovou/cílovou adresu).
<p>
ESP mù¾e poskytovat autentizaci, integritu, ochranu proti replay útokùm
a dùvìryhodnost dat (zabezpeèuje v¹e co v paketu následuje za hlavièkou)
Ochrana proti replay útokùm vy¾aduje autentizaci a integritu (tyto dvì
jdou v¾dycky spolu).  Dùvìryhodnost (¹ifrování) mù¾e být pou¾ita bez
nebo s autentizací/integritou. Podobnì mù¾ete pou¾ít
autentizaci/integritu bez dùvìryhodnosti.
<P>
<a name= "Wire">
<a name= "13.4">
<h1>13.4 - Formát sí»ové vrstvy</h1>
</a>

<P>The <B>Authentication Header</B>
(AH) je za základní IP hlavièkou a obsahuje kryptografické hashe dat a
informace o identifikaci. Tyto hashe mohou také pokrývat rùzné èásti IP
hlavièky samotné. Existují RFC, která dávají na výbìr z nìkolika
algoritmù, které se mohou v AH pou¾ít, nicménì v¹echny musí splòovat
pravidla popsaná v:
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC2402</A>.

<P><B>Encapsulating
Security Payload</B> (ESP) hlavièka, dovoluje pøepsání payloadu v
¹ifrované formì. ESP hlavièka nepokrývá èásti IP hlavièky, tak¾e
garantuje pouze to, co je obsa¾eno v datové èásti (payloadu).  Rùzné
typy ESP musí splòovat
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</a>.
ESP hlavièka mù¾e také poskytovat autentifikaci pro payload (ale ne pro
"venkovní" hlavièku.

<P>Funkcionalitu IPsecu mù¾eme rozdìlit témìø ortogonálnì - podle toho,
který koncový bod podílející se na IPsec komunikaci je originální zdroj
dat nebo gateway.

<UL>
<LI><B>Transportní</B> mód je pou¾íván pro generování paketù. V
transportním módu jsou security hlavièky pøidány pøed hlavièky
transportní vrstvy (napø.  TCP, UDP), pøedtím ne¾ je IP hlavièka
pøipojena k výslednému paketu.  Jinými slovy bude pøidání AH k paketu
hashovì pokrývat TCP hlavièku a nìkterá pole z IP hlavièky, ESP bude
pokrývat data, ale ne IP hlavièku od zaèátku do konce.
</LI>

<LI><B>Tunnelovací</B> mód je pou¾it kdy¾ u¾ je IP hlavièka pøipojena k
paketu a jeden z koncù komunikace je pouze gateway. V tomto módì
pokrývají AH a ESP celý paket vèetnì hlavièky od zaèátku a¾ do konce.
Nová IP hlavièka je pøipojena k paketu a je pou¾ita pouze pro dal¹í
"hop" v bezpeèné komunikaci (který¾to mù¾e být vzdálen klidnì nìkolik IP
hopù).
</LI>
</UL>

<P>Linky zabezpeèené pomocí IPsec jsou definované v termínech
<B>Security Associations </B>(SAs).  Ka¾dý SA je definován jako
jednoduchý nesmìrový tok dat a obvykle (ignorujeme-li multicasty) od
jednoho konce k druhému, pokrývající traffic rozpoznatelný podle
nìjakého <B>unikátního selektoru</B>. S ve¹kerým trafficem tekoucím pøes
jednoduchý SA bude nakládáno stejnì. Traffic urèitého druhu by mohl
podléhat nìkolika SA subjektùm, ka¾dý z nich provádìjící nìjakou
transformaci. Skupiny SA se nazývají SA <B>Bundle</B>.  Pøicházející
pakety mohou být pøiøazeny k urèitému SA podle tøi definujících polí,
(<B>Cílová IP adresa, Security Parameter Index, bezpeènostní
protokol</B>). SPI mohou být pova¾ovány za cookie, která je vydávána
pøijímaèem SA v prùbìhu vyjednávání parametrù konekce. Bezpeènostní
protokol musí být buï AH nebo ESP. A proto¾e IP adresa pøijímaèe je èást
této trojice, je tato hodnota unikátní. Dají se nalézt z venkovní IP
hlavièky a z první bezpeènostní hlavièky (která obsahuje SPI a
bezpeènostní protokol).

<P>Pøíklad tunelovacího módu AH paketu: 
<p>
<table border="1">
<tr>
<td><B>IPhdr</B></td>
<td><B>AH</B></td>
<td>IPhdr2</td>
<td>TCPhdr</td>
<td>data</td>
</tr>
</table>

<P>Pøíklad transportního módu AH paketu je: 
<p>
<table border="1">
<tr>
<td><B>IPhdr</B></td>
<td><B>AH</B></td>
<td>TCPhdr</td>
<td>data</td>
</tr>
</table>

<P>Proto¾e ESP hlavièka nemù¾e autentizovat IP hlavièku, je u¾iteèné
pou¾ít kombinaci AH a ESP hlavièky, abyste dostali následující:
<p>
<table border="1">
<tr>
<td><B>IPhdr</B></td>
<td><B>AH</B></td>
<td><B>ESP</B></td>
<td><I>TCPhdr</I></td>
<td><I>data</I></td>
</tr>
</table>

<P>Toto je nazýváno <B>Transport Adjacency</B>. Tunelovací verze by mohla
vypada následovnì:
<p>
<table border="1">
<tr>
<td><B>IPhdr</B></td>
<td><B>AH</B></td>
<td><B>ESP</B></td>
<td><I>IPhdr2</I></td>
<td><I>TCPhdr</I></td>
<td><I>data</I></td>
</tr>
</table>

<P>Jakkoli to nemusí být zmínìno v RFC. S ¨Transport adjacency" by se
autentizoval celý paket vyjma pár hlavièek v IP hlavièce a taky by se
¹ifroval payload (zobrazeno kurzívou). Kdy¾ jsou AH a ESP hlavièka
aplikovány pøímo spoleènì, poøadí hlavièek bude takové, jako je vidìt na
obrázku. V tunelovacím módu je mo¾né pou¾ít rekursivní zapouzdøení tak,
¾e poøadí není urèeno.

<a name="Config">
<a name="13.5">
<h1>13.5 - Konfigurace IPsec</h1>
</a>

<P>Jak budou IPsec systémy a  gatewaye nakonfigurovány je do urèité míry
necháno na návrháøi, nicménì RFC obsahuje urèitá dùrazná doporuèení jak
by to mìlo být implementováno, co¾ by mìlo zamezit zmatkùm.

<P>Existují dvì hlavní administrativní entity které kontrolují co se s
paketem stane. Jedna je <B>Security Association Database</B> (SAD,
zmiòovaná jako TDB nebo TDB tabulka v IPsec kódu OpenBSD) a druhá je
<B>Security Policy Database</B> (SPD).

<P>Obì jsou podobné co se týèe poètu selektorù, které popisují nìkterý
traffic, dodají záznam, který pøedepisuje potøebné zpracování. Nicménì
SPD je dva kroky vzdálena od vlastního zpracování: SPD je u¾ívána pro
odchozí pakety, k rozhodnutí jaké záznamy SAD popisují aktuální
zpracování a jeho parametry.  Záznamy SPD urèují stávající SAD záznamy k
pou¾ití (pokud je to bundle, mù¾e být více ne¾ 1), ale jestli¾e jeden
není zrovna k dispozici, je pou¾it k vytváøení nových. Pole v SA, která
jsou vytváøena jsou brána jednak ze záznamu SPD nebo z paketu, který
inicoval vytváøení.

<P>Odchozí pakety jdou ze záznamu SPD ke specifické SA aby obdr¾ely
enkódovací parametry. Pøíchozí pakety se dostanou ke správnému SA pøímo
u¾itím trojice SPI/DestIP/Proto a odtud jdou k záznamu SPD.

<P>SPD mù¾e být specifikovat jaký traffic by mìl procházet IPsecem a
jaký by mìl být zahazován, tak¾e to musí být také konzultováno s
pøicházejícím ne-IPsec trafficem, záznamy SPD musí být explicitnì
seøazeny aby bylo zpracování reprodukovatelné.

<P>SPD mù¾e být pokládáno za podobné paket filtru kde rozhodování o
jednotlivých.  akcích jsou vlastnì aktivace SA procesù. Selektory mohou
zahrnovat zdrojovou a cílovou adresu, èísla portù a pokud je to dùle¾ité
i èísla portù, ID aplikace a u¾ivatele pokud jsou k dispozici (pouze v
SA který je asociován se serverem), hostname, security sensitivity
úrovnì, protokoly, atd.

<P>Záznam SAD by mìl zahrnovat:

<UL>
<LI>Dest IP address
<LI>IPsec proto (AH or ESP)
<LI>SPI (cookie)
<LI>Sequence counter
<LI>Seq O/F flag
<LI>Anti-replay window info
<LI>AH type and info
<LI>ESP type and info
<LI>Lifetime info
<LI>Tunnel/transport mode flags
<LI>Path MTU info
</UL>

<P>Záznam SPD by mìl obsahovat:

<UL>
<LI>Pointer to active SAs
<LI>Selector fields
</UL>

<P>Ka¾dá SA mù¾e definovat jednu ESP a jednu AH hlavièku.  IPsec session
musí mít jednu nebo druhou nebo obì, ale nemù¾e být definována bez ¾ádné
- jinak by nebyly k dispozici hlavièky potøebné ke specifikaci SPI a
  hledání SA. RFC neøíká nic co by se mìlo stát kdyby se hlavièky AH a
ESP neshodly na hodnotì SPI. Dalo by se pøedpokládat, ¾e by to mìlo
implikovat nìkolik SA asociací v bundle.

<P>SPD v OpenBSD  je ovládáno pøes pøíkaz <tt>ipsecadm flow</tt>.
(zmìny budete chtít dìlat jenom v pøípadì, ¾e budete chtít pou¾ít
manuální nastavení klíèù).
Záznamy SAD mohou být nastaveny ruènì s
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>,
nicménì IETF také definovalo automatický mechanismus pro inicializaci
session a podobných vìci jako je výmìna klíèù.
OpenBSD implementuje automatickou výmìnu klíèù ISAKMP
(<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC2407</a>,
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC2408</a> a
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC2409</a>)
v démonu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8">isakmpd(8)</a>.
<P>
<a name= "ManKey">
<a name= "13.6">
<h1>13.6 - Jak nastavím IPsec s manuálním nastavením klíèù?</h1>
</a>
<P>
Manuální nastavení klíèù je nejjednodu¹¹í cesta jak zaèít s IPsecem.
Mù¾ete si nastavit ¹ifrování mezi sítìmi a vytváøet VPN pou¾itím této
metody.  A¾ doètete tuto sekci, mo¾ná budete chtít projít toto:

<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">/usr/share/ipsec/rc.vpn</a>
co¾ by mìlo vìci nastavit za vás.
<P>
Nejdøíve budete potøebovat zapnout volby IP AH a IP ESP v konfiguraci
OpenBSD kernelu (pokud budete pou¾ívat ESP, jako napø, v skriptu rc.vpn
nebo s pøíklady uvedenými ní¾e, <i>nebudete potøebovat zapínat AH</i>.
Pokud zapnete AH a nebudete jej pou¾ívat, mù¾e to být z hlediska
security nebezpeèné.
 
<P>
Existuje pìkný sysctl pro zapnutí tìchto protokolù:
<ul><tt>
# <b>sysctl -w net.inet.esp.enable=1</b><BR>
net.inet.esp.enable: 0 -&gt; 1<br>
# <b>sysctl -w net.inet.ah.enable=1</b><br>
net.inet.ah.enable: 0 -&gt; 1
</tt></ul>
Mù¾ete zeditovat <tt>/etc/sysctl.conf</tt>, aby se tyto zapínaly po
bootu.  Budete potøebovat odstranit znak # pøed net.inet.esp.enable
a/nebo net.inet.ah.enable (zále¾í na to, jaký chcete pou¾ívat) a
ujistìte se, ¾e jsou nastaveny na hodnotu 1.
<P>
Také budete potøebovat vygenerovat va¹e klíèe. Proto¾e je bezpeènost VPN
zalo¾ena na nerozlousknutelnosti tìchto klíèù je velmi dùle¾ité, aby
byly klíèe odvozeny u¾itím silného generátoru náhodných èísel. Jednou
praktickou metodou mù¾e být pou¾ití zaøízení
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=random&sektion=4&format=html">random(4)</a>
To vyprodukuje 160 náhodných bitù, napøíklad, udìlejte:
<UL><tt>
# <b>dd if=/dev/urandom bs=1024 count=1 | sha1</b>
</TT></UL>

Poèet vyprodukovaných bitù je dùle¾itý, proto¾e rùzné ¹ifry mohou
vy¾adovat klíèe které jsou rùné délky.
<PRE>
Cipher    Délka klíèe
DES       56 bitù
3DES      168 bitù
BLF       Promìnná (40-160, doporuèeno 160 bitù)
CAST      Promìnná (40-128, doporuèeno 128 bitù)
BLF       Promìnná (doporuèeno 160 bitù)
CAST      Promìnná (doporuèeno 40-128 bitù)
SKIPJACK  80 bitù
</PRE>
<P>
Teï budete potøebovat nastavit SA, neboli Security Associations.  SA je
kombinace va¹í IP adresy, SPI a va¹eho security protokolu (AH a/nebo
ESP). IP adresy jsou va¹e a va¹eho cíle. SPI, Security Parameter Index
je èíslo, které OpenBSD pou¾ívá ke klasifikaci rùzných SA.
<P>
<I>Následující pøíklady ukazují u¾ití ESP k ¹ifrování va¹eho trafficu.
ESP zahrnuje autentizaci ¹ifrovaných dat, ale neautentizuje okolní IP
hlavièku jako to dìlá AH. Tato "omezená autentizace" je nicménì v mnoha
pøípadech dostaèující, hlavnì pro ESP v tunelovacím prostøedí.
</I>
<P>
<ul>
<tt>
# <b>ipsecadm new esp -spi SPI_OUT -src MY_EXTERNAL_IP -dst PEER_EXTERNAL_IP
-forcetunnel -enc blf -auth sha1 -key ENC_KEY -authkey AUTH_KEY</b>
</tt>
</ul>
<P>
Pojïme to realizovat se dvìma routery, 192.168.5.1 a 192.168.25.9.
<P>
Na 192.168.5.1:
<UL>
<TT>
# <b>ipsecadm new esp -spi 1000 -src 192.168.5.1 -dst 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b><BR>
# <b>ipsecadm new esp -spi 1001 -dst 192.168.5.1 -src 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</TT>
</UL>
Na 192.168.25.9:
<UL>
<TT>
# <b>ipsecadm new esp -spi 1001 -src 192.168.25.9 -dst 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b><BR>
# <b>ipsecadm new esp -spi 1000 -dst 192.168.25.9 -src 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</TT>
</UL>
<P>
V¹imnìte si, ¾e SPI jsou rùzná. V sekci <a href="#Wire">On the wire
format</a> je kompletní popis toho, co to je SPI a jak je pou¾it.
<P>
Teï jsou SA umístìny, zbývá nastavit jednotlivé toky (flows).
<P>
Na 192.168.5.1:
<P>
Zde nastavíme <b>dva</b> toky, které budou vytvoøeny, jeden s lokální
zdrojovou adresou, která bude pokrývat v¹echny pakety odcházející z
local hostu na cíl a také to od cíle smìøovaný na lokální host.
<ul>
<tt>
# <b>ipsecadm flow -proto esp -dst 192.168.25.9 -spi 1000
-addr 192.168.5.1 255.255.255.255 192.168.25.9 255.255.255.255</b>
</tt></ul>
Na 192.168.25.9:
<ul>
<tt>
# <b>ipsecadm flow -proto esp -dst 192.168.5.1 -spi 1001
-addr 192.168.25.9 255.255.255.255 192.168.5.1 255.255.255.255</b>
</tt></ul>
<P>
Pokud chcete ve va¹ich Host-to-Host VPN sítích men¹í overhead (sí»ovou
re¾ii), vytvoøení SPI bez <tt>-forcetunnel</tt> vám dovolí pou¾ít
transportní mód (zatímco pøi pou¾ití <tt>-forcetunnel</tt> budou v¹echny
IP pakety, vèetnì IP hlavièky zapouzdøeny pomocí SPI). Jestli¾e buï zdroj
nebo cíl jsou sí», budete muset pou¾ít tunel mód. Vytvoøení SA k a/nebo
síti automaticky zajistí vytvoøení SPI v tunel módu.
<p>
Toto je jednoduchá cesta jak zaèít pou¾ívat IPsec.
<P>
Mù¾ete pou¾ít IPsec k tunelování privátních IP adres pøes Internet. Zde
je dobrý pøíklad.. Chceme tunelovat 192.168.99.0/24, co¾ je za
208.1.1.1, na 208.1.2.0/24 a 208.1.5.0/24 které jsou za 208.2.2.2.  Tyto
pøíklady byly vygenerovány u¾itím skriptu
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">rc.vpn</a>.
<P>
Jak mù¾ete vidìt, kdy¾ pou¾íváte manuální vytváøení klíèù s IPsecem,
musíte <b>pøesnì</b> specifikovat co chcete udìlat. Nic nebude hádat za
vás. Podívejte se na následující pøíklady: 
<h2>Na 208.1.1.1:</h2>
Nejdøíve nastavte SA asociace:<BR>
(To nastaví SPI, ¹ifrovací metody a klíèe.)
<UL><tt>
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
</tt></ul>
Dále nastavte tok z 208.1.1.1 na 208.2.2.2
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.2.2.2 255.255.255.255</b><br>
</tt></ul>
Dále tok z 208.1.2.0/24, která je za 208.2.2.2, na 192.168.99.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.2.0 255.255.255.0</b><BR>
</tt></ul>
Dále tok z 208.1.5.0/24, která je za 208.2.2.2, na 192.168.99.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.5.0 255.255.255.0</b><br>
</tt></ul>
Teï tok z 208.1.2.0/24, která je za 208.2.2.2 na router 208.1.1.1.
<ul><tT>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.2.0 255.255.255.0</b><br>
</tt></ul>
OK, nastavte tok z 208.1.5.0/24, která je za 208.2.2.2, na router 208.1.1.1
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.5.0 255.255.255.0</b><br>
</tt></ul>
Nakonec nastavte tok z routeru 208.2.2.2 na 192.168.99.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.2.2.2 255.255.255.255</b><br>
</tt></ul>
<P>
<h2>On 208.2.2.2:</h2>
To samé jako pøedtím, nastavíme SA asociace...
<UL><TT>
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
</tt></ul>
Toto je protìj¹í strana.
Nastavte tok z routeru 208.2.2.2 na 208.1.1.1
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 208.1.1.1 255.255.255.255</b><br>
</tt></ul>
Nastavte tok ze sítì 192.168.99.0/24, která je za 208.1.1.1, na 208.1.2.0/24
<ul><tT>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 192.168.99.0 255.255.255.0</b><br>
</tt></ul>
Nastavte tok ze sítì 192.168.99.0/24, která je za 208.1.1.1, na
208.1.5.0/24
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 192.168.99.0 255.255.255.0</b><br>
</tt></ul>
Teï nastavte tok ze sítì 192.169.99.0/24, která je za 208.1.1.1, na
router 208.2.2.2 <ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 192.168.99.0 255.255.255.0</b><br>
</tt></ul>
U¾ jsme skoro hotovi...
Dva toky zbývají abychom dostali 208.1.2.0/24 a 208.1.5.0/24 z routeru
208.2.2.2 na router 208.1.1.1.
<ul><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</b><br>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</b><br>
</tt></ul>
<P>
Pokud jste pou¾ívali ipsecadm a chcete se zbavit v¹eho co jste vytvoøili
a zaèít od zaèátku, spus»te
<ul><tt>
# <b>ipsecadm flush</b>
</tt></ul>
To z va¹eho systému vyèistí ve¹keré IPsec info (SPI, toky, routovací
záznamy).

<P>
<a name="isakmpd"> 
<a name="13.7"> 
<h1>13.7 - Jak nastavím isakmpd?</h1>
</a>
<P>Pokud zamý¹líte pou¾ít VPN nebo jiné klasické aplikace IPsecu, budete
pravdìpodobnì chtít pou¾ít ISAKMP. Nìkteré komerèní implementace IPsecu
neposkytují manuální nastavení klíèù, namísto toho vy¾adují nìjakou
formu ISAKMP.
<P>

<h3>13.7.1 - Co je isakmpd?</h3> ISAKMP (nìkdy zmiòované v souvislosti s
IKE, nebo Internet Key Exchange) je mechanismus výmìny klíèù pro VPN.
Splòuje po¾adavky RFC 2407, RFC 2408 a RFC 2409. ISAKMP zvládá výmìnu
kryptografických klíèù kterou byste normálnì zvládli s
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8">ipsecadm(8)</a>.
To zahrnuje dvou fázový proces pro nastavení parametrù IPsec mezi dvìma
IPsec uzly.

<P>
<b>Fáze 1</b> - Dva ISAKMP peers sestaví bezpeèný, autentizovaný
kanál pomocí kterého budou komunikovat dva démoni. To nastaví Security
Association (SA) mezi dvìma stroji. <b>MainMode</b> a <b>Aggressive
Mode</b> jsou dvì metody, které mohou být pou¾ity k nastavení tohoto
kanálu.  Main Mode posílá rùzné autentizaèní informace v urèité
sekvenci, posyktuje ochranu identity. Aggressive Mode neposkytuje
ochranu identity proto¾e v¹echny autentizaèní informace jsou posílány v
ten samý èas. Aggressive mode by normálnì mìl být pou¾íván pouze v
pøípadì, kde ¹íøka pásma (bandwidth) je limitující faktor.

<P>
<b>Fáze 2</b> - Nastaveny jsou Security Associations. 
Fáze 2 nastaví tunely a koncové body SA mezi jednotlivými IPsec stroji.
<b>Quick Mode</b>  je pou¾íván ve Fázi 2 proto¾e není potøeba opakovat
celou autentizace proto¾e Fáze 1 u¾ nastavila SA asociace.

<P>
Jednodu¹e øeèeno, Fáze 1 je pou¾ita k nastavení bezpeèného kanálu ve
kterém bude (rychleji) provedeno nastavení Fáze 2. V rámci jednoho
kanálu Fáze 1 mù¾e být více nastavení Fáze 2. Fáze 2 je pou¾ita k
nastavení vlastních tunelù. Ve fázi 1 je ustavena konekce mezi va¹imi
IPsec stroji kde si stroje vymìní autentizaèní informace. (buï X.509
certifikát nebo pøed-sdílený tajný klíè).  To dovoluje ka¾dému konci
ujistit se, ¾e druhý konec je autentizován. Fáze 2 je výmìna klíèù,
která je potøebná k zaji¹tìní ¹ifrovaného spojení mezi dvìma konci.

<h3>13.7.2 - Jak zaènu pou¾ívat isakmpd?</h3>

<P>OpenBSD má v sobì defaultnì potøebné binárky pro ISAKMP a IPsec.
Nane¹tìstí soubory s pøíklady si budete muset stáhnout sami. Budete
potøebovat: /usr/src/sbin/isakmpd/samples/VPN-east.conf a
/usr/src/sbin/isakmpd/samples/policy ze source tree. Mù¾ete buï pou¾ít
CD (pokud jej máte),  
<a href="http://www.openbsd.org/cgi-bin/cvsweb/">cvsweb</a>, nebo
<a href="http://www.usa.openbsd.org/anoncvs.html">command line CVS
klienta</a>. (Cvsweb obsahuje
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/VPN-east.conf">VPN-east.conf</a>
a <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/policy">policy</a>).
Pro úèely tohoto pøíkladu zkopírujte <i>policy</i> do
/etc/isakmpd/isakmpd.policy.  Zkopírujte <i>VPN-east.conf</i> do
/etc/isakmpd/isakmpd.conf.  Zde se pokusíme ukázat vám jak nastavit VPN
(tunel). Jestli¾e chcete pou¾ívat isakmpd mezi jednotlivými hosty,
existují jiné konfiguraèní soubory v adresáøi <i>samples</i>.
Manuálové stránky obsahují detailní informace.. Nezapomeòte na
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a> a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>.

<P>
První krok je zapnout esp. Podívejte se na
<a href="#13.6" TARGET="_blank">vr¹ek sekce 13.6</a> jak to udìlat za
bìhu a pøi bootu.  Dále budete potøebovat editovat /etc/isakmpd/isakmpd.policy.
Tento soubor øíká ISAKMP kdo mù¾e pøistupovat pøes IPsec. V tomto
scénáøi deklaruje policy soubor ¾e komukoliv kdo posílá data u¾itím
Encapsulate Security Payload(ESP) a je autentizován pomocí hesla
mekmitasdigoat (nebo jakéhokoliv hesla , které si zvolíte) je povolen
pøístup ke komunikaci pomocí isakmpd. Tento soubor mù¾ete modifikovat,
aby se ISAKMP pou¾íval tak, ¾e data budou podepsána urèitým
digitálním certifikátem nebo u¾itím kryptografické transformace. Mohli
byste také povolit pøístup k IPsec úplnì ka¾dému. To je doporuèeno pouze
pro testovací úèely. Abyste to mohli udìlat, upravte vá¹ policy soubor,
aby obsahoval následující øádky:

<BR>
<UL><PRE>
KeyNote-Version: 2
Authorizer: &quot;POLICY&quot;
</PRE></UL>
<P>
Ten samý policy soubor obsahuje dvì øádky zaèínající znakem $.
Budete potøebovat tyto dvì øádky odstranit, proto¾e slou¾í pouze pro
úèely cvs.
<P>
Více u¾iteèný policy soubor pro tento pøíklad by mohl vypadat nìjak takhle:
<BR><UL><PRE>
KeyNote-Version: 2
Comment: Tato politika akceptuje ESP SA asociace ze vzdáleného konce pouze pøi
pou¾ití správného hesla
Authorizer: &quot;POLICY&quot;
Licensees: &quot;passphrase:mekmitasdigoat&quot;
Conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; -&gt; &quot;true&quot;; 
</pre></UL>
Implementace tohoto vám vytvoøí základní VPN (tunel), který pou¾ívá
pouze ESP.  Na stroji A zeditujte /etc/isakmpd/isakmpd.conf. 249.2.2.2
IP adresa by mìla být nahrazena vnìj¹í adresou stroje A.

<UL><PRE>
[General] 
Retransmits=		5
Exchange-max-time=	120
Listen-on=		249.2.2.2
</PRE></UL>

Zeditujte podobnì isakmpd.conf na stroji B. 249.3.3.3 pøedstavuje vnìj¹í
IP adresu na stroji B.

<UL><PRE>
[General]
Retransmits=		5
Exchange-max-time=	120
Listen-on=		249.3.3.3
</PRE></UL>

<p>Toto je místo kde mù¾ete nastavit v¹echny promìnné které budou
ovlivòovat chování isakmpd. Je v poøádku nechat tam defaultní hodnoty.

Hodnota <b>Listen-on</b>= urèuje IP adresu na které bude isakmpd
poslouchat.  K tomu je vy¾adována pouze Internetová IP adresa va¹í
gatewaye, mohli byste vypsat v¹echna rozhraní, na kterých budete
chtít, aby isakpmd poslouchal. To udìláte tak, ¾e je napí¹ete za sebe
oddìlené èárkami.

<P>
Dále, na stroji A, zeditujete znova isakmpd.conf.

<UL><PRE>
[Phase 1]
249.3.3.3=		HostB
</PRE></UL>

On host B:

<UL><PRE>
[Phase 1]
249.2.2.2=		HostA
</PRE></UL>

<p>
Tato sekce popisuje IP adresy, které budou akceptovány v rámci
vytvoøení konekce pro Fázi 1. Tyto hodnoty ukazují na následující
sekci. (Uvìdomte si, ¾e Fáze 1 jednodu¹e autentizuje vzdálené konce aby
se zajistilo, ¾e jsou ti, za které se vydávají). Mù¾ete uvést nìkolik
koncù v dal¹ích øádcích ve formátu IP_Address=<i> &lt;PEER-NAME&gt;.</i>

<p>
Dále na stroji A:
<UL><PRE>
[Phase 2]
Connections=		HostA-HostB
</PRE></UL>

Na B:

<UL><PRE>
[Phase 2]
Connections=		HostB-HostA
</PRE></UL>

<p>Toto popisuje Fázi 2, co¾ je fáze která urèuje jaké protokoly budou
tyto dva konce pou¾ívat ke komunikaci. 

<p>Tag <b>Connections</b>= se odkazuje na sekci dole.  To iniciuje
po¾adavky nebo akceptovatelné metody pro Fázi 2. Zároveò to øíká ISAKMP
které konekce iniciovat po startu. Uvìdomte, si ¾e mù¾ete pou¾ít víc
sekcí jak je pøedvedeno ní¾e s tím, ¾e mù¾ete propojit nìkolik rùzných
koncù. 

<p>Pokud neznáte IP adresu vzdáleného stroje, mù¾ete specifikovat
Default= který bude ukazovat na sekci popisující obecný záznam, který
bude odkazovat na ka¾dou pøíchozí IP adresu, která není vylistována v
tagu <b>Connections</b>=. 

<P>
Na A:
<UL><PRE>
[HostB]
Phase=			1
Transport=		udp
Local-address=		249.2.2.2
Address=		249.3.3.3
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat
#Flags=
</PRE></UL>

Na B:

<UL><PRE>
[HostA]
Phase=			1
Transport=		udp
Local-address=		249.3.3.3
Address=		249.2.2.2
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat
#Flags=
</PRE></UL>

Tyto reprezentují sekce zmiòované ve Fázi 1 vý¹e. Ka¾dá popisuje
po¾adavky na sousední gateway které musí splòovat aby se mohla
uskuteènit Fáze 2.  Existuje mnoho jiných mo¾ností, ty zmínìné vý¹e jsou
nezbytným minimem. 
<ul>
<li><b>Phase=1 </b>je po¾adována proto¾e kód ISAKMP pou¾ívá ty samé
procedury ke pracování Fáze 1 a fáze 2. Musí to být <b>1</b>, nic jiného
nebude pracovat.
<li><b>Transport= </b> vám dává rùzné mo¾nosti pro rùzné sousedy.
Navrhujeme aby zde bylo pou¾ito udp, tak¾e to tak necháme.  Uvìdomte si,
¾e nìkteøí sousedi mohou být za firewallem, který nepropustí UDP provoz.
To musí být zøejmì zji¹tìno pøed pøed procesem nastavování.

<li><b>Local-address </b>je cílová adresa na kterou budou ukazovat
pøicházející pakety. V nìkterých pøípadech mù¾ete poslouchat na rùzných
rozhraních, abyste nastavili konekce pro Fázi 1.  V tomto pøíkladì
poslouchá pouze 1 rozhraní, tak¾e je to IP adresa poslouchajícího
rozhraní.
<li><b>Address= </b>je adresa která ukazuje na zdroj IP pøicházejících
paketù. Toto obvykle ukazuje na sousední gateway.  Toto potøebuje dal¹í
vysvìtlení, proto¾e zdrojová IP adresa souseda nemusí být známá!

<li><b>Configuration= </b>ukazuje na sekci uvedenou ní¾e. mù¾ete
nastavit nìkolik sekcí jako je tato. Pou¾íváme tu defaultní, která byla
specifikovaná ve souboru s pøíklady. 
<li><b>Authentication=</b> je pøed-sdílený tajný klíè který je pou¾it
pro tohoto souseda. Je to více ménì passphrase, kterou pou¾ívají oba
sousedi. Tato passphrase je pøedána politice k verifikaci, jestli je
tomuto sousedovi povoleno pou¾ívat IPsec s tímto strojem. Pokud zmìníte
passphrase, musíte zároveò zeditovat policy soubor, proto¾e tento soubor
s pøíklady obsahuje tuto passphrase. Pokud jste se rozhodli pou¾ít
minimální policy soubor, pak si tam mù¾ete nastavit cokoliv chcete. 
<li><b>Flags=</b>nejsou v souèasné dobì pou¾ívány. RFC ponechávají
dostatek prostoru pro extra mo¾nosti pro Fázi 1. 
<p>Existují dal¹í tagy, které vám dovolí nastavit dal¹í mo¾nosti.
Podívejte se na 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>
pro jejich popis. 
</ul>
<P>
Na A:
<UL><PRE>
[HostA-HostB]
Phase=			2
ISAKMP-peer=		HostB
Configuration=		Default-quick-mode
Local-ID=		Net-A
Remote-ID=		Net-B
</PRE></UL>

Na B:
<UL><PRE>
[HostB-HostA]
Phase=			2
ISAKMP-peer=		HostA
Configuration=		Default-quick-mode
Local-ID=		Net-B
Remote-ID=		Net-A
</PRE></UL>

<p>Tyto reprezentují sekce zmiòované ve Fázi 2 vý¹e. Existují
individuální nastavení který ISAKMP musí pou¾ít aby mohl hovoøit z dvìma
gatewayemi pro urèitou konekci.
<ul>
<li><b>Phase=2</b> je po¾adován proto¾e ISAKMP kód pou¾ívá ty samé
fuknce k autentizaci Fáze 1 a Fáze 2. Toto je vy¾adováno pro práci VPN.
<li><b>ISAKMPD-Peer=</b> je jméno sekce Host zmínìné vý¹e. To znamená,
¾e hovoøíme s urèitým sousedem abychom ustavili konekci Fáze 2. To je
poskytováno proto¾e máme rùzné sekce, které popisují isakmp sousedy a
konekce. 
<li><b>Configuration=</b> se odkazuje na sekci ní¾e, která popisuje
standardy, které musí server a soused který s ním komunikuje dodr¾ovat.
<li><b>Local-ID=</b> se odkazuje na sekci IPsec-ID ní¾e, která popisuje
na¹i Privátní Sí» k sousední gatewayi.  Toto je èást která bude pou¾ita
druhou gatewayí k nastavení správných routovacích tabulek aby mohla být
pøená¹ena data pøes VPN k na¹í síti.
<li><b>Remote-ID=</b> se odkazuje na sekci IPsec-ID ní¾e, která popisuje
co je pøedpokládáno ¾e bude Privátní Sí» vzhledem n na¹emu stroji. Tato
èást bude interpretována k nastavení správných routovacích tabulek které
budou pøená¹et data z na¹í Privátní Sítì pøes VPN ke vzdálené Privátní
Síti.
<p>Existuje dal¹í tag Flags=, který je zde podporován. Pokud vy¾adujete
tento tag, pøeètìte si
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>.
</ul>
<P>
Toto je sekce IPsec-ID. Tyto záznamy jsou potøeba v souborech
isakmpd.conf pro oba stroje A i B. Tento pøíklad nastaví
192.168.1.0/255.255.255.0 pro A (který byl pøipojen k Net-A vý¹e) a
192.168.20.0/255.255.255.0 pro B (Net-B vý¹e).
<UL><PRE>
[Net-A]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.1.0
Netmask=		255.255.255.0

[Net-B]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.20.0
Netmask=		255.255.255.0
</PRE></UL>

<p>Tyto dvì sekce jsou v <b>conf</b> souboru na ka¾dém stroji. Jsou to
sekce, na které se odkazují identifikátory 
<b>Local-ID</b> a <b>Remote-ID</b>. Popisují routy, které by mìly být
nastaveny aby mohl protékat traffic z jedné privátní sítì do druhé.
<b>ID-type</b>= mù¾e být <b>IPV4_ADDR_SUBNET</b> nebo <b>IPV4_ADDR</b>
(RFC2708 zmiòuje více mo¾ných hodnot. V souèasné dobì je v OpenBSD
podporováno pouze IPv4.  IPv6 mù¾e být podporováno v OpenBSD-current.)
 
<P>
Na obou strojích by mìl ukázkový vypadat nìjak takhle:
<UL><PRE>
[Default-main-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		ID_PROT
Transforms=		3DES-SHA
</PRE></UL>

Tato sekce popisuje po¾adavky na ¹ifrovací metody pou¾ité v konekcích
Fáze 1.  Jméno zohledòuje hodnotu promìnné  <i>Configuration=</i>. Jak
mù¾ete vidìt, nastavujeme ná¹ Domain of Interest, co¾ je IPSEC. Promìnná
<b>EXCHANGE_TYPE</b> je nastavena na <b>ID_PROT</b> pro Fázi 1, která
identifikuje jaké protokoly budou pokryty touto autentizací.
<b>Transforms=</b> je transformace vy¾adovaná (nebo pøiøazená) pro tuto
výmìnu. V tomto pøípadì ukazuje na sekci uvedenou ní¾e v konfiguraèním
souboru, která øíká, ¾e obdr¾íme paket za¹ifrovaný 3DES a kontrolním souètem
verifikovatelným pomocí SHA1. Existuje nìkolik odli¹ných transformací
definovaných uvnitø. <b>VPN-east.conf</b>. Tyto jsou poskytováno,
proto¾e kombinace 3DES a SHA1 nemusí být na nìkterých platformách
podporována. Pro OpenBSD by nemìl být dùvod toto mìnit v základním
nastavení. Mù¾ete si v¹e zmìnit jak je libo, jediný po¾adavek je, ¾e
zmìníte promìnnou Configuration=.

<UL><PRE>
[Default-quick-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		QUICK_MODE
Suites=			QM-ESP-3DES-SHA-PFS-SUITE,QM-ESP-DES-MD5-PFS-SUITE
</PRE></UL>

<p>Tato sekce popisuje po¾adavky na ¹ifrování dat, které budou posílány
pøes VPN a je zmiòovaná v <i>Configuration</i> vý¹e. V¹imnìte si rozdílu
mezi touto sekcí a jejího ekvivalentu pro Fázi 1 - <b>EXCHANGE_TYPE</b>
je <b>QUICK_MODE</b>. Toto v¾dy platí pro Fázi 2.
<b>Suites=</b> ukazuje na sekci IPsec Suite, která popisuje rùzná
¹ifrovací schemata dostupná mezi dvìma stroji.  Je je¹tì daleko více, co
by se dalo øíct o ISAKMP a IPsec. U¾itím jednoduchých popisù zmínìných
vý¹e byste mìli být schopni vytvoøit jednoduché ale pevné VPN, které se
udr¾uje samo.  Toto je úplné <i>minimum</i> <b>isakmpd.conf</b> pro oba
stroje.
 
<h3>13.7.3 - Spou¹tìní isakmpd</h3>
Budete chtít pou¾ít
<P>
<ul>
<tt># <b>isakmpd -d -DA=99</b></tt>
</ul>
<P>
pøi prvním spu¹tìním démona. Démon nepobì¾í v démon módu ale jako
regulérní proces. V¹echno bude logováno na vá¹ terminál. Abyste
zastavili isakmpd a vyèistili routy, killnìte isakpmd proces na ka¾dém
uzlu a spus»te <b>ipsecadm flush</b>.

<P> 
<a name="x509"> 
<h1>13.8 - Jak pou¾iji isakmpd s X.509 certifikáty?</h1>
</a>
<P>
Nastavení isakmpd s pou¾itím certifikátù namísto pøed-sdílených klíèù
není zas tak o moc tì¾¹í ve velké síti mnoha sousedy, kteøí mají trust
relationship ne¾ v malé síti. Dokonce to mù¾e zjednodu¹it konfiguraci a
co je dùle¾itìj¹í i management klíèù.
<P>

<h2>Generování certifikátù.</h2>

Dobrý popis jak generovat klíèe a certifikáty je v souboru
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/README.PKI?rev=1.7">README.PKI</a>
v adresáøi se zdrojovými soubory isakmpd. Budete potøebovat CA klíè,
pøíslu¹ný CA X.509 certifikát, jeden privátní klíè pro ka¾dý poèítaè na
síti, který bude pou¾ívat isakmpd a jeden X.509 certifikát pro ka¾dý
takový klíè.
<p>
X.509 certifikáty potøebují extenzi Subject Alternative Name
(SubjectAltName) popisující dr¾itele certifikátu. V souboru README.PKI
je také popsáno jak nastavit extenzi SubjectAltName pou¾itím certpatch
pro pøípad nastavení IP adresy jako SubjectAltName. Pou¾ití IP adresy je
zde popsáno jako defaultní chování isakmpd. 
<p>
Certpatch dále podporuje buï FQDN (Fully Qualified Domain Name) nebo
UFQDN (U¾ivatelské FQDN). Pøíklad FQDN mù¾e být
<tt>www.openbsd.org</tt>, pøíklad UFQDN by mohla být e-mailová adresa.
Na pøíklad nìco jako <tt>Jorgen.Granstam@abc.se</tt>
<p>
V tomto howto dokumentu budeme pou¾ívat SubjectAltNames jako FQDNs.
U¾ívaní IP adres by mohlo být tro¹ku lehèí proto¾e je to defaultní
chování isakmpd, ale není v tom zase a¾ takový rozdíl, jak uvidíte. 
<p>
Abyste vlo¾ili FQDN SubjectAltName do certifikátu spus»te:
<p>
<ul><tt>
$ <b>/usr/sbin/certpatch -t fqdn -i home.mysite.se -k ca.key originalcert.crt newcert.crt</b>
</tt></ul>
ca.key je privátní klíè CA, tak¾e toto mù¾e provést kdokoliv, kdo má
pøístup k privátnímu klíèí CA. home.mysite.se je FQDN, které bude
vlo¾eno do certifikátu. Soubory originalcert.crt a newcert.crt mohou být
toto¾né, pak ale bude originální soubor pøepsán novým modifikovaným
certifikátem. 
<p>
Zkopírujte klíèe a certifikáty do adresáøù jak je popsáno v README.PKI.
Klíè CA (ca.key) by mìl být ulo¾en na bezpeèném místì pokud zamý¹líte
klíèe opravdu pou¾ívat.

<h2>Konfigurace isakmpd</h2>
  
Podívejme se na konfiguraèní soubor /etc/isakmpd/isakmpd.conf. Originál
byl pøevzat z 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a>
ale byl hodnì modifikován. Pro sna¾¹í pochopení budeme pou¾ívat mnohem
krat¹í soubor ne¾ ten, co je uveden v manuálové stránce.  Pøidali jsme
nìjaké komentáøe (nìkteré komentáøe pochází z isakmpd.conf(5)) a zmìnili
jsme nìkterá jména. ®ádné ze zmínìných doménových jmen normálnì
neexistuje.
<p>
Ka¾dý kdo ète tento dokument u¾ má funkèní konfiguraci pro pøed-sdílené
klíèe (viz pøedchozí sekce) tak¾e byste nemìli být moc pøekvapení.
Nebudeme vysvìtlovat v¹e, podívejte se do manuálové stránky
isakmpd.conf(5) pro více detailù.
<p>
Pøedpokládejme ¾e ná¹ setup bude vypadat nìjak takto:
<p>

<center>
<pre>
one.mysite.se                                        one.worksite.se
 192.168.1.2--+    10.0.0.1====/======10.0.0.2     +--192.168.2.2 
              |  gw.mysite.se       gw.worksite.se |
              +--192.168.1.1         192.168.2.1---+
two.mysite.se |                                    | two.worksite.se
 192.168.1.3--+                                    +--192.168.2.3
</pre>
</center>

<p>
To znamená. ¾e dvì sítì by mìly být spojeny pomocí IPsec tunelu pøes
jinou ne-bezpeènou sí». Ignorujte fakt, ¾e pou¾ívám IP adresy
rezervované pro privátní prostor (RFC1918), nìco jsme museli pou¾ít.
Nebudeme popisovat jak pou¾ít isakmpd v kombinaci s NAT nebo podobným
(proto¾e jsme to nezkou¹eli).
<p>
Podívejme se na konfiguraèní soubor. Toto je soubor pou¾itý pro gateway
gw.mysite.se:
<UL>
<pre>

# *****************************************************************
# ************* Start of the gw.mysite.se isakmpd.conf ************
# *****************************************************************

# Pøíklad konfigurace pro isakmpd ISAKMP/Oakley (aka IKE) démona.
[General]
Policy-File=            /etc/isakmpd/policy
Retransmits=            5
Exchange-max-time=      120
Listen-on=              10.0.0.1


# Jméno work-gw je pou¾ito jenom jako název sekce a tag pro pou¾ití v této
# konfiguraci ní¾e a není reálné hostname nebo domain name, nicménì mù¾e být. IP
# adresa musí být správnì. Fáze 1, jak asi u¾ víte je pou¾ita k vyjednání ISAKMP
# SA asociací. Pro ka¾dého souseda s kterým budeme chtít komunikovat by zde
# samozøejmì mìla být ip adresa a jméno.
[Phase 1]
10.0.0.2=               work-gw

# Ve Fázi 2 se vyjednávají IPsec SA asociace. Jako ve Fázi 1, uvedené jméno
# sekce bude pou¾ito pozdìji. Vlastnì to mù¾e být i list jmen oddìlených
# èárkami. S tím, jak budou pøidávány dal¹í sítì/hosty budou pøibývat jména
# sekci (a samozøejmì dal¹í sekce ní¾e).
[Phase 2]
Connections=            work-gw-my-gw


# Tady jsou nìkteré paramatery pro vyjednávaní SA. Jméno sekce je z sekce [Phase
# 1] vý¹e. Dal¹í zajímavý tag je ID tag. Tento tag je nastaven na jméno sekce
# sejce jde bude informace o identitì tohoto hostu, která bude prezentována
# sousedùm. Pokud není ID tag k dispozici, isakmpd bude pøedpokládat, ¾e to je
# IP adresa. Mù¾ete si také v¹imnout, ¾e se zde u¾ nenachází ¾ádný
# autentizaèní tag. Autentizaèní data jsou po¾itá pouze v pøípadì
# pøed-sdílených klíèù.
[work-gw]
Phase=                  1
Transport=              udp
Local-address=          10.0.0.1                # Lokální adresa
Address=                10.0.0.2                # Adresa souseda
ID=                     my-ID
Configuration=          Default-main-mode


# Toto jsou data vztahující se k identitì. ID-type mù¾e být IPV4_ADDR
# (defaultní), IPV4_ADDR_SUBNET nebo UFQDN. Name tag je pou¾it pro FQDN a UFQDN,
# pro IPV4_ADDR by mìl být pou¾it Address tag. Pro IPV4_ADDR_SUBNET by mìl být
# pou¾it Network a Netmask tag
[my-ID]
ID-type=                FQDN
Name=                   gw.mysite.se


# Toto je sekce vztahující se k IPsec konekci. Název sekce je z listu v sekci
# [Phase 2] uvedené vý¹e. ISAKMP-peer je samozøejmì tag oznaèující souseda z
# sekce [Phase 1] uvedené vý¹e. Tagy Local-ID a Remote-ID by mìly být názvy
# sekcí popisující které balíky budou forwardovány pøes IPsec tunel do vzdálené
# sítì.
[work-gw-my-gw]
Phase=                  2
ISAKMP-peer=            work-gw
Configuration=          Default-quick-mode
Local-ID=               Net-west
Remote-ID=              Net-east

# Ka¾dý paket vystupující z poèítaèe nacházejícího se na síti popsané zde...
[Net-west]
ID-type=                IPV4_ADDR_SUBNET
Network=                192.168.1.0
Netmask=                255.255.255.0

# ... a s popisem cíle, který souhlasí se sítí popsanou zde bude za¹ifrován a
# forwardován pøes IPsec tunel na vzdálený systém.
[Net-east]
ID-type=                IPV4_ADDR_SUBNET
Network=                192.168.2.0
Netmask=                255.255.255.0

# popisy Main mode 


# Tady jsou data pro main mode. Pou¾ití DES pro reálné pou¾ití není pøíli¹
# chytré, proto¾e DES není pova¾ována za bezpeèný ¹ifrovací algoritmus. 3DES je
# obecnì pova¾ována za mnohem bezpeènìj¹í, proto¾e pou¾ívá dostateènì dlouhý
# klíè. Transforms je list tagù popisující transformace v main mode. V tomto
# pøíkladì máme pouze jeden.  
[Default-main-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          ID_PROT
Transforms=             3DES-MD5


# Certifikáty ulo¾ené ve formátu PEM 
# Toto je dùle¾ité pokud pou¾íváte certifikáty. Ca certifikáty by mìly být
# v adresáøi CA (samozøejmì ne privátní klíè).
# Adresáø Cert by mìl obsahovat aspoò certifikát pro localhost ale dal¹í
# certifikáty jsou také povoleny. Privátní klíè by mìl být privátní klíè
# localhostu.
[X509-certificates]
CA-directory=           /etc/isakmpd/ca/
Cert-directory=         /etc/isakmpd/certs/
Private-key=            /etc/isakmpd/private/local.key

# Transformace v Main mode 
######################

# Dùle¾ité v této sekci je pou¾ít autentizaèní metodu RSA_SIG pøi pou¾ití
# certifikátù. Je to také jediná metoda podporovaná pro pou¾ití s certifikáty.
# Komerèní subjekty v US budou muset poèkat do Záøí 2000 kvùli RSA patentu.
# Na¹tìstí ne¾ijeme v US. Dal¹í dùle¾itý tag je GROUP_DESCRIPTION, ten musí
# odpovídat tag GROUP_DESCRIPTION v transformacích Quick mode uvedených dále. 
# Life tag by pokud mo¾no nemìl být mìnìn. LIFE_60_SECS mù¾e být krat¹í ne¾ je
# nezbytné pro bì¾né pou¾ití.

[3DES-MD5]
ENCRYPTION_ALGORITHM=   3DES_CBC
HASH_ALGORITHM=         MD5
AUTHENTICATION_METHOD=  RSA_SIG
GROUP_DESCRIPTION=      MODP_1024
Life=                   LIFE_60_SECS,LIFE_1000_KB

# Popis Quick mode 
########################

[Default-quick-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          QUICK_MODE
Suites=                 QM-ESP-3DES-MD5-PFS-SUITE

# Quick mode protection suites
##############################
# 3DES

[QM-ESP-3DES-MD5-PFS-SUITE]
Protocols=              QM-ESP-3DES-MD5-PFS

# 3DES

[QM-ESP-3DES-MD5-PFS]
PROTOCOL_ID=            IPSEC_ESP
Transforms=             QM-ESP-3DES-MD5-PFS-XF

# Transformace Quick mode 

# Nezapomeòte, ¾e GROUP_DESCRIPTION musí souhlasit s tagem GROUP_DESCRIPTION
# v main mode vý¹e. Pro forwardování paketù mezi dvìma sítìmi (nebo z hostu do
# sítì) pou¾íváme TUNNEL mode. Mezi dvìma hosty pou¾íváme namísto toho TRANSPORT
# mode.
[QM-ESP-3DES-MD5-PFS-XF]
TRANSFORM_ID=           3DES
ENCAPSULATION_MODE=     TUNNEL
AUTHENTICATION_ALGORITHM=       HMAC_MD5
GROUP_DESCRIPTION=      MODP_1024
Life=                   LIFE_60_SECS


# Jak víme z manuálové stránky isakmpd.config, LIFE_DURATION je nabízená hodnota
# (60), minimální akceptovatelná hodnota (45) a maximální akceptovatelná
# hodnota. Pøíklad isakmpd.conf má toto nastaveno na 600,450/720, co¾ mù¾e být
# pro normální pou¾ití vhodnìj¹í. 
[LIFE_60_SECS]
LIFE_TYPE=              SECONDS
LIFE_DURATION=          60,45:72

[LIFE_1000_KB]
LIFE_TYPE=              KILOBYTES
LIFE_DURATION=          1000,768:1536

# ************************************************************
# ************* Konec gw.mysite.se isakmpd.conf **************
# ************************************************************
</pre>
</UL>
<p>
To» v¹e pro lokální konfiguraci. Vzdálený systém je konfigurován úplnì
stejnì se zøejmými substitucemi, jenom první èást souboru isakmpd.conf
se li¹í.  Podívejme se na první èást souboru isakmpd.conf pro bezpeènou
gateway gw.worksite.se:  
<p>
<UL>
<pre>
# ************************************************************
# ************* Zaèátek gw.worksite.se isakmpd.conf **********
# ************************************************************

[General]
Policy-File=            /etc/isakmpd/policy
Retransmits=            5
Exchange-max-time=      120
Listen-on=              10.0.0.2

[Phase 1]
10.0.0.1=               my-gw

[Phase 2]
Connections=            work-gw-my-gw

[my-gw]
Phase=                  1
Transport=              udp
Local-address=          10.0.0.2                # Local address
Address=                10.0.0.1                # Peer address
ID=                     work-ID
Configuration=          Default-main-mode

[work-ID]
ID-type=                FQDN
Name=                   gw.worksite.se

[work-gw-my-gw]
Phase=                  2
ISAKMP-peer=            my-gw
Configuration=          Default-quick-mode
Local-ID=               Net-east
Remote-ID=              Net-west

# *****************************************************************
# ********************** ... pokraèování dále *********************
# *****************************************************************
</pre>
</UL>
<p>
To nebylo a¾ tak tì¾ké, jenom trochu nudné e ètení. Následuje o nìco
zajímavìj¹í èást.
<p>


<h2>Soubor policy.</h2>

Soubor policy by mohly být docela matoucí pro nìkoho, kdo ho u¾ døíve
nepou¾íval, hlavnì kdy¾ nìco nepracuje jak oèekával. Manuálová stránka 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
není zase tak ¹patná. Nìkteré èásti nejsou mo¾ná úplnì tak jasné, ale
obecnì je dobrá. 
<p>
Nejjednodu¹¹í mo¾ný policy soubor by mohl obsahovat jenom jediný øádek:
<p>
<UL>
<pre>
authorizer: &quot;POLICY&quot;
</pre>
</UL>
<p>
To znamená, ¾e neexistují ¾ádné limity pro to, komu bude dovolen pøístup
ke spojení. To není moc bezpeèné. Authorizer tag znamená, ¾e kdo je
autorizován mù¾e rozhodovat politiku. Speciální authorizer
&quot;POLICY&quot; má neomezenou autoritu v urèování politiky. Ka¾dý
dal¹í authorizer musí být nejprve autorizován pøes &quot;POLICY&quot;
aby mìl nìjakou autoritu.
<p>
Dále zde mù¾e být soubor podmínek pro to, co je dovoleno. Následující
politika by mìla znamenat, ¾e pouze ten, kdo pou¾ívá ESP protokol s
nìjakou formou ¹ifrování by mohl být autorizován. (samozøejmì nìkdo kdo
pou¾ívá DES by také mohl být autorizován, pøesto¾e se DES dnes pova¾uje
za "snakeoil", to je necháno jako cvièení ètenáøi, aby provedl zmìnu,
která zaká¾e DES úplnì).  Uvìdomte si, ¾e kdokoliv kdo ¹ifruje s ESP
bude mít stále povolen pøístup.
<p>
<UL>
<pre>
authorizer: &quot;POLICY&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; -&gt; &quot;true&quot;;

</pre>
</UL>
<p>
Dále je mo¾né "sublicencovat" autoritu nìkomu jinému (to mù¾e klidnì být
i více entit). Nejjednodu¹¹í pøípad by mohl být pøed-sdílený klíè. V
tomto pøípadì kdokoliv kdo zná pøed-sdílenou passphrase je autorizován.
To jest:
<p>
<UL>
<pre>
authorizer: &quot;POLICY&quot;
licensees:  &quot;passphrase:something really secret&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
Toto by autorizovalo ka¾dého kdo zná passphrase na pøipojení a splòuje
podmínky (nezapomeòte, ¾e passphrase musí být nastavena v tagu
Authentication v isakmpd.conf).
<p>
Zatím nic obtí¾ného. Teï pøistoupíme k zajímavìj¹ím vìcem. Nemusí zde
být ¾ádní licencees,  aèkoli v¹e musí být autorizováno podle
&quot;POLICY&quot;.  Dále, autorizovaní licencees mohou sublicencovat
ostatním licencees. Licencee mù¾e být jenom znakový øetìzec v pøípadì ¾e
je to dále popsáno v souboru policy:
<p>
<UL>
<pre>
authorizer: &quot;POLICY&quot;
licensees:  &quot;subpolicyAH&quot; ||  &quot;subpolicyESP&quot;
conditions: app_domain == &quot;IPsec policy&quot; -&gt; &quot;true&quot;;

authorizer: &quot;subpolicyESP&quot; 
licensees:  &quot;passphrase:something more secret&quot;
conditions: esp_present == &quot;yes&quot; -&gt; &quot;true&quot;;

authorizer: &quot;subpolicyAH&quot; 
licensees:  &quot;passphrase:something really secret&quot;
conditions: ah_present == &quot;yes&quot; -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
A teï to, na co v¹ichni èekali. Politika mù¾e také být sublicencovaná
nebo delegovaná klíèi. V tomto pøípadì je to obvykle X.509 certifikát.
Jednoduché pou¾ití certifikátù by bylo u¾ít je jako passphrases, tím ¾e
vlo¾íme do souboru policy jednotlivé u¾ivatele:
<p>
<UL>
<pre>
keynote-version: 2
comment: Toto je pøíklad delegování politiky klíèi.
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA           This is would be a user certificate           AQEB\
        BQA                                                         IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
To je zøejmì hloupost v pøípadì existence více u¾ivatelù. Certifikáty,
které isakmpd ète z z adresáøù CA- a Certificate a certifikáty obdr¾ené
od sousedù jsou pøevedeny do pseudo credentials. Takové certifikáty
pøevedené do pseudo credentials by vypadaly nìjak takto:
<p>
<UL>
<pre>

authorizer: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgI2\
	CzA  This is would be the public key/certificate of the     AQEB\
        BQA signer of the user certificate (i.e. the CA certificate)IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
licensees:  &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA      This is would be the key of the subject of the     AQEB\
        BQA                        certificate                      IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain == &quot;IPsec policy&quot; -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
Uvìdomte si, ¾e tyto nejsou autorizované pøes &quot;POLICY&quot; a tak
nebudou mít ¾ádný efekt bez politiky, která je nìjak autorizuje. Dále,
toto ukazuje, co se certifikátùm stane uvnitø. Vý¹e uvedený credential
tedy není v souboru policy, nicménì je mo¾né sublicencovat takovým
credentials. Vzpomeòte si na sublicencování uvedené vý¹e. Je dále mo¾né
licencovat v¹echny certifikáty které jsou podepsány urèitým CA tím, ¾e
zkopírujeme CA certifikáty jako licensee do &quot;POLICY&quot;:
<p>
<UL>
<pre>
keynote-version: 2
comment: Toto je pøíklad delegování politiky klíèi. 
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA               This would be the CA certificate          AQEB\
        BQA                                                         IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
To jest politika uvedená vý¹e je jednoduchý pøíklad politiky která
deleguje CA. To jest kad¾ý u¾ivatel, který má certifikát podepsaný CA,
která má tento certifikát a konfiguraèní soubor by byl autorizován. 
<p>

<h2>Skoro bezpeèné...není bezpeèné!</h2>

Je¹tì jsme neprobrali v¹echno, aby toto v¹e bylo bezpeèné. Existují
cesty, jak zaútoèit na bezpeènou gateway která je takto konfigurována.
Pokud nechcete znát detaily. pøeskoète tuto sekci. Pro ostatní: pojïme
se podívat na to, proè to není bezpeèné. Není to tak tì¾ké.
<p>
Uva¾ujme k jakým informacím má isakmpd v této fázi pøístup. Z
konfiguraèního souboru ví z kterých IP adres bude soused vysílat (z
sekce [Phase 1]). Dále zná ID pod kterým se bude soused prezentovat (z
vyjednávání Fáze 1) a certifikát který dostává od souseda dokazuje, ¾e
soused má opravdu toto ID. To vypadá dobøe, ne?
<p>
Pokud je ID informace IP adresa (co¾ je defaultní situace pokud nedodáme
ve Fázi 1 ID sekci) v¹echno je v poøádku. CA by byla svázaná k této IP
adrese a IP adresa v konfiguraèním souboru by byla v¹e co potøebujeme.
Pro útoèníka by nebylo mo¾né pou¾ít tu samou IP adresu z jiného poèítaèe
(pokud by byly oba poèítaèe na stejné síti a ten originální by z
nìjakého dùvodu nebyl pøístupný). Pro útoèníka by nicménì nebylo mo¾né
mít certifikát a pøíslu¹ný privátní klíè, který by (fale¹nì) dokazoval,
¾e tato IP adresa patøí útoèníkovi. 
<p>
Kdyby se to nìkdy stalo, útoèník by musel zvládnout buï ukrást privátní
klíè od skuteèného vlastníka nebo by musel zmást CA aby vydala
certifikát obsahující fale¹né informace. Pokud by se stala nìjaká z
tìchto vìcí, pak buï nebyl privátní klíè chráanìn dost dobøe nebo CA
dostateènì nezkontrolovala identitu útoèníka (nebo ID informace pro
certifikát) nebo privátní klíè CA nebyl dostateènì chránìn. Proto¾e toto
jsou pøedpoklady pro bezpeènost vùbec, není dovoleno, aby se vùbec stala
nìkterá z tìchto situací.
<p>
V na¹em pøíkladu je situace odli¹ná. Máme FQDN v certifikátu namísto IP
adresy. Proto¾e poøád máme IP adresu v sekci [Phase 1] mù¾e to vyústit v
bezpeènostní problém. Co se stane, kdy¾ bìhem vyjednávání ISAKMP Fáze 1
je to, ¾e bychom mohli zkontrolovat, jestli soused posílá skuteènì z
oèekávané adresy (ale ta by mohla být v urèitých pøípadech zfal¹ována,
jak dále vysvìtlíme).  Nemù¾eme ovìøit, ¾e ID pod kterým se soused hlásí
je skuteènì ID které oèekáváme, proto¾e isakmpd nikdo neøekl, jaké by ID
mìlo být.
<p>
Nìkdo teï mù¾e namítnout, ¾e DNS systém vá¾e IP adresu k FQDN pro daný
host.  To je pravda, nicménì dne¹ní DNS systém není bezpeèný a mù¾e být
za urèitých okolností zmaten tak, ¾e bude dávat fale¹né informace. (nebo
se mù¾e stát obìtí DoS útoku a útoèník zfal¹uje jeho odpovìdi). Bezpeèné
DNS pøijde v budoucnosti, ale zatím tady není (aspoò vìt¹ina DNS serverù
není zatím bezpeèná), tak¾e dnes, u¾ití DNS ke kontrole zda FQDN v
certifikátu souhlasí s oèekávanou IP adresou neposkytuje ¾ádnou záruku.
Isakpmd toto nekontroluje pou¾itím DNS. I kdyby bylo DNS bezpeèné, tato
kontrola by nám nepomohla v pøípadì, ¾e pou¾ívali UFQDN.
<p>
Tak¾e v pøípadì ¾e máme FQDN jako ID by bylo mo¾né pro útoèníka získat
privátní klíè a nechat tento klíè podepsat nìjakou CA, kterou pou¾íváme.
(samozøejmì s útoèníkovým FQDN). Pak spustit DoS útok na na¹eho souseda
tak¾e by ¹el dolù (v ISAKMP protokolu jsou nìjaké chyby, které by mohly
být zneu¾ity ke spu¹tìní DoS útoku na souseda, i kdy¾ nevíme jak citlivý
je isakmpd k tìmto útokùm). Pak by mohl útoèník nakonfigurovat svùj
poèítaè stejnì jako soused, zapojit do sousedovy sítì a pokusit se
pøipojit u¾itím svého ID, privátního klíèe a certifikátu.
<p>
Proto¾e ná¹ isakmpd nebyl informován o ID na¹eho souseda (a to proto, ¾e
útoèník je nakonfigurován stejnì jako ná¹ soused kromì certifikátu, ID a
privátního klíèe). Dále na¹e isakmpd mù¾e zkontrolovat certifikát, který
byl podepsán tou samou CA (ale vìt¹ina CA podepisuje mnoho, certifikát
nemusí být tak tì¾ké získat), a ¾e presentované ID je stejné jako ID v
certifikátu.  Nebude ale se stávající konfigurací kontrolovat ¾e toto ID
je oèekávané ID, tak¾e útoèníkovi bude povolen pøístup.
<p>

<h3>Prevence útoku.</h3>

Teï je otázka, jak mù¾eme dát isakmpd vìdìt o tom jaké ID má oèekávat.
Toto je na¹tìstí lehké a je dokumentováno v 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>.
Musíme dìlat kontrolu v politice. Nìco jako:
<p>
<UL>
<pre>
keynote-version: 2
comment: Toto je pøíklad delegování politiky klíèi. 
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA               This would be the CA certificate          AQEB\
        BQA                                                         IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; &amp;&amp;
            remote_id == &quot;gw.worksite.se&quot; -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
Teï bude pouze gw.worksite.se schopna ustavit IPsec konekci. Dal¹í
povolená ID by mohla být snadno pøidána tím, ¾e pøidáme dal¹í
alternativní remote_id kontroly, t.j. ¾e budeme mít v politice
conditions jako tyto:
<p>
<UL>
<pre>
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; &amp;&amp;
            (remote_id == &quot;gw.worksite.se&quot;  ||
               remote_id == &quot;gw.whatsite.se&quot;) -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
S touto politikou bude povolena konekce pouze strojùm gw.worksite.se,
gw.somesite.se nebo gw.whatsite.se.

<p>
Nìkdo mù¾e namítnout, ¾e není rozumné vkládat celé certifikáty do policy
souboru. Vy¾aduje to jistou práci reformátovat certifikáty do formátu
jako je v policy a to dìlá policy trochu neèitelnou. Pokud nìkdo udìlá
chybu a zamìní u¾ivatelský certifikát s korespondujícícm certifikátem v
prostøedí s komplexní politikou, mù¾e tím udìlit pøístup neautorizovaným
u¾ivatelùm a co je hor¹í, nemusí to být jednodu¹e detekovatelné pøi
ètení souboru policy. (proto¾e X.509 certifikátu nejsou v lidmi èitelné
podobì). 

<p>
Øe¹ení ale existuje, je mo¾né pou¾ít certificate Distinguished Name
(DN) namísto certifikátu v politice. (pøíslu¹ný certifikát musí být
samozøejmì dostupný na disku, aby ho mohl isakmpd najít a pou¾ít). S
tímto formátem politiky by mohl certifikát uvedený vý¹e vypada nìjak
takto:

<p>
<UL>
<pre>  
keynote-version: 2
comment: Toto je pøíklad delegování politiky klíèi.
authorizer: &quot;POLICY&quot;
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; &amp;&amp;
            (remote_id == &quot;gw.worksite.se&quot;  ||
             remote_id == &quot;gw.somesite.se&quot;  ||
             remote_id == &quot;gw.whatsite.se&quot;) -&gt; &quot;true&quot;;
</pre>
</UL>
<p>
To je mnohem èitelnìj¹í, ¾e? Informaci o tom, jaké pøesnì DN patøí k
certifikátu lze najít tak, ¾e se na certifikát podíváme  pou¾itím
utility openssl. Nìco jako:
<p>
<UL><tt>
$ <b>openssl x509 -text &lt; ca.crt</b>
</tt></UL>
<p>
Více komplikované konfigurace politiky jsou samozøejmì mo¾né, ale toto
je zaèátek, dal¹í pøíklady jsou v dal¹í sekci. 
<p>
To by mìlo poskytovat nezbytné informace o certifikátu v ca.crt. To je
dobré dokud máme malou nebo aspoò rozumnì malou politiku. Poøád to ale
není moc dobré, pokud máme gigantický site s mnoha u¾ivateli, kteøí by
mìli mít povoleno se pøipojit.

<H2>Multiu¾ívatelské konfigurce a/nebo centrálnì spravovaná autorizace.</h2>

Teï se povívejme na nìkteré opravdu dobré vlastnosti isakmpd. Pøedtím
jsme pøedpokládali, ¾e soused je známý a má statickou IP adresu. To není
a¾ tak obvyklý pøípad. Mnoho lidí pou¾ívá dynamicky pøidìlované IP
adresy nebo pou¾ívá mnoho poèítaèù. V nìkterých pøípadech (napø. pro
server) nemusíme vìdìt kdo se pokou¹í pøipojit.

<p>
Tím pádem jedna velmi pìkná vlastnost isakmpd je schopnost pou¾ívat
default tag namísto IP adresy v sekci [Phase 1], èím¾ se povolí
vyjednávání pøes IP.  To mù¾e vypadat jako:
<p>
<UL>
<pre>
[phase 1]
Default=        work-gw
</pre>
</UL>
<p>
Nejprve by mìlo být øeèeno ¾e tato konfigurace nemusí být bezpeèná proti
DoS útokùm. Jak ji¾ bylo øeèeno, existují chyby v protokolech pro
ISAKMP/IKE.  Nicménì pou¾itím default v sekci [phase 1] nám namísto toho
zase dovolí pou¾ít urèitý druh &quot;autorizaèních certifikátù&quot;.
<p>
Uva¾ujme pøípad, kdy máme mnoho autorizovaných u¾ivatelù ale kdy zase
nepustíme ka¾dého. Nìco jako spoleènost. Budeme chtít, aby se
pøipojovali zamìstnanci, ale nikdo jiný. Pøedstavme si nyní velkou
spoleènost, kde mohou být tisíce zamìstnancù. Chtìli bychom aby se byli
schopní pøipojit z jakéhokoliv poèítaèe (a ne pouze z vnitrofiremní
sítì) ale ale ka¾dý by nemìl dovoleno dìlat cokoliv. Mìlo by být mo¾né
napsat politiku takto:
<P>
<UL>
<pre>
keynote-version: 2
authorizer: &quot;POLICY&quot;
licensees: &quot;telnet@work&quot; || &quot;telnet@lab&quot; || &quot;pop3@work&quot; 
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; &amp;&amp;
            remote_id_type == &quot;UFQDN&quot; &amp;&amp;
            (remote_id == &quot;telnet@worksite.se&quot;  ||
             remote_id == &quot;pop3@worksite.se&quot;  ||
             remote_id == &quot;telnet@lab.worksite.se&quot;) -&gt; &quot;true&quot;;

authorizer: &quot;telnet@work&quot;
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
conditions: remote_id == &quot;telnet@worksite.se&quot; &amp;&amp;
            local_filter_type == &quot;IPv4 address&quot; &amp;&amp;
            local_filter_port == &quot;23&quot; &amp;&amp;
            local_filter == &quot;192.168.002.003&quot;

authorizer: &quot;telnet@lab&quot;
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
conditions: remote_id == &quot;telnet@lab.worksite.se&quot; &amp;&amp;
            local_filter_type == &quot;IPv4 address&quot; &amp;&amp;
            local_filter_port == &quot;23&quot; &amp;&amp;
            local_filter == &quot;192.168.002.002&quot; -&gt; &quot;true&quot;;

authorizer: &quot;pop3@work&quot;
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
conditions: local_filter_type == &quot;IPv4 address&quot; &amp;&amp;
            local_filter_port == &quot;110&quot; &amp;&amp;
            local_filter == &quot;192.168.002.003&quot; &amp;&amp;
            remote_id == &quot;telnet@worksite.se&quot; -&gt; &quot;true&quot;;

</pre> 
</UL>
<p> 

To nemusí být úplnì pøesnì jak by to mìlo být. Pokud víme, nikdo to
kompletnì netestoval (popravdì tyto filtrovací podmínky nemusí pracovat
tak jak oèekáváme). Dále politika jako tato (vlastnì jakákoliv s default
jako hodnotou IP souseda) by vy¾adovala pøepsání souboru isakmpd.conf.
To by mìlo nìkteré bezpeènostní dùsledky. Dále pro tento druh konekcí
kde je ka¾dému dovoleno pøipojení by bylo pravdìpodobnì vhodné logovat
DN ka¾dého pøipojeného. Isakmpd zatím toto nepodporuje. Z toho mohou
vyplývat dal¹í bezpeènostní problémy.  Byli jste varováni. Základní idea
by nicménì mìla být jasná.  

<p> 

V pøípadì, ¾e nìkomu u¹ly ty opravdu zajímavé mo¾nosti: Pokud by v¹echny
poèítaèe pou¾ívající ISAKMP/IKE touto cestou dodr¾ovaly standardní
soubor pravidel pro v¹echny slu¾by, které by u¾ivatelé od vzdáleného
konce mohli po¾adovat, CA by mohla autorizovat u¾ivatele vlo¾ením jejich
SubjectAltName extenzí do certifikátù. Dále by se mohla nastavit
relativnì krátká doba expirace, aèkoli to by u¾ivatele nutilo èastìji
stahovat si znovu vydané certifikáty kdy¾ jejich aktuální zestárne. Pokud
u¾ivatelé zneu¾ijí svoje autorizace, zastavíme obnovování certifikátu a
u¾ se poté nedostanou dovnitø.  To znamená, ¾e není potøeba mìnit
soubory policy jenom proto, ¾e zamìstnanec ukonèil pracovní pomìr. To
samé schéma by mìlo fungovat pro jiné úèely ne¾ ISAKMP/IPsec (napø.
autorizaci pro off-line systémy!), aèkoli to by vy¾adovalo speciální
software. V ka¾dém pøípadì ¾ádná organizace pou¾ívající tento systém by
asi nemìla být svou CA.

<p>

Multiu¾ivatelské konfigurace (mobilní u¾ivatelé) jako tyto je mo¾né
provozovat i s pøed-sdílenými klíèi, ale pak je vy¾adován AGGRESSIVE mód
namísto módu ID_PROT, proto¾e musíme být schopni zvolit si správné heslo
zalo¾ené na ID, proto¾e to neumíme urèit z IP (v módu AGGRESSIVE je ID
posíláno je¹tì pøed vyjednáváním, ale je posíláno ne¹ifrovanì, tak¾e
mód AGGRESSIVE je rychlej¹í proto¾e vy¾aduje ménì výmìn, ale také je o
nìco ménì bezpeènìj¹í proto¾e ID je posíláno v èitelné formì).

<P>
<a name= "IKEcl">
<h1>13.9 - Kteøí IKE klienti jsou kompatibilní s isakmpd?</h1>
</a>
<P>
<tt>isakmpd</tt> je ISAKMP/Oakley je démon pro správu klíèù zahrnutý v
OpenBSD distribuci. Pravdìpodobnì by mìl (aspoò èásteènì) pracovat s
vìt¹inou ISAKMP implementací, ale následující byly opravdu testovány.
Nìkteré z isakmp software jsou vlastnì zalo¾eny na démonu dodávaném s
OpenBSD.

<P>
Následující klienti pro MS-Windows pracují s isakmpd:
<UL>
<LI><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Client
<LI><a href="http://www.vpcom.com/">Ashley Laurent</a> VPCom VPN software
<LI><a href="http://www.nai.com/asp_set/products/tns/pgp_vpn.asp">PGP VPN</a> software
<LI><a href="http://www.radguard.com/">Radguard</a> cIPro client
<LI><a href="http://www.cisco.com/">Cisco</a> IRE client
<LI><a href="http://www.microsoft.com">Microsoft</a> Windows 2000, XP 
</UL>
<P>
Následující gatewaye/routery jsou kompatibilní:
<UL>
<LI><a href="http://www.cisco.com/">Cisco</a> IOS
<LI><a href="http://www.cisco.com/">Cisco</a> PIX
<LI><a href="http://www.intel.com/">Intel</a> LanRover
<LI><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Gate
<LI><a href="http://www.cendio.com/">Cendio</a> Fuego
<LI><a href="http://www.kame.net/">KAME</a> for FreeBSD
<LI><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN</a> for Linux
<LI><a href="http://www.axent.com/">Axent</a> Raptor
<LI><a href="http://www.ericsson.com/">Ericsson</a> eBox
<LI><a href="http://www.radguard.com/">Radguard</a> cIPro-VPN
<LI><a href="http://www.f-secure.com/">F-Secure</a> VPN+
<LI><a href="http://www.teamware.com/">Teamware</a> TWISS
<LI><a href="http://www.3com.com/">3com</a> Pathbuilder
<LI><a href="http://www.nortelnetworks.com/">Nortel</a> Contivity
<LI><a href="http://www.checkpoint.com/">CheckPoint</a> FW-1
<LI><a href="http://www.watchguard.com/">Watchguard</a> Firebox III
<LI><a href="http://www.lucent.com/">Lucent</a> Access Point
</UL>
<P>
<a name= "Trouble">
<h1>13.10 - Ladìní IPsec/VPN</h1>
</a>
<P>
Prvním nástrojem pro ladìní IPsecu je 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>.
Pou¾ijte <tt>tcpdump</tt> abyste se podívali na pár vìcí.
<P>
Pokud pou¾íváte tcpdump na OpenBSD, máte zlep¹enou verzi, která dává
informace o ESP a AH paketech. Pokud pou¾íváte tcpdump z OpenBSD verze
2.5 nebo jiného operaèního systému, je ¹ance, ¾e máte star¹í verzi,
která pouze zobrazí èíslo protokolu AH nebo ESP. (ESP je IP protokol 50,
AH je 51) 
<UL>
<P>
<LI>
S tcpdumpem m¾ete vidìt jestli traffic bì¾í pøes AH/ESP nebo bez.
Pokud jde traffic bez, pak jsou va¹e toky (flows) nastaveny nekorektnì
nebo isakmp vyjednávání neprobìhla správnì.
Pou¾ijte <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>,
abyste vygenerovali jednoduchý traffic.
<P>
<UL>
Na pøíklad,, mìjme dva stroje, 208.1.1.1 a 208.2.2.2. 
Nalogováni na 208.2.2.2, provedeme toto:
<PRE>
# <b>ping -c 3 208.1.1.1</b>
PING esp.mil (208.1.1.1): 56 data bytes
64 bytes from 208.1.1.1: icmp_seq=0 ttl=255 time=190.155 ms
64 bytes from 208.1.1.1: icmp_seq=1 ttl=255 time=201.040 ms
64 bytes from 208.1.1.1: icmp_seq=2 ttl=255 time=165.481 ms
--- esp.mil ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 165.481/185.558/201.040 ms
</PRE>
V jiné session mù¾eme vidìt zapouzdøené pakety:
<PRE>
# <b>tcpdump -ni fxp7 host 208.1.1.1</b>
tcpdump: listening on fxp7
14:12:19.630274 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4535 len 116
14:12:19.813519 esp 208.1.1.1 &gt; 208.2.2.2 spi 0x00001001 seq 49313 len 116
14:12:20.630277 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4536 len 116
14:12:20.832458 esp 208.1.1.1 &gt; 208.2.2.2 spi 0x00001001 seq 49314 len 116
14:12:21.630273 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4537 len 116
<b>^C</b>
1831 packets received by filter
0 packets dropped by kernel
</PRE>
</ul>
<P>
<LI>ISAKMP bì¾í na UDP portu 500.  Pokud je tento zakázán firewallem
nebo paket filtrem, budete to muset zmìnit!
<UL><PRE>
# Povolíme ISAKMP traffic z bezpeèných gatewayí
pass in on ne0 proto udp from gatewB/32 port = 500 to gatewA/32 port = 500
pass out on ne0 proto udp from gatewA/32 port = 500 to gatewB/32 port = 500

# Povolení ¹ifrovaného trafficu z bezpeèných gatewayí
pass in proto esp from gatewB/32 to gatewA/32
pass out proto esp from gatewA/32 to gatewB/32
</PRE></UL>
<P>
<LI>
Abyste v isakmpd zapnuli nejvy¹¹í debug level, spus»te: 
<P>
<UL><TT>
# <b>/sbin/isakmpd -d -DA=99</b>
</TT></UL><P>
nebo (abyste vynechali nejvíce detailní timer debug hlá¹ky)
<P>
<UL><TT>
# <b>/sbin/isakmpd -d -DA=99 -D1=70</b>
</TT></UL>
<P>
<LI>Budete chtít povolit traffic který byl produkován IPsecem ze sítì netB do
va¹í lokální sítì netA za firewallem.
<UL><PRE>
# Povolení traffic z urèitých subnetù 
pass in on enc0 from netB/netBmask to netA/netAmask
</PRE></UL>
<P>
<LI>S tcpdumpem na OpenBSD mù¾ete dekódovat vìt¹inu ne¹ifrovaných èástí
bìhem výmìny klíèù. Tcpdump vám zároveò zobrazí payload v AH paketech.
<P>
<LI>Namontujte filesystem /kern (pokud jste tak ji¾ neuèinili)
<P>
<UL><TT>
# <b>mkdir /kern; mount -t kernfs /kern /kern</b>
</TT></UL>
<P>
V /kern je tabulka aktuálních SA/SPIs, vèetnì informace, které mají toky
(odchozí SA) a které ne (pøíchozí SA).  Dále existují traffic countery
které vám umo¾ní vidìt kolik trafficu jde kam.
<P>
<LI>Nakonec mù¾ete pou¾ít <a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a>
abyste vidìli SA.
<UL><PRE>
$ <b>netstat -rn -f encap</b>
Routing tables

Encap:
Source             Port  Destination        Port  Proto SA(Address/SPI/Proto) 
0.0.0.0/32         0     192.168.99/24      0     0     208.1.1.1/00001000/50
0.0.0.0/32         0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
</PRE></UL>
<P>
<LI>
Pokud to nefunguje, rekompilujte vá¹ kernel s mo¾ností <tt>option
ENCDEBUG</tt>. Pak nastavte sysctl <tt>net.inet.ip.encdebug</tt> na 1.
Podívejte se do dmesg po chybových hlá¹eních a reportujte je pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>
Pokud si nejste jisti, ¾e jste na¹li chybu, mù¾ete poslat zprávu do
jednoho z <a href="../../cs/mail.html">mailing listù</a>.
</UL>
<P>
<a name= "SeeAlso">
<h1>13.11 - Dal¹í Dokumentace</h1>
</a>
<p>
IPsec is èásteènì dokumentován v 
manuálové stránce <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&apropos=0&sektion=0&format=html">vpn(8)</a>
Rùzné vzory konfigurací lze nalézt v <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/">/usr/share/ipsec/</a>
Manuálové stránky pro
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4">enc(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4">ipsec(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&sektion=8">ipsecadm(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&sektion=8">isakmpd(8)</a>,
<a HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a> and
<a HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
jsou detailní a pomohou vám v nastavení  a pou¾ívání IPsecu.
<P>
Dal¹í linky...
<UL>
<LI><a href="http://www.ietf.org/html.charters/ipsec-charter.html">IETF IPsec Working Group</a>
<LI><a href="http://isakmp-test.ssh.fi/">SSH IPsec interoperability Test Node</a>
<LI><a href="http://ipsec-wit.antd.nist.gov/">NIST IPsec Web Based Interoperability Tester</a>
<LI><a href="http://www.r4k.net/ipsec/">A port of OpenBSD's IPsec to FreeBSD</a>
<LI><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN - IPsec for Linux</a>
<LI><a href="http://www.codetalker.com/greenbox/docs/vpn-24-minifaq.html">OpenBSD 2.4 VPN Configuration Mini-FAQ</a>
</UL>
<p> 
<A name="rfc">
RFCèka...</a>
<UL>
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1320.html">RFC 1320</a> - The MD4 Message-Digest Algorithm
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1321.html">RFC 1321</a> - The MD5 Message-Digest Algorithm
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1828.html">RFC 1828</a> - IP Authentication using Keyed MD5
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1829.html">RFC 1829</a> - The ESP DES-CBC Transform
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2040.html">RFC 2040</a> - The RC5, RC5-CBC, RC5-CBC-Pad, and RC5-CTS Algorithms
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2085.html">RFC 2085</a> - HMAC-MD5 IP Authentication with Replay Prevention
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2104.html">RFC 2104</a> - HMAC: Keyed-Hashing for Message Authentication
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2144.html">RFC 2144</a> - The CAST-128 Encryption Algorithm 
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2202.html">RFC 2202</a> - Test Cases for HMAC-MD5 and HMAC-SHA-1 
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPsec Data Flows
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2268.html">RFC 2268</a> - A Description of the RC2 Encryption Algorithm 
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2367.html">RFC 2367</a> - PF_KEY Key Management API, Version 2
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<b>IPsec</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC 2402</A> - IP Authentication Header (<b>AH</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2403.html">RFC 2403</A> - The Use of HMAC-MD5-96 within ESP and AH
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2404.html">RFC 2404</A> - The Use of HMAC-SHA-1-96 within ESP and AH
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2405.html">RFC 2405</A> - The ESP DES-CBC Cipher Algorithm With Explicit IV
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC 2406</A> - IP Encapsulating Security Payload (<b>ESP</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC 2407</A> - The Internet IP Security Domain of Interpretation for ISAKMP
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408</A> - Internet Security Association and Key Management Protocol (<b>ISAKMP</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</A> - The Internet Key Exchange (<b>IKE</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2410.html">RFC 2410</A> - The NULL Encryption Algorithm and Its Use With IPsec (ha ha...)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2411.html">RFC 2411</A> - IP Security Document Roadmap
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2412.html">RFC 2412</A> - The OAKLEY Key Determination Protocol
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2451.html">RFC 2451</a> - The ESP CBC-Mode Cipher Algorithms
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2631.html">RFC 2631</a> - Diffie-Hellman Key Agreement Method
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2709.html">RFC 2709</a> - Security Model with Tunnel-mode IPsec for NAT Domains
</UL>

<font color= "#0000e0">
<a href= "index.html">[Zpátky na Hlavní Index]</a>
<a href= "faq12.html">[Na Sekci 12.0 - Pro pokroèilé]</a>
<a href= "faq14.html">[Na Sekci 14.0 - Pou¾ívání diskù v OpenBSD]</a>
</font>
<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../../images/back.gif" border= "0" alt="[zpìt]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<small>
<br>
Originally [OpenBSD: faq13.html,v 1.60 ]
<br>
$Translation: faq13.html,v 1.17 2002/11/06 23:11:02 certik Exp $
<br>
$OpenBSD: faq13.html,v 1.15 2002/11/07 09:38:43 jufi Exp $
</small>
</body>
</html>
