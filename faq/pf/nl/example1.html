<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Voorbeeld: Firewall voor Thuis of Klein Kantoor</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../nl/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Vorige: Firewall Redundantie met CARP en pfsync</a>]
[<a href="index.html">Inhoud</a>]

<p>
<h1><font color="#e00000">PF: Voorbeeld: Firewall voor Thuis of Klein
Kantoor</font></h1>
<hr>

<h3>Inhoudsopgave</h3>
<ul>
<li><a href="#scenario">Het Scenario</a>
	<ul>
	<li><a href="#network">Het Netwerk</a>
	<li><a href="#objective">De Doelstelling</a>
	<li><a href="#prep">Voorbereiding</a>
	</ul>
<li><a href="#ruleset">De Regelset</a>
	<ul>
	<li><a href="#macros">Macro's</a>
	<li><a href="#options">Opties</a>
	<li><a href="#scrub">Scrub</a>
	<li><a href="#nat">Network Address Translation</a>
	<li><a href="#rdr">Omleiding ("redirection")</a>
	<li><a href="#filter">Filterregels</a>
	</ul>
<li><a href="#allrules">De Volledige Regelset</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>Het Scenario</h2>
In dit voorbeeld draait PF op een OpenBSD machine die fungeert als
firewall en NAT gateway voor een klein netwerk in een huis of kantoor. De
globale doelstelling is om Internettoegang aan te bieden aan het netwerk
en beperkte toegang tot de firewall machine vanaf het Internet, en een
interne webserver aan het externe Internet bloot te stellen. Dit
document zal een volledige regelset overlopen die precies dat doet.

<a name="network"></a>
<h3>Het Netwerk</h3>
Het netwerk is als volgt opgebouwd:

<pre>
    
  [ COMP1 ]    [ COMP3 ]
      |            |
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
Er zijn een aantal computers in het interne netwerk; het diagramma toont
er drie maar het werkelijke aantal is irrelevant. Deze computers zijn
gewone werkstations die gebruikt worden voor web surfen, e-mail,
chatten, enz., behalve COMP3 die ook een kleine webserver draait.
Het interne netwerk gebruikt het 192.168.0.0 / 255.255.255.0 netwerkblok.

<p>
De OpenBSD firewall is een Celeron 300 met twee netwerkkaarten: een 3com
3c509B (<tt>xl0</tt>) en een Intel EtherExpress Pro/100 (<tt>fxp0</tt>).
De firewall heeft een kabelverbinding naar het Internet en gebruikt NAT om
deze verbinding te delen met het interne netwerk. Het IP adres op de externe
interface wordt dynamisch toegekend door de Internet Service Provider.

<a name="objective"></a>
<h3>De Doelstelling</h3>
De doelstellingen zijn:
<ul>
<li>Bied onbeperkte Internet toegang aan elke interne computer.
<li>Gebruik een "standaard weigeren" filterregelset.
<li>Laat het volgende binnenkomende verkeer toe naar de firewall vanaf het
Internet:
	<ul>
	<li>SSH (TCP poort 22): dit zal gebruikt worden voor extern onderhoud
	van de firewall machine.
	<li>Auth/Ident (TCP poort 113): gebruikt door bepaalde diensten zoals
	SMTP en IRC.
	<li>ICMP Echo Requests: het ICMP pakket-type gebruikt door
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
>ping(8)</a>.
	</ul>
<li>Leid TCP poort 80 verbindingspogingen (die pogingen zijn om een webserver
te benaderen) om naar computer COMP3.
Laat ook TCP poort 80 verkeer dat bestemd is voor COMP3, toe doorheen de
firewall.
<li>Log filterstatistieken op de externe interface.
<li>Antwoord standaard met een TCP RST of ICMP Unreachable voor geblokkeerde
pakketten.
<li>Maak de regelset zo eenvoudig en gemakkelijk mogelijk om te onderhouden.
</ul>

<a name="prep"></a>
<h3>Voorbereiding</h3>
Dit document veronderstelt dat de OpenBSD host netjes geconfigureerd is om
als router te fungeren, inclusief het verifiëren van de IP netwerksetup,
Internet-connectiviteit, en het instellen van de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> variabelen <tt>net.inet.ip.forwarding</tt> en/of
<tt>net.inet6.ip6.forwarding</tt> op "<tt>1</tt>".
U moet ook PF ingeschakeld hebben met
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.7"
>pfctl(8)</a> of door de overeenkomstige variabele in te stellen in
<tt>/etc/rc.conf.local</tt>.
PF staat standaard aan bij OpenBSD 4.6 en nieuwere versies.

<a name="ruleset"></a>
<h2>De Regelset</h2>
Het volgende zal doorheen een regelset stappen die de bovenstaande
doelstellingen vervult.

<a name="macros"></a>
<h3>Macro's</h3>
De volgende macro's worden gedefinieerd om onderhoud en het lezen van
de regelset gemakkelijker te maken:
<blockquote><pre>
int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"
</pre></blockquote>

<p>
De eerste regel definiëert de interne netwerkinterface waarop filtering zal
gebeuren.
Door ze hier te definiëren, kunnen we als we dit systeem moeten verplaatsen
naar een systeem met andere hardware, alleen die twee lijnen veranderen,
en zal de rest van de regelset nog steeds bruikbaar zijn.
(In dit voorbeeld zal de externe interface worden behandeld door de
<tt>egress</tt> interface groep.
Deze wordt automatisch ingesteld op iedere interface die een default
route heeft, in dit geval fxp0.)
De tweede en derde regel sommen de TCP poortnummers op van de
diensten die geopend zullen worden voor het Internet (SSH en ident/auth) en
de ICMP pakket-types die zullen doorgelaten worden op de firewall machine.
Tenslotte definieert de laatste lijn het IP adres van COMP3.

<p>
<b>Opmerking</b>: Als de Internetverbinding
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=4"
>PPPoE</a> vereiste, dan zou filtering en NAT moeten plaatsvinden op de
<tt>pppoe0</tt> interface en <i>niet</i> op <tt>fxp0</tt>.

<a name="options"></a>
<h3>Opties</h3>
De volgende twee opties zullen het standaard antwoord instellen voor
<tt>block</tt> filterregels en het loggen van statistieken inschakelen
voor de externe interface:
<blockquote><pre>
set block-policy return
set loginterface fxp0
</pre></blockquote>

<p>
Elk Unix systeem heeft een "loopback" interface.
Dit is een virtuele netwerkinterface die door toepassingen gebruikt worden
om binnen het systeem met elkaar te communiceren.
Op OpenBSD is de loopback interface
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
Het wordt als de beste gewoonte beschouwd om al het filteren op loopback
interfaces uit te schakelen.
Met <a href="options.html#skip">set skip</a> zullen we dat tot stand brengen.
<blockquote><pre>
set skip on lo
</pre></blockquote>
<!-- XXX this should be interface groups, but PF (at least up to
4.7) just does a substring match on the interface name -->
Merk op dat we hier alle <tt>lo</tt> interfaces overslaan,
hierdoor hoeven we ons later, mochten we bijkomende loopback interfaces
toevoegen, geen zorgen te maken over het wijzigen van dit gedeelte van ons
bestaande regelsbestand.

<a name="scrub"></a>
<a name="nat"></a>
<a name="rdr"></a>
<a name="filter"></a>
<h3>Firewall Regels</h3>

We beginnen met regels om het gebruik van
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.7"
>ftp-proxy(8)</a> te ondersteunen zodat FTP-clients op het lokale netwerk
FTP-servers op internet kunnen bereiken.
Dit functioneert door het dynamisch invoegen van regels wanneer een
ftp-verbinding wordt gemaakt.
Dit wordt gedaan met behulp van een <a href="anchors.html">anker</a>:
<blockquote><pre>
anchor "ftp-proxy/*"
</pre></blockquote>

<p>
Nu voegen we de regel toe die nodig is om FTP-verbindingen om te leiden
zodat ze worden gezien door ftp-proxy(8):
<blockquote><pre>
pass in quick on $int_if inet proto tcp to any port ftp \
    rdr-to 127.0.0.1 port 8021
</pre></blockquote>

<p>
Deze regel onderschept FTP-verbindingen naar poort 21 en leidt ze om naar
ftp-proxy(8) die draait op poort 8021 en, door het gebruik van het
<tt>quick</tt> keyword, zullen packets die matchen niet verder worden
gecontroleerd door de volgende regels van de regelset.
Indien gebruikers regelmatig verbinding maken naar FTP-servers op
andere poorten, dan zou een lijst gebruikt moeten worden om de doel-poort
aan te geven, bijvoorbeeld:
<tt>to any port { 21, 2121 }</tt>.

<p>
Merk op dat zowel de <a href="anchors.html">anker</a> als de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.7"
>ftp-proxy(8)</a> omleidingsregel voor alle <tt>match</tt> regels voor NAT
moeten staan, anders werkt ftp-proxy(8) niet zoals u verwacht.

<p>
Nu gaan we verder met enkele <tt>match</tt> regels.
Op zichzelf bepaalt een <tt>match</tt> regel niet of een packet mag worden
doorgelaten of niet.
In plaats daarvan, zullen voor de packets die overeenkomen met deze regel de
paramaters worden onthouden; deze worden vervolgens gebruikt in iedere
<tt>pass</tt> regel die dit packet behandelt.

<p>
Dit is krachtig: parameters zoals <a href="nat.html">NAT</a> of
<a href="queueing.html">queueing</a> kunnen worden toegepast op bepaalde
klasses van packets en vervolgens kunnen de toegangsrechten apart
gedefinieerd worden.

<p>
Om NAT uit te voeren voor het volledige interne netwerk wordt de volgende
<tt>match</tt> regel gebruikt:
<blockquote><pre>
match out on egress inet from !(egress:network) to any nat-to (egress:0)
</pre></blockquote>

<p>
In dit geval zou "<tt>!(egress:network)</tt>" eenvoudig vervangen kunnen
worden door "<tt>$int_if:network</tt>", naar indien u meerdere interne
interfaces zou toevoegen, zou u meerdere NAT-regels moeten toevoegen,
terwijl met deze constructie NAT wordt uitgevoerd voor alle beschermde
interfaces.

<p>
Aangezien het IP adres op de externe interface dynamisch toegekend wordt,
worden er haakjes gezet rond de vertalingsinterface zodat PF zal merken
wanneer het adres verandert.
De toevoeging :0 wordt gebruikt zodat alleen het eerste adres wordt
gebruikt voor de vertaling, mocht de externe interface meerdere adressen
hebben.

<p>
Tenslotte wordt de protocolfamilie <tt>inet</tt> (IPv4) opgegeven.
Dit voorkomt het vertalen van <tt>inet6</tt> (IPv6) packets die mogelijk
worden ontvangen.

<p>
Nu de regels die de toegang bepalen.
Start met het standaard niet toestaan:
<blockquote><pre>
block in log
</pre></blockquote>

<p>
Op dit ogenblik zal alle verkeer dat op een interface probeert binnen te
komen, geblokkeerd worden, zelfs dat van het interne netwerk.
Deze packets worden tevens gelogd.
Volgende regels zullen de firewall openen volgens de
bovenstaande doelstellingen en ook alle benodigde virtuele interfaces
openen.

<p>
Hou in het achterhoofd dat pf verkeer kan blokkeren dat binnenkomt of
buitengaat op een interface.
Het kan uw leven vereenvoudigen als u ervoor kiest om verkeer in één
richting te filteren, veeleer dan te proberen het overeind te houden wanneer
u bepaalde dingen inwaarts filtert, en andere dingen uitwaarts.
In ons geval zullen we verkiezen om inwaarts verkeer te filteren, maar
zodra het verkeer toegelaten wordt in een interface, zullen we niet
proberen het te blokkeren als het weer naar buiten gaat, dus we zullen
het volgende doen:
<blockquote><pre>
pass out quick
</pre></blockquote>

Door <tt>quick</tt> te gebruiken wordt voorkomen dat packets worden
gecontroleerd door de volgende regels, wat de prestaties verbetert.

<p>
Het is goed om de <a href="filter.html#antispoof">spoofed address
protection</a> te gebruiken:
<blockquote><pre>
antispoof quick for { lo $int_if }
</pre></blockquote>

<p>
Open nu de poorten gebruikt door die netwerkdiensten die beschikbaar zullen
zijn voor het Internet.
Eerst het verkeer dat bestemd is voor de firewall zelf:
<blockquote><pre>
pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services
</pre></blockquote>

<p>
Het specificeren van de netwerkpoorten in de macro <tt>$tcp_services</tt>
maakt het eenvoudig om bijkomende diensten te openen voor het Internet door
eenvoudigweg de macro te bewerken en de regelset te herladen. UDP diensten
kunnen ook geopend worden door een <tt>$udp_services</tt> macro aan te maken
en een filterregel toe te voegen die gelijkaardig is aan de bovenstaande
en <tt>proto udp</tt> specificeert.

<p>
De volgende regel vangt alle pogingen op om door iemand op Internet een
verbinding te maken met poort 80 op de firewall.
Legitieme poginen om deze poort te bereiken zijn van gebruiks die de
webserver op het netwerk te bereiken.
Deze verbindingspogingen moeten worden omgeleid naar COMP3:

<blockquote><pre>
pass in on egress inet proto tcp to (egress) port 80 \
    rdr-to $comp3 synproxy state
</pre></blockquote>

<p>
Voor een bijkomend beetje veiligheid, zullen we gebruik maken van de
<a href="filter.html#synproxy">TCP SYN Proxy</a> om de webserver verder
te beschermen.

<p>
ICMP verkeer moet doorgelaten worden:
<blockquote><pre>
pass in inet proto icmp all icmp-type $icmp_types
</pre></blockquote>

<p>
Gelijkaardig aan de <tt>$tcp_services</tt> macro, kan de <tt>$icmp_types</tt>
macro gemakkelijk bewerkt worden om de types van ICMP pakketten te veranderen
die zullen toegestaan worden de firewall te bereiken. Merk op dat deze regel
van toepassing is op alle netwerkinterfaces.

<p>
Nu moet verkeer naar en vanuit het interne netwerk doorgelaten worden.
We zullen aannemen dat gebruikers op het interne netwerk weten wat ze
aan het doen zijn en dat ze geen problemen gaan veroorzaken. Dit is niet
noodzakelijk een geldige veronderstelling; een veel meer beperkende regelset
zou voor vele omgevingen gepast zijn.
<blockquote><pre>
pass in on $int_if
</pre></blockquote>

<p>
TCP, UDP en ICMP verkeer wordt toegestaan om de firewall te verlaten naar het
Internet dankzij de "<tt>pass out</tt>" regel hierboven.
Toestandsinformatie wordt bijgehouden zodat de terugkerende pakketten
binnen gelaten zullen worden doorheen de firewall.

<a name="allrules"></a>
<h2>De Volledige Regelset</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macro's

int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"

# opties

set block-policy return
set loginterface fxp0
set skip on lo

# FTP Proxy regels

anchor "ftp-proxy/*"

pass in quick on $int_if inet proto tcp to any port ftp \
    rdr-to 127.0.0.1 port 8021

# match-regels

match out on egress inet from !(egress) to any nat-to (egress:0)

# filterregels

block in log
pass out quick

antispoof quick for { lo $int_if }

pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services
 
pass in on egress inet proto tcp to (egress) port 80 \
    rdr-to $comp3 synproxy state

pass in inet proto icmp all icmp-type $icmp_types

pass in on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Vorige: Firewall Redundantie met CARP en pfsync</a>]
[<a href="index.html">Inhoud</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[terug]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.43 ]<br>
$Translation: example1.html,v 1.26 2010/07/24 06:30:15 maurice Exp $<br>
-->
$OpenBSD: example1.html,v 1.22 2010/07/27 04:49:26 ajacoutot Exp $
</small>

</body>
</html> 
