<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Aufzeichnen</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Language" content="de">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="Die OpenBSD-FAQ-Seite">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2005, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../de/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="tagging.html">Zurück: Pakete markieren</a>]
[<a href="index.html">Inhalt</a>]
[<a href="perf.html">Weiter: Leistung</a>]

<p>
<h1><font color="#e00000">PF: Aufzeichnen</font></h1>

<hr>

<h3>Inhaltsverzeichnis</h3>
<ul>
<li><a href="#intro">Einführung</a>
<li><a href="#log">Pakete aufzeichnen</a>
<li><a href="#logfile">Eine Logdatei lesen</a>
<li><a href="#filter">Log-Ausgabe filtern</a>
<li><a href="#syslog">Pakete durch syslog aufzeichnen</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Einführung</h2>
In PF wird das Aufzeichnen von Paketen mit Hilfe von
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.8"
>pflogd(8)</a> realisiert, welches auf dem
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4&amp;manpath=OpenBSD+3.8"
><tt>pflog0</tt></a>-Interface lauscht und Pakete in eine Logdatei
(normalerweise /var/log/pflog) im
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.8"
>tcpdump(8)</a>-Binärformat schreibt. <a href="filter.html">Filter</a>regeln,
die das <tt>log</tt>- oder <tt>log (all)</tt>-Schlüsselwort mit angeben,
zeichen genau auf diese Art und Weise auf.

<a name="log"></a>
<h2>Pakete aufzeichnen</h2>
<p>
Damit Pakete, die PF passieren, aufgezeichnet werden können, muss das
Schlüsselwort <tt>log</tt> innerhalb der <a href="nat.html">NAT/rdr</a>-
und <a href="filter.html">Filter</a>regeln angegeben werden. Beachte,
dass PF nur Pakete aufzeichnen kann, die geblockt oder durchgelassen
werden; du kannst also keine Regel angeben, die einfach nur Pakete
aufzeichnet.

<p>
Das Schlüsselwort <tt>log</tt> bewirkt, dass alle Pakete, die auf die
Regel zutreffen, aufgezeichnet werden. Falls die Regel
<a href="filter.html#state">ein ,state' anlegt</a>, wird nur das erste
aufkommende Paket aufgezeichnet (d.&nbsp;h. das Paket, das für das
Anlegen des ,states' verantwortlich ist).

<p>
Die Optionen, die an das Schlüsselwort <tt>log</tt> übergeben werden
können, sind:

<dl>
<dt><tt>all</tt>
<dd>Sorgt dafür, dass alle zutreffenden Pakete (nicht nur das erste
Paket) aufgezeichnet werden. Insbesondere für Regeln sinnvoll, die ein
,state' anlegen.

<dt><tt>user</tt>
<dd>Sorgt dafür, dass die UNIX-Benutzer-ID und -Gruppen-ID des
Besitzers des Sockets, von dem aus das Paket gesendet/zu dem das
Paket gesendet wird, neben den standardmäßigen Loginformationen
aufgezeichnet werden.
</dl>

<p>
Optionen werden in Klammern nach dem Schlüsselwort <tt>log</tt>
angegeben; mehrere Optionen werden mit Kommas oder Leerstellen getrennt.

<blockquote>
<tt>
pass in log (all) on $ext_if inet proto tcp to $ext_if port 22 keep state
</tt>
</blockquote>

<p>
Hiermit werden alle eingehenden Pakete für den Port 22 aufgezeichnet.

<a name="logfile"></a>
<h2>Eine Logdatei lesen</h2>
Die Logdatei, die von pflogd geschrieben wird, ist im Binärformat und
kann nicht mit einem Texteditor gelesen werden. Tcpdump muss verwendet
werden, um die Log anzuzeigen.

<p>
Um die Logdatei anzusehen:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Bedenke, dass die Verwendung von tcpdump(8), um die pflog-Datei anzusehen,
<i>keine</i> Echtzeit-Anzeige ist. Eine Echtzeit-Anzeige aufgezeichneter
Pakete wird anhand des <tt>pflog0</tt>-Interfaces erreicht:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">HINWEIS: </font>
Wenn die Logs untersucht werden, sollte besondere Vorsicht mit tcpdumps
,verbose'-Protokoll-Dekodierung herrschen (diese wird mit der
<tt>-v</tt>-Kommandozeilenoption aktiviert). Tcpdumps Protokoll-Dekodierer
hat keine perfekte Sicherheitsvergangenheit. Zumindest ist in der Theorie
ein verzögerter Angriff möglich, indem die einzelnen Paket-,payloads' mit
dem Logging-Device aufgezeichnet werden. Es ist empfohlene Praxis, die
Logdateien von der Firewall-Maschine auf einen anderen Rechner zu
verschieben, bevor sie auf diesem Weg überprüft werden.

<p>
Besondere Sorgfalt sollte ebenfalls beim Absichern des Zugriffs auf
die Logs geboten sein. Standardmäßig nimmt pflogd 96 Bytes des Pakets
in die Logdatei auf. Zugriff auf die Logs könnten somit Zugriff auf
sensible Paket-,payloads' ermöglichen (wie zum Beispiel
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1&amp;manpath=OpenBSD+3.8"
>telnet(1)</a>- oder
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.8"
>ftp(1)</a>-Benutzernamen und -Passwörter).

<a name="filter"></a>
<h2>Log-Ausgabe filtern</h2>
Weil pflogd-Logs im tcpdump-Binärformat vorliegen, kann die gesamte
Palette der tcpdump-Funktionen genutzt werden, wenn die Logs wieder
angesehen werden. Zum Beispiel kann Folgendes verwendet werden, um
nur die Pakete zu sehen, die mit einem bestimmten Port übereinstimmen:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Dies kann weiter verbessert werden, indem die angezeigten Pakete
auf eine bestimmte Host- und Port-Kombination reduziert werden:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
Die gleiche Idee kann angewendet werden, wenn vom <tt>pflog0</tt>-Interface
gelesen wird:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Bedenke, dass dies keinen Einfluss darauf nimmt, welche Pakete
in die Logdatei aufgezeichnet werden; das zuvor angegebene Kommando
zeigt nur Pakete an, sobald sie aufgezeichnet werden.

<p>
Zusätzlich zu den typischen
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.8"
>tcpdump(8)</a>-Filterregeln wurde OpenBSDs tcpdump-Filtersprache so
erweitert, dass die pflogd-Ausgabe gelesen werden kann:
<ul>
<li><tt>ip</tt> - Adress-Familie ist IPv4.
<li><tt>ip6</tt> - Adress-Familie ist IPv6.
<li><tt>on <i>int</i></tt> - Pakete, die durch das <i>int</i>-Interface
hereingekommen sind.
<li><tt>ifname <i>int</i></tt> - das Gleiche wie <tt>on <i>int</i></tt>.
<li><tt>ruleset <i>name</i></tt> - der
<a href="anchors.html">Regelsatz/Anker</a>, der auf das Paket zutraf.
<li><tt>rulenum <i>num</i></tt> - Die Filterregel, auf die das Paket
zutraf, war Regelnummer <i>num</i>.
<li><tt>action <i>act</i></tt> - Die Aktion, die auf das Paket
angewandt wurde.
Mögliche Aktionen sind <tt>pass</tt> und <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - Der Grund für die Aktion (<tt>action</tt>).
Mögliche Gründe sind <tt>match</tt>, <tt>bad-offset</tt>,
<tt>fragment</tt>, <tt>short</tt>, <tt>normalize</tt>,
<tt>memory</tt>, <tt>bad-timestamp</tt>,
<tt>congestion</tt>, <tt>ip-option</tt>, <tt>proto-cksum</tt>,
<tt>state-mismatch</tt>, <tt>state-insert</tt>, <tt>state-limit</tt>,
<tt>src-limit</tt>, und <tt>synproxy</tt>.
<li><tt>inbound</tt> - Paket kam herein.
<li><tt>outbound</tt> - Paket ging heraus.
</ul>

<p>
Beispiel:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Dies zeigt die Log von eingehenden Paketen in Echtzeit an, die auf dem
wi0-Interface geblockt worden sind.

<a name="syslog"></a>
<h2>Pakete durch syslog aufzeichnen</h2>
In vielen Situationen ist es erwünscht, die Firewall-Logs im ASCII-Format
verfügbar zu haben und/oder diese zu einem entfernten Logserver zu senden.
All das kann mit zwei kleinen Shellskripten, ein paar kleinen Änderungen
an den OpenBSD-Konfigurationsdateien und
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.8"
>syslogd(8)</a>, dem Logging-Daemon, erreicht werden. Syslogd zeichnet
in ASCII auf und ist ebenfalls in der Lage, auf einen entfernten Logserver
aufzuzeichnen.

<p>
Zuerst müssen wir einen Benutzer <tt>pflogger</tt> anlegen, der eine
<tt>/sbin/nologin</tt>-Shell besitzt. Der einfachste Weg, um diesen
Benutzer anzulegen, ist
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8&amp;manpath=OpenBSD+3.8"
>adduser(8)</a>.

<p>
Nachdem wir den Benutzer <tt>pflogger</tt> angelegt haben, erstellen
wir die beiden folgenden Skripte:

<p>
<tt>/etc/pflogrotate</tt>
<pre>
	#!/bin/sh
	FILE=/home/pflogger/pflog5min.$(date "+%Y%m%d%H%M")
	kill -ALRM $(cat /var/run/pflogd.pid)
	if [ $(ls -l /var/log/pflog | cut -d " " -f 8) -gt 24 ]; then
	   mv /var/log/pflog $FILE
	   chown pflogger $FILE
	   kill -HUP $(cat /var/run/pflogd.pid)
	fi
</pre>

<p>
<tt>/home/pflogger/pfl2sysl</tt>
<pre>
	#!/bin/sh
	# feed rotated pflog file(s) to syslog
	# do not start if another instance of this script is already running
	pgrep pfl2sysl >/dev/null 2>&1
	if [ $? -ne 0 ] ; then
		for logfile in /home/pflogger/pflog5min* ; do
			if [ -f "$logfile" ] ; then
				tcpdump -n -e -ttt -r $logfile | logger -t pf -p local0.info
				rm $logfile
			fi
		done
	fi
</pre>

<p>
Editieren roots Cron-Job:
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Fügen diese beiden Zeilen mit ein:
<blockquote>
<tt>
# rotate pf log file every 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Erstellen einen Cron-Job für den Benutzer <tt>pflogger</tt>:
<blockquote>
<tt>
# crontab -u pflogger -e
</tt>
</blockquote>

<p>
Fügen die folgenden beiden Zeilen ein:
<blockquote>
<tt>
# feed rotated pflog file(s) to syslog<br>
0-59/5 *       *       *       *       /bin/sh /home/pflogger/pfl2sysl
</tt>
</blockquote>

<p>
Fügen folgende Zeile in <tt>/etc/syslog.conf</tt> mit ein:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Wenn du ebenfalls auf einen entfernten Log-Server aufzeichnen willst,
füge diese Zeile mit ein:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Stelle sicher, dass der Host <i>syslogger</i> in der
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5&amp;manpath=OpenBSD+3.8"
>hosts(5)</a>-Datei definiert wurde.

<p>
Erstelle die Datei <tt>/var/log/pflog.txt</tt>, damit syslog in der Lage
ist, in diese Datei aufzuzeichnen.
<blockquote>
<tt>
# touch /var/log/pflog.txt
</tt>
</blockquote>

<p>
Teile syslogd die Änderungen mit, indem du ihn neustartest:
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Alle aufgezeichnete Pakete werden nun zur <tt>/var/log/pflog.txt</tt>-Datei
gesendet. Wenn die zweite Zeile hinzugefügt wurde, dann werden sie
ebenfalls zum entfernten Log-Host <i>syslogger</i> gesendet.

<p>
Das Skript <tt>/etc/pflogrotate</tt> verarbeitet und entfernt danach
<tt>/var/log/pflog</tt>, so dass das Rotieren von <tt>pflog</tt> durch
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8&amp;manpath=OpenBSD+3.8"
>newsyslog(8)</a> nicht weiter notwendig ist und daher auch ausgeschaltet
werden könnte. Trotzdem wird <tt>/var/log/pflog.txt</tt>
<tt>/var/log/pflog</tt> ersetzen und das Rotieren davon sollte aktiviert
werden.
Ändere <tt>/etc/newsyslog.conf</tt> wie folgt:
<pre>
    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
PF wird nun in ASCII in <tt>/var/log/pflog.txt</tt> aufzeichnen. Wenn
es in <tt>/etc/syslog.conf</tt> so angeben wurde, wird ebenfalls auf
einen entfernten Log-Server aufgezeichnet. Das Aufzeichnen findet
nicht sofort statt, stattdessen kann es bis zu 5 oder 6 Minuten dauern
(das Cron-Job-Intervall), bevor aufgezeichnete Pakete in der
Datei auftauchen.

<p>
[<a href="tagging.html">Zurück: Pakete markieren</a>]
[<a href="index.html">Inhalt</a>]
[<a href="perf.html">Weiter: Leistung</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[zurück]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: logging.html,v 1.25 ]
$Translation: logging.html,v 1.16 2006/01/10 12:18:04 paldium Exp $
-->
$OpenBSD: logging.html,v 1.16 2006/01/14 11:36:00 jufi Exp $
</small>

</body>
</html> 
