<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Authpf: Benutzer-Shell für authentifizierende Gateways</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta http-equiv="Content-Language" content="de">
<meta name="description"   content="die OpenBSD-FAQ-Seite">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../de/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="ftp.html">Zurück: Probleme mit FTP</a>]
[<a href="index.html">Inhalt</a>]
[<a href="example1.html">Weiter: Beispiel: Firewall für zuhause oder
ein kleines Büro</a>]

<h1><font color="#e00000">PF: Authpf: Benutzer-Shell für authentifizierende
Gateways</font></h1>

<hr>

<h3>Inhaltsverzeichnis</h3>
<ul>
<li><a href="#intro">Einführung</a>
<li><a href="#config">Konfiguration</a>
	<ul>
	<li><a href="#linkmain">Authpf in den Hauptregelsatz einbinden</a>
	<li><a href="#loadrules">Geladene Regeln konfigurieren</a>
	<li><a href="#acl">Access-Control-Listen</a>
	<li><a href="#shell">Authpf als Shell eines Benutzers zuweisen</a>
	</ul>
<li><a href="#wholog">Sehen, wer eingeloggt ist</a>
<li><a href="#moreinfo">Weitere Informationen</a>
<li><a href="#example">Beispiel</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Einführung</h2>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>Authpf(8)</a> ist eine Benutzer-Shell für authentifizierende Gateways. Ein
authentifizierendes Gateway ist wie jedes gewöhnliche Gateway (a.k.a.
ein Router), ausgenommen, dass Benutzer sich erst authentifizieren
müssen, bevor der Gateway den Verkehr durchlässt. Wenn eine
Benutzer-Shell auf <tt>/usr/sbin/authpf</tt> gestellt ist (z.B. statt
die Benutzer-Shell auf
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1&amp;manpath=OpenBSD+3.6"
>ksh(1)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=csh&amp;sektion=1&amp;manpath=OpenBSD+3.6"
>csh(1)</a>, etc. zu stellen) und der Benutzer unter Verwendung von
SSH einloggt, wird authpf alle notwendigen Änderungen an dem aktiven
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.6"
>pf(4)</a>-Regelsatz durchzuführen, so dass der Verkehr des Benutzers
durch den Filter geleitet und/oder unter Verwendung von Network Address
Translation oder Umleitung übersetzt wird. Sobald der Benutzer sich
ausloggt oder seine Sitzung unterbrochen wird, wird authpf jegliche
Regeln entfernen, die für den Benutzer geladen worden sind, und
trennt alle ,stateful' Verbindungen, die vom Benutzer geöffnet worden
sind. Daher besteht die Möglichkeit des Benutzers, seinen Verkehr durch
das Gateway zu leiten, nur solange er seine SSH-Sitzung offen hält.

<p>
Authpf ändert den aktiven
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.6"
>pf(4)</a>-Regelsatz ab, indem Regeln einem
<a href="anchors.html#named">benannten Regelsatz</a> hinzugefügt werden,
der einem <a href="anchors.html">Ankerpunkt</a> angehängt ist.
Jedes Mal, wenn sich ein Benutzer authentifiziert, erstellt
autpf einen benannten Regelsatz und lädt vorkonfigurierte
<a href="filter.html">Filter</a>-, <a href="nat.html"><tt>nat</tt></a>-,
<a href="nat.html#binat"><tt>binat</tt></a>- und
<a href="rdr.html"><tt>rdr</tt></a>-Regeln hinein. Die Regeln, die authpf
lädt, können auf einer Benutzer-spezifischen oder System-weiten Basis
konfiguriert werden.

<p>
Beispielverwendungen von authpf beinhalten:
<ul>
<li>Vom Benutzer erwarten, sich zu authentifizieren, bevor Zugriff auf
das Internet erlaubt wird.
<li>Bestimmten Benutzern -- wie zum Beispiel Administratoren --
Zugriff auf eingeschränkte Teile des Netzwerks erlauben.
<li>Nur bekannten Benutzern den Zugriff auf den Rest des Netzwerkes
oder auf das Internet von drahtlosen Netzwerksegmenten aus erlauben.
<li>Arbeitnehmern, die zuhause oder unterwegs arbeiten, etc., Zugriff
auf die Ressourcen im Netzwerk der Firma erlauben. Benutzer, die
außerhalb des Büros sind, können dann nicht nur auf das Firmennetz
zugreifen, sondern können auch auf bestimmte Ressourcen (z.B. ihren
eigenen Desktop) weitergeleitet werden, jenachdem, mit welchem
Benutzernamen sie sich authentifizieren.
<li>An Orten wie beispielsweise einer Bibliothek oder anderen Plätzen
mit öffentlichen Internet-Terminals, könnte PF so konfiguriert werden,
dass Gast-Benutzern nur begrenzter Internetzugriff erlaubt wird. Authpf
kann dann ebenfalls benutzt werden, um registrierten Benutzern den
vollen Internetzugriff zu gewähren.
</ul>

<p>
Authpf loggt den Benutzernamen und die IP-Adresse von jedem Benutzer,
der sich erfolgreich authentifiziert, so wie auch die Start- und
Endzeiten ihrer Login-Sitzung per
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>syslogd(8)</a>. Unter Verwendung dieser Informationen kann ein
Administrator erfahren, wer wann eingeloggt war und Benutzer somit
für ihren Netzwerkverkehr belangbar machen.

<a name="config"></a>
<h2>Konfiguration</h2>
Die Basis-Schritte, die benötigt werden, um authpf zu konfigurieren,
werden hier aufgelistet. Für eine komplette Beschreibung von authpfs
Konfiguration greife bitte auf die
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>authpf-Manual-Seite</a> zurück.

<a name="linkmain"></a>
<h3>Authpf in den Hauptregelsatz einbinden</h3>
Authpf wird unter Verwendung von <tt>anchor</tt>-Regeln in den
Hauptregelsatz eingebunden:
<blockquote>
<tt>
nat-anchor "authpf/*"<br>
rdr-anchor "authpf/*"<br>
binat-anchor "authpf/*"<br>
anchor "authpf/*"<br>
</tt>
</blockquote>

<p>
Überall dort, wo <tt>anchor</tt>-Regeln innerhalb des Regelsatzes
platziert wurden, wird PF vom Hauptregelsatz abzweigen, um die
authpf-Regeln zu verarbeiten. Es ist nicht notwendig, dass alle vier
<tt>anchor</tt>-Regeln vorhanden sind; wenn authpf zum Beispiel nicht
so aufgesetzt wurde, dass es irgendwelche <tt>nat</tt>-Regeln laden
soll, kann die <tt>nat-anchor</tt>-Regel ausgelassen werden.

<a name="loadrules"></a>
<h3>Geladene Regeln konfigurieren</h3>
Authpf lädt seine Regeln von einer dieser beiden Dateien:
<ul>
<li><tt>/etc/authpf/users/$USER/authpf.rules</tt>
<li><tt>/etc/authpf/authpf.rules</tt>
</ul>

<p>
Die erste Datei beinhaltet Regeln, die nur geladen werden, wenn sich der
Benutzer <tt>$USER</tt> (dies wird mit dem Benutzernamen des Benutzers
ausgetauscht) einloggt. Die Benutzer-spezifische Regelkonfiguration wird
verwendet, wenn ein bestimmter Benutzer -- wie zum Beispiel ein
Administrator -- einen Satz von Regeln benötigt, die vom standardmäßigen
Satz abweichen. Die zweite Datei beinhaltet die standardmäßigen Regeln,
die für jeden Benutzer geladen werden, der keine eigene
<tt>authpf.rules</tt>-Datei hat. Wenn die Benutzer-spezifische Datei
existiert, wird sie die standardmäßige Datei überschreiben. Zumindest
eine von beiden Dateien muss existierieren, ansonsten wird authpf
nicht laufen.

<p>
Filter- und Übersetzungsregeln haben die gleiche Syntax wie jede
anderer PF-Regelsatz mit einer Ausnahme: Authpf erlaubt die Verwendung
von zwei vordefinierten Makros:
<ul>
<li><tt>$user_ip</tt> - Die IP-Adresse des eingeloggten Benutzers
<li><tt>$user_id</tt> - Der Benutzername des eingeloggten Benutzers
</ul>

<p>
Es ist empfohlene Praxis, das <tt>$user_ip</tt>-Makro zu verwenden,
um nur den Verkehr durch das Gateway von dem Computer des
authentifizierten Benutzers zu erlauben.

<a name="acl"></a>
<h3>Access-Control-Listen</h3>
Benutzern kann die Verwendung von authpf verweigert werden, indem eine
Datei in dem <tt>/etc/authpf/banned/</tt>-Verzeichnis erstellt und sie
nach dem Benutzernamen benannt wird, dem der Zugriff verweigert werden
soll. Der Inhalt dieser Datei wird den Benutzern angezeigt werden, bevor
authpf ihre Verbindung wieder trennt. Dies erlaubt einen einfachen Weg,
um Benutzern mitzuteilen, warum ihnen der Zugriff entzogen wurde und an
wen sie sich wenden müssen, wenn ihr Zugriff wiederhergestellt werden
soll.

<p>
So gesagt ist es ebenfalls möglich, nur bestimmte Benutzer zu erlauben,
indem der Benutzername in die <tt>/etc/authpf/authpf.allow</tt>-Datei
eingetragen wird. Wenn die <tt>/etc/authpf/authpf.allow</tt>-Datei nicht
existiert oder ,<tt>*</tt>' in die Datei eingetragen wurde, wird authpf
jedem Benutzer, der sich erfolgreich über SSH eingeloggt hat, den Zugriff
erlauben, solange dieser nicht explizit gebannt wurde.

<p>
Wenn authpf nicht in der Lage ist herauszufinden, ob ein Benutzername
erlaubt oder verboten ist, wird es eine kurze Nachricht ausgeben und
den Benutzer wieder trennen. Ein Eintrag in <tt>/etc/authpf/banned/</tt>
überschreibt immer einen Eintrag in <tt>/etc/authpf/authpf.allow</tt>.

<a name="shell"></a>
<h3>Authpf als Shell eines Benutzers zuweisen</h3>
Damit authpf funktionieren kann, muss es als Login-Shell einem Benutzer
zugewiesen sein. Wenn der Benutzer sich erfolgreich mit
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>sshd(8)</a>
authentifiziert, wird authpf als Benutzer-Shell ausgeführt. Es wird dann
überprüfen, ob dem Benutzer erlaubt wurde, authpf zu benutzen, lädt die
Regeln aus den passenden Dateien, etc.

<p>
Es gibt einige Wege, um authpf als Benutzer-Shell zuzuweisen:
<ol>
<li>Manuell für jeden Benutzer unter Verwendung von
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1&amp;manpath=OpenBSD+3.6"
>chsh(1)</a>, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>vipw(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>useradd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>usermod(8)</a>, etc.
<li>Durch das Zuweisen eines Benutzer zu einer Login-Klasse und dem
Ändern der <tt>shell</tt>-Option dieser Klasse in
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5&amp;manpath=OpenBSD+3.6"
><tt>/etc/login.conf</tt></a>.
</ol>

<a name="wholog"></a>
<h2>Sehen, wer eingeloggt ist</h2>
Sobald sich ein Benutzer erfolgreich eingeloggt hat und authpf die
PF-Regeln angepasst hat, ändert authpf den Prozesstitel um auf den
Benutzernamen und die IP-Adresse des eingeloggten Benutzer zu deuten:
<pre>
    # ps -ax | grep authpf
    23664 p0  Is+     0:00.11 -authpf: charlie@192.168.1.3 (authpf)
</pre>

<p>
Hier ist der Benutzer <tt>charlie</tt> von der Maschine 192.168.1.3 aus
eingeloggt. Durch das Senden eines SIGTERM-Signals zum authpf-Prozesses
wird der Benutzer gewaltsam ausgeloggt. Authpf wird ebenfalls jegliche
geladenen Regeln entfernen, die für den Benutzer bestimmt waren und
schließt alle ,stateful' Verbindungen, die der Benutzer geöffnet hat.
<pre>
    # kill -TERM 23664
</pre>

<a name="moreinfo"></a>
<h2>Weitere Informationen</h2>

Für eine komplette Beschreibung von authpfs Funktionsweise, greife
bitte auf die
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>authpf-Manual-Seite</a> zurück.

<a name="example"></a>
<h2>Beispiel</h2>
Authpf wird auf einem OpenBSD-Gateway verwendet, um Benutzer eines
drahtlosen Netzwerkes zu authentifizieren, welches Teil eines größeren
Campus-Netzwerkes ist. Sobald ein Benutzer sich authentifiziert hat,
vorausgesetzt, dass er nicht auf der Bannliste steht, wird ihm
erlaubt, eine SSH-Verbindung nach außen aufzubauen und im Web zu
surfen (einschließlich sicheren Webseiten), zusätzlich zu dem Zugriff auf
einen der Campus-DNS-Server.

<p>
Die <tt>/etc/authpf/authpf.rules</tt>-Datei beinhaltet folgende Regeln:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

pass in quick on $wifi_if proto udp from $user_ip to $dns_servers \
   port domain keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
Der administrative Benutzer <tt>charlie</tt> braucht die Möglichkeit,
auf die SMTP- und POP3-Server vom Campus zuzugreifen, sowie im Web
zu surfen und SSH zu verwenden. Die folgenden Regeln wurden in
<tt>/etc/authpf/users/charlie/authpf.rules</tt> eingestellt:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
smtp_server = "10.0.1.50"
pop3_server = "10.0.1.51"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

pass in quick on $wifi_if proto udp from $user_ip to $dns_servers \
   port domain keep state
pass in quick on $wifi_if proto tcp from $user_ip to $smtp_server \
   port smtp flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to $pop3_server \
   port pop3 flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
Der Hauptregelsatz -- der sich in <tt>/etc/pf.conf</tt> befindet --
wurde wie folgt aufgesetzt:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros
wifi_if = "wi0"
ext_if  = "fxp0"

scrub in all

# filter
block drop all

pass out quick on $ext_if proto tcp from $wifi_if:network flags S/SA \
   modulate state
pass out quick on $ext_if proto { udp, icmp } from $wifi_if:network \
   keep state

pass in quick on $wifi_if proto tcp from $wifi_if:network to $wifi_if \
   port ssh flags S/SA keep state

anchor "authpf/*" in on $wifi_if
</pre>
</td></tr>
</table>

<p>
Der Regelsatz ist sehr einfach und macht folgendes:
<ul>
<li>Blockiere alles (standardmäßiges Blocken).
<li>Lasse ausgehenden TCP-, UDP- und ICMP-Verkehr durch das externe
Interface vom drahtlosen Netzwerk durch.
<li>Lasse eingehenden SSH-Verkehr vom drahtlosen Netzwerk durch, der für
das Gateway bestimmt ist. Diese Regel ist notwendig, damit sich
Benutzer einloggen können.
<li>Erzeuge einen Ankerpunkt ,authpf' für eingehenden Verkehr auf dem
drahtlosen Interface.
</ul>

<p>
Die Idee hinter dem Hauptregelsatz ist, alles zu blocken und nur so
wenig Verkehr zuzulassen wie möglich. Der Verkehr kann frei durch das
externe Interface fließen, doch wird alles durch die ,standardmäßiges
Blocken'-Richtlinie am Eindringen in das drahtlose Netzwerk-Interface
gehindert. Sobald sich ein Benutzer authentifiziert, wird der Verkehr von
ihm das drahtlose Interface passieren dürfen, um von dort aus durch das
Gateway in den Rest des Netzwerkes fließen zu dürfen. Das
<tt>quick</tt>-Schlüsselwort wird durchgehend verwendet, so dass PF nicht
jeden benannten Regelsatz überprüfen muss, wenn eine neue Verbindung durch
das Gateway gelassen wird.

<p>
[<a href="ftp.html">Zurück: Probleme mit FTP</a>]
[<a href="index.html">Inhalt</a>]
[<a href="example1.html">Weiter: Beispiel: Firewall für zuhause oder
ein kleines Büro</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[zurück]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: authpf.html,v 1.10 ]<br>
$Translation: authpf.html,v 1.6 2004/12/22 12:29:53 paldium Exp $<br>
$OpenBSD: authpf.html,v 1.6 2004/12/22 20:00:48 jufi Exp $
</small>

</body>
</html> 
