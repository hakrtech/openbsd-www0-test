<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Probleme mit FTP</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta http-equiv="Content-Language" content="de">
<meta name="description"   content="Die OpenBSD-FAQ-Seite">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003, 2004, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../de/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="perf.html">Zurück: Leistung</a>]
[<a href="index.html">Inhalt</a>]
[<a href="authpf.html">Weiter: Authpf: Benutzer-Shell für authentifizierende
Gateways</a>]

<p>
<h1><font color="#e00000">PF: Probleme mit FTP</font></h1>
<hr>

<h3>Inhaltsverzeichnis</h3>
<ul>
<li><a href="#modes">FTP-Modi</a>
<li><a href="#client">FTP-Client hinter der Firewall</a>
<li><a href="#server">Ein FTP-Server, der ,sich selbst mit PF schützt'</a>
<li><a href="#natserver">FTP-Server, die durch eine externe PF-Firewall
beschützt werden, die NAT verwendet</a>
<li><a href="#info">Weitere Informationen zum Thema FTP</a>
</ul>

<hr>

<a name="modes"></a>
<h2>FTP-Modi</h2>
FTP ist ein Protokoll, das zu der Zeit entwickelt wurde, als das Internet
noch eine kleine, freundliche Ansammlung von Computern war und jeder
jeden kannte. Zu dieser Zeit war die Notwendigkeit zum Filtern und für
straffe Sicherheit nicht gegeben. FTP wurde nicht zum Filtern, zum
Weiterleiten durch Firewalls oder für die Zusammenarbeit mit NAT
entwickelt.

<p>
Du kannst FTP auf zwei unterschiedliche Weisen verwenden: passiv oder
aktiv. Generell gilt, dass die Wahl zwischen aktiv und passiv entscheidet,
wer das Problem mit der Firewall haben wird. Sei realistisch, du wirst
beide unterstützen müssen, um glückliche Anwender zu haben.

<p>
Bei aktivem FTP wird der FTP-Server eine neue Verbindung zurück zum -Client
eröffnen, um die angefragten Daten zu übertragen, wenn ein Benutzer sich
zu einem entfernten FTP-Server verbindet und eine Information oder Datei
anfragt. Diese wird als <i>data connection</i> bezeichnet. Am Anfang
entscheidet der FTP-Client sich für einen zufälligen Port, auf dem die
,data connection' angenommen werden soll. Der Client sendet dann die
gewählte Portnummer zum FTP-Server und lauscht dann auf dem Port für eine
eingehende Verbindung. Der FTP-Server erstellt dann eine Verbindung zur
Adresse vom Client am gewählten Port und überträgt die Daten. Dies ist ein
Problem für Benutzer, die auf einen FTP-Server zugreifen wollen, wenn sie
selbst hinter einem NAT-Gateway liegen. Wegen der Funktionsweise von NAT
wird der FTP-Server eine ,data connection' zur externen Adresse des
NAT-Gateways auf dem gewählten Port aufbauen. Die NAT-Maschine wird diese
Verbindung erhalten, aber da sie nicht in der ,state'-Tabelle aufgelistet
ist, wird sie das Paket fallen lassen und nicht zum Client weiterleiten.

<p>
Beim passiven FTP-Modus (dem standardmäßigem Modus mit OpenBSDs <a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.7"
>ftp(1)</a>-Client) wird der Client vom Server verlangen, dass dieser
einen zufälligen Port auswählen soll, auf dem er dann auf die
,data connection' wartet. Der Server teilt dem Client mit, welchen
Port er ausgewählt hat und der Client verbindet sich auf diesen Port,
um die Daten zu übertragen. Unglücklicherweise ist dies nicht immer
möglich oder erwünscht, da die Möglichkeit besteht, dass eine Firewall
vor dem FTP-Server die eingehende ,data connection' blockt. OpenBSDs
ftp(1) verwendet standardmäßig den passiven Modus; um aktives FTP
zu erzwingen, verwende die -A-Option mit ftp oder setze den passiven
Modus aus (off), indem du das Kommando ,<tt>passive off</tt>' am
,<tt>ftp&gt;</tt>' Prompt eingibst.

<a name="client"></a>
<h2>FTP-Client hinter der Firewall</h2>
Wie zuvor schon angedeutet, geht FTP nicht sonderlich gut durch NAT
und Firewalls hindurch.


<p>
Packet Filter bietet eine Lösung für dieses Problem, indem der
FTP-Verkehr durch einen FTP-Proxyserver hindurch geleitet wird. Dieser
Prozess ,leitet' deinen FTP-Verkehr durch das NAT-Gateway/durch die
NAT-Firewall. Der FTP-Proxy, der von OpenBSD und PF verwendet wird,
ist
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>ftp-proxy(8)</a>. Um ihn zu aktivieren, erstelle in der NAT-Sektion
von <tt>pf.conf</tt> etwas, das ähnlich diesem Eintrag ist:

<blockquote>
<tt>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \<br>
&nbsp;&nbsp;&nbsp;port 8021
</tt>
</blockquote>

<p>
Die Erklärung dieser Zeile ist: "Verkehr auf dem internen Interface wird
zum Proxyserver weitergeleitet, der auf dieser Maschine läuft und auf
dem Port 8021 lauscht."

<p>
Hoffentlich ist es offensichtlich, dass der Proxyserver auf dem
OpenBSD-Rechner gestartet werden und auch laufen muss. Dies wird durch das
Eintragen der folgenden Zeile in die <tt>/etc/inetd.conf</tt> realisiert:

<blockquote>
<tt>
127.0.0.1:8021 stream tcp nowait root /usr/libexec/ftp-proxy \<br>
&nbsp;&nbsp;&nbsp;ftp-proxy -n
</tt>
</blockquote>

<p>
Bedenke, dass die <tt>-n</tt>-Option nur notwendig ist, wenn die
OpenBSD-Maschine als NAT arbeitet.
Sende jetzt ein ,HUP'-Signal zum
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>inetd(8)</a>, so dass dieser seine Konfigurationsdatei neu einließt.
Ein Weg, das ,HUP'-Signal zu senden, ist, folgendes Kommando einzugeben:

<blockquote>
<tt>
kill -HUP `cat /var/run/inetd.pid`
</tt>
</blockquote>

<p>
Du wirst bemerken, dass der ftp-proxy auf den Port 8021 hört, dem
gleichen Port, auf den in der vorherigen <tt>rdr</tt>-Angabe der
FTP-Verkehr weitergeleitet wird. Die Wahl von Port 8021 ist willkürlich,
wobei 8021 eine gute Wahl ist, da dieser für keine andere Applikation
definiert wurde.

<p>
Zu diesem Zeitpunkt werden nur passive FTP-Verbindungen funktionieren.
Um aktive Verbindungen ebenfalls zu ermöglichen, muss die ,ftp-data
connection', die der FTP Server aufbaut, zur Firewall durchgelassen
werden.
Leider kann der Port, auf den die Verbindung aufgebaut werden soll,
nicht vorhergesagt werden, nur der Bereich, in dem dieses möglich sein
könnte.
Was jedoch bekannt ist, ist, dass die Verbindung vom Port 20
(ftp-data-Port) aus errichtet wird, und dass der ftp-proxy die Verbindung
akzeptieren wird (und dann die Daten zum Client weiterleitet).
Da der ftp-proxy als Benutzer <tt>proxy</tt> läuft, kann das
<tt>user</tt>-Schlüsselwort in der Filterregel angewandt werden.

<blockquote>
<tt>
pass in on $ext_if inet proto tcp from port 20 to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;&nbsp;user proxy flags S/SA keep state
</tt>
</blockquote>

<p>
Bedenke bitte, dass der ftp-proxy(8) dazu da ist, den <b>FTP-Clients</b>
hinter einem PF-Filter zu helfen; er kann keinen <b>FTP-Server</b> hinter
einem PF-Filter handhaben.


<a name="server"></a>
<h2>Ein FTP-Server, der ,sich selbst mit PF schützt'</h2>
In diesem Fall läuft PF direkt auf dem FTP-Server, statt auf einem
extra dafür installiertem Firewall-Computer. Wenn eine passive
FTP-Verbindung angeboten wird, wird FTP zufällig einen hohen TCP-Port
für eingehende Daten auswählen. Standardmäßig wird OpenBSDs nativer
FTP-Server
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>ftpd(8)</a>
einen Port aus dem Bereich 49152 bis 65535 nutzen.
Diese müssen selbstverständlich durch die Filterregeln gelassen werden,
zusätzlich zum Port 21 (dem FTP-Kontroll-Port):

<blockquote>
<tt>
pass in on $ext_if proto tcp from any to any port 21 keep state<br>
pass in on $ext_if proto tcp from any to any port &gt; 49151 \<br>
&nbsp;&nbsp;&nbsp;keep state
</tt>
</blockquote>

<p>
Wenn du möchtest, kannst du den Bereich der Ports beachtlich
verbessern. Im Falle vom OpenBSD
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>ftpd(8)</a>-Programm wird dies durch die Verwendung von den
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>sysctl(8)</a>-Variablen <tt>net.inet.ip.porthifirst</tt> und
<tt>net.inet.ip.porthilast</tt> ermöglicht.

<a name="natserver"></a>
<h2>FTP-Server, die durch eine externe PF-Firewall beschützt werden,
die NAT verwendet</h2>
In diesem Fall muss die Firewall den Verkehr zum FTP-Server zusätzlich
zum Durchlassen der Ports auch weiterleiten. Um das Beispiel einfach
zu halten, nehmen wir an, dass wieder der normale OpenBSD-
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>ftpd(8)</a> unter Verwendung des standardmäßigen Portbereichs genutzt
wird.

<p>
Hier ist ein Beispiel-Unterregelsatz, der dies realisieren würde:
<blockquote>
<tt>
ftp_server = "10.0.3.21"<br>
<br>
rdr on $ext_if proto tcp from any to any port 21 -&gt; $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21<br>
rdr on $ext_if proto tcp from any to any port 49152:65535 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$ftp_server port 49152:65535<br>
<br>
# in on $ext_if<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21 keep state<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port &gt; 49151 keep state<br>
<br>
# out on $int_if<br>
pass out quick on $int_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21 keep state<br>
pass out quick on $int_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port &gt; 49151 keep state
</tt>
</blockquote>


<a name="info"></a>
<h2>Weitere Informationen zum Thema FTP</h2>
Weitere Informationen zum Thema FTP-Filtern und wie FTP generell
funktioniert, können in diesem ,whitepaper' gefunden werden:
<ul>
<li><a href="http://www.pintday.org/whitepapers/ftp-review.shtml">FTP
Reviewed</a>
</ul>

<p>
[<a href="perf.html">Zurück: Leistung</a>]
[<a href="index.html">Inhalt</a>]
[<a href="authpf.html">Weiter: Authpf: Benutzer-Shell für authentifizierende
Gateways</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[zurück]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: ftp.html,v 1.18 ]
$Translation: ftp.html,v 1.7 2005/05/20 16:33:52 paldium Exp $
-->
$OpenBSD: ftp.html,v 1.7 2005/05/20 17:13:26 jufi Exp $
</small>

</body>
</html> 
