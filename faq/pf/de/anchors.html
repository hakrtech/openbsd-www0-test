<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Anker und Benannte Regelsätze</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta http-equiv="Content-Language" content="de">
<meta name="description"   content="die OpenBSD-FAQ-Seite">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="scrub.html">Zurück: Scrub (Paketnormalisierung)</a>]
[<a href="index.html">Inhalt</a>]
[<a href="queueing.html">Weiter: Paket-Queueing und Priorisierung</a>]

<p>
<h1><font color="#e00000">PF: Anker und benannte Regelsätze</font></h1>

<hr>

<h3>Inhaltsverzeichnis</h3>
<ul>
<li><a href="#intro">Einführung</a>
<li><a href="#named">Benannte Regelsätze</a>
<li><a href="#options">Anker-Optionen</a>
<li><a href="#manip">Anker manipulieren</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Einführung</h2>
Zusätzlich zu den Hauptregelsätzen kann PF ebenfalls Unterregelsätze
festsetzen. Seit Unterregelsätze ,on the fly' unter Verwendung von
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>pfctl(8)</a> manipuliert werden können, bieten sie einen praktischen Weg,
um einen aktiven Regelsatz dynamisch zu verändern. Während eine
<a href="tables.html">Tabelle</a> verwendet wird, um eine dynamische
Liste von Adressen zu halten, wird ein Unterregelsatz verwendet, um
einen dynamischen Satz von Filter-, <tt>nat</tt>-, <tt>rdr</tt>- und
<tt>binat</tt>-Regeln zu halten.

<p>
Unterregelsätze werden mit Hilfe von Ankern an den Hauptregelsatz
angehängt. Es gibt vier Typen dieser <tt>Anker</tt>-Regeln:
<ul>
<li><tt>anchor <i>name</i></tt> - weist alle <a href="filter.html">
Filter</a>regeln dem Anker <i><tt>name</tt></i> zu
<li><tt>binat-anchor <i>name</i></tt> - weist alle
<a href="nat.html#binat"><tt>binat</tt></a>-Regeln dem Anker
<i><tt>name</tt></i> zu
<li><tt>nat-anchor <i>name</i></tt> - weist alle <a href="nat.html">
<tt>nat</tt></a>-Regeln dem Anker <i><tt>name</tt></i> zu
<li><tt>rdr-anchor <i>name</i></tt> - weist alle <a href="rdr.html">
<tt>rdr</tt></a>-Regeln dem Anker <i><tt>name</tt></i> zu
</ul>

<tt>anchor</tt>-Regeln werden relativ zu dem Anker zugewiesen, in welchem
sie geladen werden. Zum Beispiel werden <tt>anchor</tt>-Regeln im
Hauptregelsatz Ankeranhänge erzeugen, die auf den Hauptregelsatz als
ihre Eltern zeigen und <tt>anchor</tt> Regeln, die aus Dateien mit der
<tt>load anchor</tt> Direktive geladen worden sind, werden Ankerpunkte
mit diesen Ankern als ihre Eltern erzeugen.

<a name="named"></a>
<h2>Anker</h2>
Ein Anker ist eine Kollektion von Filter- und/oder Übersetzungsregeln,
Tabellen und anderen Ankern, denen ein Name zugewiesen wurde.
Wenn PF auf eine <tt>anchor</tt>-Regel im Hauptregelsatz trifft, wird
es die Regeln, die in diesem <tt>anchor</tt>-Punkt liegen, genauso
wie die Regeln im Hauptregelsatz zuweisen. Die Verarbeitung wird dann
mit dem Hauptregelsatz weitergesetzt, außer das Paket trifft auf eine
Filterregel, die die <tt>quick</tt>-Option gesetzt hat, oder auf eine
Übersetzungsregel innerhalb des Ankers zu, so dass in diesem Fall die
Übereinstimmung als final angesehen wird und in einem Abbruch der
Überprüfungen der Regeln in sowohl dem Anker als auch im Hauptregelsatz
endet.


<p>
Zum Beispiel:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor goodguys
</tt>
</blockquote>

<p>
Dieser Regelsatz setzt eine ,standardmäßiges Blocken'-Richtlinie auf
<tt>fxp0</tt> für sowohl einkommenden als auch ausgehenden Verkehr.
Der Verkehr wird dann zustandsmäßig (statefully) herausgelassen und
eine Ankerregel wird mit dem Namen <tt>goodguys</tt> erstellt. Anker
können auf zwei Arten mit Regeln gefüllt werden:
<ul>
<li>eine <tt>load</tt>-Regel verwenden
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>pfctl(8)</a>
verwenden
</ul>

<p>
Die <tt>load</tt>-Regel sorgt dafür, dass <tt>pfctl</tt> den angegebenen
Anker und benannten Regelsatz durch das Lesen von Regeln aus einer Textdatei
anlegt. Beispiel:
<blockquote>
<tt>
load anchor goodguys:ssh from "/etc/anchor-goodguys-ssh"
</tt>
</blockquote>

<p>Wenn der Hauptregelsatz geladen ist, werden die Regeln, die in der Datei
<tt>/etc/anchor-goodguys-ssh</tt> aufgelistet sind, in den benannten
Regelsatz <tt>ssh</tt> geladen, welcher an den <tt>goodguys</tt>-Anker
angehängt ist.

<p>
Um Regeln unter Verwendung von <tt>pfctl</tt> einem Anker hinzuzufügen,
kann der folgende Befehlstyp verwendet werden:
<blockquote>
<tt>
# echo "pass in proto tcp from 192.0.2.3 to any port 22" \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys/ssh -f -
</tt>
</blockquote>

<p>
Dies fügt eine <tt>pass</tt>-Regel dem Anker namens <tt>ssh</tt> hinzu,
welcher dem <tt>goodguys</tt>-Anker angehängt wurde. PF wird nun diese
Regel berücksichtigen (und jede andere Filterregel, die hinzugefügt wird),
wenn es die <tt>anchor "goodguys/*"</tt>-Zeile im Hauptregelsatz erreicht.

<p>
Regeln können ebenfalls in eine Textdatei gespeichert und geladen werden:
<blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys:www -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
Dies lädt die Regeln aus der <tt>/etc/anchor-goodguys-www</tt>-Datei
in den benannten Regelsatz <tt>www</tt> im <tt>goodguys</tt>-Anker.

<p>
Filter- und Übersetzungsregeln können unter Verwendung der gleichen
Syntax und Optionen in einen benannten Regelsatz wie Regeln in den
Hauptregelsatz geladen werden.
Ein Haken jedoch ist, dass jegliche <a href="macros.html">Makros</a>,
die verwenden werden, ebenfalls im benannten Regelsatz definiert
werden müssen; Makros, die im Hauptregelsatz definiert worden sind,
sind von benannten Regelsätzen aus <i>nicht</i> sichtbar.

<p>
Jeder benannte Regelsatz, wie auch der Hauptregelsatz, existiert separat
neben anderen Regelsätzen. Operationen, die in einem Regelsatz ausgeführt
werden, wie zum Beispiel die Regeln zu ,flush'en, haben keine Auswirkung
auf andere. Ebenfalls wird das Entfernen eines Ankerpunktes aus dem
Hauptregelsatz keinen Anker oder irgendeinen benannten Regelsatz
zerstören, die diesem Anker angehängt worden sind. Ein benannter Regelsatz
wird nicht zerstört, bis er von allen Regeln unter Verwendung von
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>pfctl(8)</a>
ge,flush't wird. Sobald einem Ankerpunkt kein benannter Regelsatz mehr
angehängt ist, wird er ebenfalls zerstört.

<a name="options"></a>
<h2>Anker-Optionen</h2>
Wenn gewünscht, können <tt>anchor</tt>-Regeln ein Interface, Protokoll,
Quell- und Zieladresse, Tags, etc., unter Verwendung der selben
Syntax der Filterregeln spezifizieren. Wenn solche Information gegeben
sind, werden <tt>anchor</tt>-Regeln nur verarbeitet, wenn das Paket mit
der Regeldefinition vom <tt>anchor</tt> übereinstimmt.
Zum Beispiel:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor ssh in on $ext_if proto tcp from any to any port 22<br>
</tt>
</blockquote>

<p>
Die Regeln in dem Anker <tt>ssh</tt> werden nur für TCP-Pakete
verarbeitet, die für den Port 22 bestimmt sind und über
<tt>fxp0</tt> hereinkommen. Regeln werden wie folgt dem
<tt>anchor</tt> angehängt:
<blockquote>
<tt>
# echo "pass in from 192.0.2.10 to any" | pfctl -a ssh/allowed -f -
</tt>
</blockquote>

<p>
So, selbst wenn die Filterregel kein Interface, Protokoll oder Port
angibt, wird dem Host 192.0.2.10 die Verbindung nur erlaubt sein, wenn
er SSH verwendet, da die Definition der <tt>anchor</tt>-Regel greift.
<p>

<a name="manip"></a>
<h2>Anker manipulieren</h2>
Die Manipulierung von Ankern wird durch <tt>pfctl</tt> bewerkstelligt.
Es kann verwendet werden, um Regeln einem Anker hinzuzufügen oder zu
löschen, ohne den Hauptregelsatz neuzuladen.

<p>
Um alle Regeln in dem Anker namens <tt>allowed</tt> aufzulisten, der
dem <tt>ssh</tt>-Anker angehängt ist:
<blockquote>
<tt>
# pfctl -a ssh/allowed -s rules
</tt>
</blockquote>


<p>
Um alle Filterregeln von dem gleichen Anker zu ,flush'en:
<blockquote>
<tt>
# pfctl -a ssh/allowed -F rules
</tt>
</blockquote>

<p>
Für eine vollständige Liste der Kommandos, siehe bitte
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>pfctl(8)</a>.

<p>
[<a href="scrub.html">Zurück: Scrub (Paketnormalisierung)</a>]
[<a href="index.html">Inhalt</a>]
[<a href="queueing.html">Weiter: Paket-Queueing und Priorisierung</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[zurück]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: anchors.html,v 1.14 ]<br>
$Translation: anchors.html,v 1.4 2004/12/07 16:56:32 paldium Exp $<br>
$OpenBSD: anchors.html,v 1.4 2004/12/08 05:22:43 saad Exp $
</small>

</body>
</html> 
