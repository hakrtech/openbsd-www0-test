<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Fronty (queueing)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="scrub.html">Pøedchozí: Scrub</a>]
[<a href="index.html">Obsah</a>]
[<a href="nat.html">Dále: Pøeklad sí»ových adres</a>]

<p>
<h1><font color="#e00000">PF: Fronty (queueing)</font></h1>


<hr>

<h3>Obsah</h3>
<ul>
<li><a href="#queueing">Fronty</a>
<li><a href="#sched">Schedulery</a>
	<ul>
	<li><a href="#cbq">Class Based Queueing</a>
	<li><a href="#priq">Priority Queueing</a>
	<li><a href="#red">Random Early Detection</a>
	<li><a href="#ecn">Explicit Congestion Notification</a>
	</ul>
<li><a href="#altq">Konfigurace front</a>
<li><a href="#assign">Pøiøazení provozu frontì</a>
<li><a href="#example1">Pøíklad è.1: Malá domácí sí»</a>
<li><a href="#example2">Pøíklad è.2: Firemní sí»</a>
</ul>

<hr>

<a name="queueing"></a>
<h2>Fronty</h2>
<p>
Zaøadit nìco do fronty znamená ulo¾it to, v poøadí, zatímco to èeká na
zpracování. V poèítaèových sítích jsou pøi odesílání z poèítaèe datové
pakety zaøazeny do fronty, kde èekají na zpracování operaèním systémem.
Operaèní systém se potom rozhodne, která fronta a které pakety z ní, mají
být zpracovány. Poøadí, ve kterém operaèní sytém vybírá pakety ke
zpracování, mù¾e ovlivnit výkon sítì. Pøedstavme si, napøíklad,
u¾ivatele, který pou¾ívá dvì aplikace: SSH a FTP. V ideálním pøípadì by
pakety SSH mìly být zpracovány pøed FTP pakety, proto¾e SSH je z povahy vìci
citlivìjsí na zpo¾dìní. Pøi zmáèknutí klávesy v SSH klientu oèekáváme
okam¾itou odezvu, zatímco nìkolikasekundového zpo¾dìní FTP pøenosu si
sotva v¹imneme. Co se ale stane, kdy¾ router obsluhující tato spojení
zpracovává vellký balík paketù z FTP spojení pøed zpracováním SSH
spojení? Pakety ze SSH spojení budou zùstávat ve frontì (nebo mo¾ná
budou zahozeny routerem, pokud fronta není dostateènì velká, aby se do
ní ve¹ly v¹echny pakety) a SSH spojení se bude zpo¾ïovat nebo
vypadávat. Zmìnou pou¾ívané strategie zpracování fronty mù¾eme sdílet
pásmo spravedlivì mezi rùznými aplikacemi, u¾ivateli a poèítaèi.

<p>
Uvìdomme si, ¾e queueing má smysl pouze u paketù v  <i>odchozím</i>
smìru. Jakmile paket dorazí na rozhraní v pøíchozím smìru, je u¾ pøíli¹
pozdì øadit ho do fronty -- pøenosové pásmo (bandwith) u¾ spotøeboval
na to, aby se dostal na rozhraní, které ho právì pøijalo. Jediné øe¹ení
je zapnout queueing na pøedcházejícím routeru nebo, pokud poèítaè, který
paket pøijal funguje jako router, zapnout queueing na vnitøním rozhraní,
kde pakety opou¹tìjí router.

<a name="sched"></a>
<h2>Schedulery</h2>
Scheduler je to, co rozhoduje, které fronty zpracovávat a v jakém
poøadí. OpenBSD pou¾ívá First In First Out (FIFO) scheduler. FIFO fronta
funguje jako fronta v supermarketu nebo bance -- první polo¾ka ve frontì
je zpracována jako první. Kdy¾ dorazí nový paket, je zaøazen na konec
fronty. Pokud se fronta zaplní, jsou novì pøíchozí pakety zahazovány.
Tomu se øíká tail-drop.

<p>
OpenBSD podporuje dva dal¹í schedulery:
<ul>
<li>Class Based Queueing
<li>Priority Queueing
</ul>

<a name="cbq"></a>
<h3>Class Based Queueing</h3>
Class Based Queueing (Fronty zalo¾ené na tøídách, CBQ) je "frontovací"
algoritmus, který rozdìluje pásmo pro sí»ová spojení mezi nìkolik front
nebo tøíd. Ke ka¾dé frontì jsou potom pøiøazena spojení na základì
zdrojové nebo cílové adresy, èísla portu, protokolu atd. Fronta mù¾e být
volitelnì nakonfigurována tak, aby si pùjèovala pásmo od své rodièovské
fronty, pokud je ta nevytí¾ená. Frontám jsou také pøiøazeny priority,
tak¾e pakety interaktivních spojení, jako je SSH, mohou být zpracovány
døíve ne¾ fronty obsahující bì¾ný provoz, jako tøeba FTP.

<p>
CBQ fronty jsou uspoøádány hierarchicky. Na vrcholu hierarchie je root
fronta, která definuje celkovou dostupnou ¹íøku pásma. Pod ní jsou
vytváøeny dceøiné fronty, z nich¾ ka¾dé mù¾e být pøiøazena èást pásma
root fronty. Fronty mohou být uspoøádány napøíklad takto:
<dl>
<dd>Root Queue (2Mbps)
	<dl>
	<dd>Queue A (1Mbps)
	<dd>Queue B (500Kbps)
	<dd>Queue C (500Kbps)
	</dl>
</dl>

<p>
V tomto pøípadì je celková dostupná ¹íøka pásma nastavena na 2 megabity
za sekunbu (Mbps). Toto pásmo je rozdìleno mezi tøi dceøiné fronty.

<p>
Hierarchie mù¾e být dále roz¹íøena definováním front uvnitø front. Pro
rozdìlení pásma mezi rùzné u¾ivatele rovným dílem a klasifikovaní jejich
provozu tak, aby nìjaký protokol netrpìl na úkor ostatních nedostatkem
pásma, mù¾e být definována následující struktura front:
<dl>
<dd>Root Queue (2Mbps)
	<dl>
	<dd>UserA (1Mbps)
		<dl>
		<dd>ssh (50Kbps)
		<dd>bulk (950Kbps)
		</dl>
	<dd>UserB (1Mbps)
		<dl>
		<dd>audio (250Kbps)
		<dd>bulk (750Kbps)
			<dl>
			<dd>http (100Kbps)
			<dd>other (650Kbps)
			</dl>
		</dl>
	</dl>
</dl>

<p>
V¹imnìte si, ¾e na ¾ádné úrovni souèet ¹íøky pásma pøiøazeného frontaám
nepøesahuje ¹íøku pásma pøidìleného rodièovské frontì.

<p>
Fronta mù¾e být nastavena tak, aby si pùjèovala pásmo od svého rodièe,
pokud ten má pøebyteènou dostupnou kapacitu, proto¾e není naplno vyu¾ívána
ostatními dceøinými frontami. Uva¾ujme následující schema front:
<dl>
<dd>Root Queue (2Mbps)
	<dl>
	<dd>UserA (1Mbps)
		<dl>
		<dd>ssh (100Kbps)
		<dd>ftp (900Kbps, borrow)
		</dl>
	<dd>UserB (1Mbps)
	</dl>
</dl>

<p>
Pokud provoz ve frontì <tt>ftp</tt> pøekroèí 900Kbps a provoz ve frontì
<tt>UserA</tt> je ménì ne¾ 1Mbps (proto¾e ssh fronta vyu¾ívé ménì ne¾
pøiøazených 100Kbps), fronta <tt>ftp</tt> si vypùjèí pøebyteèné pásmo od
<tt>UserA</tt>. Tímto zpùsobem mù¾e <tt>ftp</tt> vyu¾ít více ne¾
pøiøazené pásmo, pokud je pøetí¾eno. Kdy¾ se ve frontì <tt>ssh</tt>
zvý¹í zátì¾, vypùjèené pásmo bude vráceno. 

<p>
CBQ pøiøazuje ka¾dé frontì prioritu. Fronty s vy¹¹í prioritou jsou pøi
zahlcení preferovány oproti frontám s ni¾¹í prioritou, pokud obì mají
spoleèného rodièe (jinak øeèeno, pokud jsou obì fronty ve stejné vìtvi
hierarchie). Fronty se stejnou prioritou jsou zpracovávány round-robin
mechanismem. Napøíklad:
<dl>
<dd>Root Queue (2Mbps)
	<dl>
	<dd>UserA (1Mbps, priority 1)
		<dl>
		<dd>ssh (100Kbps, priority 5)
		<dd>ftp (900Kbps, priority 3)
		</dl>
	<dd>UserB (1Mbps, priority 1)
	</dl>
</dl>

<p>
CBQ bude zpracovávat fronty <tt>UserA</tt> a <tt>UserB</tt> round-robin
mechanismem -- ¾ádná fronta nebude upøednostòovaná. Bìhem zpracovávání
fronty <tt>UserA</tt>, CBQ také zpracuje její dceøiné fronty. V tomto
pøípadì má fronta <tt>ssh</tt> vy¹¹í prioritu a dostane se jí
pøednostnìj¹ího zacházení ne¾ frontì <tt>ftp</tt>, pokud dojde k
zahlcení. V¹imnìte si, ¾e priority front <tt>ssh</tt> a <tt>ftp</tt> se
neporovnávají s frontami <t>UserA</tt> a <tt>UserB</tt>, proto¾e nejsou
v¹echny ve stejné vìtvi hierarchie.

<p>
Detailnìj¹í pohled na teorii v pozadí CBQ najdete na
<a href="http://www.icir.org/floyd/cbq.html">této stránce</a>.

<a name="priq"></a>
<h3>Priority Queueing</h3>
Priority Queueing (PRIQ) pøiøazuje více front jednomu rozhraní s tím, ¾e
ka¾dá fronta má pøiøazenu jedineènou úroveò priority. Fronta s vy¹¹í
prioritou je <i>v¾dy</i> zpracována døív ne¾ fronta s ni¾¹í prioritou.

<p>
Struktura front PRIQ je plochá -- nemù¾ete vytvoøit fronty uvnitø front.
Je stanovena root fronta, která specifikuje celkovou dostupnou ¹íøku
pásma a pod ní jsou stanoveny podfronty. Uva¾ujme následující pøíklad:
<dl>
<dd>Root Queue (2Mbps)
	<dl>
	<dd>Queue A (priority 1)
	<dd>Queue B (priority 2)
	<dd>Queue C (priority 3)
	</dl>
</dl>

<p>
Root fronta je urèena tak, ¾e má k dipozici pásmo o ¹íøce 2Mbps a jsou
stanoveny tøi podfronty. Fronta s nejvy¹¹í prioritou (nejvy¹¹í èíslo
priority) je obsluhována jako první. Kdy¾ jsou v¹echny pakety z této
fronty zpracovány nebo je fronta prázdná, PRIQ pokraèuje frontou s dal¹í
nejvy¹¹í prioritou. V rámci jedné fronty jsou pakety zpracovány zpùsobem
First In First Out (FIFO).

<p>
Je dùle¾ité uvìdomit si, ¾e pøi pou¾itá PRIQ musíte naplánovat své
fronty velmi peèlivì. Proto¾e PRIQ <i>v¾dy</i> zpracovává fronty s vy¹¹í
prioritou pøed tìmi s ni¾¹í prioritou, je mo¾né, aby fronta s vy¹¹í
prioritou zpùsobovala zpo¾dìní nebo zahazování paketù fronty o ni¾¹í
prioritì, pokud ta s vy¹¹í priotitou pøijímá stálý proud paketu.

<a name="red"></a>
<h3>Random Early Detection</h3>
Random Early Detection (RED) je algoritmus zabraòující zahlcení. Jeho
úèelem je zabránit zahlcení sítì tím, ¾e hlídá, aby se fronta
nezaplnila. Toho je dosahováno prùbì¾ným poèítáním prùmìrné délky
(velikosti) fronty a porovnáváním se dvìma prahovýmí hodnotami,
minimální a maximální. Pokud je prùmìrná délka fronty pod minimálním
prahem, ¾ádný paket nebude zahozen. Pokud prùmìrná délka fronty
pøekraèuje maximální práh, potom <i>v¹echny</i> novì pøíchozí pakety
budou zahozeny. Pokud je prùmìr mezi prahovými hodnotami, pakety budou
zahazovány na základì pravdìpodobnosti poèítané z prùmìrné velikosti fronty.
Jinak øeèeno, èím více se velikost fronty blí¾í maximálnímu prahu, tím
více paketù bude zahazováno. Pøi zahazovaní paketù RED náhodnì vybírá,
ze kterého spojení paket zahodit. Spojení vyu¾ívající velkou èást pásma
mají vìt¹í pravdìpodobnost, ¾e jejich pakety budou zahozeny.

<p>
RED je u¾iteèný, proto¾e zabraòuje situaci známé jako globální synchronizace a
je schopný zvládnout nápor provozu. Globální synchronizací je nazývána ztráta
celkové propustnosti kvùli tomu, ¾e pakety jsou zahazovány z nìkolika spojení
souèasnì. Pokud napøíklad dojde k zahlcení routeru zpracovávajícího data deseti
FTP spojení a pakety ze v¹ech (nebo vìt¹iny) budou zahozeny (co¾ se dìje u FIFO
front), dojde k prudkému poklesu celkové prostnosti. To není moc ideální,
proto¾e u v¹ech FTP spojení poklesne propustnost a zároveò nebude vyu¾it
maximální potenciál sítì.  RED tomu zabraòuje náhodným výbìrem ze kterého
spojení zahodit pakety, místo zahození v¹ech. Spojení vyu¾ívající více pásma
mají vìt¹í pravdìpodobnost zahození paketu. Tím jsou spojení nároènìj¹í na
pásmo pøi¹krcena a zahlcení je zabránìno. Navíc je RED schopen zvládout
nárazový provoz, proto¾e zaène zahazovat pakety <i>døíve</i>, ne¾ se fronta
zaplní. Kdy¾ tedy nárazový provoz prochází, ve frontì bude dost místa pro nové
pakety.

<p>
RED by mìl být pou¾íván pouze pokud je transportní protokol schopen
reagovat na pøíznaky zahlcení sítì. Ve vìt¹inì pøípadù to znamená, ¾e
RED by mìl být pou¾íván u TCP spojení a ne u UDP a ICMP.

<p>
Podrobnìj¹í informace o teorii kolem RED najdete na
<a href="http://www.icir.org/floyd/red.html">této stránce</a>.

<a name="ecn"></a>
<h3>Explicit Congestion Notification</h3>
Explicit Congestion Notification (ECN) slou¾í ve spojení s RED k
upozornìní poèítaèù komunikujících po síti na zahlcení 
komunikaèní cesty. Dosahuje toho tím, ¾e umo¾òuje, aby RED nastavil
pøíznak v hlavièce paketu místo zahazování paketu. Za pøedpokladu, ¾e
odesílající poèítaè podporuje ECN, mù¾e si pøeèíst tento pøíznak a podle
toho omezit sí»ový provoz.

<p>
Více informací o ECN najdete v
<a href="http://www.rfc-editor.org/rfc/rfc3168.txt">RFC 3168</a>.

<a name="altq"></a>
<h2>Konfigurace front</h2>
Od verze OpenBSD 3.0 byla souèástí systému implementace front 
<a href="http://www.csl.sony.co.jp/person/kjc/kjc/software.html#ALTQ"
>Alternate Queueing (ALTQ)</a>. Poèínaje OpenBSD 3.3 je ALTQ integrováno
do PF. Implementace ALTQ v OpenBSD podporuje Class Based Queueing (CBQ)
a Priority Queueing (PRIQ) schedulery. Podporuje také Random
Early Detection (RED) a Explicit Congestion Notification (ECN).

<p>
Proto¾e ALTQ je spojeno s PF, PF musí zapnuto, aby fungoval queueing.
Pokyny jak zapnout PF najdete v
<a href="config.html#activate">sekci konfigurace</a>.

<p>
Queueing je konfigurován <tt>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+3.3"
>/etc/pf.conf</a></tt>. Existují dva druhy direktiv, které mohou být
pou¾ity pro konfiguraci front:
<ul>
<li><tt>altq on</tt> - zapíná queueing na rozhraní, urèuje, který
scheduler pou¾ít, a vytváøí root frontu
<li><tt>queue</tt> - definuje vlastnosti dceøinných front
</ul>

<p>
Syntaxe direktivy <tt>altq on</tt> je následující:
<blockquote>
<tt>
altq on <i>interface scheduler</i> bandwidth <i>bw</i> qlimit 
<i>qlim</i> \<br>
&nbsp;&nbsp;&nbsp;tbrsize <i>size</i> queue { <i>queue_list</i> }
</tt>
</blockquote>

<ul>
<li><tt><i>interface</i></tt> - rozhraní, na kterém aktivujeme queueing.
<li><tt><i>scheduler</i></tt> - jaký pou¾ít scheduler. Mo¾né hodnoty
jsou <tt>cbq</tt> and <tt>priq</tt>. V danou chvíli mù¾e být aktivován
pouze jeden scheduler.
<li><tt><i>bw</i></tt> - celková ¹íøka pásma dostupná scheduleru.
Zde mù¾e být specifikována absolutní hodnota s pøíponou  <tt>b</tt>,
<tt>Kb</tt>, <tt>Mb</tt> a <tt>Gb</tt>  znaèící bity, kilobity,
megabity a gigabity za sekundu nebo procenta celkové ¹íøky pásma
rozhraní <tt><i>interface</i></tt>.
<li><tt><i>qlim</i></tt> - maximální poèet paketù ve frontì. Tento
parametr je nepovinný. Default je 50.
<li><tt><i>size</i></tt> - velikost token bucket regulator v bytech.
Pokud není specifikována je velikost urèen z ¹íøky pásma rozhraní
<tt><i>interface</i></tt>
<li><tt><i>queue_list</i></tt> - seznam frot pro vytvoøení pod root
frontou.
</ul>

<p>
Npøíklad:
<blockquote>
altq on fxp0 cbq bandwidth 2Mb queue { std, ssh, ftp }
</blockquote>
Toto zapne CBQ na rozhraní fxp0. Celková dostupná ¹íøka pásma je
nastavena na 2Mbps. Jsou definovány tøi dceøinné fronty:
<tt>std</tt>, <tt>ssh</tt>, and <tt>ftp</tt>.

<p>
Syntaxe direktivy <tt>queue</tt> je následující:
<blockquote>
<tt>
queue <i>name</i> bandwidth <i>bw</i> priority <i>pri</i> qlimit
<i>qlim</i> \<br>
&nbsp;&nbsp;&nbsp;<i>scheduler</i> ( <i>sched_options</i> )
{ <i>queue_list</i> }
</tt>
</blockquote>

<ul>
<li><tt><i>name</i></tt> - jméno fronty. Musí se shodovat s jedním z
jmen definovaných v seznamu <tt><i>queue_list</i></tt> direktivy
<tt>altq on</tt>. Pro <tt>cbq</tt> to mù¾e také být jméno fronty
z <tt><i>queue_list</i></tt> pøedchozí direktivy <tt>queue</tt>.
Jméno fronty nesmí pøesáhnout 15 znakù.
<li><tt><i>bw</i></tt> - celková ¹íøka pásma dostupná scheduleru.
Zde mù¾e být specifikována absolutní hodnota s pøíponou  <tt>b</tt>,
<tt>Kb</tt>, <tt>Mb</tt> a <tt>Gb</tt>  znaèící bity, kilobity,
megabity a gigabity za sekundu nebo procenta celkové ¹íøky pásma
rozhraní <tt><i>interface</i></tt>.
<li><tt><i>pri</i></tt> - priorita fronty. Pro <tt>cbq</tt> je 
rozsah priorit 0 a¾ 7 a pro <tt>priq</tt> je to 0 a¾ 15.
Priorita 0 znaèí nejni¾¹í prioritu. Pokud není specifikována, defaultní
je 1.
<li><tt><i>qlim</i></tt> - maximální poèet paketù ve frontì. Tento
parametr je nepovinný. Default je 50.
<li><tt><i>scheduler</i></tt> - specifikuje pou¾itý scheduler, buï <tt>cbq</tt>
nebo <tt>priq</tt>. Musí být stejný jako pro root frontu.
<li><tt><i>sched_options</i></tt> - scheduleru mù¾eme pøedat dal¹í volby
urèující jeho chování:
	<ul>
	<li><tt>default</tt> - definuje defaultní frontu, kam budou
	ulo¾eny v¹echy pakety, které nespadají do ¾ádné jiné fronty. Je
	vy¾adována právì jedna defaultní fronta.
	<li><tt>red</tt> - zapíná Random Early Detection (RED) na této
	frontì.
	<li><tt>rio</tt> - zapíná RED s IN/OUT. V tomto módu bude RED
	udr¾ovat nìkolik prùmìrných délek fronty a nìkolik prahových
	hodnot, jednu pro ka¾dou úroveò IP Quality of Service.
	<li><tt>ecn</tt> - zapíná Explicit Congestion Notification
	(ECN) pro tuto frontu. <tt>Ecn</tt> imlikuje <tt>red</tt>.
	<li><tt>borrow</tt> - fronta si mù¾e vypùjèit pásmo od
	rodièovské. Lze specifikovat pouze pøi pou¾ití scheduleru
	<tt>cbq</tt>.
	</ul>
<li><tt><i>queue_list</i></tt> - seznam dceøiných front k vytvoøení pod
touto frontou. Seznam <tt><i>queue_list</i></tt> mù¾e být definován pouze
pøi pou¾ítí scheduleru <tt>cbq</tt>. 
</ul>

<p>
Pokraèujeme v pøede¹lém pøíkladu:
<blockquote>
<tt>
queue std bandwidth 50% cbq(default)<br>
queue ssh { ssh_login, ssh_bulk }<br>
&nbsp;&nbsp;queue ssh_login  priority 4 cbq(ecn)<br>
&nbsp;&nbsp;queue ssh_bulk   cbq(ecn)<br>
queue ftp bandwidth 500Kb priority 3 cbq(borrow red)<br>
</tt>
</blockquote>

<p>
Tady nastavujeme parametry døíve definovaných dceøiných front. Frontì
<tt>ssh</tt> pøiøadíme 50% pásma root fronty (èili 1Mbps) a urèíme ji
jako defaultní frontu. Fronta <tt>ssh</tt> má dvì dceøinné fronty,
<tt>ssh_login</tt> a <tt>ssh_bulk</tt>. Fronta <tt>ssh_login</tt> má
vy¹¹í prioritu ne¾ <tt>ssh_bulk</tt> a obì mají zapnuto ECN. Frontì
<tt>ftp</tt> je pøiøazeno pásmo o ¹íøce 500Kbps a priorita 3. Mù¾e si
také pùjèovat pásmo, pokud je nìjaké navíc k dispozici, a má zapnuto
RED.

<a name="assign"></a>
<h3>Pøiøazování provozu frontì</h3>
<p>
Pro pøiøazení provozu frontì pou¾íváme klíèové slovo <tt>queue</tt> ve
spojení s <a href="filter.html">filtrovacími pravidly</a> PF. Uva¾ujme
napøíklad sedu pravidel obsahující následucící øádek:
<blockquote>
<tt>pass out on fxp0 from any to any port 22</tt>
</blockquote>

<p>
Pakety odpovídající tomuto pravidlu mohou být pøiøazeny urèité frontì
pou¾itím klíèového slova <tt>queue</tt>:
<blockquote>
<tt>pass out on fxp0 from any to any port 22 queue ssh</tt>
</blockquote>

<p>
Pøi pou¾ití klièového slova <tt>queue</tt> s direktivou  <tt>block</tt>,
v¹echny výsledné TCP RST nebo ICMP Unreachable pakety budou pøiøazeny
urèené frontì.

<p>
V¹imnìte si, ¾e k oznaèení fronty mù¾e dojít na jiném rozhraní ne¾ 
tom definovaném v direktivì <tt>altq on</tt>:
<blockquote>
<tt> 
altq on fxp0 cbq bandwidth 2Mb queue { std, ftp }<br>
queue std cbq(default)<br>
queue ftp bandwidth 1.5Mb<br>
<br>
pass in on dc0 from any to any port 21 queue ftp<br>
</tt>
</blockquote>

<p>
Queueing je zapnuto na fxp0 ale oznaèení se dìje na dc0. Pokud pakety
odpovídající pravidlu <tt>pass</tt> odcházejí rozhraním fxp0, budou
zaøazeny do fronty <tt>ftp</tt>. Tato metoda mù¾e být velmi u¾iteèná na
routerech.

<p>
Bì¾nì mù¾eme urèit pouze jedno jméno fronty u klíèového slova
<tt>queue</tt>, ale pokud je specifikováno druhé, bude tato fronta
pou¾ita pro pakety s low-delay
<a href="http://www.rfc-editor.org/rfc/rfc791.txt">Type of
Service (ToS)</a> a pro TCP ACK pakety nenesoucí data. Dobrý pøíklad
najdeme u SSH. SSH login relace mají nastaven ToS na low-delay
zatímco SCP a SFTP relace nikoliv. PF mù¾e této informace vyu¾ít k
zaøazení paketù nále¾ejících do login spojení do jiné fronty ne¾
neinteraktivní spojení. To mù¾e být u¾iteèné k upøednostnìní paketù
login spojení pøed pakety pøenosu souborù.
<blockquote>
<tt>pass out on fxp0 from any to any port 22 queue(ssh_bulk, ssh_login)</tt>
</blockquote>

<p>
Tímto pøiøadíme pakety nále¾ející do SSH login spojení do fronty
<tt>ssh_login</tt> a pakety nále¾ející do SCP a SFTP spojení do fronty
<tt>ssh_bulk</tt>. Pakety SSH login spojení tak budou zpracovány pøed
SCP a SFTP spojeními, proto¾e fronta <tt>ssh_login</tt> má vy¹¹í
prioritu.

<p>
Zaøazení TCP ACK paketù fo fronty s vy¹¹í prioritou je u¾iteèné u
asymetrických spojení, èili u spojení, která mají odli¹nou ¹íøku pásma
pri upload a download, jako tøeba ADSL linky. Pokud je u ADSL linky
kanál pro upload zcela vyu¾it a zaèneme stahovat, download bude trpìt,
proto¾e TCP ACK, které potøebuje posílat, uvíznout v zácpì pøi prùchodu
upload kanálem. Testy ukázaly, ¾e k dosa¾ení nejlep¹ích výsledkù by
pásmo pro upload frontu mìlo být nastaveno na ni¾¹í hodnotu ne¾ je
rychlost linky. Pokud ADSL linka má napøíklad upload maximálnì 640Kbps,
nastavení ¹íøky pásma root fronty na 600Kb by se mìlo projevit lep¹ím
výkonem. Metodou pokus a omyl zjistíme nejlep¹í nastavení
<tt>bandwidth</tt>.

<p>
Pøi pou¾ití klíèového slova <tt>queue</tt> s pravidlem <tt>keep
state</tt>, jako tøeba:
<blockquote>
<tt>
pass in on fxp0 proto tcp from any to any port 22 flags S/SA \<br>
&nbsp;&nbsp;&nbsp;keep state queue ssh
</tt>
</blockquote>

<p>
PF zapí¹e frontu do tabulky stavù, tak¾e pakety vracející se fxp0, které
odpovídají ustavenému spojení, skonèí ve frontì <tt>ssh</tt>. V¹imnìte
si, ¾e aèkoliv klíèové slovo <tt>queue</tt> je pou¾ito v pravidle
filtrujícím odchozí spojení, úèelem je specifikovat frontu pro
odpovídající odchozí provoz; vý¹e uvedené pravidlo nefrontuje pøíchozí
pakety.

<a name="example1"></a>
<h2>Pøíklad è. 1: Malá domácí sí»</h2>
<pre>
  
    [ Alice ]    [ Charlie ]
        |             |                              ADSL
     ---+-----+-------+------ dc0 [ OpenBSD ] fxp0 -------- ( Internet )
              |
           [ Bob ]

</pre>

<p>
V tomto pøípadì je OpenBSD pou¾ito na Internetové bránì malé sítì se
tøemi stanicemi. Brána provádí filtrování paketù a NAT zále¾itosti.
Pøipojení k Internetu je pøes ADSL linku s 2Mbps dovnitø a 640Kbps ven.

<p>
Politika front pro tuto sí»:
<ul>
<li>Vyèlenit 80Kbps download pásma pro Boba, aby mohl hrát svoje online
hry ani¾ by byl zpomalován downloady Alice a Charlieho. Povolit Bobovi
více ne¾ 80Kbps, pokud je k dispozici.
<li>Provoz interaktivního SSH a instant messages mají vìt¹í prioritu ne¾
bì¾ný provoz.
<li>DNS dotazy a odpovìdi mají druhou nejvy¹¹í prioritu.
<li>Odchozí TCP ACK pakety mají vy¹¹í prioritu ne¾ v¹echen ostaní
odchozí provoz.
</ul>

<p>
Následuje sada pravidel, ktaré splòuje tuto sí»ovou politiku. Pov¹imnìte
si, ¾e jsou uvedeny pouze ty direktivy <tt>pf.conf</tt>, které se
vztahují k vý¹e uvedené politice;  <a href="nat.html"><tt>nat</tt></a>,
<a href="rdr.html"><tt>rdr</tt></a>, <a href="options.html">options</a>,
atd. není ukázáno.

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# enable queueing on the external interface to control traffic going to
# the Internet. use the priq scheduler to control only priorities. set
# the bandwidth to 610Kbps to get the best performance out of the TCP
# ACK queue.

altq on fxp0 priq bandwidth 610Kb queue { std_out, ssh_im_out, dns_out, \
	tcp_ack_out }

# define the parameters for the child queues.
# std_out      - the standard queue. any filter rule below that does not
#                explicitly specify a queue will have its traffic added
#                to this queue.
# ssh_im_out   - interactive SSH and various instant message traffic.
# dns_out      - DNS queries.
# tcp_ack_out  - TCP ACK packets with no data payload.

queue std_out     priq(default)
queue ssh_im_out  priority 4 priq(red)
queue dns_out     priority 5
queue tcp_ack_out priority 6

# enable queueing on the internal interface to control traffic coming in
# from the Internet. use the cbq scheduler to control bandwidth. max
# bandwidth is 2Mbps.

altq on dc0 cbq bandwidth 2Mb queue { std_in, ssh_im_in, dns_in, bob_in }

# define the parameters for the child queues.
# std_in      - the standard queue. any filter rule below that does not
#               explicitly specify a queue will have its traffic added
#               to this queue.
# ssh_im_in   - interactive SSH and various instant message traffic.
# dns_in      - DNS replies.
# bob_in      - bandwidth reserved for Bob's workstation. allow him to
#               borrow.

queue std_in    cbq(default)
queue ssh_im_in priority 4
queue dns_in    priority 5
queue bob_in    bandwidth 80Kb cbq(borrow)


# ... in the filtering section of pf.conf ...

alice         = "192.168.0.2"
bob           = "192.168.0.3"
charlie       = "192.168.0.4"
local_net     = "192.168.0.0/24"
ssh_ports     = "{ 22 2022 }"
im_ports      = "{ 1863 5190 5222 }"

# filter rules for fxp0 inbound
block in on fxp0 all

# filter rules for fxp0 outbound
block out on fxp0 all
pass  out on fxp0 inet proto tcp from (fxp0) to any flags S/SA \
	keep state queue(std_out, tcp_ack_out)
pass  out on fxp0 inet proto { udp icmp } from (fxp0) to any keep state
pass  out on fxp0 inet proto { tcp udp } from (fxp0) to any port domain \
	keep state queue dns_out
pass  out on fxp0 inet proto tcp from (fxp0) to any port $ssh_ports \
	flags S/SA keep state queue(std_out, ssh_im_out)
pass  out on fxp0 inet proto tcp from (fxp0) to any port $im_ports \
	flags S/SA keep state queue(ssh_im_out, tcp_ack_out)

# filter rules for dc0 inbound
block in on dc0 all
pass  in on dc0 from $local_net

# filter rules for dc0 outbound
block out on dc0 all
pass  out on dc0 from any to $local_net
pass  out on dc0 proto { tcp udp } from any port domain to $local_net \
	queue dns_in
pass  out on dc0 proto tcp from any port $ssh_ports to $local_net \
	queue(std_in, ssh_im_in)
pass  out on dc0 proto tcp from any port $im_ports to $local_net \
	queue ssh_im_in
pass  out on dc0 from any to $bob queue bob_in
</pre>
</td></tr>
</table>

<a name="example2"></a>
<h2>Pøíklad è. 2: Firemní sí»</h2>
<pre>

  ( IT Dept )  [ Boss's PC ]
       |          |                                   T1
     --+----+-----+---------- dc0 [ OpenBSD ] fxp0 -------- ( Internet )
            |                         fxp1
         [ COMP1 ]    [ WWW ]         /
                         |           / 
                       --+----------' 

</pre>

<p>
V tomto pøíkladu funguje poèítaè s OpenBSD jako firewall pro firemní
sí». Spoleènost provozuje WWW server v DMZ sekci své sítì, kam zákazníci
uploadují své webové stránky pøes FTP. IT oddìlení má svùj vlastní
subnet pøipojený do hlavní sítì a ¹éf má na stole PC, které pou¾ívá na
emaily a brouzdání po webu. Pøipojení k internetu je T1 linkou s 1,5Mbps
v obou smìrech. V¹echny ostatní sí»ové segmenty vyu¾ívají Fast Ethernet
(100 Mbps).

<p>
Sí»ový administrátor stanovil následující politiku:
<ul>
<li>Omezit provoz mezi WWW serverem a Internetem na 500Kbps v obou
smìrech.
<li>®ádné omezení pásma mezi WWW serverem a vnitøní sítí.
<li>Dát HTTP spojení mezi WWW serverem a Internetem vìt¹í prioritu ne¾
ostatnímu provozu mezi WWW serverem a Internetem (jako jsou FTP
uploady).
<li>Vyhradit 500Kbps pro IT oddìlení, aby mohli stahovat nejnovìj¹í
software v rozumném èase. Mìli by mít mo¾nost vyu¾ívat více ne¾ 500Kbps,
pokud je k dispozici navíc.
<li>Dát provozu mezi ¹éfovým PC a Internetem vý¹¹í prioritu ne¾
ostatnímu provozu do/z Internetu.
</ul>

<p>
Následuje sada pravidel, ktaré splòuje tuto sí»ovou politiku. Pov¹imnìte
si, ¾e jsou uvedeny pouze ty direktivy <tt>pf.conf</tt>, které se
vztahují k vý¹e uvedené politice;  <a href="nat.html"><tt>nat</tt></a>,
<a href="rdr.html"><tt>rdr</tt></a>, <a href="options.html">options</a>,
atd. není ukázáno.

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# enable queueing on the external interface to queue packets going out
# to the Internet. use the cbq scheduler so that the bandwidth use of
# each queue can be controlled. the max outgoing bandwidth is 1.5Mbps.

altq on fxp0 cbq bandwidth 1.5Mb queue { std_ext, www_ext, boss_ext }

# define the parameters for the child queues.
# std_ext        - the standard queue. also the default queue for
#                  outgoing traffic on fxp0.
# www_ext        - container queue for WWW server queues. limit to
#                  500Kbps.
#   www_ext_http - http traffic from the WWW server
#   www_ext_misc - all non-http traffic from the WWW server
# boss_ext       - traffic coming from the boss's computer

queue std_ext        cbq(default)
queue www_ext        bandwidth 500Kb { www_ext_http, www_ext_misc }
  queue www_ext_http priority 3 cbq(red)
  queue www_ext_misc priority 1
queue boss_ext       priority 3

# enable queueing on the internal interface to control traffic coming
# from the Internet or the DMZ. use the cbq scheduler to control the
# bandwidth of each queue. bandwidth on this interface is set to the
# maximum. traffic coming from the DMZ will be able to use all of this
# bandwidth while traffic coming from the Internet will be limited to
# 1.0Mbps (because 0.5Mbps (500Kbps) is being allocated to fxp1).

altq on dc0 cbq bandwidth 100% queue { net_int, www_int }

# define the parameters for the child queues.
# net_int    - container queue for traffic from the Internet. bandwidth
#              is 1.0Mbps.
#   std_int  - the standard queue. also the default queue for outgoing
#              traffic on dc0.
#   it_int   - traffic to the IT Dept network.
#   boss_int - traffic to the boss's PC.
# www_int    - traffic from the WWW server in the DMZ.

queue net_int    bandwidth 1.0Mb { std_int, it_int, boss_int }
  queue std_int  cbq(default)
  queue it_int   bandwidth 500Kb cbq(borrow)
  queue boss_int priority 3
queue www_int    cbq(red)

# enable queueing on the DMZ interface to control traffic destined for
# the WWW server. cbq will be used on this interface since detailed
# control of bandwidth is necessary. bandwidth on this interface is set
# to the maximum. traffic from the internal network will be able to use
# all of this bandwidth while traffic from the Internet will be limited
# to 500Kbps.

altq on fxp1 cbq bandwidth 100% queue { internal_dmz, net_dmz }

# define the parameters for the child queues.
# internal_dmz   - traffic from the internal network.
# net_dmz        - container queue for traffic from the Internet.
#   net_dmz_http - http traffic.
#   net_dmz_misc - all non-http traffic. this is also the default queue.

queue internal_dmz      # no special settings needed
queue net_dmz        bandwidth 500Kb { net_dmz_http, net_dmz_misc }
  queue net_dmz_http priority 3 cbq(red)
  queue net_dmz_misc priority 1 cbq(default)


# ... in the filtering section of pf.conf ...

main_net  = "192.168.0.0/24"
it_net    = "192.168.1.0/24"
int_nets  = "{ 192.168.0.0/24, 192.168.1.0/24 }"
dmz_net   = "10.0.0.0/24"

boss      = "192.168.0.200"
wwwserv   = "10.0.0.100"

# default deny
block on { fxp0, fxp1, dc0 } all

# filter rules for fxp0 inbound
pass in on fxp0 proto tcp from any to $wwwserv port { 21, \
	&gt; 49151 } flags S/SA keep state queue www_ext_misc
pass in on fxp0 proto tcp from any to $wwwserv port 80 \
	flags S/SA keep state queue www_ext_http

# filter rules for fxp0 outbound
pass out on fxp0 from $int_nets to any keep state
pass out on fxp0 from $boss to any keep state queue boss_ext

# filter rules for dc0 inbound
pass in on dc0 from $int_nets to any keep state
pass in on dc0 from $it_net to any queue it_int
pass in on dc0 from $boss to any queue boss_int
pass in on dc0 proto tcp from $int_nets to $wwwserv port { 21, 80, \
	&gt; 49151 } flags S/SA keep state queue www_int

# filter rules for dc0 outbound
pass out on dc0 from dc0 to $int_nets

# filter rules for fxp1 inbound
pass in on fxp1 proto { tcp, udp } from $wwwserv to any port 53 \
	keep state

# filter rules for fxp1 outbound
pass out on fxp1 proto tcp from any to $wwwserv port { 21, \
	&gt; 49151 } flags S/SA keep state queue net_dmz_misc
pass out on fxp1 proto tcp from any to $wwwserv port 80 \
	flags S/SA keep state queue net_dmz_http
pass out on fxp1 proto tcp from $int_nets to $wwwserv port { 80, \
	21, &gt; 49151 } flags S/SA keep state queue internal_dmz
</pre>
</td></tr>
</table>

<p>
[<a href="scrub.html">Pøechozí: Scrub</a>]
[<a href="index.html">Obsah</a>]
[<a href="nat.html">Dále: Pøeklad sí»ových adres</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<small>
<br>
Originally [OpenBSD: queueing.html,v 1.12 ]
<br>
$Translation: queueing.html,v 1.1 2003/11/09 21:03:38 certik Exp $
<br>
$OpenBSD: queueing.html,v 1.1 2003/11/10 00:00:46 horacio Exp $
</small>

</body>
</html> 
