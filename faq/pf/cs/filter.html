<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Filtrování paketù</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2002-2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
<p>
[<a href="rdr.html">Pøedchozí: Pøesmìrování trafficu</a>]
[<a href="index.html">Obsah</a>]
[<a href="logging.html">Dále: Logování</a>]

<h1><font color="#e00000">PF: Filtrování paketù</font></h1>

<hr>

<h3>Obsah</h3>
<ul>
<li><a href="#intro">Úvod</a>
<li><a href="#syntax">Sytax pravidel</a>
<li><a href="#defdeny">Default Deny</a>
<li><a href="#pass">Passing Traffic</a>
<li><a href="#state">Udr¾ování stavu</a>
<li><a href="#udpstate">Udr¾ování stavu pro UDP</a>
<li><a href="#tcpflags">TCP Flagy</a>
<li><a href="#quick">Klíèové slovo <tt>quick</tt></a>
<li><a href="#antispoof">Blokování spoofnutých paketù</a>
<li><a href="#ipopts">IP Options</a>
<li><a href="#example">Pøíklad mno¾iny pravidel pro filtrování</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Úvod</h2>
Filtrování paketù je selektivní prùchod nebo blokování datových paketù tím
jak procházejí sí»ovým interfacem. Kriteria, která
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>pf(4)</a> pou¾ívá kdy¾ provádí inspekci paketù jsou zalo¾enna na Layer 3 
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>IPv4</a> a 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip6&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>IPv6</a>) a Layer 4
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcp&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>TCP</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=udp&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>UDP</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>ICMP</a>, a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp6&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>ICMPv6</a>) hlavièkách. Nejèastìji pou¾ívaná kriteria jsou zdrojová a
cílová adresa, zdrojový a cílový port a protokol.

<p>
Filtrovací pravidla specifikují kriteria, která musí paket splòovat a
akci, buï povolit nebo zakázat, která je provedena, pokud je pravidlo
splnìno. Filtrovací pravidla jsou vyhodnocována v sekvenèním poøadí, od
prvního do posledního. Dokud není nalezeno pravidlo obsahující klíèové
slovo <tt>quick</tt>, paket bude vyhodnocován oproti <i>v¹em</i>
filtrovacím pravidlùm pøedtím ne¾ bude provedena koneèná akce. Poslední
pravidlo, které vyhovuje, "vyhrává" a bude diktovat jaká akce se s paketem
provede. Na konci mno¾iny filtrovacích pravidel je implicitní <tt>pass
all</tt>, co¾ znamená, ¾e pokud paket nebude splòovat ¾ádné pravidlo,
výsledná akce bude <tt>pass</tt>. 


<a name="syntax"></a>
<h2>Syntax pravidel</h2>
Obecná, <i>velmi zjednodu¹ená</i> syntax pro filtrovací pravidla je:
<blockquote>
<tt>
<i>action</i> <i>direction</i> [log] [quick] on <i>int</i> [<i>af</i>] 
[proto <i>protocol</i>] \<br>
&nbsp;&nbsp;&nbsp;from <i>src_addr</i> [port <i>src_port</i>] to 
<i>dst_addr</i> [port <i>dst_port</i>] \<br>
&nbsp;&nbsp;&nbsp;[<i>tcp_flags</i>] [<i>state</i>]
</tt>
</blockquote>

<dl>
<dt><tt><i>action</i></tt>
<dd>Akce, která bude provedena na pakety splòující pravidlo,
buï <tt>pass</tt> nebo
<tt>block</tt>. Akce <tt>pass</tt> nechá projít paket zpátky do kernelu
pro dal¹í zpracování, zatímco akce <tt>block</tt> bude reagovat v
závislosti na volbì
<a href="options.html#block-policy"><tt>block-policy</tt></a>. 
Defaultní rekace mù¾e být pøepsána buï specifikováním 
<tt>block drop</tt> nebo <tt>block return</tt>.

<dt><tt><i>direction</i></tt>
<dd>Smìr paketu jakým jde na interface, buï 
<tt>in</tt> nebo <tt>out</tt>.

<dt><tt>log</tt>
<dd>Specifikuje ¾e by paket mìl být zalogován via
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>pflogd(8)</a>. Pokud pravidlo specifikuje volbu <tt>keep state</tt> nebo
<tt>modulate state</tt> pak pouze pokud paket nastaví stav, je stav
zalogován. K logování v¹ech paketù, nehledì na to jestli nastaví stav nebo
ne, pou¾ijte
<tt>log-all</tt>.

<dt><tt>quick</tt>
<dd>Pokud pakket matchuje pravidlo obsahující <tt>quick</tt> pak 
je toto pravidlo pova¾ováno za poslední splòující a je provedena akce
specifikovaná v tomto pravidle.

<dt><tt><i>int</i></tt>
<dd>Jméno sí»ového interface, kterým prochází paket.

<dt><tt><i>af</i></tt>
<dd>Address family paketu, buï <tt>inet</tt> pro IPv4 nebo
<tt>inet6</tt> pro IPv6. PF je obvykle schopen zjistit tento parametr
v závislosti na zdrojové a cílové adrese (adresách).

<dt><tt><i>protocol</i></tt>
<dd>Layer 4 protokol:
<ul>
<li><tt>tcp</tt>
<li><tt>udp</tt>
<li><tt>icmp</tt>
<li><tt>icmp6</tt>
<li>Platné jméno protokolu z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=protocols&amp;sektion=5&amp;manpath=OpenBSD+3.3"
><tt>/etc/protocols</tt></a>
<li>Èíslo protokolu mezi 0 a 255
<li>Mno¾ina protokolù pou¾itím <a href="macros.html#lists">list</a>.
</ul>

<dt><tt><i>src_addr</i></tt>, <tt><i>dst_addr</i></tt> 
<dd>Zdrojová/cílová adresa v IP hlavièce. Adresy mohou být specifkovány
jako:
<ul>
<li>Jedna IPv4 nebo IPv6 adresa.
<li>Sí»ový blok v <a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
formátu.
<li>Plnì kvalifikované doménové jméno které se resolví via DNS ve chvíli,,
kdy je mno¾ina pravidel nahrána. V¹echny výsledné IP adresy budou
substituovány do tohoto pravidla.
<li>Jméno sí»ového interface. V¹echny IP adresy pøiøazené tomuto sí»ovému
interface budou substituované do tohoto pravidla.
<li>Jméno sí»ového inteface následovaného 
<tt>/<i>netmask</tt></i> (napø., <tt>/24</tt>). Ka¾dá IP adresa na tomto
zaøízení kombinovaná s maskou vytvoøí CIDR sí»ový blok, který jje
substituován do tohoto pravidla.
<li>Jméno sí»ového interface v závorkách <tt>( )</tt>. Toto
øekne PF aby obnovil pravidlo pokud se IP adresa (adresy) na takto
pojmenovaném interface zmìní. Toto je u¾iteèné na interface, které dostane
svoji IP adresu via DHCP nebo dial-up, proto¾e mno¾ina pravidel nemusí být
znovu nahrána poka¾dé, kdy¾ se adresa zmìní.
<li>Jméno sí»ového interface následované klíèovým slovem <tt>:network</tt> nebo
<tt>:broadcast</tt>. Výsledná CIDR sí» (napø.,
192.168.0.0/24) nebo broadcast adresa (napø., 192.168.0.255) bude 
substituována do pravidla kdy¾ je mno¾ina pravidel nahrána.
<li><a href="tables.html">table</a>.
<li>Cokoliv z vý¹e uvedeného, ale negováno pomocí modifiktoru <tt>!</tt> ("not").
<li>Mno¾ina adres pou¾itím <a href="macros.html#lists">list</a>.
<li>Klíèové slovo <tt>any</tt> pøedstavující v¹echny adresy
<li>Klíèové slovo <tt>all</tt> co¾ je zkratka za <tt>from any to
any</tt>.
</ul>

<dt><tt><i>src_port</i></tt>, <tt><i>dst_port</i></tt>
<dd>Zdrojový/cílový port v Layer 4 hlavièce paketu. Porty mohou být
specifikovány jako:
<ul>
<li>Èíslo mezi 1 a 65535
<li>Platná jméno slu¾by z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5&amp;manpath=OpenBSD+3.3"
><tt>/etc/services</tt></a>
<li>Mno¾ina portù pou¾itím <a href="macros.html#lists">list</a>
<li>Rozmezí:
	<ul>
	<li><tt>!=</tt> (nerovnost)
	<li><tt>&lt;</tt> (ostøe men¹í ne¾)
	<li><tt>&gt;</tt> (ostøe vìt¹í ne¾)
	<li><tt>&lt;=</tt> (men¹í nebo rovno)
	<li><tt>&gt;=</tt> (vìt¹í nebo rovno)
	<li><tt>&gt;&lt;</tt> (rozmezí)
	<li><tt>&lt;&gt;</tt> (inverzní rozmezí)
	</ul>
	<dl>
	<dd>Poslední dva jsou binární operátory (berou dva argumenty) a
	nezahrnují argumenty v rozmezí.
	</dl>
</ul>

<dt><tt><i>tcp_flags</i></tt>
<dd>Specifikuje flagy, které musí být nastaveny v TCP hlavièce pøi pou¾ití
<tt>proto tcp</tt>. Flagy jsou specifikovány jako
<tt>flags <i>check</i>/<i>mask</i></tt>. Napø. : <tt>flags
S/SA</tt> - to øekne PF aby se díval pouze na flagy S a A (SYN a ACK)
a matchoval pokud je "nahozen" SYN flag.

<dt><tt><i>state</i></tt>
<dd>Specifikuje zda je udr¾ována informace o stavu paketù splòujících toto
pravidlo.
<ul>
<li><tt>keep state</tt> - pracuje s TCP, UDP, a ICMP.
<li><tt>modulate state</tt> - pracuje pouze s TCP. PF bude generovat 
silná Initial Sequence Numbers (ISNs) pro paketu splòující toto pravidlo.
</ul>
</dl>

<a name="defdeny"></a>
<h2>Default Deny</h2>
Doporuèená praxe pro nastavení firewallu je 
"default deny". To znamená, zakázat <i>v¹echno</i> a pak selektivnì
povolit urèitý traffic skrz firewall. Tento pøístup je doporuèený, proto¾e
zmen¹uje pravdìpodobnost chyby v mno¾inì pravidel a také dìlá mno¾inu
pravidel pøehlednìj¹í.

<p>
Pro vytvoøení filtrovací politiky default deny, první dvì pravidla by
mìla být
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
To bude blokovat v¹echen traffic na v¹ech interfacech v obou smìrech.

<a name="pass"></a>
<h2>Passing Traffic</h2>
Traffic musí být explicitnì povolen skrz firewall nebo bude zahozen
default deny politikou. Toto je chvíle, kdy se ke slovu dostávají 
zdrojový/cílový port, zdrojová/cílová adresa, a protokol.
Kdykoliv je traffic povolen skrz firewall nìjakým pravidlem, toto pravidlo
by mìlo být napsáno co nejrestriktivnìji. Toto zajistí, ¾e projde jen a pouze
traffic, který chceme nechat projít.

<p>
Nìjaké pøíklady:
<blockquote>
<tt>
# Povol traffic na dc0 z lokální sítì, 192.168.0.0/24,<br>
# na IP adresu OpenBSD storje 192.168.0.1. Dále povol<br>
# vracející se traffic na dc0.<br>
pass in &nbsp;on dc0 from 192.168.0.0/24 to 192.168.0.1<br>
pass out on dc0 from 192.168.0.1 to 192.168.0.0/24<br>
<br>
<br>
# Povol TCP traffic na fxp0 na web server bì¾ící na<br>
# OpenBSD stroji. Jméno interface, fxp0, je pou¾ito jako<br>
# cílová adresa, tak¾e pakety budou splòovat toto pravidlo pouze tehdy,<br>
# kdy¾ jsou urèeny pro tento OpenBSD stroj.<br>
pass in on fxp0 proto tcp from any to fxp0 port www
</tt>
</blockquote>

<a name="state"></a>
<h2>Udr¾ování stavu</h2>
Jedna z dùle¾itých schopností Packet filtru je "udr¾ování stavu" nebo 
"stavová inspekce". Stavová inspekce se vztahuje k schopnosti PF udr¾ovat
pøehled o stavu nebo prùbìhu sí»ového spojení. Ulo¾ením informace 
o ka¾dém spojení do stavové tabulky, je PF schopen rychle zjistit, zda
paket procházející firewallem patøí do ji¾ ustaveného spojení. Pokud
patøí, projde firewallem bez vyhodnocování rulesetu.

<p>
Udr¾ování stavu má mnoho výhod vèetnì jednodu¹¹ích mno¾in pravidel a
lep¹ího výkon filtrování. PF je schopno poznat pakety jdoucí v 
<i>obou</i> smìrech v rámci stavové tabulky, co¾ znamená, ¾e pravidla pro
vracející se traffic nemusí být v mno¾inì pravidel uvedena.
A proto¾e pakety vyhovující stavovým spojením nemusí projít vyhodnocováním
rulesetu, èas který PF stráví zpracováním takových paketù mù¾e být hodnì
sní¾en.

<p>
Pokud obsahuje pravidlo volbu <tt>keep state</tt>, první paket, který
vyhovuje tomuto pravidlo vytvoøí "stav" mezi odesilatelem a pøíjemcem.
Od té chvíle nejenom pakety jdoucí od odesilatele k pøíjemmcci splòují
záznam ve stavové tabulce, ale také pakety jdoucí od pøíjemce k
odesilateli. Napø.:
<blockquote>
<tt>
pass out on fxp0 proto tcp from any to any keep state
</tt>
</blockquote>

<p>
To povolí jakýkoliv odchozí TCP traffic na interface <tt>fxp0</tt> 
a dále povolí traffic v opaèném smìru.
Udr¾ování stavu je hezká fíèura, je¾ znatelnì zlep¹í výkon firewallu,
proto¾e vyhledávání stavù je rychlej¹í ne¾ vyhodnocování rulesetu.

<p>
Volba <tt>modulate state</tt> pracuje jako <tt>keep state</tt> s tou
výjimkou, ¾e se vztahuje pouze k TCP paketùm. S
<tt>modulate state</tt>, Initial Sequence Number (ISN) odchozích spojení
je náhodné. To je u¾iteèné pro ochranu spojení iniciovaných urèitými
operaèními systémy, které mají ubohý zpùsob volby ISN èísel.

<p>
Keep state na odchozích TCP, UDP, a ICMP paketech a modulace TCP ISNs:
<blockquote>
<tt>
pass out on fxp0 proto tcp from any to any modulate state<br>
pass out on fxp0 proto { udp, icmp } from any to any keep state
</tt>
</blockquote>

<p>
Dal¹í výhodou udr¾ování stavu je ¾e korespondující ICMP traffic projde
firewallem. Napø. pokud je <tt>keep state</tt> specifikován pro TCP
spojení a pøijde ICMP source-quennch zpráva vztahující se k tomuto TCP
spojení, bude vyhovovat pøislu¹nému áznamu ve stavové tabulce a povolena.

<p>
Je dùle¾ité poznamenat, ¾e stavové konence jsou limitované na interface,
na kterém byly vytvoøeny. To je obzvlá¹tì dùle¾ití na routerech a
firewallech bì¾ících PF, zvlá¹» kdy¾ je implementována politika
"default deny" jak je naznaèeno vý¹e. Pokud firewall udr¾uje stav na v¹ech
odhchozích spojeních na externím interface, tyto pakety musí být
explicitnì povoleny skrz interní interface.

<p>
Pravidla <a href="nat.html"><tt>nat</tt></a>, 
<a href="nat.html#binat"><tt>binat</tt></a>, a
<a href="rdr.html"><tt>rdr</tt></a> implicitnì vytváøí stav pro
vyhovující spojení tak dlouho jak je spojení povoleno mno¾inou filtrovaích
pravidel.

<a name="udpstate"></a>
<h2>Udr¾ování stavu pro UDP</h2>
Nìkdo jednou øekl, ¾e "Nelze vytvoøit stav pro UDP, proto¾e UDP je
bezstavový protokol!"  I kdy¾ je pravda, ¾e UDP komunikace 
nemá ¾ádný stavový koncept (nebo expliticní zaèátek a konec komunikace),
to nemá vliv na schopnost PF vytvoøit stav pro UDP session. V pøípadì
protkolù bez "start" a "end" paketù, PF jednodu¹e sleduje kolik uplynulu
èasu od posledního pektu, který vyhovoval pravidlu. Pokud vypr¹el timeout,
dojde ke smazání stavu. Hodnoty timeoutù mohou být nastaveny 
v sekci <a href="options.html">options</a> v souboru
<tt>/etc/pf.conf</tt>.

<a name="tcpflags"></a>
<h2>TCP Flagy</h2>
Vyhodnocování TCP paketù zalo¾ené na flags je nejèastìji pou¾ito k
filtrování TCP paketù, které se pokou¹í u ustavení spojení. TCP flagy a
jejich význam je zde: 
<ul>
<li><b>F</b> : FIN  - Finish; konec session
<li><b>S</b> : SYN  - Synchronize; indikuje ¾ádost o zaèátek session
<li><b>R</b> : RST  - Reset; strhni spojení 
<li><b>P</b> : PUSH - Push; paket je poslán ihned
<li><b>A</b> : ACK  - Acknowledgement
<li><b>U</b> : URG  - Urgent
<li><b>E</b> : ECE  - Explicit Congestion Notification Echo
<li><b>W</b> : CWR  - Congestion Window Reduced
</ul>

<p>
Aby PF provádìl inspekci TCP flagù bìhem vyhodnocování pravidla, je
pou¾ito klíèové slovo <tt>flags</tt> s následující syntaxí:
<blockquote>
<tt>
flags <i>check</i>/<i>mask</i>
</tt>
</blockquote>

<p>
<tt><i>mask</i></tt> øekne PF aby se provádìla inspekce pouze
specifikovaných flagù a <tt><i>check</i></tt> specifikuje které flagy musí
být "nahozeny" v hlavièce aby pravidlo vyhovovalo. 
<blockquote>
<tt>
pass in on fxp0 proto tcp from any to any port ssh flags S/SA
</tt>
</blockquote>

<p>
Vý¹e uvedené pravidlo pustí TCP traffic s nastaveným SYN flagem, zkoumá
pouze pøítomnost SYN a ACK flagù. Paket s SYN a ECE flagy bude vý¹e
uvedenému pravidlu vyhovovat a paket s SYN a ACK nebo jenom ACK nebude.

<p>
Poznámka: v pøedchozích verzích OpenBSD, následující syntax byla 
podporovaná:
<blockquote>
<tt>
. . . flags S
</tt>
</blockquote>

<p>
To u¾ neplatí. Maska musí být nyní <i>v¾dy</i> specifikována.

<p>
Flagy jsou èasto pou¾ity ve spojení s pravidly obsahujícími 
<tt>keep state</tt> pro snadnìj¹í vytváøení záznamù ve stavové tabulce:
<blockquote>
<tt>
pass out on fxp0 proto tcp all flags S/SA keep state
</tt>
</blockquote>

<p>
Toto povolí vytváøení stavu pro odchozí TCP pakety s nastaveným SYN flagem
z SYN a ACK flagù.

<p>
Mìli byste být opatrní pøi pou¾ívání flagù -- rozumìjte tomu, co dìláte a
proè a buïte opatrní s radami, které dostanete, proto¾e spousta z nich je
¹patných.
Nìkteøí lidé navrhují vytvoøení stavu "pouze pokud je nastaven SYN flag
a ne ostatní". Takové pravidlo by skonèilo takto: 
<pre>
     . . . flags S/FSRPAUEW  <i>¹patný nápad!!</i>
</pre>

<p>
Teorie je, ¾e stav se vytváøí pouze na zaèátku TCP session a session by
mìla zaèínat pouze SYN flagem a ne ostatnímmi. Problém je v tom, ¾e
nìkteré stroje zaèínají pou¾ívat ECN flag a pokud se takový stroj pokusí
pøipojit, bude takovým pravidlem odmítnuta. O moc lep¹í pravidlo je:
<blockquote>
<tt>
. . . flags S/SAFR
</tt>
</blockquote>

<p>
Zatímco toto je praktické a bezpeèné, je také nezbytné kontrolovat FIN a
RST flagy pokud traffic také podléhá
<a href="scrub.html">scrub</a>. Scrub proces zpùsobí, ¾e PF bude zahazovat
jakékoliv pøíchozí pakety s ilegální kombinací TCP flagù (jako napø. SYN a
FIN nebo SYN a RST). Je dùraznì doporuèeno v¾dcky pou¾ívat 
<tt>scrub</tt> na pøíchozí traffic:
<blockquote>
<tt>
scrub in on fxp0<br>
.<br>
.<br>
.<br>
pass in on fxp0 proto tcp from any to any port ssh flags S/SA \<br>
&nbsp;&nbsp;&nbsp;keep state
</tt>
</blockquote>

<a name="quick"></a>
<h2>Klíèové slovo <tt>quick</tt></h2>
Jak bylo naznaèeno døíve, ka¾dý paket je vyhodnocovaný oproti mno¾inì
filtrovacích pravidel od shora dolù. Defaultnì, paket je oznaèen pro
prùchod, co¾ mù¾e být zmìmìno nìjakým pravidlem a mù¾e být zmìnìno tam a
zpátky pøedtím ne¾ vyhodnocování dorazí na konec mno¾iny pravidel.
<b>Poslední pravidlo, které vyhovuje "vyhrává".</b>  K tomuto chování
existuje výjimka: Volba <tt>quick</tt> ve filtrovacím pravidle 
ukonèí zpracování a vede k provedení akce s paketem. Podívejme se na
nìkolik pøíkladù:

<p>
©patnì:
<blockquote>
<tt>
block in on fxp0 proto tcp from any to any port ssh<br>
pass &nbsp;in all
</tt>
</blockquote>

<p>
V tomto pøípadì, mù¾e být øádek s <tt>block</tt> vyhodnocen, ale nikdy
nebude mít ¾ádný efekt, proto¾e následuje øádek, který povolí v¹echno.

<p>
Lep¹í:
<blockquote>
<tt>
block in quick on fxp0 proto tcp from any to any port ssh<br>
pass &nbsp;in all
</tt>
</blockquote>

<p>
Tato pravidla budou vyhodnocována trochu odli¹nì. Pokud
øádek s <tt>block</tt> vyhovuje, kvùli volbì <tt>quick</tt> bude paket
zablokován a zbytek mno¾iny pravidel bude ignorován.

<a name="antispoof"></a>
<h2>Blokování Spoofnutých Paketù</h2>
"spoofování" adres je kdy¾ nehodný u¾ivatel zfal¹uje zdrojovou IP adresu v
paketech, které pøená¹í za úèelem schovat svoji skuteènou adresu nebo
vydávat se za nìjaký jiný uzel na sítí. Jakmile u¾ivattel spoofnul svoji
adresu, mù¾e spustit sí»ový útok bez toho, ¾e by odhalil skuteèn zdroj
útoku nebo se mù¾e pokusit získat pøístup k sí»ovým slu¾bám, které jsou
restringovány na urèité IP adresy.

<p>
PF naíbízí ochranu proti spoofování adres pomocí klíèového slova
<tt>antispoof</tt>:

<blockquote>
<tt>
antispoof [log] [quick] for <i>interface</i> [<i>af</i>]
</tt>
</blockquote>

<dl>
<dt><tt>log</tt>
<dd>Specifikuje ¾e vyhovující pakety mají být zalogovány via 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>pflogd(8)</a>.

<dt><tt>quick</tt>
<dd>Pokud paket vyhovuje tomuto pravidlu, pak bude pova¾ováno 
"výherce" a vyhodnocování rulesetu se zastaví.

<dt><tt><i>interface</i></tt>
<dd>Sí»ový interface na kterém aktivovat ochranu proti spoofování.
Zde mù¾e být seznam interfacù via <a href="macros.html#lists">list</a>.

<dt><tt><i>af</i></tt>
<dd>Address family pro kterou aktivovat ochranu proti spoofování, buï
<tt>inet</tt> pro IPv4 nebo <tt>inet6</tt> pro IPv6.
</dl>

<p>
Pøíklad:
<blockquote>
<tt>
antispoof for fxp0 inet
</tt>
</blockquote>

<p>
Kdy¾ je mno¾ina pravidel nahrána, v¹echny výskyty klíèového slova
<tt>antispoof</tt> jsou expandovány do dvou filtrovacích pravidel.
Pøedpokládejme, ¾e interface fxp0 má IP 
adresu 10.0.0.1 a masku podsítì 255.255.255.0 (tj.
/24), pak vý¹e uvedené <tt>antispoof</tt> pravidlo se rozvine do:

<blockquote>
<tt>
block in on ! fxp0 inet from 10.0.0.0/24 to any<br>
block in inet from 10.0.0.1 to any
</tt>
</blockquote>

<p>
Tato pravidla provedou dvì vìci:
<ul>
<li>Zablokuje v¹echen traffic pøicházející ze sítì 10.0.0.0/24 
<i>not</i> který nejde pøes fxp0. Proto¾e sí» 10.0.0.0/24 
je na interface fxp0, pakety se zdrojovou adresou z tohoto sí»ového bloku
by nemìly nikdy pøijít na jiný interface. 
<li>Zablokuje v¹echen pøíchozí traffic z 10.0.0.1, IP addresy na fxp0.
Stroj by nikdy nemìl posílat pakety sobì sama skrz externí interface,
tak¾e v¹echny pøíchozí pakety se zdrojovou adresou nále¾ící stroji by mìly
být pova¾ovány za zlomyslné.
</ul>

<p>
<b>POZNÁMKA</b>: Filtrovací pravidla do kterých se expanduje pravidlo 
<tt>antispoof</tt> budou také blokovat pakety poslané pøes loopback
interface na lokální adresu. Tyto adresy by mìly být explicitnì povoleny.
Napø.:
<blockquote>
<tt>
pass in quick on lo0 all<br>
<br>
antispoof for fxp0 inet
</tt>
</blockquote>

<p>
Pou¾ití <tt>antispoof</tt> by mìlo být omezeno na interfacy, které mají
pøiøazenu IP adresu. Pou¾ití
<tt>antispoof</tt> na interface bez IP adresy vyústí v filtrovací pravidla
jako
<blockquote>
<tt>
block drop in on ! fxp0 inet all<br>
block drop in inet all
</tt>
</blockquote>

<p>
S tìmito pravidly riskujete blokování <i>ve¹kerého</i> pøíchozího trafficu
na <i>v¹ech</i> interfacech.

<a name="ipopts"></a>
<h2>IP Options</h2>
Defaultnì, PF blokuje v¹echny pakety s nastavenými IP options. To mù¾e
být dobré pro detekci "OS fingerprinting" utilitami jako nmap. Pokud
provozujete aplikaci, která vy¾aduje povolení takových paketù jako napø.
multicast nebo IGMP, mù¾e pou¾ít direktivu <tt>allow-opts</tt>:
<blockquote>
<tt>
pass in quick on fxp0 all allow-opts
</tt>
</blockquote>

<a name="example"></a>
<h2>Pøíklad mno¾iny filtrovacích pravidel</h2>
Ní¾e je uveden pøiklad mno¾iny filtrovacích pravidel. Stroj, na kterém
bì¾í PF funguje jako firewall mezi malou interní sítí a Internetem.
Uvedena jsou pouze filtrovcí pravidla.
<a href="queueing.html">queueing</a>, 
<a href="nat.html"><tt>nat</tt></a>, 
<a href="rdr.html"><tt>rdr</tt></a>, 
atd., byly v tomto pøíkladu vynechány.
<br>
<br>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
ext_if  = "fxp0"
int_if  = "dc0"
lan_net = "192.168.0.0/24"

# scrub incoming packets
scrub in all

# nastav politiku default deny 
block in  all
block out all

# povol traffic na loopback interface v obou smìrech
pass quick on lo0 all

# aktivuj ochranu proti spoofování na interním interface.
antispoof quick for $int_if inet

# povol pouze ssh spojení z lokální sítì pokud je to dùveryhodný poèítaè
# 192.168.0.15. pou¾ij "block return" tak¾e je poslán TCP RST 
# pro uzavøených blokovaných spojení. pou¾ij "quick" aby nebylo toto
# pravidlo pøepsáno nìkterým z "pass" pravidel pod ním.
block return in quick on $int_if proto tcp from ! 192.168.0.15 \
   to $int_if port ssh flags S/SA

# povol v¹echen traffic z a do lokální sítì
pass in  on $int_if from $lan_net to any
pass out on $int_if from any to $lan_net

# povol tcp, udp, a icmp z externího (Internet) interface. 
# keep state pro udp a icmp a modulate state pro tcp.
pass out on $ext_if proto tcp all modulate state flags S/SA
pass out on $ext_if proto { udp, icmp } all keep state

# povol ssh spojení na externí interface pokud NENÍ urèen 
# pro firewall (tj. jsou urèeny pro stroj v lokální síti)
# loguj iniciální pakety tak¾e mù¾eme pozdìji øíci, kdo se pokou¹el
# napojit
pass in log on $ext_if proto tcp from any to { !$ext_if, !$int_if } \
   port ssh flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
[<a href="rdr.html">Pøedchozí: Pøesmìroování Trafficu</a>]
[<a href="index.html">Obsah</a>]
[<a href="logging.html">Dal¹í: Logování</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<small>
<br>
Originally [OpenBSD: filter.html,v 1.13 ]
<!--- translation by Vladimir Kotal -->
<br>
$Translation: filter.html,v 1.3 2003/11/10 13:34:59 horacio Exp $
<br>
$OpenBSD: filter.html,v 1.3 2003/11/10 14:42:48 horacio Exp $
</small>

</body>
</html> 
