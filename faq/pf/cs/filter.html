<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Filtrování paketů</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../cs/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="tables.html">Předchozí: Tabulky</a>]
[<a href="index.html">Obsah</a>]
[<a href="../nat.html">Další: Network Address Translation</a>]

<h1><font color="#e00000">PF: Filtrování paketů</font></h1>

<hr>

<h3>Obsah</h3>
<ul>
<li><a href="#intro">Úvod</a>
<li><a href="#syntax">Syntaxe pravidel</a>
<li><a href="#defdeny">Zakázání všeho</a>
<li><a href="#pass">Povolování provozu</a>
<li><a href="#quick">Klíčové slovo <tt>quick</tt></a>
<li><a href="#state">Udržování informace o spojení</a>
<li><a href="#udpstate">Udržování informace o spojení pro UDP</a>
<li><a href="#stateopts">Volby pro sledování stavů</a>
<li><a href="#tcpflags">Volby TCP paketu</a>
<li><a href="#synproxy">TCP SYN Proxy</a>
<li><a href="#antispoof">Blokování podvržených paketů</a>
<li><a href="#urpf">Unicast Reverse Path Forwarding</a>
<li><a href="#osfp">Pasivní detekce operačních systémů</a>
<li><a href="#ipopts">Volby protokolu IP</a>
<li><a href="#example">Příklad filtrovacích pravidel</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Úvod</h2>
Filtrování paketů je selektivní povolení nebo blokování datových paketů, 
které prochází přes síťové rozhraní. Kritéria, která 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.7"
>pf(4)</a> používá při inspekci paketů jsou založena na vrstvě 3
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip&amp;sektion=4"
>IPv4</a> a 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip6&amp;sektion=4"
>IPv6</a>) a vrstvě 4
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcp&amp;sektion=4"
>TCP</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=udp&amp;sektion=4"
>UDP</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp&amp;sektion=4"
>ICMP</a> a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp6&amp;sektion=4"
>ICMPv6</a>) záhlaví. Nejčastěji používaná kritéria jsou zdrojová a cílová
adresa, zdrojový a cílový port a protokol.

<p>
Filtrovací pravidla specifikují kritéria, která musí paket splnit a následnou
akci, buď blokování nebo povolení, která se vykoná jakmile se najde shoda.
Filtrovací pravidla jsou vykonávána sekvenčně od prvního k poslednímu.
Pokud paket neodpovídá pravidlu obsahujícímu klíčové slovo <tt>quick</tt>, 
tak paket prochází <i>všechna</i> pravidla předtím než nastane finální akce.
Poslední pravidlo, které odpovídá je "vítěz" a bude určovat, která akce se 
s paketem provede. Je zde defaultní pravidlo <tt>pass all</tt> na začátku
seznamu, které znamená, že pokud paket neodpovídá žádnému filtrovacímu 
pravidlu, tak výsledná akce bude <tt>pass</tt>.

<a name="syntax"></a>
<h2>Syntaxe pravidel</h2>
Obecná, <i>velmi zjednodušená</i> syntaxe pro filtrovací pravidla je:
<blockquote>
<tt>
<i>action</i> [<i>direction</i>] [log] [quick] [on <i>interface</i>] 
[<i>af</i>] [proto <i>protocol</i>] \<br>
&nbsp;&nbsp;&nbsp;[from <i>src_addr</i> [port <i>src_port</i>]] [to 
<i>dst_addr</i> [port <i>dst_port</i>]] \<br>
&nbsp;&nbsp;&nbsp;[flags <i>tcp_flags</i>] [<i>state</i>]
</tt>
</blockquote>

<dl>
<dt><tt><i>action</i></tt>
<dd>Akce, která se vykoná na odpovídajících paketech. Buď <tt>pass</tt> nebo
<tt>block</tt>. Akce <tt>pass</tt> propustí paket dále do jádra k dalšímu
zpracování, zatímco <tt>block</tt> akce reaguje podle nastavení
<a href="../options.html#block-policy"><tt>block-policy</tt></a> volby. 
Defaultni reakce může být přepsána buď pomocí specifikování 
<tt>block drop</tt> nebo <tt>block return</tt>.

<dt><tt><i>direction</i></tt>
<dd>Směr, kterým se paket pohybuje na rozhraní. Buď
<tt>in</tt> nebo <tt>out</tt>.

<dt><tt>log</tt>
<dd>Specifikuje, že paket by měl být zaznamenán pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.7"
>pflogd(8)</a>. Pokud pravidlo vytváří stav, tak pouze paket, který tento
stav vytváří je zaznamenán. K zaznamenání všech paketů bez rozdílu použijte
<tt>log (all)</tt>.

<dt><tt>quick</tt>
<dd>Pokud paket odpovídá pravidlu specifikujícímu <tt>quick</tt>, tak je toto
pravidlo považováno za poslední odpovídající a specifikovaná
<tt><i>action</i></tt> je provedena.

<dt><tt><i>interface</i></tt>
<dd>Název nebo skupina síťového rozhraní přes které se paket pohybuje.
Rozhraní mohou být přidána do skupin pomocí
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a> příkazu.
Některé skupiny jsou vytvořeny automaticky jádrem:
<ul>
<li>Skupina <tt>egress</tt> , která obsahuje rozhraní(i více z nich) jež
mají defaultní route(s).
<li>Obecná skupina pro klonované rozhraní.
Příklad: <tt>ppp</tt> nebo <tt>carp</tt>.
</ul>
Tohle zajistí, že pravidlo bude odpovídat jakémukoliv paketu, který jde
přes jakékoliv <tt>ppp</tt> nebo <tt>carp</tt> rozhraní.

<dt><tt><i>af</i></tt>
<dd>Rodina adres paketu. Buď <tt>inet</tt> pro IPv4 nebo
<tt>inet6</tt> pro IPv6. PF je obvykle schopné rozlišit tento parametr
na základě zdrojové a/nebo cílové adresy(adres).

<dt><tt><i>protocol</i></tt>
<dd>Protokol paketu z vrstvy 4:
<ul>
<li><tt>tcp</tt>
<li><tt>udp</tt>
<li><tt>icmp</tt>
<li><tt>icmp6</tt>
<li>Platné jméno protokolu z 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=protocols&amp;sektion=5"
><tt>/etc/protocols</tt></a>
<li>Číslo protokolu mezi 0 a 255
<li>Sada protokolů za použití <a href="macros.html#lists">seznamu</a>.
</ul>

<dt><tt><i>src_addr</i></tt>, <tt><i>dst_addr</i></tt> 
<dd>Zdrojová/cílová adresa v IP záhlaví. Adresy mohou být specifikovány
jako:
<ul>
<li>Samotná IPv4 nebo IPv6 adresa.
<li><a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
síťový blok.
<li>Plné doménové jméno, které bude přeloženo pomocí DNS v době nahrávání
pravidel. Všechny výsledné IP adresy budou do pravidel doplněny a nahradí
doménové jména.
<li>Jméno síťového rozhraní nebo skupiny. Jakákoliv IP adresa přiřazená k
rozhraní bude doplněna do pravidla.
<li>Jméno síťového rozhraní následované
<tt>/<i>síťovou maskou</i></tt> (např., <tt>/24</tt>). 
Každá IP adresa na rozhraní je zkombinovaná se síťovou maskou k vytvoření
CIDR síťového bloku, který je následně doplněn do pravidla.
<li>Jméno síťového rozhraní nebo skupiny v jednoduchých závorkách
<tt>( )</tt>.
Toto PF říká, že se pravidlo má aktualizovat pokud se IP adresa(adresy) na
pojmenovaném rozhraní změní.
Toto je užitečné na rozhraní, které získává svou IP adresu pomocí DHCP nebo
na vytáčeném připojení, protože pravidla pak nemusí být znovu nahrávána 
pokaždé, když se adresa změní.
<li>Jméno síťového rozhraní následované jakýmkoliv z následujících
modifikátorů: 
  <ul>
  <li><tt>:network</tt> - dosadí CIDR síťový blok (např.,
  192.168.0.0/24)
  <li><tt>:broadcast</tt> - dosadí síťovou broadcast adresu
  (např., 192.168.0.255)
  <li><tt>:peer</tt> - dosadí peer IP adresu na point-to-point lince
  </ul>
  <dl>
  <dd>Jako doplnění, <tt>:0</tt> modifikátor může být přidán buď ke jménu
  rozhraní nebo k jakémukoliv výše zmíněnému modifikátoru pro indikaci, že
  PF by neměl zahrnout IP aliasy k dosazení. Tyto modifikátory mohou být
  také použity, když je rozhraní uvedeno v závorkách.
  Příklad: <tt>fxp0:network:0</tt>
  </dl>
<li><a href="tables.html">Tabulka</a>.
<li>Klíčové slovo <tt>urpf-failed</tt> může být použito pro zdrojovou adresu
k indikaci toho, že by měla projít <a href="#urpf">uRPF kontrolou</a>.
<li>Cokoliv z výše uvedeného, ale negované pomocí <tt>!</tt> ("ne") 
modifikátoru.
<li>Sada adres pomocí <a href="macros.html#lists">seznamu</a>.
<li>Klíčové slovo <tt>any</tt> znamenající všechny adresy.
<li>Klíčové slovo <tt>all</tt>, které je zkratkou pro <tt>from any to
any</tt>.
</ul>

<dt><tt><i>src_port</i></tt>, <tt><i>dst_port</i></tt>
<dd>Zdrojový/cílový port v záhlaví paketu na vrstvě 4. Porty mohou být
specifikovány jako:
<ul>
<li>Číslo mezi 1 a 65535
<li>Platné jméno služby z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5"
><tt>/etc/services</tt></a>
<li>Sada portů pomocí <a href="macros.html#lists">seznamu</a>
<li>Rozsah:
	<ul>
	<li><tt>!=</tt> (nerovná se)
	<li><tt>&lt;</tt> (méně než)
	<li><tt>&gt;</tt> (více než)
	<li><tt>&lt;=</tt> (méně než nebo rovná se)
	<li><tt>&gt;=</tt> (více než nebo rovná se)
	<li><tt>&gt;&lt;</tt> (rozsah)
	<li><tt>&lt;&gt;</tt> (inverzní rozsah)
	<dl>
	<dd>Poslední dva jsou binární operátory (přijímají dva argumenty) 
	a neobsahují argumenty v rozsahu.
	</dl>
	<li><tt>:</tt> (všeobecný rozsah)
	<dl>
	<dd>Jedná se také o binární operátor a obsahuje argumenty v rozsahu.
	</dl>
	</ul>
</ul>

<dt><tt><i>tcp_flags</i></tt>
<dd>Specifikuje volby, které musí být nastaveny v TCP záhlaví při použítí
<tt>proto tcp</tt>. Volby jsou specifikovány jako 
<tt>flags <i>check</i>/<i>mask</i></tt>. Příklad: <tt>flags
S/SA</tt> - toto PF říká, aby se podíval na S a A (SYN a ACK)
volby a aplikoval toto pravidlo na paket jen pokud je SYN volba "zapnuta" 
(defaultně to platí pro všechna TCP pravidla).
<tt>flags any</tt> instructs PF not to check flags.

<dt><tt><i>state</i></tt>
<dd>Specifikuje, zda se ukládá informace o stavu spojení pro pakety, které
odpovídají tomuto pravidlu.
<ul>
<li><tt>no state</tt> - funguje s TCP, UDP a ICMP.
PF nebude sledovat informace o stavu spojení.
Pro TCP spojení, <tt>flags any</tt> je obvykle nutno použít.
<li><tt>keep state</tt> - funguje s TCP, UDP a ICMP.
Tato volba je defaultní pro všechny filtrovací pravidla.
<li><tt>modulate state</tt> - funguje pouze s TCP. PF vygeneruje silné
Initial Sequence Number (ISN) pro pakety odpovídající tomuto pravidlu.
<li><tt>synproxy state</tt> - funguje jako proxy pro příchozí TCP spojení
k ochraně serverů před zahlcením TCP SYN pakety s podvrženou adresou.
Tato volba obsahuje funkčnost <tt>keep state</tt> a
<tt>modulate state</tt>.
</ul>
</dl>

<a name="defdeny"></a>
<h2>Zakázání všeho</h2>
Doporučená praxe při nastavování firewallu je použít přístup "default deny".
To znamená zakázat <i>vše</i> a poté selektivně povolovat určitý provoz
přes firewall. Tento přístup je doporučený, protože zvyšuje bezpečnost a
zjednodušuje psaní pravidel.

<p>
Pro vytvoření "default deny" filtrovací politiky stačí vytvořit tyto první
dvě filtrovací pravidla:
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
Toto bude blokovat všechen provoz na všech rozhraních v jakémkoliv směru a
odkudkoliv kamkoliv.

<a name="pass"></a>
<h2>Povolování provozu</h2>
Provoz nyní musí být explicitně povolen pro průchod firewallem, protože
jinak bude zahozen díky politice "default deny". Tohle je oblast, kde 
kritéria paketů jako zdrojový/cílový port, zdrojová/cílová adresa a protokol
přicházejí do hry. Kdykoliv je provoz povolen procházet přes firewall, tak
pravidlo(pravidla) musí být maximálně restriktivní jak to jen je možné.
Je to kvůli tomu, aby se zajistilo, že jen chtěný provoz a opravdu jen chtěný
provoz bude povolen.

<p>
Některé příklady:
<blockquote>
<tt>
# Pass traffic in on dc0 from the local network, 192.168.0.0/24,<br>
# to the OpenBSD machine's IP address 192.168.0.1. Also, pass the<br>
# return traffic out on dc0.<br>
pass in &nbsp;on dc0 from 192.168.0.0/24 to 192.168.0.1<br>
pass out on dc0 from 192.168.0.1 to 192.168.0.0/24<br>
<br>
<br>
# Pass TCP traffic in on fxp0 to the web server running on the<br>
# OpenBSD machine. The interface name, fxp0, is used as the<br>
# destination address so that packets will only match this rule if<br>
# they're destined for the OpenBSD machine.<br>
pass in on fxp0 proto tcp from any to fxp0 port www
</tt>
</blockquote>

<a name="quick"></a>
<h2>Klíčové slovo <tt>quick</tt></h2>
Jak již bylo zmíněno dříve, tak každý paket se vyhodnocuje v pravidlech
od shora dolů. Defaultně je paket označen k propuštění což může být
změněno kterýmkoliv pravidlem. Může to být změněno tam a zpět několikrát
po sobě než se dorazí na konec filtrovacích pravidel. <b>Poslední
odpovídající pravidlo "vítězí".</b>  Je zde ale vyjímka z tohoto pravidla:  <tt>quick</tt> volba ve filtrovacím pravidle má efekt zrušení jakéhokoliv
následného zpracovávání a způsobí, že specifikovaná akce se provede.
Pojďme se podívat na několik příkladů:

<p>
Špatně:
<blockquote>
<tt>
block in on fxp0 proto tcp to port ssh<br>
pass &nbsp;in all
</tt>
</blockquote>

<p>
V tomto případě by <tt>block</tt> řádek měl být vykonán, ale nikdy nebude
mít žádný efekt, protože je následován řádkem, který propustí vše.

<p>
Lépe:
<blockquote>
<tt>
block in quick on fxp0 proto tcp to port ssh<br>
pass &nbsp;in all
</tt>
</blockquote>

<p>
Tyto pravidla jsou vykonány trochu odlišně. Pokud řádek <tt>block</tt>
odpovídá, tak díky volbě <tt>quick</tt> bude paket zablokován a zbytek
pravidel bude ignorován.

<a name="state"></a>
<h2>Udržování informace o spojení</h2>
Jedna z důležitých vlastností PF je udržování informace o spojení
"keeping state" nebo kontrola stavu spojení "stateful inspection".
Kontrola stavu spojení odkazuje na schopnost PF sledovat stav nebo vývoj
síťového spojení. Pomocí ukládání informace o každém spojení do stavové 
tabulky je PF schopné rychle rozhodnout jestli paket procházející firewallem
náleží do již existujícího navázaného spojení. Pokud ano, tak je puštěn skrze
firewall aniž by procházel dalšími pravidly.

<p>
Udržování informace o spojení má mnoho výhod včetně lehčích pravidel a 
lepšího výkonu filtrování paketů. PF je schopné kontrolovat pakety pohybující
se v <i>jakémkoliv</i> směru proti záznamům ve stavové tabulce což znamená,
že filtrovací pravidla, která propuští vracející se provoz nemusí být vůbec
napsaná. A díky tomu, že pakety odpovídající navázaným spojení neprochází
vyhodnocením pomocí pravidel, tak čas, který PF stráví správou těchto paketů
může být výrazně snížen.

<p>
Když pravidlo vytváří stav, tak první paket odpovídající pravidlu vytváří
"stav" mezi odesílatelem a příjemcem. Nyní nejen pakety odcházející od
odesílatele k příjemci odpovídají stavovému záznamu a přeskakují průchod
pravidly, ale i pakety vracející se stejnou cestou se chovají stejně.

<p>
Všechny <i>pass</i> pravidla automaticky vytváří stavový záznam, když
paket odpovídá pravidlu.
Toto může být explicitně zrušeno použítím <tt>no state</tt> volby.

<blockquote>
<tt>
pass out on fxp0 proto tcp from any to any
</tt>
</blockquote>

<p>
Toto pravidlo umožňuje jakýkoliv odchozí TCP provoz na <tt>fxp0</tt>
rozhraní a také povoluje vracející se provoz k tomuto spojení skrze
firewall. Udržování informace o spojení výrazně zlepšuje výkon vašeho
firewallu, protože vyhledávání stavu jsou dramaticky rychlejší v porovnání
s průchodem paketu filtrovacími pravidly.

<p>
Volba <tt>modulate state</tt> funguje stejně jako <tt>keep state</tt>
mimo to, že je funkční pouze pro TCP pakety. S
<tt>modulate state</tt> je Initial Sequence Number (ISN) odchozího
spojení randomizováno. Toto je užitečné pro ochranu spojení navazovaných
některými operačními systémy, které odvádí špatnou práci při výběru ISN.
Pro umožnění lehčích pravidel může být volba <tt>modulate state</tt> 
použita v pravidlech, která specifikují protokol jiný než TCP; v těchto
 případech je vyhodnocována jako <tt>keep state</tt>. 

<p>
Udržování informace o spojení pro odchozí TCP, UDP a ICMP pakety a modulování
TCP ISN:
<blockquote>
<tt>
pass out on fxp0 proto { tcp, udp, icmp } from any \<br>
&nbsp;&nbsp;&nbsp;&nbsp;to any modulate state<br>
</tt>
</blockquote>

<p>
Další výhoda udržování informace o spojení je, že související ICMP provoz
bude propuštěn skrze firewall.

Například když TCP spojení prochází firewallem a je o něm udržována informace
o spojení a zároveň přijde ICMP source-quench zpráva odkazující na toto TCP
spojení, tak bude přiřazena odpovídajícímu záznamu o stavu a propuštěna skrze
firewall.

<p>
Rozsah stavového záznamu je globálně kontrolován pomocí
<a href="../options.html#state-policy"><tt>state-policy</tt></a>
volby za běhu a v jednotlivých pravidlech pomocí <tt>if-bound</tt>
a <tt>floating</tt> klíčových slov pro stavy.
Tyto klíčová slova pro jednotlivá pravidla mají stejný význam jako
když se použíjí s volbou <tt>state-policy</tt> . Příklad:

<blockquote>
<tt>
pass out on fxp0 proto { tcp, udp, icmp } from any \<br>
&nbsp;&nbsp;&nbsp;&nbsp;to any modulate state (if-bound)<br>
</tt>
</blockquote>

<p>
Toto pravidlo nařídí, že aby pakety souhlasili se stavovým záznamem, tak
musí procházet přes <tt>fxp0</tt> rozhraní.


<a name="udpstate"></a>
<h2>Udržování informace o spojení pro UDP</h2>
Možná jste někdy slyšeli, jak se říká, že "Nejde vytvořit informace o stavu
UDP, protože UDP je bezstavový protokol!". I když je pravda, že UDP 
komunikace nemá žádný koncept stavů (explicitně definovaný začátek a
konec komunikace), tak to nemá žádný vliv na schopnost PF vytvořit informaci
o stavu pro UDP spojení. V případě protokolů bez "počátečních" a "koncových"
paketů PF prostě sleduje informaci o tom, kolik času uběhlo od okamžiku, kdy
odpovídající paket procházel. Pokud čas vyprší(timeout), tak se informace o
stavu smaže. Časové hodnoty je možné nastavit v
<a href="../options.html">options</a> sekci <tt>pf.conf</tt>
souboru.

<a name="stateopts"></a>
<h2>Volby pro sledování stavů</h2>
Filtrovací pravidla, která vytvářejí stavové záznamy mohou specifikovat
různé volby pro kontrolu chování výsledného stavového záznamu. Následující
volby jsou dostupné:

<dl>
<dt><tt>max <i>number</i></tt>
<dd>Omezuje maximální číslo stavových záznamů, které pravidlo může vytvořit
na <i>number</i>.
Pokud je maximum dosaženo, tak pakety, které by normálně vytvořili stavový
záznam nebudou tomuto pravidlu vyhovovat, dokud se číslo existujích stavových
záznamů nesníží pod uvedený limit.

<dt><tt>no state</tt>
<dd>Zabraňuje pravidlu automaticky vytvářet stavový záznam.

<dt><tt>source-track</tt>
<dd>Tato volba umožňuje sledování počtu stavových záznamů vytvořených pro 
každou zdrojovou IP adresu. 
Tato volba má dva formáty:
	<ul>
	<li><tt>source-track rule</tt> - Maximální počet stavů vytvořených
	pomocí tohoto pravidla je limitován pomocí <tt>max-src-nodes</tt>
	a <tt>max-src-states</tt> voleb pravidla. Pouze stavy vytvořené 
	pomocí tohoto konkrétního pravidla se připočítávají k limitům 
	pravidla.
	<li><tt>source-track global</tt> - Počet stavů vytvořených všemi
	pravidly, které používají tuto volbu je limitován. Každé pravidlo
	může specifikovat rozdílné <tt>max-src-nodes</tt> a 
	<tt>max-src-states</tt> volby. Ovšem stavové záznamy vytvořené
	jakýmkoliv dalším pravidlem se připočítávají k individuálním limitům
	pravidla.
	</ul>
Celkový počet zdrojových IP adres, které mohou být sledovány globálně může
být kontrolován pomocí
<a href="../options.html#limit"><tt>src-nodes</tt> on-line volby</a>.

<dt><tt>max-src-nodes <i>number</i></tt>
<dd>Když se použije <tt>source-track</tt> volba, tak
<tt>max-src-nodes</tt> omezí počet zdrojových IP adres, které mohou současně
vytvořit stav. Tato volba může být použita pouze s 
<tt>source-track rule</tt>.

<dt><tt>max-src-states <i>number</i></tt>
<dd>Když se použije <tt>source-track</tt> volba, tak
<tt>max-src-states</tt> omezí počet simultánních  stavových záznamů, které
mohou být vytvořeny pro každou IP adresu. Rozsah tohoto limitu 
(to značí, stavy vytvořené pouze tímto pravidlem nebo stavy vytvořené 
všemi pravidly, které používají <tt>source-track</tt>) je závislý
na specifikaci <tt>source-track</tt> volby.
</dl>

<p>
Volby jsou specifikovány uvnitř závorek a okamžitě po jednom z klíčových
slov pro stavy (<tt>keep state</tt>, <tt>modulate state</tt> nebo 
 <tt>synproxy state</tt>). Vícenásobné volby jsou odděleny čárkou.
V OpenBSD 4.1 a pozdějších se <tt>keep state</tt> volba stala implicitně
defaultní pro všechna filtrovací pravidla.
Navzdory tomuto musí být při specifikaci voleb stavů jedno z klíčových
slov pro stavy vždy použito ještě před těmito volbami.


<p>
Příklad pravidla:

<blockquote>
<tt>
pass in on $ext_if proto tcp to $web_server \<br>
&nbsp;&nbsp;&nbsp;&nbsp;port www keep state \<br>
&nbsp;&nbsp;&nbsp;&nbsp;(max 200, source-track rule, max-src-nodes 100,
max-src-states 3)
</tt>
</blockquote>

<p>
Pravidlo uvedené výše definuje následující chování:

<ul>
<li>Omezuje absolutní maximálně možný počet stavů, které toto pravidlo může
vytvořit na 200
<li>Povoluje source-track volbu; omezuje vytvoření stavů na stavy vytvořené
pouze pomocí tohoto pravidla
<li>Omezuje maximální možný počet uzlů, které mohou současně vytvořiv stav
na 100
<li>Omezuje maximální počet simultánních stavů pro zdrojovou IP na 3
</ul>

<p>
Samostatná sada omezení může být uplatněna na stateful TCP spojení, která
dokončila tzv. 3-cestný handshake.

<dl>
<dt><tt>max-src-conn <i>number</i></tt>
<dd>Omezuje maximální počet simultánních TCP spojení, které může jednotlivý
systém vytvořit a které dokončili 3-cestný handshake.
<dt><tt>max-src-conn-rate <i>number</i> / <i>interval</i></tt>
<dd>Omezuje rychlost nových spojení na určitý počet za danný časový interval.
</dl>

<p>
Obě tyto volby automaticky používají <tt>source-track rule</tt>
volbu a jsou nekompatibilní s <tt>source-track global</tt>.

<p>
Protože tyto limity jsou aplikovány pouze proti TCP spojením, které
dokončili 3-cestný handshake, tak je možné použít mnohem agresivnější akce
proti "útočícím" IP adresám.

<dl>
<dt><tt>overload &lt;<i>table</i>&gt;</tt>
<dd>Vloží "útočící" IP adresu systému do pojmenované tabulky.
<dt><tt>flush [global]</tt>
<dd>Znič jakékoliv další stavy, které odpovídají tomuto pravidlu a které
byly vytvořeny touto zdrojovou IP adresou.
Když je <tt>global</tt> specifikováno, tak znič všechny stavy odpovídající 
zdrojové IP adrese bez ohledu na to, které pravidlo stav vytvořilo.
</dl>

<p>
Příklad:

<blockquote>
<tt>
table &lt;abusive_hosts&gt; persist<br>
block in quick from &lt;abusive_hosts&gt;<br>
<br>
pass in on $ext_if proto tcp to $web_server \<br>
&nbsp;&nbsp;&nbsp;&nbsp;port www flags S/SA keep state \<br>
&nbsp;&nbsp;&nbsp;&nbsp;(max-src-conn 100, max-src-conn-rate 15/5,
overload &lt;abusive_hosts&gt; flush)
</tt>
</blockquote>

<p>
Toto dělá následující:

<ul>
<li>Omezuje maximální počet spojení ze zdroje na 100
<li>Limituje počet spojení na 15 v rozsahu 5 sekund
<li>Vlož IP adresu jakéhokoliv systému, který poruší tyto pravidla do
<tt>&lt;abusive_hosts&gt;</tt> tabulky
<li>Pro jakoukoliv "útočící" IP adresu znič jakékoliv stavy vytvořené tímto
pravidlem.
</ul>

<a name="tcpflags"></a>
<h2>Volby TCP paketu</h2>
Výběr TCP paketů podle jejich voleb je nejčastěji používáno k filtrování
TCP paketů, které se pokoušejí otevřít nové spojení. TCP volby paketu a
jejich významy jsou vypsány zde:
<ul>
<li><b>F</b> : FIN  - Finish; konec spojení
<li><b>S</b> : SYN  - Synchronize; indikuje požadavak na začátek spojení
<li><b>R</b> : RST  - Reset; zahodí spojení
<li><b>P</b> : PUSH - Push; paket je poslán okamžitě
<li><b>A</b> : ACK  - Acknowledgement; potvrzení
<li><b>U</b> : URG  - Urgent; urgentní
<li><b>E</b> : ECE  - Explicit Congestion Notification Echo
<li><b>W</b> : CWR  - Congestion Window Reduced
</ul>

<p>
Aby PF kontroloval TCP volby paketu během vykonávání pravidla, tak se používá
klíčové slovo <tt>flags</tt> s následující syntaxí:
<blockquote>
<tt>
flags <i>check</i>/<i>mask</i><br>
flags any
</tt>
</blockquote>

<p>
Část <tt><i>mask</i></tt> PF říká, aby kontroloval pouze specifikované
volby a část <tt><i>check</i></tt> specifikuje, která volba(y) musí být
"zapnuty" v záhlaví aby nastala shoda.
Použití klíčového slova <tt>any</tt> umožňuje, aby jakákoliv kombinace
voleb v záhlaví odpovídala.
<blockquote>
<tt>
pass in on fxp0 proto tcp from any to any port ssh flags S/SA
pass in on fxp0 proto tcp from any to any port ssh
</tt>
</blockquote>

<p>
Protože <tt>flags S/SA</tt> je nastaveno defaultně, tak výše uvedená
pravidla jsou stejná; každé z těchto pravidel propouští TCP provoz
s volbou SYN nastavenou, přičemž se dívá pouze na SYN a ACK volby.
Paket s volbami SYN a ECE bude odpovídat výše uvedeným pravidlům, ale paket
s SYN a ACK nebo pouze ACK už ne.

<p>
Defaultní volby mohou být přepsány pomocí volby <tt>flags</tt> jak je
zmíněno výše.

<p>
Je důležité být opatrný při použítí voleb -- rozumějte tomu co děláte a proč
a buďte opatrní s doporučeními od lidí, protože hodně z nich je špatných.
Někteří lidé doporučovali vytvořit stav "jen pokud je SYN volba nastavena
a žádné jiné". Takové pravidlo může končit nějak takhle:
<pre>
     . . . flags S/FSRPAUEW  <i>bad idea!!</i>
</pre>

<p>
Teorie je vytvořit stav jen na začátku TCP spojení a spojení by mělo začínat
s SYN volbou a žádnou jinou. Problém je, že některé systémy začínají používat
ECN volbu a tak jakýkoliv systém používající ECN, který se pokusí s vámi 
spojit bude tímto pravidlem odmítnut.
Mnohem lepší přístup je nespecifikovat vůbec žádné volby a nechat PF
aplikovat defaultní volby do vašich pravidel.
Pokud opravdu sami pro sebe chcete volby specifikovat, tak následující
kombinace by měla být bezpečná:
<blockquote>
<tt>
. . . flags S/SAFR
</tt>
</blockquote>

<p>
<!--XXX scrub changes may have invalidated this-->
I když je toto praktické a bezpečné, tak je také zbytečné kontrolovat
FIN a RST volby pokud je provoz také kontrolován pomocí scrub.
Scrub proces způsobí, že PF zahodí jakékoliv příchozí pakety s nelegálními
kombinacemi TCP voleb (jako SYN a RST) a normalizuje potencionálně nejasné
kombinace (jako SYN a FIN).


<a name="synproxy"></a>
<h2>TCP SYN Proxy</h2>
<p>
Normálně, když klient inicializuje TCP spojení k serveru, tak PF propustí
<a href="http://www.inetdaemon.com/tutorials/internet/tcp/3-way_handshake.shtml"
>handshake</a> pakety mezi dvěma body spojení tak jak přicházejí.
PF má ovšem schopnost aplikovat proxy na tyto handshake.
Když handshake prochází přes tuto proxy, tak PF samotné dokončí handshake
s klientem a poté vyvolá handshake se serverem a až poté propustí pakety
mezi klientem a serverem.
Výhoda tohoto procesu je, že žádné pakety nejsou poslány serveru dokud
klient nedokončí handshake.
To elimuje nebezpečí návalu podvržených TCP SYN spojení , které by
 ovlivňovali server, protože podvržené klientské spojení nebude 
schopné dokončit handshake.

<p>
TCP SYN proxy se povoluje pomocí klíčového slova <tt>synproxy state</tt>
 ve filtrovacích pravidlech. Příklad:

<blockquote>
<tt>
pass in on $ext_if proto tcp to $web_server port www synproxy state
</tt>
</blockquote>

<p>
V tomto případě budou spojení k web serveru procházet přes TCP proxy v PF.

<p>
Díky tomu jak <tt>synproxy state</tt> funguje, tak také obsahuje stejnou
funkcionalitu jako <tt>keep state</tt> a <tt>modulate state</tt>.

<p>
SYN proxy nebude fungovat pokud PF běží na  
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&amp;sektion=4"
>bridge(4)</a>.

<a name="antispoof"></a>
<h2>Blokování podvržených paketů</h2>
Podvržení adresy ("spoofing") je, když zlomyslný uživatel podvrhne zdrojovou
IP adresu v paketech, které přenáší buď kvůli tomu, aby skryl svou reálnou
adresu nebo aby se vydával za jiný systém na síti. Jakmile uživatel podvrhne
svou adresu, tak může začít síťový útok aniž by odhalil pravý zdroj útoku
nebo získat přístup k síťovým službám, které jsou jinak vyhrazené pro
určité IP adresy.

<p>
PF nabízí určitou ochranu proti podvrženým adresám pomocí klíčového slova
<tt>antispoof</tt> :

<blockquote>
<tt>
antispoof [log] [quick] for <i>interface</i> [<i>af</i>]
</tt>
</blockquote>

<dl>
<dt><tt>log</tt>
<dd>Určuje, že odpovídající pakety budou zaznamenány pomocí
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.7"
>pflogd(8)</a>.

<dt><tt>quick</tt>
<dd>Pokud paket odpovídá tomuto pravidlu, tak pravidlo bude považováno
 za "vítěze" a vyhodnocování pravidel se zde ukončí.

<dt><tt><i>interface</i></tt>
<dd>Síťové rozhraní na kterém se má tato ochrana aktivovat. Může to také
být <a href="macros.html#lists">seznam</a> rozhraní.

<dt><tt><i>af</i></tt>
<dd>Rodina adres pro kterou se má tato ochrana aktivovat. Buď
<tt>inet</tt> pro IPv4 nebo <tt>inet6</tt> pro IPv6.
</dl>

<p>
Příklad:
<blockquote>
<tt>
antispoof for fxp0 inet
</tt>
</blockquote>

<p>
Když se pravidla nahrávají, tak jakýkoliv výskyt klíčového slova
<tt>antispoof</tt> je rozšířen do dvou filtrovacích pravidel. Pokud má
například rozhraní <tt>fxp0</tt> IP adresu 10.0.0.1 a síťovou masku 
 255.255.255.0 (tzn., /24), tak <tt>antispoof</tt> pravidlo se rozšíří do:

<blockquote>
<tt>
block in on ! fxp0 inet from 10.0.0.0/24 to any<br>
block in inet from 10.0.0.1 to any
</tt>
</blockquote>

<p>
Tyto pravidla splňují dvě věci:
<ul>
<li>Blokují všechen provoz přicházející z 10.0.0.0/24 sítě, který 
<i>nepřišel</i> přes <tt>fxp0</tt>. Protože 10.0.0.0/24 síť je na
<tt>fxp0</tt> rozhraní, tak pakety se zdrojovou adresou v tomto síťovém
bloku se nikdy nemají objevit jako přicházející na jakémkoliv jiném rozhraní.
<li>Blokují všechen příchozí provoz z 10.0.0.1, což je IP adresa, která je 
na <tt>fxp0</tt>. Systém by nikdy neměl posílat pakety sám sobě přes externí
rozhraní. Takže jakékoliv pakety přícházející se zdrojovou adresou náležející
samotnému systému mohou být považovány za podezřelé.
</ul>

<p>
<b>POZNÁMKA</b>: Filtrovací pravidla, do kterých se <tt>antispoof</tt> 
pravidlo také rozšíři, blokují i pakety posílané přes lokální rozhraní
na lokální adresy. Je proto dobrou praxí vynechat filtrování na lokálních
rozhraních. Což je dobré i tak, ale stává se to nutností při použítí
antispoof pravidel:
<blockquote>
<tt>
set skip on lo0<br>
<br>
antispoof for fxp0 inet
</tt>
</blockquote>

<p>
Použití <tt>antispoof</tt> by mělo být omezeno na rozhraní, která mají
přiřazenu IP adresu. Použití <tt>antispoof</tt> na rozhraní bez IP adresy
skončí filtrovacím pravidlem, které vypadá nějak takto:
<blockquote>
<tt>
block drop in on ! fxp0 inet all<br>
block drop in inet all
</tt>
</blockquote>

<p>
S těmito pravidly je zde riziko, že bude blokován <i>všechen</i> příchozí
provoz na <i>všech</i> rozhraních.

<a name="urpf"></a>
<h2>Unicast Reverse Path Forwarding</h2>

<p>
PF nabízí vlastnost - Unicast Reverse Path Forwarding (uRPF).
Když paket prochází uRPF kontrolou, tak zdrojová IP adresa paketu projde
kontrolou v směrovací tabulce. Pokud odchozí rozhraní nalezené v záznamu
směrovací tabulky je stejné jako rozhraní přes které paket přišel, tak
uRPF kontrola proběhne v pořádku. Pokud ale rozhraní nejsou stejná, tak
je možné, že paket má svoji zdrojovou adresu podvrženu.

<p>
Kontrola uRPF může být na paketech vykonána pomocí klíčového slova
<tt>urpf-failed</tt> ve filtrovacích pravidlech:

<blockquote>
<tt>
block in quick from urpf-failed label uRPF
</tt>
</blockquote>

<p>
Uvědomte si, že uRPF kontrola má smysl pouze v prostředí, kde se používá
symetrické směrování.

<p>
uRPF poskytuje stejnou funkcionalitu jako
<a href="#antispoof">antispoof</a> pravidla.


<a name="osfp"></a>
<h2>Pasivní detekce operačních systémů</h2>

<p>
Pasivní detekce operačních systémů - Passive OS Fingerprinting (OSFP) 
je metoda pro pasivní detekci operačního systému vzdáleného systému 
(počítače, serveru,...), která je založena na určitých charakteristikách,
které tento systém promítne do TCP SYN paketů. Tato informace pak může být
použita jako kritérium ve filtrovacích pravidlech.

<p>
PF určuje vzdálený operační systém porovnáním charakteristik TCP SYN paketu
proti 
<a href="../options.html#fingerprints">souboru otisků</a>, kterým je
defaultně 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+4.7"
><tt>/etc/pf.os</tt></a>. 
Jakmile je PF povolen, tak aktuální seznam otisků může být zobrazen
pomocí tohoto příkazu:

<blockquote>
<tt>
# pfctl -s osfp
</tt>
</blockquote>

<p>
V rámci filtrovacího pravidla může být otisk specifikován pomocí třídy OS,
verze nebo subtypu/patch verze. Každá z těchto položek je vypsána ve výstupu
příkazu <tt>pfctl</tt> použitého výše. Ke specifikováni otisku ve filtrovacím
pravidle je třeba použít kličové slovo <tt>os</tt> :

<blockquote>
<tt>
pass &nbsp;in on $ext_if from any os OpenBSD keep state<br>
block in on $ext_if from any os "Windows 2000"<br>
block in on $ext_if from any os "Linux 2.4 ts"<br>
block in on $ext_if from any os unknown
</tt>
</blockquote>

<p>
Speciální třída operačního systému <tt>unknown</tt> umožňuje nastavit shodu
u paketů, kde otisk OS není znám.
<p>
<font color="#ff0000">NEZAPOMEŇTE</font> na následující:
<ul>
  <li>Otisky operačních systémů jsou občas špatně kvůli podvrženým a/nebo
  upraveným paketům, které jsou vytvořeny tak, aby vypadali jako kdyby
  pocházeli ze specifického operačního systému.
  <li>Některé revize aktualizací operačního systému mohou změnit chování
  síťové vrstvy a způsobit, že otisk neodpovídá tomu co je v souboru otisků
  nebo odpovídat jinému záznamu a to i oboje zároveň.
  <li>OSFP funguje pouze s TCP SYN paketem; nebude fungovat s jiným 
  protokolem nebo na již existujícím navázaném spojení.
</ul>

<a name="ipopts"></a>
<h2>Volby protokolu IP</h2>
Defaultně PF blokuje pakety s použitými volbami IP. Tohle může ztížit práci
pro "OS detekční" utility jako nmap. Pokud máte aplikaci, která vyžaduje
propuštění těchto paketů, jako například multicast nebo IGMP, tak můžete
použít <tt>allow-opts</tt> direktivu:
<blockquote>
<tt>
pass in quick on fxp0 all allow-opts
</tt>
</blockquote>

<a name="example"></a>
<h2>Příklad filtrovacích pravidel</h2>
Níže je příklad filtrovacích pravidel. Stroj na kterém běží PF vystupuje
jako firewall mezi malou interní sítí a Internetem. Ukázány jsou pouze
filtrovací pravidla; 
<a href="../queueing.html">queueing</a>, 
<a href="../nat.html"><tt>nat</tt></a>, 
<a href="../rdr.html"><tt>rdr</tt></a>, 
atp., byla v tomto příkladu vynechána.
<br>
<br>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
ext_if  = "fxp0"
int_if  = "dc0"
lan_net = "192.168.0.0/24"

# table containing all IP addresses assigned to the firewall
table &lt;firewall&gt; const { self }

# don't filter on the loopback interface
set skip on lo0

# scrub incoming packets
match in all scrub (no-df)

# setup a default deny policy
block all

# activate spoofing protection for all interfaces
block in quick from urpf-failed

# only allow ssh connections from the local network if it's from the
# trusted computer, 192.168.0.15. use "block return" so that a TCP RST is
# sent to close blocked connections right away. use "quick" so that this
# rule is not overridden by the "pass" rules below.
block return in quick on $int_if proto tcp from ! 192.168.0.15 \
   to $int_if port ssh

# pass all traffic to and from the local network.
# these rules will create state entries due to the default
# "keep state" option which will automatically be applied.
pass in  on $int_if from $lan_net
pass out on $int_if to $lan_net

# pass tcp, udp, and icmp out on the external (Internet) interface. 
# tcp connections will be modulated, udp/icmp will be tracked
# statefully.
pass out on $ext_if proto { tcp udp icmp } all modulate state

# allow ssh connections in on the external interface as long as they're
# NOT destined for the firewall (i.e., they're destined for a machine on
# the local network). log the initial packet so that we can later tell
# who is trying to connect. use the tcp syn proxy to proxy the connection.
# the default flags "S/SA" will automatically be applied to the rule by
# PF.
pass in log on $ext_if proto tcp to ! &lt;firewall&gt; \
   port ssh synproxy state
</pre>
</td></tr>
</table>

<p>
[<a href="tables.html">Předchozí: Tabulky</a>]
[<a href="index.html">Obsah</a>]
[<a href="../nat.html">Další: Network Address Translation</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: filter.html,v 1.54 ]<br>
$Translation: filter.html,v 1.5 2010/06/13 15:58:10 bodie Exp $<br>
-->
$OpenBSD: filter.html,v 1.5 2010/06/19 07:38:08 ajacoutot Exp $
</small>
</small>

</body>
</html> 
