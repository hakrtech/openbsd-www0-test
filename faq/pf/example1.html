<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Example #1: Firewall for Home or Small Office</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">

<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
<p>
[<a href="authpf.html">Previous: Authpf: User Shell for Authenticating
Gateways</a>]
[<a href="index.html">Contents</a>]

<p>
<h1><font color="#e00000">PF: Example #1: Firewall for Home or Small Office</font></h1>
<hr>

<h3>Table of Contents</h3>
<ul>
<li><a href="#scenario">The Scenario</a>
	<ul>
	<li><a href="#network">The Network</a>
	<li><a href="#objective">The Objective</a>
	<li><a href="#prep">Preparation</a>
	</ul>
<li><a href="#ruleset">The Ruleset</a>
	<ul>
	<li><a href="#macros">Macros</a>
	<li><a href="#options">Options</a>
	<li><a href="#scrub">Scrub</a>
	<li><a href="#nat">Network Address Translation</a>
	<li><a href="#rdr">Redirection</a>
	<li><a href="#filter">Filter Rules</a>
	</ul>
<li><a href="#allrules">The Complete Ruleset</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>The Scenario</h2>
In this example, PF is running on an OpenBSD machine acting as a
firewall and NAT gateway for a small network in a home or office. The
overall objective is to provide Internet access to the network and to
allow limited access to the firewall machine from the Internet. This
document will go through a complete ruleset that does just that.

<a name="network"></a>
<h3>The Network</h3>
The network is setup like this:

<pre>
    
  [ COMP1 ]    [ COMP3 ]
      |            |                               ADSL
   ---+------+-----+------- fxp0 [ OpenBSD ] ep0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
There are a number of computers on the internal network; the diagram
shows three but the actual number is irrelevant.  These computers are
regular workstations used for web surfing, email, chatting, etc. The
internal network is using the 192.168.0.0 / 255.255.255.0 network block.

<p>
The OpenBSD router is a Pentium 100 with two network cards: a 3com
3c509B (ep0) and an Intel EtherExpress Pro/100 (fxp0).  The router has
an ADSL connection to the Internet and is using NAT to share this
connection with the internal network. The IP address on the external
interface is dynamically assigned by the Internet Service Provider.

<a name="objective"></a>
<h3>The Objective</h3>
The objectives are:
<ul>
<li>Provide unrestricted Internet access to each internal computer.
<li>Use a "default deny" filter ruleset.
<li>Allow the following incoming traffic to the firewall from the
Internet:
	<ul>
	<li>SSH (TCP port 22): this will be used for external maintenance of
	the firewall machine.
	<li>Auth/Ident (TCP port 113): used by some services such as SMTP
	and IRC.
	<li>ICMP Echo Requests: the ICMP packet type used by
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>ping(8)</a>.
	</ul>
<li>Log filter statistics on the external interface.
<li>By default, reply with a TCP RST or ICMP Unreachable for blocked
packets.
<li>Make the ruleset as simple and easy to maintain as possible.
</ul>

<a name="prep"></a>
<h3>Preparation</h3>
This document assumes that the OpenBSD host has been properly configured
to act as a router, including verifying IP networking setup, Internet
connectivity, and setting <tt>net.inet.ip.forwarding</tt> to "<tt>1</tt>".

<a name="ruleset"></a>
<h2>The Ruleset</h2>
The following will step through a ruleset that will accomplish the above
goals.

<a name="macros"></a>
<h3>Macros</h3>
The following macros are defined to make maintenance and reading of
the ruleset easier:
<blockquote>
<tt>
int_if = "fxp0"<br>
ext_if = "ep0"<br>
<br>
tcp_services = "{ 22, 113 }"<br>
icmp_types = "echoreq"<br>
<br>
priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
</tt>
</blockquote>

<p>
The first two lines define the network interfaces that filtering will
happen on. The third and fourth lines list the TCP port numbers of the services
that will be opened up to the Internet (SSH and ident/auth) and the ICMP
packet types that will be permitted to reach the firewall machine. The last
line defines the loopback and
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a> address
blocks.

<p>
<b>Note</b>: If the ADSL Internet connection required
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>PPPoE</a>, then filtering and NAT would have to take place on the
<tt>tun0</tt> interface and <i>not</i> on <tt>ep0</tt>.

<a name="options"></a>
<h3>Options</h3>
The following two options will set the default response for
<tt>block</tt> filter rules and turn statistics logging "on" for the
external interface:
<blockquote>
<tt>
set block-policy return<br>
set loginterface $ext_if
</tt>
</blockquote>

<a name="scrub"></a>
<h3>Scrub</h3>
There is no reason not to use the recommended scrubbing of all incoming
traffic, so this is a simple one-liner:
<blockquote>
<tt>
scrub in all
</tt>
</blockquote>

<a name="nat"></a>
<h3>Network Address Translation</h3>
To perform NAT for the entire internal network the following
<tt>nat</tt> rule is used:
<blockquote>
<tt>
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
Since the IP address on the external interface is assigned dynamically,
parenthesis are placed around the translation interface so that PF
will notice when the address changes.

<a name="rdr"></a>
<h3>Redirection</h3>
The only redirection needed is for 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>ftp-proxy(8)</a> so that FTP clients on the local network can connect
to FTP servers on the Internet.
<blockquote>
<tt>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Note that this rule will only catch FTP connections to port 21. If users
regularly connect to FTP servers on other ports, then a list should be
used to specify the destination port, for example: <tt>from any to any
port { 21, 2121 }</tt>.

<a name="filter"></a>
<h3>Filter Rules</h3>
Now the filter rules. Start with the default deny:
<blockquote>
<tt>
block all<br>
</tt>
</blockquote>

<p>
At this point nothing will go through the firewall, not even from the
internal network. The following rules will open up the firewall as per
the objectives above as well as open up any necessary virtual
interfaces.

<p>
Every Unix system has a "loopback" interface. It's a virtual network interface that
is used by applications to talk to each other inside the system. In general,
all traffic should be passed on the loopback interface. On OpenBSD, the
loopback interface is 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>lo(4)</a>.
<blockquote>
<tt>
pass quick on lo0 all
</tt>
</blockquote>

<p>
Next, the
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>
addresses will be blocked from entering or exiting the external
interface. These addresses should never appear on the public Internet,
and filtering them will ensure that the router does not "leak" these
addresses out from the internal network and also block any incoming
packets with a source address in one of those networks.
<blockquote>
<tt>
block drop in &nbsp;quick on $ext_if from $priv_nets to any<br>
block drop out quick on $ext_if from any to $priv_nets
</tt>
</blockquote>

<p>
Note that <tt>block drop</tt> is used to tell PF not to respond with a
TCP RST or ICMP Unreachable packet. Since the RFC 1918 addresses don't
exist on the Internet, any packets sent to those addresses will never
make it there anyways. The <tt>quick</tt> option is used to tell PF not
to bother evaluating the rest of the filter rules if one of the above
rules matches; packets to or from the <tt>$priv_nets</tt> networks will
be immediately dropped.

<p>
Now open the ports used by those network services that will be available
to the Internet:
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>

<p>
Specifying the network ports in the macro <tt>$tcp_services</tt> makes
it simple to open additional services to the Internet by simply editing
the macro and reloading the ruleset. UDP services can also be opened up
by creating a <tt>$udp_services</tt> macro and adding a filter rule,
similar to the one above, that specifies <tt>proto udp</tt>.

<p>
ICMP traffic must now be passed:
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>

<p>
Similar to the <tt>$tcp_services</tt> macro, the <tt>$icmp_types</tt>
macro can easily be edited to change the types of ICMP packets that will
be allowed to reach the firewall. Note that this rule applies to all
network interfaces.

<p>
Now traffic must be passed to and from the internal network.
We'll assume that the users on the internal network know what
they are doing and aren't going to be causing trouble.  This is not
necessarily a valid assumption; a much more restrictive ruleset would
be appropriate for some environments.
<blockquote>
<tt>
pass in on $int_if from $int_if:network to any keep state
</tt>
</blockquote>

<p>
The above rule will permit any internal machine to send packets through
the firewall; however, it will <i>not</i> permit the firewall to
initiate a connection to an internal machine. Is this a good idea? That
depends on some of the finer details of the network setup. If the
firewall is also a DHCP server, it may need to "ping" an address to
verify its availability before assigning it. Permitting the firewall to
connect to the internal network also allows someone who has ssh'ed into
the firewall from the Internet to then access machines on the network.
Keep in mind that <i>not</i> allowing the firewall to communicate
directly to the network is not a large security benefit; if someone gets
access to the firewall they can probably alter the filter rules anyways.
By adding the following rule, the firewall will be able to initiate
connections to the internal network:
<blockquote>
<tt>
pass out on $int_if from any to $int_if:network keep state
</tt>
</blockquote>

<p>
Note that if both of these lines are in place, the <tt>keep state</tt>
option is not needed; all packets will be able to pass through the
internal interface because there is a rule to pass packets in both
directions.  However, if the <tt>pass out</tt> line is <i>not</i>
included, the <tt>pass in</tt> line <i>must</i> include <tt>keep
state</tt>.  There is also some performance benefit to keeping state:
State tables are checked before rules are evaluated, and if a state
match is found, the packet is passed through the firewall without going
through ruleset evaluation. This can offer a performance benefit on a
heavily loaded firewall, though in a system this simple it is unlikely
to generate enough load to matter.

<p>
Finally, pass traffic out on the external interface:
<blockquote>
<tt>
pass out on $ext_if proto tcp all modulate state flags S/SA<br>
pass out on $ext_if proto { udp, icmp } all keep state
</tt>
</blockquote>

<p>
TCP, UDP, and ICMP traffic is permitted to exit the firewall towards the
Internet. State information is kept so that the returning packets will
be passed in through the firewall.

<a name="allrules"></a>
<h2>The Complete Ruleset</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros
int_if = "fxp0"
ext_if = "ep0"

tcp_services = "{ 22, 113 }"
icmp_types = "echoreq"

priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
	  
# options
set block-policy return
set loginterface $ext_if

# scrub
scrub in all

# nat/rdr
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \
   port 8021

# filter rules
block all

pass quick on lo0 all

block drop in  quick on $ext_if from $priv_nets to any
block drop out quick on $ext_if from any to $priv_nets

pass in on $ext_if inet proto tcp from any to ($ext_if) \
   port $tcp_services flags S/SA keep state

pass in inet proto icmp all icmp-type $icmp_types keep state

pass in  on $int_if from $int_if:network to any keep state
pass out on $int_if from any to $int_if:network keep state

pass out on $ext_if proto tcp all modulate state flags S/SA
pass out on $ext_if proto { udp, icmp } all keep state
</pre>
</td></tr>
</table>

<p>
[<a href="authpf.html">Previous: Authpf: User Shell for Authenticating
Gateways</a>]
[<a href="index.html">Contents</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>$OpenBSD: example1.html,v 1.8 2003/09/16 01:23:49 nick Exp $</small>

</body>
</html> 
