<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Journal des Ev&eacute;nements</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003-2004 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="tagging.html">Pr&eacute;c&eacute;dent : Balisage de
Paquets</a>]
[<a href="index.html">Index</a>]
[<a href="perf.html">Suivant : Performances</a>]

<p>
<h1><font color="#e00000">PF: Journal des Ev&eacute;nements</font></h1>

<hr>

<h3>Table des Mati&egrave;res</h3>
<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#logfile">Lire un Fichier d'Ev&eacute;nements</a>
<li><a href="#filter">Filtrer les Ev&eacute;nements en Sortie</a>
<li><a href="#syslog">Enregistrement des Ev&eacute;nements &agrave;
    Travers Syslog</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introduction</h2>
L'enregistrement des Ev&eacute;nements dans PF est effectu&eacute; par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.4">pflogd(8)</a>
qui &eacute;coute sur l'interface
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4&amp;manpath=OpenBSD+3.4">pflog0</a>
et &eacute;crit les paquets dans un fichier d'&eacute;v&eacute;nements
(normalement /var/log/pflog) au format binaire
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.4">tcpdump(8)</a>.
Les flux correspondant aux r&egrave;gles de <a
href="../filter.html">filtrage</a> qui contiennent les mots-cl&eacute;s
<tt>log</tt> ou <tt>log-all</tt> sont enregistr&eacute;s de cette
mani&egrave;re.

<a name="logfile"></a>
<h2>Lire un Fichier d'Ev&eacute;nements</h2>
Le fichier d'&eacute;v&eacute;nements &eacute;crit par pflogd est dans
un format binaire que seul tcpdump(8) ou tout outil connaissant le
format binaire tcpdump peut lire.

<p>
Pour lire le fichier d'&eacute;v&eacute;nements :
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Il est &agrave; noter que l'utilisation de tcpdump(8) pour lire le
fichier pflog ne donne <i>pas</i> un affichage en temps r&eacute;el.
Cependant, il est possible d'obtenir un tel affichage en utilisant
l'interface pflog0 :
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">REMARQUE : </font>
Lorsque vous examinez les &eacute;v&eacute;nements, une attention
particuli&egrave;re doit &ecirc;tre prise par rapport au d&eacute;codage
verbeux des protocoles effectu&eacute; par tcpdump (d&eacute;codage
activ&eacute; par l'option <tt>-v</tt>). Les d&eacute;codeurs
protocolaires de tcpdump ne poss&egrave;dent pas un historique
s&eacute;curit&eacute; parfait. En th&eacute;orie du moins, une attaque
retard&eacute;e peut &ecirc;tre possible &agrave; travers les charges
utiles partielles enregistr&eacute;es par le p&eacute;riph&eacute;rique
d'enregistrement d'&eacute;v&eacute;nements. Il est recommand&eacute; de
d&eacute;placer les fichiers d'&eacute;v&eacute;nements du pare-feu
avant de proc&eacute;der &agrave; leur examen de cette mani&egrave;re.

<p>
Des pr&eacute;cautions suppl&eacute;mentaires doivent &ecirc;tres prises
pour s&eacute;curiser l'acc&egrave;s aux &eacute;v&eacute;nements. Par
d&eacute;faut, pflogd enregistrera 96 octets du paquet dans le fichier
d'&eacute;v&eacute;nements. L'acc&egrave;s aux fichiers
d'&eacute;v&eacute;nements pourrait fournir un acc&egrave;s partiel
&agrave; des charges utiles de paquets sensibles (tels que les noms
d'utilisateurs et les mots de passe
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1&amp;manpath=OpenBSD+3.4">telnet(1)</a> ou
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.4">ftp(1)</a>).

<a name="filter"></a>
<h2>Filtrer les Ev&eacute;nements en Sortie</h2>
Etant donn&eacute; que pflogd enregistre les &eacute;v&eacute;nements au
format binaire tcpdump, la totalit&eacute; des fonctionnalit&eacute;s
tcpdump peut &ecirc;tre utilis&eacute;e pour analyser les
&eacute;v&eacute;nements. Par exemple, pour voir uniquement les paquets
qui correspondent &agrave; un certain port :
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Ceci peut &ecirc;tre encore affin&eacute; en limitant l'affichage des
paquets &agrave; une certaine combinaison de h&ocirc;te et de port :
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
La m&ecirc;me id&eacute;e peut &ecirc;tre appliqu&eacute;e quand on lit
les &eacute;v&eacute;n&eacute;ments directement &agrave; partir de
l'interface pflog0 :
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Il est &agrave; noter que ces manipulations n'ont aucun impact sur les
paquets enregistr&eacute;s dans le fichier d'&eacute;v&eacute;nements
pflogd; les commandes ci-dessus ne feront qu'afficher les paquets au fur
et &agrave; mesure qu'ils sont enregistr&eacute;s.

<p>
En plus de l'utilisation des r&egrave;gles de filtrage standard
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.4">tcpdump(8)</a>,
le langage de filtrage du tcpdump fourni avec OpenBSD a
&eacute;t&eacute; &eacute;tendu pour lire la sortie de pflogd :
<ul>
<li><tt>ip</tt> - la famille d'adresses est IPv4.
<li><tt>ip6</tt> - la famille d'adresses est IPv6.
<li><tt>on <i>int</i></tt> - le paquet est pass&eacute; &agrave; travers
    l'interface
<i>int</i>.
<li><tt>ifname <i>int</i></tt> - idem.
<li><tt>rulenum <i>num</i></tt> - la r&egrave;gle de filtrage &agrave;
    laquelle correspondait le paquet &eacute;tait la r&egrave;gle
    num&eacute;ro <i>num</i>.
<li><tt>action <i>act</i></tt> - l'action prise pour le paquet. Les
    actions possibles sont <tt>pass</tt> et <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - la raison pour laquelle
    l'<tt>action</tt> a &eacute;t&eacute; prise. Les raisons possibles
    sont <tt>match</tt>, <tt>bad-offset</tt>, <tt>fragment</tt>,
    <tt>short</tt>, <tt>normalize</tt>, et <tt>memory</tt>.
<li><tt>inbound</tt> - le paquet &eacute;tait entrant.
<li><tt>outbound</tt> - le paquet &eacute;tait sortant.
</ul>

<p>
Exemple :
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Cette commande affichera l'&eacute;v&eacute;nement en temps r&eacute;el
cr&eacute;e par des paquets entrants bloqu&eacute;s sur l'interface wi0.

<a name="syslog"></a>
<h2>Enregistrement des Ev&eacute;nements &agrave; Travers Syslog</h2>
Dans plusieurs situations, il est souhaitable de disposer des
&eacute;v&eacute;nements enregistr&eacute;s par le pare-feu sous format
ASCII ou de les envoyer &agrave; un serveur d'&eacute;v&eacute;nements
central distant. Tout ceci peut &ecirc;tre effectu&eacute; par deux
petits scripts shell, quelques modifications mineures aux fichiers de
configuration OpenBSD, et

<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.4">syslogd(8)</a>, 
le service qui permet d'enregistrer les &eacute;v&eacute;nements.
Syslogd enregistre les &eacute;v&eacute;nements sous format ASCII et il
est aussi capable de les envoyer &agrave; un serveur
d'&eacute;v&eacute;nements distant.

<p>
Il faut d'abord cr&eacute;er un utilisateur, <tt>pflogger</tt>, avec un
shell <tt>/sbin/nologin</tt>. La fa&ccedil;on la plus simple de
cr&eacute;er cet utilisateur consiste &agrave; utiliser la commande
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8&amp;manpath=OpenBSD+3.4">adduser(8)</a>.

<p>
Apr&egrave;s avoir cr&eacute;e l'utilisateur <tt>pflogger</tt>,
cr&eacute;ez les deux scripts suivants :

<p>
<tt>/etc/pflogrotate</tt>
<pre>
        FILE=/home/pflogger/pflog5min.$(date "+%Y%m%d%H%M")
        kill -ALRM $(cat /var/run/pflogd.pid)
        if [ $(ls -l /var/log/pflog | cut -d " " -f 8) -gt 24 ]; then
           mv /var/log/pflog $FILE
           chown pflogger $FILE
           kill -HUP $(cat /var/run/pflogd.pid)
        fi
</pre>

<p>
<tt>/home/pflogger/pfl2sysl</tt>
<pre>
        for logfile in /home/pflogger/pflog5min* ; do
           tcpdump -n -e -ttt -r $logfile | logger -t pf -p local0.info
           rm $logfile
        done
</pre>

<p>
Editez la liste des t&acirc;ches cron du super-utilisateur root :
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Ajoutez-y les deux lignes suivantes :
<blockquote>
<tt>
# effectuer une rotation du fichier d'&eacute;v&eacute;nements<br>
# toutes les 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Cr&eacute;er une liste de t&acirc;ches cron pour l'utilisateur
<tt>pflogger</tt> :
<blockquote>
<tt>
# crontab -u pflogger -e
</tt>
</blockquote>

<p>
Ajoutez-y les deux lignes suivantes :
<blockquote>
<tt>
# alimenter le(s) fichier(s) pflog apr&egrave;s rotation &agrave;<br>
# syslog<br>

0-59/5 *       *       *       *       /bin/sh /home/pflogger/pfl2sysl
</tt>
</blockquote>

<p>
Ajoutez la ligne suivante au fichier <tt>/etc/syslog.conf</tt> :
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Si vous voulez les envoyer aussi &agrave; un serveur
d'&eacute;v&eacute;nements distant, ajoutez la ligne suivante
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Assurez vous que le h&ocirc;te <i>syslogger</i> a bien &eacute;t&eacute;
d&eacute;fini dans le fichier
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5&amp;manpath=OpenBSD+3.4">hosts(5)</a>.

<p>
Cr&eacute;ez le fichier <tt>/var/log/pflog.txt</tt> afin de permettre
&agrave; syslog d'enregistrer les &eacute;v&eacute;nements dans ce
fichier.
<blockquote>
<tt>
# touch /var/log/pflog.txt
</tt>
</blockquote>

<p>
Relancez syslogd pour que les modifications soient prises en compte :
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Tous les &eacute;v&eacute;nements enregistr&eacute;s sont maintenant
envoy&eacute;s vers <tt>/var/log/pflog.txt</tt>. Si la seconde ligne a
&eacute;t&eacute; ajout&eacute;e, les &eacute;v&eacute;nements sont
aussi envoy&eacute;s au serveur d'&eacute;v&eacute;nements distant
<i>syslogger</i>.

<p>
Le script <tt>/etc/pflogrotate</tt> traite d&eacute;sormais
<tt>/var/log/pflog</tt> et le supprime &agrave; la fin du traitement. La
rotation de ce fichier par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8&amp;manpath=OpenBSD+3.4">newsyslog(8)</a> 
n'est plus n&eacute;cessaire d&eacute;sormais et devrait &ecirc;tre
d&eacute;sactiv&eacute;e. Cependant <tt>/var/log/pflog.txt</tt> remplace
<tt>/var/log/pflog</tt> et sa rotation devrait &ecirc;tre
activ&eacute;e. Modifiez <tt>/etc/newsyslog.conf</tt> comme suit :
<pre>
    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
PF, &agrave; l'aide du m&eacute;canisme pr&eacute;cit&eacute;,
g&eacute;n&eacute;rera des &eacute;v&eacute;nements qui seront
enregistr&eacute;s dans le fichier <tt>/var/log/pflog.txt</tt>. Ces
&eacute;v&eacute;nements pourront aussi &ecirc;tre envoy&eacute;s
&agrave; un serveur d'&eacute;v&eacute;nements distant. La conversion en
ASCII n'est pas imm&eacute;diate. Elle prend jusqu'&agrave; 5-6 minutes
(l'intervalle d'ex&eacute;cution de la t&acirc;che cron) avant que les
&eacute;v&eacute;nements enregistr&eacute;s apparaissent dans le
fichier.

<p>
[<a href="tagging.html">Pr&eacute;c&eacute;dent : Balisage de
Paquets</a>]
[<a href="index.html">Index</a>]
[<a href="perf.html">Suivant : Performances</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: logging.html,v 1.13 ]<br>
$Translation: logging.html,v 1.3 2004/02/19 20:31:29 saad Exp $<br>
$OpenBSD: logging.html,v 1.3 2004/02/20 06:33:11 jufi Exp $
</small>

</body>
</html> 
