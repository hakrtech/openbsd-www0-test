<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Journal des Evénements</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="tagging.html">Précédent : Balisage de
Paquets</a>]
[<a href="index.html">Index</a>]
[<a href="perf.html">Suivant : Performances</a>]

<p>
<h1><font color="#e00000">PF: Journal des Evénements</font></h1>

<hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#logfile">Lire un Fichier d'Evénements</a>
<li><a href="#filter">Filtrer les Evénements en Sortie</a>
<li><a href="#syslog">Enregistrement des Evénements à
    Travers Syslog</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introduction</h2>
L'enregistrement des Evénements dans PF est effectué par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.5">pflogd(8)</a>
qui écoute sur l'interface
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4&amp;manpath=OpenBSD+3.5">pflog0</a>
et écrit les paquets dans un fichier d'événements
(normalement /var/log/pflog) au format binaire
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.5">tcpdump(8)</a>.
Les flux correspondant aux règles de <a
href="filter.html">filtrage</a> qui contiennent les mots-clés
<tt>log</tt> ou <tt>log-all</tt> sont enregistrés de cette
manière.

<a name="logfile"></a>
<h2>Lire un Fichier d'Evénements</h2>
Le fichier d'événements écrit par pflogd est dans
un format binaire que seul tcpdump(8) ou tout outil connaissant le
format binaire tcpdump peut lire.

<p>
Pour lire le fichier d'événements :
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Il est à noter que l'utilisation de tcpdump(8) pour lire le
fichier pflog ne donne <i>pas</i> un affichage en temps réel.
Cependant, il est possible d'obtenir un tel affichage en utilisant
l'interface <tt>pflog0</tt> :
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">REMARQUE : </font>
Lorsque vous examinez les événements, une attention
particulière doit être prise par rapport au décodage
verbeux des protocoles effectué par tcpdump (décodage
activé par l'option <tt>-v</tt>). Les décodeurs
protocolaires de tcpdump ne possèdent pas un historique
sécurité parfait. En théorie du moins, une attaque
retardée peut être possible à travers les charges
utiles partielles enregistrées par le périphérique
d'enregistrement d'événements. Il est recommandé de
déplacer les fichiers d'événements du pare-feu
avant de procéder à leur examen de cette manière.

<p>
Des précautions supplémentaires doivent êtres prises
pour sécuriser l'accès aux événements. Par
défaut, pflogd enregistrera 96 octets du paquet dans le fichier
d'événements. L'accès aux fichiers
d'événements pourrait fournir un accès partiel
à des charges utiles de paquets sensibles (tels que les noms
d'utilisateurs et les mots de passe
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1&amp;manpath=OpenBSD+3.5">telnet(1)</a> ou
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.5">ftp(1)</a>).

<a name="filter"></a>
<h2>Filtrer les Evénements en Sortie</h2>
Etant donné que pflogd enregistre les événements au
format binaire tcpdump, la totalité des fonctionnalités
tcpdump peut être utilisée pour analyser les
événements. Par exemple, pour voir uniquement les paquets
qui correspondent à un certain port :
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Ceci peut être encore affiné en limitant l'affichage des
paquets à une certaine combinaison de hôte et de port :
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
La même idée peut être appliquée quand on lit
les événéments directement à partir de
l'interface <tt>pflog0</tt> :
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Il est à noter que ces manipulations n'ont aucun impact sur les
paquets enregistrés dans le fichier d'événements
pflogd; les commandes ci-dessus ne feront qu'afficher les paquets au fur
et à mesure qu'ils sont enregistrés.

<p>
En plus de l'utilisation des règles de filtrage standard
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.5">tcpdump(8)</a>,
le langage de filtrage du tcpdump fourni avec OpenBSD a
été étendu pour lire la sortie de pflogd :
<ul>
<li><tt>ip</tt> - la famille d'adresses est IPv4.
<li><tt>ip6</tt> - la famille d'adresses est IPv6.
<li><tt>on <i>int</i></tt> - le paquet est passé à travers
    l'interface
<i>int</i>.
<li><tt>ifname <i>int</i></tt> - idem.
<li><tt>rulenum <i>num</i></tt> - la règle de filtrage à
    laquelle correspondait le paquet était la règle
    numéro <i>num</i>.
<li><tt>action <i>act</i></tt> - l'action prise pour le paquet. Les
    actions possibles sont <tt>pass</tt> et <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - la raison pour laquelle
    l'<tt>action</tt> a été prise. Les raisons possibles
    sont <tt>match</tt>, <tt>bad-offset</tt>, <tt>fragment</tt>,
    <tt>short</tt>, <tt>normalize</tt>, et <tt>memory</tt>.
<li><tt>inbound</tt> - le paquet était entrant.
<li><tt>outbound</tt> - le paquet était sortant.
</ul>

<p>
Exemple :
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Cette commande affichera l'événement en temps réel
crée par des paquets entrants bloqués sur l'interface wi0.

<a name="syslog"></a>
<h2>Enregistrement des Evénements à Travers Syslog</h2>
Dans plusieurs situations, il est souhaitable de disposer des
événements enregistrés par le pare-feu sous format
ASCII ou de les envoyer à un serveur d'événements
central distant. Tout ceci peut être effectué par deux
petits scripts shell, quelques modifications mineures aux fichiers de
configuration OpenBSD, et

<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.5">syslogd(8)</a>, 
le service qui permet d'enregistrer les événements.
Syslogd enregistre les événements sous format ASCII et il
est aussi capable de les envoyer à un serveur
d'événements distant.

<p>
Il faut d'abord créer un utilisateur, <tt>pflogger</tt>, avec un
shell <tt>/sbin/nologin</tt>. La façon la plus simple de
créer cet utilisateur consiste à utiliser la commande
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8&amp;manpath=OpenBSD+3.5">adduser(8)</a>.

<p>
Après avoir crée l'utilisateur <tt>pflogger</tt>,
créez les deux scripts suivants :

<p>
<tt>/etc/pflogrotate</tt>
<pre>
        FILE=/home/pflogger/pflog5min.$(date "+%Y%m%d%H%M")
        kill -ALRM $(cat /var/run/pflogd.pid)
        if [ $(ls -l /var/log/pflog | cut -d " " -f 8) -gt 24 ]; then
           mv /var/log/pflog $FILE
           chown pflogger $FILE
           kill -HUP $(cat /var/run/pflogd.pid)
        fi
</pre>

<p>
<tt>/home/pflogger/pfl2sysl</tt>
<pre>
        for logfile in /home/pflogger/pflog5min* ; do
           tcpdump -n -e -ttt -r $logfile | logger -t pf -p local0.info
           rm $logfile
        done
</pre>

<p>
Editez la liste des tâches cron du super-utilisateur root :
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Ajoutez-y les deux lignes suivantes :
<blockquote>
<tt>
# effectuer une rotation du fichier d'événements<br>
# toutes les 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Créer une liste de tâches cron pour l'utilisateur
<tt>pflogger</tt> :
<blockquote>
<tt>
# crontab -u pflogger -e
</tt>
</blockquote>

<p>
Ajoutez-y les deux lignes suivantes :
<blockquote>
<tt>
# alimenter le(s) fichier(s) pflog après rotation à<br>
# syslog<br>

0-59/5 *       *       *       *       /bin/sh /home/pflogger/pfl2sysl
</tt>
</blockquote>

<p>
Ajoutez la ligne suivante au fichier <tt>/etc/syslog.conf</tt> :
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Si vous voulez les envoyer aussi à un serveur
d'événements distant, ajoutez la ligne suivante
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Assurez vous que le hôte <i>syslogger</i> a bien été
défini dans le fichier
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5&amp;manpath=OpenBSD+3.5">hosts(5)</a>.

<p>
Créez le fichier <tt>/var/log/pflog.txt</tt> afin de permettre
à syslog d'enregistrer les événements dans ce
fichier.
<blockquote>
<tt>
# touch /var/log/pflog.txt
</tt>
</blockquote>

<p>
Relancez syslogd pour que les modifications soient prises en compte :
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Tous les événements enregistrés sont maintenant
envoyés vers <tt>/var/log/pflog.txt</tt>. Si la seconde ligne a
été ajoutée, les événements sont
aussi envoyés au serveur d'événements distant
<i>syslogger</i>.

<p>
Le script <tt>/etc/pflogrotate</tt> traite désormais
<tt>/var/log/pflog</tt> et le supprime à la fin du traitement. La
rotation de ce fichier par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8&amp;manpath=OpenBSD+3.5">newsyslog(8)</a> 
n'est plus nécessaire désormais et devrait être
désactivée. Cependant <tt>/var/log/pflog.txt</tt> remplace
<tt>/var/log/pflog</tt> et sa rotation devrait être
activée. Modifiez <tt>/etc/newsyslog.conf</tt> comme suit :
<pre>
    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
PF, à l'aide du mécanisme précité,
générera des événements qui seront
enregistrés dans le fichier <tt>/var/log/pflog.txt</tt>. Ces
événements pourront aussi être envoyés
à un serveur d'événements distant. La conversion en
ASCII n'est pas immédiate. Elle prend jusqu'à 5-6 minutes
(l'intervalle d'exécution de la tâche cron) avant que les
événements enregistrés apparaissent dans le
fichier.

<p>
[<a href="tagging.html">Précédent : Balisage de
Paquets</a>]
[<a href="index.html">Index</a>]
[<a href="perf.html">Suivant : Performances</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: logging.html,v 1.15 ]<br>
$Translation: logging.html,v 1.7 2004/10/11 12:24:36 saad Exp $<br>
$OpenBSD: logging.html,v 1.7 2004/10/11 16:17:48 jufi Exp $
</small>

</body>
</html> 
