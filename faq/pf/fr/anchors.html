<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Ancres et Bases de Règles
            Nommées (Sub)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="scrub.html">Précédent : Scrub (Normalisation de
Paquets)</a>]
[<a href="index.html">Index</a>]
[<a href="queueing.html">Suivant : Gestion de La Bande Passante</a>]

<p>
<h1><font color="#e00000">PF : Ancres et Bases de Règles
    Nommées (Sub)</font></h1>

<hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#named">Bases de Règles Nommées</a>
<li><a href="#options">Options d'Ancrage</a>
<li><a href="#manip">Manipulation des Ancres</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introduction</h2>
En plus de la base de règles principale, PF peut aussi évaluer des bases
de règles secondaires. Vu que les bases de règles secondaires ("sub
rulesets" en anglais) peuvent être manipulées à la volée en utilisant
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6">pfctl(8)</a>, 
elles fournissent une bonne façon pour modifier dynamiquement l'ensemble
des règles actives. Alors qu'une
<a href="tables.html">table</a> est utilisée pour contenir une liste
dynamique d'adresses, une base de règle secondaire est utilisée pour
contenir un ensemble dynamique de règles de filtrage, <tt>nat</tt>,
<tt>rdr</tt>, et <tt>binat</tt>.

<p>
Les bases de règles secondaires sont attachées à la base de règles
principale à l'aide d'ancres. Il existe quatre types de règles
<tt>anchor</tt> (ancre en anglais) :
<ul>
<li><tt>anchor <i>nom</i></tt> - évalue toutes les règles
    de <a href="filter.html">filtrage</a> de l'ancre
    <i><tt>nom</tt></i>
<li><tt>binat-anchor <i>nom</i></tt> - évalue toutes les règles de
    traduction <a href="nat.html#binat"><tt>binat</tt></a> de l'ancre
    <i><tt>nom</tt></i>
<li><tt>nat-anchor <i>nom</i></tt> - évalue toutes les règles de
    traduction <a href="nat.html"> <tt>nat</tt></a> de l'ancre
    <i><tt>nom</tt></i>
<li><tt>rdr-anchor <i>nom</i></tt> - évalue toutes les règles
    <a href="rdr.html"><tt>rdr</tt></a> de l'ancre
    <i><tt>nom</tt></i>
</ul>

Les règles <tt>anchor</tt> seront évaluées relativement à l'ancre dans
laquelle elles sont chargées. Par exemple, les règles <tt>anchor</tt>
dans la base de règles principale crééront des points d'ancrage
définissant la base de règles principale comme parent, et les règles
<tt>anchor</tt> chargées à partir de fichiers à l'aide de la directive
<tt>load anchor</tt> crééront des points d'ancrage définissant cette
ancre comme parent.

<a name="named"></a>
<h2>Ancres</h2>
Une ancre est une collection de règles de filtrage et/ou de traduction,
des tables, et d'autres ancres auxquelles un nom a été affecté.
Lorsque PF lit une règle <tt>anchor</tt> dans le jeu de règles
principal, il va évaluer les règles contenues dans ce point
<tt>anchor</tt> de la même manière qu'il évalue des règles dans la base
de règles principale.
Le traitement de la base de règles principale se poursuivra ensuite à
moins que le paquet en cours de traitement ne corresponde à une règle de
filtrage qui utilise le mot- clé <tt>quick</tt> ou à une règle de
traduction dans l'ancre, dans ce cas la correspondance est déclarée
comme finale et l'évaluation sera arrêtée aussi bien dans les bases de
règles rattachées à l'ancre que dans la base de règles principale.

<p>
Par exemple :
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor goodguys
</tt>
</blockquote>

<p>
Cette base de règles implémente une politique dite restrictive (tout ce
qui n'est pas connu est interdit par défaut) sur l'interface
<tt>fxp0</tt> aussi bien pour le trafic entrant que le trafic sortant.
Le trafic sortant est ensuite autorisé et un état est gardé. Ensuite une
règle d'ancrage est créée avec le nom <tt>goodguys</tt>. Les ancres
peuvent être peuplées avec des règles de deux façons différentes :
<ul>
<li>en utilisant une règle de chargement <tt>load</tt>
<li>en utilisant 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6">pfctl(8)</a>
</ul>

<p>
Une règle de chargement <tt>load</tt> est utilisée pour ordonner à
<tt>pfctl</tt> de peupler l'ancre spécifiée et la base de règles nommées
à partir d'un fichier texte. Par exemple :
<blockquote>
<tt>
load anchor goodguys:ssh from "/etc/anchor-goodguys-ssh"
</tt>
</blockquote>

<p>
Lorsque la base de règles principale est chargée, les règles figurant
dans le le fichier <tt>/etc/anchor-goodguys- ssh</tt> seront chargées
dans la base de règles nommée <tt>ssh</tt> attachée à l'ancre
<tt>goodguys</tt>.

<p>
Pour ajouter des règles à une ancre à l'aide de <tt>pfctl</tt>, le type
de commandes suivant devra être employé :
<blockquote>
<tt>
# echo "pass in proto tcp from 192.0.2.3 to any port 22" \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys/ssh -f -
</tt>
</blockquote>

<p>
Ceci ajoute une règle <tt>pass</tt> à l'ancre <tt>ssh</tt> attachée à
l'ancre <tt>goodguys</tt>. PF évaluera ensuite cette règle (ainsi que
les autres règles de filtrage ajoutées par la suite) lorsqu'il atteint
la ligne <tt>anchor goodguys</tt> dans la base de règles principale.

<p>
Les règles peuvent aussi être sauvegardées et chargées à partir d'un
fichier texte :
<blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys:www -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
Ceci charge les règles à partir du fichier <tt>/etc/anchor-goodguys-
www</tt> dans la base de règles nommée <tt>www</tt> attachée à l'ancre
<tt>goodguys</tt>.

<p>
Des règles de filtrage et de traduction peuvent être chargées dans une
base de règles nommée en utilisant les mêmes syntaxe et options
utilisées par les règles définies dans la base de règles principale. Une
exception est à signaler cépendant dans le cas des
<a href="macros.html">macros</a>. Les macros utilisées dans une base de
règles nommée doivent aussi être définies dans la base de règles nommée
qui les utilisent; les macros définies dans la base de règles principale
ne sont <i>pas</i> visibles par les bases de règles nommées.

<p>
Chaque base de règles nommée, ainsi que la base de règles principale,
existe séparemment des autres bases de règles. Les opérations effectuées
sur une base de règles, telles que la suppression des règles, n'a aucun
effet sur les autres bases. De plus, la suppression d'un point d'ancrage
dans la base de règles principale ne détruit pas l'ancre ni les bases de
règles nommées attachées à cet ancre. Une base de règles nommée n'est
détruire que lorsque toutes les règles qu'elle contient sont supprimées
à l'aide de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6">pfctl(8)</a>.
Une fois un point d'ancrage se retrouve sans aucune base de règles
nommée attachée, il est aussi détruit.

<a name="options"></a>
<h2>Options d'Ancrage</h2>
Optionnellement, les règles d'ancrage <tt>anchor</tt> peuvent spécifier
une interface, un protocole, un port source, un port destination, une
balise ... en utilisant la même syntaxe que celle employée dans les
règles de filtrage. Lorsque de telles informations sont fournies, les
règles d'ancrage sont uniquement évaluées lorsque le paquet en cours de
traitement correspond à la définition de la règle d'ancrage. Par exemple
:
<blockquote>
<tt>
ext_if = "fxp0"<br> <br> block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor ssh in on $ext_if proto tcp from any to any port 22<br>
</tt>
</blockquote>

<p>
Les règles de l'ancre <tt>ssh</tt> sont uniquement évaluées pour les
paquets TCP destinés au port 22 en entrée de <tt>fxp0</tt>. Ces règles
sont alors ajoutées à l'ancre de la façon suivante :
<blockquote>
<tt>
# echo "pass in from 192.0.2.10 to any" | pfctl -a ssh/allowed -f -
</tt>
</blockquote>

<p>
Ainsi, même si la règle de filtrage ne spécifie ni l'interface, ni le
protocole ni d'autres paramètres tels que le port, le hôte 192.0.2.10
sera uniquement autorisé à faire des connexions SSH vu la définition de
la règle d'ancrage.

<a name="manip"></a>
<h2>Manipulation des Ancres</h2>
La manipulation des ancres se fait à l'aide de <tt>pfctl</tt>. Cette
commande peut être utilisée pour ajouter ou supprimer des règles d'une
ancre sans nécessiter le rechargement de la base de règles principale.

<p>
Pour lister toutes les règles de l'ancre <tt>allowed</tt>, attachée à
l'ancre <tt>ssh</tt> :
<blockquote>
<tt>
# pfctl -a ssh/allowed -s rules
</tt>
</blockquote>

<p>
Pour supprimer toutes les règles de filtrage de la même ancre :
<blockquote>
<tt>
# pfctl -a ssh/allowed -F rules
</tt>
</blockquote>

<p>
Pour une liste complète des commandes, veuillez consulter
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6">pfctl(8)</a>.

<p>
[<a href="scrub.html">Précédent : Scrub (Normalisation de Paquets)</a>]
[<a href="index.html">Index</a>]
[<a href="queueing.html">Suivant : Gestion de La Bande Passante</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: anchors.html,v 1.14 ]<br>
$Translation: anchors.html,v 1.7 2004/11/03 20:38:27 saad Exp $<br>
$OpenBSD: anchors.html,v 1.5 2004/11/03 21:01:25 saad Exp $
</small>

</body>
</html> 
