<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Exemple : Pare-feu pour réseau domestique ou
            petite société</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../fr/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Précédent : Haute disponibilité des pare-feux
avec CARP et pfsync</a>]
[<a href="index.html">Index</a>]

<p>
<h1><font color="#e00000">PF : Exemple : Pare-feu pour réseau domestique
    ou petite société</font></h1> <hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#scenario">Le Scenario</a>
        <ul>
        <li><a href="#network">Le Réseau</a>
        <li><a href="#objective">Les Objectifs</a>
        <li><a href="#prep">Préparation</a>
        </ul>
<li><a href="#ruleset">Le Jeu de Règles</a>
        <ul>
        <li><a href="#macros">Macros</a>
        <li><a href="#options">Options</a>
        <li><a href="#rules">Règles de pare-feur</a>
        </ul>
<li><a href="#allrules">Le Jeu de Règles Complet</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>Le Scenario</h2>
Dans cet exemple, PF fonctionne sur une machine OpenBSD jouant le rôle
de pare-feu et de passerelle NAT pour un réseau SoHo. L'objectif global
est de fournir un accès Internet au réseau local, de fournir un accès
limité au pare-feu depuis Internet et d'exposer un serveur web interne
à l'Internet. Ce document a pour but de vous montrer comment on
construit un jeu de règles correspondant à l'objectif précité.

<a name="network"></a>
<h3>Le Réseau</h3>
Le réseau est conçu de la manière suivante :

<pre>
    
  [ COMP1 ]    [ COMP3 ]
      |            |                               
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
Il y a un certain nombre de machines sur le réseau interne. Le diagramme
en montre trois mais le vrai nombre n'est pas une donnée utile. Ces
machines sont des stations de travail normales servant à surfer sur le
web, écrire des messages électroniques, participer à des forums de
discussion en ligne, etc à l'exception de COMP3 qui sert aussi de
serveur Web. Le réseau interne utilise le bloc de réseau
192.168.0.0 / 255.255.255.0.

<p>
Le pare-feu OpenBSD est une machine dotée d'un Celeron 300 et de deux
cartes réseau : une 3Com 3c905B (<tt>xl0</tt>) et une Intel
EtherExpress Pro/100 (<tt>fxp0</tt>). Le pare-feu a une connexion câble
vers Internet et utilise la NAT pour partager cette connexion avec le
réseau interne. L'adresse IP de l'interface externe est attribuée
dynamiquement par le Fournisseur d'Accès Internet.

<a name="objective"></a>
<h3>Les Objectifs</h3>
Les objectifs sont les suivants :
<ul>
<li>Fournir un accès Internet sans restriction pour chaque machine du
    réseau interne.
<li>Utiliser un jeu de règles bloquant tout flux par défaut.
<li>Autoriser les flux entrants suivants sur le pare-feu à partir
    d'Internet :
        <ul>
        <li>SSH (port TCP 22) : utilisé pour la maintenance externe du
            pare-feu.
        <li>Auth/Ident (port TCP 113): utilisé par quelques services
            tels que SMTP et IRC.
        <li>Messages ICMP "Echo Request" : Le type de paquet ICMP
            utilisé par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8">ping(8)</a>.
        </ul>
<li>Rediriger les tentatives de connexion sur le port TCP 80 (qui sont
    des tentatives d'accès à un serveur Web) vers la machine COMP3. Et
    autoriser aussi le trafic vers le port TCP 80 destiné à COMP3 à
    travers le pare-feu.
<li>Enregistrer des statistiques de filtrage pour l'interface externe.
<li>Par défaut, renvoyer un RST TCP ou un message ICMP "Unreachable"
    pour les paquets bloqués.
<li>S'assurer que le jeu de règles est aussi simple et facile à
    maintenir que possible.
</ul>

<a name="prep"></a>
<h3>Préparation</h3>
Ce document suppose que l'hôte OpenBSD a été correctement configuré
pour fonctionner comme routeur : configuration réseau, connexion
Internet et positionnement des variables 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> <tt>net.inet.ip.forwarding</tt> et/ou
<tt>net.inet6.ip6.forwarding</tt> à "<tt>1</tt>".
Vouc devez également activer PF en utilisant
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+5.2"
>pfctl(8)</a> ou en définissant la variable appropriée dans
<tt>/etc/rc.conf.local</tt>.
PF est activé par défaut sur OpenBSD 4.6 et les nouvelles versions.

<a name="ruleset"></a>
<h2>Le Jeu de Règles</h2>
Les sections ci-après détaillent la manière dont le jeu de règles
répondra aux objectifs précités.

<a name="macros"></a>
<h3>Macros</h3>
Les macros suivantes sont définies pour rendre la maintenance et la
lecture du jeu de règles plus faciles :
<blockquote><pre>
int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3 = "192.168.0.3"
</pre></blockquote>

<p>
La première ligne définit les interfaces réseau sur
lesquelles le filtrage sera effectué. En les définissant ici, si nous
devons déplacer ce système vers une autre machine avec un matériel
différent, nous pourrons alors ne changer que ces deux lignes et le
reste des règles restera valable. 
(Pour cet exemple, l'interface externe sera assurée en utilisant
l'interface de groupe <tt>egress</tt>.
C'est automatiquement activé sur toutes les interfaces ayant une route par
défaut, dans ce cas, fxp0).
Les deuxièmes et troisièmes lignes listent les numéros de port TCP  
des services ouverts depuis Internet
(SSH et ident/auth) et les types de paquets ICMP qui sont autorisés à
parvenir jusqu'aù pare-feu. Enfin, la dernière ligne définit l'adresse
IP de COMP3.

<p>
<b>Remarque</b> : Si la connexion Internet nécessite l'utilisation
   de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=4">PPPoE</a>, 
   le filtrage et la NAT s'effectueront sur l'interface <tt>pppoe0</tt> <i>au
   lieu de</i> l'interface de sortie (<tt>fxp0</tt>).

<a name="options"></a>
<h3>Options</h3>
Les deux options suivantes spécifient la réponse par défaut fournie par
les règles de filtrage <tt>block</tt> et activent la collecte de
statistiques sur l'interface externe :
<blockquote><pre>
set block-policy return
set loginterface egress
</pre></blockquote>

<p>
Chaque système Unix possède une interface de "loopback".
C'est une interface réseau virtuelle utilisée par les applications pour
converser avec les autres au sein du même système.
Sur OpenBSD, l'interface de bouclage ("loopback") est
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
Le filtrage est communément désactivé sur ces interfaces.
L'utilisation de <a href="options.html#skip">set skip</a> permet
d'accomplir cela.
<blockquote><pre>
set skip on lo
</pre></blockquote>
<!-- XXX this should be interface groups, but PF (at least up to
 4.8) just does a substring match on the interface name -->
Veuillez prendre note que nous n'effectuons pas de filtrage sur les
interfaces <tt>lo</tt>, de cette manière nous pourrions
rajouter des interfaces de loopback supplémentaire sans avoir à nous
soucier de mettre à jour cette partie de la configuration.

<a name="rules"></a>
<h3>Règles Pare-feu</h3>

On commencera avec des règles pour supporter l'utilisation de 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.2">
ftp-proxy(8)</a> ainsi les clients FTP sur le réseau local pourront se
connecter aux serveurs FTP sur Inernet.
Cela fonctionne en insérant dynamiquement des règles quand une connexion ftp
est effectuée.
C'est réalisé en utilisant une <a href="anchors.html">ancre</a>:
<blockquote><pre>
anchor "ftp-proxy/*"
</pre></blockquote>

<p>
Maintenant nous allons ajouter la règle permettant le détournement des
connexions FTP pour qu'elles soient vues par ftp-proxy(8):
<blockquote><pre>
pass in quick on $int_if inet proto tcp to any port ftp \
    divert-to 127.0.0.1 port 8021
</pre></blockquote>

<p>
Cette règle intercepte les connexions FTP sur le port 21 et les détourne
vers une instance ftp-proxy(8) tournant sur le port 8021 et, à travers
l'utilisation du mot-clé <tt>quick</tt>, les paquets valides ne seront pas
testés par le reste du jeu de règles.
Si des utilisateurs se connectent sur les serveurs FTP sur des ports
différents, une liste peut être utilisée pour spécifier le port de
destination, par exemple :
<tt>to any port { 21, 2121 }</tt>.


<p>
Il faut remarquer qu'aussi bien les <a href="anchors.html">ancres</a> que
la règle de redirection
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.2"
>ftp-proxy(8)</a> ont besoin d'être placées avant toutes règles <tt>match</tt> 
pour le NAT ou le ftp-proxy(8) ne fonctionnera pas bien.

<p>
Maintenant nous allons voir les règles <tt>match</tt>.
Par elle-même, une règle <tt>match</tt> ne détermine pas si un paquet a la
permission ou non de passer.
À la place, les paquets qui sont conformes à cette règle auront les
paramètres mémorisés; ils seront utilisés dans toutes les règles <tt>pass</tt>
qui valident ces paquets.

<p>
C'est puissant : des paramètres comme <a href="nat.html">NAT</a>
ou <a href="queueing.html">queueing</a> peuvent être appliqués pour
certaines classes de paquets, et les permissions d'accès définies séparement.
 
<p>
Pour avoir du NAT pour la totalité du réseau interne la règle <tt>match</tt>
suivante est utilisée :
<blockquote><pre>
match out on egress inet from !(egress:network) to any nat-to (egress:0)
</pre></blockquote>
 
<p>
Dans ce cas, le "<tt>!(egress:network)</tt>" peut être facilement remplacé
par un "<tt>$int_if:network</tt>", mais si vous ajoutez plusieurs interfaces
internes, vous devrez ajouter des règles NAT en plus, par rapport à la
structure, NAT sera utilisé sur toutes les interfaces protégées.

<p>
Comme l'adresse IP de l'interface externe est assignée dynamiquement, les
parenthèses sont placées entre l'interface de traduction pour que PF soit
notifié d'un chagement d'adresse.
Le suffixe :0 est utilisé pour cela, si l'interface externe possède
plusieurs adresses, seule la première est utilisée pour la
traduction. 


<p>
Pour finir, la famille de protocole <tt>inet</tt> (IPv4) est spécifiée.
Cela supprime la traduction de tous les paquets <tt>inet6</tt> (IPv6) qui
sont reçus.

<p>
Maintenant les règles pour contrôler les permissions d'accès.
On commence avec une interdiction par défaut :
<blockquote><pre>
block in log
</pre></blockquote>

<p>
À ce point, tout le trafic entrant sera bloqué, même celui en provenance
du réseau interne. Ces paquets seront aussi tracés.
Des règles suivantes vont ouvrir un certain nombre de flux sur le pare-feu
afin de répondre aux objectifs précités et d'ouvrir toutes les interfaces
virtuelles nécessaires.

<p>
Gardez à l'esprit que pf peut bloquer le trafic entrant ou sortant d'une
interface.
Cela peut vous simplifier la tâche de ne filtrer que dans une direction
plutôt que d'essayer de rester consistant en filtrant le trafic sortant
et entrant.
Dans notre cas, nous choisirons de filtrer le trafic entrant uniquement,
mais lorsque celui-ci sera permit sur une interface nous ne
l'empêcherons pas d'en sortir. Pour se faire, nous utiliserons :

<blockquote><pre>
pass out quick
</pre></blockquote>

En utilisant <tt>quick</tt>, les paquets sortants ne seront pas vérifiés sur
les règles suivantes, cela améliore les performances.
 
<p>
Il est utile d'utiliser la <a href="filter.html#antispoof">protection
contre le spoofing d'adresses</a> :
<blockquote><pre>
antispoof quick for { lo $int_if }
</pre></blockquote>

<p>
Maintenant, il faut ouvrir les ports utilisés par les services réseau
disponibles depuis Internet. Tout d'abord, le trafic destiné au pare-feu
lui-même :

<blockquote><pre>
pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services
</pre></blockquote>

<p>
La spécification des ports réseau par le biais de la macro
<tt>$tcp_services</tt> rend l'ouverture de nouveaux services pour des
connexions provenant d'Internet plus facile dans la mesure où il suffira
de modifier la macro et recharger le jeu de règles. Des services UDP
peuvent aussi être mis à disposition en créant la macro
<tt>$udp_services</tt> et en ajoutant une règle de filtrage adéquate
similaire à la règle de filtrage ci-dessus en spécifiant <tt>proto
udp</tt>.

<p>
La règle suivante récupère toutes les tentatives de quelqu'un sur Internet
voulant se connecter sur le port 80 du pare-feu.
Les tentatives légitimes pour accéder à ce port seront des utilisateurs
essayant d'accéder au serveur web du réseau. 
Ces tentatives de connexion seront redirigées vers COMP3 :
 
<blockquote><pre>
pass in on egress inet proto tcp to (egress) port 80 rdr-to $comp3
</pre></blockquote>

<p>
Le trafic ICMP doit être permis :
<blockquote><pre>
pass in inet proto icmp all icmp-type $icmp_types
</pre></blockquote>

<p>
Comme pour la macro <tt>$tcp_services</tt>, la macro
<tt>$icmp_types</tt> peut facilement être modifiée pour changer les
types des paquets ICMP qui doivent être autorisés à atteindre le 
pare-feu. Notez que cette règle s'applique à toutes les interfaces 
réseau.

<p>
Maintenant, le trafic en provenance du réseau interne doit être
autorisé. Nous supposerons que les utilisateurs du réseau interne savent
ce qu'ils font et ne provoqueront pas de problème sur Internet. Ce n'est
pas nécessairement une bonne supposition pour de nombreux
environnements.
<blockquote><pre>
pass in on $int_if
</pre></blockquote>

<p>
Le trafic TCP, UDP et ICMP à destination d'Internet est autorisé à sortir
du pare-feu grâce à la règle précédente "<tt>pass out</tt>".
L'information sur l'état des connexions est sauvegardée pour permettre
aux paquets de retour de passer à leur tour la barrière que constitue le
pare-feu.

<a name="allrules"></a>
<h2>Le Jeu de Règles Complet</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros

int_if="xl0"

tcp_services = "{ 22, 113 }"
icmp_types = "echoreq"

comp3 = "192.168.0.3"

# options

set block-policy return
set loginterface egress

set skip on lo

# règles Proxy FTP

anchor "ftp-proxy/*"

pass in quick on $int_if inet proto tcp to any port ftp \
    divert-to 127.0.0.1 port 8021

# règles match

match out on egress inet from !(egress:network) to any nat-to (egress:0)

# règles de filtrage

block in log
pass out quick

antispoof quick for { lo $int_if }

pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services

pass in on egress inet proto tcp to (egress) port 80 rdr-to $comp3

pass in inet proto icmp all icmp-type $icmp_types

pass in on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Précédent : Haute disponibilité des pare-feux
avec CARP et pfsync</a>]
[<a href="index.html">Index</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.52 ]<br>
$Translation: example1.html,v 1.49 2012/11/01 19:46:20 rustybsd Exp $<br>
-->
$OpenBSD: example1.html,v 1.44 2012/11/02 07:24:05 ajacoutot Exp $
</small>

</body>
</html> 
