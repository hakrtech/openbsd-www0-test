<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Raccourcis pour la Cr&eacute;ation de Jeux de
R&egrave;gles</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="../rdr.html">Pr&eacute;c&eacute;dent : Redirection de Trafic
("Forwarding" de Ports)</a>]
[<a href="index.html">Index</a>]
[<a href="options.html">Suivant : Options de Fonctionnement</a>]

<p>
<h1>
<font color="#e00000">PF : Raccourcis pour la Cr&eacute;ation de Jeux de
R&egrave;gles</font>
</h1>

<hr>

<h3>Table des Mati&egrave;res</h3>
<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#macros">Utiliser les Macros</a>
<li><a href="#lists">Utiliser les Listes</a>
<li><a href="#grammar">Grammaire de PF</a>
        <ul>
        <li><a href="#elim">Suppression de Mots-cl&eacute;s</a>
        <li><a href="#return">Simplification des R&egrave;gles avec
            <tt>return</tt></a>
        <li><a href="#order">Ordonnancement de Mots-cl&eacute;s</a>
        </ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introduction</h2>
PF offre plusieurs moyens pour simplifier un jeu de r&egrave;gles.
Quelques bons exemples sont les
<a href="macros.html#macros">macros</a> et les
<a href="macros.html#lists">listes</a>.
De plus, le langage d'&eacute;criture des jeux de r&egrave;gles, ou
grammaire, offre aussi quelques raccourcis pour rendre un jeu de
r&egrave;gles plus simple. En r&egrave;gle g&eacute;n&eacute;rale, plus
un jeu de r&egrave;gles est facile plus il est facile de le comprendre
et le maintenir.

<a name="macros"></a>
<h2>Utiliser les Macros</h2>
Les macros sont utiles car elles fournissent une alternative au codage
en dur des adresses, des num&eacute;ros de ports, des noms d'interfaces
etc. dans un jeu de r&egrave;gles. Est-ce que l'adresse IP d'un serveur
a &eacute;t&eacute; modifi&eacute;e ? Pas de probl&egrave;me, il suffit
de mettre &agrave; jour la macro; nul besoin de retoucher les
r&egrave;gles de filtrage que vous avez mis du temps et de
l'&eacute;nergie &agrave; construire selon vos besoins.

<p>
Une convention usuelle dans l'&eacute;criture des jeux de r&egrave;gles
PF est de d&eacute;finir une macro pour chaque interface r&eacute;seau.
Si une carte r&eacute;seau doit &ecirc;tre remplac&eacute;e par une
autre carte qui utilise un pilote diff&eacute;rent (en changeant une
3Com par une Intel par exemple), la macro est mise &agrave; jour et les
r&egrave;gles de filtrage fonctionneront comme avant. Un autre
b&eacute;n&eacute;fice est le d&eacute;ploiement du m&ecirc;me jeu de
r&egrave;gles sur plusieurs machines. Certaines de ces machines peuvent
avoir des cartes r&eacute;seau diff&eacute;rentes. L'utilisation de
macros pour d&eacute;finir les cartes r&eacute;seau permet d'installer
les jeux de r&egrave;gles avec un minimum d'&eacute;dition.
L'utilisation de macros pour d&eacute;finir des informations dans un jeu
de r&egrave;gles sujet &agrave; changements, telles que les
num&eacute;ros de ports, les adresses IP, et les noms d'interfaces, est
une pratique recommand&eacute;e.
<blockquote>
<tt>
# d&eacute;finition de macros pour chaque interface r&eacute;seau<br>
IntIF = "dc0"<br>
ExtIF = "fxp0"<br>
DmzIF = "fxp1"
</tt>
</blockquote>

<p>
Une autre convention usuelle est d'utiliser les macros pour
d&eacute;finir des adresses IP et les blocs r&eacute;seau. Ceci aura
pour effet de r&eacute;duire de mani&egrave;re significative les
op&eacute;rations de maintenance d'un jeu de r&egrave;gles lorsque les
adresses IP y figurant changent.
<blockquote>
<tt>
# d&eacute;finition de nos r&eacute;seaux<br>
IntNet = "192.168.0.0/24"<br>
ExtAdd = "24.65.13.4"<br>
DmzNet = "10.0.0.0/24"
</tt>
</blockquote>

<p>
Si le r&eacute;seau interne doit &ecirc;tre &eacute;tendu ou
modifi&eacute;, il suffit de mettre &agrave; jour la macro :
<blockquote>
<tt>
IntNet = "{ 192.168.0.0/24, 192.168.1.0/24 }"
</tt>
</blockquote>

<p>
Une fois le jeu de r&egrave;gles recharg&eacute;, tout fonctionnera
comme avant.

<a name="lists"></a>
<h2>Utiliser les Listes</h2>
Prenons comme exemple quelques bonnes r&egrave;gles &agrave; inclure
dans vos jeux de r&egrave;gles pour g&eacute;rer les adresses

<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>
qui ne doivent pas &ecirc;tre rout&eacute;es sur Internet et qui
d'habitude, sont utilis&eacute;es dans un but malicieux :
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 127.0.0.0/8<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 10.0.0.0/8
</tt>
</blockquote>

<p>
Simplifions maintenant les r&egrave;gles ci-dessus :
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from { 127.0.0.0/8, 192.168.0.0/16, \<br>
&nbsp;&nbsp;&nbsp;172.16.0.0/12, 10.0.0.0/8 } to any<br>
block out quick on tl0 inet from any to { 127.0.0.0/8, \<br>
&nbsp;&nbsp;&nbsp;192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }
</tt>
</blockquote>

<p>
Le jeu de r&egrave;gles a &eacute;t&eacute; r&eacute;duit de six lignes
: on est pass&eacute; de huit lignes &agrave; deux. On peut encore
simplifier en utilisant des macros en conjonction d'une liste :

<blockquote>
<tt>
NoRouteIPs = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \<br>
&nbsp;&nbsp;&nbsp;10.0.0.0/8 }"
<br>
ExtIF = "tl0"<br>
block in &nbsp;quick on $ExtIF from $NoRouteIPs to any<br>
block out quick on $ExtIF from any to $NoRouteIPs
</tt>
</blockquote>

<p>
Notez que les macros et les listes simplifient le fichier
<tt>pf.conf</tt> mais que les lignes sont en r&eacute;alit&eacute;
interpr&eacute;t&eacute;es par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.4">pfctl(8)</a> 
en plusieurs lignes. Ainsi l'exemple pr&eacute;c&eacute;dent est
interpr&eacute;t&eacute; comme suit :
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 10.0.0.0/8<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 127.0.0.0/8
</tt>
</blockquote>

<p>
Comme vous pouvez le voir, la simplification des r&egrave;gles figurant
dans le fichier <tt>pf.conf</tt> est une facilit&eacute; offerte
&agrave; l'auteur et &agrave; la personne charg&eacute;e de la
maintenance de ce fichier. Ce n'est pas une simplification r&eacute;elle
des r&egrave;gles trait&eacute;es par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.4">pf(4)</a>.

<p>
Les macros peuvent &ecirc;tre utilis&eacute;es n'importe o&ugrave; dans
le fichier de r&egrave;gles PF et pas seulement pour d&eacute;finir des
adresses et des ports :
<blockquote>
<tt>
pre  = "pass in quick on ep0 inet proto tcp from "<br>
post = "to any port { 80, 6667 } keep state"<br>
<br>
# classe de David<br>
$pre 21.14.24.80 $post<br>
<br>
# logement de Nick<br>
$pre 24.2.74.79 $post<br>
$pre 24.2.74.178 $post
</tt>
</blockquote>

<p>
Les macros pr&eacute;c&eacute;dentes sont interpr&eacute;t&eacute;es
comme suit :
<blockquote>
<tt>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state
</tt>
</blockquote>

<a name="grammar"></a>
<h2>Grammaire de PF</h2>
La grammaire de PF est assez flexible ce qui permet une grande
flexibilit&eacute; dans les jeux de r&egrave;gles. PF est capable de
supposer certains mots-cl&eacute;s ce qui veut dire qu'ils n'ont pas
besoin d'&ecirc;tre explicitement inclus dans une r&egrave;gle, et
l'ordonnancement des mots-cl&eacute;s est rel&acirc;ch&eacute; de telle
fa&ccedil;on &agrave; ce qu'il ne soit pas n&eacute;cessaire de
m&eacute;moriser une syntaxe stricte.

<a name="elim"></a>
<h3>Elimination of Keywords</h3>
<p>
Pour d&eacute;finir une politique de blocage par d&eacute;faut, deux
r&egrave;gles sont utilis&eacute;s :
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
Ceci peut &ecirc;tre r&eacute;duit &agrave; :
<blockquote>
<tt>
block all
</tt>
</blockquote>

<p>
Quand aucune direction n'est sp&eacute;cifi&eacute;es, PF suppose que la
r&egrave;gle s'applique aux paquets passant dans les deux sens.

<p>
De mani&egrave;re similaire, les clauses "<tt>from any to any</tt>" et
"<tt>all</tt>" peuvent ne pas figurer dans une r&egrave;gle. Par exemple
:
<blockquote>
<tt>
block in on rl0 all<br>
pass &nbsp;in quick log on rl0 proto tcp from any to any port 22 keep state
</tt>
</blockquote>

<p>
peut &ecirc;tre simplifi&eacute;e de la mani&egrave;re suivante :
<blockquote>
<tt>
block in on rl0<br>
pass &nbsp;in quick log on rl0 proto tcp to port 22 keep state</tt>
</blockquote>

<p>
La premi&egrave;re r&egrave;gle bloque tous les paquets en entr&eacute;e
de n'importe o&ugrave; vers n'importe o&ugrave; sur l'interface rl0, et
la deuxi&egrave;me r&egrave;gle laisse passer le trafic TCP sur rl0
&agrave; destination du port 22.

<a name="return"></a>
<h3>Simplification des R&egrave;gles avec <tt>return</tt></h3>
<p>
Un jeu de r&egrave;gles utilis&eacute; pour bloquer des paquets et
r&eacute;pondre avec un TCP RST ou un ICMP Unreachable peut &ecirc;tre
&eacute;crit comme suit :
<blockquote>
<tt>
block in all<br>
block return-rst in proto tcp all<br>
block return-icmp in proto udp all<br>
block out all<br>
block return-rst out proto tcp all<br>
block return-icmp out proto udp all
</tt>
</blockquote>

<p>
Il peut &ecirc;tre largement simplifi&eacute; comme suit :
<blockquote>
<tt>
block return
</tt>
</blockquote>

<p>
Quand PF voit le mot-cl&eacute; <tt>return</tt>, il "sait" ce qu'il faut
envoyer comme r&eacute;ponse (ou pas en envoyer du tout), selon le
protocole du paquet bloqu&eacute;.

<a name="order"></a>
<h3>Ordonnancement de Mots-cl&eacute;s</h3>
<p>
L'ordre selon lequel les mots-cl&eacute;s sont sp&eacute;cifi&eacute;s
est flexible dans la plupart des cas. Par exemple, une r&egrave;gle
&eacute;crite comme suit :
<blockquote>
<tt>
pass in log quick on rl0 proto tcp to port 22 \<br> 
&nbsp;&nbsp;&nbsp;flags S/SA keep state queue ssh label ssh
</tt>
</blockquote>

<p>
Peut aussi &ecirc;tre &eacute;crite de cette fa&ccedil;on :
<blockquote>
<tt>
pass in quick log on rl0 proto tcp to port 22 \<br>
&nbsp;&nbsp;&nbsp;queue ssh keep state label ssh flags S/SA
</tt>
</blockquote>

<p>
Des variations similaires fonctionneront aussi.

<p>
[<a href="../rdr.html">Pr&eacute;c&eacute;dent : Redirection de Trafic
("Forwarding" de Ports)</a>]
[<a href="index.html">Index</a>]
[<a href="options.html">Suivant : Options de Fonctionnement</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: shortcuts.html,v 1.9 ]<br>
$Translation: shortcuts.html,v 1.1 2003/12/28 21:20:14 saad Exp $<br>
$OpenBSD: shortcuts.html,v 1.1 2003/12/29 22:13:35 horacio Exp $
</small>

</body>
</html> 
