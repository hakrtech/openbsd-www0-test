<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Gestion du Protocole FTP</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2002-2004 by OpenBSD.">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="perf.html">Précédent : Performances</a>]
[<a href="index.html">Index</a>]
[<a href="authpf.html">Suivant : Authpf : Shell Utilisateur pour les
Passerelles d'Authentification</a>]

<p>
<h1><font color="#e00000">PF : Gestion du Protocole FTP</font></h1>
<hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#modes">Modes FTP</a>
<li><a href="#client">Client FTP derrière un pare-feu</a>
<li><a href="#server">Serveur FTP protégé par un pare-feu
    PF local</a>
<li><a href="#natserver">Serveur FTP protégé par un
    pare-feu PF externe avec NAT</a>
<li><a href="#info">Plus d'Informations sur FTP</a>
</ul>

<hr>

<a name="modes"></a>
<h2>Modes FTP</h2>
FTP est un protocole qui date d'une époque où Internet était un petit
ensemble de machines avec des relations de confiance mutuelle et où tout
le monde connaissait tout le monde. A cette époque le besoin de filtrer
ou d'assurer une sécurité stricte était inexistant. FTP n'était pas
conçu pour filtrer, pour faire transiter du trafic à travers les pare-
feux, ou pour fonctionner avec la NAT.

<p>
FTP peut fonctionner dans deux modes : passif et actif. De manière
générale, le choix du mode actif ou passif consiste à déterminer
l'extrêmité de communication FTP qui a un problème avec le filtrage pare-
feu. Dans le meilleur des mondes, il faudrait supporter les deux modes
pour rendre vos utilisateurs heureux.

<p>
Dans le mode FTP actif, quand un utilisateur se connecte à un serveur
FTP distant et demande une information ou un fichier, le serveur FTP
effectue une connexion vers le client pour transférer les données
demandées. Cette connexion est appelée la <i>connexion de données</i>.
Pour commencer, le client FTP choisit un port aléatoire qui lui servira
pour recevoir les données. Le client envoie le numéro de port qu'il a
choisi au serveur FTP puis se met à l'écoute des connexions entrantes à
destination de ce port. Le serveur FTP initie ensuite une connexion vers
l'adresse du client sur le port choisi et transfère les données. Ce mode
de fonctionnement est problématique pour les utilisateurs essayant
d'accéder à des serveurs FTP lorsqu'ils sont derrière une passerelle
NAT. Vu la manière dont fonctionne la NAT, le serveur FTP initie la
connexion de données en se connectant à l'adresse externe de la
passerelle NAT sur le port choisi. La passerelle NAT n'a pas de
correspondance pour le paquet reçu dans sa table d'état. Le paquet sera
ignoré et ne sera pas délivré au client.

<p>
Dans le mode FTP passif (le mode par défaut utilisé par le client
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.6">ftp(1)</a> 
d'OpenBSD), le client demande au serveur de choisir un port aléatoire
sur lequel ce dernier se mettra à l'écoute en attente de la connexion de
données. Le serveur communique au client le port qu'il a choisi pour le
transfert des données. Malheureusement, ce n'est pas toujours possible
ou souhaitable à cause de la possibilité d'existence d'un pare-feu
devant le serveur FTP qui bloquerait les connexions de données en
entrée. Le client ftp(1) d'OpenBSD utilise le mode passif par défaut;
pour forcer le mode FTP actif, utilisez le drapeau -A du client ftp(1).
Il est aussi possible de désactiver le mode passif (et donc d'activer
par cette action le mode actif) en utilisant la commande "<tt>passive
off</tt>" à l'invite de commandes "<tt>ftp&gt;</tt>".


<a name="client"></a>
<h2>Client FTP derrière un pare-feu</h2>
Comme précédemment indiqué, FTP ne fonctionne pas très bien à travers
des mécanismes de NAT et des pare-feux.


<p>
Packet Filter fournit une solution à ce cas en redirigeant le trafic FTP
à travers un serveur mandataire FTP (proxy). Ce processus agit de telle
façon à "guider" votre trafic FTP à travers la passerelle NAT/pare-feu.
Le mandataire FTP utilisé par OpenBSD et PF est
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.6">ftp-proxy(8)</a>.  
Pour l'activer, ajustez la ligne suivante selon vos besoins et ajoutez
la à la section NAT de <tt>pf.conf</tt> :

<blockquote>
<tt>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \<br>
&nbsp;&nbsp;&nbsp;port 8021
</tt>
</blockquote>

<p>
Voici l'explication de cette ligne : "Le trafic entrant sur l'interface
interne est redirigé vers le serveur mandataire sur cette machine et
écoutant sur le port 8021".

<p>
Il est évident que le serveur mandataire doit être démarré et exécuté
sur la machine OpenBSD. Ceci peut être effectué en insérant la ligne
suivante dans <tt>/etc/inetd.conf</tt> :

<blockquote>
<tt>
127.0.0.1:8021 stream tcp nowait root /usr/libexec/ftp-proxy \<br>
&nbsp;&nbsp;&nbsp;ftp-proxy -n
</tt>
</blockquote>

<p>
L'option <tt>-n</tt> est uniquement nécessaire si la machine OpenBSD
effectue de la traduction d'adresses (NAT). Il faut maintenant envoyer
un signal 'HUP' à
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>inetd(8)</a> pour qu'il relise son fichier de configuration.
Une manière d'envoyer le signal 'HUP' consiste à utiliser
la commande suivante :

<blockquote>
<tt>
kill -HUP `cat /var/run/inetd.pid`
</tt>
</blockquote>

<p>
Notez que ftp-proxy écoute sur le port 8021, le même
port qui est utilisé dans la ligne <tt>rdr</tt>. Le choix du port
8021 est arbitraire, bien que 8021 est un bon choix vu qu'il n'est
utilisé par aucune autre application.

<p>
A ce moment, seules les connexions FTP en mode passif fonctionneront.
Pour autoriser les connexions en mode actif, la connexion ftp-data
initiée par le serveur doit être permise par le pare-feu.
Malheureusement, le port sur lequel cette connexion arrive ne peut être
connu à l'avance mais uniquement l'intervalle à laquelle il appartient.
Par contre, on sait que la connexion sera initiée à partir du port 20
(port ftp-data) et que ftp-proxy acceptera cette connexion (il
transmettra par la suite les données au client).
Etant donnée que ftp-proxy s'éxecute avec les privilèges de
l'utilisateur <tt>proxy</tt>, le mot-clé <tt>user</tt> peut être
utilisé dans la règle de filtrage.
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from port 20 to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;&nbsp;user proxy flags S/SA keep state
</tt>
</blockquote>

<p>
Veuillez noter que ftp-proxy(8) est utilisé pour aider les
<b>clients FTP</b> derrière un pare-feu PF; il n'est pas
utilisé pour prendre en charge un <b>serveur FTP</b>
derrière un tel pare-feu.


<a name="server"></a>
<h2>Serveur FTP protégé par un pare-feu PF local</h2>
Dans ce cas, PF est activé sur le serveur FTP lui-même
plutôt que sur un pare-feu dédié. Pour les besoins
d'une connexion FTP passive, FTP utilisera un haut port TCP choisi de
manière aléatoire pour les données entrantes. Par
défaut, le serveur FTP natif d'OpenBSD
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.6">ftpd(8)</a> 
utilise la plage 49152 à 65535. Ces ports doivent être
autorisés en entrée ainsi que le port 21 (le port de
contrôle FTP) :

<blockquote>
<tt>
pass in on $ext_if proto tcp from any to any port 21 keep state<br>
pass in on $ext_if proto tcp from any to any port &gt; 49151 \<br>
&nbsp;&nbsp;&nbsp;keep state
</tt>
</blockquote>

<p>
Si vous le souhaitez, vous pouvez restreindre cette plage
considérablement. Dans le cas du programme
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.6">ftpd(8)</a> 
d'OpenBSD, ceci peut être effectué en utilisant les
variables
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8&amp;manpath=OpenBSD+3.6">sysctl(8)</a> 
<tt>net.inet.ip.porthifirst</tt> et
<tt>net.inet.ip.porthilast</tt>.

<a name="natserver"></a>
<h2>Serveur FTP protégé par un pare-feu PF externe avec
    NAT</h2>
Dans ce cas, le pare-feu doit rediriger tout le trafic vers le serveur
FTP. De plus, il ne doit bloquer aucun des ports requis. Pour fournir un
exemple concret, on supposera encore une fois que le serveur FTP est le
serveur standard sous OpenBSD :
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.6">ftpd(8)</a>, 
utilisant la plage de ports par défaut.

<p>
Voici un exemple de règles qui pourraient être
utilisées dans ce cas de figure :
<blockquote>
<tt>
ftp_server = "10.0.3.21"<br>
<br>
rdr on $ext_if proto tcp from any to any port 21 -&gt; $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21<br>
rdr on $ext_if proto tcp from any to any port 49152:65535 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$ftp_server port 49152:65535<br>
<br>
# in on $ext_if<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21 keep state<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port &gt; 49151 keep state<br>
<br>
# out on $int_if<br>
pass out quick on $int_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21 keep state<br>
pass out quick on $int_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port &gt; 49151 keep state
</tt>
</blockquote>


<a name="info"></a>
<h2>Plus d'Informations sur FTP</h2>
Vous pouvez obtenir plus d'informations concernant le filtrage et le
fonctionnement de FTP de manière générale dans le
livre blanc suivant :
<ul>
<li><a href="http://www.pintday.org/whitepapers/ftp-review.shtml">FTP
Reviewed</a>
</ul>

<p>
[<a href="perf.html">Précédent : Performances</a>]
[<a href="index.html">Index</a>]
[<a href="authpf.html">Suivant : Authpf : Shell Utilisateur pour les
Passerelles d'Authentification</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: ftp.html,v 1.16 ]<br>
$Translation: ftp.html,v 1.11 2004/11/03 15:49:22 saad Exp $<br>
$OpenBSD: ftp.html,v 1.10 2004/11/03 21:01:25 saad Exp $
</small>

</body>
</html> 
