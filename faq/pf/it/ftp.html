<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>PF: Considerazioni con l'FTP</TITLE><LINK rev=made 
href="mailto:www@openbsd.org">
<META http-equiv=Content-Type content="text/html; charset=ISO-8859-1">
<META content=document name=resource-type>
<META content="the OpenBSD FAQ page" name=description>
<META content="openbsd,faq,pf" name=keywords>
<META content=global name=distribution><!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003, 2004, Joel Knight <enabled@myrealbox.com>
Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.
THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->
<META content="MSHTML 6.00.2600.0" name=GENERATOR></HEAD>
<BODY text="#000000" bgColor="#ffffff">
<!-- Passes validator.w3.org, please keep it this way; 
please, use a max of 72 chars per line -->
<A href="../../../it/index.html"><IMG height=30 alt="[OpenBSD]" 
src="../../../images/smalltitle.gif" width=141 border=0> </A>

<P>
[<A href="perf.html">Precedente: Performance</A>] 
[<A href="index.html">Indice</A>] 
[<A href="authpf.html">
Successivo: Authpf: Shell utente per autenticazione di Gateway</A>] 

<P>
<H1><FONT color="#e00000">PF: Considerzioni con l'FTP</FONT></H1>
<HR>

<H3>Indice</H3>
<UL>
  <LI><A href="ftp.html#modes">Modalità FTP</A> 
  <LI><A href="ftp.html#client">Client FTP dietro un Firewall</A> 
  <LI><A href="ftp.html#server">
PF "Self-Protecting" di un server FTP</A> 
  <LI><A href="ftp.html#natserver">Server FTP protetto da un Firewall PF con NAT</A> 
  <LI><A href="ftp.html#info">Ulteriori informazioni sull'FTP</A> </LI>
</UL>
<HR>
<A name=modes></A>
<H2>Modalità FTP</H2>
FTP è un vecchio protocollo che risale a quando Internet era un 
piccolo, gruppo di computer fidati e ognuno conosceva gli altri. 
A quel tempo la necessità di filtrare o di ottenere una sicurezza 
impenetrabile non era necessaria. FTP non era progettato per il 
filtraggio, attraversare firewall, o lavorare con NAT.

<P>
FTP si può usare in uno dei due seguenti modi: passivo o attivo. 
In genere la scelta di attivo o passivo è fatta per determinare chi ha 
problemi con il firewall. Realisticamente, occorre supportare entrambi 
per far felici gli utenti.

<P>
Con l'FTP attivo, quando un utente si connette a un server remoto FTP e 
richiede informazioni o un file, l'FTP server effettua una nuova 
connessione con il client per trasferire i dati richiesti. Questa è 
chiamata <I>data connection</I>. Per iniziare l'FTP client sceglie una 
porta casuale sulla quale ricevere i dati della connessione. Il client 
invia il numero di porta scelto al server FTP e resta in 
ascolto su quella porta in attesa di possibili connessioni. Il server 
FTP inizia quindi una connessione con la porta scelta all'indirizzo del 
client e trasferisce i dati. Questo è un problema per gli utenti che 
cercano di ottenere un accesso a un server FTP da dietro un gateway NAT. 
Proprio per come lavora la NAT, il server FTP inizia la connessione di 
dati collegandosi alla porta scelta all'indirizzo esterno del gateway 
NAT. La NAT riceverà questa connessione, ma non avendo mappato il 
pacchetto nella sua tabella di stato, getterà via il pacchetto e non lo 
consegnerà al client.
<P>
Con la modalità passiva l'FTP (modalità di default con l'OpenBSD 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;
sektion=1&amp;manpath=OpenBSD+3.7">ftp(1)</A> client), il client 
richiede che il server scelga una porta a caso per ascoltare la 
connessione di dati. Il server informa il client della porta scelta, 
e il client si connette a questa porta per trasferire i dati. 
Sfortunatamente questo non è sempre possibile o desiderabile per 
l'eventuale presenza di un firewall davanti al server FTP che blocca 
la connessione dati in ingresso. L'ftp(1) di OpenBSD usa di default 
la modalità passiva; per forzare la modalità attiva dell'FTP, usare 
il flag -A all'ftp o configurare la modalità passiva a "off" con il 
comando "<TT>passive off</TT>" al prompt "<TT>ftp&gt;</TT>". 
<A name=client></A>
<H2>Client FTP dietro un firewall</H2>
Come visto precedentemente, l'FTP non funziona molto bene attraverso 
la NAT e i firewall.

<P>
Packet Filter fornisce una soluzione per queste situazioni effettuando 
il reindirizzamento del traffico FTP attraverso un server proxy FTP. 
Questo processo agisce per "guidare" il tuo traffico FTP attraverso 
gateway NAT e firewall. Il proxy FTP utilizzato da OpenBSD e PF è 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;
sektion=8&amp;manpath=OpenBSD+3.7">ftp-proxy(8)</A>. Per attivarlo, 
scrivere nella sezione NAT di <TT>pf.conf</TT>:
<BLOCKQUOTE><TT>rdr on $int_if proto tcp from any to any port 21 -&gt; 
  127.0.0.1 \<BR>&nbsp;&nbsp;&nbsp;port 8021 </TT></BLOCKQUOTE>

<P>
La spiegazione di questa linea è: "Il traffico sull'interfaccia interna 
è reindirizzato al proxy server in esecuzione su questa macchina il 
quale sta ascoltando sulla porta 8021".
 
<P>
Con la speranza che sia visibile il proxy server deve essere attivato e 
funzionante sul box OpenBSD. Questo si ottiene inserendo la seguente 
riga in <TT>/etc/inetd.conf</TT>: 
<BLOCKQUOTE>
<TT>127.0.0.1:8021 stream tcp nowait root /usr/libexec/ftp-proxy 
  \<BR>&nbsp;&nbsp;&nbsp;ftp-proxy -n </TT></BLOCKQUOTE>

<P>
Da notare che lo switch <TT>-n</TT> è necessario solo se la macchina 
Open BSD sta effettuando la NAT. Ora invia un segnale 'HUP' a 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;
sektion=8&amp;manpath=OpenBSD+3.7">inetd(8)</A> 
per rileggere il suo file di configurazione. Un modo per inviare il 
segnale 'HUP' si ha con il comando:
<BLOCKQUOTE><TT>kill -HUP `cat /var/run/inetd.pid` </TT></BLOCKQUOTE>

<P>
Noterai che l'ftp-proxy sta ascoltando sulla porta 8021, la stessa porta 
della riga precedente <TT>rdr</TT> alla quale viene inviato il traffico. 
La scelta della porta 8021 è arbitraria, pensare a 8021 è una buona 
scelta perchè non è definita per nessun altra applicazione.

<P>
A questo punto solo una connessione FTP in modalità passiva funzionerà. 
Per abilitare una connessione in modalità attiva, l'ftp data connection 
che il server FTP inizia deve essere passato all'ingresso del firewall. 
Sfortunatamente, la porta da dove arriva questa connessione non può 
esser conosciuta precedentemente, ma può essere conosciuto solo il range 
entro il quale può capitare. Quello che si sa è che la connessione 
inizierà sulla porta 20 (ftp-data port) e che l'ftp-proxy accetterà la 
connessione (e quindi invierà i dati al client). Dato che l'ftp-proxy 
funziona come l'utente <TT>proxy</TT>, la keyword <TT>user</TT> può 
essere utilizzata nella regola di filtraggio.
<BLOCKQUOTE>
<TT>pass in on $ext_if inet proto tcp from port 20 to ($ext_if) 
  \<BR>
&nbsp;&nbsp;&nbsp;&nbsp;user proxy flags S/SA keep state </TT>
</BLOCKQUOTE>

<P>
Da notare che l'ftp-proxy(8) aiuta i <B>client FTP</B> dietro un filtro 
PF; non viene utilizzato per gestire un <B>server FTP</B> dietro un 
filtro PF. <A 
name=server></A>
<H2>PF "Self-Protecting" di un server FTP</H2>
In questo caso, PF funziona su un server FTP stesso piuttosto che su 
un computer dedicato al firewall. Quando ci si server di una 
connessione FTP passiva, FTP utilizzerà una porta TCP con numero 
elevato scelta a caso per l'ingresso dei dati. Di default il server 
FTP 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;
sektion=8&amp;manpath=OpenBSD+3.7">ftpd(8)</A> 
usa il range tra 49152 e 65535. Ovviamente queste devono essere 
passate attraverso le regole di filtraggio, insieme con la porta 21 
(la porta di controllo FTP):
<BLOCKQUOTE>
<TT>pass in on $ext_if proto tcp from any to any port 21 keep 
  state
<BR>pass in on $ext_if proto tcp from any to any port &gt; 49151 
  \<BR>&nbsp;&nbsp;&nbsp;keep state </TT></BLOCKQUOTE>

<P>
Da notare che se si desidera, si può chiudere al traffico quel range 
di porte. Nel caso di OpenBSD 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;
sektion=8&amp;manpath=OpenBSD+3.7">ftpd(8)</A> 
ciò si ottiene usando le variabili di 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;
sektion=8&amp;manpath=OpenBSD+3.7">sysctl(8)</A>, 
<TT>net.inet.ip.porthifirst</TT> e <TT>net.inet.ip.porthilast</TT>. 
<A name=natserver></A>
<H2>Server FTP protetto da un Firewall PF con NAT</H2>
In questo caso, il firewall deve reindirizzare il traffico al server 
FTP per non bloccare le richieste. Assumendo che il server FTP sia  
ancora lo standard OpenBSD
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;
sektion=8&amp;manpath=OpenBSD+3.7">ftpd(8)</A>, 
usando il range di porte di default.

<P>
Qui c'è un esempio di sottoregole di configurazione che dovrebbe 
ottenere questo:
<BLOCKQUOTE><TT>ftp_server = "10.0.3.21"<BR>
<BR>rdr on $ext_if proto tcp from 
  any to any port 21 -&gt; $ftp_server \<BR>
&nbsp;&nbsp;&nbsp;port 21<BR>rdr on 
  $ext_if proto tcp from any to any port 49152:65535 -&gt; 
  \<BR>&nbsp;&nbsp;&nbsp;$ftp_server port 49152:65535<BR>
<BR># ingresso sulla  
  $ext_if<BR>pass in quick on $ext_if proto tcp from any to $ftp_server 
  \<BR>&nbsp;&nbsp;&nbsp;port 21 keep state<BR>
pass in quick on $ext_if proto 
  tcp from any to $ftp_server \<BR>&nbsp;&nbsp;&nbsp;port &gt; 49151 keep 
  state<BR>
<BR># uscita sulla $int_if<BR>pass out quick on $int_if proto tcp from any 
  to $ftp_server \<BR>
&nbsp;&nbsp;&nbsp;port 21 keep state<BR>pass out quick on 
  $int_if proto tcp from any to $ftp_server \<BR>
&nbsp;&nbsp;&nbsp;port &gt; 
  49151 keep state </TT></BLOCKQUOTE><A name=info></A>
<H2>Ulteriori informazioni sull'FTP</H2>
Ulteriori informazioni sul filtraggio FTP e come l'FTP funziona può 
essere trovato in generale in queste pagine bianche:
<UL>
  <LI>
<A href="http://www.pintday.org/whitepapers/ftp-review.shtml">FTP 
  Reviewed</A> </LI></UL>

<P>
[<A href="perf.html">Precedente: Performance</A>] 
[<A href="index.html">Indice</A>] 
[<A href="authpf.html">
Successivo: Authpf: Shell utente per autenticazione di Gateway</A>] 

<P>
<HR>
<A href="../../it/index.html"><IMG height=24 alt="[back]" 
src="../../../images/back.gif" width=24 border=0></A> <A 
href="mailto:www@openbsd.org">www@openbsd.org</A> <BR>
<SMALL>
<!--
Originally [OpenBSD: ftp.html,v 1.18 ]<br>
$Translation: ftp.html,v 1.1 2005/10/16 09:21:24 danix Exp $<br>
-->
$OpenBSD: ftp.html,v 1.1 2005/10/16 10:14:28 saad Exp $
</SMALL> 
</BODY>
</HTML>
