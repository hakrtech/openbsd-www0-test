<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>PF: Logging</TITLE><LINK rev=made 
href="mailto:www@openbsd.org">
<META http-equiv=Content-Type content="text/html; charset=ISO-8859-1">
<META content=document name=resource-type>
<META content="the OpenBSD FAQ page" name=description>
<META content="openbsd,faq,pf" name=keywords>
<META content=global name=distribution><!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2005, Joel Knight <enabled@myrealbox.com>
Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.
THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->
<META content="MSHTML 6.00.2600.0" name=GENERATOR></HEAD>
<BODY text="#000000" bgColor="#ffffff"><!-- Passes validator.w3.org, 
please keep it this way; please, use a max of 72 chars per line -->
<A href="../../../it/index.html"><IMG height=30 alt="[OpenBSD]" 
src="../../../images/smalltitle.gif" width=141 border=0> </A>

<P>
[<A href="tagging.html">Precedente: Packet Tagging</A>] 
[<A href="index.html">Indice</A>] 
[<A href="perf.html">Successivo: Performance</A>] 
<P>
<H1><FONT color="#e00000">PF: Logging</FONT></H1>
<HR>
<H3>Indice</H3>
<UL>
  <LI><A href="logging.html#intro">Introduzione</A> 
  <LI><A href="logging.html#logfile">Lettura di un Log File</A> 
  <LI><A href="logging.html#filter">Filtraggio degli output di log</A> 
  <LI><A href="logging.html#syslog">
Logging dei pacchetti tramite Syslog</A> </LI></UL>
<HR>
<A name=intro></A>
<H2>Introduzione</H2>
Il logging dei pacchetti in PF è eseguito da 
<A 
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;
sektion=8&amp;manpath=OpenBSD+3.7">pflogd(8)</A> 
il quale ascolta sull'interfaccia <A 
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;
sektion=4&amp;manpath=OpenBSD+3.7"><TT>pflog0</TT></A> 
e riporta in formato binario 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;
sektion=8&amp;manpath=OpenBSD+3.7">tcpdump(8)</A> i pacchetti su 
un log file (generalmente /var/log/pflog). 
Le regole di <A href="http://www.openbsd.org/faq/pf/filter.html">
filtraggio</A> con keyword <TT>log</TT> o <TT>log-all</TT> 
vengono loggate. <A name=logfile></A>
<H2>Lettura di un Log File</H2>
Il log file scritto da pflogd è in formato binario e non può essere 
letto da un editor di testo. 
Per vedere il log deve essere usato Tcpdump.

<P>
Per vedere il log file:
<BLOCKQUOTE><TT># tcpdump -n -e -ttt -r /var/log/pflog </TT>
</BLOCKQUOTE>

<P>
Da notare che tcpdump(8) <I>non</I> consente l'analisi in tempo 
reale del file pflog. Per una visione in tempo reale 
dei log dei pacchetti si usa l'interfaccia <TT>pflog0</TT>: 
<BLOCKQUOTE><TT># tcpdump -n -e -ttt -i pflog0 </TT></BLOCKQUOTE>

<P>
<FONT color="#e00000">NOTE: </FONT>
Quando si esaminano i log, particolare attenzione dovrebbe essere 
data al decoding verbouse di tcpdump (attivato da linea di comando 
con l'opzione <TT>-v</TT>). Il protocollo decoder di tcpdump 
non ha una storia perfetta per quanto riguarda la sicurezza. 
Almeno in teoria sarebbe possibile un attacco ritardato utilizzando 
i payload parziali dei pacchetti registrati dal dispositivo di logging. 
Si raccomanda di spostare i file di log dal firewall prima di 
esaminarli.

<P>
Ulteriore attenzione dovrebbe essere dedicata all'accesso sicuro ai log. 
Di default, pflogd registrerà 96 bytes del pacchetto nel log file. 
L'accesso ai log dovrebbe fornire un accesso parziale a pacchetti 
di dati sensibili (come username e password di 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;
sektion=1&amp;manpath=OpenBSD+3.7">telnet(1)</A> o 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;
sektion=1&amp;manpath=OpenBSD+3.7">ftp(1)</A>). 
<A name=filter></A>
<H2>Filtraggio degli output di log</H2>
Grazie ai log di pflogd, in formato binario, nel rivedere i log si 
possono utilizzare tutte le opzioni offerte da tcpdump. Per esempio, per 
vedere solo i pacchetti che hanno una corrispondenza con una 
determinata porta:
<BLOCKQUOTE><TT># tcpdump -n -e -ttt -r /var/log/pflog port 80 
</TT></BLOCKQUOTE>

<P>
Si può limitare la visione dei pacchetti con una determinata 
combinazione di host e porta:
<BLOCKQUOTE>
<TT># tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 
  192.168.1.3 </TT></BLOCKQUOTE>

<P>
La stessa cosa può essere fatta quando si legge dall'interfaccia 
<TT>pflog0</TT>: 

<BLOCKQUOTE><TT># tcpdump -n -e -ttt -i pflog0 host 192.168.4.2 
</TT></BLOCKQUOTE>

<P>
Da notare che ciò non ha impatto sui pacchetti loggati dal file di
pflogd; il comando precedente visualizza solo i pacchetti quando vengono 
loggati.

<P>
Oltre all'utilizzo delle regole standard di filtraggio di 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;
sektion=8&amp;manpath=OpenBSD+3.7">tcpdump(8)</A>, 
il linguaggio di filtraggio del tcpdump di OpenBSD è stato esteso per 
la lettura dell'output di pflogd: 
<UL>
  <LI><TT>ip</TT> - famiglia di indirizzi IPv4. 
  <LI><TT>ip6</TT> - famiglia di indirizzi IPv6. 
  <LI><TT>on <I>int</I></TT> - pacchetto passato attraverso 
l'interfaccia <I>int</I>. 
  <LI><TT>ifname <I>int</I></TT> - 
lo stesso come <TT>on <I>int</I></TT>. 
  <LI><TT>ruleset <I>name</I></TT> - la regola di configurazione/<A 
  href="http://www.openbsd.org/faq/pf/anchors.html">ancora</A> con 
la quale il pacchetto ha avuto una corrispondenza.
  <LI><TT>rulenum <I>num</I></TT> - la regola di filtraggio che ha 
corrispondenza con il pacchetto era la regola numero <I>num</I>. 
  <LI><TT>action <I>act</I></TT> - l'azione intrapresa sul pacchetto. 
Le azioni possibili sono <TT>pass</TT> e <TT>block</TT>. 
  <LI><TT>reason <I>res</I></TT> - la ragione per la quale l'
<TT>azione</TT> è intrapresa. 
  Possibili ragioni sono <TT>match</TT>, <TT>bad-offset</TT>, 
<TT>fragment</TT>, <TT>short</TT>, <TT>normalize</TT>, <TT>memory</TT>, 
<TT>bad-timestamp</TT>, <TT>congestion</TT>, <TT>ip-option</TT>, 
<TT>proto-cksum</TT>, <TT>state-mismatch</TT>, 
<TT>state-insert</TT>, <TT>state-limit</TT>, <TT>src-limit</TT>, e 
<TT>synproxy</TT>. 
  <LI><TT>inbound</TT> - il pacchetto era in ingresso. 
  <LI><TT>outbound</TT> - il pacchetto era in uscita. </LI></UL>

<P>
Esempio: 
<BLOCKQUOTE>
<TT># tcpdump -n -e -ttt -i pflog0 inbound and action block and on 
  wi0 </TT></BLOCKQUOTE>

<P>
Questo mostra il log, in tempo reale, dei pacchetti in ingresso che 
sono stati bloccati all'interfaccia wi0. <A name=syslog></A>
<H2>Logging dei pacchetti tramite Syslog</H2>
In molte occasioni è desiderabile avere i log del firewall disponibili 
in formato ASCII per inviarli,ad esempio, a un server remoto di logging. 
Tutto questo può essere ottenuto con due piccoli script per shell, 
qualche cambio nella configurazione dei file di OpenBSD, e il 
demone di logging 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;
sektion=8&amp;manpath=OpenBSD+3.7">syslogd(8)</A>. 
Syslogd effettua il logging in ASCII ed è inoltre in grado di collegarsi  
con un server remoto di logging. 
<P>
Per prima cosa occorre creare uno user, <TT>pflogger</TT>, con una shell 
<TT>/sbin/nologin</TT>. Il modo più semplice per creare questo user è con 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;
sektion=8&amp;manpath=OpenBSD+3.7">adduser(8)</A>. 

<P>
Dopo aver creato lo user <TT>pflogger</TT>, creare i due seguenti 
script: 

<P>
<TT>/etc/pflogrotate</TT> <PRE>	FILE=/home/pflogger/pflog5min.$(date "+%Y%m%d%H%M")
	kill -ALRM $(cat /var/run/pflogd.pid)
	if [ $(ls -l /var/log/pflog | cut -d " " -f 8) -gt 24 ]; then
	   mv /var/log/pflog $FILE
	   chown pflogger $FILE
	   kill -HUP $(cat /var/run/pflogd.pid)
	fi
</PRE>

<P>
<TT>/home/pflogger/pfl2sysl</TT> <PRE>	for logfile in /home/pflogger/pflog5min* ; do
	   if [ -s "$logfile" ]; then
	      tcpdump -n -e -ttt -r $logfile | logger -t pf -p local0.info
	      rm $logfile
	   fi
	done
</PRE>

<P>
Editare il cron job di root:
<BLOCKQUOTE><TT># crontab -u root -e </TT></BLOCKQUOTE>

<P>
Aggiungere le due seguenti righe:
<BLOCKQUOTE>
<TT># rotate pf log file every 5 minutes<BR>
0-59/5 * * * * /bin/sh 
  /etc/pflogrotate </TT></BLOCKQUOTE>

<P>
Creare un cron job per l'utente <TT>pflogger</TT>: 
<BLOCKQUOTE><TT># crontab -u pflogger -e </TT></BLOCKQUOTE>

<P>
Aggiungere le due seguenti righe:
<BLOCKQUOTE><TT># feed rotated pflog file(s) to syslog<BR>
0-59/5 * * * * 
  /bin/sh /home/pflogger/pfl2sysl </TT></BLOCKQUOTE>

<P>
Aggiungere la seguente riga a <TT>/etc/syslog.conf</TT>: 
<BLOCKQUOTE><TT>local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt 
</TT></BLOCKQUOTE>

<P>
Se si volesse collegare a un log server remoto, aggiungere la 
linea:
<BLOCKQUOTE><TT>local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger 
</TT></BLOCKQUOTE>

<P>
Assicurarsi che l'host <I>syslogger</I> sia stato definito nel file 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;
sektion=5&amp;manpath=OpenBSD+3.7">hosts(5)</A>. 

<P>
Creare il file <TT>/var/log/pflog.txt</TT> per consentire a syslog di 
loggare quel file. 
<BLOCKQUOTE><TT># touch /var/log/pflog.txt </TT></BLOCKQUOTE>

<P>
Far ripartire syslogd per caricare i cambiamenti: 
<BLOCKQUOTE><TT># kill -HUP $(cat /var/run/syslog.pid) </TT></BLOCKQUOTE>

<P>
Tutti i pacchetti loggati sono inviati a <TT>/var/log/pflog.txt</TT>. 
Se la seconda riga viene aggiunta essi sono inviati all'host remoto di 
logging <I>syslogger</I>. 

<P>
Lo script <TT>/etc/pflogrotate</TT> processa e di seguito cancella 
<TT>/var/log/pflog</TT> così la rotazione di <TT>pflog</TT> da parte 
<A href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;
sektion=8&amp;manpath=OpenBSD+3.7">newsyslog(8)</A> 
non è più necessaria e dovrebbe essere disabilitata. Comunque, 
<TT>/var/log/pflog.txt</TT> sostituisce <TT>/var/log/pflog</TT> e la 
rotazione di esso dovrebbe essere attivata. 
Cambiare <TT>/etc/newsyslog.conf</TT> come di seguito: <PRE>    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</PRE>

<P>
PF effettuerà ora il log in ASCII al <TT>/var/log/pflog.txt</TT>. 
Se così configurato in <TT>/etc/syslog.conf</TT>, effettuerà anche il 
log su un server remoto. Il logging non è immediato ma può richiedere 
circa 5-6 minuti (l'intervallo del cron job) prima che i pacchetti 
loggati appaiano nel file.

<P>
[<A href="tagging.html">Precedente: Packet Tagging</A>] 
[<A href="index.html">Indice</A>] 
[<A href="perf.html">Successivo: Performance</A>] 

<P>
<HR>
<A href="../../it/index.html"><IMG height=24 alt="[back]" 
src="../../../images/back.gif" width=24 border=0></A> <A 
href="mailto:www@openbsd.org">www@openbsd.org</A> <BR>
<SMALL>
<!--
Originally [OpenBSD: logging.html,v 1.21 ]<br>
$Translation: logging.html,v 1.1 2005/10/16 09:21:24 danix Exp $<br>
-->
$OpenBSD: logging.html,v 1.1 2005/10/16 10:14:28 saad Exp $
</SMALL> 
</BODY>
</HTML>