<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Logging</title><link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description" content="the OpenBSD FAQ page">
<meta name="keywords" content="openbsd,faq,pf">
<meta name="distribution" content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2007, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="tagging.html">Anterior: Marca&ccedil;&atilde;o de Pacotes</a>]
[<a href="index.html">Conte&uacute;do</a>]
[<a href="perf.html">Pr&oacute;ximo: Performance</a>]

<p>
<h1><font color="#e00000">PF: Logging</font></h1>

<hr>

<h3>Conte&uacute;do</h3>
<ul>
<li><a href="#intro">Introdu&ccedil;&atilde;o</a>
<li><a href="#log">Logando Pacotes</a>
<li><a href="#logfile">Lendo um Arquivo de Log</a>
<li><a href="#filter">Filtrando Sa&iacute;das de Log</a>
<li><a href="#syslog">Logando Pacotes Atrav&eacute;s do Syslog</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdu&ccedil;&atilde;o</h2>
Quando um pacote &eacute; logado, uma c&oacute;pia do cabe&ccedil;alho do
pacote &eacute; enviada para a interface 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4&amp;manpath=OpenBSD+4.2"
>pflog(4)</a> junto com dados adicionais como a interface que o 
pacote foi transmitido, a a&ccedil;&atilde;o que o PF tomou (pass ou block),
etc. 
A interface pflog(4) permite que aplica&ccedil;&otilde;es em espa&ccedil;o de
usu&aacute;rio recebam dados de log do PF vindos do kernel. 
Se o PF estiver habilitado quando o sistema iniciar, o servi&ccedil;o 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.2"
>pflogd(8)</a> &eacute; iniciado.
Por padr&atilde;o pflogd(8) escuta a interface <tt>pflog0</tt> e escreve
todos os dados de log no arquivo <tt>/var/log/pflog</tt>.

<a name="log"></a>
<h2>Logando Pacotes</h2>
<p>
Para logar pacotes atravessando o PF, a palavra-chave <tt>log</tt>
deve ser usada em regras <a href="nat.html">NAT/rdr</a> e 
<a href="filter.html">filtragem</a>.
Perceba que o PF pode logar apenas pacotes que estejam sendo liberados 
ou bloqueados; voc&ecirc; n&atilde;o pode criar uma regra que apenas 
logue os pacotes.

<p>
A palavra-chave <tt>log</tt> faz com que todos os pacotes que combinem 
com a regra sejam logados.
No caso da regra estar <a href="filter.html#state">criando estado</a>, 
apenas o primeiro pacote (o que faz com que o estado seja criado) 
ser&aacute; logado.

<p>
As op&ccedil;&otilde;es que podem ser passadas a palavra-chave 
<tt>log</tt> s&atilde;o:

<dl>
<dt><tt>all</tt>
<dd>Faz com que todos os pacotes, e n&atilde;o apenas o primeiro, sejam
logados.
&Eacute; &uacute;til para regras que criam estado.

<dt><tt>to <i>pflogN</i></tt>
<dd>Faz com que todos os pacotes que combinem com a regra sejam logados
na interface pflog(4) especificada.
Por exemplo, quando estiver usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamlogd&amp;sektion=8"
>spamlogd(8)</a> todo o trafego SMTP pode ser logado numa interface pflog(4)
dedicada pelo PF. 
O servi&ccedil;o spamlogd(8) pode ent&atilde;o ser configurado para escutar
nesta interface.
Isto mant&eacute;m o arquivo principal de log do PF limpo de trafego SMTP
que de alguma forma n&atilde;o precisa ser logado.
Use
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a> para criar interfaces pflog(4).
A interface de log padr&atilde;o <tt>pflog0</tt> &eacute; criada
automaticamente. 

<dt><tt>user</tt>
<dd>Faz com que al&eacute;m da informa&ccedil;&atilde;o padr&atilde;o de
log, o user-id e group-id Unix do usu&aacute;rio dono do socket de 
origem/destino do pacote (independente de ser local) sejam logados 
tamb&eacute;m.
</dl>

<p>
As op&ccedil;&otilde;es devem ser informadas entre par&ecirc;nteses
ap&oacute;s a palavra <tt>log</tt>; v&aacute;rias op&ccedil;&otilde;es 
podem ser informadas separando-as com v&iacute;rgula ou espa&ccedil;o.

<blockquote>
<tt>
pass in log (all, to pflog1) on $ext_if inet proto tcp to $ext_if port 22 keep
state

</tt>
</blockquote>

<a name="logfile"></a>
<h2>Lendo um Arquivo de Log</h2>
O arquivo de log escrito pelo pflogd &eacute; em formato bin&aacute;rio e n&atilde;o pode ser 
lido utilizando um editor de texto. O tcpdump deve ser utilizado para 
ver os logs.

<p>
Para ver o arquivo de log:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Perceba que usando tcpdump(8) para ver um arquivo de log <i>n&atilde;o</i> 
mostra a atividade em tempo real. Um monitoramento em tempo real dos 
pacotes logados &eacute; conseguido usando a interface <tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">NOTA: </font>
Quando estiver examinando logs, um cuidado especial deve ser tomado 
com a op&ccedil;&atilde;o verbose do decodificador de protocolos do tcpdump 
(ativada pela op&ccedil;&atilde;o <tt>-v</tt>). Os decodificadores de 
protocolos do tcpdump n&atilde;o possuem um perfeito hist&oacute;rico de 
seguran&ccedil;a.  Pelo menos em teoria, um ataque muito lento 
pode ser poss&iacute;vel utilizando-se de partes do payload dos 
pacotes que s&atilde;o logados pelo dispositivo de log. &Eacute; 
pr&aacute;tica recomendada mover os arquivos de log fora da 
m&aacute;quina do firewall antes de examin&aacute;-los desta maneira.

<p>
Um cuidado adicional deve existir com a seguran&ccedil;a no acesso aos 
logs. Por padr&atilde;o, pflogd ir&aacute; registrar 96 bytes do pacote no 
arquivo de log.  O acesso aos logs pode prover acesso parcial a 
payloads de pacotes com informa&ccedil;&otilde;es sens&iacute;veis  
(como nomes de usu&aacute;rio e senhas 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1"
>telnet(1)</a> ou
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1"
>ftp(1)</a>).

<a name="filter"></a>
<h2>Filtrando a Sa&iacute;da de Log</h2>
Como pflogd loga em formato tcpdump bin&aacute;rio, toda a gama de atributos 
do tcpdump pode ser utilizada quando estiver examinando os logs. Por 
exemplo, para ver apenas pacotes que combinem com certa porta:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Isso pode ser filtrado ainda mais limitando a exibi&ccedil;&atilde;o de pacotes 
com certa combina&ccedil;&atilde;o de host e porta:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
A mesma id&eacute;ia pode ser aplicada quando lendo atrav&eacute;s da interface 
<tt>pflog0</tt>
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Note que isso n&atilde;o tem nenhum impacto sobre pacotes que s&atilde;o logados
no arquivos do pflogd; o comando acima mostra apenas pacotes 
conforme eles s&atilde;o logados.

<p>
Al&eacute;m de usar as regras de filtragem padr&atilde;o do 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8">tcpdump(8)</a>, 
a linguagem do tcpdump do OpenBSD's foi extendida para ler a sa&iacute;da do pflogd:
<ul>
<li><tt>ip</tt> - fam&iacute;lia do endere&ccedil;o &eacute; IPv4.
<li><tt>ip6</tt> - fam&iacute;lia do endere&ccedil;o &eacute; IPv6.
<li><tt>on <i>int</i></tt> - pacote passou pela interface
<i>int</i>.
<li><tt>ifname <i>int</i></tt> - o mesmo que <tt>on <i>int</i></tt>.
<li><tt>ruleset <i>nome</i></tt> - a 
<a href="anchors.html">ruleset/anchor</a> que o pacote combinou.
<li><tt>rulenum <i>num</i></tt> - n&uacute;mero da regra que combinou com o pacote.
<li><tt>action <i>act</i></tt> - a a&ccedil;&atilde;o empregada no pacote.
A&ccedil;&otilde;es poss&iacute;veis s&atilde;o <tt>pass</tt> e <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - a raz&atilde;o pela qual a <tt>a&ccedil;&atilde;o</tt> foi  
tomada. Raz&otilde;es poss&iacute;veis s&atilde;o <tt>match</tt>, <tt>bad-offset</tt>,
<tt>fragment</tt>, <tt>short</tt>, <tt>normalize</tt>, 
<tt>memory</tt>, <tt>bad-timestamp</tt>,
<tt>congestion</tt>, <tt>ip-option</tt>, <tt>proto-cksum</tt>,
<tt>state-mismatch</tt>, <tt>state-insert</tt>, <tt>state-limit</tt>,
<tt>src-limit</tt> e <tt>synproxy</tt>.
<li><tt>inbound</tt> - pacote estava entrando.
<li><tt>outbound</tt> - pacote estava saindo.
</ul>

<p>
Exemplo:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Isso mostra o log, em tempo real, de pacotes entrantes que foram 
bloquados na interface wi0.

<a name="syslog"></a>
<h2>Logando Pacotes Atrav&eacute;s do Syslog</h2>
Em muitas situa&ccedil;&otilde;es &eacute; desej&aacute;vel possuir 
logs do firewall dispon&iacute;veis em formato texto ASCII e/ou 
envi&aacute;-los a um servidor de logs remoto. 
Tudo isso pode ser obtido com o uso de um pequeno shell script, 
algumas pequenas altera&ccedil;&otilde;es em arquivos de 
configura&ccedil;&atilde;o do OpenBSD, e o servi&ccedil;o de log 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8">syslogd(8)</a>. 
O syslogd loga em formato ASCII e tamb&eacute;m &eacute; capaz de logar em servidor remoto.

<p>
Crie o seguinte script:

<p>
<tt>/etc/pflogrotate</tt>
<pre>
	#!/bin/sh
	PFLOG=/var/log/pflog
	FILE=/var/log/pflog5min.$(date "+%Y%m%d%H%M")
	kill -ALRM $(cat /var/run/pflogd.pid)
	if [ -r $PFLOG ] && [ $(stat -f %z $PFLOG) -gt 24 ]; then
		mv $PFLOG $FILE
		kill -HUP $(cat /var/run/pflogd.pid)
		tcpdump -n -e -ttt -r $FILE | logger -t pf -p local0.info
		rm $FILE
	fi
</pre>

<p>
Edite o cron do root:
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Adicione as duas linhas seguintes:
<blockquote>
<tt>
# rotate pf log file every 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Adicione a linha a seguir em <tt>/etc/syslog.conf</tt>:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Se voc&ecirc; tamb&eacute;m quiser logar num servidor remoto, insira 
a linha:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Certifique-se de que <i>syslogger</i> esteja definido no arquivo 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5"
>hosts(5)</a>.

<p>
Crie o arquivo <tt>/var/log/pflog.txt</tt> para que o syslog 
possa logar nele e de as mesmas permiss&otilde;es do arquivo pflog.
<blockquote>
<tt>
# touch /var/log/pflog.txt<br>
# chmod 600 /var/log/pflog.txt
</tt>
</blockquote>

<p>
Avise o syslogd sobre a altera&ccedil;&atilde;o, reinciando-o:
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Todos pacotes logados agora s&atilde;o enviados para 
<tt>/var/log/pflog.txt</tt>.
Caso a segunda linha tenha sido adicionada eles tamb&eacute;m 
s&atilde;o enviados para o host remoto <i>syslogger</i>.

<p>
O script <tt>/etc/pflogrotate</tt> agora processa e deleta 
<tt>/var/log/pflog</tt>, assim a rota&ccedil;&atilde;o do 
<tt>pflog</tt> por <a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8">newsyslog(8)</a> 
n&atilde;o &eacute; mais necess&aacute;ria, e deve ser desabilitada. Contudo, 
<tt>/var/log/pflog.txt</tt> subistitui
<tt>/var/log/pflog</tt> e sua rota&ccedil;&atilde;o deve ser ativada.
Altere <tt>/etc/newsyslog.conf</tt> da seguinte forma:
<pre>    
    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
Agora o PF loga em <tt>/var/log/pflog.txt</tt> no formato ASCII. 
Se estiver configurado em <tt>/etc/syslog.conf</tt>, tamb&eacute;m 
logar&aacute; num servidor remoto.  O log n&atilde;o &eacute; imediato 
podendo ser necess&aacute;rio no m&aacute;ximo 5-6 minutos (o 
intervalo da tarefa no cron) para que eles apace&ccedil;am no arquivo.

<p>
[<a href="tagging.html">Anterior: Marca&ccedil;&atilde;o de Pacotes</a>]
[<a href="index.html">Conte&uacute;do</a>]
[<a href="perf.html">Pr&oacute;ximo: Performance</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: index.html,v 1.34 ]<br>
$Translation: logging.html,v 1.11 2007/11/24 18:12:31 dsantos Exp $<br>
-->
$OpenBSD: logging.html,v 1.11 2007/12/01 10:39:11 tobias Exp $ 
</small>

</body>
</html>
