<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Logging</title><link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2007, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="tagging.html">Anterior: Marcação de Pacotes</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="perf.html">Próximo: Performance</a>]

<p>
<h1><font color="#e00000">PF: Logging</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#log">Logando Pacotes</a>
<li><a href="#logfile">Lendo um Arquivo de Log</a>
<li><a href="#filter">Filtrando Saídas de Log</a>
<li><a href="#syslog">Logando Pacotes Através do Syslog</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
Quando um pacote é logado pelo PF, uma cópia do cabeçalho do pacote é
enviado para a interface
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=8&amp;manpath=OpenBSD+4.4"
>pflog(8)</a> junto com alguns outros dados adicionais, como a
interface que o pacote estava transitando, a ação que o PF tomou
(liberou ou bloqueou), etc.
A interface pflog(4) libera aplicações no espaço de usuário a receber
os dados de logging do kernel.
Se o PF é ativado quando o sistema é inicializado, o daemon
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.4"
>pflogd(8)</a> é carregado.
Por padrão, o pflogd(8) ouve na interface <tt>pflog0</tt> e escreve
todos os dados logados no arquivo <tt>/var/log/pflog</tt>.

<a name="log"></a>
<h2>Logando Pacotes</h2>
<p>
Para logar pacotes atravessando o PF, a palavra-chave <tt>log</tt>
deve ser usada em regras de <a href="nat.html">NAT/rdr</a> e
<a href="filter.html">filtragem</a>.
Perceba que o PF pode logar apenas pacotes que estejam sendo liberados
ou bloqueados; você não pode criar uma regra que apenas
logue os pacotes.

<p>
A palavra-chave <tt>log</tt> faz com que todos os pacotes que casem
com a regra sejam logados.
No caso da regra estar <a href="filter.html#state">criando estado</a>,
apenas o primeiro pacote (o que faz com que o estado seja criado)
será logado.

<p>
As opções que podem ser passadas à palavra-chave
<tt>log</tt> são:

<dl>
<dt><tt>all</tt>
<dd>Faz com que todos os pacotes, e não apenas o primeiro, sejam
logados.
É útil para regras que criam estado.

<dt><tt>to <i>pflogN</i></tt>
<dd>Faz com que todos os pacotes casados sejam logados na interface
pflog(4) especificada.
Por exemplo, quando usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamlogd&amp;sektion=8"
>spamlogd(8)</a>, todo o tráfego SMTP pode ser logado pelo PF para uma
interface pflog(4) dedicada.
O daemon spamlogd(8) pode então ser ordenado para escutar naquela
interface.
Isso mantém limpo o arquivo de log principal do PF de tráfego SMTP, o
qual fora isso, não precisa ser logado.
Use o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a>
para criar interfaces pflog(4).
A interface de log padrão <tt>pflog0</tt> é criada automaticamente.

<dt><tt>user</tt>
<dd>Faz com que além da informação padrão de log, o user-id e
group-id Unix do usuário dono do socket de origem/destino do pacote
(independente de ser local) sejam logados também.
</dl>

<p>
As opções devem ser informadas entre parênteses após a palavra-chave
<tt>log</tt>; várias opções podem ser informadas separando-as com
vírgula ou espaço.

<blockquote>
<tt>
pass in log (all, to pflog1) on $ext_if inet proto tcp to $ext_if port 22 keep state
</tt>
</blockquote>


<a name="logfile"></a>
<h2>Lendo um Arquivo de Log</h2>
O arquivo de log escrito pelo pflogd é em formato binário e não pode ser
lido utilizando um editor de textos. O tcpdump deve ser utilizado para
ver os logs.

<p>
Para ver o arquivo de log:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Perceba que o uso do tcpdump(8) para ver um arquivo de log <i>não</i>
mostra a atividade em tempo real. Um monitoramento em tempo real dos
pacotes logados é conseguido usando a interface <tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">NOTA: </font>
Quando examinando logs, um cuidado especial deve ser tomado
com a opção verbose do decodificador de protocolos do tcpdump
(ativada pela opção <tt>-v</tt>). Os decodificadores de protocolos
do tcpdump não possuem um histórico de segurança perfeito.
Pelo menos em teoria, um ataque muito lento pode ser possível
utilizando-se de partes do payload dos pacotes que são logados pelo
dispositivo de log. É prática recomendada mover os arquivos de log
fora da máquina do firewall antes de examiná-los dessa maneira.

<p>
Cuidado adicional deve existir com a segurança no acesso aos logs.
Por padrão, o pflogd irá registrar 96 bytes do pacote no
arquivo de log. Acesso aos logs pode prover acesso parcial a
payloads de pacotes com informações sensíveis
(como nomes de usuário e senhas
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1&amp;manpath=OpenBSD+4.1"
>telnet(1)</a> ou
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+4.1"
>ftp(1)</a>).

<a name="filter"></a>
<h2>Filtrando a Saída de Log</h2>
Como o pflogd loga em formato tcpdump binário, toda a gama de atributos
do tcpdump pode ser utilizada quando estiver examinando os logs. Por
exemplo, para ver apenas pacotes que casem com certa porta:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Isso pode ser filtrado ainda mais, limitando a exibição de pacotes
com certa combinação de host e porta:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
A mesma idéia pode ser aplicada quando lendo através da interface
<tt>pflog0</tt>
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Note que isso não tem nenhum impacto sobre pacotes que são logados
no arquivo do pflogd; o comando acima mostra apenas pacotes
conforme eles são logados.

<p>
Além de usar as regras de filtragem padrão do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8"
>tcpdump(8)</a>, a linguagem de filtragem do tcpdump foi extendida para
ler a saída do pflogd:
<ul>
<li><tt>ip</tt> - família do endereço é IPv4.
<li><tt>ip6</tt> - família do endereço é IPv6.
<li><tt>on <i>int</i></tt> - pacote passou pela interface
    <i>int</i>.
<li><tt>ifname <i>int</i></tt> - o mesmo que <tt>on <i>int</i></tt>.
<li><tt>ruleset <i>nome</i></tt> - a
    <a href="anchors.html">ruleset/anchor</a> que o pacote casou.
<li><tt>rulenum <i>num</i></tt> - número da regra que casou com o
    pacote.
<li><tt>action <i>act</i></tt> - a ação empregada no pacote.
    Ações possíveis são <tt>pass</tt> e <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - a razão pela qual a <tt>ação</tt> foi
    tomada. Razões possíveis são <tt>match</tt>, <tt>bad-offset</tt>,
    <tt>fragment</tt>, <tt>short</tt>, <tt>normalize</tt>,
    <tt>memory</tt>, <tt>bad-timestamp</tt>, <tt>congestion</tt>,
    <tt>ip-option</tt>, <tt>proto-cksum</tt>, <tt>state-mismatch</tt>,
    <tt>state-insert</tt>, <tt>state-limit</tt>, <tt>src-limit</tt> e
    <tt>synproxy</tt>.
<li><tt>inbound</tt> - pacote estava entrando.
<li><tt>outbound</tt> - pacote estava saindo.
</ul>

<p>
Exemplo:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Isso mostra o log, em tempo real, de pacotes entrantes que foram
bloqueados na interface wi0.

<a name="syslog"></a>
<h2>Logando Pacotes Através do Syslog</h2>
Em muitas situações é desejável possuir logs do firewall disponíveis
em formato texto ASCII e/ou enviá-los a um servidor de logs remoto.
Tudo isso pode ser obtido com o uso de um pequeno shell script,
algumas pequenas alterações em arquivos de configuração do OpenBSD,
e o daemon de log
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8"
>syslogd(8)</a>. O syslogd loga em formato ASCII e também é capaz de
logar em servidor remoto.

<p>
Crie o seguinte script:

<p>
<tt>/etc/pflogrotate</tt>
<pre>
	#!/bin/sh
	PFLOG=/var/log/pflog
	FILE=/var/log/pflog5min.$(date "+%Y%m%d%H%M")
	kill -ALRM $(cat /var/run/pflogd.pid)
	if [ -r $PFLOG ] && [ $(stat -f %z $PFLOG) -gt 24 ]; then
	   mv $PFLOG $FILE
	   kill -HUP $(cat /var/run/pflogd.pid)
	   tcpdump -n -e -ttt -r $FILE | logger -t pf -p local0.info
	   rm $FILE
	fi
</pre>

<p>
Edite o cron do root:
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Adicione as duas linhas seguintes:
<blockquote>
<tt>
# rotate pf log file every 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Adicione a linha a seguir em <tt>/etc/syslog.conf</tt>:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Se você também quiser logar num servidor remoto, insira a linha:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Certifique-se de que o host <i>syslogger</i> esteja definido no arquivo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5"
>hosts(5)</a>.

<p>
Crie o arquivo <tt>/var/log/pflog.txt</tt> para que o syslog possa
logar nele, e dê a ele as mesmas permissões do arquivo pflog.
<blockquote>
<tt>
# touch /var/log/pflog.txt<br>
# chmod 600 /var/log/pflog.txt
</tt>
</blockquote>

<p>
Avise o syslogd sobre as alterações, reiniciando-o:
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Todos pacotes logados agora são enviados para
<tt>/var/log/pflog.txt</tt>.
Caso a segunda linha tenha sido adicionada, eles também são enviados
para o host remoto <i>syslogger</i>.

<p>
O script <tt>/etc/pflogrotate</tt> agora processa e deleta
<tt>/var/log/pflog</tt>, assim a rotação do <tt>pflog</tt> por
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8"
>newsyslog(8)</a> não é mais necessária, e deve ser desabilitada.
Contudo, <tt>/var/log/pflog.txt</tt> substitui <tt>/var/log/pflog</tt>
e sua rotação deve ser ativada.
Altere <tt>/etc/newsyslog.conf</tt> da seguinte forma:
<pre>
    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
Agora o PF loga em <tt>/var/log/pflog.txt</tt> no formato ASCII.
Se estiver configurado em <tt>/etc/syslog.conf</tt>, também logará num
servidor remoto. O log não é imediato, pode levar cerca de 5-6
minutos (o intervalo da tarefa no cron) antes que os pacotes logados
apareçam no arquivo.

<p>
[<a href="tagging.html">Anterior: Marcação de Pacotes</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="perf.html">Próximo: Performance</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: index.html,v 1.36 ]<br>
$Translation: logging.html,v 1.12 2009/03/11 00:52:56 dsantos Exp $<br>
-->
$OpenBSD: logging.html,v 1.12 2009/03/16 20:24:23 tobias Exp $
</small>

</body>
</html>
