<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Exemplo: Firewall para Casa ou Pequeno Escrit&oacute;rio</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description" content="the OpenBSD FAQ page">
<meta name="keywords" content="openbsd,faq,pf">
<meta name="distribution" content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>

<p>
[<a href="carp.html">Anterior: Redund&acirc;ncia de Firewall com CARP e pfsync</a>]
[<a href="index.html">Conte&uacute;do</a>]

<p>
<h1><font color="#e00000">PF: Exemplo: Firewall para Casa ou Pequeno Escrit&oacute;rio</font></h1>
<hr>

<h3>Conte&uacute;do</h3>
<ul>
<li><a href="#scenario">O Cen&aacute;rio</a>
	<ul>
	<li><a href="#network">A Rede</a>
	<li><a href="#objective">Objetivo</a>
	<li><a href="#prep">Prepara&ccedil;&atilde;o</a>
	</ul>
<li><a href="#ruleset">As Regras</a>
	<ul>
	<li><a href="#macros">Macros</a>
	<li><a href="#options">Op&ccedil;&otilde;es</a>
	<li><a href="#scrub">Scrub</a>
	<li><a href="#nat">Tradu&ccedil;&atilde;o do Endere&ccedil;o de Rede (NAT)</a>
	<li><a href="#rdr">Redirecionamento</a>
	<li><a href="#filter">Regras de Filtragem</a>
	</ul>
<li><a href="#allrules">O Arquivo Completo</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>O Cen&aacute;rio</h2>
Neste exemplo, PF est&aacute; rodando numa m&aacute;quina OpenBSD 
agindo como firewall e gateway NAT para uma pequena rede em casa ou 
escrit&oacute;rio. O objetivo geral &eacute; prover acesso &agrave; 
Internet para a rede interna e acesso limitado
ao firewall pela Internet, e ainda disponibilizar para acesso externo
um servidor web localizado na rede Interna. Este documento o 
guiar&aacute; na cria&ccedil;&atilde;o de um conjunto de regras para 
esse fim.

<a name="network"></a>
<h3>A Rede</h3>
A rede est&aacute; configurada da seguinte forma:

<pre>   
 
  [ COMP1 ]    [ COMP3 ]
      |            |
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
Existem v&aacute;rios computadores na rede interna; o diagrama mostra apenas
tr&ecirc;s, mas o n&uacute;mero real &eacute; irrelevante.  Estes computadores 
s&atilde;o esta&ccedil;&otilde;es de trabalho usadas para navegar na Internet, 
ler email, chat, etc., exceto COMP3 que tamb&eacute;m roda um pequeno servidor 
web.
A rede interna usa a faixa de ips 192.168.0.0 / 255.255.255.0.

<p>
O firewall OpenBSD &eacute; um Celeron 300 com duas placas de rede: 
uma 3com 3c905B (<tt>xl0</tt>) e uma Intel EtherExpress Pro/100 
(<tt>fxp0</tt>).
Ele possui uma conex&atilde;o Internet a Cabo e faz NAT para 
compartilhar o acesso com a rede interna. O endere&ccedil;o IP na 
interface externa &eacute; atribu&iacute;do dinamicamente pelo 
Provedor de Acesso Internet.

<a name="objective"></a>
<h3>Objetivo</h3>
Os Objetivos s&atilde;o:
<ul>
<li>Prover acesso irrestrito &agrave; Internet para a rede interna.
<li>Usar "negar por padr&atilde;o" como pol&iacute;tica padr&atilde;o 
de regras.
<li>Permitir o seguinte tr&aacute;fego vindo da Internet para o firewall:
	<ul>
	<li>SSH (porta TCP 22): ser&aacute; utilizado para 
	manuten&ccedil;&atilde;o remota do firewall.
	<li>Auth/Ident (porta TCP 113): utilizado por alguns 
	servi&ccedil;os como SMTP e IRC.
	<li>ICMP Echo Requests: o tipo de pacote ICMP usado pelo comando 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
>ping(8)</a>.
	</ul>
<li>Redirecionar tentativas de conex&atilde;o na porta 80 TCP (que 
s&atilde;o tentativas de conex&atilde;o a um servidor web) para o 
computador COMP3.
Tamb&eacute;m permitir trafego TCP porta 80 destinado a COMP3 
atrav&eacute;s do firewall.
<li>Logar estat&iacute;sticas de filtragem na interface externa.
<li>Por padr&atilde;o, responder com um TCP RST ou ICMP Unreachable para 
pacotes bloqueados.
<li>Tornar as regras o mais simples poss&iacute;vel, para facilitar a
manuten&ccedil;&atilde;o.</ul>

<a name="prep"></a>
<h3>Prepara&ccedil;&atilde;o</h3>
Este documento assume que o host OpenBSD tenha sido corretamente 
configurado para funcionar como roteador, incluindo 
configura&ccedil;&atilde;o de endere&ccedil;os IP, conectividade com a 
Internet e defini&ccedil;&atilde;o de variaveis
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> <tt>net.inet.ip.forwarding</tt> e/ou
<tt>net.inet6.ip6.forwarding</tt> para "<tt>1</tt>".
Tamb&eacute;m &eacute; necess&aacute;rio que voc&ecirc; tenha ativado 
o PF usando <a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.1"
>pfctl(8)</a> ou definindo a vari&aacute;vel apropriada em
<tt>/etc/rc.conf.local</tt>.

<a name="ruleset"></a>
<h2>As regras</h2>
A seguir um passo a passo atrav&eacute;s das regras que realizar&atilde;o os 
objetivos acima descritos.

<a name="macros"></a>
<h3>Macros</h3>
As seguintes macros s&atilde;o definidas para facilitar a leitura e 
manuten&ccedil;ao das regras:
<blockquote>
<tt>
ext_if="fxp0"<br>
int_if="xl0"<br>
<br>
tcp_services = "{ 22, 113 }"<br>
icmp_types = "echoreq"<br>
<br>
comp3="192.168.0.3"
</tt>
</blockquote>

<p>
As primeiras duas linhas definem a interface de rede onde a filtragem 
acontecer&aacute;. 
Definindo elas aqui, se precisarmos mover este sistema
para outra m&aacute;quina com hardware diferente, n&oacute;s
trocamos apenas estas duas linhas e o resto das regras 
continuar&aacute; a mesma.

A terceira e quarta linhas listam os n&uacute;meros 
de portas TCP dos servi&ccedil;os que ser&atilde;o abertos para a 
internet (SSH e ident/auth) e os tipos de pacotes ICMP que 
ter&atilde;o permiss&atilde;o de alcan&ccedil;ar a m&aacute;quina do 
firewall. 
Finalmente, a &uacute;ltima linha define o endere&ccedil;o IP de COMP3.

<p>
<b>Nota</b>: Caso a conex&atilde;o com a Internet necessite
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8"
>PPPoE</a>, ent&atilde;o, filtragem e NAT devem acontecer na interface 
<tt>tun0</tt> <i>n&atilde;o</i> em <tt>fxp0</tt>.

<a name="options"></a>
<h3>Op&ccedil;&otilde;es</h3>
As duas op&ccedil;&otilde;es seguintes definem a resposta padr&atilde;o
<tt>block</tt> para regras de filtragem, e fazem com que sejam logadas
estat&iacute;sticas de filtragem (statistics logging "on") para a 
interface externa:
<blockquote>
<tt>
set block-policy return<br>
set loginterface $ext_if
</tt>
</blockquote>

<p>
Todo sistema Unix possui uma interface "loopback".
&Eacute; uma interface de rede virtual que &eacute; utilizada por
aplica&ccedil;&otilde;es para conversarem entre si dentro do sistema.
No OpenBSD, a interface loopback &eacute;
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
&Eacute; recomendado desabilitar qualquer filtragem nas interfaces
loopback.
Usando <a href="options.html#skip">set skip</a> para isto.
<blockquote>
<tt>
set skip on lo
</tt>
</blockquote>
Note que n&oacute;s estamos usando skip no grupo de interface 
<tt>lo</tt> inteiro, desta maneira n&oacute;s podemos, mais tarde,
adicionar interfaces loopback adicionais e n&atilde;o precisamos
nos preocupar em alterar esta parte do nosso arquivo de regras.

<a name="scrub"></a>
<h3>Scrub</h3>
N&atilde;o h&aacute; raz&atilde;o para n&atilde;o utilizar scrubbing, 
recomendado para todo tr&aacute;fego entrante, portanto aplicamos a 
regra com uma simples linha:
<blockquote>
<tt>
scrub in
</tt>
</blockquote>

<a name="nat"></a>
<h3>Tradu&ccedil;&atilde;o do Endere&ccedil;o de Rede (NAT)</h3>
Para fazer NAT para toda a rede interna a seguinte regra
<tt>nat</tt> ser&aacute; usada:
<blockquote>
<tt>
nat on $ext_if from !($ext_if) to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
O "<tt>!($ext_if)</tt>" pode ser substitu&iacute;do por 
"<tt>$int_if</tt>" neste caso, mas caso voc&ecirc; tenha 
m&uacute;ltiplas interfaces precisar&aacute; adicionar mais regras 
NAT, ao passo que, com esta estrutura o NAT ser&aacute; feito em 
todas as interfaces protegidas.

<p>
J&aacute; que o endere&ccedil;o IP da interface externa &eacute; 
atribu&iacute;do dinamicamente, par&ecirc;nteses devem ser colocados 
em volta da interface, assim o PF notar&aacute; qualquer 
altera&ccedil;&atilde;o no endere&ccedil;o.

<p>
Como queremos que o proxy FTP funcione, adicionaremos uma 
<a href="anchors.html">&acirc;ncora</a> NAT tamb&eacute;m:

<blockquote>
<tt>
nat-anchor "ftp-proxy/*"
</tt>
</blockquote>


<a name="rdr"></a>
<h3>Redirecionamento</h3>
As primeiras regras de redirecionamento necess&aacute;rias s&atilde;o 
para o
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.1"
>ftp-proxy(8)</a> 
assim, clientes FTP na rede interna local, poder&atilde;o se conectar 
a servidores FTP na Internet.
<blockquote>
<tt>
rdr-anchor "ftp-proxy/*"<br>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Note que esta regra funcionar&aacute; apenas com conex&otilde;es 
destinadas &agrave; porta 21.
Caso usu&aacute;rios se conectem a servidores FTP em outras portas, 
ent&atilde;o uma lista deve ser utilizada para especificar as portas 
de destino, por exemplo: <tt>from any to any port { 21, 2121 }</tt>.

<p>
As &uacute;ltimas regras de redirecionamento pegam qualquer tentativa 
de conex&atilde;o vinda da Internet em dire&ccedil;&atilde;o &agrave; 
porta 80 TCP no firewall.
Tentativas de conex&otilde;es leg&iacute;timas nesta porta 
ser&atilde;o de usu&aacute;rios tentando acessar o servidor web da rede.
Estas conex&otilde;es devem ser redirecionadas para COMP3:

<blockquote>
<tt>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
</tt>
</blockquote>

<a name="filter"></a>
<h3>Regras de Filtragem</h3>
Agora as regras de filtragem. Come&ccedil;ando com negar por 
padr&atilde;o:
<blockquote>
<tt>
block in<br>
</tt>
</blockquote>

<p>
Neste ponto todo tr&aacute;fego tentando entrar em uma interface 
ser&aacute; bloqueado, mesmo estes da interface de rede interna.
As regras seguintes abrem o firewall de acordo com os objetivos acima 
descritos, bem como quaisquer interfaces virtuais que se fa&ccedil;am 
necess&aacute;rias.

<p>
Tenha em mente que o pf pode bloquear tr&aacute;fego entrando e saindo 
de uma interface.
Para simplificar sua vida voc&ecirc; pode escolher fazer a filtragem de
tr&aacute;fego em apenas uma dire&ccedil;&atilde;o ao inv&eacute;s de 
bloquear entrada e sa&iacute;da.
Em nosso caso optamos por filtrar tr&aacute;fego entrando na interface, 
uma vez filtrada a entrada, n&atilde;o tentaremos obstruir sua s
a&iacute;da, portanto faremos o seguinte:

<blockquote>
<tt>
pass out keep state
</tt>
</blockquote>

<p>
Precisamos ter uma <a href="anchors.html">&acirc;ncora</a> 
para o ftp-proxy(8):

<blockquote>
<tt>
anchor "ftp-proxy/*"
</tt>
</blockquote>

<p>
&Eacute; bom usar tamb&eacute;m a 
<a href="filter.html#antispoof">prote&ccedil;&atilde;o antispoof</a>:

<blockquote>
<tt>
antispoof quick for { lo $int_if }
</tt>
</blockquote>

<p>
Agora abrimos as portas usadas pelos servi&ccedil;os que estar&atilde;o
dispon&iacute;veis para a Internet.
Primeiro, o tr&aacute;fego que &eacute; destinado ao firewall em si:

<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>

<p>
Especificando as portas na macro <tt>$tcp_services</tt> simplifica a
abertura de servi&ccedil;os adicionais para a Internet atrav&eacute;s da
simples edi&ccedil;&atilde;o da macro e recarregamento das regras.
Servi&ccedil;os UDP tamb&eacute;m podem ser abertos com a 
cria&ccedil;&atilde;o de uma macro <tt>$udp_services</tt> e 
adi&ccedil;&atilde;o de uma regra de filtragem similar &agrave; 
anterior, que especifique <tt>proto udp</tt>.

<p>
Al&eacute;m de ter uma regra <tt>rdr</tt> que redireciona o 
tr&aacute;fego do servidor web para COMP3, ainda PRECISAMOS
permitir a passagem do tr&aacute;fego atrav&eacute;s do firewall:
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to $comp3 port 80 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;flags S/SA synproxy state
</tt>
</blockquote>

<p>
Para aumentar um pouco a seguran&ccedil;a, faremos uso de 
<a href="filter.html#synproxy">TCP SYN Proxy</a> com intuito de 
proteger o servidor web.

<p>
Tr&aacute;fego ICMP precisa ser permitido:
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>

<p>
Similar &agrave; macro <tt>$tcp_services</tt>, a macro 
<tt>$icmp_types</tt> pode ser facilmente editada para alterar os tipos 
de pacotes ICMP que ter&atilde;o permiss&atilde;o de passar pelo 
firewall. Note que esta regra se aplica a todas interfaces de rede.

<p>
Agora o tr&aacute;fego deve passar "de" e "para" a interface interna.
Assumiremos que os usu&aacute;rios da rede interna sabem o que 
est&atilde;o fazendo e n&atilde;o nos causar&atilde;o problemas.  Esta 
n&atilde;o &eacute; necessariamente uma suposi&ccedil;&atilde;o 
v&aacute;lida; um conjunto de regras muito mais restritivo pode ser 
apropriado para muitos ambientes.
<blockquote>
<tt>
pass in quick on $int_if
</tt>
</blockquote>

<p>
Tr&aacute;fego TCP, UDP e ICMP pode sair do firewall com destino 
&agrave; Internet de acordo com a regra "<tt>pass out keep state</tt>"
anterior.
A informa&ccedil;&atilde;o de estado das conex&otilde;es &eacute; 
mantida de forma que pacotes que retornam passar&atilde;o pelo firewall.

<a name="allrules"></a>
<h2>O Conjunto Completo de Regras</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros
ext_if="fxp0"
int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"

# op&ccedil;&otilde;es
set block-policy return
set loginterface $ext_if

set skip on lo

# scrub
scrub in

# nat/rdr
nat on $ext_if from !($ext_if) -> ($ext_if:0) 
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"

rdr pass on $int_if proto tcp to port ftp -> 127.0.0.1 port 8021
rdr on $ext_if proto tcp from any to any port 80 -> $comp3

# regras de filtragem
block in

pass out keep state

anchor "ftp-proxy/*" 
antispoof quick for { lo $int_if }

pass in on $ext_if inet proto tcp from any to ($ext_if) \
   port $tcp_services flags S/SA keep state

pass in on $ext_if inet proto tcp from any to $comp3 port 80 \
   flags S/SA synproxy state 

pass in inet proto icmp all icmp-type $icmp_types keep state

pass quick on $int_if

</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Anterior: Redund&acirc;ncia de Firewall com CARP e pfsync</a>]
[<a href="index.html">Conte&uacute;do</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.32 ]<br>
$Translation: example1.html,v 1.8 2007/06/21 23:41:17 dsantos Exp $<br>
-->
$OpenBSD: example1.html,v 1.8 2007/06/23 18:29:30 jufi Exp $ 
</small>

</body>
</html>
