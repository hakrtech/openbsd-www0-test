<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Registros de bitácora</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2007, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141"
src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="tagging.html">Anterior: Marcado de
paquetes</a>]
[<a href="index.html">Contenido</a>]
[<a href="perf.html">Siguiente: Rendimiento</a>]

<p>
<h1><font color="#e00000">PF: Registros de bitácora</font></h1>

<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#intro">Introducción</a>
<li><a href="#log">Registro de paquetes</a>
<li><a href="#logfile">Interpretación de un fichero de
registro</a>
<li><a href="#filter">Filtrado de la salida de registro</a>
<li><a href="#syslog">Registro de paquetes con syslog</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introducción</h2>
<p>
Cuando PF registra un paquete, se envía una copia de la cabecera del 
paquete a la interfaz <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4&amp;manpath=OpenBSD+4.8"
>pflog(4)</a>, junto con algunos 
datos adicionales tales como la interfaz por la que 
ha transitado el paquete, la acción que PF adoptó (permitir o bloquear), etc. 
La interfaz pflog(4) permite que las aplicaciones en espacio de usuario 
reciban los datos de registro PF del núcleo. Si PF 
está activado cuando el sistema arranca, el demonio 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>pflogd(8)</a> 
se inicia. De forma predeterminada pflogd(8) escucha en el interfaz 
<tt>pflog0</tt> y escribe todos los registros de bitácora en el fichero 
<tt>/var/log/pflog</tt>.

<a name="log"></a>
<h2>Registro de paquetes</h2>
<p>
Para registrar los paquetes que pasan a través de PF, debe usarse
la palabra-clave <tt>log</tt>. La palabra clave <tt>log</tt> hace 
que se registren todos los paquetes que concuerden con la regla. 
En el caso de que la regla <a href="filter.html#state">cree estado</a>, 
solo se registra el primer paquete visto (o el que hace que se cree el 
estado).

<p>
Las opciones que pueden pasarse a la palabra-clave <tt>log</tt> son:

<dl>
<dt><tt>all</tt>
<dd>Hace que todos los paquetes concordantes, no solo el paquete inicial,
serán registrados.
Útil para reglas que crean estado.

<dt><tt>to <i>pflogN</i></tt>
<dd>Hace que todos los paquetes concordantes sean registrados 
por la interfaz pflog(4) especificada. 
Por ejemplo, cuando se utiliza 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamlogd&amp;sektion=8"
>spamlogd(8)</a> todo el tráfico SMTP puede ser registrado por PF
en una interfaz pflog(4) dedicada. El demonio spamlogd(8) puede
entonces ser configurado para que escuche en esa interfaz.  Esto permite
mantener a la bitácora de registro principal de PF libre de tráfico SMTP 
que no precisaría ser registrado. 
Utilice <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a> para crear interfaces pflog(4). 
La interfaz de registro predeterminado <tt>pflog0</tt> 
se crea automáticamente.

<dt><tt>user</tt>
<dd>Hace que el identificador de usuario y de grupo de UNIX al que pertenece 
el <i>socket</i> del origen/destino del paquete (cualquier <i>socket</i> 
local) sea registrado junto con la información de bitácora estándar.
</dl>

<p>
Las opciones se dan entre paréntesis después de la palabra-clave <tt>log</tt>; 
pueden pasarse varias opciones separadas por una coma o un espacio.

<blockquote>
<tt>
pass in log (all, to pflog1) on $ext_if inet proto tcp to $ext_if port 22 keep state
</tt>
</blockquote>


<a name="logfile"></a>
<h2>Interpretación de un fichero de registro</h2>
<p>
El fichero de registro grabado por pflogd se encuentra en formato
binario, y no se puede leer usando un editor de texto.  Hay que usar
tcpdump para ver el registro.

<p>
Para poder leer el fichero de registro:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Nótese que el uso de tcpdump para leer el fichero pflog <i>no</i>
ofrece una visión en tiempo real.  Para obtener una visión
en tiempo real de los paquetes registrados, hay que usar la interfaz
<tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">NOTA: </font>
Cuando se examinan los registros, hay que tener un cuidado especial con
la descodificación verbosa del protocolo por parte de tcpdump
(activada mediante la opción <tt>-v</tt> en la línea de
órdenes).  Los descodificadores del protocolo de tcpdump no
tienen un historial de seguridad perfecto.  En teoría, existe la
posibilidad de un ataque retardado a través de las cargas
útiles (<i>payloads</i>) parciales de los paquetes registrados
por el dispositivo de registro.  En la práctica se recomienda
trasladar los ficheros de registro desde la máquina de
cortafuegos a otra máquina antes de examinarlos de esta forma.

<p>
También hay que tener un cuidado adicional al asegurar el acceso
a los registros.  pflogd registra 96 bytes del paquete en el fichero de
registro en el modo predeterminado.  El acceso a los registros
podría pemitir acceso parcial a cargas útiles de paquetes
sensibles (como los nombres de usuario y contraseñas de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1"
>telnet(1)</a> o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1"
>ftp(1)</a>).

<a name="filter"></a>
<h2>Filtrado de la salida de registro</h2>
<p>
Como pflogd efectúa los registros en formato binario de tcpdump,
se pueden usar todas las funcionalidades de tcpdump para revisar los
registros.  Por ejemplo, para ver solamente los paquetes que concuerden
con un cierto puerto:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Esto se puede refinar aún más limitando la cantidad de
paquetes que mostrará a los que concuerden con una
combinación de un cierto anfitrión y puerto:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
Se puede aplicar la misma idea cuando se lee desde la interfaz <tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Nótese que esto no tiene ningún impacto sobre qué
paquetes se registran en el fichero de registro de pflogd.  Las
órdenes anteriores sólo muestran los paquetes que
están siendo registrados en ese momento.

<p>
Además de usar las reglas de filtrado estándar de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8"
>tcpdump(8)</a>, el lenguaje de filtrado de tcpdump se ha extendido 
para que pueda leer la salida de pflogd:
<ul>
<li><tt>ip</tt> - la familia de direcciones es IPv4.
<li><tt>ip6</tt> - la familia de direcciones es IPv6.
<li><tt>on <i>int</i></tt> - el paquete ha pasado por la interfaz
<i>int</i>.
<li><tt>ifname <i>int</i></tt> - lo mismo que <tt>on <i>int</i></tt>.
<li><tt>ruleset <i>name</i></tt> - el  
<a href="anchors.html">conjunto de reglas/anclaje</a> con el que concordó 
el paquete.
<li><tt>rulenum <i>num</i></tt> - la regla de filtrado con la que ha
concordado el paquete es la regla número <i>num</i>.
<li><tt>action <i>act</i></tt> - la acción que se ha tomado en el
paquete.  Las acciones pueden ser <tt>pass</tt> o <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - el motivo por el que se ha tomado la
acción, <tt>action</tt>.  Los motivos pueden ser <tt>match</tt>, 
<tt>bad-offset</tt>, <tt>fragment</tt>, <tt>short</tt>, <tt>normalize</tt>,
<tt>memory</tt>, <tt>bad-timestamp</tt>,
<tt>congestion</tt>, <tt>ip-option</tt>, <tt>proto-cksum</tt>,
<tt>state-mismatch</tt>, <tt>state-insert</tt>, <tt>state-limit</tt>,
<tt>src-limit</tt> y <tt>synproxy</tt>.
<li><tt>inbound</tt> - el paquete era un paquete entrante.
<li><tt>outbound</tt> - el paquete era un paquete saliente.
</ul>

<p>
Ejemplo:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Esto muestra el registro, en tiempo real, de los paquetes entrantes que
han sido bloqueados en la interfaz wi0.

<a name="syslog"></a>
<h2>Registro de paquetes con syslog</h2>
<p>
Hay muchas situaciones en las que es deseable tener los registros del
cortafuegos en formato ASCII (texto simple) y/o enviarlos a un servidor
de registros remoto.  Todo esto se puede conseguir con un
pequeño guión (<i>script</i>), algunos cambios 
menores en los ficheros de configuración de OpenBSD y 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8"
>syslogd(8)</a>, el servicio (demonio) de registro de bitácoras.
Syslogd realiza los registros en formato ASCII y también puede
efectuar los registros en un servidor de registros remoto.

<p>
Hay que crear el siguiente guión de ejecución:

<p>
<tt>/etc/pflogrotate</tt>
<pre>
	#!/bin/sh
	PFLOG=/var/log/pflog
	FILE=/var/log/pflog5min.$(date "+%Y%m%d%H%M")
	pkill -ALRM -u root -U root -t - -x pflogd
	if [ -r $PFLOG ] && [ $(stat -f %z $PFLOG) -gt 24 ]; then
	   mv $PFLOG $FILE
	   pkill -HUP -u root -U root -t - -x pflogd
	   tcpdump -n -e -ttt -r $FILE | logger -t pf -p local0.info
	   rm $FILE
	fi
</pre>

<p>
Editar la tarea de cron del usuario <i>root</i>:
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Añadir las dos siguientes líneas:
<blockquote>
<tt>
# rotate pf log file every 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Añadir la siguiente línea a <tt>/etc/syslog.conf</tt>:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Si también se quiere efectuar los registros en un servidor de
registros remoto, hay que añadir la línea:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Hay que asegurarse de que el anfitrión <i>syslogger</i> se
encuentre definido en el fichero
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5"
>hosts(5)</a>.

<p>
Crear el fichero <tt>/var/log/pflog.txt</tt> para que syslog pueda
escribir registros en él y darle los mismos permisos que al fichero pflog:
<blockquote>
<tt>
# touch /var/log/pflog.txt<br>
# chmod 600 /var/log/pflog.txt
</tt>
</blockquote>

<p>
Para que syslogd tenga constancia de estos cambios hay que reiniciarlo:
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Ahora todos los paquetes registrados son enviados a
<tt>/var/log/pflog.txt</tt>.  Si se añade la segunda
línea, también se envían al anfitrión de
registros remotos <i>syslogger</i>.

<p>
Ahora, el guión <tt>/etc/pflogrotate</tt> procesa y luego elimina
<tt>/var/log/pflog</tt>, de modo que ya no es necesaria la
rotación de <tt>pflog</tt> por
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8"
>newsyslog(8)</a>,
y debe ser desactivada.  Sin embargo, <tt>/var/log/pflog.txt</tt>
sustituye a <tt>/var/log/pflog</tt> y hay que activar su
rotación.  Para ello hay que realizar los siguientes cambios en
el fichero <tt>/etc/newsyslog.conf</tt>:
<pre>
    #/var/log/pflog       600    3    250    *    ZB "pkill -HUP -u root -U root -t - -x pflogd"
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
Ahora PF realizará los registros en formato ASCII en el fichero
<tt>/var/log/pflog.txt</tt>.  Y <tt>/etc/syslog.conf</tt> enviará
los registros a un servidor remoto si ha sido configurado para que lo
haga.  El registro no es inmediato, y puede tardar entre 5 y 6 minutos
(el intervalo de la tarea de cron) antes de que los paquetes registrados
aparezcan en el fichero.

<p>
[<a href="tagging.html">Anterior: Marcado de
paquetes</a>]
[<a href="index.html">Contenido</a>]
[<a href="perf.html">Siguiente: Rendimiento</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: logging.html,v 1.42 ]<br>
$Translation: logging.html,v 1.13 2011/03/05 14:22:40 mvidal Exp $<br>
-->
$OpenBSD: logging.html,v 1.11 2011/03/13 07:16:15 ajacoutot Exp $
</small>

</body>
</html> 
