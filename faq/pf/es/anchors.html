<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Anclajes</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="options.html">Anterior: Opciones en tiempo de ejecución</a>]
[<a href="index.html">Contenido</a>]
[<a href="queueing.html">Siguiente: Formación de colas y
prioridades de paquetes</a>]

<p>
<h1><font color="#e00000">PF: Anclajes</font></h1>

<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#intro">Introducción</a>
<li><a href="#anchors">Anclajes</a>
<li><a href="#options">Opciones de anclaje</a>
<li><a href="#manip">Manipulación de anclajes</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introducción</h2>
<p>
Además del conjunto de reglas principal, PF también puede
evaluar subconjuntos de reglas.  Los subconjuntos de reglas se pueden
manipular al vuelo usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>pfctl(8)</a>,
para lo que disponen de un modo conveniente para alterar
dinámicamente un conjunto de reglas activo.  Mientras que una
<a href="tables.html">tabla</a> se usa para contener una lista
dinámica de direcciones, un subconjunto de reglas se usa para
contener un conjunto dinámico de reglas de filtrado.
Estos subconjuntos de reglas van ligados al conjunto de reglas 
principal mediante el uso de anclajes (<tt>anchor</tt>).

<p>
Los anclajes pueden anidarse, lo que permite que al subconjunto 
de reglas ir encadenado juntamente. 
Las reglas de anclaje serán evaluadas en relación con el
anclaje que las carga. 
Por ejemplo, las reglas de anclaje en el conjunto de reglas 
principal crearán puntos vinculados con el conjunto de reglas 
principal como padre, y las reglas de anclaje 
cargadas de ficheros invocados por medio de la directiva 
<tt>load anchor</tt> crearán puntos de anclaje definiendo ese 
anclaje como padre. 

<a name="named"></a>
<a name="anchors"></a>
<h2>Anclajes</h2>
<p>
Un anclaje es una agrupación de reglas de filtrado, tablas y otros
anclajes a la que se ha asignado un nombre.  
Cuando PF se encuentra con una regla <tt>anchor</tt> en el conjunto 
principal de reglas, evalúa las reglas contenidas en ese punto de 
anclaje tal y como evalúa las reglas en el conjunto de reglas principal.
Entonces continúa el procesamiento en el conjunto de reglas principal, 
a menos que el paquete concuerde con una regla de filtrado que use la opción
<tt>quick</tt>, en cuyo caso la búsqueda de concordancia se
considerará finalizada y terminará la evaluación de
las reglas, tanto en el anclaje como en el conjunto de reglas principal.

<p>
Por ejemplo:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if<br>
pass &nbsp;out on $ext_if<br>
anchor goodguys
</tt>
</blockquote>

<p>
En este conjunto de reglas se ha definido una política de
denegación predeterminada en <tt>fxp0</tt>, tanto para el
tráfico entrante como para el saliente.  
A continuación se permite pasar el tráfico, manteniendo el estado, 
y se crea una regla de anclaje con el nombre de <tt>goodguys</tt>.  
Hay tres métodos para llenar con reglas los anclajes:
<ul>
<li>usando un regla <tt>load</tt>
<li>usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>pfctl(8)</a>
<li>especificando las reglas directamente en el conjunto 
de reglas principal
</ul>

<p>
La regla <tt>load</tt> hace que <tt>pfctl</tt> llene el anclaje 
especificado leyendo las reglas desde un
fichero de texto.  Ejemplo:
<blockquote>
<tt>
anchor goodguys<br>
load anchor goodguys from "/etc/anchor-goodguys-ssh"
</tt>
</blockquote>

<p>
Para añadir reglas a un anclaje con <tt>pfctl</tt>, se puede
emplear una orden parecida a la siguiente:
<blockquote>
<tt>
# echo "pass in proto tcp from 192.0.2.3 to any port 22" \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys -f -
</tt>
</blockquote>

<p>
También es posible guardar y cargar las reglas desde un fichero
de texto:
<blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
Para cargar las reglas directamente desde un conjunto de reglas
principal, sitúe las reglas de anclaje en un bloque delimitado por 
llaves:

<blockquote>
<tt>
anchor "goodguys" { <br>
&nbsp;&nbsp;&nbsp;pass in proto tcp from 192.168.2.3 to port 22<br>
}
</tt>
</blockquote>

Los anclajes delimitados de esta manera pueden contener otros
anclajes:

<blockquote>
<tt>
allow = "{ 192.0.2.3 192.0.2.4 }" <br>
<br>
anchor "goodguys" { <br>
&nbsp;&nbsp;&nbsp;anchor { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass in proto tcp from 192.0.2.3 to port 80 <br>
&nbsp;&nbsp;&nbsp;} <br>
&nbsp;&nbsp;&nbsp;pass in proto tcp from $allow to port 22<br>
}
</tt>
</blockquote>

Con anclajes especificados directamente, el nombre del anclaje se convierte 
en opcional. Nótese que el anclaje anidado del ejemplo anterior no tiene nombre.
Tenga en cuenta también que la macro <tt>$allow</tt> se crea fuera del 
anclaje (en el conjunto de reglas principal) y entonces se utiliza dentro del 
anclaje.

<p>
Las reglas se pueden cargar en un anclaje, usando la misma sintaxis 
y opciones que para las reglas cargadas en el conjunto de reglas principal.  
Sin embargo, hay que tener en cuenta que, excepto que esté
usando anclajes directamente, cualquier
<a href="macros.html">macro</a> que esté siendo utilizada debe
ser definida en el anclaje mismo; las macros que se encuentran 
definidas en el conjunto de reglas principal
<i>no</i> son visibles desde el anclaje.

<p>
Dado que los anclajes pueden anidarse, es posible especificar que
todos los anclajes-hijo dentro de un anclaje específico 
sea evaluado:

<blockquote>
<tt>
anchor "spam/*"
</tt>
</blockquote>

<p>
Esta sintaxis hace que se evalúe cada regla vinculada al anclaje 
<tt>spam</tt>. Los anclajes-hijo serán evaluados en orden alfabético, 
pero no se recorren de forma recursiva. 
Los anclajes se evalúan siempre relativos al anclaje 
en el que están definidos.

<p>
Cada anclaje, así como el conjunto de reglas principal, 
existe de forma independiente de los otros conjuntos
de reglas.  Las operaciones que se realicen en un conjunto de reglas,
como la limpieza de las reglas, no afecta a ninguno de los otros
conjuntos.  Además, si se elimina un punto de anclaje del
conjunto de reglas principal, no se destruye el anclaje ni cualquier
subconjunto de reglas con nombre que esté adjunto a ese anclaje.
Un anclaje no se destruye hasta que se han
limpiado todas las reglas usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>pfctl(8)</a> y no existan anclajes-hijo dentro del anclaje.


<a name="options"></a>
<h2>Opciones de anclaje</h2>
<p>
De modo opcional, las reglas <tt>anchor</tt> pueden especificar una
interfaz, un protocolo, una dirección de origen y destino, una marca, etc..
mediante la misma sintaxis que las reglas de filtrado.  Cuando se da este
tipo de información, las reglas <tt>anchor</tt> sólo se
procesan si el paquete concuerda con la definición de la regla
<tt>anchor</tt>.  Por ejemplo:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if<br>
pass &nbsp;out on $ext_if<br>
anchor ssh in on $ext_if proto tcp to port 22<br>
</tt>
</blockquote>

<p>
Las reglas en el anclaje <tt>ssh</tt> solo se evalúan para
los paquetes TCP destinados al puerto 22 que entran en la interfaz
<tt>fxp0</tt>.  Entonces se añaden las reglas al <tt>anchor</tt>,
del siguiente modo:
<blockquote>
<tt>
# echo "pass in from 192.0.2.10 to any" | pfctl -a ssh -f -
</tt>
</blockquote>

<p>
Por lo tanto, aunque la regla de filtrado no especifique una interfaz,
un protocolo, o un puerto, al anfitrión 192.0.2.10 sólo se
le permitirá conectar usando SSH, de acuerdo con la
definición de la regla <tt>anchor</tt>.

<p>
La misma sintaxis puede aplicarse a los anclajes especificados
directamente:

<blockquote>
<tt>
allow = "{ 192.0.2.3 192.0.2.4 }" <br>
<br>
anchor "goodguys" in proto tcp { <br>
&nbsp;&nbsp;&nbsp;anchor proto tcp to port 80 { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass from 192.0.2.3 <br>
&nbsp;&nbsp;&nbsp;} <br>
&nbsp;&nbsp;&nbsp;anchor proto tcp to port 22 { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass from $allow<br>
&nbsp;&nbsp;&nbsp;} <br>
}
</tt>
</blockquote>


<a name="manip"></a>
<h2>Manipulación de anclajes</h2>
<p>
La manipulación de anclajes se realiza mediante <tt>pfctl</tt>.  
Se puede usar para añadir y eliminar reglas de un anclaje 
sin recargar el conjunto de reglas principal.

<p>
Para ver una lista de todas las reglas en un anclaje llamado 
<tt>ssh</tt>:
<blockquote>
<tt>
# pfctl -a ssh -s rules
</tt>
</blockquote>

<p>
Para limpiar todas las reglas de filtrado de este mismo anclaje:
<blockquote>
<tt>
# pfctl -a ssh -F rules
</tt>
</blockquote>

<p>
Para una lista completa de órdenes, véase
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>pfctl(8)</a>.

<p>
[<a href="options.html">Anterior: Opciones en tiempo de ejecución</a>]
[<a href="index.html">Contenido</a>]
[<a href="queueing.html">Siguiente: Formación de colas y
prioridades de paquetes</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: anchors.html,v 1.29 ]<br>
$Translation: anchors.html,v 1.13 2011/02/28 18:10:28 mvidal Exp $<br>
-->
$OpenBSD: anchors.html,v 1.11 2011/03/04 16:16:15 ajacoutot Exp $
</small>

</body>
</html> 
