<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Anclajes y Subgrupos de Reglas con Nombre</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta http-equiv="Content-Language" content="es">
<meta name="resource-type" content="document">
<meta name="description"   content="Preguntas Frecuentes de OpenBSD">
<meta name="keywords"      content="openbsd,preguntas frecuentes,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="Este documento es copyright 2003 de OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif">
<p>
[<a href="logging.html">Anterior: Registros de Bit&aacute;cora</a>]
[<a href="index.html">Contenido</a>]
[<a href="shortcuts.html">Siguiente: Atajos para la Creaci&oacute;n de
Grupos de Reglas</a>]

<p>
<h1><font color="#e00000">PF: Anclajes y Subgrupos de Reglas con
Nombre</font></h1>

<hr>

<h3>&Iacute;ndice de Contenidos</h3>
<ul>
<li><a href="#intro">Introducci&oacute;n</a>
<li><a href="#named">Subgrupos de Reglas con Nombre</a>
<li><a href="#options">Opciones de Anclaje</a>
<li><a href="#manip">Manipulaci&oacute;n de Subgrupos de Reglas con
Nombre</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introducci&oacute;n</h2>
<p>
Adem&aacute;s del grupo de reglas principal, PF tambi&eacute;n puede
evaluar subgrupos de reglas.  Los subgrupos de reglas se pueden
manipular sobre la marcha usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3"><tt>pfctl(8)</tt></a>,
para lo que disponen de un modo conveniente para alterar
din&aacute;micamente un grupo de reglas activo.  Mientras que una
<a href="tables.html">tabla</a> se usa para contener una lista
din&aacute;mica de direcciones, un subgrupo de reglas se usa para
contener un grupo din&aacute;mico de reglas de filtrado, <tt>nat</tt>,
<tt>rdr</tt>, y <tt>binat</tt>.

<p>
Estos subgrupos de reglas van ligados al grupo de reglas principal
mediante el uso de reglas de anclaje;  las reglas de anclaje se crean
con la clave <tt>anchor</tt>:
<ul>
<li><tt>anchor <i>nombre</i></tt> - eval&uacute;a todas las
<a href="filter.html">reglas de filtrado</a> en el anclaje
<i><tt>nombre</tt></i>
<li><tt>binat-anchor <i>nombre</i></tt> - eval&uacute;a todas las reglas
de <a href="nat.html#binat"><tt>binat</tt></a> en el anclaje
<i><tt>nombre</tt></i>
<li><tt>nat-anchor <i>nombre</i></tt> - eval&uacute;a todas las reglas
de <a href="nat.html"><tt>nat</tt></a> en el anclaje
<i><tt>nombre</tt></i>
<li><tt>rdr-anchor <i>nombre</i></tt> - eval&uacute;a todas las reglas
de <a href="rdr.html"><tt>rdr</tt></a> en el anclaje
<i><tt>nombre</tt></i>
</ul>

Las reglas de anclaje <tt>anchor</tt> s&oacute;lo se pueden definir en
el grupo de reglas principal.

<a name="named"></a>
<h2>Subgrupos de Reglas con Nombre</h2>
<p>
Un subgrupo de reglas con nombre es una agrupaci&oacute;n de reglas de
filtrado y/o traducci&oacute;n a la que se ha asignado un nombre.  Un
punto de anclaje <tt>anchor</tt> puede contener m&aacute;s de uno de
estos subgrupos de reglas.  Cuando PF se encuentra con una regla
<tt>anchor</tt> en el grupo principal de reglas, eval&uacute;a todos los
subgrupos de reglas adjuntas a ese punto de anclaje, en orden
alfab&eacute;tico de acuerdo con sus nombres.  Entonces contin&uacute;a
el procesamiento en el grupo de reglas principal, a menos que el paquete
concuerde con una regla de filtrado que use la opci&oacute;n
<tt>quick</tt> o con una regla de traducci&oacute;n dentro del mismo
anclaje, en cuyo caso la b&uacute;squeda de concordancia se
considerar&aacute; finalizada y terminar&aacute; la evaluaci&oacute;n de
las reglas, tanto en el anclaje como en el grupo de reglas principal.

<p>
Por ejemplo:
<blockquote>
<tt>
ext_if = &quot;fxp0&quot;<br>
<br>
block on $ext_if all<br>
pass  out on $ext_if all keep state<br>
anchor goodguys
</tt>
</blockquote>

<p>
En este grupo de reglas se ha definido una pol&iacute;tica de
denegaci&oacute;n predeterminada en fxp0, tanto para el tr&aacute;fico
entrante como para el saliente.  A continuaci&oacute;n se permite pasar
el tr&aacute;fico, manteniendo el estado, y se crea una regla de anclaje
con el nombre de <tt><i>goodguys</i></tt>.  Para a&ntilde;adir reglas al
anclaje <tt><i>goodguys</i></tt> se pueden usar las siguientes
&oacute;rdenes:
<blockquote>
<tt>
# echo &quot;pass in proto tcp from 192.0.2.3 to any port 22&quot; \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys:ssh -f -
</tt>
</blockquote>

<p>
Con esta orden se a&ntilde;ade una regla <tt>pass</tt> al grupo de
reglas llamado <tt><i>ssh</i></tt>, adjunto al anclaje
<tt><i>goodguys</i></tt>.  PF eval&uacute;a esta regla, y cualquier otra
regla de filtrado que se a&ntilde;ada, cuando llega a la l&iacute;nea
<tt>anchor goodguys</tt> en el grupo de reglas principal.

<p>
Tambi&eacute;n es posible guardar y cargar las reglas desde un fichero
de texto:
<blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys:www -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
De este modo se cargan las reglas desde el fichero
<tt>/etc/anchor-goodguys-www</tt> al subgrupo de reglas con nombre
<tt><i>www</i></tt> en el anclaje <tt><i>goodguys</i></tt>.

<p>
Las reglas de filtrado y de traducci&oacute;n se pueden cargar en un
subgrupo de reglas con nombre, usando la misma sintaxis y opciones que
para las reglas cargadas en el grupo de reglas principal.  Sin embargo,
hay que tener en cuenta que tambi&eacute;n se debe definir dentro del
subgrupo de reglas con nombre cualquier <a href="macros.html">macro</a>
que est&eacute; siendo utilizada;  Las macros que se encuentran
definidas en el grupo de reglas principal <i>no</i> son visibles desde
los subgrupos de reglas con nombre.

<p>
Cada subgrupo de reglas con nombre, as&iacute; como el grupo de reglas
principal, existe de forma independiente de los otros grupos de reglas.
Las operaciones que se realicen en un grupo de reglas, como la limpieza
de las reglas, no afecta a ninguno de los otros grupos.  Adem&aacute;s,
si se elimina un punto de anclaje del grupo de reglas principal, no se
destruye el anclaje ni cualquier subgrupo de reglas con nombre que
est&eacute; adjunto a ese anclaje.  Un subgrupo de reglas con nombre no
se destruye hasta que se han limpiado todas las reglas usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3">pfctl(8)</a>.
Cuando un punto de anclaje ya no tiene ning&uacute;n grupo de reglas
adjunto, tambi&eacute;n se destruye.


<a name="options"></a>
<h2>Opciones de Anclaje</h2>
<p>
De modo opcional, las reglas <tt>anchor</tt> pueden especificar una
interfaz, un protocolo, una direcci&oacute;n de origen y destino, etc..
usando la misma sintaxis que las reglas de filtrado.  Cuando se da este
tipo de informaci&oacute;n, las reglas <tt>anchor</tt> s&oacute;lo se
procesan si el paquete concuerda con la definici&oacute;n de la regla
<tt>anchor</tt>.  Por ejemplo:
<blockquote>
<tt>
ext_if = &quot;fxp0&quot;<br>
<br>
block on $ext_if all<br>
pass  out on $ext_if all keep state<br>
anchor ssh in on $ext_if proto tcp from any to any port 22<br>
</tt>
</blockquote>

<p>
Las reglas en el anclaje <tt>anchor <i>ssh</i></tt> s&oacute;lo se
eval&uacute;an para los paquetes TCP destinados al puerto 22 que entran
en la interfaz fxp0.  Entonces se a&ntilde;aden las reglas al
<tt>anchor</tt>, del siguiente modo:
<blockquote>
<tt>
# echo &quot;pass in from 192.0.2.10 to any&quot; | pfctl -a ssh:allowed -f -
</tt>
</blockquote>

<p>
Por lo tanto, aunque la regla de filtrado no especifique una interfaz,
un protocolo, o un puerto, al anfitri&oacute;n 192.0.2.10 s&oacute;lo se
le permitir&aacute; conectar usando SSH, de acuerdo con la
definici&oacute;n de la regla <tt>anchor</tt>.

<a name="manip"></a>
<h2>Manipulaci&oacute;n de Subgrupos de Reglas con Nombre</h2>
<p>
La manipulaci&oacute;n de los subgrupos de reglas con nombre se realiza
mediante <tt>pfctl</tt>.  Se puede usar <tt>pfctl</tt> para
a&ntilde;adir y eliminar reglas de un grupo de reglas sin recargar el
grupo de reglas principal.

<p>
Para ver una lista de todas las reglas en el grupo de reglas
<tt><i>allowed</i></tt> adjunto al anclaje <tt><i>ssh</i></tt>:
<blockquote>
<tt>
# pfctl -a ssh:allowed -s rules
</tt>
</blockquote>

<p>
Para limpiar todas las reglas de filtrado de este mismo grupo de reglas:
<blockquote>
<tt>
# pfctl -a ssh:allowed -F rules
</tt>
</blockquote>

<p>
Si se omite el nombre del grupo de reglas, la acci&oacute;n se
aplicar&aacute; a todas las reglas en el anclaje.

<p>
Para una lista completa de &oacute;rdenes, v&eacute;ase
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3"><tt>pfctl(8)</tt></a>.

<p>
[<a href="logging.html">Anterior: Registros de Bit&aacute;cora</a>]
[<a href="index.html">Contenido</a>]
[<a href="shortcuts.html">Siguiente: Atajos para la Creaci&oacute;n de
Grupos de Reglas</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[&Iacute;ndice]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: anchors.html,v 1.6 2003/09/16 01:23:49 nick Exp ]<br>
$OpenBSD: anchors.html,v 1.5 2003/09/20 07:00:26 horacio Exp $<br>
$Translation: anchors.html,v 1.6 2003/09/19 22:10:58 horacio Exp $
</small>
</body>
</html> 
