<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Authpf: shell de usuario para pasarelas
de autenticación</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="ftp.html">Anterior: Cuestiones relacionadas con FTP</a>]
[<a href="index.html">Contenido</a>]
[<a href="carp.html">Siguiente: Redundancia de cortafuegos con CARP 
y pfsync</a>]

<h1><font color="#e00000">PF: authpf: shell de usuario para pasarelas
de autenticación</font></h1>

<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#intro">Introducción</a>
<li><a href="#config">Configuración</a>
        <ul>
	<li><a href="#enable">Activación de authpf</a>
        <li><a href="#linkmain">Cómo enlazar authpf en el grupo
		de reglas principal</a>
        <li><a href="#loadrules">Configuración de las reglas
		cargadas</a>
        <li><a href="#acl">Listas de Control de Acceso</a> 
	<li><a href="#message">Mostrar un mensaje de inicio de sesión</a>
	<li><a href="#shell">Asignar authpf como
		shell de usuario</a>
        </ul>
<li><a href="#loginclass">Creación de una clase de inicio de sesión authpf</a>
<li><a href="#wholog">Cómo ver quién está conectado al sistema</a>
<li><a href="#example">Ejemplo</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introducción</h2>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>Authpf(8)</a> es una <i>shell</i> ("intérprete de órdenes") para pasarelas de
autenticación.  Una pasarela de autenticación es como una
pasarela de red normal (también llamada enrutador), con la
diferencia que los usuarios se deben autenticar ante la pasarela antes
de que se permita que pase el tráfico a través de
esta.  Cuando se configura el intérprete de un usuario
para que éste sea <tt>/usr/sbin/authpf</tt> (o sea, en lugar de
configurarlo como
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1"
>ksh(1)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=csh&amp;sektion=1"
>csh(1)</a>, o cualquier otro intérprete)
y el usuario ingresa en el sistema usando SSH, authpf realiza los
cambios necesarios en el grupo de reglas activo de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.8"
>pf(4)</a>,
de modo que el tráfico del usuario pase a través del
filtro y/o sea traducido usando Traducción de Direcciones de Red (NAT) 
o redireccionamiento.  Una vez que el usuario sale del sistema o
que se desconecta la sesión, authpf elimina cualquier regla que
haya sido cargada por el usuario y termina cualquier conexión de
estado que haya dejado abierta el usuario.  De esta forma, el
tráfico generado por el usuario sólo podrá pasar a
través de la pasarela mientras el usuario mantenga abierta su
sesión de SSH.

<p>
Authpf carga un grupo de reglas de usuario en un 
<a href="anchors.html">punto de anclaje</a> único. 
Este anclaje es nombrado por la combinación el 
nombre de usuario UNIX y el identificador del proceso authpf 
en el formato "<tt>username(PID)</tt>".
Cada anclaje de usuario se almacena dentro del anclaje 
<tt>authpf</tt> que es a su vez anclado en el conjunto de reglas principal. 
La "ruta de anclaje completa", se convierte entonces en:

<blockquote>
<tt>
<i>conjunto_de_reglas_principal</i>/authpf/<i>nombre_usuario</i>(<i>PID</i>)
</tt>
</blockquote>

<p>
Las reglas que authpf carga pueden configurarse por usuario
o bien globalmente.

<p>
Algunos ejemplos de usos de authpf son:
<ul>
<li>Requerir a los usuarios que se autentiquen antes de permitir el
acceso desde Internet.
<li>Otorgar a ciertos usuarios, como los administradores, acceso a zonas
restringidas de la red.
<li>Permitir que sólo aquellos usuarios que sean conocidos puedan
acceder al resto de la red, o a Internet desde un segmento de una red
inalámbrica.
<li>Permitir que los usuarios puedan acceder desde sus casas, o mientras
estén de viaje, a recursos existentes dentro de la red de la
empresa.  Los usuarios que se encuentren físicamente fuera de la
oficina no sólo podrán abrir un acceso a la red de la
empresa, sino que también podrán ser redireccionados a
recursos concretos (por ejemplo, a su propio escritorio)
basándose en el nombre de usuario con el que se autentiquen.
<li>En un sitio como puede ser una biblioteca, u otro con terminales de
Internet públicas, se puede configurar PF para permitir un acceso
limitado a Internet a usuarios anónimos que entren como
invitados. Authpf puede entonces utilizarse para proveer acceso completo
a usuarios registrados.
</ul>

<p>
Authpf registra el nombre de usuario y la dirección IP de cada
usuario que se autentica con éxito, además de
también registrar el inicio y el final de sus sesiones de
ingreso mediante
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8"
>syslogd(8)</a>.
Con el uso de esta información, un administrador puede determinar
quién ha ingresado en el sistema y cuándo, y
también calcular y pedir cuentas a los usuarios por el 
tráfico de red utilizado.

<a name="config"></a>
<h2>Configuración</h2>
<p>
Los pasos básicos necesarios para configurar authpf se
señalan a continuación.  Para una descripción
completa de la configuración de authpf, véase la
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>página de manual de authpf</a>.

<a name="enable"></a>
<h3>Activación de authpf</h3>

<p>
Authpf no se ejecutará si no está presente 
el fichero de configuración <tt>/etc/authpf/authpf.conf</tt>.
El fichero puede estar vacío (tamaño cero) pero, a menos que  
esté presente, authpf se cerrará inmediatamente después de que un 
usuario se autentique correctamente.

<p>
Las siguientes directivas de configuración pueden colocarse
en <tt>authpf.conf</tt>:

<ul>
<li><tt>anchor=<i>nombre</i></tt> - Use el nombre de 
<a href="anchors.html">anclaje</a> especificado en lugar de "authpf".
<li><tt>table=<i>nombre</i></tt> - Use el nombre de 
<a href="tables.html">tabla</a> en lugar de "authpf_users".
</ul>

<a name="linkmain"></a>
<h3>Cómo enlazar authpf en el grupo de reglas principal</h3>
<p>
Authpf está enlazado en el grupo de reglas principal mediante
una regla de anclaje <tt>anchor</tt>:
<blockquote>
<tt>
anchor "authpf/*"<br>
</tt>
</blockquote>

<p>
Allá donde la regla <tt>anchor</tt> se encuentre dentro del
grupo de reglas, será donde PF se ramificará desde el
grupo de reglas principal para evaluar las reglas de authpf.

<a name="loadrules"></a>
<h3>Configuración de las reglas cargadas</h3>
<p>
Authpf carga sus reglas desde uno de los dos ficheros siguientes:
<ul>
<li><tt>/etc/authpf/users/$USER/authpf.rules</tt>
<li><tt>/etc/authpf/authpf.rules</tt>
</ul>

<p>
El primer fichero contiene las reglas que sólo se cargarán
cuando el usuario <tt>$USER</tt> (sustitúyase por el nombre de
usuario del usuario) ingrese en el sistema.  La configuración
individual por usuario se usa cuando un usuario específico, como
un administrador, requiere un grupo de reglas diferente al grupo
predeterminado.  El segundo fichero contiene las reglas predeterminadas
que se cargarán para cualquier usuario que no tenga su propio
fichero <tt>authpf.rules</tt>.  Si existe este fichero específico
PARA el usuario, se anulará el fichero predeterminado.  Para que
funcione authpf, como mínimo debe existir uno de los ficheros.

<p>
Las reglas tienen la misma sintaxis que en cualquier otro grupo 
de reglas de PF, pero con una excepción:
authpf permite el uso de dos macros predefinidas:
<ul>
<li><tt>$user_ip</tt> - la dirección IP del usuario que ha
ingresado en el sistema
<li><tt>$user_id</tt> - el nombre de usuario del usuario que ha
ingresado en el sistema
</ul>

<p>
La práctica recomendada es usar la macro <tt>$user_ip</tt> para
que sólo se permita el paso a través de la pasarela al
tráfico originado desde la máquina del usuario que se ha
autenticado.

<p>
Además de la macro <tt>$user_ip</tt>, authpf hará uso de la
tabla <tt>authpf_users</tt> (si existe) para almacenar las
direcciones IP de todos los usuarios autenticados.
Asegúrese de definir la tabla antes de usarla:

<blockquote>
<tt>
table &lt;authpf_users&gt; persist<br>
pass in on $ext_if proto tcp from &lt;authpf_users&gt; \<br>
&nbsp;&nbsp;&nbsp;&nbsp;to port smtp
</tt>
</blockquote>

Esta tabla solo debe usarse en reglas que se pretendan aplicar 
a todos los usuarios autenticados.

<a name="acl"></a>
<h3>Listas de Control de Acceso</h3>
<p>
Se puede evitar que ciertos usuarios utilicen authpf creando un fichero
con el nombre de cada uno de los usuarios a los que se quiera denegar el
acceso, dentro del directorio <tt>/etc/authpf/banned/</tt>.  El
contenido del fichero es lo que se mostrará a los usuarios antes
de que authpf los desconecte.  Esto ofrece un modo sencillo de notificar
al usuario el motivo por el que se le impide el acceso, y con
quién debe contactar para que se le vuelva a otorgar acceso.

<p>
Y a la inversa, también es posible permitir el acceso sólo
a ciertos usuarios añadiendo sus nombres de usuario al fichero
<tt>/etc/authpf/authpf.allow</tt>.  Si no existe este fichero o si el
contenido de este fichero es un asterisco (<tt>*</tt>), entonces authpf
permitirá el acceso a cualquier usuario que se autentique con
éxito mediante SSH, siempre y cuando no exista una
prohibición explícita para el usuario.

<p>
Si authpf no puede determinar si un nombre de usuario tiene el acceso
permitido o denegado, mostrará un breve mensaje y luego
desconectará al usuario.  Una entrada en
<tt>/etc/authpf/banned/</tt> siempre tiene precedencia y anula otra
entrada en <tt>/etc/authpf/authpf.allow</tt>.

<a name="message"></a>
<h3>Mostrar un mensaje de inicio de sesión</h3>

<p>
Cada vez que un usuario se autentica correctamente en
authpf, se muestra un mensaje que indica que el usuario se ha 
autenticado: 

<blockquote>
<tt>
Hello charlie. You are authenticated from host "64.59.56.140"
</tt>
</blockquote>

<p>
Este mensaje puede ser complementado añadiendo un mensaje 
personalizado en <tt>/etc/authpf/authpf.message</tt>.  
El contenido de este fichero se mostrará después del mensaje 
de bienvenida por defecto.

<a name="shell"></a>
<h3>Asignar authpf como shell de usuario</h3>
<p>
Para que authpf funcione debe ser asignado como el intérprete
(<i>shell</i>) de ingreso del usuario.  Cuando el usuario se autentica
con éxito a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8"
>sshd(8)</a>,
authpf se ejecuta como shell del usuario;  entonces
comprueba si el usuario tiene permiso para usar authpf, carga las reglas
desde el fichero apropiado, etc.

<p>
Existen un par de formas para asignar authpf como el intérprete
del usuario:
<ol>
<li>Manualmente para cada usuario utilizando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1"
>chsh(1)</a>, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8"
>vipw(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8"
>useradd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&amp;sektion=8"
>usermod(8)</a>, etc.
<li>Asignando usuarios a una clase de inicio de sesión y cambiando la
opción de clase <tt>shell</tt> en
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5"
><tt>/etc/login.conf</tt></a>.
</ol>

<a name="loginclass"></a>
<h2>Creación de una clase de inicio de sesión authpf</h2>
Cuando se utiliza authpf en un sistema que tiene cuentas de usuario normales
y cuentas de usuarios de authpf, puede ser interesante utilizar una clase de 
inicio de sesión separada para los usuarios authpf.
Esto permite rewlizar globalmente ciertos cambios en estas cuentas, así
como emplazar distintas políticas en cuentas normales y cuentas authpf.
Algunos ejemplos de las políticas que pueden establecerse:


<ul>
<li><b>shell</b> - Especifica una shell de inicio de sesión de usuario.
Puede usarse para forzar una shell de usuario  <tt>authpf</tt>, 
independendientemente de la entrada en la base de datos de 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=passwd&amp;sektion=5"
>passwd(5)</a>. 
<li><b>welcome</b> - Especifica qué fichero
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=motd&amp;sektion=5"
>motd(5)</a> mostrar cuando un usuario inicia sesión. Esto es útil
para mostrar mensajes solo relevantes para los usuarios authpf.  
</ul>

<p>
Las clases de inicio de sesión se crean en el fichero
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5"
>login.conf(5)</a>.
OpenBSD incluye una clase de inicio de sesión definida así: 

<blockquote>
<tt>
authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:welcome=/etc/motd.authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:shell=/usr/sbin/authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:tc=default:
</tt>
</blockquote>

<p>
Los usuarios son asignados a una clase de inicio de sesión mediante 
la edición del campo <tt>class</tt> de la entrada de usuario en la 
base de datos passwd(5). Una forma de hacerlo es con la orden 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1"
>chsh(1)</a>.

<a name="wholog"></a>
<h2>Cómo ver quién está conectado al sistema</h2>
<p>
Una vez que un usuario ha ingresado con éxito y que authpf ha
ajustado las reglas de PF, authpf cambia el título de su proceso
para indicar el nombre de usuario y la dirección IP del usuario:
<pre>
    # ps -ax | grep authpf
    23664 p0  Is+     0:00.11 -authpf: charlie@192.168.1.3 (authpf)
</pre>

<p>
En este ejemplo, el usuario <tt>charlie</tt> está conectado desde
la máquina 192.168.1.3.  Enviando una señal de SIGTERM al
proceso de authpf, el usuario puede forzar la terminación de la
conexión.  Authpf también elimina cualquier regla que se
haya cargado para el usuario, y termina cualquier conexión de
estado que tenga abierta el usuario.
<pre>
    # kill -TERM 23664
</pre>

<a name="example"></a>
<h2>Ejemplo</h2>
<p>
En el siguiente ejemplo se usa authpf en una pasarela OpenBSD, para
autenticar a usuarios en una red inalámbrica que forma parte de
otra red más grande del campus.  Una vez que un usuario se ha
autenticado, asumiendo que no se encuentre en la lista de usuarios
prohibidos, se le permitirá usar SSH y navegar por la web
(incluidos sitios web seguros), además de acceder a
cualquiera de los servidores de DNS del campus.

<p>
El fichero <tt>/etc/authpf/authpf.rules</tt> contiene las siguientes
reglas:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"

pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https }
</pre>
</td></tr>
</table>

<p>
El usuario administrador <tt>charlie</tt> necesita tener acceso a los
servidores de SMTP y POP3 del campus, además de poder navegar por
la web y de usar SSH.  Para ello se configuran las siguientes
reglas en <tt>/etc/authpf/users/charlie/authpf.rules</tt>:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
smtp_server = "10.0.1.50"
pop3_server = "10.0.1.51"

pass in quick on $wifi_if \
   proto tcp from $user_ip to $smtp_server port smtp
pass in quick on $wifi_if \
   proto tcp from $user_ip to $pop3_server port pop3
pass in quick on $wifi_if \
   proto tcp from $user_ip to port { ssh, http, https }
</pre>
</td></tr>
</table>

<p>
El grupo de reglas principal, que se encuentra en el fichero
<tt>/etc/pf.conf</tt>, se configura como sigue:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros
wifi_if = "wi0"
ext_if  = "fxp0"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

table &lt;authpf_users&gt; persist

# filtrado
block drop all

pass out quick on $ext_if inet proto { tcp, udp, icmp } \
   from { $wifi_if:network, $ext_if }

pass in quick on $wifi_if inet proto tcp \
   from $wifi_if:network to $wifi_if port ssh

pass in quick on $wifi_if inet proto { tcp, udp } \
   from &lt;authpf_users&gt; to $dns_servers port domain

anchor "authpf/*" in on $wifi_if
</pre>
</td></tr>
</table>

<p>
El grupo de reglas es muy simple y realiza las siguientes funciones:
<ul>
<li>Bloquea todo (denegación predeterminada).
<li>Permite el paso del tráfico saliente de TCP, UDP, y ICMP a la
interfaz externa desde la red inalámbrica y desde la propia pasarela.
<li>Permite el paso del tráfico entrante de SSH desde la red
inalámbrica con destino a la pasarela.  Esta regla es necesaria
para permitir que ingresen los usuarios.
<li>Permite el paso de consultas entrantes de DNS de todos los usuarios 
authpf autenticados a los servidores DNS del campus.
<li>Crea el punto de anclaje "authpf" para el tráfico
entrante en la interfaz inalámbrica.
</ul>

<p>
La idea detrás del grupo de reglas principal es bloquear todo y
permitir que pase la menor cantidad de tráfico que sea
posible.  El tráfico es libre de salir a la interfaz externa,
pero tiene bloqueada la entrada a la interfaz inalámbrica debido
a la política de denegación predeterminada.  Una vez que
el usuario se autentica, se permite que su tráfico pase a la
interfaz inalámbrica y desde allí, a través de la
pasarela, al resto de la red.  Se usa la clave <tt>quick</tt> de forma
consistente, para que PF no tenga que evaluar cada uno de los subgrupos
de reglas con nombre cada vez que pase a través de la pasarela
una nueva conexión.

<p>
[<a href="ftp.html">Anterior: Cuestiones relacionadas con FTP</a>]
[<a href="index.html">Contenido</a>]
[<a href="carp.html">Siguiente: Redundancia de cortafuegos con CARP 
y pfsync</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: authpf.html,v 1.28 ]<br>
$Translation: authpf.html,v 1.8 2011/03/12 17:05:50 mvidal Exp $<br>
-->
$OpenBSD: authpf.html,v 1.8 2011/03/13 07:16:15 ajacoutot Exp $
</small>

</body>
</html>
