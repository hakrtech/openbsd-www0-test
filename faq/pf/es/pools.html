<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Reservas de direcciones y balanceo de carga</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="queueing.html">Anterior: Formación de colas y
prioridades de paquetes</a>]
[<a href="index.html">Contenido</a>]
[<a href="tagging.html">Siguiente: Marcado de paquetes</a>]

<p>
<h1>
<font color="#e00000">PF: Reservas de direcciones y balanceo
de carga</font>
</h1>

<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#intro">Introducción</a>
<li><a href="#nat">Reserva de direcciones de NAT</a>
<li><a href="#incoming">Balanceo de carga en conexiones entrantes</a>
<li><a href="#outgoing">Balanceo de carga en tráfico saliente</a>
	<ul>
	<li><a href="#outexample">Ejemplo de grupo de reglas</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introducción</h2>
<p>
Una reserva (<i>pool</i>) de direcciones es un grupo de dos o más
direcciones cuyo uso comparten un grupo de usuarios.  Una reserva de
direcciones puede especificarse como la dirección de destino 
en las opciones de <a href="filter.html">filtrado</a> <tt>nat-to</tt>, <tt>rdr-to</tt>,<tt>route-to</tt>,
<tt>reply-to</tt> y <tt>dup-to</tt>.

<p>
Existen cuatro métodos para usar una reserva de direcciones:
<ul>
<li><tt>bitmask</tt> - incrusta la parte referente a la red que
corresponde a la reserva de direcciones en la dirección
que se esté modificando (que sería la dirección de
origen para las reglas de <tt>nat-to</tt> y la dirección de destino
para las reglas <tt>rdr-to</tt>).  Ejemplo: si la reserva de direcciones
es 192.0.2.1/24 y la dirección que se
está modificando es 10.0.0.50, la dirección resultante
será 192.0.2.50.  Si la reserva de direcciones es
192.0.2.1/25 y la dirección que se está modificando es
10.0.0.130, la dirección resultante será 192.0.2.2.
<li><tt>random</tt> - selecciona una de las direcciones de la reserva
de forma aleatoria.
<li><tt>source-hash</tt> - usa un resumen criptográfico
(<i>hash</i>) de la dirección de origen para determinar
qué dirección de la reserva debe usar.  Este
método asegura que una dirección de origen que venga
indicada se asigne siempre a la misma dirección de la reserva. La
clave que se le pasa al algoritmo del resumen se puede especificar de
modo opcional después de la clave <tt>source-hash</tt>, en
formato hexadecimal o como una cadena.  En su modo predeterminado,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>pfctl(8)</a> generará una clave aleatoria
cada vez que se cargue un grupo de reglas.
<li><tt>round-robin</tt> - este método realiza una
rotación en secuencia por la reserva de direcciones.  Es
el método predeterminado en PF, y también el único
método permitido cuando se especifica una reserva de
direcciones usando una <a href="tables.html">tabla</a>.
</ul>

<p>
A excepción del método <tt>round-robin</tt>, la reserva
de direcciones se debe expresar como un bloque
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
(Enrutamiento de Inter-Dominios Sin Clase).  El método
<i>round-robin</i> aceptará más de una dirección
individual cuando se use una
<a href="macros.html#lists">lista</a> o una
<a href="tables.html">tabla</a>.

<p>
La opción <tt>sticky-address</tt> puede ser usada con los tipos de reserva
<tt>random</tt> y <tt>round-robin</tt> para asegurarse de que una dirección
de origen en particular sea siempre asignada a la misma dirección de
redirección.

<a name="nat"></a>
<h2>Reserva de direcciones de NAT</h2>
<p>
Se puede usar una reserva de direcciones como la
dirección de traducción en las reglas <a href="nat.html"><tt>nat-to</tt></a>.
La dirección de origen de
las conexiones se traducirá a la de una de las direcciones de la
reserva, basándose en el método escogido.  Esto puede
ser muy útil en situaciones en las que PF esté realizando
NAT para una red muy grande.  Dado que el número de conexiones
con NAT por dirección de traducción es limitado, al
añadir direcciones de traducción adicionales la pasarela
de NAT podrá escalar y así servir a un número mayor
de usuarios.

<p>
En el siguiente ejemplo, se usa una reserva de dos direcciones para
traducir los paquetes salientes.  Por cada conexión saliente, PF
rotará las direcciones según el método
<i>round-robin</i>.
<blockquote>
<tt>
match out on $ext_if inet nat-to { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
Un problema con este método es que las conexiones sucesivas desde
una misma dirección interna no se traducirán siempre a la
misma dirección.  Esto puede causar
interferencias, por ejemplo, cuando se esté navegando por sitios
<i>web</i> que realicen seguimientos de los ingresos de los usuarios
basándose en la dirección IP.  Una alternativa es usar el
método <i>source-hash</i>, para que siempre se traduzca cada
dirección interna a la misma dirección.  Para ello, la reserva de
direcciones debe ser un bloque de red
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
<blockquote>
<tt>
match out on $ext_if inet nat-to 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
Esta regla usa la reserva de direcciones
192.0.2.4/31 (192.0.2.4 - 192.0.2.5) como la dirección de
traducción de los paquetes salientes.  Cada dirección
interna se traducirá siempre a la misma dirección de
traducción, por indicación de la clave
<tt>source-hash</tt>.

<a name="incoming"></a>
<h2>Balanceo de carga en conexiones entrantes</h2>
<p>
Las reservas de direcciones también se pueden usar para
el balanceo de carga de las conexiones entrantes.  Por ejemplo, se
pueden distribuir a través de varios servidores de <i>web</i> las
conexiones entrantes al servidor de <i>web</i>:
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
match in on $ext_if proto tcp to port 80 rdr-to $web_servers \<br>
&nbsp;&nbsp;&nbsp;&nbsp;round-robin sticky-address
</tt>
</blockquote>

<p>
Las conexiones sucesivas se redireccionarán a los servidores de
<i>web</i> de acuerdo con el método <i>round-robin</i>, enviando al
mismo servidor web las conexiones provenientes del mismo origen.
Esta "conexión pegajosa" existirá mientras haya estados que hagan referencia
a esta conexión.
Una vez que los estados expiren, esta "conexión pegajosa" lo hará también.
Las siguientes conexiones provenientes de este host serán redirigidos al
siguiente servidor web en el round robin.

<a name="outgoing"></a>
<h2>Balanceo de carga en tráfico saliente</h2>
<p>
Las reservas de direcciones se pueden usar en
combinación con la opción de filtrado <tt>route-to</tt>,
con el fin de balancear la carga de dos o más conexiones de
Internet cuando no se encuentre disponible un protocolo de enrutamiento
de múltiples caminos apropiado (como
<a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>).  Usando
<tt>route-to</tt> con una reserva de direcciones
<tt>round-robin</tt>, se pueden distribuir las conexiones salientes a
partes iguales entre múltiples caminos salientes.

<p>
Un pieza adicional de información necesaria para esto es la
dirección IP del enrutador adyacente en cada conexión de
Internet.  Esta información se pasa a la opción
<tt>route-to</tt> para controlar el destino de los paquetes salientes.

<p>
El siguiente ejemplo balancea el tráfico saliente a través
de dos conexiones de Internet:
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if from $lan_net \
&nbsp;&nbsp;&nbsp;route-to { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } \
&nbsp;&nbsp;&nbsp;round-robin
</tt>
</blockquote>

<p>
La opción <tt>route-to</tt> se usa sobre el tráfico que
<i>entra</i> en la interfaz <i>interna</i> para especificar las
interfaces de red salientes a través de las cuales se
balanceará el tráfico, junto con sus respectivas
pasarelas.  Nótese que la opción <tt>route-to</tt> debe
estar presente en <i>cada una</i> de las reglas de filtrado para las que
se balanceará el tráfico (no puede usarse con reglas <tt>match</tt>).

<p>
Para asegurarse de que los paquetes con una dirección de origen
que pertenezca a <tt>$ext_if1</tt> sean siempre enrutados a
<tt>$ext_gw1</tt> (y lo mismo para <tt>$ext_if2</tt> y
<tt>$ext_gw2</tt>), hay que incluir las siguientes dos líneas en
el grupo de reglas:
<blockquote>
<tt>
pass out on $ext_if1 from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;route-to ($ext_if2 $ext_gw2)<br>
pass out on $ext_if2 from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;route-to ($ext_if1 $ext_gw1) 
</tt>
</blockquote>

<p>
Finalmente, también se puede usar NAT en cada una de las
interfaces salientes:
<blockquote>
<tt>
match out on $ext_if1 from $lan_net nat-to ($ext_if1)<br>
match out on $ext_if2 from $lan_net nat-to ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
Un ejemplo completo que balancea la carga del tráfico saliente
sería algo parecido al siguiente:

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

#  conexiones salientes de nat en cada interfaz de internet
match out on $ext_if1 from $lan_net nat-to ($ext_if1)
match out on $ext_if2 from $lan_net nat-to ($ext_if2)

#  denegación predeterminada
block in
block out

#  permitir el paso a todos los paquetes salientes en la interfaz interna
pass out on $int_if to $lan_net
#  permitir el paso 'quick' a cualquier paquete destinado para la pasarela
pass in quick on $int_if from $lan_net to $int_if
#  balancear la carga del tráfico tcp saliente desde la red interna.
pass in on $int_if from $lan_net \
    route-to { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } \
    round-robin
#  mantener tráfico https en una única conexión; algunas aplicaciones web,
#  especialmente las "seguras", no permiten cambiar a mitad de sesión
pass in on $int_if proto tcp from $lan_net to port https \
    route-to ($ext_if1 $ext_gw1)

#  reglas "pass out" genéricas para las interfaces externas
pass out on $ext_if1
pass out on $ext_if2

#  enrutar paquetes desde cualquier IP en $ext_if1 hacia $ext_gw1
#  y lo mismo para $ext_if2 y $ext_gw2
pass out on $ext_if1 from $ext_if2 route-to ($ext_if2 $ext_gw2)
pass out on $ext_if2 from $ext_if1 route-to ($ext_if1 $ext_gw1) 
</pre>
</td></tr>
</table>

<p>
[<a href="queueing.html">Anterior: Formación de colas y
prioridades de paquetes</a>]
[<a href="index.html">Contenido</a>]
[<a href="tagging.html">Siguiente: Marcado de paquetes</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: pools.html,v 1.27 ]<br>
$Translation: pools.html,v 1.8 2011/02/28 19:40:13 mvidal Exp $<br>
-->
$OpenBSD: pools.html,v 1.8 2011/03/04 16:16:15 ajacoutot Exp $
</small>

</body>
</html> 
