<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Marcado de paquetes (filtrado por política)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="pools.html">Anterior: Reservas de direcciones y
balanceo de carga</a>]
[<a href="index.html">Contenido</a>]
[<a href="logging.html">Siguiente: Registros de
bitácora</a>]

<p>
<h1><font color="#e00000">PF: Marcado de paquetes (filtrado por política)</font></h1>

<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#intro">Introducción</a>
<li><a href="#assign">Asignación de etiquetas a los paquetes</a>
<li><a href="#check">Comprobación de las etiquetas aplicadas</a>
<li><a href="#policy">Filtrado por política</a>
<li><a href="#ethernet">Marcado de tramas de Ethernet</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introducción</h2>
<p>
El marcado de paquetes es una forma de etiquetar paquetes con un
identificador interno que más tarde se puede usar para el
criterio de las reglas de filtrado y traducción.
Mediante el marcado se pueden realizar tareas como la creación de
&laquo;relaciones de confianza&raquo; entre interfaces y determinar 
si los paquetes han sido procesados por las reglas de traducción.
También es posible alejarse del filtrado basado en reglas e
iniciar un filtrado basado en políticas.

<a name="assign"></a>
<h2>Asignación de etiquetas a los paquetes</h2>
<p>
Para añadir una etiqueta a un paquete, hay que usar la clave
<tt>tag</tt>:
<blockquote>
<tt>
pass in on $int_if all tag INTERNAL_NET keep state
</tt>
</blockquote>

<p>
De este modo, la etiqueta <tt>INTERNAL_NET</tt> será añadida
a cualquier paquete que concuerde con la regla anterior.  

<p>
Una etiqueta también puede ser asignada usando una
<a href="macros.html#macros">macro</a>.
Por ejemplo:

<blockquote>
<tt>
name = "INTERNAL_NET"<br>
pass in on $int_if all tag $name
</tt>
</blockquote>

<p>
Hay un conjunto de macros predefinidas que también pueden usarse.
<ul>
<li><tt>$if</tt> - La interfaz
<li><tt>$srcaddr</tt> - La dirección IP de origen
<li><tt>$dstaddr</tt> - La dirección IP de destino
<li><tt>$srcport</tt> - El puerto de origen
<li><tt>$dstport</tt> - El puerto de destino
<li><tt>$proto</tt> - El protocolo
<li><tt>$nr</tt> - El número de la regla
</ul>

<p>
Estas macros son expandidas al momento de cargar las reglas y NO en tiempo
de ejecución.

<p>
El proceso de marcado sigue estas reglas:
<ul>
<li>Las etiquetas son &laquo;adherentes&raquo; (<i>sticky</i>).  
Una vez que una regla concordante aplica una etiqueta a un paquete, 
esta ya no se elimina nunca.  Aunque se puede sustituir por una 
etiqueta diferente.
<li>Debido a la fuerte &laquo;adherencia&raquo; de una etiqueta, 
un paquete puede tener una etiqueta aunque la última regla concordante 
no use la clave <tt>tag</tt>.
<li>A un paquete sólo se le asigna un máximo de una etiqueta
por vez.
<li>Las etiquetas son identificadores <i>internos</i>.  Las etiquetas no se
envían fuera a través de la conexión.
<li>Los nombres de etiquetas pueden tener hasta 63 caracteres.
En OpenBSD 4.0 y versiones anteriores, los nombres de etiqueta están 
limitados a 15 caracteres.
</ul>

<p>
Tomemos el siguiente conjunto de reglas como ejemplo:
<blockquote>
<tt>
(1) pass in on $int_if tag INT_NET<br>
(2) pass in quick on $int_if proto tcp to port 80 tag INT_NET_HTTP<br>
(3) pass in quick on $int_if from 192.168.1.5
</tt>
</blockquote>

<p>
<ul>
<li>A los paquetes que entren por <tt>$int_if</tt> se les
asignará una etiqueta de <tt>INT_NET</tt>, de acuerdo con la regla
#1.
<li>A los paquetes TCP entrantes por <tt>$int_if</tt> y destinados al
puerto 80 se les asignará una etiqueta de <tt>INT_NET</tt>, de
acuerdo con la regla #1.  A continuación se sustituirá esa
marca con la etiqueta <tt>INT_NET_HTTP</tt>, de acuerdo con la regla #2.
<li>Los paquetes entrantes por <tt>$int_if</tt> desde 192.168.1.5 
serán etiquetados de una de dos maneras.
Si el paquete tiene como destino el puerto TCP 80, se corresponderá
con la regla #2 y se le marcará con la etiqueta <tt>INT_NET_HTTP</tt>.  
En caso contrario, el paquete se corresponde con la regla #3 
y se le marcará con la etiqueta <tt>INT_NET</tt>.
Debido a que el paquete se corresponde con la regla #1, se aplica la etiqueta 
<tt>INT_NET</tt> y no se quita a menos que una regla coincidente 
especifique posteriormente una etiqueta (esto es la "adherencia" de una etiqueta).
</ul>

<a name="check"></a>
<h2>Comprobación de las etiquetas aplicadas</h2>
<p>
Para comprobar las etiquetas que se hayan aplicado hay que usar la clave
<tt>tagged</tt>:
<blockquote>
<tt>
pass out on $ext_if tagged INT_NET
</tt>
</blockquote>

<p>
Los paquetes salientes por <tt>$ext_if</tt> deben ir marcados con la
etiqueta <tt>INT_NET</tt> para que coincidan con la regla anterior.
También se pueden realizar comprobaciones a la inversa usando el
operador <tt>!</tt>:
<blockquote>
<tt>
pass out on $ext_if ! tagged WIFI_NET
</tt>
</blockquote>

<a name="policy"></a>
<h2>Filtrado por política</h2>
<p>
El filtrado por política es un enfoque diferente al de los
conjuntos de reglas de filtrado.
Para empezar se define una política que configura las reglas
según las cuales se dejará pasar a unos tipos de
tráfico y se bloqueará a otros.
Entonces se clasifican los paquetes dentro de esta política en
base al criterio tradicional de dirección/puerto IP de
origen/destino, protocolo, etc.
Por ejemplo, examinemos la siguiente política de cortafuegos:
<ul>
<li>Se permite el paso del tráfico desde la LAN interna 
hacia Internet (LAN_INET) y debe ser traducido (LAN_INET_NAT)
<li>Se permite el paso del tráfico desde la LAN interna hacia la
DMZ (LAN_DMZ)
<li>Se permite el paso del tráfico desde Internet hacia los
servidores en la DMZ (INET_DMZ)
<li>Se permite el paso del tráfico desde Internet que esté
siendo redireccionado a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamd&amp;sektion=8"
>spamd(8)</a> (SPAMD)
<li>Se bloqueará cualquier otro tráfico
</ul>

<p>
Nótese que la política cubre <i>todo</i> el tráfico
que pasará a través del cortafuegos.
La palabra que va entre paréntesis indica la etiqueta que se
usará para esa política.

<p>
Ahora hay que escribir las reglas para clasificar 
los paquetes dentro de la política.
<blockquote>
<tt>
block all<br>
pass out on $ext_if tag LAN_INET_NAT tagged LAN_INET nat-to ($ext_if)<br>
pass in on $int_if from $int_net tag LAN_INET<br>
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ<br>
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ<br>
pass in on $ext_if proto tcp from &lt;spamd&gt; to port smtp \<br>
&nbsp;&nbsp;&nbsp;tag SPAMD rdr-to 127.0.0.1 port 8025<br>
</tt>
</blockquote>

<p>
A continuación hay que configurar las reglas que definen esa
política.
<blockquote>
<tt>
pass in &nbsp;quick on $ext_if tagged SPAMD<br>
pass out quick on $ext_if tagged LAN_INET_NAT<br>
pass out quick on $dmz_if tagged LAN_DMZ<br>
pass out quick on $dmz_if tagged INET_DMZ
</tt>
</blockquote>

<p>
Ahora que ya se ha configurado el conjunto de reglas, para efectuar
cualquier cambio basta con modificar las reglas de clasificación.
Por ejemplo, si se añade un servidor de POP3/SMTP a la DMZ,
habrá que añadir reglas de clasificación para el
tráfico tipo POP3 y SMTP, como lo siguiente:
<blockquote>
<tt>
mail_server = "192.168.0.10"<br>
...<br>
pass in on $ext_if proto tcp to $mail_server port { smtp, pop3 } \<br>
&nbsp;&nbsp;&nbsp;tag INET_DMZ
</tt>
</blockquote>

<p>
Con esto se permitirá el paso al tráfico de correo
electrónico como parte de la entrada de política INET_DMZ.

<p>
Finalmente, el conjunto completo de reglas:
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros
int_if  = "dc0"
dmz_if  = "dc1"
ext_if  = "ep0"
int_net = "10.0.0.0/24"
dmz_net = "192.168.0.0/24"
www_server = "192.168.0.5"
mail_server = "192.168.0.10"

table &lt;spamd&gt; persist file "/etc/spammers"

# clasificación -- clasificar los paquetes basándose en la política
# definida del cortafuegos
block all
pass out on $ext_if tag LAN_INET_NAT tagged LAN_INET nat-to ($ext_if)<br>
pass in on $int_if from $int_net tag LAN_INET<br>
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ<br>
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ
pass in on $ext_if proto tcp from &lt;spamd&gt; to port smtp \<br>
&nbsp;&nbsp;&nbsp;tag SPAMD rdr-to 127.0.0.1 port 8025<br>

# imposición de la política -- pasar/bloquear basándose en la política
# definida del cortafuegos
pass in  quick on $ext_if tagged SPAMD
pass out quick on $ext_if tagged LAN_INET_NAT
pass out quick on $dmz_if tagged LAN_DMZ
pass out quick on $dmz_if tagged INET_DMZ
</pre>
</td></tr>
</table>

<a name="ethernet"></a>
<h2>Marcado de tramas de Ethernet</h2>
<p>
El marcado también se puede aplicar en el nivel de Ethernet
si la máquina que está realizando el marcado/filtrado
también hace la vez de puente de red
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&amp;sektion=4"
>bridge(4)</a>).
Creando reglas de filtrado para bridge(4) que usen la clave
<tt>tag</tt>, se puede hacer que PF filtre basándose en la
dirección MAC de origen/destino.
Las reglas para bridge(4) se crean usando la orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a>.  Ejemplo:
<blockquote>
<tt>
# ifconfig bridge0 rule pass in on fxp0 src 0:de:ad:be:ef:0 \<br>
&nbsp;&nbsp;&nbsp;tag USER1
</tt>
</blockquote>

<p>
Y a continuación, en el fichero <tt>pf.conf</tt>:
<blockquote>
<tt>
pass in on fxp0 tagged USER1
</tt>
</blockquote>

<p>
[<a href="pools.html">Anterior: Reservas de direcciones y
balanceo de carga</a>]
[<a href="index.html">Contenido</a>]
[<a href="logging.html">Siguiente: Registros de
bitácora</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: tagging.html,v 1.21 ]<br>
$Translation: tagging.html,v 1.4 2011/03/01 22:22:49 mvidal Exp $<br>
-->
$OpenBSD: tagging.html,v 1.4 2011/03/04 16:16:15 ajacoutot Exp $
</small>

</body>
</html> 
