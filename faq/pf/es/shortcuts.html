<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Atajos para la creación de conjuntos de reglas</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="rdr.html">Anterior: Redireccionamiento de tráfico
(reenvío de puertos)</a>]
[<a href="index.html">Contenido</a>]
[<a href="options.html">Siguiente: Opciones en tiempo de
ejecución</a>]

<p>
<h1>
<font color="#e00000">PF: Atajos para la creación de conjuntos de
reglas</font>
</h1>

<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#intro">Introducción</a>
<li><a href="#macros">Uso de macros</a>
<li><a href="#lists">Uso de listas</a>
<li><a href="#grammar">Gramática de PF</a>
       <ul>
       <li><a href="#elim">Eliminación de palabras-clave</a>
	   <li><a href="#return">Simplificación de reglas con
	   <tt>return</tt></a>
       <li><a href="#order">Orden de las palabras-clave</a>
       </ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introducción</h2>
<p>
Con PF existen muchas formas para simplificar un conjunto de reglas.
Algunas formas de simplificar las reglas son el uso de
<a href="macros.html#macros">macros</a> y
<a href="macros.html#lists">listas</a>.  Además, el lenguaje del
conjunto de reglas, o gramática, también ofrece algunos
atajos para simplificar los conjuntos de reglas.  Como regla general, el
conjunto de reglas más simple es aquel que es más
fácil de entender y de mantener.

<a name="macros"></a>
<h2>Uso de macros</h2>
<p>
Las macros son útiles porque ofrecen un modo alternativo de
fijar direcciones, números de puertos, nombres de interfaces,
etc. dentro de un mismo conjunto de reglas.  &iquest;Ha cambiado la
dirección IP del servidor?  No hay problema, basta con actualizar
la macro;  no es necesario cambiar las reglas de filtrado que nos ha
costado tanto perfeccionar.

<p>
Una convención común en los conjuntos de reglas de PF es
la de definir una macro por cada interfaz de red.  Si una tarjeta de red
tuviera que ser reemplazada con otra que usara un controlador diferente,
por ejemplo si cambiáramos una de 3Com por una de Intel, se
podría actualizar la macro y las reglas de filtrado
seguirían funcionando como antes.  Otra ventaja de las macros es
cuando hay que instalar un mismo conjunto de reglas en varias
máquinas.  Unas máquinas pueden tener unas tarjetas de red
diferentes a las de otras máquinas, y el uso de macros para
definir las interfaces de red permitiría instalar los conjuntos
de reglas realizando unos cambios mínimos de edición.  El
uso de macros para definir información en un conjunto de reglas
que está sujeto a cambios, como pueden ser los números de
puertos, direcciones IP, y nombres de interfaces, es una práctica
recomendada.
<blockquote>
<tt>
# definir macros para cada interfaz de red<br>
IntIF = &quot;dc0&quot;<br>
ExtIF = &quot;fxp0&quot;<br>
DmzIF = &quot;fxp1&quot;
</tt>
</blockquote>

<p>
Otra convención común es la de usar macros para definir
direcciones IP y bloques de red.  Con esta práctica se puede
reducir bastante el mantenimiento de un conjunto de reglas cuando
cambien las direcciones IP.
<blockquote>
<tt>
# definir nuestras redes<br>
IntNet = &quot;192.168.0.0/24&quot;<br>
ExtAdd = &quot;24.65.13.4&quot;<br>
DmzNet = &quot;10.0.0.0/24&quot;
</tt>
</blockquote>

<p>
Si alguna vez hubiera que expandir la red interna o se renumerara en un
bloque IP diferente, bastaría con actualizar la macro:
<blockquote>
<tt>
IntNet = &quot;{ 192.168.0.0/24, 192.168.1.0/24 }&quot;
</tt>
</blockquote>

<p>
Una vez que se volviera a cargar el conjunto de reglas, todo
volvería a funcionar como antes.

<a name="lists"></a>
<h2>Uso de listas</h2>
<p>
Veamos unas buenas reglas para incluir en nuestro conjunto de reglas
que sirven para el manejo de direcciones
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>; estas
direcciones no deberían estar por Internet, y cuando lo
están suele ser para crear problemas:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 127.0.0.0/8<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 10.0.0.0/8
</tt>
</blockquote>

<p>
Ahora veamos una simplificación de lo anterior:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from { 127.0.0.0/8, 192.168.0.0/16, \<br>
&nbsp;&nbsp;&nbsp;172.16.0.0/12, 10.0.0.0/8 } to any<br>
block out quick on tl0 inet from any to { 127.0.0.0/8, \<br>
&nbsp;&nbsp;&nbsp;192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }
</tt>
</blockquote>

<p>
El conjunto de reglas se ha reducido de ocho a dos líneas.  Y
todavía puede mejorar si usamos macros en conjunción con
una lista:
<blockquote>
<tt>
NoRouteIPs = &quot;{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \<br>
&nbsp;&nbsp;&nbsp;10.0.0.0/8 }&quot;
<br>
ExtIF = &quot;tl0&quot;<br>
block in &nbsp;quick on $ExtIF from $NoRouteIPs to any<br>
block out quick on $ExtIF from any to $NoRouteIPs
</tt>
</blockquote>

<p>
Nótese que las macros y las listas simplifican el fichero
<tt>pf.conf</tt>, aunque en realidad
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>pfctl(8)</a>
expande las líneas en reglas múltiples.  Por lo tanto, el
ejemplo anterior se expandiría a las siguientes líneas:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 10.0.0.0/8<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 127.0.0.0/8
</tt>
</blockquote>

<p>
Como se puede ver, la expansión de PF no es más que una
conveniencia para quien escribe y mantiene el fichero <tt>pf.conf</tt>,
y no una simplificación real de las reglas procesadas por
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.8"
>pf(4)</a>.

<p>
Las macros se pueden usar para definir algo más que direcciones y
puertos;  se pueden usar en cualquier parte de un fichero de reglas de
PF:
<blockquote>
<tt>
pre  = "pass in quick on ep0 inet proto tcp from "<br>
post = "to any port { 80, 6667 }"<br>
<br>
# la clase de David<br>
$pre 21.14.24.80 $post<br>
<br>
# la casa de Nick<br>
$pre 24.2.74.79 $post<br>
$pre 24.2.74.178 $post
</tt>
</blockquote>

<p>
Se expandirían a:
<blockquote>
<tt>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80<br>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667
</tt>
</blockquote>

<a name="grammar"></a>
<h2>Gramática de PF</h2>
<p>
La sintaxis usada por Packet Filter es bastante flexible, lo que a su
vez permite una gran flexibilidad en los juegos de reglas.  PF es capaz
de deducir ciertas palabras-clave, lo que significa que no es necesario mantener
el estado de forma explícita en una regla, y el orden que siguen
las palabras-clave es lo suficientemente sencillo como para que no sea necesario
memorizar la sintaxis completamente.

<a name="elim"></a>
<h3>Eliminación de palabras-clave</h3>
<p>
Para definir una política de denegación predeterminada, se
usan dos reglas:
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
Que se pueden reducir a:
<blockquote>
<tt>
block
</tt>
</blockquote>

<p>
Cuando no se especifica la dirección, PF asume que la regla es
aplicable a los paquetes que van en ambas direcciones.

<p>
De forma parecida, las cláusulas <tt>from any to any</tt> y
<tt>all</tt> se pueden dejar fuera de una regla;  por ejemplo:
<blockquote>
<tt>
block in on rl0 all<br>
pass &nbsp;in quick log on rl0 proto tcp from any to any port 22 keep state
</tt>
</blockquote>

<p>
que se puede simplificar en:
<blockquote>
<tt>
block in on rl0<br>
pass &nbsp;in quick log on rl0 proto tcp to port 22 keep state</tt>
</blockquote>

<p>
La primera regla bloquea el paso a todos los paquetes entrantes desde
cualquier origen hacia cualquier destino en rl0, y la segunda regla
permite el paso al tráfico TCP entrante en rl0 hacia el puerto
22.
 
<a name="return"></a>
<h3>Simplificación de <tt>return</tt></h3>
<p>
Un conjunto de reglas que se usara para bloquear paquetes y responder
con un TCP RST o con un ICMP Unreachable sería así:
<blockquote>
<tt>
block in all<br>
block return-rst in proto tcp all<br>
block return-icmp in proto udp all<br>
block out all<br>
block return-rst out proto tcp all<br>
block return-icmp out proto udp all
</tt>
</blockquote>

<p>
Esto se puede simplificar a:
<blockquote>
<tt>
block return
</tt>
</blockquote>

<p>
Cuando PF ve la palabra-clave <tt>return</tt>, es lo suficientemente listo como
para enviar la respuesta correcta o ninguna respuesta, dependiendo del
protocolo del paquete que se esté bloqueando.

<a name="order"></a>
<h3>Orden de las palabras-clave</h3>
<p>
El orden en el que se especifican las palabras-clave es flexible en la
mayoría de los casos.  Por ejemplo, una regla escrita como:
<blockquote>
<tt>
pass in log quick on rl0 proto tcp to port 22 \<br> 
&nbsp;&nbsp;&nbsp;flags S/SA keep state queue ssh label ssh
</tt>
</blockquote>

<p>
También se puede escribir como:
<blockquote>
<tt>
pass in quick log on rl0 proto tcp to port 22 \<br>
&nbsp;&nbsp;&nbsp;queue ssh keep state label ssh flags S/SA
</tt>
</blockquote>

<p>
Otras variaciones similares también funcionarán.

<p>
[<a href="rdr.html">Anterior: Redireccionamiento de tráfico
(reenvío de puertos)</a>]
[<a href="index.html">Contenido</a>]
[<a href="options.html">Siguiente: Opciones en tiempo de
ejecución</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: shortcuts.html,v 1.26 ]<br>
$Translation: shortcuts.html,v 1.12 2011/02/19 22:24:35 mvidal Exp $<br>
-->
$OpenBSD: shortcuts.html,v 1.11 2011/02/20 10:08:24 ajacoutot Exp $
</small>

</body>
</html> 
