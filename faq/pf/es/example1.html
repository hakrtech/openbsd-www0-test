<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Ejemplo: Cortafuegos para red doméstica u oficina</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Anterior: Redundancia de cortafuegos con CARP y pfsync</a>]
[<a href="index.html">Contenido</a>]


<p>
<h1><font color="#e00000">PF: Ejemplo: Cortafuegos para red doméstica 
u oficina</font></h1>
<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#scenario">El escenario</a>
	<ul>
	<li><a href="#network">La red</a>
	<li><a href="#objective">El objetivo</a>
	<li><a href="#prep">Preparación</a>
	</ul>
<li><a href="#ruleset">El grupo de reglas</a>
	<ul>
	<li><a href="#macros">Macros</a>
	<li><a href="#options">Opciones</a>
	<li><a href="#rules">Reglas de cortafuegos</a>
	</ul>
<li><a href="#allrules">El grupo de reglas completo</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>El escenario</h2>
<p>
En este ejemplo, PF funciona en una máquina OpenBSD que actúa como
cortafuegos y pasarela de NAT para una pequeña red en casa o en
la oficina.  El objetivo final es el de dar acceso a Internet desde
la red, permitir un acceso limitado a la máquina cortafuegos
desde Internet y exponer un servidor web interno a Internet.  
En este documento se repasa un grupo de reglas completo
con este fin.

<a name="network"></a>
<h3>La red</h3>
<p>
La configuración de la red es como sigue:

<pre>
    
  [ COMP1 ]    [ COMP3 ]
      |            |                               
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
En la red interna hay varios ordenadores;  el diagrama muestra
sólo tres, aunque el número real es irrelevante.  
Estos ordenadores son estaciones de trabajo normales que se
usan para navegar por la web, correo electrónico, charlas
en línea (<i>chats</i>), etc., excepto COMP3 que además corre un pequeño
servidor web.
La red interna usa el bloque de red 192.168.0.0 / 255.255.255.0.

<p>
El cortafuegos OpenBSD es un Celeron 300 con dos tarjetas de red: una 3Com
3c905B (<tt>xl0</tt>) y una Intel EtherExpress Pro/100 (<tt>fxp0</tt>).  
El cortafuegos tiene una conexión de cable a
Internet y está usando NAT para compartir esta conexión
con la red interna.  La dirección IP en la interfaz externa la
asigna de forma dinámica el proveedor de Internet (ISP).

<a name="objective"></a>
<h3>El objetivo</h3>
Los objetivos son:
<ul>
<li>Dar acceso a Internet sin restricciones a cada uno de los
ordenadores internos.
<li>Usar un grupo de reglas de filtrado con &laquo;denegación
predeterminada&raquo;.
<li>Permitir el paso del siguiente tráfico entrante al
cortafuegos desde Internet:
	<ul>
	<li>SSH (TCP puerto 22): se usará para el mantenimiento
	remoto de la máquina cortafuegos.
	<li>Auth/Ident (TCP puerto 113): usado por algunos servicios como
	SMTP e IRC.
	<li>ICMP Echo Requests: el tipo de paquete ICMP usado por
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
>ping(8)</a>.
	</ul>
<li>Redireccionar intentos de conexión al puerto TCP 80 (accesos a un servidor
	web) a la máquina COMP3.
Permitir también el tráfico por el puerto TCP 80 destinado a COMP3 a través
	del cortafuegos.
<li>Registrar estadísticas de filtrado en la interfaz externa.
<li>Contestar, de modo predeterminado, con un TCP RST o <i>ICMP
Unreachable</i> a los paquetes bloqueados.
<li>Conseguir un grupo de reglas tan simple y fácil de mantener
como sea posible.
</ul>

<a name="prep"></a>
<h3>Preparación</h3>
<p>
En este documento se asume que se ha configurado correctamente el
anfitrión con OpenBSD para que funcione como un enrutador,
incluida la verificación de la configuración de redes IP,
la conexión a Internet y haber configurado las variables 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> <tt>net.inet.ip.forwarding</tt> 
y/o <tt>net.inet6.ip6.forwarding</tt> con el valor "<tt>1</tt>".

<a name="ruleset"></a>
<h2>El grupo de reglas</h2>
<p>
A continuación construiremos un grupo de reglas que
lograrán los objetivos anteriores.

<a name="macros"></a>
<h3>Macros</h3>
<p>
Las siguientes macros se han definido para facilitar el mantenimiento y
la lectura del grupo de reglas:
<blockquote><pre>
int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"
</pre></blockquote>

<p>
La primera línea define la interfaz de red interna en la que
tendrá lugar el filtrado.
Al definirlas aquí, si tenemos que mover este sistema a otra
máquina con diferente hardware, podemos cambiar solo estas dos
líneas, y el resto de reglas seguirán siendo válidas.
(Para este ejemplo, la interfaz externa será manejada usando 
la interfaz de grupo <tt>egress</tt>.
Esto es automáticamente configurado en cualquier interfaz que 
contenga una ruta por defecto, en este caso fxp0).
La segunda y tercera líneas son una lista de los números de 
puertos TCP de los servicios que se abrirán a Internet 
(SSH e ident/auth) y de los tipos de paquetes ICMP a los se 
que les permitirá llegar a la máquina cortafuegos. 
Finalmente, la última línea define la dirección IP de COMP3.

<p>
<b>Nota</b>: Si la conexión de Internet requiere
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=4"
>PPPoE</a>, entonces el filtrado y el NAT tendrían que realizarse 
en la interfaz <tt>pppoe0</tt>y <i>no</i> en <tt>fxp0</tt>.

<a name="options"></a>
<h3>Opciones</h3>
<p>
Con las siguientes dos opciones se configura la respuesta predeterminada
para las reglas de filtrado <tt>block</tt>, y se activa el registro de
estadísticas para la interfaz externa:
<blockquote><pre>
set block-policy return
set loginterface fxp0
</pre></blockquote>

<p>
Todo sistema Unix tiene una interfaz de retrobucle (<i>loopback</i>). Se trata de
una interfaz virtual de red que usan las aplicaciones para comunicarse
entre sí mismas dentro del sistema.  En OpenBSD, la
interfaz de <i>loopback</i> es
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>. Se considera una buena práctica desactivar todo filtrado
en las interfaces <i>loopback</i>.
Por medio de <a href="options.html#skip">set skip</a> lograremos esto:
<blockquote><pre>
set skip on lo
</pre></blockquote>
<!-- XXX this should be interface groups, but PF (at least up to
 4.8) just does a substring match on the interface name -->
Tenga en cuenta que nos estamos saltando el filtrado para todos los 
interfaces <tt>lo</tt>. De esta manera, si más tarde debemos añadir 
interfaces <i>loopback</i> suplementarios, no tendríamos que preocuparnos 
por la modificación de esta parte de nuestro actual fichero de reglas.

<a name="rules"></a>
<h3>Reglas del cortafuegos</h3>

Comenzaremos con las reglas para soportar el uso de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>ftp-proxy(8)</a>, 
de modo que los clientes FTP en la red local puede conectarse 
a servidores FTP en Internet. Esto funciona mediante 
la inserción dinámica de las reglas cuando se realiza una conexión 
ftp. Se hace por medio de un <a href="anchors.html">anclaje</a>:
<blockquote><pre>
anchor "ftp-proxy/*"
</pre></blockquote>

<p>
Ahora añadiremos la regla que permita la redirección 
de las conexiones FTP para que puedan ser vistas por 
ftp-proxy(8):
<blockquote><pre>
pass in quick on $int_if inet proto tcp to any port ftp \
    rdr-to 127.0.0.1 port 8021
</pre></blockquote>

<p>
Esta regla interceptará las conexiones FTP en el puerto 21 
y las redirigirá a una instancia ftp-proxy(8) que se ejecuta 
en el puerto 8021 y, a través del uso de la palabra clave 
<tt>quick</tt>, los paquetes válidos no serán 
verificados por el resto del conjunto de reglas. 
Si los usuarios se conectan regularmente a los servidores FTP 
en otros puertos, entonces se debe utilizar una lista para 
especificar el puerto de destino, por ejemplo: 
<tt>to any port { 21, 2121 }</tt>.

<p>
Hay que subrayar que tanto el <a href="anchors.html">anclaje</a> como la regla
de redirección 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>ftp-proxy(8)</a> necesitan ser situados antes de cualquier 
regla <tt>match</tt> para el NAT o el ftp-proxy(8) no funcionará
como se espera.

<p>
Ahora vamos a ver las reglas <tt>match</tt>. 
Por sí misma, una regla <tt>match</tt> no determina 
si a un paquete se le permite o no pasar. En cambio, 
se almacenarán los parámetros de los paquetes que coincidan 
con esta regla y se utilizarán en cualquier regla
<tt>pass</tt> que luego valide estos paquetes.

<p>
Esto es potente: parámetros tales como <a href="nat.html">NAT</a>
o <a href="queueing.html">formación de colas</a> (<i>queueing</i>) 
pueden aplicarse a ciertas clases de paquetes y los permisos de acceso 
definirse después por separado.

<p>
Para disponer de NAT en toda la red interna se utiliza la siguiente regla
<tt>match</tt>:
<blockquote><pre>
match out on egress inet from !(egress:network) to any nat-to (egress:0)
</pre></blockquote>

<p>
En este caso, el "<tt>!(egress:network)</tt>" podría ser fácilmente 
reemplazado por un "<tt>$int_if:network</tt>", pero si usted ha agregado 
múltiples interfaces internas, habría que añadir reglas NAT adicionales, 
mientras que con esta estructura NAT será manejado en todas las interfaces 
protegidas.

<p>
Dado que la dirección IP de la interfaz externa se asigna dinámicamente,
los paréntesis se colocan en torno a la interfaz de traducción para que PF
sea avisado cuando la dirección cambia.
El sufijo :0 se utiliza para que si la interfaz externa tiene múltiples
direcciones, sólo la primera dirección se utilice para la traducción.

<p>
Para acabar, se especifica la familia de protocolos <tt>inet</tt> (IPv4)
Esto suprime la traducción de todos los paquetes <tt>inet6</tt> (IPv6)
que puedan ser recibidos. 

<p>
Ahora las reglas para controlar los permisos de acceso.
Se empieza con una denegación de forma predeterminada:
<blockquote><pre>
block in log
</pre></blockquote>

<p>
En este punto todo el tráfico que intenta entrar en la interfaz será
bloqueado, incluso el que proviene de la red interna. 
Estos paquetes también son logueados.
Las reglas siguientes abrirán el cortafuegos de acuerdo con los objetivos
descritos anteriormente, y abrirán también todos los interfaces virtuales
necesarios.

<p>
Tenga en cuenta que pf puede bloquear el tráfico entrante o saliente 
de un interfaz.
Puede simplificar su vida si usted elige filtrar el tráfico en una
dirección, en lugar de tratar de bloquear entrada y salida.
En nuestro caso, optaremos por filtrar únicamente el tráfico de entrada, 
pero una vez permitida la entrada en una interfaz, no vamos a 
tratar de obstruir la salida, por lo que haremos lo siguiente:

<blockquote><pre>
pass out quick
</pre></blockquote>

Utilizando <tt>quick</tt> puede evitarse que los paquetes salientes sean
verificados contra las reglas siguientes, mejorando así el rendimiento.

<p>
Es útil usar también la <a href="filter.html#antispoof">protección contra 
la falsificación de direcciones</a> (<i>antispoofing</i>):
<blockquote><pre>
antispoof quick for { lo $int_if }
</pre></blockquote>

<p>
Ahora abrimos los puertos usados por los servicios de red
que estarán disponibles desde Internet.
Primero, el tráfico que se destina al cortafuegos mismo: 

<blockquote><pre>
pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services
</pre></blockquote>

<p>
Especificar los puertos de red en la macro 
<tt>$tcp_services</tt> simplifica la apertura 
de servicios adicionales a Internet, simplemente mediante
la edición de la macro y la recarga del conjunto de reglas. 
Los servicios UDP también pueden abrirse mediante la creación de 
una macro <tt>$udp_services</tt> y la adición de una regla de filtrado,
similar a la indicada anteriormente, que especifique <tt>proto udp</tt>.

<p>
La siguiente regla captura cualquier intento de conexión desde Internet 
por medio del puerto TCP 80 del cortafuegos.
Los intentos legítimos para acceder a este puerto procederán de usuarios 
que tratan de acceder al servidor web de la red.
Estos intentos de conexión deben ser redirigidos a COMP3:

<blockquote><pre>
pass in on egress inet proto tcp to (egress) port 80 \
    rdr-to $comp3 synproxy state
</pre></blockquote>

<p>
Para incrementar un poco la seguridad, usaremos el 
<a href="filter.html#synproxy">proxy de paquetes TCP SYN</a> 
con el fin de proteger el servidor web.

<p>
Debe permitirse el tráfico ICMP:
<blockquote><pre>
pass in inet proto icmp all icmp-type $icmp_types
</pre></blockquote>

<p>
Similar a la macro <tt>$tcp_services</tt>, la macro <tt>$icmp_types</tt> 
puede fácilmente ser modificada para alterar los tipos de paquetes ICMP
que serán autorizados a alcanzar el cortafuegos. Téngase en cuenta que esta
regla se aplica a todas las interfaces de red.

<p>
Ahora el tráfico de la red interna debe ser permitido. 
Asumimos que los usuarios de la red interna
saben lo que hacen y no causarán problemas. Esto no es
 necesariamente una asunción válida para muchos
entornos; para muchos otros contextos pueden ser más apropiado  
un conjunto de reglas más restrictivo.
<blockquote><pre>
pass in on $int_if
</pre></blockquote>

<p>
Se permite que el tráfico TCP, UDP y ICMP salga del cortafuegos
hacia Internet gracias a la regla precedente "<tt>pass out</tt>".  
La información sobre el estado se guarda para
que los paquetes de vuelta pasen a través del cortafuegos.

<a name="allrules"></a>
<h2>El grupo de reglas completo</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros

int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"

# opciones

set block-policy return
set loginterface fxp0
set skip on lo

# reglas proxy FTP

anchor "ftp-proxy/*"

pass in quick on $int_if inet proto tcp to any port ftp \
    rdr-to 127.0.0.1 port 8021

# reglas match

match out on egress inet from !(egress) to any nat-to (egress:0)

# reglas de filtrado

block in log
pass out quick

antispoof quick for { lo $int_if }

pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services

pass in on egress inet proto tcp to (egress) port 80 \
    rdr-to $comp3 synproxy state

pass in inet proto icmp all icmp-type $icmp_types

pass in on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Anterior: Redundancia de cortafuegos con CARP y pfsync</a>]
[<a href="index.html">Contenido</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.45 ]<br>
$Translation: example1.html,v 1.11 2011/02/16 14:46:56 mvidal Exp $<br>
-->
$OpenBSD: example1.html,v 1.9 2011/02/17 23:28:45 ajacoutot Exp $
</small>

</body>
</html> 
