<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Cuestiones relacionadas con FTP</title><link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003, 2004, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="perf.html">Anterior: Rendimiento</a>]
[<a href="index.html">Contenido</a>]
[<a href="authpf.html">Siguiente: Shell de usuario para pasarelas
de autentificación</a>]

<p>
<h1><font color="#e00000">PF: Cuestiones relacionadas con
FTP</font></h1>
<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#modes">Modos de FTP</a>
<li><a href="#client">Cliente de FTP detrás de un cortafuegos</a>
<li><a href="#server">Autoprotección de un servidor de FTP con
PF</a>
<li><a href="#natserver">Servidor de FTP protegido por un cortafuegos de
PF externo con NAT</a>
<li><a href="#info">Más información sobre FTP</a>
<li><a href="#tftp-proxy">Proxy de TFTP</a>
</ul>

<hr>

<a name="modes"></a>
<h2>Modos de FTP</h2>
FTP es un protocolo que se remonta a los tiempos cuando Internet era una
pequeña colección de computadoras, basada en la confianza mutua, 
y todo el mundo se conocía.  En esos tiempos no
existía la necesidad de filtrar o de reforzar la seguridad.  Como
consecuencia, FTP no se diseñó para el filtrado ni para
que pasara a través de cortafuegos o para que funcionara con NAT.

<p>
Se puede usar FTP de dos modos:  pasivo o activo.  Generalmente, la
elección entre el modo activo o el pasivo se toma para determinar
quién tiene el problema con los cortafuegos.  La realidad es que
para mantener a los usuarios contentos tendrá que dar soporte 
para ambos modos.

<p>
Con FTP activo, cuando un usuario se conecta a un servidor de FTP remoto
y requiere información o un fichero de este, el servidor
de FTP abre una nueva conexión de vuelta al cliente para
transferir los datos que le ha requerido.  Esto se conoce como la
<i>conexión de datos</i>.  Para empezar, el cliente de FTP escoge
un puerto aleatorio por el que recibirá la conexión de
datos.  El cliente envía al servidor de FTP el número de
puerto que ha escogido, y permanece a la espera de recibir una
conexión entrante por este puerto.  Entonces el servidor de FTP
inicia una conexión a la dirección del cliente por el
puerto elegido, y da comienzo a la transferencia de los datos.  Esto
supone un problema para los usuarios que intenten obtener acceso a
servidores de FTP que se encuentren detrás de una pasarela de
NAT.  Debido al funcionamiento propio de NAT, el servidor de FTP inicia
la conexión de datos conectándose a la dirección
externa de la pasarela de NAT por el puerto elegido.  La máquina
de NAT recibe esta conexión, pero como no tiene asignación
para el paquete en su tabla de estado, lo bloquea y no lo entrega al
cliente.

<p>
Con el modo pasivo de FTP (el modo predeterminado con el cliente de
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1"
>ftp(1)</a> de OpenBSD),
el cliente envía un requerimiento al servidor para que
éste escoja un puerto aleatorio en el que permanezca a la escucha
en espera de la conexión de datos.  El servidor informa al
cliente sobre el puerto que ha escogido, y el cliente se conecta a este
puerto para la transferencia de datos.  Desafortunadamente, esto no es
siempre posible o deseable debido a la posiblidad de que exista un
cortafuegos delante del servidor de FTP bloqueando la conexión de
datos entrante.  En OpenBSD, ftp(1) está configurado para usar el
modo pasivo de forma predeterminada; para forzar el modo activo de FTP,
hay que usar el indicador -A de la orden ftp, o desactivar el modo
pasivo mediante la orden <tt>passive off</tt> desde el punto de
inserción (<i>prompt</i>) de <tt>ftp&gt;</tt>.


<a name="client"></a>
<h2>Cliente de FTP detrás de un cortafuegos</h2>
<p>
Como se ha indicado anteriormente, FTP no va demasiado bien 
a través de NAT y cortafuegos.

<p>
PF dispone de una solución para esta situación,
redireccionando el tráfico de FTP a través de un servidor
<i>proxy</i> de FTP. Este proceso actúa como
&laquo;guía&raquo; para el tráfico de FTP a través
de la pasarela/cortafuegos de NAT, añadiendo activamente 
las reglas necesarias y eliminándolas cuando ya no sean necesarias
a través del sistema de <a href="anchors.html">anclajes</a> de PF.  
El <i>proxy</i> de FTP que usa PF es 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>ftp-proxy(8)</a>.

<p>
Para activarla, añada una línea parecida a la
siguiente en la sección de reglas de <tt>pf.conf</tt>:

<blockquote>
<tt>
pass in quick on $int_if proto tcp to port 21 rdr-to 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Esto redirecciona el FTP de nuestros clientes hacia el programa 
ftp-proxy(8), que está a la escucha en nuestra máquina por el 
puerto 8021.

<p>
También se necesita un anclaje en la sección de reglas:
<blockquote>
<tt>
anchor "ftp-proxy/*"
</tt>
</blockquote>

Evidentemente,  el servidor proxy debe estar iniciado y ejecutándose
en la máquina OpenBSD. Esto se hace incluyendo la siguiente línea en
<tt>/etc/rc.conf.local</tt>:

<blockquote>
<tt>
ftpproxy_flags=""
</tt>
</blockquote>

<p>
El programa ftp-proxy puede arrancarse como root para 
activarlo a fin de evitar un reinicio del sistema.

<p>
ftp-proxy está a la escucha en el puerto 8021, 
el mismo puerto al que la línea <tt>rdr-to</tt> 
precedente estaba enviando el tráfico de FTP.

<p>
Para soportar el modo de conexiones activas de 
determinados clientes (quisquillosos), es posible que 
necesite utilizar el parámetro '-r' en ftp-proxy(8).

<a name="server"></a>
<h2>"Autoprotección" de un servidor de FTP con PF</h2>
<p>
Para este caso, PF estaría funcionando en el mismo servidor de
FTP, en lugar de hacerlo en una máquina separada de cortafuegos.
Cuando dé servicio a una conexión de FTP pasiva, FTP
usará un puerto TCP alto, aleatorio, para los datos entrantes.
El servidor de FTP nativo de OpenBSD <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8"
>ftpd(8)</a> está configurado para usar
de forma predeterminada un puerto en el rango entre 49152 y 65535.
Obviamente, es necesario permitir el paso para estos puertos, junto con
el puerto 21 (el puerto de control de FTP):

<blockquote>
<tt>
pass in on $ext_if proto tcp to port 21<br>
pass in on $ext_if proto tcp to port &gt; 49151
</tt>
</blockquote>

<p>
Nótese que, si lo desea, es posible restringir el rango de puertos de forma
considerable.  En el caso del programa
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8"
>ftpd(8)</a> de OpenBSD, esto se hace usando las variables
<tt>net.inet.ip.porthifirst</tt> y <tt>net.inet.ip.porthilast</tt> de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8"
>sysctl(8)</a>.

<a name="natserver"></a>
<h2>Servidor de FTP protegido por un cortafuegos de PF con NAT</h2>
En este caso, el cortafuegos debe redireccionar el tráfico al
servidor de FTP, además de no bloquear los puertos requeridos.
Para lograr esto, volvemos de nuevo a ftp-proxy(8).

<p>
ftp-proxy(8) se puede ejecutar en un modo que hace que se 
redireccionen toda las conexiones FTP a un determinado servidor FTP.
Básicamente configuramos el proxy para que escuche en el 
puerto 21 del cortafuegos y redireccionamos las conexiones 
al servidor final.

<p>
Edite el fichero <tt>/etc/rc.conf.local</tt> y añada lo siguiente:

<blockquote>
<tt>
ftpproxy_flags="-R 10.10.10.1 -p 21 -b 192.168.0.1"
</tt>
</blockquote>

Aquí 10.10.10.1 es la dirección IP del servidor FTP real, 
21 es el puerto en el que queremos que ftp-proxy (8) escuche 
y 192.168.0.1 es la dirección en el cortafuegos para el proxy.

Ahora, para las reglas de pf.conf:

<blockquote>
<tt>
ext_ip = "192.168.0.1"<br>
ftp_ip = "10.10.10.1"<br>
<br>
match out on $ext_if inet from $int_if nat-to ($ext_if)<br>
<br>
anchor "ftp-proxy/*"<br>
pass in on $ext_if inet proto tcp to $ext_ip port 21<br>
pass out on $int_if inet proto tcp to $ftp_ip port 21 user proxy
</tt>
</blockquote>

<p>
Aquí permitimos la conexión entrante al puerto 21 en el interfaz
externo, así como la conexión de salida correspondiente al 
servidor de FTP.
La adición de "user proxy" a la regla de salida garantiza que solo
se permiten las conexiones iniciadas por ftp-proxy(8).

<p>
Tenga en cuenta que si usted desea ejecutar ftp-proxy(8) para 
proteger un servidor FTP sin impedir a los clientes salir 
fuera del firewall, son necesarias dos instancias de ftp-proxy.

<a name="info"></a>
<h2>Más información sobre FTP</h2>
<p>
Se puede encontrar más información sobre el filtrado  
y el funcionamiento de FTP en el siguiente documento:
<ul>
<li><a href="http://www.pintday.org/whitepapers/ftp-review.shtml">FTP
Reviewed</a>
</ul>

<a name="tftp-proxy"></a>
<h2>Proxy de TFTP</h2>

<p>
El Protocolo TFTP (<i>Trivial File Transfer Protocol</i>, 
&laquo;Protocolo de Transferencia de Ficheros Trivial&raquo;) 
sufre el mismo tipo de limitaciones que FTP cuando 
trata de atravesar un cortafuegos. Por suerte, PF 
dispone de un proxy de ayuda para TFTP llamado 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>tftp-proxy(8)</a>. 

<p>
tftp-proxy(8) se configura de una manera similar a como se hizo con 
ftp-proxy(8) en la sección anterior <a href="#client">Cliente de FTP detrás 
de un cortafuegos</a>. 


<blockquote>
<tt>
match out on $ext_if from $int_if nat-to ($ext_if)<br>
anchor "tftp-proxy/*"<br>
pass in quick on $int_if proto udp from $int_if to port tftp \<br>
&nbsp;&nbsp;&nbsp;&nbsp;rdr-to 127.0.0.1 port 6969<br>
<br>
anchor "tftp-proxy/*"
</tt>
</blockquote>

<p>
Las reglas anteriores autorizan la salida del tráfico TFTP 
de la red interna a los servidores TFTP en la la red externa.

<p>
El último paso es la activación de tftp-proxy en 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd.conf&amp;sektion=5"
>inetd.conf(5)</a> a fin de que escuche en el mismo puerto que la regla
<tt>rdr-to</tt> mencionada anteriormente, en este caso 6969.

<blockquote>
<tt>
127.0.0.1:6969  dgram   udp   wait  root  /usr/libexec/tftp-proxy tftp-proxy
</tt>
</blockquote>

<p>
A diferencia de ftp-proxy(8), tftp-proxy(8) se invoca vía inetd.

<p>
[<a href="perf.html">Anterior: Rendimiento</a>]
[<a href="index.html">Contenido</a>]
[<a href="authpf.html">Siguiente: Siguiente: Shell de usuario para pasarelas
de autentificación</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: ftp.html,v 1.32 ]<br>
$Translation: ftp.html,v 1.14 2011/02/25 12:16:18 mvidal Exp $<br>
-->
$OpenBSD: ftp.html,v 1.10 2011/02/25 12:35:57 ajacoutot Exp $
</small>

</body>
</html> 
