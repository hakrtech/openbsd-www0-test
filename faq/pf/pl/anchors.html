<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Zakotwiczenia i nazwane zestawy (pod)regu³</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="logging.html">Wstecz: Logowanie</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="shortcuts.html">Dalej: Skracanie zestawów regu³</a>]

<p>
<h1><font color="#e00000">PF: Zakotwiczenia i nazwane zestawy (pod)regu³</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wprowadzenie</a>
<li><a href="#named">Nazwane zestawy regu³</a>
<li><a href="#options">Opcje zakotwiczeñ</a>
<li><a href="#manip">Manipulowanie nazwanymi zestawami regu³</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Wprowadzenie</h2>
Poza g³ównym zestawem regu³, PF mo¿e przetwarzaæ tak¿e podzestawy.
Poniewa¿ podzestawy mog± byæ modfikowane w trakcie dzia³ania przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3"
><tt>pfctl(8)</tt></a>, mog± stanowiæ wygodny sposób dynamicznego
zarz±dzania aktywnym zestawem regu³. Podczas gdy
<a href="tables.html">tabele</a> s± wykorzystywane do
przechowywania dynamicznych list adresów, podzestawy
regu³ mog± przechowywaæ dynamiczne zestawy regu³ filtruj±cych,
<tt>nat</tt>, <tt>rdr</tt>, i <tt>binat</tt>.

<p>
Podzestawy regu³ s± do³±czane do g³ównego zestawu regu³ przy pomocy
zakotwiczeñ (ang. anchors). S± cztery typy regu³ zakotwiczeñ <tt>anchor</tt>:
<ul>
<li><tt>anchor <i>name</i></tt> - przetwarza wszystkie regu³y
<a href="filter.html">filtruj±ce</a>
w zakotwiczeniu <i><tt>name</tt></i>
<li><tt>binat-anchor <i>name</i></tt> - przetwarza wszystkie
regu³y <a href="nat.html#binat"><tt>binat</tt></a>
w zakotwiczeniu <i><tt>name</tt></i>
<li><tt>nat-anchor <i>name</i></tt> - przetwarza wszystkie regu³y
<a href="nat.html"><tt>nat</tt></a>
w zakotwiczeniu <i><tt>name</tt></i>
<li><tt>rdr-anchor <i>name</i></tt> - przetwarza wszystkie regu³y
<a href="rdr.html"> <tt>rdr</tt></a>
w zakotwiczeniu <i><tt>name</tt></i>
</ul>

Jedynie g³ówny zestaw regu³ mo¿e zawieraæ dyrektywy <tt>anchor</tt>.

<a name="named"></a>
<h2>Nazwane zestawy regu³</h2>
Nazwany zestaw regu³, to grupa regu³ filtruj±cych i/lub translacji,
które maj± przyporz±dkowan± nazwê. Punkty zakotwiczenia <tt>anchor</tt>
w g³ównym zestawie regu³ mog± zawieraæ wiele takich zestawów regu³.
Gdy PF natrafi na jak±¶ regu³ê <tt>anchor</tt>, zostan± rozwiniête
w kolejno¶ci alfabetycznej, zgodnie z ich nazwami, wszystkie
do³±czone do niego zestawy regu³. Porównywanie regu³ bêdzie nastêpnie
kontynuowane, chyba ¿e pakiet zostanie dopasowany do regu³y
korzystaj±cej z opcji <tt>quick</tt> lub regu³y translacyjnej w tym
zakotwiczeniu, kiedy to dopasowanie bêdzie uznane za ostateczne
i spowoduje zaniechanie dalszego porównywania regu³ w samym,
zakotwiczeniu jak i g³ównym zestawie regu³.

<p>
Na przyk³ad:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor goodguys
</tt>
</blockquote>

<p>
Ten zestaw regu³ sankcjonuje politykê domy¶lnego blokowania dla
zarówno przychodz±cego jak i wychodz±cego ruchu. Ruch jest
nastêpnie przepuszczany na zewn±trz wraz z ¶ledzeniem stanu po³±czenia,
a tak¿e tworzone jest zakotwiczenie nazwane  <tt><i>goodguys</i></tt>.
Aby dodaæ regu³ê do zakotwiczenia <tt><i>goodguys</i></tt> mo¿na
u¿yæ nastêpuj±cych komend:
<blockquote>
<tt>
# echo "pass in proto tcp from 192.0.2.3 to any port 22" \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys:ssh -f -
</tt>
</blockquote>

<p>
Dodaje ona regu³ê <tt>pass</tt> do zestawu nazwanego <tt><i>ssh</i></tt>
do³±czonego do zakotwiczenia <tt><i>goodguys</i></tt>. PF dokona nastêpnie
porównania tej regu³y (a tak¿e ka¿dej kolejnej, dodanej regu³y filtruj±cej)
z chwil±, gdy dotrze do linii <tt>anchor goodguys</tt> w g³ównym
zestawie regu³.

<p>
Regu³y mog± byæ tak¿e zapisywane i odczytywane z pliku tekstowego:
<blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys:www -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
Ostatnia komenda powoduje za³adowanie regu³ z pliku
<tt>/etc/anchor-goodguys-www</tt> do nazwanego zestawu regu³
<tt><i>www</i></tt> w zakotwiczeniu <tt><i>goodguys</i></tt>.

<p>
Regu³y filtruj±ce i translacyjne mog± byæ za³adowane z nazwanego
zestawu regu³ z wykorzystaniem tych samych opcji i sk³adni, co
przy ³adowaniu z g³ównego zestawu regu³.
Z zastrze¿eniem, i¿ wykorzystywane <a href="macros.html">makra</a> 
musz± byæ zdefiniowane w danym zestawie, a makra g³ównego
zestawu regu³ <i>nie</i> bêd± widoczne w nazwanych zestawach regu³.

<p>
Ka¿dy nazwany zestaw regu³, podobnie jak i g³ówny zestaw regu³
funkcjonuje niezale¿nie od innych zestawów. Operacje wykonywane
na pojedynczym zestawie, takie jak wyczyszczenie (ang. flush),
nie maj± wp³ywu na pozosta³e zestawy regu³. Ponad to, usuniêcie
zakotwiczenia z g³ównego zestawu regu³ nie niszczy zakotwiczenia,
ani ¿adnego nazwanego zestawu regu³, który jest do niego podpiêty.
Nazwany zestaw regu³ nie jest niszczony a¿ do momentu wyczyszczenia
wszystkich regu³ przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>pfctl(8)</a>. Kiedy punkt zakotwiczenia nie posiada ¿adnego,
podpiêtego zestawu tak¿e jest niszczony.

<a name="options"></a>
<h2>Opcje zakotwiczeñ</h2>
Opcjonalnie, regu³y <tt>anchor</tt> mog± precyzowaæ interfejs sieciowy,
protokó³, adres ¼ród³owy i docelowy itp przy pomocy tej samej sk³adni co
regu³y filtruj±ce. Je¶li takie informacje s± podawane, regu³y
<tt>anchor</tt> s± przetwarzane jedynie gdy pakiet pasuje do definicji
danej regu³y <tt>anchor</tt>.
Na przyk³ad:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor ssh in on $ext_if proto tcp from any to any port 22<br>
</tt>
</blockquote>

<p>
Regu³y zakotwiczenia <tt>anchor <i>ssh</i></tt> s± przetwarzane jedynie
dla pakietów TCP o docelowym porcie 22, i które nadchodz± przez fxp0.
Regu³y s± nastêpnie dodawane do zakotwiczenia <tt>anchor</tt>
w nastêpuj±cy sposób:
<blockquote>
<tt>
# echo "pass in from 192.0.2.10 to any" | pfctl -a ssh:allowed -f -
</tt>
</blockquote>

<p>
Mimo i¿ regu³y filtruj±ce nie precyzuj± interfejsu, protoko³u
czy portu, jedynie host 192.0.2.10 bêdzie mia³ prawo ³±czyæ siê
przy pomocy SSH ze wzglêdu na definicje zakotwiczenia <tt>anchor</tt>.

<a name="manip"></a>
<h2>Manipulowanie nazwanymi zestawami regu³</h2>
Manipulowanie nazwanymi zestawami regu³ odbywa siê poprzez
<tt>pfctl</tt>. Program ten mo¿e byæ wykorzystywany do dodawania
i usuwania regu³ z zestawu bez konieczno¶ci prze³adowywania
g³ównego zestawu regu³.

<p>
Aby wy¶wietliæ wszystkie regu³y zestawu <tt><i>allowed</i></tt>
podpiêtego do zakotwiczenia <tt><i>ssh</i></tt>:
<blockquote>
<tt>
# pfctl -a ssh:allowed -s rules
</tt>
</blockquote>

<p>
Aby wyczy¶ciæ wszystkie regu³y z tego samego zestawu:
<blockquote>
<tt>
# pfctl -a ssh:allowed -F rules
</tt>
</blockquote>

<p>
Gdy nazwa zestawu jest pominiêta, akcja odnosi siê do wszystkich
regu³ w zakotwiczeniu.

<p>
Pe³na lista komend znajduje siê na stronach man
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3"
><tt>pfctl(8)</tt></a>.

<p>
[<a href="logging.html">Wstecz: Logowanie</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="shortcuts.html">Dalej: Skracanie zestawów regu³</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: anchors.html,v 1.7 ]<br>
$Translation: anchors.html,v 1.3 2003/09/28 14:51:04 pl-team Exp $<br>
$OpenBSD: anchors.html,v 1.2 2003/09/28 22:28:56 horacio Exp $
</small>
</body>
</html> 
