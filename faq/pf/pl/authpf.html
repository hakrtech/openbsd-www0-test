<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Authpf: pow³oka dla bramek uwierzytelniaj±cych</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003-2004 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="ftp.html">Wstecz: Problemy z FTP</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="example1.html">Dalej: Firewall dla sieci domowej lub ma³ego biura</a>]

<h1><font color="#e00000">PF: Authpf: pow³oka dla bramek
uwierzytelniaj±cych</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wstêp</a>
<li><a href="#config">Konfiguracja</a>
	<ul>
	<li><a href="#linkmain">W³±czanie authpf do g³ównego zestawu regu³</a>
	<li><a href="#loadrules">Konfigurowanie ³adowanych regu³</a>
	<li><a href="#acl">Listy kontroli dostêpu</a>
	<li><a href="#shell">Ustawianie authpf jako pow³okê u¿ytkownika</a>
	</ul>
<li><a href="#wholog">Przegl±danie, kto jest zalogowany</a>
<li><a href="#moreinfo">Wiêcej informacji</a>
<li><a href="#example">Przyk³ad</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Wstêp</h2>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>Authpf(8)</a> jest pow³ok± u¿ytkownika s³u¿±c± do uwierzytelniania
w bramkach sieciowych. Bramka uwierzytelniaj±ca nie ró¿ni siê od zwyk³ej
bramki sieciowej (aka router) z tym wyj±tkiem, ¿e u¿ytkownicy musz±
potwierdziæ swoj± to¿samo¶æ na bramce, zanim ich ruch bêdzie móg³
zostaæ przepuszczony przez ni±. Gdy domy¶ln± pow³ok± u¿ytkownika jest
<tt>/usr/sbin/authpf</tt> (np zamiast normalnie stosowanych pow³ok:
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1&amp;manpath=OpenBSD+3.5"
>ksh(1)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=csh&amp;sektion=1&amp;manpath=OpenBSD+3.5"
>csh(1)</a>, itp), a u¿ytkownik zaloguje siê przez SSH, authpf zajmie siê
wykonaniem odpowiednich operacji, aby aktywowaæ zestaw regu³
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.5"
>pf(4)</a> i spowodowaæ, ¿e dzia³a obs³uga ruchu zwi±zanego z danym
u¿ytkownikiem jak np regu³y filtruj±ce i/lub translacje NAT czy
przekierowania. Gdy u¿ytkownik wylogowuje siê lub nastêpuje
zamkniêcie jego sesji, authpf usuwa wszystkie regu³y za³adowane dla
tego u¿ytkownika i zamyka wszystkie otwarte przez niego po³±czenia
stanowe. Dziêki temu, u¿ytkownik mo¿e przesy³aæ pakiety przez bramkê
jedynie w czasie, gdy utrzymuje otwart± sesjê SSH.

<p>
Authpf wp³ywa na zestaw regu³
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.5"
>pf(4)</a> poprzez dodawanie regu³ do
<a href="anchors.html#named">nazwanych zestawów regu³</a> dowi±zanych 
w <a href="anchors.html">punktach zakotwiczenia</a>. Za ka¿dym razem,
gdy u¿ytkownik pomy¶lnie potwierdza swoj± to¿samo¶æ,
authpf tworzy nowy nazwany zestaw regu³ i ³aduje do niego wcze¶niej
przygotowane regu³y 
<a href="filter.html">filtruj±ce</a>, <a href="nat.html"><tt>nat</tt></a>,
<a href="nat.html#binat"><tt>binat</tt></a> i 
<a href="rdr.html"><tt>rdr</tt></a>. Regu³y, które ³aduje authpf
mog± byæ przygotowane globalnie lub dla poszczególnych u¿ytkowników.

<p>
Przyk³adowe zastosowania authpf to:
<ul>
<li>Wymaganie od u¿ytkowników potwierdzenia swojej to¿samo¶ci przed
uzyskaniem dostêpu do Internetu.
<li>Nadawanie pewnym u¿ytkownikom -- na przyk³ad administratorom --
dostêpu do chronionych czê¶ci sieci.
<li>Zezwalanie na dostêp do reszty sieci lub Internetu jedynie
zidentyfikowanym u¿ytkownikom z segmentu sieci bezprzewodowej. 
<li>Zezwalanie na dostêp do zasobów sieci firmy dla pracowników w domach,
podró¿uj±cych itd. U¿ytkownicy z zewn±trz nie tylko mog± mieæ dostêp
do sieci firmy, ale mog± byæ tak¿e ograniczeni do pewnych zasobów
(np ich stacji roboczej) bazuj±c na nazwie u¿ytkownika, której
autentyczno¶æ potwierdzaj±.
<li>W miejscu takim jak biblioteka czy inne miejsce z publicznym
dostêpem do Internetu, PF mo¿e byæ skonfigurowany, aby umo¿liwiaæ
ograniczony dostêp dla u¿ytkowników-go¶ci. Authpf mo¿e byæ wykorzystanie
do zapewnienia zarejestrowanym u¿ytkownikom pe³nego dostêpu. 
</ul>

<p>
Authpf zapewnia logi z nazwami u¿ytkowników i ich adresami IP dla ka¿dego
u¿ytkownika, który pomy¶lnie przechodzi uwierzytelnianie, podobnie dzieje
siê z dok³adnym czasem rozpoczêcia i zakoñczenia sesji odnotowywanymi przez 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>syslogd(8)</a>. Wykorzystuj±c te informacje, administrator mo¿e okre¶liæ
kto i kiedy by³ zalogowany oraz czyni u¿ytkowników odpowiedzialnymi za
swój ruch sieciowy.

<a name="config"></a>
<h2>Konfiguracja</h2>
Podstawowe kroki, niezbêdne do konfiguracji authpf s± wymienione poni¿ej.
Bardziej szczegó³owe informacje o konfiguracji mo¿na znale¼æ na
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>stronie podrêcznika man authpf</a>.

<a name="linkmain"></a>
<h3>W³±czanie authpf do g³ównego zestawu regu³</h3>
Authpf jest w³±czane do (ang. linked into) g³ównego zestawu regu³
przy pomocy regu³ <tt>anchor</tt>:
<blockquote>
<tt>
nat-anchor authpf<br>
rdr-anchor authpf<br>
binat-anchor authpf<br>
anchor authpf<br>
</tt>
</blockquote>

<p>
Niezale¿nie od tego, gdzie w g³ównym zestawie regu³ znajdzie siê
regu³a <tt>anchor</tt>, PF rozga³êzi siê, aby przetworzyæ regu³y
authpf. Nie jest wymagana obecno¶æ wszystkich czterech regu³
<tt>anchor</tt>, na przyk³ad je¶li authpf nie jest skonfigurowane
do ³adowania regu³ <tt>nat</tt>, regu³a <tt>nat-anchor</tt> mo¿e
zostaæ pominiêta.

<a name="loadrules"></a>
<h3>Konfigurowanie ³adowanych regu³</h3>
Authpf ³aduje swoje regu³y z jednego z dwóch plików:
<ul>
<li><tt>/etc/authpf/users/$USER/authpf.rules</tt>
<li><tt>/etc/authpf/authpf.rules</tt>
</ul>

<p>
Pierwszy plik zawiera regu³y, które s± ³adowane jedynie gdy
<tt>$USER</tt> (które jest zastêpowane przez nazwê u¿ytkownika)
zaloguje siê. Konfiguracja regu³ wed³ug u¿ytkowników ma miejsce,
gdy konkretny u¿ytkownik -- jak np administrator -- wymaga
zestawu regu³ innego, ni¿ domy¶lnie ustawiony. Drugi plik
zawiera domy¶lne regu³y, które s± ³adowane, gdy dowolny u¿ytkownik
nie posiada swojego w³asnego pliku <tt>authpf.rules</tt>.
Je¶li plik ten dla konkretnego u¿ytkownika istnieje, zastêpuje
domy¶lny plik. Przynajmniej jeden z plików musi istnieæ, w
przeciwnym razie authpf nie bêdzie dzia³aæ.

<p>
Regu³y filtruj±ce i translacyjne maj± tak± sam± sk³adniê, jak
dowolny inny zestaw regu³ PF, z jednym wyj±tkiem: authpf daje
mo¿liwo¶æ korzystania z predefiniowanych makr:
<ul>
<li><tt>$user_ip</tt> - adres IP zalogowanego u¿ytkownika
<li><tt>$user_id</tt> - nazwa zalogowanego u¿ytkownika
</ul>

<p>
Jest zalecan± praktyk±, aby wykorzystywaæ makro <tt>$user_ip</tt>
jedynie do zezwalania na ruch pakietów z komputera u¿ytkownika,
który potwierdzi³ swoj± to¿samo¶æ.

<a name="acl"></a>
<h3>Listy kontroli dostêpu</h3>
Mo¿na uniemo¿liwiæ dostêp u¿ytkownika przez authpf poprzez utworzenie
pliku o nazwie u¿ytkownika, który ma byæ zablokowany, w katalogu
<tt>/etc/authpf/banned/</tt>. Zawarto¶æ pliku bêdzie wy¶wietlona
u¿ytkownikowi zanim authpf zerwie z nim po³±czenie. Dziêki temu,
mo¿na w porêczny sposób powiadomiæ u¿ytkownika dlaczego nie ma on
prawa do po³±czenia siê i z kim nale¿y siê skontaktowaæ, aby odzyskaæ
dostêp.

<p>
Mo¿na tak¿e umo¿liwiaæ dostêp odwrotnie, czyli jedynie poszczególnym
u¿ytkownikom poprzez umieszczanie nazw u¿ytkowników w pliku
<tt>/etc/authpf/authpf.allow</tt>. Je¶li plik ten nie istnieje, lub
zawiera tylko "<tt>*</tt>", wówczas authpf zezwoli na dostêp
wszystkim, których logowanie przez SSH zakoñczy³o siê sukcesem,
pod warunkiem, ¿e nie s± zbanowani.

<p>
Je¶li authpf nie jest w stanie okre¶liæ, czy u¿ytkownik ma prawo
dostêpu, czy nie, wówczas wy¶wietla krótk± wiadomo¶æ i roz³±cza
u¿ytkownika. Wpis w <tt>/etc/authpf/banned/</tt> zawsze
nadpisuje wpis w <tt>/etc/authpf/authpf.allow</tt>.

<a name="shell"></a>
<h3>Ustawianie authpf jako pow³okê u¿ytkownika</h3>
Aby authpf dzia³a³o, musi byæ ustawione jako pow³oka domy¶lna
u¿ytkownika. Gdy u¿ytkownik pomy¶lnie potwierdza swoj± to¿samo¶æ
wobec
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>sshd(8)</a>, authpf bêdzie uruchomione, jako pow³oka u¿ytkownika.
Nast±pi wówczas sprawdzenie, czy u¿ytkownik ma prawo dostêpu
do authpf, za³adowanie regu³ z odpowiedniego pliku itd.

<p>
Jest kilka sposobów na ustawienie authpf jako pow³okê u¿ytkownika:
<ol>
<li>Rêcznie dla ka¿dego u¿ytkownika, przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1&amp;manpath=OpenBSD+3.5"
>chsh(1)</a>, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>vipw(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>useradd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>usermod(8)</a>, itd.
<li>Poprzez ustawienie opcji 
<tt>shell</tt> w klasie zdefiniowanej w pliku
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5&amp;manpath=OpenBSD+3.5"
><tt>/etc/login.conf</tt></a>, do której nale¿y u¿ytkownik lub te¿
do której go przydzielimy.
</ol>

<a name="wholog"></a>
<h2>Przegl±danie, kto jest zalogowany</h2>
Kiedy ju¿ u¿ytkownik pomy¶lnie zaloguje siê, a PF dostroi regu³y PF,
authpf zmienia znacznik procesu (ang. process title), aby wskazywaæ na
nazwê zalogowanego u¿ytkownika i jego adres IP:
<pre>
    # ps -ax | grep authpf
    23664 p0  Is+     0:00.11 -authpf: charlie@192.168.1.3 (authpf)
</pre>

<p>
Tutaj u¿ytkownik <tt>charlie</tt> jest zalogowany z maszyny
192.168.1.3. Poprzez wys³anie sygna³u SIGTERM do procesu authpf,
u¿ytkownik mo¿e zostaæ roz³±czony si³±. Authpf usunie tak¿e
wszystkie za³adowane regu³y i po³±czenia stanowe
utworzone przez u¿ytkownika.
<pre>
    # kill -TERM 23664
</pre>

<a name="moreinfo"></a>
<h2>Wiêcej informacji</h2>
Pe³en opis dzia³ania authpf znajdziesz na stronie podrêcznika 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.5"
>man authpf</a>.

<a name="example"></a>
<h2>Przyk³ad</h2>
Authpf jest wykorzystywane w bramce sieciowej OpenBSD do uwierzytelniania
u¿ytkowników sieci bezprzewodowej, która jest czê¶ci± wiêkszej
struktury sieciowej. Gdy u¿ytkownik potwierdzi swoj± to¿samo¶æ,
zak³adaj±c, ¿e nie jest na li¶cie banów, bêdzie móg³ ³±czyæ siê
ze ¶wiatem zewnêtrznym przez SSH, przegl±daæ strony www (tak¿e
bezpieczne po³±czenia www), a dodatkowo bêdzie mia³ prawo
korzystaæ z dowolnego serwera DNS sieci w której siê znajduje.

<p>
Plik <tt>/etc/authpf/authpf.rules</tt> zawiera nastêpuj±ce regu³y:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

pass in quick on $wifi_if proto udp from $user_ip to $dns_servers \
   port domain keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
U¿ytkownik administruj±cy <tt>charlie</tt> musi mieæ dostêp do
serwerów SMTP i POP3 kampusu, a dodatkowo do serfowania po sieci
i korzystania z SSH. Nastêpuj±ce regu³y s± ustawione w
<tt>/etc/authpf/users/charlie/authpf.rules</tt>:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
smtp_server = "10.0.1.50"
pop3_server = "10.0.1.51"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

pass in quick on $wifi_if proto udp from $user_ip to $dns_servers \
   port domain keep state
pass in quick on $wifi_if proto tcp from $user_ip to $smtp_server \
   port smtp flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to $pop3_server \
   port pop3 flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
G³ówny zestaw regu³ -- umieszczony w <tt>/etc/pf.conf</tt> -- jest
skonfigurowany w nastêpuj±cy sposób:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# makra
wifi_if = "wi0"
ext_if  = "fxp0"

scrub in all

# regu³y filtruj±ce
block drop all

pass out quick on $ext_if proto tcp from $wifi_if:network flags S/SA \
   modulate state
pass out quick on $ext_if proto { udp, icmp } from $wifi_if:network \
   keep state

pass in quick on $wifi_if proto tcp from $wifi_if:network to $wifi_if \
   port ssh flags S/SA keep state

anchor authpf in on $wifi_if
</pre>
</td></tr>
</table>

<p>
Zestaw regu³ jest bardzo prosty, oto jak dzia³a:
<ul>
<li>Blokuje wszystko (domy¶lna polityka blokowania).
<li>Przepuszcza wychodz±cy ruch TCP, UDP i ICMP na zewnêtrznym
interfejsie pochodz±cy z sieci bezprzewodowej.
<li>Przepuszcza nadchodz±cy ruch SSH z sieci bezprzewodowej skierowany
do samej bramki. Regu³a ta jest niezbêdna, aby umo¿liwiæ u¿ytkownikom
logowanie siê.
<li>Tworzy punk zakotwiczenia (ang. anchor point) "authpf" dla
nadchodz±cego ruchu na interfejsie sieci bezprzewodowej.
</ul>

<p>
My¶l± przewodni± g³ównego zestawu regu³ jest: blokowanie wszystkiego
i przepuszczanie minimalnej ilo¶ci jasno sprecyzowanego ruchu.
Ruch mo¿e wychodziæ na zewnêtrznym interfejsie, ale jest blokowany,
gdy nadchodzi na interfejsie sieci bezprzewodowej dziêki polityce
domy¶lnego blokowania. Gdy u¿ytkownik potwierdzi swoj± to¿samo¶æ,
jego ruch jest przepuszczany na interfejsie sieci bezprzewodowej
i mo¿e dotrzeæ przez bramkê do pozosta³ych
 czê¶ci sieci.
S³owo kluczowe <tt>quick</tt> jest zastosowane, aby PF nie musia³
przetwarzaæ za ka¿dym razem wszystkich nazwanych zestawów regu³,
gdy nowe po³±czenie przechodzi przez bramkê.

<p>
[<a href="ftp.html">Wstecz: Problemy z FTP</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="example1.html">Dalej: Firewall dla sieci domowej lub ma³ego
biura</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: authpf.html,v 1.6 ]<br>
$Translation: authpf.html,v 1.7 2004/06/05 10:34:17 pl-team Exp $<br>
$OpenBSD: authpf.html,v 1.7 2004/06/07 06:59:45 jufi Exp $
</small>

</body>
</html> 
