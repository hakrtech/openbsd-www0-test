<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Problemy z FTP</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003, 2004, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="perf.html">Wstecz: Wydajno¶æ</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="authpf.html">Dalej: Authpf: pow³oka dla bramek
uwierzytelniaj±cych</a>]

<p>
<h1><font color="#e00000">PF: Problemy z FTP</font></h1>
<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#modes">Tryby pracy FTP</a>
<li><a href="#client">Klient FTP za firewallem</a>
<li><a href="#server">"Samozabezpieczenie" PF serwera FTP</a>
<li><a href="#natserver">Zabezpieczanie serwera FTP poprzez dedykowany
firewall z NAT</a>
<li><a href="#info">Wiêcej informacji o FTP</a>
</ul>

<hr>

<a name="modes"></a>
<h2>Tryby pracy FTP</h2>
Powstanie protoko³u FTP mia³o miejsce gdy Internet by³ jeszcze ma³±,
przyjazn± sieci± i ka¿dy wiedzia³ wszystko o wszystkich, a wiêc wtedy
gdy filtrowanie pakietów i nadzwyczajne ¶rodki ostro¿no¶ci nie by³y
jeszcze potrzebne. Protokó³ ten nie jest wiêc zaprojektowany tak aby
umo¿liwiæ jego ³atwe filtrowanie lub przekazywanie jego datagramów
poprzez ¶ciany ogniowe, a tak¿e do wspó³pracy z translacj± adresów.

<p>
Z FTP mo¿na korzystaæ na dwa sposoby: pasywnie lub aktywnie. Wybór
trybu aktywnego lub pasywnego zale¿y w g³ównej mierze od okre¶lenia
kto ma problemy z filtrowaniem pakietów. Najlepszym rozwi±zaniem
by³oby umo¿liwiæ korzystanie z obu metod.

<p>
Kiedy u¿ytkownik ³±czy siê z serwerem przy pomocy aktywnego FTP i
wysy³a ¿±danie otrzymania informacji lub pliku, serwer FTP tworzy
nowe po³±czenie z powrotem do klienta i przesy³a dane. nazywa siê to
<i>po³±czeniem przesy³ania danych</i> (ang. <i>data connection</i>).
Aby zacz±æ, klient FTP wybiera losowy port, przesy³a jego numer
do serwera FTP i wtedy zaczyna nas³uchiwaæ na tym porcie wybra³.
Serwer FTP inicjuje wówczas po³±czenie na adres i otrzymany port
klienta, po czym rozpoczyna transmisjê danych. Stanowi to problem
dla u¿ytkowników staraj±cych siê uzyskaæ dostêp do serwerów FTP
z za bramek realizuj±cych NAT. Poniewa¿ NAT dzia³a, jak dzia³a,
serwer FTP inicjuje po³±czenie przesy³ania danych poprzez ³±czenie
siê na zewnêtrzny adres bramki oraz wybrany port. Maszyna realizuj±ca
NAT otrzyma po³±czenie, lecz poniewa¿ nie wie, jak zmapowaæ pakiet
w swojej tabeli stanów, porzuci pakiet i nie dostarczy go do klienta.

<p>
W trybie pasywnym (jest to domy¶lne zachowanie programu <a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.6"
>ftp(1)</a>), dostarczonego wraz z OpenBSD), klient ¿±da aby to
serwer okre¶li³ losowy port na którym bêdzie oczekiwa³ na po³±czenie
dla przes³ania danych. Serwer informuje klienta, który port zosta³
wybrany, a klient ³±czy siê z tym portem i nastêpuje transfer danych.
Niestety, z powodu mo¿liwo¶ci istnienia zapory ogniowej przed
serwerem FTP, która bêdzie blokowaæ nadchodz±ce po³±czenia przesy³ania
danych. W OpenBSD ftp(1) u¿ywa tego trybu domy¶lnie, wymuszenie trybu
aktywnego mo¿na uzyskaæ na dwa sposoby: opcja -A podczas wywo³ania ftp,
lub wy³±czenie trybu pasywnego komend± "<tt>passive off</tt>" w linii
poleceñ programu "<tt>ftp&gt;</tt>".

<a name="client"></a>
<h2>Klient FTP za firewallem</h2>
Jak to zosta³o opisane wcze¶niej, protokó³ FTP ma problemy z wspó³prac±
z NAT i firewallami.

<p>
Packet Filter dostarcza rozwi±zanie tego problemu, którym jest przekierowanie
ruchu FTP na serwer proxy FTP. proces ten "przeprowadzi" po³±czenia FTP
poprzez bramkê/firewall z NAT. Serwerem proxy FTP wykorzystywanym przez
OpenBSD i PF
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>ftp-proxy(8)</a>. Aby go aktywowaæ, w umie¶æ co¶ takiego w sekcji translacji
pliku <tt>pf.conf</tt>:

<blockquote>
<tt>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \<br>
&nbsp;&nbsp;&nbsp;port 8021
</tt>
</blockquote>

<p>
Dzia³anie tej linii mo¿na stre¶ciæ nastêpuj±co: "Ruch na wewnêtrznym
interfejsie sieciowym jest przekierowany do serwera po¶rednicz±cego,
uruchomionego na tej maszynie i nas³uchuj±cego na porcie 8021".

<p>
Oczywi¶cie powy¿sze przekierowanie zak³ada, ¿e serwer proxy jest
uruchomiony na tym komputerze. Nale¿y sprawdziæ, czy w pliku
<tt>/etc/inetd.conf</tt>, jest nastêpuj±ca linia:

<blockquote>
<tt>
127.0.0.1:8021 stream tcp nowait root /usr/libexec/ftp-proxy \<br>
&nbsp;&nbsp;&nbsp;ftp-proxy -n
</tt>
</blockquote>

<p>
Flaga <tt>-n</tt> jest niezbêdna tylko gdy maszyna OpenBSD
realizuje NAT. Nastêpnie wy¶lij sygna³ 'HUP' do demona
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>inetd(8)</a> aby zmusiæ go do ponownego odczytania swojego pliku
konfiguracyjnego. Sygna³ ten mo¿na wys³aæ do demona inetd w
nastêpuj±cy sposób:

<blockquote>
<tt>
kill -HUP `cat /var/run/inetd.pid`
</tt>
</blockquote>

<p>
Mo¿na zauwa¿yæ, ¿e ftp-proxy nas³uchuje na porcie 8021, dok³adnie
tym samym, na który podana dyrektywa <tt>rdr</tt> przekierowuje
ruch FTP. Wybór numeru portu jest zupe³nie dowolny, jednak port
8021 jest dobrym wyborem, jako ¿e nie jest on u¿ywany przez
¿adn± inn± aplikacjê.

<p>
W tym momencie nadal jeszcze bêd± funkcjonowa³y jedynie pasywne
po³±czenia FTP.
Aby umo¿liwiæ po³±czenia w trybie "aktywnym", po³±czenie zwrotne
inicjowane z powrotem do klienta przez serwer FTP musi przej¶æ przez
firewall.
Niestety, znamy jedynie zakres mo¿liwych portów port na który nadejdzie
to po³±czenie.
Wiadomo natomiast, ¿e po³±czenie to bêdzie nadchodzi³o z portu
20 (ftp-data port) oraz ze ftp-proxy przejmie je i bêdzie
po¶redniczyæ w komunikacji z w³a¶ciwym klientem.
Poniewa¿ ftp-proxy uruchamiane jest z prawami u¿ytkownika
<tt>proxy</tt>, s³owo kluczowe <tt>user</tt> mo¿e byæ
wykorzystywane w regule filtrowania.

<blockquote>
<tt>
pass in on $ext_if inet proto tcp from port 20 to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;&nbsp;user proxy flags S/SA keep state
</tt>
</blockquote>

<p>
Proszê zauwa¿yæ, ¿e ftp-proxy(8) jest pomoc± dla <b>klientów FTP</b>
znajduj±cych siê za ¶cian± ogniow±, nie s³u¿y natomiast do uruchomienia
<b>serwera FTP</b> za firewallem.

<a name="server"></a>
<h2>"Samozabezpieczenie" PF serwera FTP</h2>
W tym przypadku, filtr PF jest uruchomiony na tym samym komputerze co serwer
FTP, a nie na osobnej maszynie. Kiedy serwer obs³uguje pasywne sesje FTP,
otwiera wysoki port TCP dla danych. Domy¶lnie, natywny serwer OpenBSD
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>ftpd(8)</a> u¿ywa w tym celu portów z zakresu od 49152 do 65535.
Oczywi¶cie ruch na tych portach musi byæ przepuszczany wraz z portem
21 (który jest portem kontrolnym FTP):

<blockquote>
<tt>
pass in on $ext_if proto tcp from any to any port 21 keep state<br>
pass in on $ext_if proto tcp from any to any port &gt; 49151 \<br>
&nbsp;&nbsp;&nbsp;keep state
</tt>
</blockquote>

<p>
Proszê zauwa¿yæ, ¿e je¶li zaistnieje potrzeba ograniczenia
zakresu wysokich portów, których bêdzie u¿ywa³ natywny serwer
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>ftpd(8)</a> OpenBSD, mo¿na to osi±gn±æ poprzez zmianê
warto¶ci zmiennych
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>sysctl(8)</a> <tt>net.inet.ip.porthifirst</tt> i
<tt>net.inet.ip.porthilast</tt>.

<a name="natserver"></a>
<h2>Zabezpieczanie serwera FTP poprzez dedykowany firewall z NAT</h2>
Ta sytuacja zmusza, ¶cianê ogniow± do przekierowania ruchu FTP do serwera FTP,
dodatkowo nie blokuj±c wymaganych, nowo otwartych portów. W tym przyk³adzie
za³o¿ono, ¿e serwerem FTP bêdzie znów natywne rozwi±zanie OpenBSD czyli
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>ftpd(8)</a>, korzystaj±cy z domy¶lnego zakresu portów.

<p>
Oto przyk³ad regu³ dziêki którym powy¿szy cel mo¿e zostaæ osi±gniêty:
<blockquote>
<tt>
ftp_server = "10.0.3.21"<br>
<br>
rdr on $ext_if proto tcp from any to any port 21 -&gt; $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21<br>
rdr on $ext_if proto tcp from any to any port 49152:65535 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$ftp_server port 49152:65535<br>
# in on $ext_if<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21 keep state<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port &gt; 49151 keep state<br>
<br>
# out on $int_if<br>
pass out quick on $int_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21 keep state<br>
pass out quick on $int_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port &gt; 49151 keep state
</tt>
</blockquote>


<a name="info"></a>
<h2>Wiêcej informacji o FTP</h2>
Wiêcej informacji o filtrowaniu protoko³u FTP oraz o tym, jak
ogólnie dzia³a FTP znajdziesz w tym opracowaniu:
<ul>
<li><a href="http://www.pintday.org/whitepapers/ftp-review.shtml">FTP
Reviewed</a>
</ul>

<p>
[<a href="perf.html">Wstecz: Wydajno¶æ</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="authpf.html">Dalej: Authpf: pow³oka dla bramek
uwierzytelniaj±cych</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: ftp.html,v 1.17 ]<br>
$Translation: ftp.html,v 1.11 2005/02/18 23:08:45 pl-team Exp $<br>
$OpenBSD: ftp.html,v 1.11 2005/02/19 10:16:13 jufi Exp $
</small>
</body>
</html> 
