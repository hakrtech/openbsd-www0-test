<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Logowanie</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2005 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>

<p>
[<a href="tagging.html">Wstecz: Packet Tagging</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="perf.html">Dalej: Wydajno¶æ</a>]

<p>
<h1><font color="#e00000">PF: Logowanie</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wstêp</a>
<li><a href="#logfile">Odczytywanie pliku logów</a>
<li><a href="#filter">Selektywne przegl±danie logów</a>
<li><a href="#syslog">Logowanie pakietów poprzez syslog</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Wstêp</h2>
Tworzenie logów w PF odbywa siê za po¶rednictwem
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>pflogd(8)</a>, który nas³uchuje na urz±dzeniu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4&amp;manpath=OpenBSD+3.7"
>pflog0</a> i zapisuje pakiety do pliku logów (domy¶lnie
/var/log/pflog) w formacie binarnym 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>tcpdump(8)</a>. <a href="filter.html">Regu³y filtruj±ce</a>, które
zawieraj± s³owa kluczowego <tt>log</tt> lub <tt>log-all</tt> podlegaj±
logowaniu.

<a name="logfile"></a>
<h2>Odczytywanie pliku logów</h2>
Plik logów, tworzony przez pflogd jest plikiem o formacie binarnym i
nie mo¿e byæ odczytywany przy pomocy edytora tekstu.
Nale¿y u¿yæ tcpdump do jego odczytu.

<p>
Aby wy¶wietliæ zawarto¶æ pliku logów:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Oczywi¶cie przegl±danie plkiu <tt>pflog</tt> przy pomocy tcpdump(8),
<i>nie</i> daje wyników w czasie rzeczywistym. Wy¶wietlanie
logowanych pakietów na bierz±co mo¿e byæ osi±gniête przy pomocy
interfejsu <tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">UWAGA: </font>
Podczas analizowania logów, uwagê nale¿y zwracaæ na szczegó³owe
dekodowanie protoko³ów przez tcpdump (tryb "dok³adny" aktywowany
opcj± <tt>-v</tt>). Dekoder zawarty w programie tcpdump nie ma zbyt
chwalebnej przesz³o¶ci je¶li chodzi o bezpieczeñstwo. Przynajmniej
teoretycznie mo¿liwe jest przeprowadzenie opó¼nionego ataku poprzez
wysy³anie pakietów maj±cych zostaæ zalogowanymi. Jest zalecan± praktyk±,
aby przed rozpoczêciem przegl±dania plików logów w ten sposób,
przenie¶æ je z firewalla na inn± maszynê. 

<p>
Szczególna ostro¿no¶æ powinna byæ zachowana w stosunku do zabezpieczenia
dostêpu do plików logów. Domy¶lnie, pflogd bêdzie zapisywaæ 96 bajtów
pakietu w pliku logów.
Dostêp do logów mo¿e skutkowaæ uzyskaniem dostêpu do wra¿liwych
danych transportowanych w pakietach (jak na przyk³ad nazwy
u¿ytkowników i has³a us³ug
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1&amp;manpath=OpenBSD+3.7"
>telnet(1)</a> lub
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.7"
>ftp(1)</a>).

<a name="filter"></a>
<h2>Selektywne przegl±danie logów</h2>
Poniewa¿ logi pflogd(8) s± zapisywane w binarnym formacie tcpdump(8),
wszystkie dostêpne w³a¶ciwo¶ci tego programu mog± byæ wykorzystywane
podczas ich przegl±dania. Na przyk³ad, aby wy¶wietliæ pakiety,
które odpowiadaj± portowi 80, mo¿na u¿yæ takiego polecenia:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Aby uzyskaæ jeszcze bardziej prezycjn± informacjê, mo¿na ograniczyæ wy¶wietlane
dane do konkretnych kombinacji port-host:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
Ta sama technika mo¿e byæ zastosowana podczas odczytu bezpo¶rednio
z interfejsu <tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Warto podkre¶liæ, ¿e nie ma to wp³ywu na to, które pakiety s± zapisywane w
pliku logów pflogd, a jedynie na to, co jest wy¶wietlane przez t± komendê.

<p>
Standardowe regu³y filtruj±ce 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>tcpdump(8)</a> zosta³y rozszerzone w wersji tego programu dla OpenBSD o
dodatkowe mo¿liwo¶ci filtrowaia logów pflogd:
<ul>
<li><tt>ip</tt> - ustala rodzinê adresów na IPv4.
<li><tt>ip6</tt> - ustala rodzinê adresów na IPv6.
<li><tt>on <i>int</i></tt> - pakiet, który przeszed³ przez interfejs
<i>int</i>.
<li><tt>ifname <i>int</i></tt> - to samo, co <tt>on <i>int</i></tt>.
<li><tt>rulenum <i>num</i></tt> - regu³a, do której zosta³ dopasowany
pakiet mia³a numer <i>num</i>.
<li><tt>action <i>act</i></tt> - akcja podjêta wobec pakietu.
Mo¿liwymi akcjami s± <tt>pass</tt> i <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - powód, dla którego akcja <tt>action</tt>
zosta³a podjêta. Mo¿liwymi powodami s± <tt>match</tt>, <tt>bad-offset</tt>,
<tt>fragment</tt>, <tt>short</tt>, <tt>normalize</tt>,
<tt>memory</tt>, <tt>bad-timestamp</tt>,
<tt>congestion</tt>, <tt>ip-option</tt>, <tt>proto-cksum</tt>,
<tt>state-mismatch</tt>, <tt>state-insert</tt>, <tt>state-limit</tt>,
<tt>src-limit</tt> oraz <tt>synproxy</tt>.
<li><tt>inbound</tt> - pakiety nadchodz±ce.
<li><tt>outbound</tt> - pakiety wychodz±ce.
</ul>

<p>
Przyk³ad:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Wy¶wietla logi w czasie rzeczywistym, dla nadchodz±cych pakietów, które
zosta³y zablokowane na interfejsie wi0.

<a name="syslog"></a>
<h2>Logowanie pakietów poprzez syslog</h2>
W niektórych sytuacjach jest po¿±dane, aby logi firewalla by³y
dostêpne w formacie ASCII i/lub wysy³ane do zdalnego serwera
gromadz±cego logi. Mo¿e to byæ zrealizowane poprzez dwa ma³e
skrypty pow³oki, wprowadzenie drobnych zmian w plikach
konfiguracyjnych OpenBSD oraz
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>syslogd(8)</a> - demonie loguj±cym. Syslogd prowadzi logi w formacie
ASCII i jest w stanie przechowywaæ logi na zdalnym serwerze logów.

<p>
Prace rozpoczyna siê od utworzenia u¿ytkownika <tt>pflogger</tt>,
jego shell to <tt>/sbin/nologin</tt>. Najpro¶ciej zrobiæ to przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>adduser(8)</a>.

<p>
Po dodaniu u¿ytkownika <tt>pflogger</tt>, nale¿y przekopiowaæ dwa
proste skrypty:

<p>
<tt>/etc/pflogrotate</tt>
<pre>
	FILE=/home/pflogger/pflog5min.$(date "+%Y%m%d%H%M")
	kill -ALRM $(cat /var/run/pflogd.pid)
	if [ $(ls -l /var/log/pflog | cut -d " " -f 8) -gt 24 ]; then
	   mv /var/log/pflog $FILE
	   chown pflogger $FILE
	   kill -HUP $(cat /var/run/pflogd.pid)
	fi
</pre>

<p>
<tt>/home/pflogger/pfl2sysl</tt>
<pre>
	for logfile in /home/pflogger/pflog5min* ; do
	    if [ -s "$logfile" ]; then
	    tcpdump -n -e -ttt -r $logfile | logger -t pf -p local0.info
	    rm $logfile
	    fi
	done
</pre>

<p>

Przej¶æ do edycji zadañ demona cron dla u¿ytkownika root:
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Dodaæ dwie nastêpuj±ce linie:
<blockquote>
<tt>
# rotate pf log file every 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Utworzyæ zadania demona cron dla u¿ytkownika <tt>pflogger</tt>:
<blockquote>
<tt>
# crontab -u pflogger -e
</tt>
</blockquote>

<p>
Dodaæ dwie poni¿sze linie:
<blockquote>
<tt>
# feed rotated pflog file(s) to syslog<br>
0-59/5 *       *       *       *       /bin/sh /home/pflogger/pfl2sysl
</tt>
</blockquote>

<p>
Dodaæ nastêpuj±c± linie do <tt>/etc/syslog.conf</tt>:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Dodatkowo, aby prowadziæ logi na zdalnym serwerze przeznaczonym do tego celu,
nale¿y dodaæ nastêpuj±c± linie:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Dodatkow upewniæ siê, ¿e host <i>syslogger</i> jest zdefiniowany w pliku
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5&amp;manpath=OpenBSD+3.7"
>hosts(5)</a>.

<p>
Utwórz plik <tt>/var/log/pflog.txt</tt>, aby umo¿liwiæ syslog
dopisywanie do niego logów.
<blockquote>
<tt>
# touch /var/log/pflog.txt
</tt>
</blockquote>

<p>
Zmiany stan± siê aktywne po prze³adowaniu demona syslogd:
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Wszystkie logowane pakiety s± teraz wysy³ane do <tt>/var/log/pflog.txt</tt>.
Je¶li druga linia zosta³a tak¿e dodana, s± one tak¿e wysy³ane do zdalnego
hosta loguj±cego <i>syslogger</i>.

<p>
Skrypt <tt>/etc/pflogrotate</tt> ju¿ dzia³a i zastêpuje
<tt>/var/log/pflog</tt> wiêc rotacja <tt>pflog</tt> dokonywana przez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>newsyslog(8)</a> nie jest ju¿ potrzebna i powinna byæ wy³±czona.
Poniewa¿ <tt>/var/log/pflog.txt</tt> przejmujê zadania
<tt>/var/log/pflog</tt>, jego rotacja powinna byæ aktywowana.
Tak wiêc nale¿y zmieniæ <tt>/etc/newsyslog.conf</tt> w nastêpuj±cy sposób:
<pre>
    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
PF bêdzie teraz zapisywa³ logi w formacie ASCII do pliku
<tt>/var/log/pflog.txt</tt>. Odpowiednio ustawiony plik 
<tt>/etc/syslog.conf</tt> sprawi, ¿e dziennik prowadzony bêdzie tak¿e na
zdalnym serwerze logów. Logowanie nie bêdzie natychmiastowe i mo¿e up³yn±æ
oko³o 5-6 minut (przerwa pomiêdzy zadaniami cron), zanim logowane
pakiety pojawi± siê pliku.

<p>
[<a href="tagging.html">Wstecz: Packet Tagging</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="perf.html">Dalej: Wydajno¶æ</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: logging.html,v 1.21 ]<br>
$Translation: logging.html,v 1.11 2005/08/24 11:42:36 pl-team Exp $<br>
-->
$OpenBSD: logging.html,v 1.11 2005/08/24 12:58:45 saad Exp $
</small>
</body>
</html> 
