<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Przyk³ad 1: Firewall dla sieci domowej lub ma³ego biura </title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003-2004 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="authpf.html">Wstecz: Authpf: pow³oka dla bramek uwierzytelniaj±cych</a>]
[<a href="index.html">Spis tre¶ci</a>]

<p>
<h1><font color="#e00000">PF: Przyk³ad 1: Firewall dla sieci domowej lub
ma³ego biura</font></h1>
<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#scenario">Wstêp</a>
	<ul>
	<li><a href="#network">Sieæ</a>
	<li><a href="#objective">Za³o¿enia</a>
	<li><a href="#prep">Wymagania</a>
	</ul>
<li><a href="#ruleset">Budowanie zestawu regu³</a>
	<ul>
	<li><a href="#macros">Makra</a>
	<li><a href="#options">Opcje</a>
	<li><a href="#scrub">Normalizacja pakietów</a>
	<li><a href="#nat">Translacja adresów</a>
	<li><a href="#rdr">Przekierowania</a>
	<li><a href="#filter">Regu³ki filtra pakietów</a>
	</ul>
<li><a href="#allrules">Kompletny zestaw regu³</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>Wstêp</h2>
W tym FAQ zostanie omówiony przyk³ad wykorzystania maszyny z OpenBSD i
dzia³aj±cym PF do zbudowania firewalla i bramki NAT dla niewielkiej sieci w
domu lub biurze. G³ównym celem jest udostêpnienie po³±czenia z Internetem
komputerom w sieci wewnêtrznej, a tak¿e umo¿liwienie ograniczonego dostêpu z
Internetu do maszyny spe³niaj±cej rolê ¶ciany ogniowej. Kompletny przyk³ad
bêdzie mo¿na znale¼æ na koñcu tego dokumentu.

<a name="network"></a>
<h3>Sieæ</h3>
Topologia sieci wygl±da nastêpuj±co:

<pre>
    
  [ KOMP1 ]    [ KOMP3 ]
      |            |                               ADSL
   ---+------+-----+------- fxp0 [ OpenBSD ] ep0 -------- ( Internet )
             |
         [ KOMP2 ]

</pre>

<p>
Do sieci wewnêtrznej przy³±czonych jest kilka maszyn, co prawda na schemacie
zaznaczone s± trzy, ale w tym przypadku ich ilo¶æ nie ma ¿adnego znaczenia.
Komputery te wykorzystywane s± do codziennych zadañ takich jak: przegl±danie
stron www, wysy³anie poczty elektronicznej, rozmów, itd. Przestrzeñ adresowa
sieci wewnêtrznej zawiera siê w bloku 192.168.0.0 / 255.255.255.0.

<p>
Router zbudowany na bazie OpenBSD to komputer z procesorem Pentium 100
i dwiema kartami sieciowymi: 3Com 3c509B (<tt>ep0</tt>) i Intel
EtherExpress Pro/100 (<tt>fxp0</tt>). Po³±czony jest on z Internetem
³±czem ADSL, a do udostêpniania po³±czenia innym komputerom
wykorzystywany jest NAT. Adres IP dla zewnêtrzenego interfejsu uzyskiwany
jest dynamicznie od Dostawcy Us³ug Internetowych.

<a name="objective"></a>
<h3>Za³o¿enia</h3>
Za³o¿enia, którymi nale¿y kierowaæ siê przy budowie regu³ek filtrowania:
<ul>
<li>Umo¿liwienie niczym nieograniczonego dostêpu do Internetu komputerom z sieci
wewnêtrznej.
<li>Zastosowanie regu³ek filtra zapewniaj±cych "domy¶lne blokowanie" ruchu
przychodz±cego.
<li>Przepuszczanie ruchu z Internetu skierowanego do nastêpuj±cych portów:
	<ul>
	<li>SSH (TCP port 22): u¿ywany do zdalnej administracji ¶ciany ogniowej.
	<li>Auth/Ident (TCP port 113): u¿ywany przez niektóre us³ugi, takie jak
	SMTP czy IRC.
	<li>ICMP Echo Requests: ten typ pakietów ICMP jest u¿ywany przez program
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>ping(8)</a>.
	</ul>
<li>Logowanie statystyk filtra pakietów dla zewnetrznego interfejsu sieciowego.
<li>Wysy³anie domy¶lnej odpowiedzi TCP RST lub ICMP Unreachable na zablokowane
pakiety.
<li>Stworzenie zestawu regu³, który bêdzie prosty i zrozumia³y.
</ul>

<a name="prep"></a>
<h3>Wymagania</h3>
Podczas pisania tego FAQ przyjêto, ¿e OpenBSD zosta³ poprawnie skonfigurowany
do przysz³ej pracy jako router, w³±czaj±c w to w³a¶ciwe przygotowanie sieci,
po³±czenia z Internetem, oraz ustawienia zmiennej sysctl
<tt>net.inet.ip.forwarding</tt> na "<tt>1</tt>".

<a name="ruleset"></a>
<h2>Budowanie zestawu regu³</h2>
Wykonanie poleceñ zawartych w nastêpuj±cych podrozdzia³ach zaowocuje otrzymaniem
kompletnego zestawu regu³ spe³niaj±cego wszystkie warunki podane powy¿ej.

<a name="macros"></a>
<h3>Makra</h3>
Poni¿sze makra maj± na celu u³atwienie zrozumienia oraz usprawnienie zarz±dzania
zestawem regu³:
<blockquote>
<tt>
int_if = "fxp0"<br>
ext_if = "ep0"<br>
<br>
tcp_services = "{ 22, 113 }"<br>
icmp_types = "echoreq"<br>
<br>
priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
</tt>
</blockquote>

<p>
Pierwsze dwie linie okre¶laj± na jakich interfejsach bêdzie odbywaæ siê
filtrowanie. Trzecia linia zawiera liste portów TCP (SSH i ident/auth), do
których ruch z Internetu ma byæ przepuszczany. W czwartej linii okre¶lone s±
typy komunikatów ICMP, które nie bêd± blokowane. W ostatniej linii
wyszczególnione s± adresy pêlti zwrotnej oraz zarezerwowane bloki sieci opisane
w <a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>.

<p>
<b>Uwaga</b>: Je¶li po³±czenie ADSL odbywa siê poprzez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>PPPoE</a>, wtedy filtrowanie oraz translacja pakietów odbywaæ siê bêdzie na
interfejsie <tt>tun0</tt> a <i>nie</i> na <tt>ep0</tt>.

<a name="options"></a>
<h3>Opcje</h3>
Dwie poni¿sze opcje w³±czaj± domy¶lne odpowiedzi na zablokowane pakiety dla
regu³y <tt>block</tt>, a tak¿e zbieranie ró¿nego rodzaju statystyk dla
zewnêtrznego interfejsu sieciowego.
<blockquote>
<tt>
set block-policy return<br>
set loginterface $ext_if
</tt>
</blockquote>

<a name="scrub"></a>
<h3>Normalizacja pakietów</h3>
Nie istnieje ¿aden wa¿ny powód dla którego nadchodz±ce pakiety nie mia³y by
zostaæ poddane normalizacji. W³±czenie normalizowania pakietów odbywa siê przez
dodanie jednej, prostej linii:
<blockquote>
<tt>
scrub in all
</tt>
</blockquote>

<a name="nat"></a>
<h3>Translacja adresów</h3>
W³±czenie translacji adresów (NAT) dla hostów w sieci wewnêtrznej uzyskuje siê
przez dodanie regu³ki <tt>nat</tt>:
<blockquote>
<tt>
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
Jako ¿e adres IP dla zewnêtrznego interfejsu sieciowego jest uzyskiwany
dynamicznie, nazwa interfejsu na którym odbywa siê mapowanie adresów zosta³a
wziêty w nawiasy, dziêki temu PF zostanie powiadomione o ka¿dej zmianie adresu.

<a name="rdr"></a>
<h3>Przekierowanie</h3>
Jedyne przekierowanie konieczne w tym zestawie regu³ jest dla
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>ftp-proxy(8)</a>, aby klient FTP w sieci lokalnej móg³ bez problemów po³±czyæ
siê z serwerami FTP w Internecie.
<blockquote>
<tt>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Proszê zauwa¿yæ, ¿e regu³ka ta obs³uguje jedynie po³±czenia FTP na porcie 21.
Je¶li zajdzie potrzeba umo¿liwienia korzystania z innych numerów portów,
konieczne bêdzie podanie ich w postaci listy, na przyk³ad:
<tt>from any to any port { 21, 2121}</tt>

<a name="filter"></a>
<h3>Regu³ki filtra pakietów</h3>
Po ustawieniu NAT i przekierowañ mo¿na przyst±piæ do konfiguracji filtra
pakietów. Filtr bêdzie pracowa³ zgodnie z zasad± "domy¶lnego blokowania":
<blockquote>
<tt>
block all<br>
</tt>
</blockquote>

<p>
W tym miescu ¿aden ruch nie jest przepuszczany przez scianê ogniow±, nawet ten
pochodz±cy z sieci wewnêtrznej. Kolejne regu³ki bêd± umo¿liwia³y przej¶cie
datagramów zgodnie z wytycznymi podanymi wcze¶niej.

<p>
Ka¿dy system UNIX posiada intefejs pêtli zwrotnej nazywany "loopback". Jest to
wirtualny interfejs sieciowy u¿ywany przez procesy do komunikacji z innymi
aplikacjami uruchomionymi w lokalnym systemie. Ca³y ruch na tym interfejsie
powinnien byæ przepuszczany bez ¿adnych ograniczeñ. W OpenBSD interfejs
"loopback" nazywa siê:
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.4"
>lo(4)</a>.
<blockquote>
<tt>
pass quick on lo0 all
</tt>
</blockquote>

<p>
Pakiety posiadaj±ce jako adres docelowy lub ¼ród³owy, jeden z adresów opisanych
w <a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>, przechodz±ce
w dowolnym kierunku przez interfejs zewnêtrzny zostan± zablokowane - te adresy
nigdy nie powinny pojawiæ siê w Internecie. Wprowadzenie tych regu³ek daje
gwarancje, ¿e ¿aden z zarezerwowanych adresów nie przedostanie siê do
Internetu, a tak¿e zapobiega przyjmowaniu pakietów ze ¶wiata posiadaj±cych jako
adres ¼ród³owy jeden z adresów z RFC 1918.

<blockquote>
<tt>
block drop in &nbsp;quick on $ext_if from $priv_nets to any<br>
block drop out quick on $ext_if from any to $priv_nets
</tt>
</blockquote>

<p>
Nale¿y zwróciæ uwagê, ¿e <tt>block drop</tt> okre¶la, ¿e filtr PF nie ma
wysy³aæ TCP RST lub ICMP Unreachable w odpowiedzi na zablokowane pakiety.
Adresy z RFC 1918 nie istniej± w Internecie, ¿aden pakiet wys³any pod ten
adres nie dotrze do miejsca przeznaczenia. Opcja <tt>quick</tt> mówi, ¿e PF ma
przerwaæ sprawdzanie dalszej czê¶ci zestawu je¶li pakiet pasowa³ do tej
regu³ki. Pakiety pochodz±ce lub skierowane do sieci <tt>$priv_nets</tt> bêd±
natychmiast odrzucone.

<p>
Nastêpna regu³ka otwiera porty dla us³ug, które maj± byæ udostêpnione w
Internecie:
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>

<p>
Podanie portów w postaci makra <tt>$tcp_services</tt> sprawia, ¿e ³atwo dodaæ
kolejne us³ugi, które maj± zostaæ udostêpnione. Wystarczy wyedytowaæ makro i
ponownie za³adowaæ zestaw regu³. Podobnie sprawa ma siê z us³ugami bazuj±cymi
na protokole UDP, potrzeba tylko utworzyæ makro <tt>$udp_services</tt> i dodaæ
bardzo podobn± regu³kê, jak ta pokazana powy¿ej, z opcj± <tt>proto udp</tt>.

<p>
Przepuszczenie pakietów ICMP:
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>

<p>
Podobnie jak makro <tt>$tcp_services</tt>, makro <tt>$icmp_types</tt> mo¿e
byæ w ³atwy sposób zmienione by umo¿liwiæ przepuszczanie innych typów pakietów
ICMP przez firewall. Proszê zwróciæ uwagê, ¿e regu³ka ta odnosi siê do
wszystkich interfejsów sieciowych.

<p>
Kolejne regu³ki przepuszczaj± ruch z lub do sieci wewnêtrznej. Przyk³ad zak³ada,
¿e u¿ytkownicy na wewnêtrznym interfejsie dok³adnie wiedz± co robi± i nie bêd±
powodowaæ problemów. To niekoniecznie prawid³owe za³o¿enie, mniejsza swoboda
mo¿e byæ bardziej odpowiednia w niektórych przypadkach.

<blockquote>
<tt>
pass in on $int_if from $int_if:network to any keep state
</tt>
</blockquote>

<p>
Powy¿sza regu³ka zezwala hostom z sieci lokalnej na wysy³anie pakietów przez
scianê ogniow±, <i>nie</i> umo¿liwia natomiast na nawi±zanie po³±czenia
routera z komputerem z sieci wewnêtrznej. Czy to dobre rozwi±zanie? Odpowied¼
uzale¿niona jest od kilku elementów konfiguracji sieci. Je¶li firewall jest
jednocze¶nie serwerem DHCP, przed przydzieleniem adresu konieczne mo¿e byæ
sprawdzenie czy nie jest on ju¿ przypisany do innego hosta. Je¶li firewall ma
mo¿liwo¶æ nawi±zania po³±czenia z maszyn± w sieci lokalnej, ka¿dy kto zaloguje
siê do routera bêdzie mia³ dostêp do komputrów wewn±trz sieci lokalnej.
Nale¿y jednak pamiêtaæ, ¿e nie jest to w³a¶ciwie ¿adna znacz±ca poprawa
bezpieczeñstwa - je¶li kto¶ niepowo³any uzyska dostêp do bramki, bêdzie te¿
najprawdopodobniej móg³ zmieniæ regu³y filtra pakietów. Dodanie nastêpnej
regu³ki sprawi, ¿e firewall bêdzie móg³ bez przeszkód komunikowaæ siê z
maszynami w sieci wewnêtrznej:

<blockquote>
<tt>
pass out on $int_if from any to $int_if:network keep state
</tt>
</blockquote>

<p>
Wa¿ne jest to, ¿e je¶li obie powy¿sze linie bêd± umieszczone w pliku
konfiguracyjnym, dyrektywa <tt>keep state</tt> nie jest konieczna - wszystkie
pakiety bêd± mog³y wyj¶æ poprzez zewnêtrzny interfejs bez konieczno¶ci
¶ledzenia stanów. Jednak¿e, je¶li linia zaczynaj±ca siê od <tt>pass out</tt> nie
bêdzie dodana, konieczne jest umieszczenie w linii rozpoczynaj±cej siê od
<tt>pass in</tt> opcji <tt>keep state</tt>. Dziêki zastosowaniu ¶ledzenia stanów
mo¿na osi±gn±æ pewn± poprawê wydajno¶ci - tablice stanów s± sprawdzane zanim
datagram zostanie sprawdzony poprzez regu³y, ale poprawa wydajno¶ci dotyczyæ
bêdzie w g³ównej mierze bardzo obci±¿onych filtrów, a ¿e ten przyk³adowy
system jest bardzo prosty, raczej ma³o prawdopodobne aby mo¿na by³o zauwa¿yæ
ró¿nice.

<p>
Ostatnie regu³ki zezwalaj± na przepuszczenie ruchu wychodz±cego przez
zewnêtrzny interfejs sieciowy.
<blockquote>
<tt>
pass out on $ext_if proto tcp all modulate state flags S/SA<br>
pass out on $ext_if proto { udp, icmp } all keep state
</tt>
</blockquote>

<p>
Ruch na protoko³ach TCP, UDP i ICMP jest przepuszczany do Internetu, a ¶ledzenie
stanów pozwala przepu¶ciæ pakiety, które s± odpowiedzi± na wys³ane datagramy.

<a name="allrules"></a>
<h2>Kompletny zestaw regu³</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# makra
int_if = "fxp0"
ext_if = "ep0"

tcp_services = "{ 22, 113 }"
icmp_types = "echoreq"

priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
	  
# opcje
set block-policy return
set loginterface $ext_if

# normalizacja datagramów 
scrub in all

# nat/rdr
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \
   port 8021

# regu³ki filtra pakietów
block all

pass quick on lo0 all

block drop in  quick on $ext_if from $priv_nets to any
block drop out quick on $ext_if from any to $priv_nets

pass in on $ext_if inet proto tcp from any to ($ext_if) \
   port $tcp_services flags S/SA keep state

pass in inet proto icmp all icmp-type $icmp_types keep state

pass in  on $int_if from $int_if:network to any keep state
pass out on $int_if from any to $int_if:network keep state

pass out on $ext_if proto tcp all modulate state flags S/SA
pass out on $ext_if proto { udp, icmp } all keep state
</pre>
</td></tr>
</table>

<p>
[<a href="authpf.html">Wstecz: Authpf: pow³oka dla bramek uwierzytelniaj±cych</a>]
[<a href="index.html">Spis tre¶ci</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: example1.html,v 1.12 ]<br>
$Translation: example1.html,v 1.7 2004/01/12 17:37:45 pl-team Exp $<br>
$OpenBSD: example1.html,v 1.6 2004/01/16 21:01:34 jufi Exp $
</small>

</body>
</html> 
