<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: パケットのタグ付け</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003-2004 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="pools.html">前に戻る: アドレスプールと負荷分散 (Load Balancing)</a>]
[<a href="index.html">目次</a>]
[<a href="logging.html">次に進む: ログの取得</a>]

<p>
<h1><font color="#e00000">PF: パケットのタグ付け</font></h1>

<hr>

<h3>目次</h3>
<ul>
<li><a href="#intro">はじめに</a>
<li><a href="#assign">パケットへのタグの割り付け</a>
<li><a href="#check">適用済タグのチェック</a>
<li><a href="#policy">ポリシーフィルタリング</a>
<li><a href="#ethernet">Ethernet のフレームに対するタグ付け</a>
</ul>

<hr>

<a name="intro"></a>
<h2>はじめに</h2>
パケットへのタグ付けとは、後でフィルタや変換ルールで使用可能な
内部の識別子でパケットにマークを付けるための方法のことです。
タグ付けにより、インターフェイス間の「信頼関係」を作り出したり、
パケットが変換ルールで既に処理されたものかどうかの決定したりすることが
可能になります。
また、ルールベースのフィルタリングをやめて、
ポリシーベースのフィルタリングに移行することもできます。

<a name="assign"></a>
<h2>パケットへのタグの割り付け</h2>
パケットにタグを追加するには、以下のように <tt>tag</tt> キーワードを使用します。
<blockquote>
<tt>
pass in on $int_if all tag INTERNAL_NET keep state
</tt>
</blockquote>

<p>
<tt>INTERNAL_NET</tt> タグは、上記のルールにマッチするすべてのパケットに
追加されます。<tt>keep state</tt> の使用には注意が必要です。<tt>keep state</tt>
(あるいは <tt>modulate state</tt>/<tt>synproxy state</tt>) は、パケットにタグを
付与する <tt>pass</tt> ルール中で使用すべきです。

<p>
タグ付けには以下のようなルールがあります。
<ul>
<li>タグには「粘着性」があります。ルールにマッチすることにより、
いったんタグがパケットに適用されれば、これは決して除去されることはありません。
しかし、異なるタグで、それを置換することは可能です。
<li>タグの「粘着性」のため、最後にマッチしたルールが <tt>tag</tt>
キーワードを使用していない場合でも、パケットはタグを持つことができます。
<li>ある時点で、ひとつのタグには最大でもひとつのパケットだけが割り付けられます。
<li>タグは<i>内部</i>識別子です。タグが送信されることは
ありません。 
</ul>

<p>
例として以下のルールセットを見てみましょう。
<blockquote>
<tt>
(1) pass in on $int_if tag INT_NET keep state<br>
(2) pass in quick on $int_if proto tcp to port 80 tag \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT_NET_HTTP keep state<br>
(3) pass in quick on $int_if from 192.168.1.5 keep state
</tt>
</blockquote>

<p>
<ul>
<li><tt>$int_if</tt> に着信するパケットは、ルール (1) により <tt>INT_NET</tt>
タグが割り付けられます。
<li><tt>$int_if</tt> に着信する送信先がポート 80 の TCP パケットは、
ルール (1) により <tt>INT_NET</tt> タグが最初に割り付けられます。このタグは、
ルール (2) によって <tt>INT_NET_HTTP</tt> タグに置換されます。
<li>192.168.1.5 から <tt>$int_if</tt> に着信するパケットは、
最後にマッチしたルール (3) によって通過が許可されます。
しかし、これらのパケットは、送信先が TCP ポート 80 である場合には、
<tt>INT_NET_HTTP</tt> タグが割り付けられており、そうでなければ、
<tt>INT_NET</tt> タグが割り付けられています。
</ul>

<p>
フィルタルールでタグを適用するだけでなく、<tt>nat</tt>、<tt>rdr</tt> および
<tt>binat</tt> 変換ルールの場合も <tt>tag</tt> キーワードを使用することにより
パケットにタグを適用することもできます。

<a name="check"></a>
<h2>適用済タグのチェック</h2>
適用済のタグをチェックするには、以下のように <tt>tagged</tt> キーワードを使用します。
<blockquote>
<tt>
pass out on $ext_if tagged INT_NET keep state
</tt>
</blockquote>

<p>
<tt>$ext_if</tt> から送出されるパケットは、上記のルールにマッチするよう、
<tt>INT_NET</tt> タグでタグ付けされていなければなりません。以下のように
<tt>!</tt> 演算子を使用することによって、逆のマッチを行うこともできます。
<blockquote>
<tt>
pass out on $ext_if tagged ! WIFI_NET keep state
</tt>
</blockquote>

<a name="policy"></a>
<h2>ポリシーフィルタリング</h2>
ポリシーフィルタリングは、フィルタリングルールセットを記述するのとは異なるアプローチを取ります。
どのタイプのトラフィックが通過を許可され、どのタイプはブロックされるのかというルールを設定する
ポリシーが定義されます。
パケットは、送信元/送信先の IP アドレス/ポート、プロトコル、
などなどの伝統的な基準に基づいてポリシーに分類されます。
たとえば、以下のようなファイアウォールポリシーを調べてみましょう。
<ul>
<li>内部 LAN から DMZ へのトラフィックは許可します (LAN_DMZ)。
<li>インターネットから DMZ 上のサーバへのトラフィックは許可します
(INET_DMZ)。
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamd&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>spamd(8)</a> にリダイレクトされる
インターネットからのトラフィックは許可されます (SPAMD)。
<li>他のすべてのトラフィックはブロックします。
</ul>

<p>
ファイアウォールを通過する<i>すべて</i>のトラフィックをポリシーがどのようにカバーしているのか
ということに注目しましょう。
括弧内のアイテムは、そのポリシーのアイテム用に使用される
タグを示しています。

<p>
まず、パケットをポリシーに分類するため、フィルタおよび変換ルールを
記述する必要があります。
<blockquote>
<tt>
rdr on $ext_if proto tcp from &lt;spamd&gt; to port smtp \<br>
&nbsp;&nbsp;&nbsp;tag SPAMD -&gt; 127.0.0.1 port 8025<br>
<br>
block all<br>
pass in on $int_if from $int_net tag LAN_INET keep state<br>
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ keep state<br>
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ keep state
</tt>
</blockquote>

<p>
次にポリシーを定義したルールを設定します。
<blockquote>
<tt>
pass in &nbsp;quick on $ext_if tagged SPAMD keep state<br>
pass out quick on $ext_if tagged LAN_INET keep state<br>
pass out quick on $dmz_if tagged LAN_DMZ keep state<br>
pass out quick on $dmz_if tagged INET_DMZ keep state
</tt>
</blockquote>

<p>
これですべてのルールセットが設定され、変更すべき点は
せいぜい分類ルールの調整くらいとなります。
たとえば、POP3/SMTP サーバが DMZ に追加された場合、POP3 および SMTP
のトラフィックに対する分類ルールを以下の例のように追加する必要が
あるでしょう。
<blockquote>
<tt>
mail_server = "192.168.0.10"<br>
...<br>
pass in on $ext_if proto tcp to $mail_server port { smtp, pop3 } \<br>
&nbsp;&nbsp;&nbsp;tag INET_DMZ keep state
</tt>
</blockquote>

<p>
これで電子メールのトラフィックが、ポリシーエントリ INET_DMZ の一部として通過が許可されるようになります。

<p>
完全なルールセットは以下のとおりです。
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# マクロ
int_if  = "dc0"
dmz_if  = "dc1"
ext_if  = "ep0"
int_net = "10.0.0.0/24"
dmz_net = "192.168.0.0/24"
www_server = "192.168.0.5"
mail_server = "192.168.0.10"

table &lt;spamd&gt; persist file "/etc/spammers"

# 分類 -- 定義されたファイアウォールポリシーに基づいて
# パケットを分類します。
rdr on $ext_if proto tcp from &lt;spamd&gt; to port smtp \
    tag SPAMD -&gt; 127.0.0.1 port 8025

block all
pass in on $int_if from $int_net tag LAN_INET keep state
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ keep state
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ keep state 
pass in on $ext_if proto tcp to $mail_server port { smtp, pop3 } \
    tag INET_DMZ keep state 

# ポリシーの適用 -- 定義されたファイアウォールポリシーに基づいて通過を許可/ブロックします。
pass in  quick on $ext_if tagged SPAMD keep state
pass out quick on $ext_if tagged LAN_INET keep state
pass out quick on $dmz_if tagged LAN_DMZ keep state
pass out quick on $dmz_if tagged INET_DMZ keep state 
</pre>
</td></tr>
</table>

<a name="ethernet"></a>
<h2>Ethernet のフレームに対するタグ付け</h2>
タグ付け/フィルタリングを行っているマシンが
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&amp;sektion=4&amp;manpath=OpenBSD+3.4"
>bridge(4)</a>
として動作している場合、Ethernet レベルでタグ付けを行うことができます。
<tt>tag</tt> キーワードを使用する bridge(4) 用フィルタルールを生成することで、
PF は送信元/送信先の MAC アドレスに基づいたフィルタを作成することができます。
bridge(4) 用ルールは、たとえば以下の例のように、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=brconfig&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>brconfig(8)</a> コマンドを使用して生成することができます。
<blockquote>
<tt>
# brconfig bridge0 rule pass in on fxp0 src 0:de:ad:be:ef:0 \<br>
&nbsp;&nbsp;&nbsp;tag USER1
</tt>
</blockquote>

<p>
そして、<tt>pf.conf</tt> 中に以下の行を追加します。
<blockquote>
<tt>
pass in on fxp0 tagged USER1
</tt>
</blockquote>

<p>
[<a href="pools.html">前に戻る: アドレスプールと負荷分散 (Load Balancing)</a>]
[<a href="index.html">目次</a>]
[<a href="logging.html">次に進む: ログの取得</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: tagging.html,v 1.2 ]
<br>
$Translation: tagging.html,v 1.2 2004/01/03 06:14:18 toshi Exp $
<br>
$OpenBSD: tagging.html,v 1.2 2004/01/04 22:47:55 horacio Exp $
</small>

</body>
</html> 
