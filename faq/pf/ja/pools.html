<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Address Pools and Load Balancing</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="shortcuts.html">前に戻る: ルールセット作成の近道</a>]
[<a href="index.html">目次</a>]
[<a href="perf.html">次に進む: 性能</a>]

<p>
<h1>
<font color="#e00000">PF: アドレスプールと負荷分散 (Load Balancing)</font>
</h1>

<hr>

<h3>目次</h3>
<ul>
<li><a href="#intro">はじめに</a>
<li><a href="#nat">NAT アドレスプール</a>
<li><a href="#incoming">着信接続の負荷分散</a>
<li><a href="#outgoing">送出トラフィックの負荷分散</a>
	<ul>
	<li><a href="#outexample">ルールセットの例</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>はじめに</h2>
アドレスプールは、ユーザのグループの間で共有して使用される、ふたつ以上のアドレスを
提供するためのものです。アドレスプールは、<a href="rdr.html"><tt>rdr</tt></a> ルール中の
リダイレクションアドレスとして、あるいは、<a href="nat.html"><tt>nat</tt></a> ルール中の
変換アドレスや、<a href="filter.html">フィルタ</a>オプションの
<tt>route-to</tt>、<tt>reply-to</tt> および <tt>dup-to</tt>
のターゲットアドレスとして指定することができます。

<p>
アドレスプールを使用するには、4 つの方法があります。
<ul>
<li><tt>bitmask</tt> - プールアドレスのネットワーク部を、変更されるアドレス
(<tt>nat</tt> ルールの送信元アドレス、<tt>rdr</tt> ルールの送信先アドレス)
に移植します。
例: アドレスプールが 192.0.2.1/24 であり、変換されるアドレスが 10.0.0.50
の場合、結果のアドレスは 192.0.2.50 となります。
アドレスプールが 192.0.2.1/25 であり、変換されるアドレスが 10.0.0.130
の場合、結果のアドレスは 192.0.2.2 となります。
<li><tt>random</tt> - プールからアドレスをランダムに選択します。
<li><tt>source-hash</tt> - プールからどのアドレスを使用するのかを決定するのに、
送信元アドレスのハッシュを使用します。この方法は、与えられた送信元アドレスが
常に同じプールアドレスにマッピングされるのを確実にします。
ハッシュアルゴリズムから導かれた鍵を、オプションとして <tt>source-hash</tt>
の後に 16 進数のフォーマットか文字列で指定することができます。
デフォルトでは、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>pfctl(8)</a> はランダムな鍵をルールセットがロードされるごとに
毎回生成しています。
<li><tt>round-robin</tt> - アドレスプールを順にループします。
これがデフォルトの方法です。
</ul>

<p>
<tt>round-robin</tt> 法を除いて、アドレスプールは
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
(Classless Inter-Domain Routing)
ネットワークブロックとして記述されていなければなりません。<tt>round-robin</tt>
法では、<a href="macros.html#lists">リストのフォーマット</a>を使用して
複数の個々のアドレスを指定できます。

<p>
さらに、<tt>nat</tt> ルールが TCP および UDP パケットの送信元ポートを
変更してしまわないようにするため、<tt>static-port</tt> キーワードを
上記の方法のひとつの後に指定することができます。

<a name="nat"></a>
<h2>NAT アドレスプール</h2>
アドレスプールは、<a href="nat.html"><tt>nat</tt></a> ルールの
変換アドレスとして使用することができます。接続の元の送信元アドレスは、
選択した方法に基づくプールからのアドレスで変換されます。
これは、PF が非常に大規模なネットワークで NAT を実行しているような状況で
役に立つものです。変換アドレスごとの NAT を使用する接続の数は限られているので、
付加的な変換アドレスを追加することは、より多くのユーザにサービスを提供するため、
NAT ゲートウェイがその規模を拡大させることができることを意味します。

<p>
この例では、送出されるパケットを変換するために、ふたつのアドレスのプールが
使用されることになります。それぞれの送出される接続のために、
PF はラウンドロビンで使用するアドレスのローテーションを行います。
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
この方法のひとつの欠点は、内部ネットワークからの一連の接続に対して、
常に同じアドレスへと変換されるとは限らないということでしょう。
これはたとえば、IP アドレスに基づいてユーザのログインを追跡するような
web サイトをブラウジングする際などに、障害となり得るものです。
この代替の方法は、それぞれの内部アドレスが常に同じ変換アドレスへと
変換される <tt>source-hash</tt> 法を使用することです。
これを使用するためには、アドレスプールは
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
ネットワークブロックでなければなりません。
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
この <tt>nat</tt> ルールは、192.0.2.4/31 (192.0.2.4 〜 192.0.2.5) の
アドレスプールを、送出パケットの変換アドレスとして使用しています。
それぞれの内部アドレスは、<tt>source-hash</tt> キーワードによって、
常に同じ変換アドレスへと変換されます。

<a name="incoming"></a>
<h2>着信接続の負荷分散</h2>
アドレスプールはまた、着信接続の負荷分散のためにも使用することができます。
たとえば、web サーバに着信する接続は、以下のように web サーバの集合に
分散させることができるのです。
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $web_servers
</tt>
</blockquote>

<p>
一連の接続は、ラウンドロビン法で web サーバに
リダイレクトされることになります。

<p>
NAT の例としては、すべての web サーバが CIDR ネットワークブロック内に
配置されている場合には、与えられた IP アドレスが物理的に同じ web サーバに
常にリダイレクトされるよう、<tt>source-hash</tt> キーワードを
使用することができます。もう一度言いますが、これは、web サーバのブラウジングの際の
セッション情報を保守するために、ときどき必要となるものです。

<a name="outgoing"></a>
<h2>送出トラフィックの負荷分散</h2>
アドレスプールは、(<a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>
のような) 適正な複数経路用のルーティングプロトコルを利用できない場合に、
ふたつ以上のインターネット接続の負荷分散を行うために <tt>route-to</tt>
フィルタオプションと組み合わせて使用することができます。
<tt>round-robin</tt> 法のアドレスプールとともに <tt>route-to</tt>
を使用することで、外向きの接続は複数の外向きの経路の中で
均等に分散されるようになります。

<p>
これは付加的な情報ですが、このようにするためには、それぞれの
インターネット接続に隣接するルータの IP アドレスが必要になります。
これは、送出パケットの送信先を制御するため、<tt>route-to</tt>
オプションに供給するためのものです。

<p>
以下の例は、ふたつのインターネット接続への送出トラフィックの
負荷分散を行います。
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if route-to \<br>
&nbsp;&nbsp;&nbsp;{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br>
&nbsp;&nbsp;&nbsp;from $lan_net to any keep state
</tt>
</blockquote>

<p>
<tt>route-to</tt> オプションは、それぞれのゲートウェイに対してトラフィックの
負荷分散を行うための、送出用のネットワークインターフェイスを指定するため、
<i>内部</i>インターフェイスに着信するトラフィックに対して使用されるものです。
<tt>route-to</tt> オプションは、<i>それぞれ</i>のトラフィックの負荷分散を行う
フィルタルールが存在していなければならないということに注意してください。
戻りパケットは、送出されたものと同じ外部インターフェイスに返送されて来て
(これは ISP によって行われます)、さらに普通に内部ネットワークへと
転送されて行きます。

<p>
<tt>$ext_if1</tt> に属する送信元アドレスを持つパケットが、常に
<tt>$ext_gw1</tt> へと (そして、同様に、<tt>$ext_if2</tt> は
<tt>$ext_gw2</tt> へと) ルーティングされるのを確実にするため、
以下の 2 行がルールセットに含まれているべきでしょう。
<blockquote>
<tt>
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;to any<br>
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;to any 
</tt>
</blockquote>

<p>
最終的に、NAT をそれぞれの送出用インターフェイスに対して使用することができます。
<blockquote>
<tt>
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)<br>
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
送出トラフィックの負荷分散を行うための完全な例は、
以下のようなものになるかも知れません。

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

#  nat outgoing connections on each internet interface
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)

#  default deny
block in  from any to any
block out from any to any

#  pass all outgoing packets on internal interface
pass out on $int_if from any to $lan_net
#  pass in quick any packets destined for the gateway itself
pass in quick on $int_if from $lan_net to $int_if
#  load balance outgoing tcp traffic from internal network. 
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto tcp from $lan_net to any flags S/SA modulate state
#  load balance outgoing udp and icmp traffic from internal network
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto { udp, icmp } from $lan_net to any keep state

#  general "pass out" rules for external interfaces
pass out on $ext_if1 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if1 proto { udp, icmp } from any to any keep state
pass out on $ext_if2 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if2 proto { udp, icmp } from any to any keep state

#  route packets from any IPs on $ext_if1 to $ext_gw1 and the same for
#  $ext_if2 and $ext_gw2
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 to any 
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 to any 
</pre>
</td></tr>
</table>

<p>
[<a href="shortcuts.html">前に戻る: ルールセット作成の近道</a>]
[<a href="index.html">目次</a>]
[<a href="perf.html">次に進む: 性能</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: pools.html,v 1.7 ]
<br>
$Translation: pools.html,v 1.3 2003/11/10 14:53:17 toshi Exp $
<br>
$OpenBSD: pools.html,v 1.4 2003/11/10 21:40:53 horacio Exp $
</small>

</body>
</html> 
