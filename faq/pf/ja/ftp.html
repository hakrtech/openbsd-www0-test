<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Issues with FTP</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2002-2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="perf.html">前に戻る: 性能</a>]
[<a href="index.html">目次</a>]
[<a href="authpf.html">次に進む: authpf: 認証ゲートウェイ用
ユーザシェル</a>]

<p>
<h1><font color="#e00000">PF: FTP における問題</font></h1>
<hr>

<h3>Table of Contents</h3>
<ul>
<li><a href="#modes">FTP のモード</a>
<li><a href="#client">ファイアウォールの向こう側の FTP クライアント</a>
<li><a href="#server">PF による FTP サーバの "自己防御"</a>
<li><a href="#natserver">PF で NAT を実行する外部の ファイアウォールにより
保護されている FTP サーバ</a>
<li><a href="#info">FTP についてのより詳しい情報</a>
</ul>

<hr>

<a name="modes"></a>
<h2>FTP のモード</h2>
FTP は、インターネットがまだ小さく、コンピュータ同士は友好的な接続を持ち、
誰もが他の人たちを知っていた、そのような時代に作成されたプロトコルです。
そのころはフィルタリングの必要性もなく、固いセキュリティは不要な時代でした。
そのためか、FTP はフィルタリングやファイアウォールの通過、あるいは NAT
で使用するのに向かない設計となっています。

<p>
FTP はふたつの方法、受動的接続 (passive) か能動的接続 (active) のうちのいずれかの方法で
使用することができます。一般的に active か passive かの選択は、ファイアウォールでの
FTP の使用に問題があるかどうかで決定されます。現実的には、ユーザが幸せになるために、
両方の方法をサポートすべきでしょう。

<p>
FTP の能動的接続モードでは、ユーザがリモートの FTP サーバに接続して
情報やファイルを要求する際に、要求されたデータを転送するために FTP
サーバからクライアントに対して新しい接続を行います。これは
データ接続 (<i>data connection</i>) と呼ばれる接続です。FTP クライアントは、
この接続を受信するためのランダムな空ポートを選択します。FTP クライアントは、
選択したポート番号を FTP サーバに送信し、そのポートで FTP サーバからの
接続の着信を待ちます。そして、FTP サーバは、クライアントのアドレスの
選択されたポートに対して接続を開始し、データ転送を行います。しかし、これは、
NAT の向う側にある FTP サーバからの接続を、ユーザが受信しようとする場合に
問題となります。NAT がどのように働くのかという理屈を考えるとわかりますが、
FTP サーバは NAT ゲートウェイの外部アドレスの選択されたポートに対して接続して、
データ接続を開始しようとするからです。そして、NAT マシンがこの接続を受信しますが、
NAT マシンはその状態テーブルにパケットのマッピングを持っていないので、
このパケットは廃棄され、それがクライアントに配信されることはないのです。

<p>
FTP の受動的接続モード (これは OpenBSD の
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1&amp;manpath=OpenBSD+3.3"
>ftp(1)</a> クライアントのデフォルトのモードです) では、クライアントがサーバに
データ接続を待ち受けるためのランダムなポートを選択するよう、要求を出します。
サーバはクライアントに選択したポートの情報を伝え、クライアントはそのポートに接続して
データ転送を行います。不運にも、FTP サーバの手前にあるファイアウォールが、着信する
データ接続をブロックしてしまうかも知れませんので、これは常に可能だったり、
期待できたりするわけではありません。OpenBSD の ftp(1) クライアントは、受動的接続モードを
デフォルトで使用しますが、強制的に能動的接続モードで FTP を使用するには ftp に -A
フラグを指定するか、"<tt>ftp&gt;</tt>" プロンプトで "<tt>passive off</tt>" コマンドを
発行することで、受動的接続モードを "off" に設定するかのいずれかの方法で可能です。


<a name="client"></a>
<h2>ファイアウォールの向こう側の FTP クライアント</h2>
上記のとおり、FTP は NAT やファイアウォールをうまく通過することができません。


<p>
パケットフィルタ (PF) は、FTP プロキシサーバを通過する FTP のトラフィックを
リダイレクトすることで、このような状況に対する解決策を用意しています。
この処理は、NAT ゲートウェイやファイアウォールを通過する FTP トラフィックを
「案内」するように動作します。OpenBSD と PF で使用される FTP プロキシは、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>ftp-proxy(8)</a> です。これを有効化するには、<tt>/etc/pf.conf</tt> の NAT
セクションに以下のような行を追加します。

<blockquote>
<tt>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \<br>
&nbsp;&nbsp;&nbsp;port 8021
</tt>
</blockquote>

<p>
この行の記述は、「内部インターフェイス上のトラフィックは、
ポート 8021 をリスンする、このマシン上で実行されている
プロキシサーバにリダイレクトする」という意味になります。

<p>
できれば、プロキシサーバが OpenBSD を実行するマシン上で動作するようにしたいのではないでしょうか。
これは、以下のような行を <tt>/etc/inetd.conf</tt> に
追加することで可能になります。

<blockquote>
<tt>
127.0.0.1:8021 stream tcp nowait root /usr/libexec/ftp-proxy \<br>
&nbsp;&nbsp;&nbsp;ftp-proxy
</tt>
</blockquote>

<p>
そして、システムをリブートするか、HUP シグナルを
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>inetd(8)</a> に送信するかのどちらかを実行してください。HUP シグナルを送信するには以下のようにします。

<blockquote>
<tt>
kill -HUP `cat /var/run/inetd.pid`
</tt>
</blockquote>

<p>
ftp-proxy がポート 8021 をリスンし、同じポートを上記の <tt>rdr</tt> 命令文が
FTP トラフィックを送信しているということに注意する必要があるでしょう。ポート
8021 の選択は任意のものですが、8021 は他のいかなるアプリケーションによっても
定義されていないので、これは良い選択であると言えるでしょう。

<p>
ftp-proxy(8) は、PF フィルタの背後の <b>FTP クライアント</b>を助けるためのものであって、PF
フィルタの背後の <b>FTP サーバ</b>を扱うために使用するものではないということに注意してください。


<a name="server"></a>
<h2>PF による FTP サーバの "自己防御"</h2>
この場合、PF はファイアウォール専用のコンピュータ上ではなく、FTP サーバ
自身の上で実行されます。受動的接続の FTP 接続に対するサービスを行う場合、
FTP はランダムに選択した、高い番号の TCP ポートを着信データ用に使用します。
デフォルトでは、OpenBSD に附属の FTP サーバ
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>ftpd(8)</a> は、49152 から 65535 の範囲のポートを使用します。
明らかに、これらのポートは、(FTP の制御用ポートである) ポート 21 と同様、
フィルタルールを通過できなければなりません。

<blockquote>
<tt>
pass in on $ext_if proto tcp from any to any port 21 keep state<br>
pass in on $ext_if proto tcp from any to any port &gt; 49151 \<br>
&nbsp;&nbsp;&nbsp;keep state
</tt>
</blockquote>

<p>
もし、その必要性があれば、これらのポートの範囲を大幅に厳しくすることができます。
OpenBSD の
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>ftpd(8)</a> プログラムの場合、これは
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>sysctl(8)</a> の変数 <tt>net.inet.ip.porthifirst</tt> および
<tt>net.inet.ip.porthilast</tt> を使用して制御することができます。

<a name="natserver"></a>
<h2>PF で NAT を実行する外部の ファイアウォールにより保護されている FTP サーバ</h2>
この場合は、ファイアウォールは FTP サーバへのトラフィックをリダイレクトする必要があり、
またリダイレクトされるポートはブロックしてはいけません。この議論のために、問題の FTP
サーバが、今回も、デフォルトのポートの範囲を使用する標準的な OpenBSD の
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>ftpd(8)</a> であると仮定します。

<p>
以下は、この目的を達成するためのルールのサブセットの例です。
<blockquote>
<tt>
ftp_server = "10.0.3.21"<br>
<br>
rdr on $ext_if proto tcp from any to any port 21 -&gt; $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21<br>
rdr on $ext_if proto tcp from any to any port 49152:65535 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$ftp_server port 49152:65535<br>
<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port 21 keep state<br>
pass in quick on $ext_if proto tcp from any to $ftp_server \<br>
&nbsp;&nbsp;&nbsp;port &gt; 49151 keep state
</tt>
</blockquote>


<a name="info"></a>
<h2>FTP についてのより詳しい情報</h2>
FTP のフィルタリングについてのより詳しい情報や、一般的に FTP がどのように
動作するのかということの回答を、以下の白書に見つけることができるでしょう。
<ul>
<li><a href="http://www.pintday.org/whitepapers/ftp-review.shtml">FTP
Reviewed</a>
</ul>

<p>
[<a href="perf.html">前に戻る: 性能</a>]
[<a href="index.html">目次</a>]
[<a href="authpf.html">次に進む: authpf: 認証ゲートウェイ用
ユーザシェル</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: ftp.html,v 1.7 ]
<br>
$Translation: ftp.html,v 1.6 2003/07/10 15:18:32 toshi Exp $
<br>
$OpenBSD: ftp.html,v 1.5 2003/07/11 20:33:06 jufi Exp $
</small>

</body>
</html> 
