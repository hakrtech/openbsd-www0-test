<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Shortcuts For Creating Rulesets</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="anchors.html">前に戻る: アンカーとサブルールセット</a>]
[<a href="index.html">目次</a>]
[<a href="pools.html">次に進む: アドレスプールと負荷分散 (Load Balancing)</a>]

<p>
<h1>
<font color="#e00000">PF: ルールセット作成の近道</font>
</h1>

<hr>

<h3>目次</h3>
<ul>
<li><a href="#intro">はじめに</a>
<li><a href="#macros">マクロの使用</a>
<li><a href="#lists">リストの使用</a>
<li><a href="#grammar">PF の文法</a>
       <ul>
       <li><a href="#elim">キーワードの除去</a>
       <li><a href="#return"><tt>Return</tt> の単純化</a>
       <li><a href="#order">キーワードの順序</a>
       </ul>
</ul>

<hr>

<a name="intro"></a>
<h2>はじめに</h2>
PF はルールセットを単純化することができる多数の方法を用意しています。
その良い例のひとつに
<a href="macros.html#macros">マクロ</a>や
<a href="macros.html#lists">リスト</a>の使用を挙げることができます。
さらに、ルールセット言語やその文法、さらにルールセットを
より簡単にするための近道も用意しています。一般的な経験に基づいて言うと、
より簡単なルールセットは、その理解やメンテナンスがより簡単になると言えます。

<a name="macros"></a>
<h2>マクロの使用</h2>
マクロは、アドレスやポート番号、インターフェイス名などをルールセット中に
ハードコードしなくて済む代替方法を用意するもので、便利な機能です。さて、
サーバの IP アドレスを変更しましたが... &nbsp; でも大丈夫です。マクロを
更新するだけで、あなたのニーズに完全に合致するよう、時間とエネルギーを費した
フィルタルール全体にメスを入れる必要はありません。

<p>
PF のルールセットにおける一般的は習慣は、それぞれのネットワークインターフェイスのための
マクロを定義することです。もし、ここで異なるドライバを使用するネットワークカードに
置換しなければならなくなったとすると、たとえば、3Com を Intel に交換する場合、
マクロを書き換えるだけでフィルタルールは以前と同じように機能してくれます。
もうひとつの利点として、同じルールセットを多数のマシンにインストールする場合を
考えることができます。あるマシンは異なるネットワークカードを持っているかも知れませんが、
ネットワークインターフェイスの定義にマクロを使用していれば、
インストールされるルールセットは最小限の編集で済みます。ルールセット中の、
ポート番号や IP アドレス、インターフェイス名などのような、
変更の対象となり得る情報の定義には、マクロを使用することが推奨されています。
<blockquote>
<tt>
# define macros for each network interface<br>
IntIF = "dc0"<br>
ExtIF = "fxp0"<br>
DmzIF = "fxp1"
</tt>
</blockquote>

<p>
もうひとつの一般的な習慣として、IP アドレスやネットワークブロックの定義にマクロを使用する、
というのがあります。これによって、IP アドレスが変更された場合に
ルールセットのメンテナンスの手間を大幅に減少させることが可能となります。
<blockquote>
<tt>
# define our networks<br>
IntNet = "192.168.0.0/24"<br>
ExtAdd = "24.65.13.4"<br>
DmzNet = "10.0.0.0/24"
</tt>
</blockquote>

<p>
もし、内部ネットワークが、拡張されたり異なる IP ブロックに付け替えられたりした場合でも、
マクロを更新するだけで済みます。
<blockquote>
<tt>
IntNet = "{ 192.168.0.0/24, 192.168.1.0/24 }"
</tt>
</blockquote>

<p>
そして、この後にルールセットをいったん再ロードすれば、すべて以前と同様に動作します。

<a name="lists"></a>
<h2>リストの使用</h2>
インターネットには存在すべきではない、そしてもしインターネット上に存在していれば、
たいていトラブルの原因となってしまう、
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>
で定義されるプライベートアドレスを扱うためのルールセットのお手本を見てみましょう。
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 127.0.0.0/8<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 10.0.0.0/8
</tt>
</blockquote>

<p>
これは、以下のように単純化することができます。
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from { 127.0.0.0/8, 192.168.0.0/16, \<br>
&nbsp;&nbsp;&nbsp;172.16.0.0/12, 10.0.0.0/8 } to any<br>
block out quick on tl0 inet from any to { 127.0.0.0/8, \<br>
&nbsp;&nbsp;&nbsp;192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }
</tt>
</blockquote>

<p>
このルールセットは 8 行から 2 行まで減少させることができました。
ここで、このリスト中でマクロを使用すれば、
さらにわかりやすくなります。
<blockquote>
<tt>
NoRouteIPs = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \<br>
&nbsp;&nbsp;&nbsp;10.0.0.0/8 }"
<br>
ExtIF = "tl0"<br>
block in &nbsp;quick on $ExtIF from $NoRouteIPs to any<br>
block out quick on $ExtIF from any to $NoRouteIPs
</tt>
</blockquote>

<p>
マクロやリストを使用して <tt>/etc/pf.conf</tt> ファイルを単純化することができますが、
それぞれの行は、実際には
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>pfctl(8)</a> によって複数のルールに展開されることに注意してください。
ですので、上記の例は、実際には以下のルールに展開されることになります。
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 10.0.0.0/8<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 127.0.0.0/8
</tt>
</blockquote>

<p>
これまで見てきましたように、PF の拡張は純粋に <tt>/etc/pf.conf</tt>
ファイルの書き手やメンテナに対して便利なものなのであって、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>pf(4)</a>
が処理するルールを実際に単純化できるわけではありません。

<p>
マクロは単にアドレスやポート以上のものを定義するのに使用することもできます。
これらは、PF ルールファイルのどこにでも使用することができます。たとえば、
<blockquote>
<tt>
pre  = "pass in quick on ep0 inet proto tcp from "<br>
post = "to any port { 80, 6667 } keep state"<br>
<br>
# David's classroom<br>
$pre 21.14.24.80 $post<br>
<br>
# Nick's home<br>
$pre 24.2.74.79 $post<br>
$pre 24.2.74.178 $post
</tt>
</blockquote>

<p>
は、以下のように展開されます。
<blockquote>
<tt>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state
</tt>
</blockquote>

<a name="grammar"></a>
<h2>PF の文法</h2>
OpenBSD 3.3 のリリースとともに、より大きなルールセットの柔軟性を持つよう、PF
の文法がチューニングされました。また、PF は、ある種のキーワードを推測できるように
なりましたが、これは、そのようなキーワードをルール中に明示的に記載する必要がない
ことを意味します。キーワードの順序についても、以前ほど厳密である必要はありません。

<a name="elim"></a>
<h3>キーワードの除去</h3>
<p>
「デフォルトで拒否」というポリシーを定義するために、ふたつのルールが使用されます。
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
これは以下のように省略可能です。
<blockquote>
<tt>
block all
</tt>
</blockquote>

<p>
方向が指定されていない場合、PF は両方向に移動するパケットに対して
ルールセットが適用されるものと見なします。

<p>
同様に、"<tt>from any to any</tt>" や "<tt>all</tt>" 節は、
ルールから無視されるかも知れません。たとえば、
<blockquote>
<tt>
block in on rl0 all<br>
pass &nbsp;in quick log on rl0 proto tcp from any to any port 22 keep state
</tt>
</blockquote>

<p>
は、以下のように単純化することができます。
<blockquote>
<tt>
block in on rl0<br>
pass &nbsp;in quick log on rl0 proto tcp to port 22 keep state</tt>
</blockquote>

<p>
最初のルールは、rl0 に対するすべての着信パケットは、どこからどこに行こうとするものでも
すべてブロックされますし、ふたつ目のルールは、rl0 上のポート 22 への TCP トラフィックを通過させます。

<a name="return"></a>
<h3><tt>Return</tt> の単純化</h3>
<p>
ブロックして TCP RST や ICMP Unreachable 応答を返すためのルールセットは、
たとえば以下のようなものであるかも知れません。
<blockquote>
<tt>
block in all<br>
block return-rst in proto tcp all<br>
block return-icmp in proto udp all<br>
block out all<br>
block return-rst out proto tcp all<br>
block return-icmp out proto udp all
</tt>
</blockquote>

<p>
この場合、以下のように単純化することができます。
<blockquote>
<tt>
block return
</tt>
</blockquote>

<p>
PF が <tt>return</tt> キーワードを見つけると、正しい応答を送信するか、
何も応答を返さない、十分洗練された動作を行いますが、この動作は
ブロックされるパケットのプロトコルに依存します。

<a name="order"></a>
<h3>キーワードの順序</h3>
<p>
指定されたキーワードの順序は、ほとんどの場合、柔軟なものです。
たとえば、以下のように記述されたルールの場合、
<blockquote>
<tt>
pass in log quick on rl0 proto tcp to port 22 \<br> 
&nbsp;&nbsp;&nbsp;flags S/SA keep state queue ssh label ssh
</tt>
</blockquote>

<p>
このように書き換えることもできます。
<blockquote>
<tt>
pass in quick log on rl0 proto tcp to port 22 \<br>
&nbsp;&nbsp;&nbsp;queue ssh keep state label ssh flags S/SA
</tt>
</blockquote>

<p>
その他の同様のバリエーションでも同じように動作します。

<p>
[<a href="anchors.html">前に戻る: アンカーとサブルールセット</a>]
[<a href="index.html">目次</a>]
[<a href="pools.html">次に進む: アドレスプールと負荷分散 (Load Balancing)</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: shortcuts.html,v 1.7 ]
<br>
$Translation: shortcuts.html,v 1.5 2003/09/24 04:31:39 toshi Exp $
<br>
$OpenBSD: shortcuts.html,v 1.6 2003/11/03 16:54:43 jufi Exp $
</small>

</body>
</html> 
