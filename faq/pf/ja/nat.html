<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Network Address Translation (NAT)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2002-2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="queueing.html">前に戻る: キューイング</a>]
[<a href="index.html">目次</a>]
[<a href="rdr.html">次に進む: トラフィックリダイレクション</a>]

<p>
<h1><font color="#e00000">PF: ネットワークアドレス変換 (NAT)</font></h1>

<hr>

<h3>目次</h3>
<ul>
<li><a href="#intro">はじめに</a>
<li><a href="#works">NAT はどのように動くか</a>
<li><a href="#enable">NAT の有効化</a>
<li><a href="#config">NAT の設定</a>
<li><a href="#binat">双方向マッピング (1:1 マッピング)</a>
<li><a href="#except">変換ルールの例外</a>
<li><a href="#status">NAT の状態のチェック</a>
</ul>

<hr>

<a name="intro"></a>
<h2>はじめに</h2>
ネットワークアドレス変換 (NAT) は (複数の) ネットワーク全体を、単一の IP
アドレスにマップするための方法です。インターネットサービスプロバイダ (ISP)
から割り当てられた IP アドレスが、インターネットアクセスのために用意しようと
考えているコンピュータの総数より少ない場合には、NAT は必須となります。NAT は
<a href="http://www.geektools.com/rfc/rfc1631.txt">RFC 1631</a>
に記述があります。

<p>
NAT によって、
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>
に記述されている予約済プライベートアドレスのメリットを亨受できるようになります。
典型的に、内部ネットワークは、これらのネットワークブロックをひとつ以上使用して
構築されていることでしょう。これらのネットワークブロックは以下のようなものです。
<pre>
	10.0.0.0/8       (10.0.0.0 - 10.255.255.255)
	172.16.0.0/12    (172.16.0.0 - 172.31.255.255)
	192.168.0.0/16   (192.168.0.0 - 192.168.255.255)
</pre>

<p>
NAT を実行する OpenBSD システムは、片方がインターネット、他方が内部ネットワーク
に接続された、少なくとも 2 枚のネットワークアダプタを持っていることと思います。
NAT は、内部ネットワークからの要求を、それらがすべて OpenBSD 上の NAT システム
から来る要求であるように見せかけるように変換します。

<a name="works"></a>
<h2>NAT はどのように動くか</h2>
<p>
内部ネットワーク上のクライアントがインターネット上のマシンに接続しようとする場合、
そのマシンの IP アドレスを送信先とするパケットを、クライアントは送出します。
これらのパケットは、目的地の必要なアドレスの情報をすべて含んでいます。
NAT はこれらの情報の一部と関連づけられます。
<ul>
<li>送信元の IP アドレス (たとえば、192.168.1.35)
<li>送信元の TCP か UDP のポート番号 (たとえば、2132)
</ul>

<p>
パケットが NAT ゲートウェイを通過する際、パケットは、NAT
ゲートウェイ自身から来ているかのように見えるような修正が加えられます。
NAT ゲートウェイは、a) 戻りのパケットの変更を元に戻すし、b) 確実に戻りの
パケットがファイアウォールを通過し、ブロックされないようにするために、
自身の加えた変更を状態テーブルに記録します。たとえば、NAT ゲートウェイでは、
以下の例のような変更が加えられているかも知れません。
<ul>
<li>送信元の IP: ゲートウェイの外部アドレスと置換
(たとえば、24.5.0.5)
<li>送信元のポート: ランダムに選択したゲートウェイの未使用ポートと置換
(たとえば、53136)
</ul>

<p>
内部マシンでもインターネット上のホストの場合でもない場合には、これらの変換ステップに
注意が必要です。内部マシンに対しては、NAT ゲートウェイは単にインターネットゲートウェイに
見えます。また、インターネット上のホストに対しては、パケットは NAT システムから直接来る
ように見えるので、内部のワークステーションが存在しているかどうかについては、まったく気に
する必要がありません。

<p>
インターネット上のホストが内部マシンのパケットに対して応答する場合、
NAT ゲートウェイの外部 IP アドレス (24.5.0.5) の変換ポート (53136)
宛に向けて送信されます。このとき、NAT ゲートウェイは、
戻りのパケットが既に確立された接続にマッチするかどうかを決定するために、
状態テーブルを探索します。たとえば、192.168.1.35 の IP アドレスを持つ
内部マシンから開始した接続に属するパケットの
IP/ポートの組み合わせがユニークにマッチすれば、
PF は送出パケットに対して行われたものと正反対の変更を戻りのパケットに加え、
そのパケットを内部マシンに対して転送します。

<p>
ICMP パケットの変換も、送信元ポートの修正が行われないことを除いて、
同様の流儀で行われます。

<a name="enable"></a>
<h2>NAT の有効化</h2>
<p>
OpenBSD のゲートウェイ上で NAT を有効化するには、
<a href="config.html#activate">PF の有効化</a>に加えて、
以下のように IP のフォワーディングを有効化しなければなりません。
<blockquote>
<tt>
# sysctl -w net.inet.ip.forwarding=1<br>
# sysctl -w net.inet6.ip6.forwarding=1 <i>(if using IPv6)</i>
</tt>
</blockquote>

<p>
この変更を恒久的に有効化するには、以下のような行を
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl.conf&amp;sektion=5&amp;manpath=OpenBSD+3.4"
><tt>/etc/sysctl.conf</tt></a> ファイルに加えてください。
<blockquote>
<tt>
net.inet.ip.forwarding=1<br>
net.inet6.ip6.forwarding=1
</tt>
</blockquote>

<p>
これらの行は既に存在しているはずですが、デフォルトのインストール状態では (行頭に
<tt>#</tt> がついていて) コメントアウトされているはずです。<tt>#</tt> を削除し、
ファイルを保存して、マシンのリブートすると、IP フォワーディングが有効化されるはずです。

<a name="config"></a>
<h2>NAT の設定</h2>
<tt>/etc/pf.conf</tt> ファイル中の NAT ルールの一般的なフォーマットは、
たとえば以下のようなものです。
<blockquote>
<tt>
nat on <i>extif</i> [<i>af</i>] from <i>src_addr</i> 
[port <i>src_port</i>] to \<br>
&nbsp;&nbsp;&nbsp;<i>dst_addr</i> [port <i>dst_port</i>] -&gt; 
<i>ext_addr</i>
</tt>
</blockquote>

<dl>
<dt><tt><i>extif</i></tt>
<dd>外部ネットワークインターフェイス名

<dt><tt><i>af</i></tt>
<dd>アドレスファミリであり、IPv4 用の <tt>inet</tt> か IPv6 用の
<tt>inet6</tt> のいずれかを指定します。PF は通常は、送信元/送信先の
アドレスに基づいて、このパラメータを決定することができます。

<dt><tt><i>src_addr</i></tt>
<dd>変換されるべきパケットの送信元 (内部) アドレスです。
送信元アドレスは以下のように指定することができます。
<ul>
<li>単一の IPv4 か IPv6 アドレス
<li><a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
ネットワークブロック
<li>ルールセットがロードされる際に DNS
を参照して解決される FQDN。すべての結果の IP アドレスが
ルールに代入されます。
<li>ネットワークインターフェイス名。インターフェイスに割り当てられた
すべての IP アドレスがルールに代入されます。
<li><tt>/<i>netmask</i></tt> (たとえば <tt>/24</tt>) のような
ネットマスクの指定されたネットワークインターフェイス名。インターフェイスの
それぞれの IP アドレスは、ルールに代入される CIDR ネットワークブロックの形で
ネットマスクに結合されます。
<li><tt>:network</tt> キーワードの指定されたネットワークインターフェイス名。
ルールセットのロードの際に、その結果の CIDR ネットワーク (たとえば
192.168.0.0/24) がルールに代入されます。
<li><a href="tables.html">テーブル</a>
<li><tt>!</tt> ("否定") 修飾子を使用して意味を反転させた上記のいずれか
<li><a href="macros.html#lists">リスト</a>を使用したアドレスの集合
<li>キーワード <tt>any</tt> はすべてのアドレスを意味します。
</ul>

<dt><tt><i>src_port</i></tt>
<dd>レイヤ 4 のパケットヘッダ中の送信元ポートです。
以下のポートを指定することができます。
<ul>
<li>1 から 65535 までの番号
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5&amp;manpath=OpenBSD+3.4"
><tt>/etc/services</tt></a>
に記述された正しいサービス名
<li><a href="macros.html#lists">リスト</a>を使用したポートの集合
<li>範囲には以下の演算子が使用できます。
	<ul>
	<li><tt>!=</tt> (not equal)
	<li><tt>&lt;</tt> (less than)
	<li><tt>&gt;</tt> (greater than)
	<li><tt>&lt;=</tt> (less than or equal)
	<li><tt>&gt;=</tt> (greater than or equal)
	<li><tt>&gt;&lt;</tt> (range)
	<li><tt>&lt;&gt;</tt> (inverse range)
	</ul>
	<dl>
	<dd>最後のふたつは二項演算子 (ふたつの引数を取ります) で、
	range 中には引数は含まれません。
	</dl>
</ul>
<tt>port</tt> オプションは、通常は <tt>nat</tt> ルールでは使用されませんが、
これは、その目標が通常は、使用されるポートとは無関係に、すべてのトラフィックに
NAT を行うことだからです。

<dt><tt><i>dst_addr</i></tt>
<dd>パケットの送信先アドレスも変換対象となるものです。
送信先アドレスの指定方法は、送信元アドレスの場合と同様です。

<dt><tt><i>dst_port</i></tt>
<dd>レイヤ 4 のパケットヘッダの送信先ポートです。
送信先ポートの指定方法は、送信元ポートの場合と同様です。

<dt><tt><i>ext_addr</i></tt>
<dd>NAT ゲートウェイ上の外部 (変換) アドレスで、このアドレスにパケットの
アドレスが変換されます。外部アドレスは以下のように指定することができます。
<ul>
<li>単一の IPv4 か IPv6 アドレス
<li><a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
ネットワークブロック
<li>ルールセットがロードされる際に DNS
を参照して解決される FQDN。
<li>外部ネットワークインターフェイス名。インターフェイスに割り当てられた
すべての IP アドレスがルールに代入されます。
<li>括弧 <tt>( )</tt> 内に指定された外部ネットワークインターフェイス名。
これは、PF はこの名前のインターフェイス上の IP アドレスが変更された場合に、
ルールを更新すべきことを指示します。これは、IP アドレスが DHCP 経由や
ダイアルアップ経由で外部インターフェイスに割り当てられている場合に、
アドレスが変更された時に毎回ルールセットを再ロードする必要がないので非常に便利です。
<li><tt>:network</tt> キーワードの指定されたネットワークインターフェイス名。
ルールセットのロードの際に、その結果の CIDR ネットワーク (たとえば
192.168.0.0/24) がルールに代入されます。
<li><a href="macros.html#lists">リスト</a>を使用したアドレスの集合
</ul>

</dl>

<p>
以下は、NAT の最も基本的な形となる例です。
<blockquote>
<tt>
nat on tl0 from 192.168.1.0/24 to any -&gt; 24.5.0.5
</tt>
</blockquote>

<p>
このルールは、<tt>tl0</tt> インターフェイス上の NAT は、
192.168.1.0/24 からのすべての着信パケットの送信元アドレスの
24.5.0.5 の置換を実行するものであることを表しています。

<p>
上記のルールは正しいものではありますが、推奨できる形ではありません。
外部か内部ネットワークのアドレスが変更された場合に、この行を編集する
必要があるので、保守が大変になります。この行の保守を簡単にするための、
以下の例と比較してみてください (ここで、<tt>tl0</tt> は外部インターフェイス、
<tt>dc0</tt> は内部インターフェイスです)。
<blockquote>
<tt>
nat on tl0 from dc0/24 to any -&gt; tl0
</tt>
</blockquote>

<p>
この優位性は明らかで、このルールを変更することなく、どちらのインターフェイスの
IP アドレスも変更することができます。

<p>
上記の例のようなアドレス変換を行うためのインターフェイス名を指定する場合、IP
アドレスは pf.conf の<i>ロード</i>時に決定されるのであり、動作中に必要に応じて
決定されるわけではありません。これは、外部インターフェイスの設定に DHCP を使用している
場合などに、このことが問題になる可能性があります。つまり、割り当てられた IP アドレスが
変更された後も、NAT は送出パケットを古い IP アドレスで変換し続けてしまうからです。
これは、外向けの接続が、その機能を停止してしまう原因となります。
これが正しく動くようにするには、PF が自動的に変換アドレスを更新するよう、
以下の例のようにインターフェイス名を括弧で囲むと良いでしょう。
<blockquote>
<tt>
nat on tl0 from dc0/24 to any -&gt; (tl0)
</tt>
</blockquote>

<p>
これを行うには、ひとつ大きな制限があります。それは、インターフェイス名が括弧で囲まれている場合には、
そのインターフェイス上の最初の IP のエイリアスだけが評価の対象となるということです。

<a name="binat"></a>
<h2>双方向マッピング (1:1 マッピング)</h2>
<tt>binat</tt> ルールを使用すると、双方向のマッピングを確立することができます。
<tt>binat</tt> ルールは、内部 IP アドレスと外部アドレスとの間で
1 対 1 のマッピングを確立します。
これは便利で、たとえば、内部ネットワーク上の Web サーバを、
外部 IP アドレスで公開することも可能になります。
インターネットから外部アドレスへの接続は、内部アドレスに変換され、
Web サーバからの (DNS のリクエストのような) 接続は
外部アドレスに変換されます。
TCP および UDP のポートは、<tt>binat</tt> ルールの場合も
<tt>nat</tt> ルールの場合と同様、決して変更されることはありません。

<p>
例:
<blockquote>
<tt>
web_serv_int = "192.168.1.100"<br>
web_serv_ext = "24.5.0.6"<br>
<br>
binat on tl0 from $web_serv_int to any -&gt; $web_serv_ext<br>
</tt>
</blockquote>

<a name="except"></a>
<h2>変換ルールの例外</h2>
<tt>no</tt> キーワードを使用すると、変換ルールの中に
例外を設けることができます。たとえば、上記の NAT の例を
以下のように修正してみましょう。
<blockquote>
<tt>
no nat on tl0 from 192.168.1.10 to any<br>
nat on tl0 from 192.168.1.0/24 to any -&gt; 24.2.74.79
</tt>
</blockquote>

<p>
このようにすると、192.168.1.10 を除く、192.168.1.0/24 のネットワーク全体で、
パケットは外部アドレスの 24.2.74.79 に変換されるようになります。

<p>
この場合、最初にマッチしたルールが「勝者」となることに注意してください。もし、それが
<tt>no</tt> ルールであると、パケットは変換されません。この <tt>no</tt> キーワードは、
<tt>binat</tt> および <a href="rdr.html"><tt>rdr</tt></a> でもに使用されます。

<a name="status"></a>
<h2>NAT の状態のチェック</h2>
アクティブな NAT の変換状況を見るためには、以下のように
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>pfctl(8)</a> を <tt>-s state</tt> オプションで使用します。
このオプションは、現在のすべての NAT セッションをリストします。

<pre>
   # pfctl -s state
   TCP 192.168.1.35:2132 -&gt; 24.5.0.5:53136 -&gt; 65.42.33.245:22 TIME_WAIT:TIME_WAIT
   UDP 192.168.1.35:2491 -&gt; 24.5.0.5:60527 -&gt; 24.2.68.33:53   MULTIPLE:SINGLE
</pre>

<p>
説明 (最初の行のみ):

<dl>
<dt>TCP
<dd>接続に使用されているプロトコル
</dl>

<dl>
<dt>192.168.1.35:2132
<dd>内部ネットワーク上のマシンの IP アドレス (192.168.1.35)。
発信元ポート (2132) はアドレスの後に表示されています。
これは、IP ヘッダ中の置換されるアドレスでもあります。
</dl>

<dl>
<dt>24.5.0.5:53136
<dd>パケットの変換後となるゲートウェイ上の IP アドレス (24.5.0.5)
とポート (53136) です。
</dl>

<dl>
<dt>65.42.33.245:22
<dd>内部のマシンが接続しようとしている IP アドレス (65.42.33.245)
とポート (22) です。
</dl>

<dl>

<dt>TIME_WAIT:TIME_WAIT
<dd>これは、どの状態の TCP 接続を PF が信用すべきかを指示するものです。
</dl>

<p>
[<a href="queueing.html">前に戻る: キューイング</a>]
[<a href="index.html">目次</a>]
[<a href="rdr.html">次に進む: トラフィックリダイレクション</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: nat.html,v 1.11 ]
<br>
$Translation: nat.html,v 1.10 2003/11/10 14:53:17 toshi Exp $
<br>
$OpenBSD: nat.html,v 1.10 2003/11/10 21:40:53 horacio Exp $
</small>

</body>
</html>
