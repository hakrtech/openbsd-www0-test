<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
 <head>
  <meta http-equiv="Content-Type"
        content="text/html; charset=iso-8859-2">
  <meta name="resource-type"
        content="document">
  <meta name="description"
        CONTENT="How to make an OpenBSD port">
  <meta name="keywords"
        content="openbsd,ports">
  <meta name="distribution"
        content="global">
  <meta name="copyright"
        content="This document copyright 1997-1999 by the OpenBSD project">
  <title>Build OpenBSD portu</title>
  <link rev="made" HREF="mailto:www@openbsd.org">
 </head>
 <body text="#000000" bgcolor="#FFFFFF" link="#23238E">
  <img height=30 width=141 src=../images/smalltitle.gif alt="[OpenBSD]" >

  <h2><font color="#e00000">Build OpenBSD portu</font></h2>

   Právì jste zkompilovali vá¹ oblíbený softwarový balík na va¹em stroji s
   OpenBSD a chcete sdílet va¹e úsilí tím, ¾e tento balík pøemìníte ve
   standartní port. Co k tomu budete potøebovat?
  <p>
   Nejvíce dùle¾itá vìc je <strong>komunikovat</strong>. Zeptejte se lidí
   v <a href="mailto:ports@openbsd.org">ports@openbsd.org</a> jestli u¾
   nepracují na tom samém portu. <em>Dejte o tom vìdìt autorovi originálního
   software</em>, vèetnì problémù, které jste na¹li. Pokud se licenèní
   politika zdá být nesprávná, povìzte mu o to.
   Pokud vyvíjí pouze pro Linux a
   chová se jako kdyby ignoroval zbytek Unixového svìta, zkuste ho
   pøesvìdèit zmìnit názor.
  <p>
   <strong>KOMUNIKACE</strong> je právì ten rozdíl mezi úspì¹ným portem a
   portem který bude pomalu zapomenut.
  <p>
   Nejprve se podívejte na informace o portování na této stránce. Pak se
podívejte na odkazované dokumenty, hlavnì OpenBSD porting
   <a href="../checklist.html">checklist</a>.
  <p>
   Testujte, pak znova testujte, a nakonec testujte je¹tì jednou!
  <p>
   Submitnìte port.  Vytvoøte gzipped tarball v adresáøi portù.
   Pak jej mù¾ete buï vlo¾it na veøejný FTP nebo HTTP server a poslat jeho
   adresu do <a href="mailto:ports@openbsd.org">ports@openbsd.org</a> nebo
   poslat tento port v mime kódování na tu samou adresu. Vyberte si metodu,
   která je vám nejbli¾¹í.
  <p>
  <h3><font color="#0000e0">Dostupné informace o portování</font></h3>
  <ul>
   <li>Soubor <code>/usr/share/mk/bsd.port.mk</code>.  Toto je makefile,
       který je vlo¾en na konci v¹ech souborù makefile v jednotlivých portech.
       Pøeètìte si komentáøe na zaèátku totho souboru, dobøe popisují v¹echny
       dostupné options pro make.
   <li>The
       Dokumentace <a href="http://www.netbsd.org/Documentation/software/packages.html">
       NetBSD Package Systému</a>. Tento dokument popisuje verzi portù pro
       NetBSD ze systému portù z FreeBSD a je celkem u¾iteèná. 
   <li>Sekce 19.2.5 z
       <a href="http://www.freebsd.org/porters-handbook/index.html">FreeBSD
       Handbook</a>.  Toto je "FreeBSD porting bible".
   <li>OpenBSD porting <a href="checklist.html">checklist</a>.
   <li>Nìkteré odli¹nosti z jiných BSD systémù portù, vìt¹inou souhrn 
    <a href="porting/diffs.html">odli¹ností v infrastruktuøe</a>.
   <li><a href="../audio-port.html">Portování audio aplikací do OpenBSD</a>.
   <li>OpenBSD ports mailing list,
       <a href="mailto:ports@openbsd.org">ports@OpenBSD.ORG</a>.
  </ul>
  <h3><font color="#0000e0">Plitika portování v OpenBSD</font></h3>
  <ul>
   <li>OpenBSD NEPOU®ÍVÁ <code>/usr/local/etc/rc.d</code>.<br>
       <code>/usr/local</code> je èasto sdílen mezi nìkolika stroji 
 	 díky NFS. Z tohoto dùvodu soubory s konfigurací specifické pro
	 urèitý stroj nemohou být pod <code>/usr/local</code>, cetrální repository
	 pro daný stroj je v <code>/etc</code>. Navíc politkika OpenBSD je
	 nikdy neupdatovat soubory pod <code>/etc</code> automaticky. Porty které
	 potøebují nìkteré specifické nastavení pøi bootu by mìly poradit
	 administrátorovi, co dìlat ne¾ slepì instalovat soubory.
   <li>OpenBSD NEKOMPRIMUJE manuálové stránky.
   <li>OpenBSD NEPO®ADUJEE <code>-lcrypt</code>.<br>
         ©ifrování DES je èástí standartního kódu v <code>libc</code>.
   <li>OpenBSD je silnì zamìøené na bezpeènost. Mìli byste i pøeèíst a
	 porozumìt 
         <a href="#security">sekci bezepeènost</a> na této stránce.
   <li>Ujistìte se, ¾e jste pøidali CVS tag <code>&#36;OpenBSD&#36;</code> 
         do Makefile. Pokud importujete port z jibého systému ujistìte se,
	 ¾e necháte jejich tag v Makefile. Nicménì FreeBSD tag
	 <code>&#36;Id&#36;</code> nahraïte tagem <code>&#36;FreeBSD&#36;</code>. 
   <li>Cílem je aby v¹echny portované aplikace podporovaly OpenBSD.  K
       dosa¾ení tohoto cíle <strong>MUSÍTE</strong> dodat v¹echny OpenBSD patche
       zpátky ke správci.
  </ul>
  <a name=security></a>
  <h3><font color="#0000e0">Doporuèení pro bezpeènost</font></h3>
       Je zde mnoho bezepènostních problémù o kterých byste mìli vìdìt. Pokud
       si nejste abolutnì jisti co dìláte po¾ádejte prosím o pomoc v mailing listu
       <a href="mailto:ports@openbsd.org">ports</a>. 

  <ul>
   <li><em>Nepou¾ívejte</em> alpha nebo beta kód kdy¾ pøipravujete port.
       Pou¾ijte poslední pravidelné nebo patch vydáni.

   <li>Jakýkoliv software který bude instalován na serveru by mìl být
       projit na buffer overflows, hlavnì nebezpeèné pou¾ití 
       <code>strcat/strcpy/strcmp/sprintf</code>.  Obecnì by mìl být 
       <code>sprintf</code> nahrazen <code>snprintf</code>.

   <li>Nikdy nepou¾ívejte jména souborù namísto opravdové bezpeènosti.
       Existují race conditions, kde nemáte úplnou kontrolu. Na pøíklad 
       útoèník, který ji¾ získal u¾ivatelská práva na va¹em stroji mù¾e nahradit
       soubory v <code>/tmp</code> symbolickými linky na více strategických
       souborù jako napøíklad <code>/etc/master.passwd</code>.

   <li>Na pøílad <code>fopen</code> a <code>freopen</code>
       <strong>vytváøejí nový soubor nebo otevøou existující
       soubor</strong> pro zápis. Útoèník mù¾e vyvoøit symbolický link z 
       <code>/etc/master.passwd</code> na <code>/tmp/addrpool_dump</code>. 
       Jakmile jej otevøete, vá¹ soubor s hesly je ztracen. Ano, dokonce i
       s pøedcházejícím voláním <code>unlink</code> tìsnì pøedtím. Pouze mù¾ete
       zmen¹it okno pøíle¾itosti. Pou¾ivejte <code>open</code> s
       <code>O_CREAT|O_EXCL</code> a <code>fdopen</code>.
                 
   <li>Dal¹ím velmi èastým problémem je funkce <code>mktemp</code>.
       Sledujte varování bsd linkeru o jeho pou¾ití. 
       <strong>Tyto musí být odstranìna</strong>.
       To není tak jednoduché jako <code>s/mktemp/mkstemp/g</code>.  <br>
       Pøeètìte si manuálovou stránku <code>mktemp(3)</code> v OpenBSD
       current pro více informací.
       Správný kód pou¾ívající <code>mkstemp</code> zahrnuje zdrojové kódy
       jako <code>ed</code> nebo <code>mail</code>.
       Vzácný pøípad kódu, který pou¾ívá správnì <code>mktemp</code>
       mù¾ete nalézt v portu <code>rsync</code>.

   <li>To, ¾e nìco mù¾e èíst, neznamená je¹tì ¾e by mìlo. Dosti známá díra
       tohoto typu je <code>startx</code> problém. Jako setuid program mù¾ete
       spustit pøes startx jakýkoliv skript. Pokud tento soubor nebyl platným
       shell skriptem, dostanete chybové hlá¹ení (syntax error) s první øádkou
       dotyèného souboru bez toho, ¾e by startx provádìl nìjakou kontrolu práv.
       Docela dobré k tomu, aby si èlovìk pøeèetl první øádku souboru shadow,
       který èasto jako první záznam obsahuje právì záznam pro u¾ivatele root.
       Neotvírejte vá¹ soubor a pak provìïte  <code>fstat</code> na otevøený
       deskriptor abyste zjistili, jestli byste byli schopni jej otevøít (nebo si
       útoèník bude hrát s /dev/rst0 a pøevine va¹i pásku) -- otevøete jej se
       správným nastavení hodnot uid/gid/grouplist. 
       
   <li>Nepou¾ívejte nic co forkuje shell v setuid programech pøedtím ne¾
       to zanechá svá privilegia. To zahrnuje volání <code>popen</code> a
       <code>system</code>. Pou¾ívejte <code>fork</code>, <code>pipe</code> a
       <code>execve</code>.
       
   <li>Pøedávejte otevøené deskriptory namísto jménù souborù mezi programy
       abyste se vyhnuli 'race conditions'. Dokonce i pokud program neakceptujte
       deskriptory, mù¾ete stále pou¾ít <code>/dev/fd/0</code>.
       
   <li>Pøístupová práva jsou svázána s file deskriptory. Pokud potøebujete
       setuid práva k tomu abyste mohli otevøít soubor, otevøete soubor a pak
       zanechte va¹e privilegia. Mù¾ete poøád pøistupovat k deskriptoru ale
       budete se muset strachovat o ménì vìcí. To má dvì stránky: dokonce i poté,
       co zanecháte privilegia byste mìli stále tyto deskriptory sledovat.
       
   <li>Vyhnìte se setuid root jak mù¾ete. Jednodu¹e øeèeno, root mù¾e
       dìlat cokoliv, ale rootovská práva jsou zøídkakdy nutná, vyjma situace,
       kdy chcete vytvoøit soket s èíslem portu men¹ím ne¾ 1024. Je rozhodnì
       lep¹í to vyøe¹it pomocí <code>inetd</code> a jenom pøidat relevantní
       záznamy do <code>inetd.conf</code>. Musíte znát pøíslu¹nou magii pro psaní
       démonù abyste toho dosáhli. Mìlo by být poznamìnáno, ¾e byste nemìli psát
       setuid programy, pokud nevíte jak na to.
       
   <li>Pou¾ijte setgid namísto setuid. Vìt¹ina souborù nemá práva zápisù pro
       skupinu. Bezpeènostní problém v setgid programu nebude znamenat pro vá¹
       systém mnoho: pouze s právy skupiny bude útoèník v nejhor¹ím schopen
       zmìnit tabulku skóre nìjaké hry nebo nìco podobného. Podívejte se na
       zdrojový kód portu <code>xkobo</code> pro pøíklad takových zmìn.
       
   <li>Nevìøte souborùm, které mají nastavena práva pro zápis pro skupinu.
       Dokonce i pokud pro¹ly setgid programy auditem, nejsou vnímány jako
       dùle¾ité potenciální bezpeènostní díry. Tím pádem vìci které mohou poru¹it
       by nemìly být pova¾ovány za senzitivní informace.
       
   <li>Nevìøte svému prostøedí ! To zahrnuje jednoduché vìci jako vá¹
       <code>PATH</code> (nikdy nepou¾ívejte volání <code>system</code> s
       nekvalifikovaným jménem, vyhnìte se <code>execvp</code>), ale také
       jemnìj¹ích vìcí jako va¹e locales, timezone, termcap, atd. 
       Uvìdomte si tranzitivitu: dokonce i pokud udìláte v¹e pro kontrolu a
       bezpeènost, programy které voláte to dìlat nemusí. <strong>Nikdy</strong>
       nepou¾ívejte <code>system</code> v privilegovaných programech, vystavìjte 
       si vlastní pøíkazovou øádku, a volejte pøímo <code>execve</code>.
       Manuálová stránka <code>perlsec</code> je dobrým úvodem do takovýchto
       problémù.
       
   <li>Nikdy nepu¾ívjte setuid shell-skripty. Tyto jsou nebezpeèné.
       Zabalte je do kódu v C abyste zajistili dobré prostøedí. Na druhé stranì,
       OpenBSD obsahuje bezpeèné perl skripty.
       
   <li>Vyhnìte se dynamickému loaderu. Pokud bì¾íte se setuid právy,
       budete pou¾ívat pouze knihovny kterým vìøíte a které byly projity
       ldconfigem. Setgid není dostateèné øe¹ení.
       
   <li>Dynamické knihovny jsou lstivé. Kód v C++ je podobným problémem.
       Jednodu¹e øeèeno knihovny mohou provést nìjakou akci závislou na va¹em
       prostøedí pøedtím ne¾ se vùbec hlavní program k tomu aby zjistil setgid
       status. Kód <code>issetugid</code> v OpenBSD se sna¾í vypoøádat se s tímto
       problémem, z pohledu toho, kdo pí¹e knihovny. NEpokou¹ejte se portovat
       knihovny dokud podrobnì nerozumíte tomuto problému.
       
  </ul>
  <h3><font color="#0000e0">Obecné rady pro portování</font></h3>
  <ul>
   <li><code>__OpenBSD__</code> by mìl být pou¾íván co nejménì èasto,
       pokud vùbec. Konstrukty vypadající jako 
       <pre>
            #if defined(__NetBSD__) || defined(__FreeBSD__)
       </pre>
       jsou èasto nevhodné. Nepøidávejte slepì <code>__OpenBSD__</code>.
       Namísto toho se sna¾te zjistit, co se dìje a jaká vlastnost je ve
       skuteènosti potøeba. Manuálové stránky jsou èasto u¾iteèné, proto¾e
       obsahují historické komentáøe, zahrnující datum kdy byla vlastnost do BSD
       kódu pøidána. Porovnání numerické hodnoty <code>BSD</code> oproti známým
       releasùm je èasto ta správná cesta. Pro více informací si pøeètìte  
       <a href="ftp://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc/Packages.txt">the
       NetBSD package guide</a>.

   <li>Definování <code>BSD</code> je ¹patný nápad. Zkuste includovat <code>sys/param.h</code>.
       To nedefinuje pouze <code>BSD</code>, dává navíc pøíslu¹nou hodnotu.
       Správný kus kódu by vypadal nìjak takto:
       <pre>
           #if (defined(__unix__) || defined(unix)) &amp;&amp; !defined(USG)
           #include &lt;sys/param.h&gt;
           #endif
       </pre>
   <li>Provádìjte testy na vlastnosti, ne na specifické operaèní systémy.
       Dlouhodobì je mnohem lep¹í testovat zda <code>tcgetattr</code> pracuje ne¾
       zda bì¾íte na BSD 4.3 nebo pozdìj¹í nebo SystemVR4. Tyto typy testù jsou
       jenom matoucí. Cesta jak to obejít, je napø. nastavit
       definice <code>HAVE_TCGETATTR</code> a pak teprve pøejít na testy systémù.
       Tato technika separuje testy vlastností od jednotlivých operaèních
       systémù. Ve spìchu mù¾e dal¹í èlovìk co portuje pøidat do Makefile celý
       set pravidel <code>-DHAVE_XXX</code>. Nebo mù¾ete do configure skriptu
       napsat check na tyto vlastnosti aby byly pøidány automaticky. Jako
       pøíklad, který není vhodný následování lze zmìnit zdrojový kód nethack
       3.2.2: pøedpokládá nahrávání vìcí zalo¾ené na typu operaèního sytému.
       Vìt¹ina z tìchto pøedpokladù je u¾ neaktuální a nereflektují realitu:
       Funkce z POSIXu jsou u¾iteènìj¹í ne¾ odli¹nosti starého BSD versus
       SystemV, dokonce nìkteré tradièní bsd funkce jsou teï poporovány u¾ jen
       pouze pomocí compatibility knihoven.

   <li>Vyhnìte se includování souborù, které includují jiné a ty
       includují... Je to neefektivní. Vá¹ projekt skonèí tak, ¾e bude zahrnovat
       soubor, který zahrnuje v¹echno. Navíc je pak obtí¾nìj¹í opravit problémy.
       Je pak mnohem te¾¹í nìco <em>ne</em>inkludovat.

   <li>Vyhnìte se bizarním trikùm s makry. Oddefinovat makro, které bylo
       definováno v hlavièkovém souboru je ¹patný nápad. Definování maker abyste
       dostali nìjaké specifické chování z sobouru include je také ¹patný nápad:
       kompilaèní módy by mìly být globální. Pokud chcete chování v souladu s
       POSIXem, definujte <code>#define POSIX_C_SOURCE</code> v celém projektu ne
       kdy¾ cítíte, ¾e to zrovna potøebujete. 
       
   <li>Nikdy nepi¹te prototypy systémových funkcí. V¹echny moderní
       systémy, OpenBSD nevyjímaje mají standardní umístìní tìchto prototypù.
       Vìt¹inou jsou to <code>unistd.h</code>, <code>fcntl.h</code> nebo
       <code>termios.h</code>. 
       Manuálová stránka èasto øíká kde jsou prototypy umístìny. Budete
       potøebovat dal¹í kusy maker s <code>HAVE_XXX</code> pro ten správný
       soubor. Nedìlejte si starosti s tím, ¾e includnete nìjaký soubor dvakrát,
       include soubory mají zakomponovány ochrany, které mají zabránit rùzným
       typùm ¹patností.<br>
       Pokud nìjaký ¹patný systém potøebuje abyste napsali prototyp, nevkládejte
       je na ostatních systémech. Va¹e vlastní prototypy nemusí pracovat, proto¾e
       mohou pou¾ívat typy, které nejsou portovatelné na jiné systémy
       (<code>unsigned long</code> namísto <code>size_t</code>), nebo dostanete
       nìjaký ¹patný status u <code>const</code>.
       Nìkteré kompilery jako napø. gcc z OpenBSD jsou schopny provést lep¹í
       práci, s nìkterými velmi frekventovanými funkcemi jako je
       <code>strlen</code> pokud inkludujete ten správný hlavièkový soubor. 

   <li>Nepou¾ívejte jméno standardní systémové funkce pro cokoliv jiného.
       Pokud chete napsat vlastní funkci, dejte jí vlastní jmnéno a volejte ji
       tak v¹ude. Pokud chcete nahradit va¹i funkci standardní systémovou funkci,
       zakomentujte svùj kód a definujte vlastní jméno pro systémovou funkci.
       Nedìlejte to opaènì. Kód by mìl vypadat nìjak takto:
<pre>
       /* prototype part */
       #ifdef USE_OWN_GCVT
       char *foo_gcvt(double number, size_t ndigit, char *buf);
       #else
       /* include correct file */
       #include &lt;stdlib.h&gt;
       /* use system function */
       #define foo_gcvt  gcvt
       #endif

       /* definition part */
       #ifdef USE_OWN_GCVT
       char *foo_gcvt(double number, size_t ndigit, char *buf)
          {
          /* proper definition */
          }

       /* typical use */
       s = foo_gcvt(n, 15, b);
       </pre>
  </ul>
  <h3><font color="#0000e0">Dal¹í U¾iteèné Rady</font></h3>
  <ul>
   <li>Nedávné verze <code>bsd.port.mk</code> nastavovaly instalaèní cestu.
       Napøíklad nastavovaly, aby se cesty <code>/usr/bin</code> a
       <code>/bin</code> prohledávaly <em>pøed</em> cestami
       <code>/usr/local/bin</code> a <code>/usr/X11R6/bin</code>.
   <li><em>NEgenerujte</em> sdílené knihovny pokud je definováno
       <code>${NO_SHARED_LIBS}</code> (pozor, mù¾e být definováno pouze po
       includování <code>bsd.port.mk</code>). Pokud má vá¹ port GNU configure,
       jednudu¹e do Makefile pøidejte øádku 
       <code>CONFIGURE_ARGS += ${CONFIGURE_SHARED}</code>.
   <li>Pokud spoléháte na vlastnost, která se objevila v nedávné verzi 
       <code>bsd.port.mk</code>, nezapomeòte do Makefile pøidat øádku s 
       <code>NEED_VERSION = x.yy</code>.
   <li><code>curses.h/libcurses/libtermlib</code> jsou v OpenBSD 
       ``new curses''.  Zmìòte:<br>
       <code>ncurses.h ==&gt; curses.h</code><br>
       <code>-lncurses ==&gt; -lcurses</code><br>
       ``old (BSD) curses''  je k dispozici pomocí definice 
       <code>_USE_OLD_CURSES_</code>
       pøedtím ne¾ includujete <code>curses.h</code> (obvykle v Makefile) a
       slinkováním s <code>-locurses</code>.
   <li>Ovládání terminálu v OpenBSD bylo upgradováno ze starého BSD
       <code>sgtty</code> na novou rodinu POSIX <code>tcgetattr</code>. Vyhnìte
       se starému stylu ve svém kódu. Nìkteré zdrojové soubory mohou definovat
       <code>tcgetattr</code> jako synonymum pro starý kód <code>sgtty</code>,
       ale to je dobré pouze jako doèasná výpomoc. Zdrojový kód
       <code>xterm</code> je velmi dobrým pøíkladem toho, jak se to nemá dìlat.
       Pokuste se to udìlat správnì: chcete typ, který si pamatuje stav va¹eho
       terminálu (pokud mo¾no typdef), chcete funkci, která extrahuje souèasný
       stav a funkci, která nastaví nový stav. Funkce které modifikují tento stav
       jsou více slo¾ité, proto¾e jsou systémovì závislé. Dále nezapomìòte, ¾e
       budete muset vyøe¹it pøípady, kde nejste pøipojeni k terminálu a kdy
       potøebujete vyøe¹it signály: nejenom ukonèení, ale také pozadí
       (<code>SIGTSTP</code>). Mìli byste v¾dy nechat terminál v rozumném stavu.
       Provádìjte testy pod star¹ím shellem, jako napø. sh, který neresetuje
       terminál pøi ukonèení programu.

   <li>Novej¹í termcap/terminfo a curses, jako ty v OpenBSD, zahrnují
       standardní sekvence pro kontrolování barevných terminálù. Pokud mo¾no
       byste mìli tyto pou¾ívat a vracet se k standradním ANSI sekvencím barev na
       jiných systémech. Nìkteré definice terminálù je¹tì nebyly updatovány a
       budete chtít specifikovat tyto sekvence ruènì. Tak to napøíklad dìlá vim.
       To není úplnì nezbytné. Vyjma privilegovaných programù je obecnì mo¾né
       pøepsat definici z termcapu pomocí promìnné <code>TERMCAP</code> a
       nastavit ji tak aby pracovala správnì.  
   <li>Sémantika signálù je choulostivá a li¹í se od jednoho systému k
       druhému. Pou¾ijte <code>sigaction</code> abyste zajistili specifickou
       sémantiku, spolu s ostatními systémovými voláními zmínìnými v pøislu¹né
       manuálové stránce.
  </ul>
  <hr>
  <a href="index.html"><img height=24 width=24 src=../back.gif border=0 alt=OpenBSD></a> 
  <a href="mailto:www@openbsd.org">www@openbsd.org</a>
<small>
<br>
Originally [OpenBSD: porting.html,v 1.32 ]
<br>
$Translation: porting.html,v 1.3 2001/05/10 20:29:44 certik Exp $
<br>
$OpenBSD: porting.html,v 1.1 2001/05/11 06:07:26 jufi Exp $
</small>
 </body>
</html>
