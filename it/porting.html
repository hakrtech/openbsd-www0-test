<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
 <head>
  <meta http-equiv="Content-Type"
        content="text/html; charset=iso-8859-1">
  <meta name="resource-type"
        content="document">
  <meta name="description"
        CONTENT="Come creare un port per OpenBSD">
  <meta name="keywords"
        content="openbsd,ports">
  <meta name="distribution"
        content="global">
  <meta name="copyright"
        content="This document copyright 1997-2006 by OpenBSD.">
  <title>Building an OpenBSD port</title>
  <link rev="made" HREF="mailto:www@openbsd.org">
 </head>
 <body text="#000000" bgcolor="#FFFFFF" link="#23238E">
<a href="index.html"><img alt="[OpenBSD]" height="30" width="141" src="../images/smalltitle.gif" border="0"></a>

  <h2><font color="#e00000">Costruire un port per OpenBSD</font></h2>

   E così hai appena compilato il tuo pacchetto software preferito
   sulla tua macchina OpenBSD e vuoi condividere il tuo sforzo facendolo
   diventare un port standard. Che fare?
  <p>
   La cosa più importante da fare è <strong>comunicare</strong>.
   Chiedi alle persone su <a href="mailto:ports@openbsd.org">ports@openbsd.org</a>
   se stanno lavorando sullo stesso port. <em>Dillo all'autore del software
   originale</em>, compresi i problemi che potresti incontrare. Se le
   informazioni sulla licenza non sembrano corrette, diglielo. Se hai dovuto
   fare i salti mortali per compilare il port, digli cosa può sistemare.
   Se stanno sviluppando solo per Linux e sembrano ignorare il resto del mondo
   Unix, cerca di cambiare il loro punto di vista.
  <p>
   La <strong>COMUNICAZIONE</strong> fa la differenza fra un port di successo
   e un port che verrà lentamente abbandonato da tutti.
  <p>
   Per prima cosa leggi le informazioni in questa pagina. Quindi dai
   un occhio ai documenti indicati, specialmente la
   <a href="checklist.html">checklist</a> per il porting su OpenBSD.
  <p>
   Testa, poi ri-testa e infine testa ancora!
  <p>
   Sottometti il port. Crea un tarball gzippato della directory del port.
   Puoi metterlo su un server FTP o HTTP pubblico, spedendo il suo
   indirizzo a <a href="mailto:ports@openbsd.org">ports@openbsd.org</a>
   o spedisci il port, codificato mime, allo stesso indirizzo. Scegli il
   metodo migliore per te.

<h3><font color="#0000e0">Indice della Documentazione per il Porting</font></h3>
<ul>
<li><a href="#Avail">Informazioni Disponibili sul Porting</a></li>
<li><a href="#Policy">Policy per il Porting su OpenBSD</a></li>
<li><a href="#Security">Raccomandazioni di Sicurezza</a></li>
<li><a href="#Generic">Dritte Generiche per il Porting</a></li>
<li><a href="#Other">Altre dritte Utili</a></li>
</ul>

  <h3><font color="#0000e0"><a name="Avail">Informazioni Disponibili sul Porting</a></font></h3>
  <ul>
   <li><a href="checklist.html">checklist</a> per il porting su OpenBSD.
   <li>La man page
   <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bsd.port.mk&amp;sektion=5">bsd.port.mk(5)</a>.
       Essa documenta il makefile dell'infrastruttura dei port 
       incluso alla fine di ogni makefile dei port.
       Ci sono ancora alcuni commenti all'inizio del file stesso, ma
       le informazioni più utili sono ormai documentate.
   <li>Alcune differenze rispetto ai sistemi di port degli altri BSD,
   per lo più un riassunto delle <a href="porting/diffs.html">differenze
   nell'infrastruttura</a>.
   <li><a href="porting/libraries.html">Usare librerie condivise nei port
   di OpenBSD</a>. Queste regole sono <strong>molto importanti</strong> non
   appena usi le librerie condivise.
   <li><a href="porting/autoconf.html">Particolarità di GNU autoconf</a>,
   come gestirle nel contesto dei port di OpenBSD.
   <li><a href="porting/config.html">I file di configurazione</a>, spesso
   un grosso problema per i nuovi sviluppatori, e gli strumenti specifici
   che l'albero dei port di OpenBSD possiede per gestirli.
   <li><a href="audio-port.html">Portare applicazioni audio su OpenBSD</a>.
   <li>La documentazione del
       <a href="http://www.netbsd.org/Documentation/software/packages.html">sistema
       di package di NetBSD</a>. Questo documento descrive la versione di NetBSD del
       sistema dei port di FreeBSD ed è molto utile.
   <li>Il 
       <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/porters-handbook/index.html">FreeBSD
       Porter's Handbook</a>. Questa è la bibbia del porting su FreeBSD.
   <li>La mailing list dei port su OpenBSD,
       <a href="mailto:ports@openbsd.org">ports@openbsd.org</a>.
  </ul>

  <h3><font color="#0000e0"><a name="Policy">Policy per il Porting su OpenBSD</a></font></h3>
  <ul>
    <li>OpenBSD non usa <code>/usr/local/etc/rc.d</code>.<br>
       <code>/usr/local</code> è spesso condivisa fra più macchine tramite NFS.
       Per questo motivo i file di configurazione specifici di una macchina non
       possono essere contenuti in <code>/usr/local</code>, <code>/etc</code> è
       il deposito centrale per i file di configurazione della macchina.
       Inoltre, la politica di OpenBSD è di non aggiornare mai automaticamente i
       file in <code>/etc</code>. I port che hanno bisogno di specifiche
       impostazioni di boot dovrebbero avvertire l'amministratore di cosa fare
       anziché installare file alla cieca.
   <li>OpenBSD NON comprime le man page.
   <li>OpenBSD NON richiede <code>-lcrypt</code>.<br>
       La crittografia DES fa parte della <code>libc</code> standard.
   <li>OpenBSD ha un namespace distinto per utenti e gruppi creati dai port.
       Per ulteriori dettagli, vedi <code>/usr/ports/infrastructure/db/user.list</code>.
   <li>OpenBSD è fortemente orientato alla sicurezza. Dovresti leggere e capire
       la <a href="#Security">sezione sulla sicurezza</a> di questa pagina.
   <li>Assicurati di aggiungere il tag CVS <code>&#36;OpenBSD&#36;</code> al
       Makefile. Importando un port da un altro sistema assicurati di lasciare
       anche il loro tag nel Makefile.
   <li>Lo scopo è che tutte le applicazioni portate supportino OpenBSD. Per
       raggiungere questo scopo <strong>devi</strong> mandare le patch per
       OpenBSD allo sviluppatore dell'applicazione.
  </ul>

  <h3><font color="#0000e0"><a name="Security">Raccomandazioni di sicurezza</a></font></h3>
  Ci sono parecchi problemi di sicurezza di cui preoccuparsi. Se non sei
       assolutamente sicuro chiedi aiuto alla mailing list sui
       <a href="mailto:ports@openbsd.org">port</a>.
  <ul>
   <li><em>Non</em> usare codice alfa o beta nel preparare un port. Usa
        l'ultima release regolare o patchata.
   <li>Qualunque software da installare come server dovrebbe essere esaminato
       alla ricerca di buffer overflow, specialmente l'uso insicuro di
       <code>strcat/strcpy/strcmp/sprintf</code>. In generale,
       <code>sprintf</code> dovrebbe essere sostituita con <code>snprintf</code>.
   <li>Non usare mai i nomi di file al posto della vera sicurezza. Ci sono
       numerose race condition dove non hai pieno controllo. Per esempio, un
       attaccante che ha già privilegi di utente sulle tue macchine potrebbe
       sostituire i file in <code>/tmp</code> con link simbolici a file più
       strategici, come <code>/etc/master.passwd</code>.  

   <li>Per esempio, sia <code>fopen</code> che <code>freopen</code>
       <strong>creano un nuovo file o ne aprono uno esistente</strong> in
       scrittura. Un attaccante potrebbe creare un link simbolico da
       <code>/etc/master.passwd</code> a <code>/tmp/addrpool_dump</code>.
       Appena lo apri, il tuo file delle password viene modificato. Già, anche
       con un <code>unlink</code> subito prima. Restringi solo il campo delle
       possibilità. Usa piuttosto <code>open</code> con
       <code>O_CREAT|O_EXCL</code> e <code>fdopen</code>.
                 
   <li>Un altro problema molto comune è la funzione <code>mktemp</code>. Dai
       retta agli avvertimenti del linker bsd sul suo utilizzo. <strong>Devono
       essere corretti</strong>. Non è facile come code>s/mktemp/mkstemp/g</code>.
       <br>Fai riferimento a
       <a href="http://www.openbsd.org/cgi-bin/man.cgi?sektion=3&amp;query=mktemp"><code>mktemp(3)</code></a>
       per maggiori informazioni. Codice che usa correttamente
       <code>mkstemp</code> comprende il sorgente di <code>ed</code> o
       <code>mail</code>. Un raro esempio di codice che usa corretamente
       <code>mktemp</code> può essere trovato nel port di <code>rsync</code>.
   <li>Solo perché lo puoi leggere non significa che lo devi fare. Un famoso
       buco di questo tipo era il problema di <code>startx</code>. Come
       programma setuid, potevi lanciare startx con qualunque file come script.
       Se il file non era uno shell script valido, si otteneva un messaggio di
       errore, insieme alla prima riga del file in questione, senza ulteriori
       verifiche sui permessi. Molto utile per ottenere la prima riga del file
       shadow delle password, considerando che comincia spesso con la riga di
       root. Non aprire il file, e poi fai un <code>fstat</code> sul descrittore
       aperto per verificare se avresti dovuto essere in grado di aprirlo
       (altrimenti l'attaccante giocherà con /dev/rst0 e riavvolgerà il nastro)
       -- aprilo con le informazioni uid/gid/grouplist corrette.
   <li>Non usare nulla che forki una shell in programmi setuid prima di
       abbassare i propri privilegi. Questo comprende <code>popen</code> e
       <code>system</code>. Usa invece <code>fork</code>, <code>pipe</code>
       e <code>execve</code>
   <li>Passa i descrittori aperti agli altri programmi anziché i nomi di file
       per evitare race condition. Anche se un programma non accetta i
       descrittori di file, puoi sempre usare <code>/dev/fd/0</code>.
   <li>I diritti di accesso sono legati ai descrittori di file. Se hai bisogno
       di diritti setuid per aprire un file, apri quel file, quindi abbassa i
       tuoi privilegi. Puoi sempre accedere al descrittore aperto, ma hai meno
       di cui preoccuparti. Anche dopo aver abbassato i tuoi privilegi, dovresti
       sempre stare attento a quei descrittori.
   <li>Evita i programmi setuid root per quanto possibile. root può fare
       praticamente tutto, ma i diritti di root sono necessari molto di rado,
       tranne forse per creare socket su porte sotto la 1024. E' meglio comunque
       tenere quei processi sotto il controllo di <code>inetd</code> e aggingere
       le voci corrispondenti in <code>inetd.conf</code>. Devi conoscere la
       giusta magia per scrivere demoni corretti. Si può dire che non conviene
       scrivere programmi setuid se non si sa come si fa.
   <li>Usa setgid anziché setuid. A parte i file specifici necessari ai
       programmi setgid, la maggior parte dei file non è scrivibile dal gruppo.
       Di conseguenza, un problema di sicurezza in un programma setgid non
       comprometterà il sistema: con i soli diritti di gruppo, il peggio che un
       intruso potrà fare è manomettere una tabella con i punteggi di un gioco
       o giù di lì. Vedi il port di <code>xkobo</code> per un cambiamento del
       genere.
   <li>Non fidarti di file scrivibili dal gruppo. Anche se sono stati
       controllati, i programmi setgid non sono percepiti come potenziali buchi
       di sicurezza importanti. Quindi i dati che manipolano non dovrebbero
       essere considerati sensibili.
   <li>Non fidarti dell'ambiente! Questo comprende cose semplici come il tuo
       <code>PATH</code> (non usare mai code>system</code> con un percorso non
       assoluto, evita <code>execvp</code>), ma anche molto più sottili come
       le impostazioni local, il fuso orario, termcap, eccetera. Fai attenzione
       alla transitività: anche se prendi tutte le precauzioni, i programmi che
       chiami direttamente non lo faranno necessariamente.Non usare
       <strong>mai</strong> <code>system</code> in programmi privilegiati,
       costruisci la tua riga di comando, un ambiente controllato e chiama
       <code>execve</code> direttamente. La man page di <code>perlsec</code> 
       è una buona guida per questi problemi.
   <li>Non usare mai script shell setuid. Sono  insicuri per definizione.
       Inseriscili all'interno di codice C che assicuri un ambiente corretto.
       D'altro canto, OpenBSD contiene script perl sicuri.
   <li>Fai attenzione al dynamic loader. Eseguendo un setuid, occorre usare
       solo librerie fidate, analizzate con ldconfig. Setgid non basta.
   <li>Le librerie dinamiche sono ostiche. Il C++ pone un problema analogo.
       In pratica, le librerie possono compiere determinate azioni in base al
       tuo ambiente prima ancora che il programma principale arrivi a verificare
       se è setuid. <code>issetugid</code> di OpenBSD affronta questo problema,
       dal punto di vista dell'autore di librerie. Non provare a portare
       librerie se non afferri fino in fondo questo problema.
  </ul>
  <h3><font color="#0000e0"><a name="Generic">Dritte generiche per il porting</a></font></h3>
  <ul>
   <li><code>__OpenBSD__</code> dovrebbe essere usato di rado, se non mai.
       Costrutti ome
       <pre>
            #if defined(__NetBSD__) || defined(__FreeBSD__)
       </pre>
       sono spesso fuori luogo. Non aggiungere <code>__OpenBSD__</code> alla
       cieca. Cerca invece di capire cosa sta succedendo, e quale funzionalità
       è effettivamente richiesta. La pagine di manuale sono spesso utili, dato
       che includono commenti storici, spiegando quando una certa funzionalità
       è stata inclusa in BSD. Verificare il valore numerico di <code>BSD</code>
       a seconda delle release è spesso il modo giusto. Vedi 
       <a href="http://www.netbsd.org/Documentation/pkgsrc/">la guida a pkgsrc di NetBSD</a>
       per maggiori informazioni.
   <li>Definire <code>BSD</code> è una pessima idea. Cerca di includere
       <code>sys/param.h</code>. Non solo definisce <code>BSD</code>, ma gli dà
       anche un valore corretto. Il frammento di codice corretto sarebbe:
       <pre>
           #if (defined(__unix__) || defined(unix)) &amp;&amp; !defined(USG)
           #include &lt;sys/param.h&gt;
           #endif
       </pre>
   <li>Testa le funzionalità, non gli specifici sistemi operativi. Nel lungo
       periodo, è molto meglio verificare se <code>tcgetattr</code> funziona
       anziché se sei su BSD 4.3 o successivo, o SystemVR4. Questi tipi di test
       confondono solo il problema. Un modo di procedere può essere, ad esempio,
       fare prove su un sistema particolare, impostare un gruppo di define
       <code>HAVE_TCGETATTR</code>, quindi passare al sistema successivo.
       Questa tecnica permette di separare i test sulle funzionalità dai sistemi
       operativi. Nella fretta, un porter può aggiungere l'intero insieme di
       define <code>-DHAVE_XXX</code> al Makefile. Può anche aggiungere o
       scrivere in un file di configurazione di verificare quella funzionalità
       e aggiungerla automaticamente. Come esempio da non seguire, vedi il
       sorgente di nethack 3.2.2: ipotizza un mare di cose in base al tipo di
       sistema. La maggior parte di queste ipotesi sono obsolete e non
       riflettono più la realtà: le funzioni POSIX sono molto più utili delle
       vecchie differenze fra BSD e SystemV, tanto che ormai alcune funzioni BSD
       tradizionali sono supportate solo tramite le librerie di compatibilità.
   <li>Evita di includere dei file che includono altri file che... Primo, perché
       è inefficente. Il tuo progetto finirà per includere un file che include
       tutto. Inoltre, perché rende difficile risolvere alcuni problemi. Diventa
       più difficile <em>non</em> includere un certo file a un dato momento.
   <li>Evita strani giochetti con le macro. Annullare una macro definita in un
       header file è una pessima idea. Anche definire macro per ottenere un
       comportamento particolare da un file include è una pessima idea: le
       modalità di compilazione dovrebbero essere globali. Se vuoi un
       comportamento POSIX, dillo, e inserisci
       <code>#define POSIX_C_SOURCE</code> in tutto il progetto, non quando ti
       pare.
   <li>Non scrivere mai prototipi di funzioni di sistema. Tutti i sistemi
       moderni, compreso OpenBSD, hanno un posto standard per questi prototipi.
       Posti tipici sono <code>unistd.h</code>, <code>fcntl.h</code> o 
       <code>termios.h</code>.
       La man page indica spesso dove si trova il prototipo. Potresti aver
       bisogno di un altro gruppo di macro <code>HAVE_XXX</code> per procurarti
       il file giusto. Non preoccuparti di includere lo stesso file due volte,
       i file include hanno guardie che prevengono ogni tipo di stranezze.<br>
       Se qualche sistema richiede la scrittura del prototipo, non importlo
       anche a tutti gli altri sistemi operativi. I prototipi fai-da-te
       falliranno perché possono usare tipi equivalenti sul tuo sistema, ma non
       portabili su altri (<code>unsigned long</code> al posto di
       <code>size_t</code>). Inoltre, alcuni compilatori, come il gcc di
       OpenBSD, fanno un lavoro migliore con alcune funzioni usatissime come
       <code>strlen</code> se si includono i file header corretti.
   <li>Non usare il nome di una funzione standard per nient'altro. Se vuoi
       creare la tua funzione, dalle un nome proprio e chiamala ovunque. Se vuoi
       tornare alla funzione di sistema di default, devi solo commentare il tuo
       codice e definire il nome della tua funzione cole la funzione di sistema.
       Non fare il contrario. Il codice dovrebbe assomigliare a
<pre>
       /* prototype part */
       #ifdef USE_OWN_GCVT
       char *foo_gcvt(double number, size_t ndigit, char *buf);
       #else
       /* include correct file */
       #include &lt;stdlib.h&gt;
       /* use system function */
       #define foo_gcvt  gcvt
       #endif

       /* definition part */
       #ifdef USE_OWN_GCVT
       char *foo_gcvt(double number, size_t ndigit, char *buf)
          {
          /* proper definition */
          }

       /* typical use */
       s = foo_gcvt(n, 15, b);
       </pre>
  </ul>
  <h3><font color="#0000e0"><a name="Other">Altre dritte utili</a></font></h3>
  <ul>
   <li>Le versioni recenti di <code>bsd.port.mk</code> impostano il percorso
       degli installer. In particolare, impostano di cercare <em>prima</em> in
       <code>/usr/bin</code> e <code>/bin</code> che in
       <code>/usr/local/bin</code> e <code>/usr/X11R6/bin</code>.
   <li><em>NON</em> generare librerie condivise se
       <code>${NO_SHARED_LIBS}</code> è impostato a yes (attenzione, può essere
       definito solo dopo l'inclusione di <code>bsd.port.mk</code>). Se il tuo
       port ha un configure GNU, aggiungi semplicemente la riga
       <code>CONFIGURE_ARGS += ${CONFIGURE_SHARED}</code> al Makefile.
   <li>E' corretto fare affidamento su una funzionalità apparsa di recente in
       <code>bsd.port.mk</code>, dato che si suppone che chiunque aggiorni
       l'intero albero dei port, compreso <code>bsd.port.mk</code>.
       NEED_VERSION è ormai obsoleto.
   <li>E' preferibile usare <code>update-plist</code> per generare e aggiornare
       le packing-list anziché fare le cose a mano.
       Puoi commentare le righe che non ti servono.
       <code>update-plist</code> può identificare la maggior parte dei tipi di
       file e copiare la maggior parte delle annotazioni extra correttamente.
   <li>Aggiungi <code>USE_SYSTRACE=Yes</code> a <code>/etc/mk.conf</code> per
       individuare script, Makefiles, etc. non corretti.
   <li>In OpenBSD <code>curses.h/libcurses/libtermlib</code> sono le
       ``new curses''. Modifica:<br>
       <code>ncurses.h ==&gt; curses.h</code><br>
       ``old (BSD) curses'' è disponibile definendo
       <code>_USE_OLD_CURSES_</code> prima di includere <code>curses.h</code>
       (di solito in un Makefile) e linkando con <code>-locurses</code>.
   <li>In OpenBSD, l'uso del terminale è passato dal vecchio <code>sgtty</code>
       BSD alla nuova famiglia POSIX <code>tcgetattr</code>. Evita il vecchio
       stile nel nuovo codice. Del codice può definire
       <code>tcgetattr</code> come sinonimo del vecchio <code>sgtty</code>, ma
       questo è al massimo una via di fuga su OpenBSD.
       Il codice sorgente di <code>xterm</code> è un ottimo esempio di cosa non
       fare. Cerca di rendere corrette le funzionalità del tuo sistema: vuoi un
       tipo che immagazzini lo stato del tuo terminale (possibile typedef),
       vuoi una funzione che ricavi lo stato corrente e una funzione che imposti
       il nuovo stato. Le funzioni che modifichino questo stato sono più
       difficili, dato che variano a seconda del sistema. Inoltre,  ricorda che
       dovrai gestire casi in cui non sei connesso a un terminale e che devi
       gestire i segnali: non solo di termine, ma anche background
       (<code>SIGTSTP</code>). Dovresti sempre lasciare il terminale in uno
       stato corretto. Fai i test con una vecchia shell, come sh, che non
       resetta in alcun modo il terminale alla fine del programma.
   <li>Le nuove termcap/terminfo e curses, incluse in OpenBSD, comprendono
       sequenze standard per controllare i colori dei terminali. Dovresti usare
       queste, se possibile, ripiegando alle sequenze di colore ANSI sugli altri
       sisitemi. Comunque, alcune descrizioni di terminali non sono ancora state
       aggiornate e potresti aver bisogno di specificare queste sequenze a mano.
       E' in questo modo che vim le gestisce. Questo non è strettamente
       necessario. Tranne per i programmi privilegiati, è generalmente possibile
       ridefinire una definizione di termcap per mezzo della variabile
       <code>TERMCAP</code> e farlo funzionare correttamente.
   <li>La semantica dei segnali è complessa, e varia da sistema a sistema.
       Usa <code>sigaction</code> per essere sicuro di una specifica semantica
       insieme ad altre chiamate di sistema menzionate nella man page
       corrispondente.
  </ul>
  <hr>
  <a href="index.html"><img height=24 width=24 src=../back.gif border=0 alt=OpenBSD></a> 
  <a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: porting.html,v 1.54 ]<br>
$Translation: porting.html,v 1.3 2006/05/02 10:09:27 danix Exp $
-->
$OpenBSD: porting.html,v 1.3 2006/05/02 17:09:35 jufi Exp $
</small>

 </body>
</html>
