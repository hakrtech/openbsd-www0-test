<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
   <META http-equiv="Content-Type" content="text/html; charset=iso-2022-jp">
   <TITLE>CTM</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#23238E">

<center>
<img alt="CTM for OpenBSD" src="../images/bsdctm.gif" width="401" height="126">
</center>

<H3><font color="#0000e0">CTM とは ?</font></H3>

<P>
CTM は、ソースツリーへの変更を定期的に電子メールで利用できるよう、
Poul-Henning Kamp により設計されたシステムだ。
モデム接続のような遅いインターネット接続を利用している場合、これは、
現在のソースツリーや CVS リポジトリを最新のものに保つ良い方法だろう。

<P>
OpenBSD CTM は、OpenBSD の CVS リポジトリのすべてのモジュールを配布すること
ができる。また、チェックアウトされたバージョンの配布に使うこともできる。
CTM はツリーへの変更を配布するのに、非常に狭い帯域幅しか使わず、さらに
それを <tt><b>gzip -9</b></tt> を使って圧縮している。
<a href="cvsup.html">CVSup</a> とは対照的に、CTM はプレーンな C 言語で記述
されているので、OpenBSD がサポートするすべてのプラットフォームで利用可能だ。
他のすべての OpenBSD の CVS リポジトリにアクセスする方法がプルシステム
なのに対して、CTM はプッシュシステムと呼ばれる実装となっている。

<p>
CTM に関する<b>どんな</b>問題、示唆、報告、または質問でも、 CTM 保守担当の
<a href="mailto:hgw@d1906.inka.de">Hans G&uuml;nter Weigand</a> に連絡を
取って欲しい。
<small>(CTM のサポートについては、他の OpenBSD の人たちには尋ねないでね。
なにしろ、彼等は他のことで手いっぱいだから。よろしく。)</small>

<H3><font color="#0000e0">どのように動くのか ?</font></H3>

<P>
CTM についての基本的な考え方は、特殊な CVS モジュールやソースツリーのための
特別なメーリングリストを講読するということだ。毎日、その間にツリーに
加えられたすべての変更を含んだ電子メールを、あなたは受け取ることになろう。
そのような差分のセットは<b>デルタ</b>と呼ばれる。
実際には、CTM サーバは 12 時間ごとに新しいデルタを作っている。

<P>
ベースセットから始めるが、これに対して後のデルタをパッチとして当てる。 CTM を
使い始めるためには、最新のベースセットおよびその後に生成されたすべてのデルタを
ダウンロードする。一度、それらを処理すれば、メーリングリストから受け取るその後
のデルタを処理できるようになる。ベースセットは、回線状況が良くなくてもダウン
ロードが容易になるよう、1400kB ずつに分割されている。

<P>
ベースセットは 50 個の相対デルタごとに生成されるので、追いかけるために 50 個
以上の相対デルタを落としてくる必要はない。

<P>
現時点では、2 種類のベースセットがある。我々はかなりの間、
<tt><b>tar.gz</b></tt> ファイルを手動で作成していたのだけれど、
本当の CTM ベースデルタに戻した。後者は、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=md5&sektion=1">md5(1)</a>
チェックサムを含み、これは自動生成されているので、こちらの方が少しだけ安全だね。
これら 2 種類のベースセットは、そのファイル名で区別できるだろう。
たとえば、<tt><b>tar.gz</b></tt> ファイルの場合なら、
<tt><b>OpenBSD-cvs.1450.tar.gz</b></tt> となるのに対して、CTM ベースデルタなら
<tt><b>OpenBSD-cvs.1500A.gz</b></tt> となる。
詳細な取り扱い説明は以下を見て欲しい。

<H3><font color="#0000e0">CTM はどれくらいの帯域幅を使うのか ?</font></H3>

<P>
以下にリストされたサイトから、FTP でベースデルタおよび最近までの
すべての相対デルタを取得する。サイズは次のとおり:

<ul>
<li>OpenBSD-cvs の場合、およそ 215MB。
<li>OpenBSD-cvs-x11 の場合、およそ 40MB。
<li>OpenBSD-cvs-xf4 の場合、およそ 65MB。
<li>OpenBSD-src の場合、およそ 83MB。
<li>OpenBSD-src-x11 の場合、およそ 36MB。
<li>OpenBSD-ports の場合、およそ 4MB。
<br>これらが圧縮したサイズであることを心に留めておいて欲しい。
    伸長したファイルはおよそ 5 倍ほどの大きさになる。
<li>相対デルタは 10kB から 500kB くらいまで、さらには時に数MB くらいまで
    変化することがある。
<li>CTM は、自動的に再構成される 100kB のメイルのメッセージに、
    常にデルタを分割する。
<li>デルタが 5MB よりも大きい場合には、それはメイルでは送られない。
    その代わりに、FTP によってデルタを取得するための通知を受け取る
    ことだろう。大きな CTM のアップデートは稀だけど、binutils、
    Perl、gcc、XFree86 などのようなもののメジャーなインポートや
    CVS リポジトリへのタグ付けの後だけに通常は起き得るものだ。
</ul>

<H3><font color="#0000e0">CTM はどのように使うのか ?</font></H3>

<UL>
<LI>お望みのソースセットのための CTM メーリングリストの講読。
<p>
   CTM 関連のいくつかのメーリングリストがある。CVS リポジトリの更新の
   ためのメーリングリスト、ソースツリーのためのメーリングリスト、X11
   部分の両方のためのメーリングリストと、そして ports ツリー、さらに
   CTM のデルタ生成の際のメッセージログのためのメーリングリストだ。
   <p>
   以下のコマンドで、適切なメーリングリストを講読できる:
<p>
CVS リポジトリ用 (CVSROOT, ports, src および www モジュール,
ただし、X11 と XF4 は含まず):
<pre>
	echo subscribe OpenBSD-cvs | mail majordomo@OpenBSD.org
</pre>
X11 モジュールの CVS リポジトリ用:
<pre>
	echo subscribe OpenBSD-cvs-x11 | mail majordomo@OpenBSD.org
</pre>
XF4 モジュールの CVS リポジトリ用:
<pre>
	echo subscribe OpenBSD-cvs-xf4 | mail majordomo@OpenBSD.org
</pre>
ソースモジュールのチェックアウトされたコピー用:
<pre>
	echo subscribe OpenBSD-src | mail majordomo@OpenBSD.org
</pre>
X11 モジュールのチェックアウトされたコピー用:
<pre>
	echo subscribe OpenBSD-src-x11 | mail majordomo@OpenBSD.org
</pre>
ports モジュールのチェックアウトされたコピー用:
<pre>
	echo subscribe OpenBSD-ports-ctm | mail majordomo@OpenBSD.org
</pre>
CTM のログ用:
<pre>
	echo subscribe ctm-log | mail majordomo@OpenBSD.org
</pre>

<p>
<li>パッケージか ports コレクションから CTM プログラムをインストール
しよう。ports は
<tt><b>/usr/ports/devel/ctm</b></tt> にある。

</ul>
<b>注:</b> 次の例は、OpenBSD-cvs を明確にカバーしている。
その他のソースセットも同様の方法で扱われている。

<p><ul>

<li>FTP サイトからベースセットをダウンロードする。そのサブディレクトリに
<tt><b>base/OpenBSD-cvs</b></tt> がある。そのディレクトリの中のファイルを
すべてを取得する。一度、それらすべてを取得したなら、ベースセットファイルを
生成でき、そして、取得したファイルのタイプに依存するが、以下のコマンドで
それらをアンパックできるだろう。

<pre>
	cat split/OpenBSD-cvs.1500A.gz.* &gt; OpenBSD-cvs.1500A.gz
	cd target
	ctm -v -v -v .../OpenBSD-cvs.1500A.gz
</pre>
<p>
あるいは、

<pre>
	cat split/OpenBSD-cvs.1450.tar.gz.* &gt; OpenBSD-cvs.1450.tar.gz
	cd target
	tar -xzvf .../OpenBSD-cvs.1450.tar.gz
</pre>

<p>
ここで、<tt><b>split</b></tt> とは、ダウンロードしたファイルを置いた
ディレクトリのことであり、そして <tt><b>target</b></tt> とは、
ソースセットをアンパックする場所として選んだディレクトリのことだ。

<p> もし、完全なツリーが得られたことが確認できれば、これらのベース
セットファイルを保存しておく必要はない。が、もちろん、ベースセット
ファイルをバックアップ目的で保存しておいても良い。いずれにしても、
作業を継続する前に、ベースセットの番号をちゃんと控えておくこと。

<p>
<li>今、ベースセットから生成されたものとのデルタを取得する必要がある。
以下にリストされた FTP サーバのひとつのサブディレクトリ
<tt><b>OpenBSD-cvs</b></tt> から、使用するベースセットの番号よりも
<em>大きな</em>番号の各ファイルをダウンロードして欲しい。そして、
それらのデルタを以下のようにして適用しよう。

<pre>
	cd target
	ctm -v -v -v deltas/OpenBSD-cvs.*
</pre>

<p>
ここで、<tt><b>target</b></tt> とは、ソースセットのツリーのディレクトリ
のことであり、そして <tt><b>deltas</b></tt> とは、デルタの置かれている
ディレクトリのことだ。

<p>
<LI>メーリングリストからの最初のデルタが到着するのを待とう。
<p>
<LI><tt><b>ctm_rmail</b></tt> を使って、CTM デルタをアンパック、構成して、適用しよう。
<p>

<pre>
	ctm_rmail -p /tmp -d deltas -b target folder
</pre>

<p>
ここで、<tt><b>folder</b></tt> とは、デルタのメールを含んだ
メールフォルダのことだ。このコマンドが、CTM デルタをデコードし、
それを <tt><b>deltas</b></tt> ディレクトリに保存するのだ。デルタは、
<tt><b>OpenBSD-cvs.<var>XXXX</var>.gz</b></tt> という形態の
ファイルであり、ここで <var>XXXX</var> とは、デルタの番号のことだ。
そうしたら、そのデルタを、ベースセットをアンパックした
<tt><b>target</b></tt> の場所にあるディレクトリツリーに適用しよう。

<p>
メーリングリストからデルタを受け取るごとに、この最後のステップを
繰り返そう。お好み次第で、procmail、maildrop、あるいは他の同様の
<a href="ports.html">ports コレクション</a> のプログラムを使って、
このステップを自動化することも可能だ。
</ul>

<p>
以下は、CTM デルタを取得可能な FTP サーバのリストだ。

<ul>
<li>プライマリ FTP サーバ:
<p>
<a href="ftp://openbsd.rug.ac.be:/pub/OpenBSD-ctm/">
     ftp://openbsd.rug.ac.be:/pub/OpenBSD-ctm/
</a>
<p>
このサーバは、CTM デルタ生成プロセスによって、自動的にアップデートされている。
ベースセットは、
<tt><b>base</b></tt> ディレクトリの下のひとつの大きなファイルとして存在
しており、分割ファイルは <tt><b>base-split</b></tt> ディレクトリの下にある。
</ul>

<ul>
<li><a href="ftp://ctm.se.OpenBSD.org:/pub/OpenBSD-ctm/">
     ftp://ctm.se.OpenBSD.org:/pub/OpenBSD-ctm/
</a>
<p>
このサーバは、メーリングリストからの CTM デルタによってアップデートされている。
このサーバは、<tt><b>base</b></tt> サブディレクトリの下に、
<a href="ftp://openbsd.rug.ac.be:/pub/OpenBSD-ctm/">
     ftp://openbsd.rug.ac.be:/pub/OpenBSD-ctm/
</a>
をミラーした、分割ベースデルタを付加的に持っている。
</ul>

<ul>
<li><a href="ftp://ctm.OpenBSD.org:/pub/OpenBSD-ctm/">
     ftp://ctm.OpenBSD.org:/pub/OpenBSD-ctm/
</a>
<p>
は、
<p>
<li><a href="ftp://ctm.ca.OpenBSD.org:/pub/OpenBSD-ctm/">
     ftp://ctm.ca.OpenBSD.org:/pub/OpenBSD-ctm/
</a>
<p>
と同じサーバであり、そして、
<a href="ftp://ctm.se.OpenBSD.org:/pub/OpenBSD-ctm/">
     ftp://ctm.se.OpenBSD.org
</a>
のミラーとなっている。
</ul>

<p>
<b>注:</b> <a href="mailto:hgw@d1906.inka.de">私</a> は
      これらのデルタをミラーしてくれる、世界中のサイトを
      大変な関心を持って探している。
<p>

<h3><font color="#0000e0">ソースツリーと CVS リポジトリ、どちらを選ぶべき ?</font></h3>

<P>
他の要素の中でも、これに関しては、あなたのディスクスペースに依存する。
CTM はローカルに変更されたファイルをほとんど反映することができないので、
より良い選択となるのは確実に <a href="anoncvs.html">CVS</a> リポジトリ
の方だろう。自分の CVS リポジトリから、ソースツリーの作業用コピーを
チェックアウトもできるし、安定版のブランチを追いかけることもできるし、
自分のローカルな変更を自分のソースツリー中でキープすることもできる。
CVS は、あなたのローカルな変更をマージできるくらい良くできたものだ。
さらに、あなたは、<tt><b>cvs commit</b></tt> や <tt><b>cvs tag</b></tt>
のようなコマンドを除いた、すべての範囲の CVS コマンドを利用可能でもある。

<p>
しかしながら、欠点としては、それが必要とするディスクスペースの量があるだろう。
チェックアウトされたソースツリーは約 370MB 程度を必要とするが、あなたは
自分自身の CVS リポジトリを持っているとして、そのために 1GB 以上も必要と
なり、<b>それに加えて</b> 370MB がチェックアウトしたツリー用に必要となる。
この中には、たとえば、ソースのコンパイルなどの、ビルド中に生成されるファイル
のために必要な (アーキテクチャに依存する) 100MB 以上の領域は含まれていない。

<p>
もし、ソースツリーを得られたなら、ローカルな変更を反映する必要があろう。
これを行うためのひとつの方法としては、<b>union</b> ファイルシステムがある
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mount_union&sektion=8">mount_union(8)</a>
を参照)。しかし、上層および下層の両方が、同じ物理的ファイルシステム上にある
場合、<b>union</b> ファイルシステムは不安定であるとのレポートも出されている。
もし、上層と下層を別々のファイルシステムに配置できるのであれば、特に問題は
ないだろう。これについての例は次のとおり:

<p>
CTM で更新されたツリーが <tt><b>/usr/src-ctm</b></tt> にあり、そして、
自分自身で変更を加え、そこでビルドされる実際のソースツリーが
<tt><b>/usr/src</b></tt> にあると仮定する。
<tt><b>/usr/src</b></tt> は初期状態では空のディレクトリであるべきだ。
次のコマンドで、union マウントをセットアップできるだろう。

<pre>
	mount -t union -o -b /usr/src-ctm /usr/src
</pre>

<p>
<tt><b>/usr/src</b></tt> 中のファイルに加えられた変更は、
<tt><b>src-ctm</b></tt> 中のファイルを隠して、<tt><b>/usr/src</b></tt> 中に
含まれるファイルになるだろう。もし、<tt><b>src-ctm</b></tt> のツリー下の
ファイルに CTM 経由でこのような変更が加えられても、上層のファイルが下層を
隠すかのように、これらの変更が見える<b>わけではない</b>。

<p>
定期的に union をアンマウントして、
ローカルから union ファイルシステムに移ったファイルをサーチすべきだろう。

<pre>
	umount /usr/src
	find /usr/src -type f
</pre>

<p>
コマンド <tt><b>ls -W</b></tt> および <tt><b>rm -W</b></tt> も、
<tt><b>/usr/src</b></tt> の中の "whiteouts" という名前のオブジェクトが
<tt><b>src-ctm</b></tt> のファイルを隠すだろうから、役に立つことだろう。

<p>
CVS リポジトリを入手したら、そこからソースツリーをチェックアウトするのに、
<tt><b>cvs checkout</b></tt> コマンドを使用することができる。
毎回、CTM での更新時に、ソースリポジトリを更新するのに、
<tt><b>cvs update</b></tt> コマンドを使用することができる。

<p>
初期状態の src リポジトリを得るには:
<pre>
	cd /usr
	cvs -qd YOUR_CVS_REPOSITORY checkout -P src
</pre>
<p>
そして、それぞれの CTM の更新後:
<pre>
	cd /usr/src
	cvs -q update -Pd
</pre>

<H3><font color="#0000e0">OpenBSD の CTM はどの程度安定しているのか ?</font></H3>

CTM は 5 年以上も OpenBSD で使用されてきており、また、FreeBSD では
さらに長い期間使用されてきた。CTM は非常に信頼性があり、安定している。

<h3><font color="#0000e0">CTM を維持するために何が行われているのか ?</font></h3>

数々の (小さな) 変更と最適化が可能。
それらの中で:

<ul>
<li> CTM never sends a delta bigger than 5MB via mail.  This could be
     changed in two ways: The maximum delta size could be increased,
     or a queue could be installed, from which only a certain number
     of messages are mailed out daily.  E. g., if a delta is 6MB in
     size, it is split into 96 mail messages.  These are put into a
     queue.  On the first day, the first 50 messages are sent, on the
     second day the remaining 46, plus the first 4 messages of the
     following delta.
<li> The CTM software could be rewritten, or at least fixed in a
     better manner.  Its C implemtation is not an example of good
     programming.  That would also be a nice opportunity for adding
     new features, like signing CTM deltas with PGP.
</ul>

<ul>
<li> CTM は 5MB 以上のデルタを決してメールでは送信しない。これについては、
     二種類の変更が可能で、デルタの最大サイズを増加させることもできたし、
     または、決まった数のメールを毎日送信するためだけのキューを
     インストールすることもできた。たとえば、デルタが 6MB の大きさの
     場合、これは 96 個のメールメッセージに分割される。そして、それらは、
     キューに入れられる。初日は最初の 50 個のメッセージを送信し、
     二日目には残りの 46 個に加えて、次のデルタの最初の 4 メッセージ
     を送信する。
<li> CTM ソフトウェアは書き換えたり、または、少なくとも、より良い方法で
     フィックスすることもできる。その C 言語の実装は、良いプログラミング
     の見本ではない。しかし、また、それは、PGP による CTM デルタへの署名
     のような新機能を追加するための良い目的ともなるだろう。
</ul>

あなたの御意見・御希望を、<a href="mailto:hgw@d1906.inka.de">私</a>にメールして欲しい !

<H3><font color="#0000e0">さらなる情報</font></H3>

もし、CTM についてさらに知りたいなら、それを始める良い場所として、
FreeBSD ハンドブックがある。

<ul>
<li> <a href="http://www.FreeBSD.org/handbook/ctm.html">
         http://www.FreeBSD.org/handbook/ctm.html
     </a>
</ul>

また、すべての CTM ユーティリティのためのマニュアルページもある。

<h3><font color="#0000e0">要約:</font></h3>

<p>
<ul>
<li> メーリングリスト:

   <ul>
   <li><tt>echo subscribe OpenBSD-cvs | mail majordomo@OpenBSD.org</tt>
   <li><tt>echo subscribe OpenBSD-cvs-x11 | mail majordomo@OpenBSD.org</tt>
   <li><tt>echo subscribe OpenBSD-cvs-xf4 | mail majordomo@OpenBSD.org</tt>
   <li><tt>echo subscribe OpenBSD-src | mail majordomo@OpenBSD.org</tt>
   <li><tt>echo subscribe OpenBSD-src-x11 | mail majordomo@OpenBSD.org</tt>
   <li><tt>echo subscribe OpenBSD-ports-ctm | mail majordomo@OpenBSD.org</tt>
   <li><tt>echo subscribe ctm-log | mail majordomo@OpenBSD.org</tt>
   </ul>
<p>
<li> FTP (ベースセットとそれに関連するデルタ用):

   <ul>
   <li> <a href="ftp://openbsd.rug.ac.be:/pub/OpenBSD-ctm/">
        ftp://openbsd.rug.ac.be:/pub/OpenBSD-ctm/</a>
   <li> <a href="ftp://ctm.OpenBSD.org:/pub/OpenBSD-ctm/">
        ftp://ctm.OpenBSD.org:/pub/OpenBSD-ctm/</a>
   <li> <a href="ftp://ctm.ca.OpenBSD.org:/pub/OpenBSD-ctm/">
        ftp://ctm.ca.OpenBSD.org:/pub/OpenBSD-ctm/</a>
   <li> <a href="ftp://ctm.se.OpenBSD.org:/pub/OpenBSD-ctm/">
        ftp://ctm.se.OpenBSD.org:/pub/OpenBSD-ctm/</a>
   </ul>
</ul>

<p>
CTM に関する重要な注意事項とアナウンスは、announce@OpenBSD.org
メーリングリストに投稿されるだろう。

<p>

<H3><font color="#0000e0">謝辞</font></H3>

<ul>
<li> Poul-Henning Kamp (phk@FreeBSD.org) は、CTM を使用可能なものにし、
     デルタの生成できるようにするのを助けてくれた。

<li> Theo de Raadt (deraadt@theos.com) は、OpenBSD を使用可能なものにし、
     (現在は別のところで生成されているが) cvs.OpenBSD.org 上で CTM デルタ
     を生成するのに必要なリソースを最初に提供してくれ、そして、
     ネームサーバのマジックも提供してくれた。

<li> Todd C. Miller (millert@OpenBSD.org) は、CTM メーリングリストを
     セットアップし、メンテナンスしてくれている。

<li> Bob Beck (beck@OpenBSD.org)、Artur Grabowski (art@OpenBSD.org)、
     Magnus Holmberg (mho@OpenBSD.org) と
     Wolfram Schneider (wosch@FreeBSD.org) は、ctm.*OpenBSD.org 上の
     ベースセットとデルタ用に ftp 用の領域をセットアップしてくれた。

<li> Thomas Graichen (graichen@OpenBSD.org) は、OpenBSD のための CTM 
     をスタートし、それをずっとメンテナンスしてくれている。

<li> Wim Vandeputte (wvdputte@OpenBSD.org) は、現在 CTM をホスティングしてくれている。

<li> ... そして、間接的に寄与してくれた、他のすべての人々
</ul>


<p>
OpenBSD プロジェクトのための OpenBSD/CTM のロゴは、
   <a href="mailto:flipk@openbsd.org">Phillip F Knaack</a> によってデザインされた。
<p>
<hr>
<a href="index.html"><img height="24" width="24" src="back.gif" border="0" alt="OpenBSD" /></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>

<br>
<small>
Originally [OpenBSD: ctm.html,v 1.21 ]
<br>
$Translation: ctm.html,v 1.1 2002/04/01 14:29:44 toshi Exp $
<br>
$OpenBSD: ctm.html,v 1.1 2002/04/05 06:02:56 jufi Exp $
<br>
</small>

</body>
</html>
