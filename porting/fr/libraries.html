<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org">
<meta http-equiv="Content-Type" content=
"text/html; charset=iso-8859-1">
<meta name="resource-type" content="document">
<meta name="description" content=
"Shared libraries in the ports tree">
<meta name="keywords" content="openbsd,ports,library">
<meta name="distribution" content="global">
<meta name="copyright" content=
"This document copyright 2001 by OpenBSD.">
<title>Gestion des bibliothèques partagées dans l'arbre des ports OpenBSD</title>
</head>
<body text="Black" bgcolor="White" link="#23238E">
<img height="30" width="141" src="../../images/smalltitle.gif" alt=
"[OpenBSD]"> 

<h1>Comment gérer les bibliothèques partagées dans l'arbre des ports</h1>

<h2>Comprendre les règles de numérotation des bibliothèques partagées</h2>
Les bibliothèques partagées sont quelque peu rusées et ce pour plusieurs
raisons. Vous devez comprendre le schéma de nommage des bibliothèques :
<code>libfoo.so.majeur.mineur</code>.
<p>
Quand vous liez un programme, l'éditeur de liens <code>ld</code> inclut
cette information dans le binaire créé. Vous pouvez voir ceci avec 
<code>ldd</code>. Par la suite, lorsque vous lancez le programme,
l'éditeur de liens dynamique <code>ld.so</code> utilise cette information 
pour trouver la bonne bibliothèque dynamique :
<ul>
        <li>Une bibliothèque avec le même numéro majeur est requise.
        <li>Une bibliothèque avec un numéro mineur égal ou supérieur est requise.
</ul>
Ainsi, cela signifie que <strong>toutes</strong> les bibliothèques avec le
même numéro majeur et un numéro mineur égal ou supérieur <strong>
doivent satisfaire l'API binaire que le programme prévoit</strong>. Si
ce n'est pas le cas, votre port est alors cassé. Spécifiquement, cela se
produira quand les utilisateurs essaieront de mettre à jour leurs
systèmes.
<p>
Les règles pour les bibliothèques partagées sont relativement simples.
<ul>
        <li>Si vous ajoutez des fonctions aux bibliothèques, vous devez
            augmenter le numéro mineur de la bibliothèque : un programme
            qui nécessite ces fonctions n'a aucun moyen de les exiger
            mais peut le demander explicitement avec une version
            minimale à utiliser.

        <li>Si les API existantes changent, ce qui est souvent le cas,
            si toutes les signatures de fonction sont modifiées, si les
            séquences d'appel ne sont plus valides ou si un type change
            d'une façon incompatible, le numéro majeur de la bibliothèque
            <string>doit être augmenté</strong>.

        <li>Ceci inclut la suppression des anciennes fonctions. Toutes
            les suppressions de fonction déclenchent une augmentation du
            numéro majeur.
</ul>
<p>
Parfois, il arrive qu'une bibliothèque soit écrite en plusieurs fichiers,
et que les fonctions internes doivent apparaitre comme visibles pour
communiquer avec ces fichiers.
Ces noms de fonction commencent traditionnellement avec un trait de
soulignement, et ne sont pas une partie proprement dite de l'API.
<p>
Notez que le schéma de nommage des bibliothèques est omniprésent sur les
plates-formes OpenBSD qu'elles soient ELF ou a.out.

<h2>Peaufiner les constructions de ports pour obtenir les noms corrects</h2>
Un certain nombre de ports ont besoin d'être peaufinés afin de
compiler correctement et continuellement les bibliothèques partagées.
Rappelez vous que la construction des bibliothèques partagées doit être
réalisée avec <code>gcc -shared -fpic|-fPIC -o libfoo.so.4.5 obj1
obj2</code>
<p>
Renommez la bibliothèque après ceci afin d'ajuster le numéro de version ne
marche pas : les bibliothèques ELF utilisent d'autres nombres magiques pour
fixer le nom interne de la bibliothèque, et vous devriez ainsi la lier avec
une version correcte dès la première fois.
<p>
D'un autre côté, rappelez vous que vous pouvez redéfinir les variables
du Makefile depuis la ligne de commande, en utilisant
<code>MAKE_FLAGS</code> dans le Makefile du port. Ceci est tout à fait
utile pour les ports basés sur la libtool par exemple, qui fournissent
une version variable pour chaque bibliothèque qu'ils créent.

<p>
Le meilleur moyen de gérer les ports basés sur libtool est d'utiliser la
variable
<code>USE_LIBTOOL=Yes</code>. Cela active la version de libtool présente
dans l'arbre des ports qui se charge automatiquement de la plupart des
détails :
<ul>
 <li>libtool regarde <code>SHARED_LIBS</code> et remplace
     automatiquement les numéros de version. 
 <li>libtool crée un log des bibliothèques partagées dans le fichier
     <code>${WRKBUILD}/shared_libs.log</code> qui peut être directement
     intégré dans le Makefile du port.
</ul>

<h2>Essayer de placer toutes les bibliothèques visibles à un utilisateur
    dans /usr/local/lib</h2>
En règle générale, demander à l'utilisateur d'ajouter des répertoires
dans leur "path" ldconfig est une très mauvaise idée : toutes les
bibliothèques partagées qui sont directement liées aux programmes devraient
apparaitre dans /usr/local/lib. Cependant, il est tout à fait possible
d'utiliser un lien symbolique vers la bibliothèque actuelle. Vous devriez
comprendre les règles de parcour des bibliothèques :
<ul>
  <li>Au moment de la construction, <code>ld</code> utilise les drapeaux
      <code>-L</code> pour régler les "paths" dans lequel regarder pour
      une bibliothèque. Il arrête le parcour dès lors qu'il trouve une
      bibliothèque qui correspond à sa recherche.
  <li>Au moment du lancement, <code>ld.so</code> utilise l'information
      mise en cache par <code>ldconfig</code> pour trouver la bibliothèque
      requise.
</ul>

A présent, supposons que vous avez deux ports qui fournissent deux
versions majeures d'une bibliothèque donnée, à savoir <code>qt.1.45</code>
et <code>qt.2.31</code>. Puisque les deux ports peuvent être installés
simultanément, pour être sur qu'un programme donné sera lié avec qt.1,
cette bibliothèque est fournie avec
<code>/usr/local/lib/qt/libqt.so.1.45</code>, et les programmes seront
liés en utilisant <code>ld -o program program.o -L/usr/local/lib/qt
-lqt</code>. De même, un programme lié avec qt.2 utilisera le fichier
<code>/usr/local/lib/qt2/libqt.so.2.31</code> avec <code>ld -o program
program.o -L/usr/local/lib/qt2 -lqt</code>.
<p>
Pour résoudre ces bibliothèques au moment du lancement, un lien appelé
<code>/usr/local/lib/libqt.so.1.45</code> et un lien appelé
<code>/usr/local/lib/libqt.so.2.31</code> sont fournis. Ceci est
suffisant pour satisfaire <code>ld.so</code>
<p>
Lier un programme en utilisant qt1 avec
<code>ld -o program program.o -L/usr/local/lib -lqt</code> est une
erreur. Ce code suppose que le <code>qt.2.31</code> n'est pas installé,
ce qui est une fausse prétention.
<p>
De telles astuces sont uniquement nécessaires dans les rares cas de
bibliothèques dominantes ou une période de transition entre deux versions
majeures doit être fournie. En général, ceci est suffisant pour
s'assurer de la présence de la bibliothèque dans
<code>/usr/local/lib</code>.
<h2>Ecrire correctement les dépendances de bibliothèque</h2>
Le nouveau code de dépendance a besoin des dépendances complètes des
bibliothèques. Vous devez utiliser <code>make lib-depends-check</code> ou
<code>make port-lib-depends-check</code>
pour vérifier qu'un port mentionne toutes les bibliothèques
requises. 
Vous devez juste les écrite dans LIB_DEPENDS/WANTLIB comme cela :
<pre>
        LIB_DEPENDS += ::x11/gtk+
        WANTLIB += gtk.&gt;=1.2,gdk.&gt;=1.2
</pre>
<p>
Spécifier les bibliothèques statiques sur la ligne WANTLIB n'est pas une
erreur à part entière. WANTLIB est évaluée intégralement au moment
de la construction du paquet : le paquetage résultant aura une information
de dépendance de bibliothèque inclut dans <code>ld.so</code> qui porte
le numéro majeur.mineur actuel qui était utilisé pour la construction,
mais rien pour les bibliothèques statiques.
<p>
Vous devez aussi fournir RUN_DEPENDS si un port requiert quelquechose au
delà d'une bibliothèque proprement dite. Ceci permettra au port de se
construire correctement sur les architectures qui ne supportent pas les
bibliothèques partagées.
<p>
En fait, fournir les lignes LIB_DEPENDS même pour les bibliothèques statiques
est une bonne idée : ceci simplifiera la mise à jour du port si une
dépendance donnée passe d'une bibliothèque statique à une bibliothèque
partagée.
<p>
Les lignes WANTLIB doivent spécifier les même "paths" que ceux
utilisés par <code>ld</code>. Avec le même exemple que précedemment, 
le fragment qt2 standard dit 
<code>WANTLIB += lib/qt2/qt.=2</code>.
Ceci permet au code de vérification des bibliothèques de faire le bon choix
quand plusieurs versions de la même bibliothèque sont découvertes.
<h2>Mettre à jour les ports correctement</h2>
Ainsi, quand vous mettez à jour ou ajoutez un port qui implique des
bibliothèques partagées, quelques détails doivent être respectés.
<ul>
        <li>Assurez vous que les numéros majeur.mineur des bibliothèques
            partagées sont corrects.
        <li>Verifiez tous les ports qui dépendent de votre port.
            Vérifiez qu'ils se construisent correctement avec vos
            changements. Notifiez les mainteneurs de la mise à jour,
            pour qu'ils puissent ainsi vérifier que leurs ports
            fonctionnent toujours correctement.
        <li>Vous pourriez avoir à ajuster les dépendances de ports WANTLIB et
            LIB_DEPENDS. Si vous introduisez de nouvelles bibliothèques
            partagées, regardez les BUILD_DEPENDS devant être changées
            en LIB_DEPENDS.
        <li>Chaque fois que vous introduisez un nouveau port, vous
            devriez vérifier que vous n'êtes pas en train de créer une
            bibliothèque qui entre en conflit avec une bibliothèque existante
            : les bibliothèques de deux ports avec le même nom sont un
            danger, car les schémas de numérotation de leurs versions
            n'ont aucune chance de correspondre. Vous devriez essayer de
            résoudre la situation avec l'auteur du logiciel (par
            exemple, une bibliothèque appelée libnet est définitivement mal
            dénommée).
        <li>Référez-vous au <a href="../update.html">guide de mise à jour
            des ports</a> pour de plus amples informations.
</ul>
  <hr>
  <a href="../index.html"><img height=24 width=24 src=../../back.gif border=0 alt=OpenBSD></a> 
  <a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br><small>
     <!--
     Originally [OpenBSD: libraries.html,v 1.7 ]<br>
     $Translation: libraries.html,v 1.12 2011/08/25 12:04:17 ajacoutot Exp $<br>
     -->
     $OpenBSD: libraries.html,v 1.9 2011/08/25 12:13:09 ajacoutot Exp $
   </small>
 </body>
</html>
