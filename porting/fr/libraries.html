<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org">
<meta http-equiv="Content-Type" content=
"text/html; charset=iso-8859-1">
<meta name="resource-type" content="document">
<meta name="description" content=
"Quick guide to writing ports">
<meta name="keywords" content="openbsd,ports">
<meta name="distribution" content="global">
<meta name="copyright" content=
"This document copyright 2001 by OpenBSD.">
<title>Gestion des librairies partagées dans l'arbre des ports OpenBSD</title>
</head>
<body text="Black" bgcolor="White" link="#23238E">
<img height="30" width="141" src="../../images/smalltitle.gif" alt=
"[OpenBSD]"> 

<h1>Comment gérer les librairies partagées dans l'arbre des ports</h1>

<h2>Comprendre les règles de numérotation des librairies partagées</h2>
Les librairies partagées sont quelque peu rusées et ce pour plusieurs
raisons. Vous devez comprendre le schéma de nommage des librairies :
<code>libfoo.so.majeur.mineur</code>.
<p>
Quand vous liez un programme, l'éditeur de liens <code>ld</code> inclut
cette information dans le binaire créé. Vous pouvez voir ceci avec 
<code>ldd</code>. Par la suite, lorsque vous lancez le programme,
l'éditeur de liens dynamique <code>ld.so</code> utilise cette information 
pour trouver la bonne librairie dynamique :
<ul>
	<li>Une librairie avec le même numéro majeur est requise.
	<li>Une librairie avec un numéro mineur égal ou supérieur est requise.
</ul>
Ainsi, cela signifie que <strong>toutes</strong> les librairies avec le
même numéro majeur et un numéro mineur égal ou supérieur <strong> doivent
satisfaire l'API binaire que le programme prévoit</strong>. Si ce n'est
pas le cas, votre port est alors cassé. Spécifiquement, cela se produira
quand les utilisateurs essaieront de mettre à jour leurs systèmes.
<p>
Les règles pour les librairies partagées sont relativement simples.
<ul>
	<li>Si vous ajoutez des fonctions aux librairies, vous devez augmenter
le numéro mineur de la librairie : un programme qui nécessite ces fonctions
n'a aucun moyen de les exiger mais peut le demander explicitement avec une
version minimale à utiliser.
        <li>Si les API existantes changent, ce qui est souvent le cas,
            si toutes les signatures de fonction sont modifiées, si les
            séquences d'appel ne sont plus valides ou si un type change
            d'une façon incompatible, le numéro majeur de la librairie
            <string>doit être augmenté</strong>.
        <li>Ceci inclut la suppression des anciennes fonctions. Toutes les 
suppressions de fonction déclenchent une augmentation du numéro majeur.
</ul>
<p>
Parfois, il arrive qu'une librairie soit écrite en plusieurs fichiers, et que
les fonctions internes doivent apparaitre comme visibles pour communiquer avec
ces fichiers.
Ces noms de fonction commencent traditionnellement avec un trait de 
soulignement, et ne sont pas une partie proprement dite de l'API.
<p>
Notez que le schéma de nommage des librairies est omniprésent sur
les plateformes OpenBSD qu'elles soient ELF ou a.out.

<h2>Peaufiner les constructions de ports pour obtenir les noms corrects</h2>
Un certain nombre de ports ont besoin d'être peaufinés afin de construire 
correctement et continuellement les librairies partagées.
Rappelez vous que la construction des librairies partagées doit être réalisée
avec <code>gcc -shared -fpic|-fPIC -o libfoo.so.4.5 obj1 obj2</code>
<p>
Renommez la librairie après ceci afin d'ajuster le numéro de version ne marche
pas : les librairies ELF utilisent d'autres nombres magiques pour fixer le
nom interne de la librairie, et vous devriez ainsi la lier avec une version
correcte dès la première fois.
<p>
D'un autre côté, rappelez vous que vous pouvez redéfinir les variables du
Makefile depuis la ligne de commande, en utilisant <code>MAKE_FLAGS</code>
dans le Makefile du port. Ceci est tout à fait utile pour les ports basés
sur la libtool par exemple, qui fournissent une version variable pour
chaque librairie qu'ils créent.

<h2>Essayer de placer toutes les librairies visibles à un utilisateur dans
/usr/local/lib</h2>
En règle générale, demander à l'utilisateur d'ajouter des répertoires
dans leur "path" ldconfig est une très mauvaise idée : toutes les librairies
partagées qui sont directement liées aux programmes devraient apparaitre
dans /usr/local/lib. Cependant, il est tout à fait possible d'utiliser
un lien symbolique vers la librairie actuelle. Vous devriez comprendre
les règles de parcour des librairies :
<ul>
  <li>Au moment de la construction, <code>ld</code> utilise les drapeaux
      <code>-L</code> pour régler les "paths" dans lequel regarder pour
      une librairie. Il arrête le parcour dès lors qu'il trouve une
      librairie qui correspond à sa recherche.
  <li>Au moment du lancement, <code>ld.so</code> utilise l'information
      mise en cache par <code>ldconfig</code> pour trouver la librairie
      requise.
</ul>

A présent, supposons que vous avez deux ports qui fournissent deux versions
majeures d'une librairie donnée, à savoir <code>qt.1.45</code> et
<code>qt.2.31</code>. Puisque les deux ports peuvent être installés 
simultanément, pour être sur qu'un programme donné sera lié avec
qt.1, cette librairie est fournie avec
<code>/usr/local/lib/qt/libqt.so.1.45</code>, et les programmes seront liés
en utilisant <code>ld -o program program.o -L/usr/local/lib/qt -lqt</code>.
De même, un programme lié avec qt.2 utilisera le fichier
<code>/usr/local/lib/qt2/libqt.so.2.31</code> avec
<code>ld -o program program.o -L/usr/local/lib/qt2 -lqt</code>.
<p>
Pour résoudre ces librairies au moment du lancement, un lien appelé
<code>/usr/local/lib/libqt.so.1.45</code> et un lien appelé
<code>/usr/local/lib/libqt.so.2.31</code> sont fournis. Ceci est
suffisant pour satisfaire <code>ld.so</code>.
<p>
Lier un programme en utilisant qt1 avec
<code>ld -o program program.o -L/usr/local/lib -lqt</code> est une erreur.
Ce code suppose que le <code>qt.2.31</code> n'est pas installé,
ce qui est une fausse prétention.
<p>
De telles astuces sont uniquement nécessaires dans les rares cas de
librairies dominantes ou une période de transition entre deux versions
majeures doit être fournie. En général, ceci est suffisant pour s'assurer
de la présence de la librairie dans
<code>/usr/local/lib</code>.
<h2>Ecrire correctement les dépendances de librairie</h2>
Le nouveau code de dépendance a besoin des dépendances complètes des
librairies. Vous devez utiliser <code>make lib-depends-check</code>
pour vérifier qu'un port mentionne toutes les librairies requises.
Vous n'avez qu'a séparer les différentes librairies avec des virgules,
comme ceci :
<code>LIB_DEPENDS=gtk.1.2,gdk.1.2::x11/gtk+</code>.
<p>
Spécifier les librairies statiques sur la ligne LIB_DEPENDS n'est pas une
erreur à part entière. LIB_DEPENDS est évaluée intégralement au moment
de la construction du paquet : le package résultant aura une information
de dépendance de librairie inclut dans <code>ld.so</code> qui porte
le numéro majeur.mineur actuel qui était utilisé pour la construction,
mais rien pour les librairies statiques.
<p>
Vous devez aussi fournir RUN_DEPENDS si un port requiert quelquechose
au delà d'une librairie proprement dite. Ceci permettra au port de 
se construire correctement sur les architectures qui ne supportent pas
les librairies partagées.
<p>
En fait, fournir les lignes LIB_DEPENDS pour les librairies statiques est
une bonne idée : ceci simplifiera la mise à jour du port si une dépendance
donnée passe d'une librairie statique à une librairie partagée.
<p>
Les lignes LIB_DEPENDS doivent spécifier les même "paths" que ceux utilisés
par <code>ld</code>. Par exemple, le fragment qt2 standard dit :
<code>LIB_DEPENDS+=lib/qt2/qt.2::x11/qt2</code>, la ligne de dépendance
des librairies pourra ainsi être correctement résolue. Ceci permet au code
de vérification des librairies de faire le bon choix quand plusieurs
versions de la même librairie sont découvertes.
<h2>Mettre à jour les ports correctement</h2>
Ainsi, quand vous mettez à jour ou ajoutez un port qui implique des librairies
partagées, quelques détails doivent être respectés.
<ul>
        <li>Assurez vous que les numéros majeur.mineur des librairies partagées 
sont corrects.
        <li>Verifiez tous les ports qui dépendent de votre port. Vérifiez qu'ils se
construisent correctement avec vos changements. Notifiez les mainteneurs 
de la mise à jour, pour qu'ils puissent ainsi vérifier que leurs ports 
fonctionnent toujours correctement.
        <li>Vous pourriez avoir à ajuster les dépendances de ports LIB_DEPENDS. Si
vous introduisez de nouvelles librairies partagées, regardez les BUILD_DEPENDS
devant être changées en LIB_DEPENDS.
        <li>Chaque fois que vous introduisez un nouveau port, vous devriez vérifier
que vous n'êtes pas en train de créer une librairie qui entre en conflit avec
une librairie existante : les librairies de deux ports avec le même nom
sont un danger, car les schémas de numérotation de leurs versions n'ont aucune
chance de correspondre. Vous devriez essayer de résoudre la situation avec
l'auteur du logiciel (par exemple, une librairie appelée libnet est
définitivement mal dénommée).
</ul>
  <hr>
  <a href="../index.html"><img height=24 width=24 src=../../back.gif border=0 alt=OpenBSD></a> 
  <a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br><small>
     <!--
     Originally [OpenBSD: libraries.html,v 1.5 ]<br>
     $Translation: libraries.html,v 1.5 2005/03/12 17:59:24 aanriot Exp $<br>
     -->
     $OpenBSD: libraries.html,v 1.4 2005/03/15 14:32:54 saad Exp $
   </small>
 </body>
</html>
